2025-05-30 15:04:42,818 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 15:04:42,818 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 15:04:42,819 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 15:04:42,819 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 15:04:42,819 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 71896
2025-05-30 15:04:42,819 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 15:04:42,819 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 15:04:42,819 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 15:04:42,824 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 15:04:42,824 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 15:04:42,937 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 15:04:42,938 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 15:04:42,938 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 15:04:42,938 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 15:04:42,938 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 15:04:42,938 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 15:04:42,963 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 15:04:42,963 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 15:04:42,963 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 15:04:42,964 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 15:04:42,965 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET)
2025-05-30 15:04:42,965 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 15:04:42,965 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 15:04:43,018 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 15:04:43,022 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 15:04:43,620 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 15:04:43,622 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 15:04:43,623 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 15:04:43,623 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 15:04:43,623 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 15:04:43,623 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 15:04:43,623 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 15:04:43,623 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 15:04:43,623 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 15:04:43,623 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 15:04:43,624 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 15:04:43,624 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 15:04:43,624 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 15:04:43,624 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 15:04:43,624 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 15:04:43,624 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 15:04:43,634 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 15:04:43,634 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 15:04:43,634 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 15:04:43,634 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4669418928) setup complete. Starting run loop.
2025-05-30 15:04:43,634 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 15:04:43,634 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 15:04:43,634 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 15:04:43,634 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 15:04:43,637 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 15:06:35,187 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 15:06:35,189 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: c6df5350-fb4d-45b5-87c3-f3396e809f4a)
2025-05-30 15:06:35,189 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 15:06:35,189 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 15:06:35,189 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 15:06:35,272 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 15:06:35,272 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 15:06:35,300 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 15:06:35,304 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 15:06:36,313 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 15:06:36,318 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 15:06:36,318 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 15:06:36,318 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 363, 'output_tokens': 12, 'total_tokens': 375, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 15:06:36,318 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:363 C:12 T:375
2025-05-30 15:06:36,318 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 375 tokens recorded.
2025-05-30 15:06:36,319 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 15:06:36,319 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: get_user_info_tool
2025-05-30 15:06:36,319 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (get_user_info_tool)---
2025-05-30 15:06:36,322 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 15:06:36,322 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 15:06:36,346 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 15:06:36,349 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 15:06:37,767 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 15:06:37,790 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 15:06:37,790 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 15:06:37,790 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 434, 'output_tokens': 16, 'total_tokens': 450, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 15:06:37,790 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:434 C:16 T:450
2025-05-30 15:06:37,790 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 450 tokens recorded.
2025-05-30 15:06:37,791 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 15:06:37,791 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748589354598
2025-05-30 15:06:37,791 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748589354598)---
2025-05-30 15:06:37,792 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹'
2025-05-30 15:06:37,792 - INFO - app.agent_runner.common.tools_registry - Function parameters: api_config=True, log_adapter=True, state=True
2025-05-30 15:06:37,792 - INFO - app.agent_runner.common.tools_registry - State type: <class 'dict'>
2025-05-30 15:06:37,792 - INFO - app.agent_runner.common.tools_registry - State keys: ['messages', 'documents', 'question', 'original_question', 'rewrite_count', 'channel', 'user_data', 'token_usage_events']
2025-05-30 15:06:37,792 - INFO - app.agent_runner.common.tools_registry - User data extracted: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 15:06:37,792 - INFO - app.agent_runner.common.tools_registry - Final user_data for API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹': {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 15:06:37,792 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 15:06:37,792 - INFO - app.agent_runner.common.tools_registry - Headers type: <class 'dict'>, value: {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36', 'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7', 'Accept-Language': 'ru-RU,ru;q=0.9,en;q=0.8', 'Accept-Encoding': 'gzip, deflate, br', 'DNT': '1', 'Connection': 'keep-alive', 'Upgrade-Insecure-Requests': '1', 'Sec-Fetch-Dest': 'document', 'Sec-Fetch-Mode': 'navigate', 'Sec-Fetch-Site': 'same-origin', 'Sec-Fetch-User': '?1', 'Cache-Control': 'max-age=0', 'Referer': 'https://airsoft-rus.ru/', 'Cookie': 'PHPSESSID=gq3cMIY4z4t5OLt12aMMcFrus6CEIhZR'}
2025-05-30 15:06:37,792 - INFO - app.agent_runner.common.tools_registry - Query Params: {'type': 'info', 'tel': '79222088435'}
2025-05-30 15:06:38,160 - ERROR - app.agent_runner.common.tools_registry - HTTP error making GET request to https://airsoft-rus.ru/obmen_rus/bals.php: 403 ï¿½ï¿½ï¿½  ï¿½ï¿½Tï¿½ï¿½ï¿½Wï¿½[<Ù±	Uï¿½:ï¿½ï¿½Vï¿½ï¿½qJï¿½sï¿½ï¿½ß«ï¿½#ï¿½(ï¿½iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½eï¿½ï¿½isï¿½u.nEï¿½Â‚ï¿½ï¿½hï¿½ï¿½%/(ï¿½1ï¿½ï¿½006ï¿½L@Ğ¯ï¿½ï¿½sSï¿½ï¿½ï¿½ï¿½-i?ï¿½ï¿½_xï¿½ï¿½ï¿½ï¿½\ï¿½uï¿½K\ï¿½ï¿½\0ï¿½  ï¿½456ï¿½ï¿½ï¿½yï¿½ï¿½`ï¿½ï¿½ï¿½ky20ï¿½ï¿½f]æ‹‰ï¿½Dï¿½Û Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½_ï¿½ï¿½vC=P)O5È™ï¿½=ï¿½ËŠï¿½ï¿½ï¿½_ï¿½cï¿½ï¿½:ï¿½ï¿½ï¿½6ï¿½mï¿½:ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½1gï¿½fï¿½xï¿½ï¿½ï¿½"ï¿½ï¿½ï¿½ï¿½ï¿½bï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½@ ï¿½ï¿½ï¿½Ø’ï¿½*ï¿½9ï¿½ç©8ï¿½ï¿½ .ï¿½iï¿½ï¿½@ï¿½_ï¿½t*B ï¿½ï¿½TÜ©ï¿½k},ï¿½ï¿½Gï¿½ï¿½uï¿½ï¿½Hï¿½~ï¿½ï¿½ï¿½Rï¿½ï¿½<ï¿½#Ûµï¿½d]ry
ï¿½Fvsï¿½ï¿½'ï¿½ï¿½ï¿½E\ï¿½dIï¿½É±ï¿½wï¿½ï¿½ï¿½ï¿½ï¿½Sp<ï¿½;ï¿½ï¿½urï¿½ï¿½ï¿½/LÓ•<Â­ï¿½<ï¿½ï¿½ï¿½ï¿½M?ï¿½ï¿½5pï¿½ï¿½Nï¿½ï¿½iï¿½ï¿½1ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½@pï¿½6Eï¿½ï¿½ï¿½ï¿½hï¿½ï¿½ï¿½p#ï¿½ï¿½ï¿½[ï¿½ï¿½,sï¿½ï¿½	vï¿½
ï¿½ï¿½ï¿½cï¿½ï¿½ï¿½+>ï¿½$ï¿½?! ï¿½ï¿½ï¿½ï¿½,cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½rï¿½ï¿½~ï¿½ï¿½7ï¿½W|ï¿½]ï¿½ï¿½ï¿½Iï¿½ï¿½7ï¿½ï¿½ï¿½	ï¿½ï¿½ï¿½ï¿½
ï¿½ï¿½ï¿½Oï¿½ï¿½ï¿½jeï¿½@ï¿½ï¿½5ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½c7zdï¿½ÒŠEdï¿½ï¿½2ï¿½ï¿½ï¿½|2]ï¿½Óšï¿½ï¿½7ï¿½ï¿½0ï¿½ï¿½+ï¿½ï¿½ï¿½*ï¿½w4tï¿½%:ï¿½"ï¿½0ï¿½ï¿½UFb$>0D9ï¿½5jï¿½U)ï¿½Mï¿½ï¿½3nï¿½Bï¿½ï¿½ï¿½ï¿½N7ï¿½S)ï¿½,ï¿½ï¿½ŞƒsP7ï¿½S)ï¿½ï¿½kï¿½)ï¿½ï¿½"lï¿½ï¿½3ï¿½?uï¿½ï¿½ï¿½\ï¿½w"ï¿½q7ï¿½2ï¿½ï¿½b`ï¿½Vsï¿½Rï¿½oï¿½ï¿½ï¿½ï¿½ï¿½SKï¿½+ï¿½ï¿½(4	4sï¿½%ï¿½ï¿½&ï¿½ï¿½ï¿½	Eï¿½jAï¿½ï¿½EfJiï¿½ï¿½d;&ï¿½^<ï¿½ï¿½_ï¿½ï¿½ï¿½"7ï¿½ï¿½?_ï¿½|ï¿½xÄ±`@İ›ï¿½ï¿½'ï¿½ï¿½G)lFIï¿½Bqï¿½tST+ZZAï¿½Aï¿½ï¿½ï¿½ï¿½gï¿½ï¿½ï¿½ï¿½à¶«
ï¿½ï¿½ï¿½i&
ï¿½ï¿½ï¿½gv&8+&ï¿½iï¿½#SLTï¿½xï¿½Kï¿½ï¿½iï¿½ï¿½ZÑ¢ï¿½*ï¿½ï¿½M=ï¿½Sï¿½ï¿½Eï¿½ID.+Lï¿½ï¿½Mï¿½PHï¿½ï¿½YL4ï¿½ÑY.Lï¿½ï¿½	ï¿½rIBrcgï¿½t!ï¿½&gï¿½ëº³\*ï¿½fï¿½ï¿½rVï¿½lï¿½[]ï¿½4
\4+ï¿½ï¿½ï¿½ï¿½	o+ï¿½ï¿½BUï¿½UGDï¿½!,ï¿½ï¿½ Bï¿½ï¿½ï¿½ï¿½ï¿½?ï¿½ï¿½ï¿½dï¿½.ß¬ï¿½tï¿½3ï¿½ï¿½tï¿½ï¿½ï¿½ï¿½ï¿½tFï¿½ï¿½ï¿½aW9}Df+|LQï¿½4ï¿½gï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½`ï¿½ï¿½ï¿½c"&bï¿½w>ï¿½$ï¿½ï¿½|Lï¿½1ï¿½ï¿½ï¿½{Rï¿½
~ï¿½ï¿½ï¿½ï¿½/ï¿½WZï¿½ï¿½ ï¿½ï¿½ï¿½2vuï¿½^ï¿½ï¿½H6Ôœoyï¿½ï¿½ï¿½ï¿½~ï¿½ï¿½ï¿½uï¿½oï¿½ï¿½6ï¿½ï¿½.(Eï¿½uUï¿½Lï¿½ï¿½KuEï¿½$y4Tï¿½Y?e32ï¿½ï¿½t0xï¿½ï¿½ï¿½ï¿½^ï¿½(ï¿½ï¿½ï¿½ï¿½ï¿½~ï¿½ï¿½;Zï¿½ï¿½ï¿½ò†¼½G^ï¿½&ï¿½ï¿½oA1N]:ï¿½ï¿½ï¿½Ë·ï¿½ï¿½:ï¿½ï¿½ï¿½ï¿½Fï¿½o'~{ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½-ï¿½ï¿½8ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½7&ï¿½!w-Ë„ï¿½ï¿½ï¿½4ï¿½ï¿½lï¿½"ï¿½6ï¿½Õ¦ï¿½ï¿½Hï¿½#7)ï¿½ï¿½n(ï¿½Fï¿½  }ï¿½Oyï¿½Èï¿½ï¿½loÇ‡$iï¿½ï¿½ï¿½qï¿½~ï¿½,l:Tyw'ï¿½ï¿½;ï¿½ï¿½bLï¿½6Ê¾Hoï¿½ï¿½SWhï¿½ï¿½ï¿½|ï¿½ï¿½]ï¿½$ï¿½?.ï¿½ï¿½ï¿½ï¿½zï¿½ï¿½ï¿½k>ï¿½ï¿½hï¿½ï¿½ï¿½sRï¿½ï¿½AGï¿½ß¾ï¿½ï¿½Gï¿½ï¿½/i+)ï¿½YO-,qï¿½ï¿½3Fï¿½ï¿½ï¿½ï¿½ï¿½9[ï¿½M6ï¿½ï¿½D-ï¿½ï¿½ï¿½aï¿½"ï¿½geï¿½rï¿½Pï¿½JIï¿½2HUQmï¿½zï¿½rï¿½Ş ï¿½ï¿½ï¿½oï¿½ï¿½;ï¿½ï¿½ï¿½-{{ï¿½ï¿½hï¿½ï¿½ï¿½ï¿½ï¿½x{ï¿½ï¿½ï¿½ï¿½>/ï¿½ï¿½ï¿½yï¿½ï¿½ï¿½ï¿½ï¿½ï¿½-Jï¿½ï¿½ï¿½ï¿½ï¿½ï¿½*=:Mï¿½yï¿½ï¿½ï¿½"ï¿½cmï¿½2ï¿½ï¿½ï¿½ï¿½qï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Aï¿½ï¿½ï¿½Ø˜ï¿½ï¿½VLï¿½ï¿½ï¿½ï¿½Í¬DVRï¿½ï¿½ï¿½HWï¿½Ê—ï¿½ï¿½mï¿½9]ï¿½Cï¿½+R(ï¿½Ì¥Cjï¿½H%ï¿½Hï¿½1ï¿½Jï¿½e[ï¿½ï¿½ï¿½xGï¿½-ï¿½A#ï¿½ï¿½4b{Lï¿½ï¿½>ï¿½} gï¿½U<8 0ï¿½ï¿½A1  bï¿½ï¿½ ï¿½+ï¿½k6ï¿½tï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½XopS@ï¿½ï¿½!ï¿½bc ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Lbï¿½iï¿½ï¿½oBAï¿½ï¿½ï¿½=ï¿½vfï¿½@J`ï¿½ï¿½Tï¿½ï¿½qï¿½ï¿½ï¿½
\ï¿½ï¿½aï¿½ï¿½ï¿½ï¿½6ï¿½nÑ³m}
ï¿½4Éœxï¿½5'ï¿½ï¿½ï¿½Tï¿½p4ï¿½ï¿½ï¿½S2ï¿½ï¿½QQï¿½Óº"ï¿½ï¿½ï¿½ï¿½Sï¿½r6ï¿½>ï¿½N-=9yï¿½ï¿½ï¿½ï¿½i_Y=*,Nhe?ï¿½;,X*ï¿½ï¿½R+ï¿½y d$Kï¿½v;	ï¿½c$ï¿½Tï¿½ï¿½4ï¿½ï¿½)p%ï¿½"=ï¿½	D×·Nï¿½N'%ï¿½ï¿½ß‚ï¿½ï¿½âQMhX~ï¿½\KNï¿½ï¿½	CeB6ï¿½ï¿½Iï¿½ï¿½ï¿½ï¿½lï¿½ï¿½ï¿½ï¿½U=ï¿½8Gba{!?:ï¿½Lbï¿½ï¿½ï¿½|ï¿½2Bï¿½ï¿½ï¿½ï¿½ï¿½î¤~ï¿½ï¿½,ogimWnï¿½mï¿½ï¿½ï¿½Kï¿½Dï¿½ ï¿½2+Yï¿½ï¿½<Yï¿½@^,kï¿½ï¿½}6kï¿½4ï¿½ï¿½55&1ï¿½ï¿½ï¿½uqï¿½Xï¿½ï¿½hc]ï¿½ï¿½ï¿½xï¿½ï¿½[ M
N!ï¿½ï¿½ï¿½ï¿½ï¿½TO7jï¿½&Gï¿½ï¿½+]ï¿½`ï¿½ï¿½tVï¿½gï¿½oï¿½Ó³{t{ï¿½cï¿½&ï¿½vfGQï¿½Ôeu60ï¿½ï¿½9ï¿½Éªï¿½-%Aï¿½ï¿½ï¿½7ï¿½QUï¿½=`eï¿½ï¿½ï¿½i$ï¿½45ï¿½ï¿½ï¿½+Û¤.6ï¿½ï¿½{Tï¿½ï¿½ï¿½qï¿½ï¿½ï¿½vï¿½ï¿½bÒ›ï¿½Cï¿½ï¿½|(#*3 ï¿½&ï¿½ï¿½tï¿½xEï¿½ï¿½\zï¿½bHï¿½w×&ï¿½[Ô¶ï¿½ï¿½Cï¿½ï¿½ï¿½9gï¿½Sï¿½]
o7ï¿½Moï¿½ï¿½Cï¿½{ï¿½ï¿½Sï¿½uÈ­ï¿½&ï¿½ï¿½pï¿½>?ï¿½Oï¿½ï¿½5:ï¿½ï¿½ï¿½vtFKï¿½H@ï¿½]sï¿½eï¿½ï¿½7\Fï¿½I ï¿½H|Mt[`Ï–'ï¿½QyNï¿½Y-ï¿½Idï¿½ï¿½-ï¿½#Yï¿½Gï¿½ï¿½ï¿½Â¥ï¿½ï¿½vYï¿½Óº%ï¿½ï¿½"ï¿½ï¿½ï¿½ka-ï¿½fï¿½ï¿½}ï¿½t_ï¿½ï¿½ï¿½sï¿½Ê§Fï¿½URï¿½ï¿½<İ¼ï¿½\&ï¿½hyï¿½Ü›+ï¿½Oï¿½4;,ï¿½gï¿½jï¿½ï¿½:ï¿½F~[fï¿½%ï¿½&Ö•ï¿½
ï¿½-ï¿½dm1$ï¿½Usp~ï¿½ï¿½ï¿½ï¿½,ï¿½ï¿½"ï¿½ï¿½<ï¿½ï¿½zï¿½ï¿½ï¿½Å«dï¿½@l^ï¿½H*ï¿½}{oï¿½1ï¿½ï¿½|#ï¿½ï¿½aTï¿½ï¿½ï¿½ï¿½"ï¿½+OMe3ï¿½.ï¿½cï¿½ï¿½[.B21ï¿½ß¾8ï¿½)\u1ï¿½ï¿½|ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½.^K<ï¿½ï¿½0y3ï¿½İ©ï¿½Nï¿½	ï¿½bï¿½uï¿½ï¿½ï¿½ï¿½wŞ«hï¿½fÂ½j;ï¿½ï¿½Jpï¿½RSï¿½vï¿½Ó¶ï¿½w2ï¿½Hï¿½Mï¿½\ONï¿½Û¸ï¿½ï¿½ï¿½~ï¿½6ï¿½uï¿½ï¿½6Ê¼ï¿½ï¿½ï¿½t>ï¿½ï¿½|Mï¿½ï¿½ï¿½&ï¿½ï¿½ï¿½Lİ“ï¿½ï¿½Â™]ï¿½Ô„%rq_ï¿½ï¿½ï¿½ï¿½:pï¿½ï¿½xAï¿½ï¿½ï¿½9$ï¿½ï¿½Û’`ï¿½mÈ¯ï¿½İ¾ï¿½ï¿½dÑ fï¿½ï¿½ï¿½
n
.rï¿½P:fï¿½MSï¿½ï¿½ï¿½ï¿½Ge,ï¿½ï¿½ï¿½Ğ‹ï¿½ï¿½^mï¿½ï¿½ï¿½ë½¼ï¿½xï¿½ï¿½7,ÒHï¿½Hï¿½=ï¿½jï¿½A[ï¿½ï¿½"Ğ„0-ï¿½ï¿½^ï¿½<ï¿½ï¿½E3UFï¿½ï¿½ï¿½szï¿½ï¿½ÑZï¿½ï¿½gï¿½[ï¿½pï¿½Çï¿½ ï¿½Moï¿½ï¿½ï¿½ï¿½ï¿½ï¿½xï¿½(!vï¿½qï¿½=ï¿½ï¿½{ï¿½/ï¿½<nï¿½+ï¿½4!ï¿½Xï¿½0ï¿½k57ï¿½*ï¿½<ë„§fï¿½Hï¿½e9ï¿½ï¿½lï¿½ï¿½ï¿½cï¿½wyï¿½ï¿½uï¿½ï¿½yï¿½ï¿½ï¿½ï¿½ï¿½ï¿½iï¿½[{ï¿½ï¿½ï¿½Eï¿½ï¿½vGï¿½ï¿½vï¿½	ï¿½_ï¿½ï¿½[ï¿½ï¿½ï¿½Vaeï¿½)ï¿½Tï¿½ï¿½Rï¿½ï¿½1H-ï¿½(ï¿½]|ï¿½7ï¿½cï¿½ï¿½-ï¿½ï¿½yï¿½n\8ï¿½ï¿½ï¿½ï¿½Hï¿½ï¿½"ï¿½ï¿½oØ›ï¿½ï¿½nm#ï¿½ï¿½.ï¿½oï¿½ï¿½DmGwDï¿½ï¿½%ï¿½^+.ï¿½ï¿½ï¿½(ï¿½@ï¿½ï¿½+ï¿½ï¿½ï¿½ï¿½rï¿½Wï¿½czï¿½ï¿½Cï¿½Dï¿½ï¿½ï¿½Jï¿½]Eï¿½ï¿½DWï¿½ï¿½-@[*ï¿½ï¿½4ï¿½ï¿½ï¿½V>ï¿½hÒ…ï¿½ï¿½"ï¿½}Uï¿½ï¿½iï¿½ï¿½ï¿½^ï¿½-&hï¿½ï¿½~aï¿½ï¿½6u8ï¿½),cKï¿½ï¿½ï¿½ï¿½vxï¿½ï¿½ï¿½reï¿½ï¿½Oï¿½ï¿½K-ï¿½ï¿½o6gjï¿½k5>ï¿½- ï¿½ï¿½"&ï¿½ï¿½Rkï¿½dï¿½ï¿½&tt ï¿½ï¿½ fbnaï¿½R|s*ï¿½#ï¿½ï¿½ï¿½C(ï¿½
ï¿½T0}q:ï¿½ï¿½iNBï¿½Bï¿½8/8w1ï¿½s>ï¿½&ï¿½ï¿½,ï¿½ï¿½ï¿½ï¿½Fï¿½iï¿½ï¿½YI0ï¿½vï¿½ï¿½N~'%ï¿½*wï¿½ï¿½ï¿½xdï¿½)ï¿½9ï¿½ï¿½Kï¿½Yï¿½ï¿½%&?t^Ä¯4ï¿½ljTc\8|x+snï¿½ï¿½2ï¿½ï¿½gï¿½<ï¿½ï¿½ï¿½}Çï¿½]É€a}`ï¿½ï¿½{ï¿½1Pï¿½ï¿½ï¿½Ã—1
ï¿½Pï¿½ï¿½ ï¿½Ê›vï¿½Iï¿½<pï¿½;ï¿½ï¿½}ï¿½ï¿½|ï¿½ï¿½mï¿½Wï¿½ï¿½wn0Óï¿½ï¿½ï¿½	Wï¿½ï¿½JGZ\O3$ï¿½[Jxï¿½
ï¿½Pï¿½ï¿½ ï¿½nï¿½ï¿½ï¿½ï„”1ï¿½Xï¿½ï¿½c'ï¿½aGï¿½yq{
Slï¿½jpjï¿½ï¿½ï¿½ j(*ï¿½ï¿½ï¿½@ï¿½Xï¿½ï¿½cAAï¿½p)iAï¿½Oï¿½ï¿½+8W~ï¿½G$ï¿½ÉŒ7fË°[ï¿½ï¿½Dï¿½ï¿½G	Eï¿½ï¿½sï¿½5ï¿½ï¿½U?ï¿½ uVï¿½ï¿½rï¿½Å°_Âï¿½yÂ“ï¿½n8ï¿½ ï¿½xï¿½ï¿½L$zÃ€ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Aï¿½ï¿½/:Ts9HXï¿½|ï¿½Efï¿½Öšï¿½ï¿½ï¿½ï¿½ï¿½Qï¿½Zrï¿½=8Xï¿½Ó^K16ï¿½ñ¶¬`ï¿½ï¿½IDvŞŸ/ ï¿½jDzß„Â«ï¿½ï¿½*}i<ï¿½ï¿½ï¿½ï¿½ï¿½Iï¿½aï¿½rvï¿½ï¿½ï¿½4ï¿½Cvï¿½tï¿½ï¿½ï¿½ï¿½ï¿½3×ˆ[5Aï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Bï¿½ï¿½ï¿½Zï¿½ï¿½ï¿½d$Xpzç›¹Vï¿½ÛµNï¿½ï¿½ï¿½ï¿½ï¿½46ï¿½ZZï¿½}ï¿½?ï¿½ï¿½pï¿½}ï¿½ï¿½ï¿½
'ï¿½ï¿½6IMï¿½ï¿½'ï¿½ï¿½ï¿½^6ï¿½ï¿½ï¿½ï¿½ï¿½;Yï¿½Ãï¿½-ï¿½Qï¿½sï¿½ï¿½ï¿½1İ;Gï¿½ï¿½â•MÜI ï¿½rï¿½ï¿½sRï¿½ï¿½ï¿½:ï¿½ï¿½t`ï¿½ï¿½a_ï¿½5ï¿½Xï¿½ï¿½ï¿½ï¿½yï¿½Kï¿½ï¿½6ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½7G7Eï¿½ï¿½Mï¿½ï¿½2r5ï¿½ï¿½ï¿½Ò»ï¿½wï¿½ï¿½ï¿½,ï¿½]ï¿½IÅ‚ï¿½ï¿½hï¿½Mï¿½Öµlï¿½ï¿½7Yï¿½ï¿½Uï¿½ï¿½ï¿½ï¿½Rï¿½ï¿½etï¿½R+ï¿½tï¿½Ò«Bï¿½ï¿½ï¿½^ï¿½ï¿½ï¿½^Ôµ2ï¿½ï¿½Ä½ï¿½ï¿½ï¿½ï¿½?vï¿½ï¿½'ï¿½dk'ï¿½ï¿½È²ï¿½ï¿½"|<ï¿½,ï¿½ï¿½W6ï¿½ï¿½Iï¿½ï¿½\×¹ï¿½ß°g8;"qvp0!F{/&ï¿½XTï¿½ï¿½ï¿½?ï¿½>:ï¿½V"ÂJï¿½ï¿½İ†ï¿½ï¿½&ï¿½gY:Ğšm%Xï¿½ï¿½!ï¿½Gï¿½_ï¿½-UFï¿½dnï¿½ï¿½Dï¿½ï¿½ ï¿½bï¿½ï¿½:yzï¿½ï¿½ï¿½ï¿½Rï¿½ï¿½ï¿½1ï¿½ï¿½iï¿½ï¿½ï¿½ï¿½Fï¿½xï¿½ï¿½ï¿½ï¿½pï¿½[ï¿½ï¿½ï¿½Jï¿½ï¿½(ï¿½Ó¹ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½08-&+ï²ï¿½9ï¿½ï¿½jLï¿½)ï¿½ï¿½qï¿½ï¿½ï¿½ï¿½ï¿½Wjï¿½xï¿½Nï¿½ï¿½ï¿½ï¿½ï¿½vC}]_Öï¿½ï¿½ï¿½ï¿½ÈŸ3ï¿½uYË’llï¿½UÍ˜ï¿½wï¿½\(ï¿½ï¿½0Xï¿½%mDFï¿½|2ï¿½Qï¿½Jï¿½wï¿½Zï¿½ï¿½"ï¿½ï¿½Gï¿½shï¿½ï¿½Ø†XXuï¿½2mï¿½Kï¿½ï¿½Kcï¿½ï¿½kï¿½ï¿½oYï¿½ï¿½ï¿½qaG1Lï¿½ï¿½Mï¿½ï¿½ï¿½>ï¿½ï¿½eUï¿½	ï¿½8ï¿½fï¿½ï¿½ï¿½~$ï¿½ï¿½5<ï¿½N(	oï¿½|ï¿½D:Sï¿½bï¿½ï¿½ï¿½ï¿½H(ï¿½Bï¿½|ï¿½Dï¿½=kï¿½ï¿½y(Oï¿½aï¿½lÍ½ï¿½;5ï¿½^Obï¿½ï¿½ï¿½ï¿½]ï¿½ï¿½
bï¿½ï¿½ï¿½%._ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½8Nï¿½ï¿½	ï¿½î‹ï¿½fØª$~bï¿½ï¿½ï¿½ï¿½opPï¿½ï¿½ï¿½ =xw1ï¿½ï¿½ï¿½ï¿½gï¿½ï¿½dEï¿½nu#ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½hlï¿½ï¿½ï¿½^ï¿½ï¿½i1ï¿½_+ï¿½ï¿½Mï¿½ï¿½~5ï¿½ï¿½ï¿½ï¿½ï¿½adï¿½ï¿½Õdï¿½ ï¿½5cï¿½q)ï¿½L7ï¿½Cï¿½dï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Lï¿½HB8 ï¿½ï¿½ï¿½ï¿½w2ï¿½ï¿½_ï¿½bï¿½]s_ï¿½ï¿½c ï¿½$S`ï¿½ï¿½P*ï¿½ï¿½Éºï¿½^sï¿½6@U$ï¿½&ï¿½Y|Ù

 ]wï¿½ï¿½ï¿½ï¿½Oé™‰OHM)ï¿½mï¿½ä…©Pï¿½Æ‘ï¿½[ï¿½ï¿½ï¿½Uï¿½WLï¿½ï¿½ ï¿½_ï¿½ï¿½dï¿½Ûï¿½ï¿½Uï¿½ï¿½ï¿½ï¿½ï¿½á…¾ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½F9"ï¿½N4@ï¿½ï¿½8ï¿½.ï¿½7t'Tï¿½{h=ï¿½ï¿½ï¿½ï¿½k0^ï¿½ï¿½ï¿½|]ï¿½.Zï¿½ï¿½ï¿½ï¿½hLï¿½9aï¿½Iï¿½ï¿½ï¿½ï¿½)ï¿½~~ï¿½ï¿½3ï¿½;`ï¿½ï¿½ï¿½ï¿½ï¿½Gï¿½QVï¿½ï¿½ò ®“6K>ï¿½:ï¿½ï¿½nl~ï¿½?ï¿½ï¿½ï¿½ï¿½4ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½,ï¿½ï¿½Bï¿½ï¿½ï¿½Eï¿½ï¿½ï¿½ï¿½`ï¿½Rï¿½ï¿½UVwDZï¿½ï¿½)ï¿½|]F
sï¿½Eï¿½ï¿½.ooï¿½ï¿½ï¿½ï¿½İ˜ï¿½-xï¿½ï¿½oï¿½/ï¿½ï¿½ï¿½uï¿½ï¿½.]ï¿½ï¿½ï¿½vï¿½ï¿½ï¿½ï¿½ï¿½Ç’ï¿½Ç‘C	ï¿½yYS]Dï¿½ï¿½;Jï¿½Ks?.cï¿½ï¿½ï¿½qÆ¿ï¿½bï¿½ï¿½ï¿½ï¿½H/Xg
ï¿½A.ï¿½ï¿½ï¿½ï¿½ï¿½;ï¿½ï¿½kï¿½9ï¿½ï¿½ï—¿ï¿½`ï¿½tï¿½ï¿½"zï¿½y4ï¿½ï¿½Ï‹eï¿½	ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½K]ï¿½_~eï¿½ï¿½ï¿½'ï¿½ï¿½1ï¿½
ï¿½{}ï¿½+hï¿½hï¿½.[ï¿½luï¿½ï¿½ï¿½ï¿½ß¿ï¿½Jï¿½ï¿½ï¿½[ï¿½ï¿½Iï¿½}ï¿½_ï¿½ï¿½ï¿½ï¿½.ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Şº+ï¿½Qwï¿½ï¿½#ï¿½ï¿½ï¿½
2025-05-30 15:06:38,162 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 15:06:38,162 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 15:06:38,192 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 15:06:38,195 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 15:06:39,358 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 15:06:40,175 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğš ÑĞ¾Ğ¶Ğ°Ğ»ĞµĞ½Ğ¸Ñ, ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ½Ğµ ÑƒĞ´Ğ°ĞµÑ‚ÑÑ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ²Ğ°ÑˆĞ¸Ñ… Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°Ñ… Ğ¸Ğ·-Ğ·Ğ° Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸.
2025-05-30 15:06:40,175 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 15:06:40,175 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 4124, 'output_tokens': 40, 'total_tokens': 4164, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 15:06:40,175 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:4124 C:40 T:4164
2025-05-30 15:06:40,175 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 4164 tokens recorded.
2025-05-30 15:06:40,176 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 15:06:40,176 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 15:06:40,177 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğš ÑĞ¾Ğ¶Ğ°Ğ»ĞµĞ½Ğ¸Ñ, ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ½Ğµ ÑƒĞ´Ğ°ĞµÑ‚ÑÑ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ²Ğ°ÑˆĞ¸Ñ… Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°Ñ… Ğ¸Ğ·-Ğ·Ğ° Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸....
2025-05-30 15:06:40,179 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: c6df5350-fb4d-45b5-87c3-f3396e809f4a)
2025-05-30 15:06:40,179 - INFO - AGENT:agent_airsoft_0faa9616 - Found 3 token usage events for InteractionID: c6df5350-fb4d-45b5-87c3-f3396e809f4a.
2025-05-30 15:38:51,097 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 15:38:51,098 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4669418928) received shutdown request. Initiating graceful shutdown...
2025-05-30 15:38:51,098 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4669418928)...
2025-05-30 15:38:51,098 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 15:38:51,098 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 15:38:51,098 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4669418928) was cancelled.
2025-05-30 15:38:51,098 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4669418928) stopping. Performing cleanup...
2025-05-30 15:38:51,098 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 15:38:51,099 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-30 15:38:51,100 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 15:38:51,100 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 15:38:51,100 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 15:38:51,100 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 15:38:51,100 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 15:38:51,100 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 15:38:51,100 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 15:38:51,104 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 15:38:51,105 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 15:38:51,105 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:38:51,106 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 15:38:51,106 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 15:38:51,106 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 15:38:51,106 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4669418928) cleanup complete.
2025-05-30 15:38:51,106 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 15:38:51,106 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 15:38:51,107 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 15:38:51,107 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 15:38:51,107 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 15:38:51,108 - INFO - __main__ - Agent runner main finished.
2025-05-30 15:41:46,701 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 15:41:46,701 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 15:41:46,707 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 15:41:46,707 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 15:41:46,707 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 15:41:46,707 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 15:41:46,707 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 15:41:46,708 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 15:41:46,708 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 15:41:46,708 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 15:41:46,708 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 15:41:46,708 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 15:41:46,708 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 15:41:46,710 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 15:41:46,710 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 15:41:46,710 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 15:41:46,726 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 15:41:46,726 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 15:41:46,726 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 15:41:46,726 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 15:41:46,728 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 15:41:46,728 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4489446128) setup complete. Starting run loop.
2025-05-30 15:41:46,729 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 15:41:46,729 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 15:41:46,730 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 15:41:46,730 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4489445936) setup complete. Starting run loop.
2025-05-30 15:41:46,730 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 15:41:46,730 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 15:41:46,730 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 15:41:46,765 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 15:41:46,765 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 15:41:46,767 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 15:41:46,768 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 74738
2025-05-30 15:41:46,768 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 74738
2025-05-30 15:41:46,769 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 15:41:46,769 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 15:41:46,769 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 15:41:46,770 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 15:41:46,771 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 74739
2025-05-30 15:41:46,771 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 74739
2025-05-30 15:41:46,772 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 15:41:46,773 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:41:46,773 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 15:41:46,773 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 15:41:46,773 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 15:41:47,657 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 15:41:47,657 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 15:41:47,657 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 15:41:47,657 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 15:41:47,657 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 74739
2025-05-30 15:41:47,657 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 15:41:47,657 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 15:41:47,657 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 15:41:47,664 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 15:41:47,676 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 15:41:47,676 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 15:41:47,676 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 15:41:47,676 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4737394800) setup complete. Starting run loop.
2025-05-30 15:41:47,676 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 15:41:47,676 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 15:41:47,676 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 15:41:47,676 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 15:41:47,677 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 15:41:47,677 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 15:41:47,677 - INFO - aiogram.dispatcher - Start polling
2025-05-30 15:41:47,679 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 15:41:47,922 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 15:41:48,069 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 15:41:48,070 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 15:41:48,070 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 15:41:48,070 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 15:41:48,070 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 74738
2025-05-30 15:41:48,070 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 15:41:48,070 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 15:41:48,070 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 15:41:48,113 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 15:41:48,113 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 15:41:48,155 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 15:41:48,155 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 15:41:48,155 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 15:41:48,155 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 15:41:48,155 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 15:41:48,156 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 15:41:48,181 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 15:41:48,181 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 15:41:48,181 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 15:41:48,182 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 15:41:48,183 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET)
2025-05-30 15:41:48,183 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 15:41:48,183 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 15:41:48,240 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 15:41:48,244 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 15:41:49,132 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 15:41:49,136 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 15:41:49,136 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 15:41:49,136 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 15:41:49,136 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 15:41:49,136 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 15:41:49,136 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 15:41:49,136 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 15:41:49,136 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 15:41:49,137 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 15:41:49,137 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 15:41:49,138 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 15:41:49,138 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 15:41:49,138 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 15:41:49,138 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 15:41:49,138 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 15:41:49,148 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 15:41:49,148 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 15:41:49,148 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 15:41:49,148 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4657133472) setup complete. Starting run loop.
2025-05-30 15:41:49,149 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 15:41:49,149 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 15:41:49,149 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 15:41:49,149 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 15:41:49,151 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 15:41:56,730 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 15:41:56,735 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 15:41:56,735 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4489445696) setup complete. Starting run loop.
2025-05-30 15:41:56,735 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 15:42:08,788 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 15:42:08,787 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 15:42:08,788 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4657133472) received shutdown request. Initiating graceful shutdown...
2025-05-30 15:42:08,788 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4657133472)...
2025-05-30 15:42:08,788 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 15:42:08,788 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 15:42:08,788 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4657133472) was cancelled.
2025-05-30 15:42:08,788 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4657133472) stopping. Performing cleanup...
2025-05-30 15:42:08,788 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 15:42:08,788 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 15:42:08,788 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 15:42:08,789 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 0) on start/restart.
2025-05-30 15:42:08,789 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 15:42:08,789 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 15:42:08,789 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 15:42:08,790 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 15:42:08,790 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 15:42:08,790 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 15:42:08,790 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 15:42:08,794 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 15:42:08,795 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 15:42:08,795 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:42:08,795 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 15:42:08,795 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 15:42:08,795 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 15:42:08,795 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4657133472) cleanup complete.
2025-05-30 15:42:08,795 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 15:42:08,795 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 15:42:08,796 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 15:42:08,796 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 15:42:08,796 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 15:42:08,796 - INFO - __main__ - Agent runner main finished.
2025-05-30 15:42:08,928 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 15:42:08,928 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 15:42:08,928 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 15:42:08,928 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4489446128) was cancelled.
2025-05-30 15:42:08,928 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4489446128) stopping. Performing cleanup...
2025-05-30 15:42:08,928 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:42:08,932 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 15:42:08,933 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 15:42:08,933 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:42:08,933 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 15:42:08,933 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:42:08,933 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4489446128) cleanup complete.
2025-05-30 15:42:08,934 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 15:42:08,934 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 15:42:08,934 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4489445936) was cancelled.
2025-05-30 15:42:08,934 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4489445936) stopping. Performing cleanup...
2025-05-30 15:42:08,934 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:42:08,936 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 15:42:08,937 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 15:42:08,937 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:42:08,938 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 15:42:08,938 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:42:08,938 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4489445936) cleanup complete.
2025-05-30 15:42:08,938 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 15:42:08,938 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 15:42:08,938 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4489445696) was cancelled.
2025-05-30 15:42:08,938 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4489445696) stopping. Performing cleanup...
2025-05-30 15:42:08,938 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 15:42:08,938 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:42:08,938 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 15:42:08,938 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 15:42:08,938 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:42:08,940 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 15:42:08,941 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 15:42:08,941 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:42:08,941 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 15:42:08,941 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:42:08,941 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 15:42:08,941 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4489445696) cleanup complete.
2025-05-30 15:42:08,941 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 15:42:08,941 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 15:42:08,941 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 15:42:08,943 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 15:42:08,943 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 15:42:09,039 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 15:42:09,040 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 15:42:09,040 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 15:42:09,040 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4737394800) received shutdown request. Initiating graceful shutdown...
2025-05-30 15:42:09,040 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4737394800)...
2025-05-30 15:42:09,040 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 15:42:09,040 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 15:42:09,040 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4737394800) was cancelled.
2025-05-30 15:42:09,040 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4737394800) stopping. Performing cleanup...
2025-05-30 15:42:09,040 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 15:42:09,040 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 15:42:09,040 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 15:42:09,040 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 15:42:09,040 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 15:42:09,040 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 15:42:09,040 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 15:42:09,040 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 15:42:09,040 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 15:42:09,040 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 15:42:09,044 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 15:42:09,045 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 15:42:09,045 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:42:09,045 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 15:42:09,045 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 15:42:09,045 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 15:42:09,045 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4737394800) cleanup complete.
2025-05-30 15:42:09,045 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 15:42:09,045 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 15:42:09,045 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 15:42:09,045 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 15:42:09,045 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 15:42:09,046 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 15:42:13,391 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 15:42:13,391 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 15:42:13,395 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 15:42:13,395 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 15:42:13,395 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 15:42:13,395 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 15:42:13,395 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 15:42:13,396 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 15:42:13,396 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 15:42:13,396 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 15:42:13,396 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 15:42:13,396 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 15:42:13,396 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 15:42:13,398 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 15:42:13,412 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 15:42:13,412 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 15:42:13,412 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 15:42:13,412 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 15:42:13,412 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 15:42:13,412 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 15:42:13,415 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 15:42:13,415 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 15:42:13,415 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4581137568) setup complete. Starting run loop.
2025-05-30 15:42:13,415 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 15:42:13,416 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 15:42:13,416 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4647782112) setup complete. Starting run loop.
2025-05-30 15:42:13,416 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 15:42:13,417 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 15:42:13,417 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 15:42:13,446 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 15:42:13,446 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 15:42:13,448 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 15:42:13,449 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 74875
2025-05-30 15:42:13,449 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 74875
2025-05-30 15:42:13,449 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 15:42:13,449 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 15:42:13,449 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 15:42:13,451 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 15:42:13,451 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 74876
2025-05-30 15:42:13,451 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 74876
2025-05-30 15:42:13,452 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 15:42:13,453 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:42:13,453 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 15:42:13,453 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 15:42:13,453 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 15:42:14,299 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 15:42:14,299 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 15:42:14,299 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 15:42:14,299 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 15:42:14,300 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 74876
2025-05-30 15:42:14,300 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 15:42:14,300 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 15:42:14,300 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 15:42:14,305 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 15:42:14,318 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 15:42:14,318 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 15:42:14,318 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 15:42:14,318 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4430325536) setup complete. Starting run loop.
2025-05-30 15:42:14,318 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 15:42:14,318 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 15:42:14,318 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 15:42:14,318 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 15:42:14,318 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 15:42:14,318 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 15:42:14,318 - INFO - aiogram.dispatcher - Start polling
2025-05-30 15:42:14,321 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 15:42:14,571 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 15:42:14,593 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 15:42:14,594 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 15:42:14,594 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 15:42:14,594 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 15:42:14,594 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 74875
2025-05-30 15:42:14,594 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 15:42:14,594 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 15:42:14,594 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 15:42:14,637 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 15:42:14,637 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 15:42:14,677 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 15:42:14,677 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 15:42:14,677 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 15:42:14,677 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 15:42:14,677 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 15:42:14,677 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 15:42:14,702 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 15:42:14,702 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 15:42:14,702 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 15:42:14,704 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 15:42:14,704 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET)
2025-05-30 15:42:14,704 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 15:42:14,704 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 15:42:14,759 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 15:42:14,763 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 15:42:15,372 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 15:42:15,375 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 15:42:15,376 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 15:42:15,376 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 15:42:15,376 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 15:42:15,376 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 15:42:15,376 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 15:42:15,376 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 15:42:15,376 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 15:42:15,376 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 15:42:15,377 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 15:42:15,377 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 15:42:15,377 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 15:42:15,377 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 15:42:15,377 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 15:42:15,377 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 15:42:15,388 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 15:42:15,388 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 15:42:15,388 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 15:42:15,388 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4645565744) setup complete. Starting run loop.
2025-05-30 15:42:15,388 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 15:42:15,388 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 15:42:15,388 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 15:42:15,388 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 15:42:15,392 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 15:42:23,417 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 15:42:23,421 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 15:42:23,421 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4647781920) setup complete. Starting run loop.
2025-05-30 15:42:23,421 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 15:43:37,173 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - User 144641834 (ChatID: 144641834) triggered /start for agent agent_airsoft_0faa9616
2025-05-30 15:43:37,501 - INFO - aiogram.event - Update id=804756332 is handled. Duration 327 ms by bot id=1750613938
2025-05-30 15:43:51,394 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñƒ Ğ¼ĞµĞ½Ñ Ğ±Ğ±?...'
2025-05-30 15:43:51,396 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 15:43:51,433 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 15:43:51,433 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 15:43:51,433 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 15:43:51,434 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 77d32b1e-7779-40ae-a75c-971928cda2f9)
2025-05-30 15:43:51,434 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 15:43:51,434 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-30 15:43:51,457 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 77d32b1e-7779-40ae-a75c-971928cda2f9, db_id: 979
2025-05-30 15:43:51,471 - INFO - AGENT:agent_airsoft_0faa9616 - Loaded 20 messages from DB for thread '144641834'.
2025-05-30 15:43:51,472 - INFO - AGENT:agent_airsoft_0faa9616 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-30 15:43:51,472 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-30 15:43:51,537 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 15:43:51,538 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 15:43:51,563 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 15:43:51,566 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 15:43:52,434 - INFO - aiogram.event - Update id=804756333 is handled. Duration 1040 ms by bot id=1750613938
2025-05-30 15:43:53,088 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 15:43:53,134 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 15:43:53,134 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 15:43:53,134 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 982, 'output_tokens': 16, 'total_tokens': 998, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 15:43:53,134 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:982 C:16 T:998
2025-05-30 15:43:53,134 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 998 tokens recorded.
2025-05-30 15:43:53,135 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 15:43:53,135 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748589354598
2025-05-30 15:43:53,135 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748589354598)---
2025-05-30 15:43:53,137 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹'
2025-05-30 15:43:53,137 - INFO - app.agent_runner.common.tools_registry - Function parameters: api_config=True, log_adapter=True, state=True
2025-05-30 15:43:53,137 - INFO - app.agent_runner.common.tools_registry - State type: <class 'dict'>
2025-05-30 15:43:53,137 - INFO - app.agent_runner.common.tools_registry - State keys: ['messages', 'documents', 'question', 'original_question', 'rewrite_count', 'channel', 'user_data', 'token_usage_events']
2025-05-30 15:43:53,137 - INFO - app.agent_runner.common.tools_registry - User data extracted: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 15:43:53,137 - INFO - app.agent_runner.common.tools_registry - Final user_data for API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹': {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 15:43:53,137 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 15:43:53,137 - INFO - app.agent_runner.common.tools_registry - Headers type: <class 'dict'>, value: {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36', 'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7', 'Accept-Language': 'ru-RU,ru;q=0.9,en;q=0.8', 'Accept-Encoding': 'gzip, deflate, br', 'DNT': '1', 'Connection': 'keep-alive', 'Upgrade-Insecure-Requests': '1', 'Sec-Fetch-Dest': 'document', 'Sec-Fetch-Mode': 'navigate', 'Sec-Fetch-Site': 'same-origin', 'Sec-Fetch-User': '?1', 'Cache-Control': 'max-age=0', 'Referer': 'https://airsoft-rus.ru/', 'Cookie': 'PHPSESSID=gq3cMIY4z4t5OLt12aMMcFrus6CEIhZR'}
2025-05-30 15:43:53,137 - INFO - app.agent_runner.common.tools_registry - Query Params: {'type': 'info', 'tel': '79222088435'}
2025-05-30 15:43:53,137 - INFO - app.agent_runner.common.tools_registry - Attempting Cloudflare bypass with cloudscraper for https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 15:43:53,528 - INFO - app.agent_runner.common.tools_registry - Cloudscraper request successful with status 200
2025-05-30 15:43:53,530 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 15:43:53,531 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 15:43:53,554 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 15:43:53,557 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 15:43:54,517 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 15:43:55,308 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğµ, Ñ‡Ñ‚Ğ¾ ÑĞ½Ğ¾Ğ²Ğ° Ğ²Ğ¾Ğ·Ğ½Ğ¸ĞºĞ»Ğ° Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾ Ñ‚Ğ²Ğ¾Ğ¸Ñ… Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°Ñ…. ĞÑ‡ĞµĞ½ÑŒ Ğ¶Ğ°Ğ»ÑŒ! ĞœĞ¾Ğ¶
2025-05-30 15:43:55,308 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 15:43:55,308 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1017, 'output_tokens': 51, 'total_tokens': 1068, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 15:43:55,308 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1017 C:51 T:1068
2025-05-30 15:43:55,308 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1068 tokens recorded.
2025-05-30 15:43:55,309 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 15:43:55,309 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 15:43:55,310 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğµ, Ñ‡Ñ‚Ğ¾ ÑĞ½Ğ¾Ğ²Ğ° Ğ²Ğ¾Ğ·Ğ½Ğ¸ĞºĞ»Ğ° Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾ Ñ‚Ğ²Ğ¾Ğ¸Ñ… Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°Ñ…. ĞÑ‡ĞµĞ½ÑŒ Ğ¶Ğ°Ğ»ÑŒ! ĞœĞ¾Ğ¶...
2025-05-30 15:43:55,311 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 77d32b1e-7779-40ae-a75c-971928cda2f9)
2025-05-30 15:43:55,312 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: 77d32b1e-7779-40ae-a75c-971928cda2f9.
2025-05-30 15:43:55,313 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğµ, Ñ‡Ñ‚Ğ¾ ÑĞ½Ğ¾Ğ²Ğ° Ğ²Ğ¾Ğ·Ğ½Ğ¸ĞºĞ»Ğ° Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾ Ñ‚Ğ²Ğ¾Ğ¸Ñ… Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°Ñ…. ĞÑ‡ĞµĞ½ÑŒ Ğ¶Ğ°Ğ»ÑŒ! ĞœĞ¾Ğ¶...
2025-05-30 15:43:55,313 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğµ, Ñ‡Ñ‚Ğ¾ ÑĞ½Ğ¾Ğ²Ğ° Ğ²Ğ¾Ğ·Ğ½Ğ¸ĞºĞ»Ğ° Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸ĞµĞ¼ Ğ¸...'
2025-05-30 15:43:55,314 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '77d32b1e-7779-40ae-a75c-971928cda2f9', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 982, 'completion_tokens': 16, 'total_tokens': 998, 'timestamp': '2025-05-30T10:43:53.134549+00:00'}
2025-05-30 15:43:55,314 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 77d32b1e-7779-40ae-a75c-971928cda2f9
2025-05-30 15:43:55,319 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 77d32b1e-7779-40ae-a75c-971928cda2f9, db_id: 980
2025-05-30 15:43:55,346 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 980 for interaction_id: 77d32b1e-7779-40ae-a75c-971928cda2f9 on attempt 1
2025-05-30 15:43:55,352 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 77d32b1e-7779-40ae-a75c-971928cda2f9, db_id: 448
2025-05-30 15:43:55,355 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '77d32b1e-7779-40ae-a75c-971928cda2f9', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1017, 'completion_tokens': 51, 'total_tokens': 1068, 'timestamp': '2025-05-30T10:43:55.308358+00:00'}
2025-05-30 15:43:55,355 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 77d32b1e-7779-40ae-a75c-971928cda2f9
2025-05-30 15:43:55,356 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 980 for interaction_id: 77d32b1e-7779-40ae-a75c-971928cda2f9 on attempt 1
2025-05-30 15:43:55,359 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 77d32b1e-7779-40ae-a75c-971928cda2f9, db_id: 449
2025-05-30 15:44:59,976 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 15:44:59,976 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 15:44:59,976 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 15:44:59,976 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4581137568) was cancelled.
2025-05-30 15:44:59,976 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4581137568) stopping. Performing cleanup...
2025-05-30 15:44:59,976 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:44:59,980 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 15:44:59,981 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 15:44:59,981 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:44:59,981 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 15:44:59,981 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:44:59,981 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4581137568) cleanup complete.
2025-05-30 15:44:59,981 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 15:44:59,981 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 15:44:59,981 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4647782112) was cancelled.
2025-05-30 15:44:59,981 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4647782112) stopping. Performing cleanup...
2025-05-30 15:44:59,981 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:44:59,984 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 15:44:59,985 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 15:44:59,985 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:44:59,985 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 15:44:59,985 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:44:59,985 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4647782112) cleanup complete.
2025-05-30 15:44:59,985 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 15:44:59,985 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 15:44:59,985 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4647781920) was cancelled.
2025-05-30 15:44:59,985 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4647781920) stopping. Performing cleanup...
2025-05-30 15:44:59,985 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 15:44:59,985 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:44:59,985 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 15:44:59,985 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 15:44:59,985 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:44:59,987 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 15:44:59,988 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 15:44:59,988 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:44:59,988 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 15:44:59,988 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:44:59,988 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 15:44:59,988 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4647781920) cleanup complete.
2025-05-30 15:44:59,988 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 15:44:59,988 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 15:44:59,988 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 15:44:59,993 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 15:44:59,993 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 15:45:00,451 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 15:45:00,451 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 15:45:00,456 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 15:45:00,456 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 15:45:00,456 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 15:45:00,456 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 15:45:00,456 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 15:45:00,456 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 15:45:00,456 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 15:45:00,456 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 15:45:00,457 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 15:45:00,457 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 15:45:00,457 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 15:45:00,459 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 15:45:00,474 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 15:45:00,474 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 15:45:00,474 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 15:45:00,474 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 15:45:00,474 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 15:45:00,474 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 15:45:00,476 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 15:45:00,476 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 15:45:00,476 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4601533728) setup complete. Starting run loop.
2025-05-30 15:45:00,476 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 15:45:00,477 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 15:45:00,477 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4601919440) setup complete. Starting run loop.
2025-05-30 15:45:00,477 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 15:45:00,478 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 15:45:00,478 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 15:45:00,506 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 15:45:00,506 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 15:45:00,507 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 15:45:00,507 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 15:45:00,507 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 15:45:00,508 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 15:45:00,509 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:45:00,509 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 15:45:00,509 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 15:45:00,509 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 15:45:10,480 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 15:45:10,484 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 15:45:10,484 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4601919488) setup complete. Starting run loop.
2025-05-30 15:45:10,484 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 15:46:13,759 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 15:46:13,759 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 15:46:13,759 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 15:46:13,759 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4601533728) was cancelled.
2025-05-30 15:46:13,759 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4601533728) stopping. Performing cleanup...
2025-05-30 15:46:13,759 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:46:13,764 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 15:46:13,765 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 15:46:13,765 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:46:13,765 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 15:46:13,765 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:46:13,765 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4601533728) cleanup complete.
2025-05-30 15:46:13,765 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 15:46:13,766 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 15:46:13,766 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4601919440) was cancelled.
2025-05-30 15:46:13,766 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4601919440) stopping. Performing cleanup...
2025-05-30 15:46:13,766 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:46:13,769 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 15:46:13,770 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 15:46:13,770 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:46:13,770 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 15:46:13,770 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:46:13,770 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4601919440) cleanup complete.
2025-05-30 15:46:13,770 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 15:46:13,770 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 15:46:13,770 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4601919488) was cancelled.
2025-05-30 15:46:13,770 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4601919488) stopping. Performing cleanup...
2025-05-30 15:46:13,770 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 15:46:13,770 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:46:13,771 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 15:46:13,771 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 15:46:13,771 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:46:13,773 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 15:46:13,774 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 15:46:13,774 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:46:13,774 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 15:46:13,774 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:46:13,774 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 15:46:13,774 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4601919488) cleanup complete.
2025-05-30 15:46:13,774 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 15:46:13,774 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 15:46:13,774 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 15:46:13,778 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 15:46:13,778 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 15:46:14,247 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 15:46:14,247 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 15:46:14,251 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 15:46:14,251 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 15:46:14,251 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 15:46:14,251 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 15:46:14,251 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 15:46:14,251 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 15:46:14,251 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 15:46:14,251 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 15:46:14,252 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 15:46:14,252 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 15:46:14,252 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 15:46:14,254 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 15:46:14,270 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 15:46:14,270 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 15:46:14,271 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 15:46:14,271 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 15:46:14,271 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 15:46:14,271 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 15:46:14,273 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 15:46:14,273 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4409187488) setup complete. Starting run loop.
2025-05-30 15:46:14,273 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 15:46:14,273 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 15:46:14,273 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 15:46:14,273 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4412900320) setup complete. Starting run loop.
2025-05-30 15:46:14,273 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 15:46:14,275 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 15:46:14,275 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 15:46:14,305 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 15:46:14,305 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 15:46:14,306 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 15:46:14,306 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 15:46:14,306 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 15:46:14,307 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 15:46:14,308 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:46:14,308 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 15:46:14,308 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 15:46:14,308 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 15:46:24,275 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 15:46:24,279 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 15:46:24,279 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4412900032) setup complete. Starting run loop.
2025-05-30 15:46:24,279 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 15:50:58,445 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 15:50:58,445 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 15:50:58,445 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 15:50:58,445 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4409187488) was cancelled.
2025-05-30 15:50:58,445 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4409187488) stopping. Performing cleanup...
2025-05-30 15:50:58,445 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:50:58,449 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 15:50:58,450 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 15:50:58,450 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:50:58,450 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 15:50:58,450 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:50:58,450 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4409187488) cleanup complete.
2025-05-30 15:50:58,450 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 15:50:58,450 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 15:50:58,450 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4412900320) was cancelled.
2025-05-30 15:50:58,450 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4412900320) stopping. Performing cleanup...
2025-05-30 15:50:58,450 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:50:58,453 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 15:50:58,454 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 15:50:58,454 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:50:58,455 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 15:50:58,455 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:50:58,455 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4412900320) cleanup complete.
2025-05-30 15:50:58,455 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 15:50:58,455 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 15:50:58,455 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4412900032) was cancelled.
2025-05-30 15:50:58,455 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4412900032) stopping. Performing cleanup...
2025-05-30 15:50:58,455 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 15:50:58,455 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:50:58,455 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 15:50:58,455 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 15:50:58,455 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:50:58,457 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 15:50:58,458 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 15:50:58,458 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:50:58,458 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 15:50:58,458 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:50:58,458 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 15:50:58,458 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4412900032) cleanup complete.
2025-05-30 15:50:58,458 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 15:50:58,458 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 15:50:58,458 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 15:50:58,461 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 15:50:58,461 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 15:50:58,937 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 15:50:58,937 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 15:50:58,942 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 15:50:58,942 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 15:50:58,942 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 15:50:58,942 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 15:50:58,942 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 15:50:58,942 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 15:50:58,942 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 15:50:58,942 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 15:50:58,942 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 15:50:58,943 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 15:50:58,943 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 15:50:58,945 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 15:50:58,961 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 15:50:58,961 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 15:50:58,961 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 15:50:58,961 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 15:50:58,962 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 15:50:58,962 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 15:50:58,963 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 15:50:58,963 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4719123616) setup complete. Starting run loop.
2025-05-30 15:50:58,963 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 15:50:58,963 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 15:50:58,963 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 15:50:58,963 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4733008208) setup complete. Starting run loop.
2025-05-30 15:50:58,963 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 15:50:58,975 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 15:50:58,975 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 15:50:58,995 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 15:50:58,995 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 15:50:58,996 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 15:50:58,996 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 15:50:58,996 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 15:50:58,997 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 15:50:58,998 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:50:58,998 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 15:50:58,998 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 15:50:58,998 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 15:51:01,444 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 15:51:01,445 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4645565744) received shutdown request. Initiating graceful shutdown...
2025-05-30 15:51:01,445 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4645565744)...
2025-05-30 15:51:01,445 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 15:51:01,445 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 15:51:01,445 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 15:51:01,445 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4645565744) was cancelled.
2025-05-30 15:51:01,445 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4645565744) stopping. Performing cleanup...
2025-05-30 15:51:01,445 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 15:51:01,445 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 15:51:01,445 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 15:51:01,446 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-30 15:51:01,446 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 15:51:01,446 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 15:51:01,446 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 15:51:01,446 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 15:51:01,447 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 15:51:01,447 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 15:51:01,447 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 15:51:01,456 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 15:51:01,458 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 15:51:01,458 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:51:01,460 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 15:51:01,461 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 15:51:01,461 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 15:51:01,461 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4645565744) cleanup complete.
2025-05-30 15:51:01,461 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 15:51:01,461 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 15:51:01,471 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 15:51:01,471 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 15:51:01,471 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 15:51:01,475 - INFO - __main__ - Agent runner main finished.
2025-05-30 15:51:01,616 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 15:51:01,617 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 15:51:01,617 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 15:51:01,617 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4719123616) was cancelled.
2025-05-30 15:51:01,617 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4719123616) stopping. Performing cleanup...
2025-05-30 15:51:01,617 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:51:01,622 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 15:51:01,622 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 15:51:01,623 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:51:01,623 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 15:51:01,623 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:51:01,623 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4719123616) cleanup complete.
2025-05-30 15:51:01,623 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 15:51:01,623 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 15:51:01,623 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4733008208) was cancelled.
2025-05-30 15:51:01,623 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4733008208) stopping. Performing cleanup...
2025-05-30 15:51:01,623 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:51:01,626 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 15:51:01,626 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 15:51:01,626 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:51:01,627 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 15:51:01,627 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:51:01,627 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4733008208) cleanup complete.
2025-05-30 15:51:01,627 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 15:51:01,627 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 15:51:01,627 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4733008256) was cancelled.
2025-05-30 15:51:01,627 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4733008256) stopping. Performing cleanup...
2025-05-30 15:51:01,627 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 15:51:01,627 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:51:01,627 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 15:51:01,627 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 15:51:01,627 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:51:01,629 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 15:51:01,629 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 15:51:01,629 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:51:01,629 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 15:51:01,629 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:51:01,629 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 15:51:01,629 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4733008256) cleanup complete.
2025-05-30 15:51:01,629 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 15:51:01,629 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 15:51:01,630 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 15:51:01,632 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 15:51:01,632 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 15:51:01,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 15:51:01,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 15:51:01,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 15:51:01,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4430325536) received shutdown request. Initiating graceful shutdown...
2025-05-30 15:51:01,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4430325536)...
2025-05-30 15:51:01,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 15:51:01,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 15:51:01,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4430325536) was cancelled.
2025-05-30 15:51:01,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4430325536) stopping. Performing cleanup...
2025-05-30 15:51:01,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 15:51:01,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 15:51:01,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 15:51:01,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 15:51:01,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 15:51:01,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 15:51:01,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 15:51:01,698 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 15:51:01,698 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 15:51:01,698 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 15:51:01,702 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 15:51:01,703 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 15:51:01,703 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:51:01,703 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 15:51:01,703 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 15:51:01,703 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 15:51:01,703 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4430325536) cleanup complete.
2025-05-30 15:51:01,703 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 15:51:01,703 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 15:51:01,707 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 15:51:01,708 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 15:51:01,708 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 15:51:01,708 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 15:51:07,065 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 15:51:07,065 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 15:51:07,069 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 15:51:07,069 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 15:51:07,069 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 15:51:07,069 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 15:51:07,069 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 15:51:07,069 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 15:51:07,069 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 15:51:07,069 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 15:51:07,070 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 15:51:07,070 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 15:51:07,070 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 15:51:07,072 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 15:51:07,072 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 15:51:07,072 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 15:51:07,087 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 15:51:07,087 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 15:51:07,087 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 15:51:07,087 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 15:51:07,089 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 15:51:07,089 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 15:51:07,089 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4451206400) setup complete. Starting run loop.
2025-05-30 15:51:07,089 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 15:51:07,090 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 15:51:07,090 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4451206208) setup complete. Starting run loop.
2025-05-30 15:51:07,090 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 15:51:07,091 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 15:51:07,091 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 15:51:07,120 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 15:51:07,120 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 15:51:07,121 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 15:51:07,122 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 75287
2025-05-30 15:51:07,122 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 75287
2025-05-30 15:51:07,123 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 15:51:07,123 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 15:51:07,123 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 15:51:07,125 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 15:51:07,125 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 75288
2025-05-30 15:51:07,125 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 75288
2025-05-30 15:51:07,126 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 15:51:07,127 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:51:07,127 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 15:51:07,127 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 15:51:07,127 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 15:51:08,051 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 15:51:08,052 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 15:51:08,052 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 15:51:08,052 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 15:51:08,052 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 75288
2025-05-30 15:51:08,052 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 15:51:08,052 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 15:51:08,052 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 15:51:08,058 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 15:51:08,072 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 15:51:08,072 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 15:51:08,072 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 15:51:08,072 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4666091824) setup complete. Starting run loop.
2025-05-30 15:51:08,072 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 15:51:08,072 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 15:51:08,072 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 15:51:08,072 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 15:51:08,072 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 15:51:08,072 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 15:51:08,072 - INFO - aiogram.dispatcher - Start polling
2025-05-30 15:51:08,075 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 15:51:08,323 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 15:51:08,404 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 15:51:08,405 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 15:51:08,405 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 15:51:08,405 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 15:51:08,405 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 75287
2025-05-30 15:51:08,405 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 15:51:08,405 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 15:51:08,405 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 15:51:08,447 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 15:51:08,447 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 15:51:08,490 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 15:51:08,490 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 15:51:08,491 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 15:51:08,491 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 15:51:08,491 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 15:51:08,491 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 15:51:08,516 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 15:51:08,517 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 15:51:08,517 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 15:51:08,518 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 15:51:08,518 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET)
2025-05-30 15:51:08,518 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 15:51:08,518 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 15:51:08,574 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 15:51:08,577 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 15:51:09,406 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 15:51:09,408 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 15:51:09,408 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 15:51:09,408 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 15:51:09,409 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 15:51:09,409 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 15:51:09,409 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 15:51:09,409 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 15:51:09,409 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 15:51:09,409 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 15:51:09,409 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 15:51:09,410 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 15:51:09,410 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 15:51:09,410 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 15:51:09,410 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 15:51:09,410 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 15:51:09,420 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 15:51:09,420 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 15:51:09,420 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 15:51:09,420 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4835062656) setup complete. Starting run loop.
2025-05-30 15:51:09,420 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 15:51:09,420 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 15:51:09,420 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 15:51:09,420 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 15:51:09,423 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 15:51:17,091 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 15:51:17,098 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 15:51:17,098 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4451206352) setup complete. Starting run loop.
2025-05-30 15:51:17,098 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 15:51:34,980 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'ĞšĞ°ĞºĞ¾Ğ¹ Ñƒ Ğ¼ĞµĞ½Ñ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²?...'
2025-05-30 15:51:34,981 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache miss for user 144641834, agent agent_airsoft_0faa9616. Checking DB.
2025-05-30 15:51:35,055 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - User 144641834 (DBID: 1) IS authorized for agent agent_airsoft_0faa9616 via DB.
2025-05-30 15:51:35,060 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 15:51:35,060 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 15:51:35,060 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 15:51:35,061 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: e973735e-bfc3-4535-85ea-d439c050ab59)
2025-05-30 15:51:35,061 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 15:51:35,061 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-30 15:51:35,082 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: e973735e-bfc3-4535-85ea-d439c050ab59, db_id: 981
2025-05-30 15:51:35,097 - INFO - AGENT:agent_airsoft_0faa9616 - Loaded 20 messages from DB for thread '144641834'.
2025-05-30 15:51:35,097 - INFO - AGENT:agent_airsoft_0faa9616 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-30 15:51:35,097 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-30 15:51:35,165 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 15:51:35,165 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 15:51:35,190 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 15:51:35,193 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 15:51:36,061 - INFO - aiogram.event - Update id=804756334 is handled. Duration 1081 ms by bot id=1750613938
2025-05-30 15:51:36,165 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 15:51:36,192 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 15:51:36,192 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 15:51:36,192 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1009, 'output_tokens': 16, 'total_tokens': 1025, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 15:51:36,192 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1009 C:16 T:1025
2025-05-30 15:51:36,192 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1025 tokens recorded.
2025-05-30 15:51:36,193 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 15:51:36,193 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748589354598
2025-05-30 15:51:36,193 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748589354598)---
2025-05-30 15:51:36,195 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹'
2025-05-30 15:51:36,195 - INFO - app.agent_runner.common.tools_registry - Function parameters: api_config=True, log_adapter=True, state=True
2025-05-30 15:51:36,195 - INFO - app.agent_runner.common.tools_registry - State type: <class 'dict'>
2025-05-30 15:51:36,195 - INFO - app.agent_runner.common.tools_registry - State keys: ['messages', 'documents', 'question', 'original_question', 'rewrite_count', 'channel', 'user_data', 'token_usage_events']
2025-05-30 15:51:36,195 - INFO - app.agent_runner.common.tools_registry - User data extracted: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 15:51:36,195 - INFO - app.agent_runner.common.tools_registry - Final user_data for API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹': {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 15:51:36,195 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 15:51:36,195 - INFO - app.agent_runner.common.tools_registry - Headers type: <class 'dict'>, value: {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36', 'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7', 'Accept-Language': 'ru-RU,ru;q=0.9,en;q=0.8', 'Accept-Encoding': 'gzip, deflate, br', 'DNT': '1', 'Connection': 'keep-alive', 'Upgrade-Insecure-Requests': '1', 'Sec-Fetch-Dest': 'document', 'Sec-Fetch-Mode': 'navigate', 'Sec-Fetch-Site': 'same-origin', 'Sec-Fetch-User': '?1', 'Cache-Control': 'max-age=0', 'Referer': 'https://airsoft-rus.ru/', 'Cookie': 'PHPSESSID=gq3cMIY4z4t5OLt12aMMcFrus6CEIhZR'}
2025-05-30 15:51:36,195 - INFO - app.agent_runner.common.tools_registry - Query Params: {'type': 'info', 'tel': '79222088435'}
2025-05-30 15:51:36,195 - INFO - app.agent_runner.common.tools_registry - Attempting Cloudflare bypass with cloudscraper for https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 15:51:36,852 - INFO - app.agent_runner.common.tools_registry - Cloudscraper request successful with status 200
2025-05-30 15:51:36,852 - INFO - app.agent_runner.common.tools_registry - API Response Status: 200
2025-05-30 15:51:36,852 - INFO - app.agent_runner.common.tools_registry - API Response Headers: {'Date': 'Fri, 30 May 2025 10:51:36 GMT', 'Content-Type': 'text/html; charset=UTF-8', 'Transfer-Encoding': 'chunked', 'Connection': 'keep-alive', 'Server': 'cloudflare', 'Nel': '{"success_fraction":0,"report_to":"cf-nel","max_age":604800}', 'Cf-Ray': '947dad61cc51665b-AMS', 'Vary': 'HTTPS', 'X-Powered-By': 'PHP/7.3.33', 'P3p': 'policyref="/bitrix/p3p.xml", CP="NON DSP COR CUR ADM DEV PSA PSD OUR UNR BUS UNI COM NAV INT DEM STA"', 'X-Powered-Cms': 'Bitrix Site Manager (16899fb15b29f3b6cb9157e0b568ff46)', 'Expires': 'Thu, 19 Nov 1981 08:52:00 GMT', 'Cache-Control': 'no-store, no-cache, must-revalidate', 'Pragma': 'no-cache', 'X-Frame-Options': 'SAMEORIGIN', 'Content-Encoding': 'br', 'Permissions-Policy': 'browsing-topics=()', 'Strict-Transport-Security': ': max-age=3600', 'Cf-Cache-Status': 'DYNAMIC', 'Report-To': '{"endpoints":[{"url":"https:\\/\\/a.nel.cloudflare.com\\/report\\/v4?s=flBwb%2BrECsWIPuBNh2YS3kFesuf3Sk3tHhWPH%2BRrTMhRem8uBplqdwbXBHOtXDbWt1B9i7QeM%2FbVhyt0WoYtYZ4B5WAyEmeVskGKirLsHDWukaLPhEdNTKlfFRX5ZKVj"}],"group":"cf-nel","max_age":604800}', 'Set-Cookie': 'PHPSESSID=7IAlIWh4ZG1tSsH5AIKi9b0B9E8TeS8K; HttpOnly; Secure; Path=/', 'server-timing': 'cfL4;desc="?proto=TCP&rtt=111980&min_rtt=111224&rtt_var=42249&sent=5&recv=6&lost=0&retrans=0&sent_bytes=2882&recv_bytes=1326&delivery_rate=36359&cwnd=252&unsent_bytes=0&cid=754d92300b9490e5&ts=375&x=0"'}
2025-05-30 15:51:36,852 - INFO - app.agent_runner.common.tools_registry - API Response Content-Type: text/html; charset=UTF-8
2025-05-30 15:51:36,852 - INFO - app.agent_runner.common.tools_registry - API Response Content Length: 7 bytes
2025-05-30 15:51:36,852 - INFO - app.agent_runner.common.tools_registry - API Response Content Preview (first 1000 chars): ï¿½574
2025-05-30 15:51:36,852 - WARNING - app.agent_runner.common.tools_registry - Failed to parse JSON response: Expecting value: line 1 column 1 (char 0)
2025-05-30 15:51:36,852 - INFO - app.agent_runner.common.tools_registry - Returning raw text response
2025-05-30 15:51:36,854 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 15:51:36,854 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 15:51:36,878 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 15:51:36,881 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 15:51:37,837 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 15:51:38,795 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ•Ğ²Ğ³ĞµĞ½Ğ¸Ğ¹, Ğº ÑĞ¾Ğ¶Ğ°Ğ»ĞµĞ½Ğ¸Ñ, ÑĞµĞ¹Ñ‡Ğ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¸Ñ‚ÑŒ Ñ‚Ğ²Ğ¾Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² Ğ¸Ğ·-Ğ·Ğ°
2025-05-30 15:51:38,795 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 15:51:38,795 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1044, 'output_tokens': 60, 'total_tokens': 1104, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 15:51:38,795 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1044 C:60 T:1104
2025-05-30 15:51:38,796 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1104 tokens recorded.
2025-05-30 15:51:38,797 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 15:51:38,797 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 15:51:38,798 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ•Ğ²Ğ³ĞµĞ½Ğ¸Ğ¹, Ğº ÑĞ¾Ğ¶Ğ°Ğ»ĞµĞ½Ğ¸Ñ, ÑĞµĞ¹Ñ‡Ğ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¸Ñ‚ÑŒ Ñ‚Ğ²Ğ¾Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² Ğ¸Ğ·-Ğ·Ğ°...
2025-05-30 15:51:38,799 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: e973735e-bfc3-4535-85ea-d439c050ab59)
2025-05-30 15:51:38,800 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: e973735e-bfc3-4535-85ea-d439c050ab59.
2025-05-30 15:51:38,801 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Ğ•Ğ²Ğ³ĞµĞ½Ğ¸Ğ¹, Ğº ÑĞ¾Ğ¶Ğ°Ğ»ĞµĞ½Ğ¸Ñ, ÑĞµĞ¹Ñ‡Ğ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¸Ñ‚ÑŒ Ñ‚Ğ²Ğ¾Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² Ğ¸Ğ·-Ğ·Ğ°...
2025-05-30 15:51:38,802 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Ğ•Ğ²Ğ³ĞµĞ½Ğ¸Ğ¹, Ğº ÑĞ¾Ğ¶Ğ°Ğ»ĞµĞ½Ğ¸Ñ, ÑĞµĞ¹Ñ‡Ğ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ ĞºĞ¾Ñ€Ñ€...'
2025-05-30 15:51:38,802 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'e973735e-bfc3-4535-85ea-d439c050ab59', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1009, 'completion_tokens': 16, 'total_tokens': 1025, 'timestamp': '2025-05-30T10:51:36.192917+00:00'}
2025-05-30 15:51:38,802 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: e973735e-bfc3-4535-85ea-d439c050ab59
2025-05-30 15:51:38,807 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: e973735e-bfc3-4535-85ea-d439c050ab59, db_id: 982
2025-05-30 15:51:38,834 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 982 for interaction_id: e973735e-bfc3-4535-85ea-d439c050ab59 on attempt 1
2025-05-30 15:51:38,839 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: e973735e-bfc3-4535-85ea-d439c050ab59, db_id: 450
2025-05-30 15:51:38,842 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'e973735e-bfc3-4535-85ea-d439c050ab59', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1044, 'completion_tokens': 60, 'total_tokens': 1104, 'timestamp': '2025-05-30T10:51:38.796003+00:00'}
2025-05-30 15:51:38,842 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: e973735e-bfc3-4535-85ea-d439c050ab59
2025-05-30 15:51:38,843 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 982 for interaction_id: e973735e-bfc3-4535-85ea-d439c050ab59 on attempt 1
2025-05-30 15:51:38,846 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: e973735e-bfc3-4535-85ea-d439c050ab59, db_id: 451
2025-05-30 15:56:17,278 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 15:56:17,286 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 15:56:46,090 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 15:56:46,090 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4835062656) received shutdown request. Initiating graceful shutdown...
2025-05-30 15:56:46,090 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4835062656)...
2025-05-30 15:56:46,090 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 15:56:46,090 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 15:56:46,090 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 15:56:46,090 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4835062656) was cancelled.
2025-05-30 15:56:46,090 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4835062656) stopping. Performing cleanup...
2025-05-30 15:56:46,090 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 15:56:46,090 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 15:56:46,091 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 15:56:46,091 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-30 15:56:46,092 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 15:56:46,092 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 15:56:46,092 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 15:56:46,092 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 15:56:46,092 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 15:56:46,092 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 15:56:46,092 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 15:56:46,096 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 15:56:46,097 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 15:56:46,097 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:56:46,098 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 15:56:46,098 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 15:56:46,098 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 15:56:46,098 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4835062656) cleanup complete.
2025-05-30 15:56:46,098 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 15:56:46,098 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 15:56:46,103 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 15:56:46,103 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 15:56:46,103 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 15:56:46,104 - INFO - __main__ - Agent runner main finished.
2025-05-30 15:56:46,273 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 15:56:46,273 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 15:56:46,273 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 15:56:46,273 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4451206400) was cancelled.
2025-05-30 15:56:46,273 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4451206400) stopping. Performing cleanup...
2025-05-30 15:56:46,273 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:56:46,278 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 15:56:46,279 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 15:56:46,279 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:56:46,279 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 15:56:46,279 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:56:46,279 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4451206400) cleanup complete.
2025-05-30 15:56:46,279 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 15:56:46,279 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 15:56:46,279 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4451206208) was cancelled.
2025-05-30 15:56:46,279 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4451206208) stopping. Performing cleanup...
2025-05-30 15:56:46,279 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:56:46,282 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 15:56:46,283 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 15:56:46,283 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:56:46,283 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 15:56:46,283 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:56:46,283 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4451206208) cleanup complete.
2025-05-30 15:56:46,283 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 15:56:46,283 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 15:56:46,283 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4451206352) was cancelled.
2025-05-30 15:56:46,283 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4451206352) stopping. Performing cleanup...
2025-05-30 15:56:46,283 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 15:56:46,283 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:56:46,284 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 15:56:46,284 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 15:56:46,284 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:56:46,286 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 15:56:46,287 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 15:56:46,287 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:56:46,287 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 15:56:46,287 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:56:46,287 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 15:56:46,287 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4451206352) cleanup complete.
2025-05-30 15:56:46,287 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 15:56:46,287 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 15:56:46,287 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 15:56:46,294 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 15:56:46,294 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 15:56:46,341 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 15:56:46,341 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 15:56:46,341 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 15:56:46,341 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4666091824) received shutdown request. Initiating graceful shutdown...
2025-05-30 15:56:46,341 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4666091824)...
2025-05-30 15:56:46,341 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 15:56:46,341 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 15:56:46,341 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4666091824) was cancelled.
2025-05-30 15:56:46,341 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4666091824) stopping. Performing cleanup...
2025-05-30 15:56:46,341 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 15:56:46,341 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 15:56:46,341 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 15:56:46,342 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 15:56:46,342 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 15:56:46,342 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 15:56:46,342 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 15:56:46,342 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 15:56:46,342 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 15:56:46,342 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 15:56:46,345 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 15:56:46,346 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 15:56:46,346 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:56:46,346 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 15:56:46,346 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 15:56:46,346 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 15:56:46,346 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4666091824) cleanup complete.
2025-05-30 15:56:46,347 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 15:56:46,347 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 15:56:46,353 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 15:56:46,353 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 15:56:46,353 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 15:56:46,353 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 15:56:52,278 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 15:56:52,278 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 15:56:52,282 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 15:56:52,282 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 15:56:52,282 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 15:56:52,282 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 15:56:52,282 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 15:56:52,283 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 15:56:52,283 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 15:56:52,283 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 15:56:52,283 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 15:56:52,283 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 15:56:52,283 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 15:56:52,285 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 15:56:52,300 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 15:56:52,300 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 15:56:52,300 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 15:56:52,300 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 15:56:52,300 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 15:56:52,300 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 15:56:52,302 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 15:56:52,302 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 15:56:52,302 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4440933008) setup complete. Starting run loop.
2025-05-30 15:56:52,302 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 15:56:52,303 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 15:56:52,303 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4440932816) setup complete. Starting run loop.
2025-05-30 15:56:52,303 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 15:56:52,304 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 15:56:52,304 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 15:56:52,336 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 15:56:52,336 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 15:56:52,337 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 15:56:52,338 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 75815
2025-05-30 15:56:52,338 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 75815
2025-05-30 15:56:52,339 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 15:56:52,339 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 15:56:52,339 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 15:56:52,341 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 15:56:52,341 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 75816
2025-05-30 15:56:52,341 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 75816
2025-05-30 15:56:52,342 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 15:56:52,342 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:56:52,343 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 15:56:52,343 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 15:56:52,343 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 15:56:53,239 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 15:56:53,239 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 15:56:53,239 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 15:56:53,239 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 15:56:53,239 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 75816
2025-05-30 15:56:53,239 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 15:56:53,239 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 15:56:53,239 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 15:56:53,244 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 15:56:53,257 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 15:56:53,257 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 15:56:53,257 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 15:56:53,257 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4392233360) setup complete. Starting run loop.
2025-05-30 15:56:53,257 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 15:56:53,257 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 15:56:53,257 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 15:56:53,258 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 15:56:53,258 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 15:56:53,258 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 15:56:53,258 - INFO - aiogram.dispatcher - Start polling
2025-05-30 15:56:53,261 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 15:56:53,503 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 15:56:53,599 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 15:56:53,600 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 15:56:53,600 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 15:56:53,600 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 15:56:53,600 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 75815
2025-05-30 15:56:53,600 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 15:56:53,600 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 15:56:53,600 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 15:56:53,642 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 15:56:53,643 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 15:56:53,687 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 15:56:53,688 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 15:56:53,688 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 15:56:53,688 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 15:56:53,688 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 15:56:53,688 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 15:56:53,713 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 15:56:53,714 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 15:56:53,714 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 15:56:53,715 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 15:56:53,715 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET)
2025-05-30 15:56:53,715 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 15:56:53,716 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 15:56:53,771 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 15:56:53,776 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 15:56:54,386 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 15:56:54,389 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 15:56:54,389 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 15:56:54,389 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 15:56:54,389 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 15:56:54,389 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 15:56:54,389 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 15:56:54,389 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 15:56:54,390 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 15:56:54,390 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 15:56:54,390 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 15:56:54,390 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 15:56:54,391 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 15:56:54,391 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 15:56:54,391 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 15:56:54,391 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 15:56:54,401 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 15:56:54,402 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 15:56:54,402 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 15:56:54,403 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4786074880) setup complete. Starting run loop.
2025-05-30 15:56:54,404 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 15:56:54,404 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 15:56:54,405 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 15:56:54,406 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 15:56:54,416 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 15:57:02,305 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 15:57:02,309 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 15:57:02,309 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4440932960) setup complete. Starting run loop.
2025-05-30 15:57:02,309 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 15:57:36,746 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑŒ Ğ¼Ğ¾Ğ¸ Ğ±Ğ±...'
2025-05-30 15:57:36,748 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 15:57:36,814 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 15:57:36,814 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 15:57:36,814 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 15:57:36,815 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: a8cbd766-cb77-4a09-b329-6f23fb921f1b)
2025-05-30 15:57:36,815 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 15:57:36,816 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-30 15:57:36,837 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: a8cbd766-cb77-4a09-b329-6f23fb921f1b, db_id: 983
2025-05-30 15:57:36,852 - INFO - AGENT:agent_airsoft_0faa9616 - Loaded 20 messages from DB for thread '144641834'.
2025-05-30 15:57:36,852 - INFO - AGENT:agent_airsoft_0faa9616 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-30 15:57:36,852 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-30 15:57:36,913 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 15:57:36,913 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 15:57:36,938 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 15:57:36,942 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 15:57:37,816 - INFO - aiogram.event - Update id=804756335 is handled. Duration 1068 ms by bot id=1750613938
2025-05-30 15:57:38,248 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 15:57:38,275 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 15:57:38,275 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 15:57:38,275 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1013, 'output_tokens': 16, 'total_tokens': 1029, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 15:57:38,275 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1013 C:16 T:1029
2025-05-30 15:57:38,275 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1029 tokens recorded.
2025-05-30 15:57:38,276 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 15:57:38,276 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748589354598
2025-05-30 15:57:38,276 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748589354598)---
2025-05-30 15:57:38,278 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹'
2025-05-30 15:57:38,278 - INFO - app.agent_runner.common.tools_registry - Function parameters: api_config=True, log_adapter=True, state=True
2025-05-30 15:57:38,278 - INFO - app.agent_runner.common.tools_registry - State type: <class 'dict'>
2025-05-30 15:57:38,278 - INFO - app.agent_runner.common.tools_registry - State keys: ['messages', 'documents', 'question', 'original_question', 'rewrite_count', 'channel', 'user_data', 'token_usage_events']
2025-05-30 15:57:38,278 - INFO - app.agent_runner.common.tools_registry - User data extracted: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 15:57:38,278 - INFO - app.agent_runner.common.tools_registry - Final user_data for API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹': {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 15:57:38,278 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 15:57:38,278 - INFO - app.agent_runner.common.tools_registry - Headers type: <class 'dict'>, value: {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36', 'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7', 'Accept-Language': 'ru-RU,ru;q=0.9,en;q=0.8', 'Accept-Encoding': 'gzip, deflate, br', 'DNT': '1', 'Connection': 'keep-alive', 'Upgrade-Insecure-Requests': '1', 'Sec-Fetch-Dest': 'document', 'Sec-Fetch-Mode': 'navigate', 'Sec-Fetch-Site': 'same-origin', 'Sec-Fetch-User': '?1', 'Cache-Control': 'max-age=0', 'Referer': 'https://airsoft-rus.ru/', 'Cookie': 'PHPSESSID=gq3cMIY4z4t5OLt12aMMcFrus6CEIhZR'}
2025-05-30 15:57:38,278 - INFO - app.agent_runner.common.tools_registry - Query Params: {'type': 'info', 'tel': '79222088435'}
2025-05-30 15:57:38,278 - INFO - app.agent_runner.common.tools_registry - Attempting Cloudflare bypass with cloudscraper for https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 15:57:38,782 - INFO - app.agent_runner.common.tools_registry - Cloudscraper request successful with status 200
2025-05-30 15:57:38,782 - INFO - app.agent_runner.common.tools_registry - API Response Status: 200
2025-05-30 15:57:38,782 - INFO - app.agent_runner.common.tools_registry - API Response Headers: {'Date': 'Fri, 30 May 2025 10:57:38 GMT', 'Content-Type': 'text/html; charset=UTF-8', 'Transfer-Encoding': 'chunked', 'Connection': 'keep-alive', 'Server': 'cloudflare', 'Nel': '{"success_fraction":0,"report_to":"cf-nel","max_age":604800}', 'Cf-Ray': '947db6389b0db8c6-AMS', 'Vary': 'HTTPS', 'X-Powered-By': 'PHP/7.3.33', 'P3p': 'policyref="/bitrix/p3p.xml", CP="NON DSP COR CUR ADM DEV PSA PSD OUR UNR BUS UNI COM NAV INT DEM STA"', 'X-Powered-Cms': 'Bitrix Site Manager (16899fb15b29f3b6cb9157e0b568ff46)', 'Expires': 'Thu, 19 Nov 1981 08:52:00 GMT', 'Cache-Control': 'no-store, no-cache, must-revalidate', 'Pragma': 'no-cache', 'X-Frame-Options': 'SAMEORIGIN', 'Content-Encoding': 'br', 'Permissions-Policy': 'browsing-topics=()', 'Strict-Transport-Security': ': max-age=3600', 'Cf-Cache-Status': 'DYNAMIC', 'Report-To': '{"endpoints":[{"url":"https:\\/\\/a.nel.cloudflare.com\\/report\\/v4?s=AtlbRv5QR%2Fjsn3ZLaqZnBuuC81smbNhyKt5OvbIIsxl6lNpnoWRlQEbQwQBNYyfgEpgghKqe5fOQSrP6Sue0crKRkepmjGdzDb4tvXV%2FhrOB7jzRJEwpdAddVEWYBIrP"}],"group":"cf-nel","max_age":604800}', 'Set-Cookie': 'PHPSESSID=AXFkWwYa2GggImCbCnIYrK7zeC9lTPe3; HttpOnly; Secure; Path=/', 'server-timing': 'cfL4;desc="?proto=TCP&rtt=113731&min_rtt=113576&rtt_var=42901&sent=5&recv=6&lost=0&retrans=0&sent_bytes=2882&recv_bytes=1326&delivery_rate=35220&cwnd=252&unsent_bytes=0&cid=e4b2af8fd69e351c&ts=258&x=0"'}
2025-05-30 15:57:38,782 - INFO - app.agent_runner.common.tools_registry - API Response Content-Type: text/html; charset=UTF-8
2025-05-30 15:57:38,782 - INFO - app.agent_runner.common.tools_registry - API Response Content Length: 7 bytes
2025-05-30 15:57:38,782 - INFO - app.agent_runner.common.tools_registry - API Response Content Preview (first 1000 chars): ï¿½574
2025-05-30 15:57:38,782 - WARNING - app.agent_runner.common.tools_registry - Failed to parse JSON response: Expecting value: line 1 column 1 (char 0)
2025-05-30 15:57:38,782 - INFO - app.agent_runner.common.tools_registry - Returning raw text response
2025-05-30 15:57:38,784 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 15:57:38,784 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 15:57:38,808 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 15:57:38,811 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 15:57:39,669 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 15:57:40,569 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ•Ğ²Ğ³ĞµĞ½Ğ¸Ğ¹, Ğº ÑĞ¾Ğ¶Ğ°Ğ»ĞµĞ½Ğ¸Ñ, ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ½Ğµ ÑƒĞ´Ğ°Ñ‘Ñ‚ÑÑ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ñ‚Ğ²Ğ¾Ğ¸Ñ… Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°Ñ… Ğ¸Ğ·-Ğ·Ğ° Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¾
2025-05-30 15:57:40,569 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 15:57:40,569 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1048, 'output_tokens': 54, 'total_tokens': 1102, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 15:57:40,569 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1048 C:54 T:1102
2025-05-30 15:57:40,569 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1102 tokens recorded.
2025-05-30 15:57:40,570 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 15:57:40,570 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 15:57:40,571 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ•Ğ²Ğ³ĞµĞ½Ğ¸Ğ¹, Ğº ÑĞ¾Ğ¶Ğ°Ğ»ĞµĞ½Ğ¸Ñ, ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ½Ğµ ÑƒĞ´Ğ°Ñ‘Ñ‚ÑÑ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ñ‚Ğ²Ğ¾Ğ¸Ñ… Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°Ñ… Ğ¸Ğ·-Ğ·Ğ° Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¾...
2025-05-30 15:57:40,573 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: a8cbd766-cb77-4a09-b329-6f23fb921f1b)
2025-05-30 15:57:40,573 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: a8cbd766-cb77-4a09-b329-6f23fb921f1b.
2025-05-30 15:57:40,575 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Ğ•Ğ²Ğ³ĞµĞ½Ğ¸Ğ¹, Ğº ÑĞ¾Ğ¶Ğ°Ğ»ĞµĞ½Ğ¸Ñ, ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ½Ğµ ÑƒĞ´Ğ°Ñ‘Ñ‚ÑÑ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ñ‚Ğ²Ğ¾Ğ¸Ñ… Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°Ñ… Ğ¸Ğ·-Ğ·Ğ° Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¾...
2025-05-30 15:57:40,575 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Ğ•Ğ²Ğ³ĞµĞ½Ğ¸Ğ¹, Ğº ÑĞ¾Ğ¶Ğ°Ğ»ĞµĞ½Ğ¸Ñ, ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ½Ğµ ÑƒĞ´Ğ°Ñ‘Ñ‚ÑÑ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¸...'
2025-05-30 15:57:40,576 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'a8cbd766-cb77-4a09-b329-6f23fb921f1b', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1013, 'completion_tokens': 16, 'total_tokens': 1029, 'timestamp': '2025-05-30T10:57:38.275604+00:00'}
2025-05-30 15:57:40,576 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: a8cbd766-cb77-4a09-b329-6f23fb921f1b
2025-05-30 15:57:40,589 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: a8cbd766-cb77-4a09-b329-6f23fb921f1b, db_id: 984
2025-05-30 15:57:40,607 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 984 for interaction_id: a8cbd766-cb77-4a09-b329-6f23fb921f1b on attempt 1
2025-05-30 15:57:40,613 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: a8cbd766-cb77-4a09-b329-6f23fb921f1b, db_id: 452
2025-05-30 15:57:40,616 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'a8cbd766-cb77-4a09-b329-6f23fb921f1b', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1048, 'completion_tokens': 54, 'total_tokens': 1102, 'timestamp': '2025-05-30T10:57:40.569872+00:00'}
2025-05-30 15:57:40,616 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: a8cbd766-cb77-4a09-b329-6f23fb921f1b
2025-05-30 15:57:40,617 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 984 for interaction_id: a8cbd766-cb77-4a09-b329-6f23fb921f1b on attempt 1
2025-05-30 15:57:40,620 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: a8cbd766-cb77-4a09-b329-6f23fb921f1b, db_id: 453
2025-05-30 15:58:21,604 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 15:58:21,604 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 15:58:21,604 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 15:58:21,604 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4440933008) was cancelled.
2025-05-30 15:58:21,604 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4440933008) stopping. Performing cleanup...
2025-05-30 15:58:21,604 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:58:21,608 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 15:58:21,609 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 15:58:21,609 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:58:21,609 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 15:58:21,609 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:58:21,610 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4440933008) cleanup complete.
2025-05-30 15:58:21,610 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 15:58:21,610 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 15:58:21,610 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4440932816) was cancelled.
2025-05-30 15:58:21,610 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4440932816) stopping. Performing cleanup...
2025-05-30 15:58:21,610 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:58:21,613 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 15:58:21,614 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 15:58:21,614 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:58:21,615 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 15:58:21,615 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:58:21,615 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4440932816) cleanup complete.
2025-05-30 15:58:21,615 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 15:58:21,615 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 15:58:21,615 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4440932960) was cancelled.
2025-05-30 15:58:21,615 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4440932960) stopping. Performing cleanup...
2025-05-30 15:58:21,615 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 15:58:21,615 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:58:21,615 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 15:58:21,615 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 15:58:21,615 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:58:21,617 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 15:58:21,618 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 15:58:21,618 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:58:21,618 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 15:58:21,618 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:58:21,618 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 15:58:21,618 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4440932960) cleanup complete.
2025-05-30 15:58:21,618 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 15:58:21,618 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 15:58:21,618 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 15:58:21,623 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 15:58:21,623 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 15:58:22,121 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 15:58:22,121 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 15:58:22,124 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 15:58:22,125 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 15:58:22,125 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 15:58:22,125 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 15:58:22,125 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 15:58:22,125 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 15:58:22,125 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 15:58:22,125 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 15:58:22,125 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 15:58:22,125 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 15:58:22,125 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 15:58:22,127 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 15:58:22,155 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 15:58:22,155 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 15:58:22,155 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 15:58:22,155 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 15:58:22,155 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 15:58:22,155 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 15:58:22,157 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 15:58:22,157 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4426292816) setup complete. Starting run loop.
2025-05-30 15:58:22,157 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 15:58:22,157 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 15:58:22,159 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 15:58:22,160 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4437901440) setup complete. Starting run loop.
2025-05-30 15:58:22,160 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 15:58:22,160 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 15:58:22,160 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 15:58:22,186 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 15:58:22,186 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 15:58:22,188 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 15:58:22,188 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 15:58:22,188 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 15:58:22,188 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 15:58:22,189 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:58:22,189 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 15:58:22,189 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 15:58:22,189 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 15:58:32,161 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 15:58:32,165 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 15:58:32,165 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4437901488) setup complete. Starting run loop.
2025-05-30 15:58:32,165 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 15:59:38,382 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 15:59:38,382 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 15:59:38,382 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 15:59:38,382 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4426292816) was cancelled.
2025-05-30 15:59:38,382 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4426292816) stopping. Performing cleanup...
2025-05-30 15:59:38,382 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:59:38,386 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 15:59:38,387 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 15:59:38,387 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:59:38,387 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 15:59:38,387 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:59:38,387 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4426292816) cleanup complete.
2025-05-30 15:59:38,387 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 15:59:38,387 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 15:59:38,387 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4437901440) was cancelled.
2025-05-30 15:59:38,388 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4437901440) stopping. Performing cleanup...
2025-05-30 15:59:38,388 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:59:38,391 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 15:59:38,392 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 15:59:38,392 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:59:38,392 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 15:59:38,392 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:59:38,392 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4437901440) cleanup complete.
2025-05-30 15:59:38,392 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 15:59:38,392 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 15:59:38,392 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4437901488) was cancelled.
2025-05-30 15:59:38,392 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4437901488) stopping. Performing cleanup...
2025-05-30 15:59:38,392 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 15:59:38,392 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:59:38,392 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 15:59:38,393 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 15:59:38,393 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:59:38,394 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 15:59:38,395 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 15:59:38,395 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:59:38,395 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 15:59:38,395 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:59:38,395 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 15:59:38,395 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4437901488) cleanup complete.
2025-05-30 15:59:38,395 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 15:59:38,395 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 15:59:38,395 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 15:59:38,397 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 15:59:38,398 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 15:59:38,798 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 15:59:38,798 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 15:59:38,802 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 15:59:38,802 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 15:59:38,802 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 15:59:38,802 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 15:59:38,802 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 15:59:38,802 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 15:59:38,802 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 15:59:38,802 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 15:59:38,803 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 15:59:38,803 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 15:59:38,803 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 15:59:38,805 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 15:59:38,805 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 15:59:38,805 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 15:59:38,805 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 15:59:38,805 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 15:59:38,805 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 15:59:38,805 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 15:59:38,821 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 15:59:38,821 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4435562704) setup complete. Starting run loop.
2025-05-30 15:59:38,821 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 15:59:38,822 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 15:59:38,823 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 15:59:38,823 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4436409040) setup complete. Starting run loop.
2025-05-30 15:59:38,823 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 15:59:38,834 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 15:59:38,834 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 15:59:38,851 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 15:59:38,851 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 15:59:38,852 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 15:59:38,852 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 15:59:38,852 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 15:59:38,853 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 15:59:38,854 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:59:38,854 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 15:59:38,854 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 15:59:38,854 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 15:59:48,835 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 15:59:48,840 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 15:59:48,840 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4436409088) setup complete. Starting run loop.
2025-05-30 15:59:48,840 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 15:59:56,804 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 15:59:56,804 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 15:59:56,804 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4786074880) received shutdown request. Initiating graceful shutdown...
2025-05-30 15:59:56,804 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4786074880)...
2025-05-30 15:59:56,804 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 15:59:56,804 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 15:59:56,804 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4786074880) was cancelled.
2025-05-30 15:59:56,804 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 15:59:56,804 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4786074880) stopping. Performing cleanup...
2025-05-30 15:59:56,804 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 15:59:56,804 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 15:59:56,805 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-30 15:59:56,805 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 15:59:56,805 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 15:59:56,805 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 15:59:56,805 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 15:59:56,805 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 15:59:56,805 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 15:59:56,805 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 15:59:56,809 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 15:59:56,810 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 15:59:56,810 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:59:56,811 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 15:59:56,811 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 15:59:56,811 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 15:59:56,811 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4786074880) cleanup complete.
2025-05-30 15:59:56,811 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 15:59:56,811 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 15:59:56,814 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 15:59:56,814 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 15:59:56,814 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 15:59:56,814 - INFO - __main__ - Agent runner main finished.
2025-05-30 15:59:56,966 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 15:59:56,966 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 15:59:56,966 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 15:59:56,966 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4435562704) was cancelled.
2025-05-30 15:59:56,967 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4435562704) stopping. Performing cleanup...
2025-05-30 15:59:56,967 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:59:56,971 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 15:59:56,972 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 15:59:56,972 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:59:56,972 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 15:59:56,972 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:59:56,972 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4435562704) cleanup complete.
2025-05-30 15:59:56,972 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 15:59:56,972 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 15:59:56,973 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4436409040) was cancelled.
2025-05-30 15:59:56,973 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4436409040) stopping. Performing cleanup...
2025-05-30 15:59:56,973 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:59:56,976 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 15:59:56,976 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 15:59:56,976 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:59:56,977 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 15:59:56,977 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:59:56,977 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4436409040) cleanup complete.
2025-05-30 15:59:56,977 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 15:59:56,977 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 15:59:56,977 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4436409088) was cancelled.
2025-05-30 15:59:56,977 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4436409088) stopping. Performing cleanup...
2025-05-30 15:59:56,977 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 15:59:56,977 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:59:56,977 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 15:59:56,977 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 15:59:56,977 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:59:56,979 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 15:59:56,980 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 15:59:56,980 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:59:56,980 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 15:59:56,980 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:59:56,980 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 15:59:56,980 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4436409088) cleanup complete.
2025-05-30 15:59:56,980 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 15:59:56,980 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 15:59:56,980 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 15:59:56,983 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 15:59:56,983 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4392233360) received shutdown request. Initiating graceful shutdown...
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4392233360)...
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4392233360) was cancelled.
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4392233360) stopping. Performing cleanup...
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 15:59:57,058 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 15:59:57,059 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 15:59:57,059 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:59:57,060 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 15:59:57,060 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 15:59:57,060 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 15:59:57,060 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4392233360) cleanup complete.
2025-05-30 15:59:57,060 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 15:59:57,060 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 15:59:57,062 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 15:59:57,062 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 15:59:57,062 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 15:59:57,063 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 16:00:04,537 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:00:04,537 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:00:04,541 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:00:04,541 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:00:04,541 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:00:04,541 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:00:04,541 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:00:04,541 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:00:04,541 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:00:04,541 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:00:04,541 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:00:04,542 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:00:04,542 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:00:04,546 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:00:04,546 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:00:04,546 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:00:04,546 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:00:04,546 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:00:04,560 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:00:04,560 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:00:04,561 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:00:04,561 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4384850000) setup complete. Starting run loop.
2025-05-30 16:00:04,561 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:00:04,561 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:00:04,562 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:00:04,562 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4384864976) setup complete. Starting run loop.
2025-05-30 16:00:04,562 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:00:04,563 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:00:04,563 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:00:04,590 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:00:04,590 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:00:04,592 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 16:00:04,593 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 76626
2025-05-30 16:00:04,593 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 76626
2025-05-30 16:00:04,593 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 16:00:04,593 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:00:04,593 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:00:04,595 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 16:00:04,596 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 76627
2025-05-30 16:00:04,596 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 76627
2025-05-30 16:00:04,596 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 16:00:04,597 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:00:04,597 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:00:04,597 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:00:04,597 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:00:05,455 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:00:05,455 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 16:00:05,455 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 16:00:05,455 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 16:00:05,455 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 76627
2025-05-30 16:00:05,455 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 16:00:05,455 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 16:00:05,455 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 16:00:05,461 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 16:00:05,474 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 16:00:05,474 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 16:00:05,474 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 16:00:05,475 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4458834320) setup complete. Starting run loop.
2025-05-30 16:00:05,475 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 16:00:05,475 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 16:00:05,475 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 16:00:05,475 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 16:00:05,475 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:00:05,475 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 16:00:05,475 - INFO - aiogram.dispatcher - Start polling
2025-05-30 16:00:05,477 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:00:05,720 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 16:00:05,789 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:00:05,789 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 16:00:05,789 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 16:00:05,789 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 16:00:05,789 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 76626
2025-05-30 16:00:05,789 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 16:00:05,789 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 16:00:05,790 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 16:00:05,831 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 16:00:05,831 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 16:00:05,873 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 16:00:05,874 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 16:00:05,874 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 16:00:05,874 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 16:00:05,874 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 16:00:05,874 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:00:05,899 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 16:00:05,899 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 16:00:05,899 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 16:00:05,900 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 16:00:05,901 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET)
2025-05-30 16:00:05,901 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 16:00:05,901 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 16:00:05,954 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 16:00:05,957 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 16:00:06,581 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 16:00:06,584 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 16:00:06,584 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 16:00:06,584 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 16:00:06,584 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 16:00:06,584 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 16:00:06,584 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 16:00:06,584 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 16:00:06,584 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 16:00:06,585 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 16:00:06,585 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 16:00:06,585 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 16:00:06,585 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 16:00:06,585 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 16:00:06,585 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 16:00:06,585 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 16:00:06,596 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 16:00:06,596 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 16:00:06,596 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 16:00:06,596 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4646565168) setup complete. Starting run loop.
2025-05-30 16:00:06,596 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 16:00:06,596 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 16:00:06,596 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 16:00:06,596 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:00:06,599 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:00:14,563 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 16:00:14,569 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 16:00:14,569 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4384864784) setup complete. Starting run loop.
2025-05-30 16:00:14,569 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 16:00:56,681 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'ĞšĞ°ĞºĞ¾Ğ¹ Ñƒ Ğ¼ĞµĞ½Ñ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²?...'
2025-05-30 16:00:56,682 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 16:00:56,745 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 16:00:56,746 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:00:56,746 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 16:00:56,746 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 355d5be6-2a7e-41a6-ab18-f51a03313350)
2025-05-30 16:00:56,746 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 16:00:56,747 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-30 16:00:56,764 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 355d5be6-2a7e-41a6-ab18-f51a03313350, db_id: 985
2025-05-30 16:00:56,779 - INFO - AGENT:agent_airsoft_0faa9616 - Loaded 20 messages from DB for thread '144641834'.
2025-05-30 16:00:56,780 - INFO - AGENT:agent_airsoft_0faa9616 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-30 16:00:56,780 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-30 16:00:56,840 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:00:56,841 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:00:56,866 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:00:56,869 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:00:57,747 - INFO - aiogram.event - Update id=804756336 is handled. Duration 1066 ms by bot id=1750613938
2025-05-30 16:00:58,169 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:00:58,238 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 16:00:58,238 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 16:00:58,238 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1001, 'output_tokens': 16, 'total_tokens': 1017, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:00:58,238 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1001 C:16 T:1017
2025-05-30 16:00:58,238 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1017 tokens recorded.
2025-05-30 16:00:58,239 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:00:58,239 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748589354598
2025-05-30 16:00:58,239 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748589354598)---
2025-05-30 16:00:58,241 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹'
2025-05-30 16:00:58,241 - INFO - app.agent_runner.common.tools_registry - Function parameters: api_config=True, log_adapter=True, state=True
2025-05-30 16:00:58,241 - INFO - app.agent_runner.common.tools_registry - State type: <class 'dict'>
2025-05-30 16:00:58,241 - INFO - app.agent_runner.common.tools_registry - State keys: ['messages', 'documents', 'question', 'original_question', 'rewrite_count', 'channel', 'user_data', 'token_usage_events']
2025-05-30 16:00:58,241 - INFO - app.agent_runner.common.tools_registry - User data extracted: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:00:58,241 - INFO - app.agent_runner.common.tools_registry - Final user_data for API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹': {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:00:58,241 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:00:58,241 - INFO - app.agent_runner.common.tools_registry - Headers type: <class 'dict'>, value: {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36', 'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7', 'Accept-Language': 'ru-RU,ru;q=0.9,en;q=0.8', 'Accept-Encoding': 'gzip, deflate, br', 'DNT': '1', 'Connection': 'keep-alive', 'Upgrade-Insecure-Requests': '1', 'Sec-Fetch-Dest': 'document', 'Sec-Fetch-Mode': 'navigate', 'Sec-Fetch-Site': 'same-origin', 'Sec-Fetch-User': '?1', 'Cache-Control': 'max-age=0', 'Referer': 'https://airsoft-rus.ru/', 'Cookie': 'PHPSESSID=gq3cMIY4z4t5OLt12aMMcFrus6CEIhZR'}
2025-05-30 16:00:58,241 - INFO - app.agent_runner.common.tools_registry - Query Params: {'type': 'info', 'tel': '79222088435'}
2025-05-30 16:00:58,241 - INFO - app.agent_runner.common.tools_registry - Attempting Cloudflare bypass with cloudscraper for https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:00:58,851 - INFO - app.agent_runner.common.tools_registry - Cloudscraper request successful with status 200
2025-05-30 16:00:58,852 - INFO - app.agent_runner.common.tools_registry - API Response Status: 200
2025-05-30 16:00:58,852 - INFO - app.agent_runner.common.tools_registry - API Response Headers: {'Date': 'Fri, 30 May 2025 11:00:58 GMT', 'Content-Type': 'text/html; charset=UTF-8', 'Transfer-Encoding': 'chunked', 'Connection': 'keep-alive', 'Server': 'cloudflare', 'Nel': '{"success_fraction":0,"report_to":"cf-nel","max_age":604800}', 'Cf-Ray': '947dbb1a5bccf7ea-AMS', 'Vary': 'HTTPS', 'X-Powered-By': 'PHP/7.3.33', 'P3p': 'policyref="/bitrix/p3p.xml", CP="NON DSP COR CUR ADM DEV PSA PSD OUR UNR BUS UNI COM NAV INT DEM STA"', 'X-Powered-Cms': 'Bitrix Site Manager (16899fb15b29f3b6cb9157e0b568ff46)', 'Expires': 'Thu, 19 Nov 1981 08:52:00 GMT', 'Cache-Control': 'no-store, no-cache, must-revalidate', 'Pragma': 'no-cache', 'X-Frame-Options': 'SAMEORIGIN', 'Content-Encoding': 'br', 'Permissions-Policy': 'browsing-topics=()', 'Strict-Transport-Security': ': max-age=3600', 'Cf-Cache-Status': 'DYNAMIC', 'Report-To': '{"endpoints":[{"url":"https:\\/\\/a.nel.cloudflare.com\\/report\\/v4?s=kAZ0%2BLxGP0wvqXkaAzipYa0X9OwxXYaDAdb4ZeUhqUH7wH4Nd2xftLn7Dy7NNRhXPexLAK4SIsjJx1kaofkCrsnqZ5dzzfb18stdzwWoUujpht7OV0BkxaQttIE7pr2j"}],"group":"cf-nel","max_age":604800}', 'Set-Cookie': 'PHPSESSID=RRn5eRe97FKHJqrTaAfV42nTWKqQCmAz; HttpOnly; Secure; Path=/', 'server-timing': 'cfL4;desc="?proto=TCP&rtt=110901&min_rtt=110437&rtt_var=41745&sent=5&recv=6&lost=0&retrans=0&sent_bytes=2880&recv_bytes=1326&delivery_rate=36618&cwnd=233&unsent_bytes=0&cid=4d16b9941ea3335a&ts=373&x=0"'}
2025-05-30 16:00:58,852 - INFO - app.agent_runner.common.tools_registry - API Response Content-Type: text/html; charset=UTF-8
2025-05-30 16:00:58,852 - INFO - app.agent_runner.common.tools_registry - API Response Content Length: 7 bytes
2025-05-30 16:00:58,852 - INFO - app.agent_runner.common.tools_registry - API Response Encoding: utf-8
2025-05-30 16:00:58,852 - INFO - app.agent_runner.common.tools_registry - API Response Content Preview (first 1000 chars): ï¿½574
2025-05-30 16:00:58,852 - WARNING - app.agent_runner.common.tools_registry - Failed to parse JSON response: Expecting value: line 1 column 1 (char 0)
2025-05-30 16:00:58,852 - INFO - app.agent_runner.common.tools_registry - Returning raw text response
2025-05-30 16:00:58,853 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:00:58,853 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:00:58,877 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:00:58,880 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:00:59,981 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:01:00,690 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğµ, Ñ‡Ñ‚Ğ¾ ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ²Ğ¾Ğ·Ğ½Ğ¸ĞºĞ»Ğ° Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾ Ñ‚Ğ²Ğ¾Ğ¸Ñ… Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°Ñ…. ĞÑ‡
2025-05-30 16:01:00,690 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 16:01:00,690 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1036, 'output_tokens': 54, 'total_tokens': 1090, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:01:00,690 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1036 C:54 T:1090
2025-05-30 16:01:00,690 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1090 tokens recorded.
2025-05-30 16:01:00,691 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:01:00,691 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 16:01:00,692 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğµ, Ñ‡Ñ‚Ğ¾ ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ²Ğ¾Ğ·Ğ½Ğ¸ĞºĞ»Ğ° Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾ Ñ‚Ğ²Ğ¾Ğ¸Ñ… Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°Ñ…. ĞÑ‡...
2025-05-30 16:01:00,693 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 355d5be6-2a7e-41a6-ab18-f51a03313350)
2025-05-30 16:01:00,694 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: 355d5be6-2a7e-41a6-ab18-f51a03313350.
2025-05-30 16:01:00,696 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğµ, Ñ‡Ñ‚Ğ¾ ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ²Ğ¾Ğ·Ğ½Ğ¸ĞºĞ»Ğ° Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾ Ñ‚Ğ²Ğ¾Ğ¸Ñ… Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°Ñ…. ĞÑ‡...
2025-05-30 16:01:00,696 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğµ, Ñ‡Ñ‚Ğ¾ ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ²Ğ¾Ğ·Ğ½Ğ¸ĞºĞ»Ğ° Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ñ...'
2025-05-30 16:01:00,698 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '355d5be6-2a7e-41a6-ab18-f51a03313350', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1001, 'completion_tokens': 16, 'total_tokens': 1017, 'timestamp': '2025-05-30T11:00:58.238895+00:00'}
2025-05-30 16:01:00,698 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 355d5be6-2a7e-41a6-ab18-f51a03313350
2025-05-30 16:01:00,702 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 355d5be6-2a7e-41a6-ab18-f51a03313350, db_id: 986
2025-05-30 16:01:00,727 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 986 for interaction_id: 355d5be6-2a7e-41a6-ab18-f51a03313350 on attempt 1
2025-05-30 16:01:00,733 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 355d5be6-2a7e-41a6-ab18-f51a03313350, db_id: 454
2025-05-30 16:01:00,737 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '355d5be6-2a7e-41a6-ab18-f51a03313350', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1036, 'completion_tokens': 54, 'total_tokens': 1090, 'timestamp': '2025-05-30T11:01:00.690221+00:00'}
2025-05-30 16:01:00,737 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 355d5be6-2a7e-41a6-ab18-f51a03313350
2025-05-30 16:01:00,738 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 986 for interaction_id: 355d5be6-2a7e-41a6-ab18-f51a03313350 on attempt 1
2025-05-30 16:01:00,741 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 355d5be6-2a7e-41a6-ab18-f51a03313350, db_id: 455
2025-05-30 16:01:35,252 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 16:01:35,252 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 16:01:35,252 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 16:01:35,252 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4384850000) was cancelled.
2025-05-30 16:01:35,252 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4384850000) stopping. Performing cleanup...
2025-05-30 16:01:35,252 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:01:35,257 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 16:01:35,258 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 16:01:35,258 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:01:35,258 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 16:01:35,258 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:01:35,258 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4384850000) cleanup complete.
2025-05-30 16:01:35,258 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 16:01:35,258 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 16:01:35,258 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4384864976) was cancelled.
2025-05-30 16:01:35,258 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4384864976) stopping. Performing cleanup...
2025-05-30 16:01:35,258 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:01:35,262 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 16:01:35,262 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 16:01:35,262 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:01:35,263 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 16:01:35,263 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:01:35,263 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4384864976) cleanup complete.
2025-05-30 16:01:35,263 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 16:01:35,263 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 16:01:35,263 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4384864784) was cancelled.
2025-05-30 16:01:35,263 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4384864784) stopping. Performing cleanup...
2025-05-30 16:01:35,263 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 16:01:35,263 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:01:35,263 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:01:35,263 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 16:01:35,263 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:01:35,266 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 16:01:35,267 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 16:01:35,267 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:01:35,267 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 16:01:35,267 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:01:35,267 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 16:01:35,267 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4384864784) cleanup complete.
2025-05-30 16:01:35,267 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 16:01:35,267 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 16:01:35,267 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 16:01:35,272 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:01:35,272 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 16:01:35,776 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:01:35,776 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:01:35,781 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:01:35,781 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:01:35,781 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:01:35,781 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:01:35,781 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:01:35,781 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:01:35,781 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:01:35,781 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:01:35,781 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:01:35,782 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:01:35,782 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:01:35,785 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:01:35,785 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:01:35,785 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:01:35,799 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:01:35,799 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:01:35,799 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:01:35,799 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:01:35,800 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:01:35,800 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4436050864) setup complete. Starting run loop.
2025-05-30 16:01:35,800 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:01:35,801 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:01:35,802 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:01:35,802 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4436064784) setup complete. Starting run loop.
2025-05-30 16:01:35,802 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:01:35,804 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:01:35,804 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:01:35,832 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:01:35,832 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:01:35,833 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:01:35,833 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:01:35,833 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:01:35,834 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:01:35,834 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:01:35,835 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:01:35,835 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:01:35,835 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:01:45,804 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 16:01:45,808 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 16:01:45,808 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4436064592) setup complete. Starting run loop.
2025-05-30 16:01:45,808 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 16:01:53,242 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 16:01:53,242 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 16:01:53,242 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 16:01:53,242 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4436050864) was cancelled.
2025-05-30 16:01:53,242 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4436050864) stopping. Performing cleanup...
2025-05-30 16:01:53,242 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:01:53,246 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 16:01:53,247 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 16:01:53,247 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:01:53,247 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 16:01:53,247 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:01:53,247 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4436050864) cleanup complete.
2025-05-30 16:01:53,247 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 16:01:53,247 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 16:01:53,247 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4436064784) was cancelled.
2025-05-30 16:01:53,247 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4436064784) stopping. Performing cleanup...
2025-05-30 16:01:53,247 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:01:53,252 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 16:01:53,253 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 16:01:53,253 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:01:53,253 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 16:01:53,253 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:01:53,253 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4436064784) cleanup complete.
2025-05-30 16:01:53,253 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 16:01:53,253 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 16:01:53,253 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4436064592) was cancelled.
2025-05-30 16:01:53,253 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4436064592) stopping. Performing cleanup...
2025-05-30 16:01:53,253 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 16:01:53,253 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:01:53,253 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:01:53,253 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 16:01:53,253 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:01:53,256 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 16:01:53,257 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 16:01:53,257 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:01:53,258 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 16:01:53,258 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:01:53,258 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 16:01:53,258 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4436064592) cleanup complete.
2025-05-30 16:01:53,258 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 16:01:53,258 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 16:01:53,258 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 16:01:53,263 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:01:53,263 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 16:01:53,662 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:01:53,662 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:01:53,666 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:01:53,667 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:01:53,667 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:01:53,667 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:01:53,667 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:01:53,667 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:01:53,667 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:01:53,667 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:01:53,667 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:01:53,667 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:01:53,667 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:01:53,669 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:01:53,669 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:01:53,669 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:01:53,669 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:01:53,669 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:01:53,669 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:01:53,669 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:01:53,685 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:01:53,685 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4453018000) setup complete. Starting run loop.
2025-05-30 16:01:53,685 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:01:53,685 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:01:53,686 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:01:53,686 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4453022224) setup complete. Starting run loop.
2025-05-30 16:01:53,686 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:01:53,687 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:01:53,687 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:01:53,716 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:01:53,716 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:01:53,717 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:01:53,717 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:01:53,717 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:01:53,718 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:01:53,719 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:01:53,719 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:01:53,719 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:01:53,719 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:01:57,487 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 16:01:57,487 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 16:01:57,487 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4646565168) received shutdown request. Initiating graceful shutdown...
2025-05-30 16:01:57,487 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4646565168)...
2025-05-30 16:01:57,487 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 16:01:57,487 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 16:01:57,487 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4646565168) was cancelled.
2025-05-30 16:01:57,487 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 16:01:57,487 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4646565168) stopping. Performing cleanup...
2025-05-30 16:01:57,487 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 16:01:57,487 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 16:01:57,488 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-30 16:01:57,488 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 16:01:57,488 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 16:01:57,488 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 16:01:57,488 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:01:57,488 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 16:01:57,488 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 16:01:57,488 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 16:01:57,492 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 16:01:57,493 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 16:01:57,493 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:01:57,493 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 16:01:57,493 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 16:01:57,493 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 16:01:57,493 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4646565168) cleanup complete.
2025-05-30 16:01:57,493 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 16:01:57,493 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 16:01:57,496 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:01:57,496 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 16:01:57,496 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 16:01:57,496 - INFO - __main__ - Agent runner main finished.
2025-05-30 16:01:57,641 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 16:01:57,641 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 16:01:57,641 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 16:01:57,641 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4453018000) was cancelled.
2025-05-30 16:01:57,641 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4453018000) stopping. Performing cleanup...
2025-05-30 16:01:57,641 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:01:57,644 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 16:01:57,645 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 16:01:57,645 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:01:57,645 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 16:01:57,645 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:01:57,645 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4453018000) cleanup complete.
2025-05-30 16:01:57,645 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 16:01:57,645 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 16:01:57,645 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4453022224) was cancelled.
2025-05-30 16:01:57,645 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4453022224) stopping. Performing cleanup...
2025-05-30 16:01:57,645 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:01:57,648 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 16:01:57,649 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 16:01:57,649 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:01:57,649 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 16:01:57,649 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:01:57,649 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4453022224) cleanup complete.
2025-05-30 16:01:57,649 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 16:01:57,649 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 16:01:57,649 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4453022608) was cancelled.
2025-05-30 16:01:57,649 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4453022608) stopping. Performing cleanup...
2025-05-30 16:01:57,649 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 16:01:57,649 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:01:57,649 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:01:57,649 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 16:01:57,649 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:01:57,651 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 16:01:57,652 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 16:01:57,652 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:01:57,652 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 16:01:57,652 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:01:57,652 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 16:01:57,652 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4453022608) cleanup complete.
2025-05-30 16:01:57,652 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 16:01:57,652 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 16:01:57,652 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 16:01:57,654 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:01:57,654 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 16:01:57,739 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 16:01:57,739 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 16:01:57,739 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 16:01:57,739 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4458834320) received shutdown request. Initiating graceful shutdown...
2025-05-30 16:01:57,739 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4458834320)...
2025-05-30 16:01:57,739 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 16:01:57,739 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 16:01:57,739 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4458834320) was cancelled.
2025-05-30 16:01:57,739 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4458834320) stopping. Performing cleanup...
2025-05-30 16:01:57,739 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 16:01:57,739 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 16:01:57,739 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 16:01:57,739 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 16:01:57,739 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 16:01:57,739 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 16:01:57,739 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:01:57,740 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 16:01:57,740 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 16:01:57,740 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 16:01:57,744 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 16:01:57,745 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 16:01:57,745 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:01:57,745 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 16:01:57,745 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 16:01:57,745 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 16:01:57,745 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4458834320) cleanup complete.
2025-05-30 16:01:57,745 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 16:01:57,745 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 16:01:57,748 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:01:57,748 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 16:01:57,748 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 16:01:57,749 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 16:02:02,611 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:02:02,611 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:02:02,616 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:02:02,616 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:02:02,616 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:02:02,616 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:02:02,616 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:02:02,616 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:02:02,616 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:02:02,616 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:02:02,617 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:02:02,617 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:02:02,617 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:02:02,619 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:02:02,619 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:02:02,619 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:02:02,619 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:02:02,619 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:02:02,620 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:02:02,620 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:02:02,634 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:02:02,635 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:02:02,635 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4412097168) setup complete. Starting run loop.
2025-05-30 16:02:02,635 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:02:02,635 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:02:02,635 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4412097360) setup complete. Starting run loop.
2025-05-30 16:02:02,635 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:02:02,638 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:02:02,638 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:02:02,664 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:02:02,664 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:02:02,665 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 16:02:02,666 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 76892
2025-05-30 16:02:02,666 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 76892
2025-05-30 16:02:02,667 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 16:02:02,667 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:02:02,667 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:02:02,669 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 16:02:02,669 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 76893
2025-05-30 16:02:02,669 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 76893
2025-05-30 16:02:02,670 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 16:02:02,670 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:02:02,670 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:02:02,670 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:02:02,670 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:02:03,533 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:02:03,533 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 16:02:03,533 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 16:02:03,533 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 16:02:03,533 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 76893
2025-05-30 16:02:03,533 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 16:02:03,533 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 16:02:03,533 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 16:02:03,537 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 16:02:03,550 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 16:02:03,550 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 16:02:03,550 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 16:02:03,550 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4433176448) setup complete. Starting run loop.
2025-05-30 16:02:03,550 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 16:02:03,550 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 16:02:03,550 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 16:02:03,550 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 16:02:03,551 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:02:03,551 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 16:02:03,551 - INFO - aiogram.dispatcher - Start polling
2025-05-30 16:02:03,553 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:02:03,787 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 16:02:03,879 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:02:03,879 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 16:02:03,879 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 16:02:03,879 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 16:02:03,879 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 76892
2025-05-30 16:02:03,879 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 16:02:03,879 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 16:02:03,879 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 16:02:03,920 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 16:02:03,920 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 16:02:03,965 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 16:02:03,966 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 16:02:03,966 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 16:02:03,966 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 16:02:03,966 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 16:02:03,966 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:02:03,991 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 16:02:03,991 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 16:02:03,991 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 16:02:03,992 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 16:02:03,993 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET)
2025-05-30 16:02:03,993 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 16:02:03,993 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 16:02:04,048 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 16:02:04,050 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 16:02:04,655 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 16:02:04,658 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 16:02:04,658 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 16:02:04,658 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 16:02:04,658 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 16:02:04,658 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 16:02:04,658 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 16:02:04,658 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 16:02:04,658 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 16:02:04,659 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 16:02:04,659 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 16:02:04,659 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 16:02:04,659 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 16:02:04,659 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 16:02:04,659 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 16:02:04,660 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 16:02:04,670 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 16:02:04,670 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 16:02:04,670 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 16:02:04,670 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4490523520) setup complete. Starting run loop.
2025-05-30 16:02:04,670 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 16:02:04,670 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 16:02:04,670 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 16:02:04,670 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:02:04,674 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:02:12,638 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 16:02:12,643 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 16:02:12,643 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4412097312) setup complete. Starting run loop.
2025-05-30 16:02:12,643 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 16:02:20,808 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'ĞšĞ°ĞºĞ¾Ğ¹ Ñƒ Ğ¼ĞµĞ½Ñ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ±?...'
2025-05-30 16:02:20,810 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 16:02:20,877 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 16:02:20,877 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:02:20,877 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 16:02:20,878 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: b7d043a6-bd7c-4e1a-b5b7-6a3aaa61307d)
2025-05-30 16:02:20,878 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 16:02:20,878 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-30 16:02:20,898 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: b7d043a6-bd7c-4e1a-b5b7-6a3aaa61307d, db_id: 987
2025-05-30 16:02:20,913 - INFO - AGENT:agent_airsoft_0faa9616 - Loaded 20 messages from DB for thread '144641834'.
2025-05-30 16:02:20,913 - INFO - AGENT:agent_airsoft_0faa9616 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-30 16:02:20,913 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-30 16:02:20,960 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:02:20,960 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:02:20,985 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:02:20,988 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:02:21,878 - INFO - aiogram.event - Update id=804756337 is handled. Duration 1070 ms by bot id=1750613938
2025-05-30 16:02:22,349 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:02:22,354 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 16:02:22,354 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 16:02:22,354 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1034, 'output_tokens': 16, 'total_tokens': 1050, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:02:22,354 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1034 C:16 T:1050
2025-05-30 16:02:22,354 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1050 tokens recorded.
2025-05-30 16:02:22,355 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:02:22,355 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748589354598
2025-05-30 16:02:22,355 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748589354598)---
2025-05-30 16:02:22,357 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹'
2025-05-30 16:02:22,357 - INFO - app.agent_runner.common.tools_registry - Function parameters: api_config=True, log_adapter=True, state=True
2025-05-30 16:02:22,357 - INFO - app.agent_runner.common.tools_registry - State type: <class 'dict'>
2025-05-30 16:02:22,357 - INFO - app.agent_runner.common.tools_registry - State keys: ['messages', 'documents', 'question', 'original_question', 'rewrite_count', 'channel', 'user_data', 'token_usage_events']
2025-05-30 16:02:22,357 - INFO - app.agent_runner.common.tools_registry - User data extracted: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:02:22,358 - INFO - app.agent_runner.common.tools_registry - Final user_data for API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹': {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:02:22,358 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:02:22,358 - INFO - app.agent_runner.common.tools_registry - Headers type: <class 'dict'>, value: {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36', 'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7', 'Accept-Language': 'ru-RU,ru;q=0.9,en;q=0.8', 'Accept-Encoding': 'gzip, deflate, br', 'DNT': '1', 'Connection': 'keep-alive', 'Upgrade-Insecure-Requests': '1', 'Sec-Fetch-Dest': 'document', 'Sec-Fetch-Mode': 'navigate', 'Sec-Fetch-Site': 'same-origin', 'Sec-Fetch-User': '?1', 'Cache-Control': 'max-age=0', 'Referer': 'https://airsoft-rus.ru/', 'Cookie': 'PHPSESSID=gq3cMIY4z4t5OLt12aMMcFrus6CEIhZR'}
2025-05-30 16:02:22,358 - INFO - app.agent_runner.common.tools_registry - Query Params: {'type': 'info', 'tel': '79222088435'}
2025-05-30 16:02:22,358 - INFO - app.agent_runner.common.tools_registry - Attempting Cloudflare bypass with cloudscraper for https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:02:22,850 - INFO - app.agent_runner.common.tools_registry - Cloudscraper request successful with status 200
2025-05-30 16:02:22,850 - INFO - app.agent_runner.common.tools_registry - API Response Status: 200
2025-05-30 16:02:22,851 - INFO - app.agent_runner.common.tools_registry - API Response Headers: {'Date': 'Fri, 30 May 2025 11:02:22 GMT', 'Content-Type': 'text/html; charset=UTF-8', 'Transfer-Encoding': 'chunked', 'Connection': 'keep-alive', 'Server': 'cloudflare', 'Nel': '{"success_fraction":0,"report_to":"cf-nel","max_age":604800}', 'Cf-Ray': '947dbd28195b97fc-AMS', 'Vary': 'HTTPS', 'X-Powered-By': 'PHP/7.3.33', 'P3p': 'policyref="/bitrix/p3p.xml", CP="NON DSP COR CUR ADM DEV PSA PSD OUR UNR BUS UNI COM NAV INT DEM STA"', 'X-Powered-Cms': 'Bitrix Site Manager (16899fb15b29f3b6cb9157e0b568ff46)', 'Expires': 'Thu, 19 Nov 1981 08:52:00 GMT', 'Cache-Control': 'no-store, no-cache, must-revalidate', 'Pragma': 'no-cache', 'X-Frame-Options': 'SAMEORIGIN', 'Content-Encoding': 'br', 'Permissions-Policy': 'browsing-topics=()', 'Strict-Transport-Security': ': max-age=3600', 'Cf-Cache-Status': 'DYNAMIC', 'Report-To': '{"endpoints":[{"url":"https:\\/\\/a.nel.cloudflare.com\\/report\\/v4?s=%2FMXqJR6tOug5Vgr8yhYjjuPCo95tLnpulBRWy8NV3NETBTdPh5Av9NIb%2BP1eB1wpQGaYV0gHt5BJvSNdi6zsyQ%2BEHgpDwO%2BQeMgEo0CEff96BhiLN6iMMplusSlZxodI"}],"group":"cf-nel","max_age":604800}', 'Set-Cookie': 'PHPSESSID=jshYsbTHcQqTyyf7kK7abV3YANdraKkX; HttpOnly; Secure; Path=/', 'server-timing': 'cfL4;desc="?proto=TCP&rtt=113118&min_rtt=112148&rtt_var=42748&sent=5&recv=6&lost=0&retrans=0&sent_bytes=2881&recv_bytes=1326&delivery_rate=36059&cwnd=246&unsent_bytes=0&cid=e4f0566ea6f7e5fd&ts=249&x=0"'}
2025-05-30 16:02:22,851 - INFO - app.agent_runner.common.tools_registry - API Response Content-Type: text/html; charset=UTF-8
2025-05-30 16:02:22,851 - INFO - app.agent_runner.common.tools_registry - API Response Content Length: 7 bytes
2025-05-30 16:02:22,851 - INFO - app.agent_runner.common.tools_registry - API Response Encoding: UTF-8
2025-05-30 16:02:22,851 - WARNING - app.agent_runner.common.tools_registry - Failed to decode as UTF-8, falling back to response.text
2025-05-30 16:02:22,851 - INFO - app.agent_runner.common.tools_registry - API Response Content Preview (first 1000 chars): ï¿½574
2025-05-30 16:02:22,851 - WARNING - app.agent_runner.common.tools_registry - Failed to parse JSON response: Expecting value: line 1 column 1 (char 0)
2025-05-30 16:02:22,851 - INFO - app.agent_runner.common.tools_registry - Returning raw text response
2025-05-30 16:02:22,852 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:02:22,853 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:02:22,876 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:02:22,879 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:02:24,286 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:02:24,897 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ•Ğ²Ğ³ĞµĞ½Ğ¸Ğ¹, Ğº ÑĞ¾Ğ¶Ğ°Ğ»ĞµĞ½Ğ¸Ñ, ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ½Ğµ ÑĞ¼Ğ¾Ğ³Ğ»Ğ° Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾ Ñ‚Ğ²Ğ¾Ğ¸Ñ… Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°Ñ…. Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾, ÑÑ‚
2025-05-30 16:02:24,898 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 16:02:24,898 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1069, 'output_tokens': 51, 'total_tokens': 1120, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:02:24,898 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1069 C:51 T:1120
2025-05-30 16:02:24,898 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1120 tokens recorded.
2025-05-30 16:02:24,898 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:02:24,899 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 16:02:24,900 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ•Ğ²Ğ³ĞµĞ½Ğ¸Ğ¹, Ğº ÑĞ¾Ğ¶Ğ°Ğ»ĞµĞ½Ğ¸Ñ, ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ½Ğµ ÑĞ¼Ğ¾Ğ³Ğ»Ğ° Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾ Ñ‚Ğ²Ğ¾Ğ¸Ñ… Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°Ñ…. Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾, ÑÑ‚...
2025-05-30 16:02:24,901 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: b7d043a6-bd7c-4e1a-b5b7-6a3aaa61307d)
2025-05-30 16:02:24,902 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: b7d043a6-bd7c-4e1a-b5b7-6a3aaa61307d.
2025-05-30 16:02:24,904 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Ğ•Ğ²Ğ³ĞµĞ½Ğ¸Ğ¹, Ğº ÑĞ¾Ğ¶Ğ°Ğ»ĞµĞ½Ğ¸Ñ, ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ½Ğµ ÑĞ¼Ğ¾Ğ³Ğ»Ğ° Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾ Ñ‚Ğ²Ğ¾Ğ¸Ñ… Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°Ñ…. Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾, ÑÑ‚...
2025-05-30 16:02:24,904 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Ğ•Ğ²Ğ³ĞµĞ½Ğ¸Ğ¹, Ğº ÑĞ¾Ğ¶Ğ°Ğ»ĞµĞ½Ğ¸Ñ, ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ½Ğµ ÑĞ¼Ğ¾Ğ³Ğ»Ğ° Ğ¿Ğ¾Ğ»...'
2025-05-30 16:02:24,904 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'b7d043a6-bd7c-4e1a-b5b7-6a3aaa61307d', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1034, 'completion_tokens': 16, 'total_tokens': 1050, 'timestamp': '2025-05-30T11:02:22.354703+00:00'}
2025-05-30 16:02:24,904 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: b7d043a6-bd7c-4e1a-b5b7-6a3aaa61307d
2025-05-30 16:02:24,918 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: b7d043a6-bd7c-4e1a-b5b7-6a3aaa61307d, db_id: 988
2025-05-30 16:02:24,934 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 988 for interaction_id: b7d043a6-bd7c-4e1a-b5b7-6a3aaa61307d on attempt 1
2025-05-30 16:02:24,940 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: b7d043a6-bd7c-4e1a-b5b7-6a3aaa61307d, db_id: 456
2025-05-30 16:02:24,943 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'b7d043a6-bd7c-4e1a-b5b7-6a3aaa61307d', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1069, 'completion_tokens': 51, 'total_tokens': 1120, 'timestamp': '2025-05-30T11:02:24.898088+00:00'}
2025-05-30 16:02:24,943 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: b7d043a6-bd7c-4e1a-b5b7-6a3aaa61307d
2025-05-30 16:02:24,944 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 988 for interaction_id: b7d043a6-bd7c-4e1a-b5b7-6a3aaa61307d on attempt 1
2025-05-30 16:02:24,947 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: b7d043a6-bd7c-4e1a-b5b7-6a3aaa61307d, db_id: 457
2025-05-30 16:03:41,809 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 16:03:41,809 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 16:03:41,809 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 16:03:41,809 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4412097360) was cancelled.
2025-05-30 16:03:41,809 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4412097360) stopping. Performing cleanup...
2025-05-30 16:03:41,809 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:03:41,814 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 16:03:41,815 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 16:03:41,815 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:03:41,815 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 16:03:41,815 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:03:41,815 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4412097360) cleanup complete.
2025-05-30 16:03:41,815 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 16:03:41,815 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 16:03:41,815 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4412097168) was cancelled.
2025-05-30 16:03:41,815 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4412097168) stopping. Performing cleanup...
2025-05-30 16:03:41,815 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:03:41,818 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 16:03:41,819 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 16:03:41,819 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:03:41,819 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 16:03:41,819 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:03:41,819 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4412097168) cleanup complete.
2025-05-30 16:03:41,819 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 16:03:41,819 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 16:03:41,819 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4412097312) was cancelled.
2025-05-30 16:03:41,819 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4412097312) stopping. Performing cleanup...
2025-05-30 16:03:41,819 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 16:03:41,819 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:03:41,820 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:03:41,820 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 16:03:41,820 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:03:41,822 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 16:03:41,823 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 16:03:41,823 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:03:41,823 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 16:03:41,823 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:03:41,823 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 16:03:41,823 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4412097312) cleanup complete.
2025-05-30 16:03:41,823 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 16:03:41,823 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 16:03:41,823 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 16:03:41,829 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:03:41,829 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 16:03:42,347 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:03:42,347 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:03:42,352 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:03:42,352 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:03:42,352 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:03:42,352 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:03:42,352 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:03:42,353 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:03:42,353 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:03:42,353 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:03:42,353 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:03:42,353 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:03:42,353 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:03:42,356 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:03:42,356 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:03:42,356 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:03:42,356 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:03:42,356 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:03:42,370 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:03:42,370 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:03:42,372 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:03:42,373 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:03:42,373 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4482382736) setup complete. Starting run loop.
2025-05-30 16:03:42,373 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:03:42,373 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:03:42,373 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4479880464) setup complete. Starting run loop.
2025-05-30 16:03:42,373 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:03:42,374 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:03:42,374 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:03:42,402 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:03:42,402 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:03:42,403 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:03:42,403 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:03:42,403 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:03:42,404 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:03:42,404 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:03:42,404 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:03:42,404 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:03:42,404 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:03:49,447 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 16:03:49,447 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 16:03:49,447 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 16:03:49,447 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4479880464) was cancelled.
2025-05-30 16:03:49,447 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4479880464) stopping. Performing cleanup...
2025-05-30 16:03:49,447 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:03:49,452 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 16:03:49,453 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 16:03:49,453 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:03:49,453 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 16:03:49,453 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:03:49,453 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4479880464) cleanup complete.
2025-05-30 16:03:49,453 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 16:03:49,453 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 16:03:49,453 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4482382736) was cancelled.
2025-05-30 16:03:49,453 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4482382736) stopping. Performing cleanup...
2025-05-30 16:03:49,453 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:03:49,456 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 16:03:49,457 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 16:03:49,457 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:03:49,457 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 16:03:49,457 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:03:49,457 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4482382736) cleanup complete.
2025-05-30 16:03:49,457 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 16:03:49,457 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 16:03:49,457 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4482382544) was cancelled.
2025-05-30 16:03:49,457 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4482382544) stopping. Performing cleanup...
2025-05-30 16:03:49,457 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 16:03:49,457 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:03:49,457 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:03:49,457 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 16:03:49,458 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:03:49,460 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 16:03:49,461 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 16:03:49,461 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:03:49,461 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 16:03:49,461 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:03:49,461 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 16:03:49,461 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4482382544) cleanup complete.
2025-05-30 16:03:49,461 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 16:03:49,461 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 16:03:49,461 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 16:03:49,464 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:03:49,464 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 16:03:49,774 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:03:49,774 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:03:49,778 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:03:49,778 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:03:49,778 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:03:49,778 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:03:49,778 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:03:49,778 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:03:49,778 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:03:49,778 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:03:49,779 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:03:49,779 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:03:49,779 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:03:49,781 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:03:49,781 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:03:49,781 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:03:49,781 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:03:49,781 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:03:49,794 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:03:49,794 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:03:49,797 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:03:49,797 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4384885984) setup complete. Starting run loop.
2025-05-30 16:03:49,797 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:03:49,798 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:03:49,799 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:03:49,799 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4384897264) setup complete. Starting run loop.
2025-05-30 16:03:49,799 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:03:49,800 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:03:49,800 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:03:49,828 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:03:49,828 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:03:49,829 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:03:49,829 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:03:49,829 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:03:49,829 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:03:49,830 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:03:49,830 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:03:49,830 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:03:49,830 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:03:59,114 - INFO - app.services.process_manager - Restarting agent process for agent_airsoft_0faa9616...
2025-05-30 16:03:59,116 - INFO - app.services.process_manager - Stopping agent process agent_airsoft_0faa9616 (PID: 76892). Force: True
2025-05-30 16:03:59,116 - INFO - app.services.process_manager - SIGTERM sent to agent agent_airsoft_0faa9616 (PID: 76892)
2025-05-30 16:03:59,217 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 (PID: 76892) terminated gracefully after SIGTERM.
2025-05-30 16:03:59,220 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 marked as stopped in Redis.
2025-05-30 16:03:59,220 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 stopped (or stop attempted and assumed successful for restart). Pausing briefly...
2025-05-30 16:03:59,800 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 16:03:59,804 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 16:03:59,804 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4384897312) setup complete. Starting run loop.
2025-05-30 16:03:59,804 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 16:04:04,220 - INFO - app.services.process_manager - Proceeding to start agent agent_airsoft_0faa9616 after delay...
2025-05-30 16:04:04,223 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 16:04:04,224 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 77299
2025-05-30 16:04:04,224 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 77299
2025-05-30 16:04:04,225 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 successfully started as part of restart sequence.
2025-05-30 16:04:04,225 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:04:04,225 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:04:05,441 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:04:05,442 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 16:04:05,442 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 16:04:05,442 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 16:04:05,442 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 77299
2025-05-30 16:04:05,442 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 16:04:05,442 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 16:04:05,442 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 16:04:05,484 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 16:04:05,485 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 16:04:05,525 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 16:04:05,525 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 16:04:05,525 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 16:04:05,526 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 16:04:05,526 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 16:04:05,526 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:04:05,551 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 16:04:05,551 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 16:04:05,551 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 16:04:05,552 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 16:04:05,553 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET)
2025-05-30 16:04:05,553 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 16:04:05,553 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 16:04:05,607 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 16:04:05,611 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 16:04:06,223 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 16:04:06,227 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 16:04:06,227 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 16:04:06,228 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 16:04:06,228 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 16:04:06,228 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 16:04:06,228 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 16:04:06,228 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 16:04:06,228 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 16:04:06,228 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 16:04:06,229 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 16:04:06,229 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 16:04:06,229 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 16:04:06,229 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 16:04:06,229 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 16:04:06,229 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 16:04:06,240 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 16:04:06,240 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 16:04:06,240 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 16:04:06,240 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4530730048) setup complete. Starting run loop.
2025-05-30 16:04:06,240 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 16:04:06,240 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 16:04:06,240 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 16:04:06,240 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:04:06,243 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:04:13,729 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:04:13,729 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:04:40,451 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒ Ğ¼Ğ¾Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²...'
2025-05-30 16:04:40,452 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 16:04:40,456 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 16:04:40,456 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:04:40,456 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 16:04:40,457 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 59cff0eb-6ee7-47d1-a747-3077cb893c09)
2025-05-30 16:04:40,457 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 16:04:40,457 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 16:04:40,457 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 16:04:40,478 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 59cff0eb-6ee7-47d1-a747-3077cb893c09, db_id: 989
2025-05-30 16:04:40,503 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:04:40,503 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:04:40,528 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:04:40,531 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:04:41,457 - INFO - aiogram.event - Update id=804756338 is handled. Duration 1005 ms by bot id=1750613938
2025-05-30 16:04:41,915 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:04:41,921 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 16:04:41,921 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_38647f5e19'}
2025-05-30 16:04:41,921 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 364, 'output_tokens': 12, 'total_tokens': 376, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:04:41,921 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:364 C:12 T:376
2025-05-30 16:04:41,921 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 376 tokens recorded.
2025-05-30 16:04:41,922 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:04:41,922 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: get_user_info_tool
2025-05-30 16:04:41,922 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (get_user_info_tool)---
2025-05-30 16:04:41,924 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:04:41,924 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:04:41,948 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:04:41,951 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:04:42,905 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:04:42,930 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 16:04:42,930 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_38647f5e19'}
2025-05-30 16:04:42,930 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 435, 'output_tokens': 16, 'total_tokens': 451, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:04:42,930 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:435 C:16 T:451
2025-05-30 16:04:42,930 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 451 tokens recorded.
2025-05-30 16:04:42,931 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:04:42,931 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748589354598
2025-05-30 16:04:42,931 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748589354598)---
2025-05-30 16:04:42,933 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹'
2025-05-30 16:04:42,933 - INFO - app.agent_runner.common.tools_registry - Function parameters: api_config=True, log_adapter=True, state=True
2025-05-30 16:04:42,933 - INFO - app.agent_runner.common.tools_registry - State type: <class 'dict'>
2025-05-30 16:04:42,933 - INFO - app.agent_runner.common.tools_registry - State keys: ['messages', 'documents', 'question', 'original_question', 'rewrite_count', 'channel', 'user_data', 'token_usage_events']
2025-05-30 16:04:42,933 - INFO - app.agent_runner.common.tools_registry - User data extracted: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:04:42,933 - INFO - app.agent_runner.common.tools_registry - Final user_data for API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹': {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:04:42,933 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:04:42,933 - INFO - app.agent_runner.common.tools_registry - Headers type: <class 'dict'>, value: {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36', 'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7', 'Accept-Language': 'ru-RU,ru;q=0.9,en;q=0.8', 'Accept-Encoding': 'gzip, deflate, br', 'DNT': '1', 'Connection': 'keep-alive', 'Upgrade-Insecure-Requests': '1', 'Sec-Fetch-Dest': 'document', 'Sec-Fetch-Mode': 'navigate', 'Sec-Fetch-Site': 'same-origin', 'Sec-Fetch-User': '?1', 'Cache-Control': 'max-age=0', 'Referer': 'https://airsoft-rus.ru/', 'Cookie': 'PHPSESSID=gq3cMIY4z4t5OLt12aMMcFrus6CEIhZR'}
2025-05-30 16:04:42,933 - INFO - app.agent_runner.common.tools_registry - Query Params: {'type': 'info', 'tel': '79222088435'}
2025-05-30 16:04:42,933 - INFO - app.agent_runner.common.tools_registry - Attempting Cloudflare bypass with cloudscraper for https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:04:43,409 - INFO - app.agent_runner.common.tools_registry - Cloudscraper request successful with status 200
2025-05-30 16:04:43,409 - INFO - app.agent_runner.common.tools_registry - API Response Status: 200
2025-05-30 16:04:43,409 - INFO - app.agent_runner.common.tools_registry - API Response Headers: {'Date': 'Fri, 30 May 2025 11:04:43 GMT', 'Content-Type': 'text/html; charset=UTF-8', 'Transfer-Encoding': 'chunked', 'Connection': 'keep-alive', 'Server': 'cloudflare', 'Nel': '{"success_fraction":0,"report_to":"cf-nel","max_age":604800}', 'Cf-Ray': '947dc096bc95661c-AMS', 'Vary': 'HTTPS', 'X-Powered-By': 'PHP/7.3.33', 'P3p': 'policyref="/bitrix/p3p.xml", CP="NON DSP COR CUR ADM DEV PSA PSD OUR UNR BUS UNI COM NAV INT DEM STA"', 'X-Powered-Cms': 'Bitrix Site Manager (16899fb15b29f3b6cb9157e0b568ff46)', 'Expires': 'Thu, 19 Nov 1981 08:52:00 GMT', 'Cache-Control': 'no-store, no-cache, must-revalidate', 'Pragma': 'no-cache', 'X-Frame-Options': 'SAMEORIGIN', 'Content-Encoding': 'br', 'Permissions-Policy': 'browsing-topics=()', 'Strict-Transport-Security': ': max-age=3600', 'Cf-Cache-Status': 'DYNAMIC', 'Report-To': '{"endpoints":[{"url":"https:\\/\\/a.nel.cloudflare.com\\/report\\/v4?s=6Qp%2BXHikbdTA9nTFbGMnnnJYKwMdpHQ7zGIHwray94ukXX%2F%2BoBn18dEhEwIPnvJOX33hO6gLYLeC7JxecYQn5IEbNoETDQWHxLxVElNXNIwIyEN1g9edWEoSXu5%2Fa%2FGh"}],"group":"cf-nel","max_age":604800}', 'Set-Cookie': 'PHPSESSID=F5qlxdnWsPvNxfkYuKyGi4e0eFSW5qWN; HttpOnly; Secure; Path=/', 'server-timing': 'cfL4;desc="?proto=TCP&rtt=112263&min_rtt=111854&rtt_var=42237&sent=5&recv=6&lost=0&retrans=0&sent_bytes=2882&recv_bytes=1326&delivery_rate=36154&cwnd=252&unsent_bytes=0&cid=0871b604fdec16fb&ts=229&x=0"'}
2025-05-30 16:04:43,409 - INFO - app.agent_runner.common.tools_registry - API Response Content-Type: text/html; charset=UTF-8
2025-05-30 16:04:43,409 - INFO - app.agent_runner.common.tools_registry - API Response Content Length: 7 bytes
2025-05-30 16:04:43,409 - INFO - app.agent_runner.common.tools_registry - API Response Encoding: UTF-8
2025-05-30 16:04:43,409 - INFO - app.agent_runner.common.tools_registry - Successfully got decoded text content, encoding: UTF-8
2025-05-30 16:04:43,409 - INFO - app.agent_runner.common.tools_registry - API Response Content Preview (first 1000 chars): ï¿½574
2025-05-30 16:04:43,409 - WARNING - app.agent_runner.common.tools_registry - Failed to parse JSON response: Expecting value: line 1 column 1 (char 0)
2025-05-30 16:04:43,409 - INFO - app.agent_runner.common.tools_registry - Returning raw text response
2025-05-30 16:04:43,410 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:04:43,411 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:04:43,434 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:04:43,437 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:04:44,678 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:04:45,107 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ’Ğ°Ñˆ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² ÑĞ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ 574 Ğ±Ğ±. Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¾ Ñ‚Ğ¾Ğ¼, 
2025-05-30 16:04:45,107 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 16:04:45,107 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 470, 'output_tokens': 34, 'total_tokens': 504, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:04:45,107 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:470 C:34 T:504
2025-05-30 16:04:45,107 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 504 tokens recorded.
2025-05-30 16:04:45,108 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:04:45,108 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 16:04:45,109 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ’Ğ°Ñˆ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² ÑĞ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ 574 Ğ±Ğ±. Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¾ Ñ‚Ğ¾Ğ¼, ...
2025-05-30 16:04:45,111 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 59cff0eb-6ee7-47d1-a747-3077cb893c09)
2025-05-30 16:04:45,111 - INFO - AGENT:agent_airsoft_0faa9616 - Found 3 token usage events for InteractionID: 59cff0eb-6ee7-47d1-a747-3077cb893c09.
2025-05-30 16:04:45,114 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Ğ’Ğ°Ñˆ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² ÑĞ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ 574 Ğ±Ğ±. Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¾ Ñ‚Ğ¾Ğ¼, ...
2025-05-30 16:04:45,114 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Ğ’Ğ°Ñˆ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² ÑĞ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ 574 ...'
2025-05-30 16:04:45,114 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '59cff0eb-6ee7-47d1-a747-3077cb893c09', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 364, 'completion_tokens': 12, 'total_tokens': 376, 'timestamp': '2025-05-30T11:04:41.921198+00:00'}
2025-05-30 16:04:45,114 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 59cff0eb-6ee7-47d1-a747-3077cb893c09
2025-05-30 16:04:45,118 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 59cff0eb-6ee7-47d1-a747-3077cb893c09, db_id: 990
2025-05-30 16:04:45,146 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 990 for interaction_id: 59cff0eb-6ee7-47d1-a747-3077cb893c09 on attempt 1
2025-05-30 16:04:45,152 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 59cff0eb-6ee7-47d1-a747-3077cb893c09, db_id: 458
2025-05-30 16:04:45,154 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '59cff0eb-6ee7-47d1-a747-3077cb893c09', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 470, 'completion_tokens': 34, 'total_tokens': 504, 'timestamp': '2025-05-30T11:04:45.107540+00:00'}
2025-05-30 16:04:45,154 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 59cff0eb-6ee7-47d1-a747-3077cb893c09
2025-05-30 16:04:45,155 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 990 for interaction_id: 59cff0eb-6ee7-47d1-a747-3077cb893c09 on attempt 1
2025-05-30 16:04:45,159 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 59cff0eb-6ee7-47d1-a747-3077cb893c09, db_id: 459
2025-05-30 16:04:45,161 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '59cff0eb-6ee7-47d1-a747-3077cb893c09', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 435, 'completion_tokens': 16, 'total_tokens': 451, 'timestamp': '2025-05-30T11:04:42.930674+00:00'}
2025-05-30 16:04:45,161 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 59cff0eb-6ee7-47d1-a747-3077cb893c09
2025-05-30 16:04:45,162 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 990 for interaction_id: 59cff0eb-6ee7-47d1-a747-3077cb893c09 on attempt 1
2025-05-30 16:04:45,164 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 59cff0eb-6ee7-47d1-a747-3077cb893c09, db_id: 460
2025-05-30 16:05:22,664 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ¸Ğ· Ğ±Ğ»Ğ¾Ğ³Ğ°...'
2025-05-30 16:05:22,667 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 16:05:22,671 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 16:05:22,671 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:05:22,671 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 16:05:22,672 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 86f4139f-7e1f-4a59-bda7-0d8ca6524f9e)
2025-05-30 16:05:22,672 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 16:05:22,673 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 16:05:22,673 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 16:05:22,676 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:05:22,677 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:05:22,680 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 86f4139f-7e1f-4a59-bda7-0d8ca6524f9e, db_id: 991
2025-05-30 16:05:22,703 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:05:22,706 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:05:23,654 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:05:23,671 - INFO - aiogram.event - Update id=804756339 is handled. Duration 1006 ms by bot id=1750613938
2025-05-30 16:05:23,706 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 16:05:23,706 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_38647f5e19'}
2025-05-30 16:05:23,706 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 517, 'output_tokens': 16, 'total_tokens': 533, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:05:23,706 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:517 C:16 T:533
2025-05-30 16:05:23,706 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 533 tokens recorded.
2025-05-30 16:05:23,707 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:05:23,707 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748460000001
2025-05-30 16:05:23,707 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748460000001)---
2025-05-30 16:05:23,708 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'JSONPlaceholder POST'
2025-05-30 16:05:23,708 - INFO - app.agent_runner.common.tools_registry - Function parameters: api_config=True, log_adapter=True, state=True
2025-05-30 16:05:23,708 - INFO - app.agent_runner.common.tools_registry - State type: <class 'dict'>
2025-05-30 16:05:23,709 - INFO - app.agent_runner.common.tools_registry - State keys: ['messages', 'documents', 'question', 'original_question', 'rewrite_count', 'channel', 'user_data', 'token_usage_events']
2025-05-30 16:05:23,709 - INFO - app.agent_runner.common.tools_registry - User data extracted: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:05:23,709 - INFO - app.agent_runner.common.tools_registry - Final user_data for API tool 'JSONPlaceholder POST': {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:05:23,709 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://jsonplaceholder.typicode.com/posts
2025-05-30 16:05:23,709 - INFO - app.agent_runner.common.tools_registry - Headers type: <class 'dict'>, value: {'Content-Type': 'application/json'}
2025-05-30 16:05:23,709 - INFO - app.agent_runner.common.tools_registry - Query Params: {}
2025-05-30 16:05:23,709 - INFO - app.agent_runner.common.tools_registry - Attempting Cloudflare bypass with cloudscraper for https://jsonplaceholder.typicode.com/posts
2025-05-30 16:05:24,082 - INFO - app.agent_runner.common.tools_registry - Cloudscraper request successful with status 200
2025-05-30 16:05:24,082 - INFO - app.agent_runner.common.tools_registry - API Response Status: 200
2025-05-30 16:05:24,082 - INFO - app.agent_runner.common.tools_registry - API Response Headers: {'Date': 'Fri, 30 May 2025 11:05:24 GMT', 'Content-Type': 'application/json; charset=utf-8', 'Transfer-Encoding': 'chunked', 'Connection': 'keep-alive', 'Server': 'cloudflare', 'Server-Timing': 'cfCacheStatus;desc="HIT", cfL4;desc="?proto=TCP&rtt=112188&min_rtt=111967&rtt_var=42430&sent=5&recv=6&lost=0&retrans=0&sent_bytes=2873&recv_bytes=995&delivery_rate=35555&cwnd=252&unsent_bytes=0&cid=ba90f55c1bda4962&ts=126&x=0"', 'Cf-Ray': '947dc1958aea88ce-AMS', 'Report-To': '{"group":"heroku-nel","max_age":3600,"endpoints":[{"url":"https://nel.heroku.com/reports?ts=1745364533&sid=e11707d5-02a7-43ef-b45e-2cf4d2036f7d&s=uo710C4FIUNu4BFlCUNZBJLrAa9qxMz%2Bz8sjG2qw2BY%3D"}]}', 'Reporting-Endpoints': 'heroku-nel=https://nel.heroku.com/reports?ts=1745364533&sid=e11707d5-02a7-43ef-b45e-2cf4d2036f7d&s=uo710C4FIUNu4BFlCUNZBJLrAa9qxMz%2Bz8sjG2qw2BY%3D', 'Nel': '{"report_to":"heroku-nel","max_age":3600,"success_fraction":0.005,"failure_fraction":0.05,"response_headers":["Via"]}', 'X-Powered-By': 'Express', 'X-Ratelimit-Limit': '1000', 'X-Ratelimit-Remaining': '999', 'X-Ratelimit-Reset': '1745364561', 'Vary': 'Origin, Accept-Encoding', 'Access-Control-Allow-Credentials': 'true', 'Cache-Control': 'max-age=43200', 'Pragma': 'no-cache', 'Expires': '-1', 'X-Content-Type-Options': 'nosniff', 'Etag': 'W/"6b80-Ybsq/K6GwwqrYkAsFxqDXGC7DoM"', 'Content-Encoding': 'gzip', 'Via': '1.1 vegur', 'Age': '5524', 'Cf-Cache-Status': 'HIT', 'alt-svc': 'h3=":443"; ma=86400'}
2025-05-30 16:05:24,083 - INFO - app.agent_runner.common.tools_registry - API Response Content-Type: application/json; charset=utf-8
2025-05-30 16:05:24,083 - INFO - app.agent_runner.common.tools_registry - API Response Content Length: 27520 bytes
2025-05-30 16:05:24,083 - INFO - app.agent_runner.common.tools_registry - API Response Encoding: utf-8
2025-05-30 16:05:24,083 - INFO - app.agent_runner.common.tools_registry - Successfully got decoded text content, encoding: utf-8
2025-05-30 16:05:24,083 - INFO - app.agent_runner.common.tools_registry - API Response Content Preview (first 1000 chars): [
  {
    "userId": 1,
    "id": 1,
    "title": "sunt aut facere repellat provident occaecati excepturi optio reprehenderit",
    "body": "quia et suscipit\nsuscipit recusandae consequuntur expedita et cum\nreprehenderit molestiae ut ut quas totam\nnostrum rerum est autem sunt rem eveniet architecto"
  },
  {
    "userId": 1,
    "id": 2,
    "title": "qui est esse",
    "body": "est rerum tempore vitae\nsequi sint nihil reprehenderit dolor beatae ea dolores neque\nfugiat blanditiis voluptate porro vel nihil molestiae ut reiciendis\nqui aperiam non debitis possimus qui neque nisi nulla"
  },
  {
    "userId": 1,
    "id": 3,
    "title": "ea molestias quasi exercitationem repellat qui ipsa sit aut",
    "body": "et iusto sed quo iure\nvoluptatem occaecati omnis eligendi aut ad\nvoluptatem doloribus vel accusantium quis pariatur\nmolestiae porro eius odio et labore et velit aut"
  },
  {
    "userId": 1,
    "id": 4,
    "title": "eum et est occaecati",
    "body": "ullam et saepe reic
2025-05-30 16:05:24,083 - INFO - app.agent_runner.common.tools_registry - Response content truncated. Full length: 27520 characters
2025-05-30 16:05:24,083 - INFO - app.agent_runner.common.tools_registry - Successfully parsed JSON response with 100 top-level items
2025-05-30 16:05:24,085 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:05:24,085 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:05:24,108 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:05:24,111 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:05:25,323 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:05:26,354 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ’Ğ¾Ñ‚ Ğ¾Ğ´Ğ½Ğ° Ğ¸Ğ· Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¸Ğ· Ğ±Ğ»Ğ¾Ğ³Ğ°:

**Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº:** sunt aut facere repellat provident occaecati excepturi
2025-05-30 16:05:26,354 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 16:05:26,354 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 8237, 'output_tokens': 86, 'total_tokens': 8323, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:05:26,354 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:8237 C:86 T:8323
2025-05-30 16:05:26,354 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 8323 tokens recorded.
2025-05-30 16:05:26,355 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:05:26,355 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 16:05:26,356 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ’Ğ¾Ñ‚ Ğ¾Ğ´Ğ½Ğ° Ğ¸Ğ· Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¸Ğ· Ğ±Ğ»Ğ¾Ğ³Ğ°:

**Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº:** sunt aut facere repellat provident occaecati excepturi...
2025-05-30 16:05:26,358 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 86f4139f-7e1f-4a59-bda7-0d8ca6524f9e)
2025-05-30 16:05:26,358 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: 86f4139f-7e1f-4a59-bda7-0d8ca6524f9e.
2025-05-30 16:05:26,360 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Ğ’Ğ¾Ñ‚ Ğ¾Ğ´Ğ½Ğ° Ğ¸Ğ· Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¸Ğ· Ğ±Ğ»Ğ¾Ğ³Ğ°:

**Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº:** sunt aut facere repellat provident occaecati excepturi...
2025-05-30 16:05:26,360 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Ğ’Ğ¾Ñ‚ Ğ¾Ğ´Ğ½Ğ° Ğ¸Ğ· Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¸Ğ· Ğ±Ğ»Ğ¾Ğ³Ğ°:

**Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº:** sunt...'
2025-05-30 16:05:26,362 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '86f4139f-7e1f-4a59-bda7-0d8ca6524f9e', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 517, 'completion_tokens': 16, 'total_tokens': 533, 'timestamp': '2025-05-30T11:05:23.706584+00:00'}
2025-05-30 16:05:26,362 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 86f4139f-7e1f-4a59-bda7-0d8ca6524f9e
2025-05-30 16:05:26,365 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 992 for interaction_id: 86f4139f-7e1f-4a59-bda7-0d8ca6524f9e on attempt 1
2025-05-30 16:05:26,365 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 86f4139f-7e1f-4a59-bda7-0d8ca6524f9e, db_id: 992
2025-05-30 16:05:26,368 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 86f4139f-7e1f-4a59-bda7-0d8ca6524f9e, db_id: 461
2025-05-30 16:05:26,372 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '86f4139f-7e1f-4a59-bda7-0d8ca6524f9e', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 8237, 'completion_tokens': 86, 'total_tokens': 8323, 'timestamp': '2025-05-30T11:05:26.354748+00:00'}
2025-05-30 16:05:26,372 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 86f4139f-7e1f-4a59-bda7-0d8ca6524f9e
2025-05-30 16:05:26,373 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 992 for interaction_id: 86f4139f-7e1f-4a59-bda7-0d8ca6524f9e on attempt 1
2025-05-30 16:05:26,376 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 86f4139f-7e1f-4a59-bda7-0d8ca6524f9e, db_id: 462
2025-05-30 16:05:40,682 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Ğ¿ĞµÑ€ĞµĞ²ĞµĞ´Ğ¸...'
2025-05-30 16:05:40,683 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 16:05:40,687 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 16:05:40,688 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:05:40,688 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 16:05:40,689 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 3bda4c7b-ff9c-4828-b8eb-14b92e73fe3e)
2025-05-30 16:05:40,689 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 16:05:40,690 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 16:05:40,690 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 16:05:40,692 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:05:40,692 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:05:40,695 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 3bda4c7b-ff9c-4828-b8eb-14b92e73fe3e, db_id: 993
2025-05-30 16:05:40,718 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:05:40,721 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:05:41,689 - INFO - aiogram.event - Update id=804756340 is handled. Duration 1006 ms by bot id=1750613938
2025-05-30 16:05:42,026 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:05:43,303 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: ĞšĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾! Ğ’Ğ¾Ñ‚ Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ¸Ğ· Ğ±Ğ»Ğ¾Ğ³Ğ° Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¸Ğ¹:

**Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº:** "Ğ­Ñ‚Ğ¾ ĞµÑÑ‚ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ¾Ñ‚Ñ‚Ğ°Ğ»ĞºĞ¸Ğ²Ğ°ÑÑ‰
2025-05-30 16:05:43,303 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_38647f5e19'}
2025-05-30 16:05:43,303 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 8333, 'output_tokens': 112, 'total_tokens': 8445, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:05:43,303 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:8333 C:112 T:8445
2025-05-30 16:05:43,303 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 8445 tokens recorded.
2025-05-30 16:05:43,305 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:05:43,305 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 16:05:43,305 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: ĞšĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾! Ğ’Ğ¾Ñ‚ Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ¸Ğ· Ğ±Ğ»Ğ¾Ğ³Ğ° Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¸Ğ¹:

**Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº:** "Ğ­Ñ‚Ğ¾ ĞµÑÑ‚ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ¾Ñ‚Ñ‚Ğ°Ğ»ĞºĞ¸Ğ²Ğ°ÑÑ‰...
2025-05-30 16:05:43,307 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 3bda4c7b-ff9c-4828-b8eb-14b92e73fe3e)
2025-05-30 16:05:43,307 - INFO - AGENT:agent_airsoft_0faa9616 - Found 1 token usage events for InteractionID: 3bda4c7b-ff9c-4828-b8eb-14b92e73fe3e.
2025-05-30 16:05:43,308 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: ĞšĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾! Ğ’Ğ¾Ñ‚ Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ¸Ğ· Ğ±Ğ»Ğ¾Ğ³Ğ° Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¸Ğ¹:

**Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº:** "Ğ­Ñ‚Ğ¾ ĞµÑÑ‚ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ¾Ñ‚Ñ‚Ğ°Ğ»ĞºĞ¸Ğ²Ğ°ÑÑ‰...
2025-05-30 16:05:43,309 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'ĞšĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾! Ğ’Ğ¾Ñ‚ Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ¸Ğ· Ğ±Ğ»Ğ¾Ğ³Ğ° Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¸Ğ¹:

...'
2025-05-30 16:05:43,310 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '3bda4c7b-ff9c-4828-b8eb-14b92e73fe3e', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 8333, 'completion_tokens': 112, 'total_tokens': 8445, 'timestamp': '2025-05-30T11:05:43.303971+00:00'}
2025-05-30 16:05:43,310 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 3bda4c7b-ff9c-4828-b8eb-14b92e73fe3e
2025-05-30 16:05:43,312 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 993 for interaction_id: 3bda4c7b-ff9c-4828-b8eb-14b92e73fe3e on attempt 1
2025-05-30 16:05:43,314 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 3bda4c7b-ff9c-4828-b8eb-14b92e73fe3e, db_id: 994
2025-05-30 16:05:43,317 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 3bda4c7b-ff9c-4828-b8eb-14b92e73fe3e, db_id: 463
2025-05-30 16:09:00,008 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 16:09:00,018 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 16:12:42,766 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:12:42,766 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:12:42,771 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:12:42,771 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:12:42,771 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:12:42,771 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:12:42,771 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:12:42,771 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:12:42,771 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:12:42,771 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:12:42,771 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:12:42,772 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:12:42,772 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:12:42,778 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:12:42,778 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:12:42,778 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:12:42,793 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:12:42,793 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:12:42,793 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:12:42,793 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:12:42,795 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:12:42,795 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:12:42,795 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4409810080) setup complete. Starting run loop.
2025-05-30 16:12:42,795 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:12:42,796 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:12:42,796 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4425551312) setup complete. Starting run loop.
2025-05-30 16:12:42,796 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:12:42,796 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:12:42,796 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:12:42,829 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:12:42,829 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:12:42,830 - WARNING - app.services.process_manager - Agent agent_airsoft_0faa9616 status is 'running' in Redis, but PID 77299 not found. Updating status.
2025-05-30 16:12:42,832 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 16:12:42,833 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 81745
2025-05-30 16:12:42,833 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 81745
2025-05-30 16:12:42,834 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 16:12:42,834 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:12:42,834 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:12:42,835 - WARNING - app.services.process_manager - Integration telegram for agent agent_airsoft_0faa9616 status is 'running' in Redis, but PID 76893 not found. Updating status.
2025-05-30 16:12:42,836 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 16:12:42,836 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 81746
2025-05-30 16:12:42,836 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 81746
2025-05-30 16:12:42,837 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 16:12:42,838 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:12:42,838 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:12:42,838 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:12:42,838 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:12:43,764 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:12:43,764 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 16:12:43,764 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 16:12:43,764 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 16:12:43,764 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 81746
2025-05-30 16:12:43,764 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 16:12:43,764 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 16:12:43,764 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 16:12:43,770 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 16:12:43,784 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 16:12:43,784 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 16:12:43,784 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 16:12:43,784 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4457546816) setup complete. Starting run loop.
2025-05-30 16:12:43,784 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 16:12:43,784 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 16:12:43,784 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 16:12:43,784 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 16:12:43,784 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:12:43,784 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 16:12:43,784 - INFO - aiogram.dispatcher - Start polling
2025-05-30 16:12:43,788 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:12:44,095 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 16:12:44,217 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:12:44,217 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 16:12:44,217 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 16:12:44,217 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 16:12:44,217 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 81745
2025-05-30 16:12:44,217 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 16:12:44,217 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 16:12:44,217 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 16:12:44,262 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 16:12:44,262 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 16:12:44,308 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 16:12:44,308 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 16:12:44,308 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 16:12:44,308 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 16:12:44,308 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 16:12:44,308 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:12:44,334 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 16:12:44,334 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 16:12:44,334 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 16:12:44,335 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 16:12:44,336 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET)
2025-05-30 16:12:44,336 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 16:12:44,336 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 16:12:44,390 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 16:12:44,395 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 16:12:45,879 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 16:12:45,882 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 16:12:45,882 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 16:12:45,882 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 16:12:45,882 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 16:12:45,882 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 16:12:45,882 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 16:12:45,882 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 16:12:45,882 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 16:12:45,882 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 16:12:45,883 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 16:12:45,883 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 16:12:45,883 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 16:12:45,883 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 16:12:45,883 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 16:12:45,883 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 16:12:45,892 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 16:12:45,893 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 16:12:45,893 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 16:12:45,893 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4517229536) setup complete. Starting run loop.
2025-05-30 16:12:45,893 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 16:12:45,893 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 16:12:45,893 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 16:12:45,893 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:12:45,896 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:12:52,797 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 16:12:52,802 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 16:12:52,802 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4425557840) setup complete. Starting run loop.
2025-05-30 16:12:52,802 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 16:13:29,767 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñƒ Ğ¼ĞµĞ½Ñ Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ?...'
2025-05-30 16:13:29,768 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 16:13:29,833 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 16:13:29,834 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:13:29,834 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 16:13:29,834 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 4568d90d-0b69-4f17-a256-b5d19355e489)
2025-05-30 16:13:29,834 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 16:13:29,835 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 16:13:29,835 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 16:13:29,859 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 4568d90d-0b69-4f17-a256-b5d19355e489, db_id: 995
2025-05-30 16:13:29,894 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:13:29,895 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:13:29,920 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:13:29,923 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:13:30,834 - INFO - aiogram.event - Update id=804756341 is handled. Duration 1067 ms by bot id=1750613938
2025-05-30 16:13:31,249 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:13:31,296 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 16:13:31,296 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 16:13:31,296 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 363, 'output_tokens': 12, 'total_tokens': 375, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:13:31,296 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:363 C:12 T:375
2025-05-30 16:13:31,296 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 375 tokens recorded.
2025-05-30 16:13:31,297 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:13:31,297 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: get_user_info_tool
2025-05-30 16:13:31,297 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (get_user_info_tool)---
2025-05-30 16:13:31,299 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:13:31,299 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:13:31,324 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:13:31,326 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:13:32,984 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:13:32,986 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 16:13:32,986 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 16:13:32,986 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 434, 'output_tokens': 16, 'total_tokens': 450, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:13:32,986 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:434 C:16 T:450
2025-05-30 16:13:32,986 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 450 tokens recorded.
2025-05-30 16:13:32,987 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:13:32,987 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748589354598
2025-05-30 16:13:32,987 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748589354598)---
2025-05-30 16:13:32,988 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹'
2025-05-30 16:13:32,988 - INFO - app.agent_runner.common.tools_registry - Function parameters: api_config=True, log_adapter=True, state=True
2025-05-30 16:13:32,988 - INFO - app.agent_runner.common.tools_registry - State type: <class 'dict'>
2025-05-30 16:13:32,988 - INFO - app.agent_runner.common.tools_registry - State keys: ['messages', 'documents', 'question', 'original_question', 'rewrite_count', 'channel', 'user_data', 'token_usage_events']
2025-05-30 16:13:32,988 - INFO - app.agent_runner.common.tools_registry - User data extracted: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:13:32,988 - INFO - app.agent_runner.common.tools_registry - Final user_data for API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹': {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:13:32,988 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:13:32,988 - INFO - app.agent_runner.common.tools_registry - Headers type: <class 'dict'>, value: {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36', 'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7', 'Accept-Language': 'ru-RU,ru;q=0.9,en;q=0.8', 'Accept-Encoding': 'gzip, deflate, br', 'DNT': '1', 'Connection': 'keep-alive', 'Upgrade-Insecure-Requests': '1', 'Sec-Fetch-Dest': 'document', 'Sec-Fetch-Mode': 'navigate', 'Sec-Fetch-Site': 'same-origin', 'Sec-Fetch-User': '?1', 'Cache-Control': 'max-age=0', 'Referer': 'https://airsoft-rus.ru/', 'Cookie': 'PHPSESSID=gq3cMIY4z4t5OLt12aMMcFrus6CEIhZR'}
2025-05-30 16:13:32,988 - INFO - app.agent_runner.common.tools_registry - Query Params: {'type': 'info', 'tel': '79222088435'}
2025-05-30 16:13:32,988 - INFO - app.agent_runner.common.tools_registry - Attempting Cloudflare bypass with cloudscraper for https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:13:33,455 - INFO - app.agent_runner.common.tools_registry - Cloudscraper request successful with status 200
2025-05-30 16:13:33,455 - INFO - app.agent_runner.common.tools_registry - API Response Status: 200
2025-05-30 16:13:33,455 - INFO - app.agent_runner.common.tools_registry - API Response Headers: {'Date': 'Fri, 30 May 2025 11:13:33 GMT', 'Content-Type': 'text/html; charset=UTF-8', 'Transfer-Encoding': 'chunked', 'Connection': 'keep-alive', 'Server': 'cloudflare', 'Nel': '{"success_fraction":0,"report_to":"cf-nel","max_age":604800}', 'Cf-Ray': '947dcd876df3f5eb-AMS', 'Vary': 'HTTPS', 'X-Powered-By': 'PHP/7.3.33', 'P3p': 'policyref="/bitrix/p3p.xml", CP="NON DSP COR CUR ADM DEV PSA PSD OUR UNR BUS UNI COM NAV INT DEM STA"', 'X-Powered-Cms': 'Bitrix Site Manager (16899fb15b29f3b6cb9157e0b568ff46)', 'Expires': 'Thu, 19 Nov 1981 08:52:00 GMT', 'Cache-Control': 'no-store, no-cache, must-revalidate', 'Pragma': 'no-cache', 'X-Frame-Options': 'SAMEORIGIN', 'Content-Encoding': 'br', 'Permissions-Policy': 'browsing-topics=()', 'Strict-Transport-Security': ': max-age=3600', 'Cf-Cache-Status': 'DYNAMIC', 'Report-To': '{"endpoints":[{"url":"https:\\/\\/a.nel.cloudflare.com\\/report\\/v4?s=Uci2DubjtjFJlRmK2FBSZF9hn6VHhU4iqVjxM3QYIp5Kc1nurMSqozSgynnTgsrYWxCkuFtg71NrHsfNQGU64ujWXEqF1A0cA5tk603rTlwU7LN95E3EbKezdoP7X3DG"}],"group":"cf-nel","max_age":604800}', 'Set-Cookie': 'PHPSESSID=Xm6b4WeJNPx4bma6IuoySxfedCXkXLx6; HttpOnly; Secure; Path=/', 'server-timing': 'cfL4;desc="?proto=TCP&rtt=112194&min_rtt=111888&rtt_var=42176&sent=5&recv=6&lost=0&retrans=0&sent_bytes=2882&recv_bytes=1326&delivery_rate=36143&cwnd=238&unsent_bytes=0&cid=18819f457f344d4e&ts=219&x=0"'}
2025-05-30 16:13:33,455 - INFO - app.agent_runner.common.tools_registry - API Response Content-Type: text/html; charset=UTF-8
2025-05-30 16:13:33,455 - INFO - app.agent_runner.common.tools_registry - API Response Content Length: 7 bytes
2025-05-30 16:13:33,455 - INFO - app.agent_runner.common.tools_registry - API Response Encoding: UTF-8
2025-05-30 16:13:33,455 - INFO - app.agent_runner.common.tools_registry - Successfully got decoded text content, encoding: UTF-8
2025-05-30 16:13:33,455 - INFO - app.agent_runner.common.tools_registry - API Response Content Preview (first 1000 chars): ï¿½574
2025-05-30 16:13:33,455 - WARNING - app.agent_runner.common.tools_registry - Failed to parse JSON response: Expecting value: line 1 column 1 (char 0)
2025-05-30 16:13:33,455 - INFO - app.agent_runner.common.tools_registry - Returning raw text response
2025-05-30 16:13:33,457 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:13:33,457 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:13:33,481 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:13:33,484 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:13:34,323 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:13:34,765 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: ĞĞ° Ğ²Ğ°ÑˆĞµĞ¼ ÑÑ‡ĞµÑ‚Ñƒ ÑĞµĞ¹Ñ‡Ğ°Ñ 574 Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°. Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ ÑƒĞ·Ğ½Ğ°Ñ‚ÑŒ, ĞºĞ°Ğº Ğ¸Ñ… Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ
2025-05-30 16:13:34,765 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_38647f5e19'}
2025-05-30 16:13:34,765 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 469, 'output_tokens': 28, 'total_tokens': 497, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:13:34,765 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:469 C:28 T:497
2025-05-30 16:13:34,765 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 497 tokens recorded.
2025-05-30 16:13:34,766 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:13:34,766 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 16:13:34,767 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: ĞĞ° Ğ²Ğ°ÑˆĞµĞ¼ ÑÑ‡ĞµÑ‚Ñƒ ÑĞµĞ¹Ñ‡Ğ°Ñ 574 Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°. Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ ÑƒĞ·Ğ½Ğ°Ñ‚ÑŒ, ĞºĞ°Ğº Ğ¸Ñ… Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ...
2025-05-30 16:13:34,769 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 4568d90d-0b69-4f17-a256-b5d19355e489)
2025-05-30 16:13:34,769 - INFO - AGENT:agent_airsoft_0faa9616 - Found 3 token usage events for InteractionID: 4568d90d-0b69-4f17-a256-b5d19355e489.
2025-05-30 16:13:34,772 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: ĞĞ° Ğ²Ğ°ÑˆĞµĞ¼ ÑÑ‡ĞµÑ‚Ñƒ ÑĞµĞ¹Ñ‡Ğ°Ñ 574 Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°. Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ ÑƒĞ·Ğ½Ğ°Ñ‚ÑŒ, ĞºĞ°Ğº Ğ¸Ñ… Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ...
2025-05-30 16:13:34,772 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'ĞĞ° Ğ²Ğ°ÑˆĞµĞ¼ ÑÑ‡ĞµÑ‚Ñƒ ÑĞµĞ¹Ñ‡Ğ°Ñ 574 Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°. Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‚...'
2025-05-30 16:13:34,773 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '4568d90d-0b69-4f17-a256-b5d19355e489', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 363, 'completion_tokens': 12, 'total_tokens': 375, 'timestamp': '2025-05-30T11:13:31.296198+00:00'}
2025-05-30 16:13:34,773 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 4568d90d-0b69-4f17-a256-b5d19355e489
2025-05-30 16:13:34,777 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 4568d90d-0b69-4f17-a256-b5d19355e489, db_id: 996
2025-05-30 16:13:34,805 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 996 for interaction_id: 4568d90d-0b69-4f17-a256-b5d19355e489 on attempt 1
2025-05-30 16:13:34,810 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 4568d90d-0b69-4f17-a256-b5d19355e489, db_id: 464
2025-05-30 16:13:34,812 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '4568d90d-0b69-4f17-a256-b5d19355e489', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 469, 'completion_tokens': 28, 'total_tokens': 497, 'timestamp': '2025-05-30T11:13:34.765602+00:00'}
2025-05-30 16:13:34,812 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 4568d90d-0b69-4f17-a256-b5d19355e489
2025-05-30 16:13:34,813 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 996 for interaction_id: 4568d90d-0b69-4f17-a256-b5d19355e489 on attempt 1
2025-05-30 16:13:34,816 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 4568d90d-0b69-4f17-a256-b5d19355e489, db_id: 465
2025-05-30 16:13:34,819 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '4568d90d-0b69-4f17-a256-b5d19355e489', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 434, 'completion_tokens': 16, 'total_tokens': 450, 'timestamp': '2025-05-30T11:13:32.986372+00:00'}
2025-05-30 16:13:34,819 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 4568d90d-0b69-4f17-a256-b5d19355e489
2025-05-30 16:13:34,819 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 996 for interaction_id: 4568d90d-0b69-4f17-a256-b5d19355e489 on attempt 1
2025-05-30 16:13:34,821 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 4568d90d-0b69-4f17-a256-b5d19355e489, db_id: 466
2025-05-30 16:17:52,991 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 16:17:52,999 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 16:22:53,182 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 16:22:53,190 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 16:27:53,330 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 16:27:53,340 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 16:32:53,526 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 16:32:53,535 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 16:35:01,347 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 16:35:01,348 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 16:35:01,348 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 16:35:01,348 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4409810080) was cancelled.
2025-05-30 16:35:01,348 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4409810080) stopping. Performing cleanup...
2025-05-30 16:35:01,348 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:35:01,353 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 16:35:01,354 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 16:35:01,354 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:35:01,354 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 16:35:01,354 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:35:01,354 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4409810080) cleanup complete.
2025-05-30 16:35:01,354 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 16:35:01,354 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 16:35:01,354 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4425551312) was cancelled.
2025-05-30 16:35:01,354 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4425551312) stopping. Performing cleanup...
2025-05-30 16:35:01,354 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:35:01,357 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 16:35:01,358 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 16:35:01,358 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:35:01,359 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 16:35:01,359 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:35:01,359 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4425551312) cleanup complete.
2025-05-30 16:35:01,359 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 16:35:01,359 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 16:35:01,359 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4425557840) was cancelled.
2025-05-30 16:35:01,359 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4425557840) stopping. Performing cleanup...
2025-05-30 16:35:01,359 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 16:35:01,359 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:35:01,359 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:35:01,359 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 16:35:01,359 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:35:01,361 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 16:35:01,361 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 16:35:01,361 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:35:01,362 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 16:35:01,362 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:35:01,362 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 16:35:01,362 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4425557840) cleanup complete.
2025-05-30 16:35:01,362 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 16:35:01,362 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 16:35:01,362 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 16:35:01,369 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:35:01,369 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 16:35:01,838 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:35:01,839 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:35:01,842 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:35:01,842 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:35:01,842 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:35:01,842 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:35:01,842 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:35:01,842 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:35:01,842 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:35:01,842 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:35:01,842 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:35:01,843 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:35:01,843 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:35:01,845 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:35:01,845 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:35:01,845 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:35:01,845 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:35:01,845 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:35:01,861 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:35:01,861 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:35:01,864 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:35:01,864 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4426849440) setup complete. Starting run loop.
2025-05-30 16:35:01,864 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:35:01,864 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:35:01,865 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:35:01,865 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4438997472) setup complete. Starting run loop.
2025-05-30 16:35:01,865 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:35:01,865 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:35:01,865 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:35:01,897 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:35:01,897 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:35:01,898 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:35:01,898 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:35:01,898 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:35:01,899 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:35:01,899 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:35:01,900 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:35:01,900 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:35:01,900 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:35:03,136 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 16:35:03,136 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4517229536) received shutdown request. Initiating graceful shutdown...
2025-05-30 16:35:03,136 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4517229536)...
2025-05-30 16:35:03,136 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 16:35:03,136 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 16:35:03,136 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 16:35:03,136 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4517229536) was cancelled.
2025-05-30 16:35:03,137 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4517229536) stopping. Performing cleanup...
2025-05-30 16:35:03,137 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 16:35:03,137 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 16:35:03,137 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 16:35:03,137 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-30 16:35:03,138 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 16:35:03,138 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 16:35:03,138 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 16:35:03,138 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:35:03,138 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 16:35:03,138 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 16:35:03,138 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 16:35:03,142 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 16:35:03,143 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 16:35:03,143 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:35:03,144 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 16:35:03,144 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 16:35:03,144 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 16:35:03,144 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4517229536) cleanup complete.
2025-05-30 16:35:03,144 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 16:35:03,144 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 16:35:03,144 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:35:03,144 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 16:35:03,144 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 16:35:03,145 - INFO - __main__ - Agent runner main finished.
2025-05-30 16:35:03,309 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 16:35:03,310 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 16:35:03,310 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 16:35:03,310 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4426849440) was cancelled.
2025-05-30 16:35:03,310 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4426849440) stopping. Performing cleanup...
2025-05-30 16:35:03,310 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:35:03,314 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 16:35:03,315 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 16:35:03,315 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:35:03,315 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 16:35:03,315 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:35:03,315 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4426849440) cleanup complete.
2025-05-30 16:35:03,315 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 16:35:03,315 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 16:35:03,315 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4438997472) was cancelled.
2025-05-30 16:35:03,315 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4438997472) stopping. Performing cleanup...
2025-05-30 16:35:03,315 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:35:03,318 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 16:35:03,319 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 16:35:03,319 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:35:03,319 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 16:35:03,319 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:35:03,319 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4438997472) cleanup complete.
2025-05-30 16:35:03,319 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 16:35:03,319 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 16:35:03,319 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4438997520) was cancelled.
2025-05-30 16:35:03,319 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4438997520) stopping. Performing cleanup...
2025-05-30 16:35:03,319 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 16:35:03,319 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:35:03,319 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:35:03,319 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 16:35:03,319 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:35:03,321 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 16:35:03,322 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 16:35:03,322 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:35:03,322 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 16:35:03,322 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:35:03,322 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 16:35:03,322 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4438997520) cleanup complete.
2025-05-30 16:35:03,322 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 16:35:03,322 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 16:35:03,322 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 16:35:03,324 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:35:03,324 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 16:35:03,387 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 16:35:03,388 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 16:35:03,388 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 16:35:03,388 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4457546816) received shutdown request. Initiating graceful shutdown...
2025-05-30 16:35:03,388 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4457546816)...
2025-05-30 16:35:03,388 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 16:35:03,388 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 16:35:03,388 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4457546816) was cancelled.
2025-05-30 16:35:03,388 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4457546816) stopping. Performing cleanup...
2025-05-30 16:35:03,388 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 16:35:03,388 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 16:35:03,388 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 16:35:03,388 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 16:35:03,388 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 16:35:03,388 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 16:35:03,388 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:35:03,388 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 16:35:03,388 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 16:35:03,388 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 16:35:03,392 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 16:35:03,393 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 16:35:03,393 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:35:03,393 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 16:35:03,393 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 16:35:03,393 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 16:35:03,393 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4457546816) cleanup complete.
2025-05-30 16:35:03,393 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 16:35:03,393 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 16:35:03,398 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:35:03,398 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 16:35:03,398 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 16:35:03,399 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 16:35:07,423 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:35:07,423 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:35:07,427 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:35:07,427 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:35:07,427 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:35:07,427 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:35:07,427 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:35:07,428 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:35:07,428 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:35:07,428 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:35:07,428 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:35:07,428 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:35:07,428 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:35:07,430 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:35:07,430 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:35:07,430 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:35:07,444 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:35:07,444 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:35:07,444 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:35:07,444 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:35:07,445 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:35:07,445 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4466515104) setup complete. Starting run loop.
2025-05-30 16:35:07,445 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:35:07,446 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:35:07,447 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:35:07,447 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4470571472) setup complete. Starting run loop.
2025-05-30 16:35:07,447 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:35:07,448 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:35:07,448 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:35:07,474 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:35:07,474 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:35:07,476 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 16:35:07,477 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 82106
2025-05-30 16:35:07,477 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 82106
2025-05-30 16:35:07,478 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 16:35:07,478 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:35:07,478 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:35:07,479 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 16:35:07,480 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 82107
2025-05-30 16:35:07,480 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 82107
2025-05-30 16:35:07,481 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 16:35:07,481 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:35:07,481 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:35:07,481 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:35:07,481 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:35:08,366 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:35:08,366 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 16:35:08,367 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 16:35:08,367 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 16:35:08,367 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 82107
2025-05-30 16:35:08,367 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 16:35:08,367 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 16:35:08,367 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 16:35:08,372 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 16:35:08,385 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 16:35:08,386 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 16:35:08,386 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 16:35:08,386 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4546554016) setup complete. Starting run loop.
2025-05-30 16:35:08,386 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 16:35:08,386 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 16:35:08,386 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 16:35:08,386 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 16:35:08,386 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:35:08,386 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 16:35:08,386 - INFO - aiogram.dispatcher - Start polling
2025-05-30 16:35:08,389 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:35:08,630 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 16:35:08,749 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:35:08,749 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 16:35:08,749 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 16:35:08,749 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 16:35:08,749 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 82106
2025-05-30 16:35:08,749 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 16:35:08,749 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 16:35:08,749 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 16:35:08,795 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 16:35:08,795 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 16:35:08,838 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 16:35:08,838 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 16:35:08,838 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 16:35:08,838 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 16:35:08,838 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 16:35:08,838 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:35:08,864 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 16:35:08,864 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 16:35:08,864 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 16:35:08,865 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 16:35:08,866 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET)
2025-05-30 16:35:08,866 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 16:35:08,866 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 16:35:08,920 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 16:35:08,924 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 16:35:10,296 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 16:35:10,301 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 16:35:10,301 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 16:35:10,301 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 16:35:10,301 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 16:35:10,301 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 16:35:10,301 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 16:35:10,301 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 16:35:10,301 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 16:35:10,302 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 16:35:10,302 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 16:35:10,302 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 16:35:10,302 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 16:35:10,302 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 16:35:10,302 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 16:35:10,302 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 16:35:10,311 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 16:35:10,311 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 16:35:10,312 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 16:35:10,312 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4471092096) setup complete. Starting run loop.
2025-05-30 16:35:10,312 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 16:35:10,312 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 16:35:10,312 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 16:35:10,312 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:35:10,315 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:35:17,448 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 16:35:17,452 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 16:35:17,452 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4470571616) setup complete. Starting run loop.
2025-05-30 16:35:17,452 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 16:36:16,835 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ‚Ğ°Ğ¼ Ñƒ Ğ¼ĞµĞ½Ñ Ğ±Ğ±?...'
2025-05-30 16:36:16,837 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 16:36:16,911 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 16:36:16,911 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:36:16,911 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 16:36:16,911 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: c7dd0110-6203-44f4-bb45-c8d6015b99bc)
2025-05-30 16:36:16,912 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 16:36:16,912 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-30 16:36:16,934 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: c7dd0110-6203-44f4-bb45-c8d6015b99bc, db_id: 997
2025-05-30 16:36:16,949 - INFO - AGENT:agent_airsoft_0faa9616 - Loaded 20 messages from DB for thread '144641834'.
2025-05-30 16:36:16,950 - INFO - AGENT:agent_airsoft_0faa9616 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-30 16:36:16,950 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-30 16:36:16,998 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:36:16,999 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:36:17,024 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:36:17,027 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:36:17,911 - INFO - aiogram.event - Update id=804756342 is handled. Duration 1076 ms by bot id=1750613938
2025-05-30 16:36:18,583 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:36:18,612 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 16:36:18,612 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 16:36:18,612 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1078, 'output_tokens': 16, 'total_tokens': 1094, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:36:18,612 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1078 C:16 T:1094
2025-05-30 16:36:18,612 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1094 tokens recorded.
2025-05-30 16:36:18,613 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:36:18,613 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748589354598
2025-05-30 16:36:18,613 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748589354598)---
2025-05-30 16:36:18,614 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹'
2025-05-30 16:36:18,615 - INFO - app.agent_runner.common.tools_registry - Function parameters: api_config=True, log_adapter=True, state=True
2025-05-30 16:36:18,615 - INFO - app.agent_runner.common.tools_registry - State type: <class 'dict'>
2025-05-30 16:36:18,615 - INFO - app.agent_runner.common.tools_registry - State keys: ['messages', 'documents', 'question', 'original_question', 'rewrite_count', 'channel', 'user_data', 'token_usage_events']
2025-05-30 16:36:18,615 - INFO - app.agent_runner.common.tools_registry - User data extracted: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:36:18,615 - INFO - app.agent_runner.common.tools_registry - Final user_data for API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹': {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:36:18,615 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:36:18,615 - INFO - app.agent_runner.common.tools_registry - Attempting Cloudflare bypass with cloudscraper for https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:36:19,097 - WARNING - app.agent_runner.common.tools_registry - Failed to parse JSON response: Expecting value: line 1 column 1 (char 0)
2025-05-30 16:36:19,099 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:36:19,099 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:36:19,123 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:36:19,126 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:36:19,959 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:36:20,336 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ£ Ñ‚ĞµĞ±Ñ Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ 574 Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°! Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ñ€Ğ°ÑÑĞºĞ°Ğ¶Ñƒ, ĞºĞ°Ğº Ğ¸Ñ… Ğ²Ñ‹Ğ³Ğ¾Ğ´Ğ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ? ğŸ˜‰
2025-05-30 16:36:20,336 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 16:36:20,336 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1113, 'output_tokens': 27, 'total_tokens': 1140, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:36:20,336 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1113 C:27 T:1140
2025-05-30 16:36:20,336 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1140 tokens recorded.
2025-05-30 16:36:20,337 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:36:20,337 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 16:36:20,338 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ£ Ñ‚ĞµĞ±Ñ Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ 574 Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°! Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ñ€Ğ°ÑÑĞºĞ°Ğ¶Ñƒ, ĞºĞ°Ğº Ğ¸Ñ… Ğ²Ñ‹Ğ³Ğ¾Ğ´Ğ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ? ğŸ˜‰...
2025-05-30 16:36:20,340 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: c7dd0110-6203-44f4-bb45-c8d6015b99bc)
2025-05-30 16:36:20,340 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: c7dd0110-6203-44f4-bb45-c8d6015b99bc.
2025-05-30 16:36:20,342 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Ğ£ Ñ‚ĞµĞ±Ñ Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ 574 Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°! Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ñ€Ğ°ÑÑĞºĞ°Ğ¶Ñƒ, ĞºĞ°Ğº Ğ¸Ñ… Ğ²Ñ‹Ğ³Ğ¾Ğ´Ğ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ? ğŸ˜‰...
2025-05-30 16:36:20,342 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Ğ£ Ñ‚ĞµĞ±Ñ Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ 574 Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°! Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ñ€...'
2025-05-30 16:36:20,343 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'c7dd0110-6203-44f4-bb45-c8d6015b99bc', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1078, 'completion_tokens': 16, 'total_tokens': 1094, 'timestamp': '2025-05-30T11:36:18.612354+00:00'}
2025-05-30 16:36:20,343 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: c7dd0110-6203-44f4-bb45-c8d6015b99bc
2025-05-30 16:36:20,346 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: c7dd0110-6203-44f4-bb45-c8d6015b99bc, db_id: 998
2025-05-30 16:36:20,376 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 998 for interaction_id: c7dd0110-6203-44f4-bb45-c8d6015b99bc on attempt 1
2025-05-30 16:36:20,383 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: c7dd0110-6203-44f4-bb45-c8d6015b99bc, db_id: 467
2025-05-30 16:36:20,386 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'c7dd0110-6203-44f4-bb45-c8d6015b99bc', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1113, 'completion_tokens': 27, 'total_tokens': 1140, 'timestamp': '2025-05-30T11:36:20.336599+00:00'}
2025-05-30 16:36:20,386 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: c7dd0110-6203-44f4-bb45-c8d6015b99bc
2025-05-30 16:36:20,388 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 998 for interaction_id: c7dd0110-6203-44f4-bb45-c8d6015b99bc on attempt 1
2025-05-30 16:36:20,391 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: c7dd0110-6203-44f4-bb45-c8d6015b99bc, db_id: 468
2025-05-30 16:40:17,642 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 16:40:17,651 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 16:44:45,339 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 16:44:45,341 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 16:44:45,341 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 16:44:45,342 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4466515104) was cancelled.
2025-05-30 16:44:45,342 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4466515104) stopping. Performing cleanup...
2025-05-30 16:44:45,342 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:44:45,345 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 16:44:45,346 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 16:44:45,346 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:44:45,347 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 16:44:45,347 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:44:45,347 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4466515104) cleanup complete.
2025-05-30 16:44:45,347 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 16:44:45,347 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 16:44:45,347 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4470571472) was cancelled.
2025-05-30 16:44:45,347 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4470571472) stopping. Performing cleanup...
2025-05-30 16:44:45,347 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:44:45,351 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 16:44:45,352 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 16:44:45,352 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:44:45,352 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 16:44:45,352 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:44:45,352 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4470571472) cleanup complete.
2025-05-30 16:44:45,352 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 16:44:45,352 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 16:44:45,352 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4470571616) was cancelled.
2025-05-30 16:44:45,352 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4470571616) stopping. Performing cleanup...
2025-05-30 16:44:45,352 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 16:44:45,352 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:44:45,352 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:44:45,352 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 16:44:45,352 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:44:45,354 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 16:44:45,355 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 16:44:45,355 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:44:45,355 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 16:44:45,355 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:44:45,355 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 16:44:45,356 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4470571616) cleanup complete.
2025-05-30 16:44:45,356 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 16:44:45,356 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 16:44:45,356 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 16:44:45,365 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:44:45,365 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 16:44:45,830 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:44:45,830 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:44:45,834 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:44:45,834 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:44:45,834 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:44:45,834 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:44:45,834 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:44:45,834 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:44:45,834 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:44:45,834 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:44:45,835 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:44:45,835 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:44:45,835 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:44:45,837 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:44:45,837 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:44:45,837 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:44:45,852 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:44:45,852 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:44:45,852 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:44:45,852 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:44:45,855 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:44:45,855 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4412351040) setup complete. Starting run loop.
2025-05-30 16:44:45,855 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:44:45,855 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:44:45,855 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:44:45,856 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4412179808) setup complete. Starting run loop.
2025-05-30 16:44:45,856 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:44:45,857 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:44:45,857 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:44:45,887 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:44:45,887 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:44:45,888 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:44:45,888 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:44:45,888 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:44:45,888 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:44:45,889 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:44:45,889 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:44:45,889 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:44:45,889 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:44:48,155 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 16:44:48,155 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4471092096) received shutdown request. Initiating graceful shutdown...
2025-05-30 16:44:48,155 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4471092096)...
2025-05-30 16:44:48,155 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 16:44:48,155 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 16:44:48,155 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 16:44:48,155 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4471092096) was cancelled.
2025-05-30 16:44:48,155 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4471092096) stopping. Performing cleanup...
2025-05-30 16:44:48,156 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 16:44:48,156 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 16:44:48,156 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 16:44:48,157 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-30 16:44:48,158 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 16:44:48,158 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 16:44:48,158 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 16:44:48,158 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:44:48,160 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 16:44:48,160 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 16:44:48,160 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 16:44:48,164 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 16:44:48,165 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 16:44:48,165 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:44:48,165 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 16:44:48,165 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 16:44:48,165 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 16:44:48,165 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4471092096) cleanup complete.
2025-05-30 16:44:48,165 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 16:44:48,165 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 16:44:48,172 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:44:48,172 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 16:44:48,172 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 16:44:48,173 - INFO - __main__ - Agent runner main finished.
2025-05-30 16:44:48,307 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 16:44:48,307 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 16:44:48,307 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 16:44:48,307 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4412351040) was cancelled.
2025-05-30 16:44:48,307 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4412351040) stopping. Performing cleanup...
2025-05-30 16:44:48,307 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:44:48,312 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 16:44:48,312 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 16:44:48,312 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:44:48,313 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 16:44:48,313 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:44:48,313 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4412351040) cleanup complete.
2025-05-30 16:44:48,313 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 16:44:48,313 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 16:44:48,313 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4412179808) was cancelled.
2025-05-30 16:44:48,313 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4412179808) stopping. Performing cleanup...
2025-05-30 16:44:48,313 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:44:48,315 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 16:44:48,316 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 16:44:48,316 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:44:48,316 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 16:44:48,316 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:44:48,316 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4412179808) cleanup complete.
2025-05-30 16:44:48,316 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 16:44:48,316 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 16:44:48,316 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4412179616) was cancelled.
2025-05-30 16:44:48,316 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4412179616) stopping. Performing cleanup...
2025-05-30 16:44:48,316 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 16:44:48,316 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:44:48,317 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:44:48,317 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 16:44:48,317 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:44:48,318 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 16:44:48,319 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 16:44:48,319 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:44:48,319 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 16:44:48,319 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:44:48,319 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 16:44:48,319 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4412179616) cleanup complete.
2025-05-30 16:44:48,319 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 16:44:48,319 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 16:44:48,319 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 16:44:48,322 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:44:48,322 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 16:44:48,408 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 16:44:48,408 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 16:44:48,408 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 16:44:48,408 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4546554016) received shutdown request. Initiating graceful shutdown...
2025-05-30 16:44:48,408 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4546554016)...
2025-05-30 16:44:48,408 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 16:44:48,408 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 16:44:48,408 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4546554016) was cancelled.
2025-05-30 16:44:48,408 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4546554016) stopping. Performing cleanup...
2025-05-30 16:44:48,408 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 16:44:48,408 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 16:44:48,408 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 16:44:48,408 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 16:44:48,408 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 16:44:48,408 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 16:44:48,408 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:44:48,408 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 16:44:48,409 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 16:44:48,409 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 16:44:48,413 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 16:44:48,414 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 16:44:48,414 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:44:48,414 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 16:44:48,414 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 16:44:48,414 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 16:44:48,414 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4546554016) cleanup complete.
2025-05-30 16:44:48,414 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 16:44:48,414 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 16:44:48,418 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:44:48,418 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 16:44:48,418 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 16:44:48,419 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 16:44:49,838 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:44:49,838 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:44:49,842 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:44:49,842 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:44:49,842 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:44:49,842 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:44:49,842 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:44:49,843 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:44:49,843 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:44:49,843 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:44:49,843 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:44:49,843 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:44:49,843 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:44:49,845 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:44:49,845 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:44:49,845 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:44:49,845 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:44:49,845 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:44:49,859 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:44:49,859 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:44:49,860 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:44:49,861 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:44:49,861 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4405560144) setup complete. Starting run loop.
2025-05-30 16:44:49,861 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:44:49,861 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:44:49,861 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4405559952) setup complete. Starting run loop.
2025-05-30 16:44:49,861 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:44:49,864 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:44:49,864 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:44:49,890 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:44:49,890 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:44:49,892 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 16:44:49,893 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 82397
2025-05-30 16:44:49,893 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 82397
2025-05-30 16:44:49,893 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 16:44:49,893 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:44:49,893 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:44:49,895 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 16:44:49,896 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 82398
2025-05-30 16:44:49,896 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 82398
2025-05-30 16:44:49,896 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 16:44:49,897 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:44:49,897 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:44:49,897 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:44:49,897 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:44:50,761 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:44:50,762 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 16:44:50,762 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 16:44:50,762 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 16:44:50,762 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 82398
2025-05-30 16:44:50,762 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 16:44:50,762 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 16:44:50,762 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 16:44:50,767 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 16:44:50,781 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 16:44:50,781 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 16:44:50,781 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 16:44:50,781 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4389349536) setup complete. Starting run loop.
2025-05-30 16:44:50,781 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 16:44:50,781 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 16:44:50,781 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 16:44:50,781 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 16:44:50,781 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:44:50,781 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 16:44:50,781 - INFO - aiogram.dispatcher - Start polling
2025-05-30 16:44:50,785 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:44:51,039 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 16:44:51,106 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:44:51,107 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 16:44:51,107 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 16:44:51,107 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 16:44:51,107 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 82397
2025-05-30 16:44:51,107 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 16:44:51,107 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 16:44:51,107 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 16:44:51,147 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 16:44:51,147 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 16:44:51,192 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 16:44:51,192 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 16:44:51,192 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 16:44:51,192 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 16:44:51,192 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 16:44:51,192 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:44:51,217 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 16:44:51,218 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 16:44:51,218 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 16:44:51,219 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 16:44:51,219 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET)
2025-05-30 16:44:51,220 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 16:44:51,220 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 16:44:51,277 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 16:44:51,280 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 16:44:52,141 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 16:44:52,143 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 16:44:52,143 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 16:44:52,143 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 16:44:52,143 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 16:44:52,144 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 16:44:52,144 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 16:44:52,144 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 16:44:52,144 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 16:44:52,144 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 16:44:52,144 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 16:44:52,144 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 16:44:52,144 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 16:44:52,145 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 16:44:52,145 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 16:44:52,145 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 16:44:52,154 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 16:44:52,154 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 16:44:52,154 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 16:44:52,154 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4499404032) setup complete. Starting run loop.
2025-05-30 16:44:52,155 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 16:44:52,155 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 16:44:52,155 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 16:44:52,155 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:44:52,158 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:44:59,865 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 16:44:59,869 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 16:44:59,870 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4405560096) setup complete. Starting run loop.
2025-05-30 16:44:59,870 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 16:45:11,144 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ¼Ğ¾Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ...'
2025-05-30 16:45:11,145 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 16:45:11,207 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 16:45:11,207 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 16:45:11,209 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:45:11,210 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: aabee661-f032-4161-8a2d-52c10befed51)
2025-05-30 16:45:11,210 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 16:45:11,211 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-30 16:45:11,231 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: aabee661-f032-4161-8a2d-52c10befed51, db_id: 999
2025-05-30 16:45:11,247 - INFO - AGENT:agent_airsoft_0faa9616 - Loaded 20 messages from DB for thread '144641834'.
2025-05-30 16:45:11,248 - INFO - AGENT:agent_airsoft_0faa9616 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-30 16:45:11,248 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-30 16:45:11,305 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:45:11,305 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:45:11,330 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:45:11,334 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:45:12,210 - INFO - aiogram.event - Update id=804756343 is handled. Duration 1066 ms by bot id=1750613938
2025-05-30 16:45:12,815 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:45:12,872 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 16:45:12,872 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 16:45:12,872 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1060, 'output_tokens': 16, 'total_tokens': 1076, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:45:12,872 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1060 C:16 T:1076
2025-05-30 16:45:12,872 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1076 tokens recorded.
2025-05-30 16:45:12,873 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:45:12,873 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748589354598
2025-05-30 16:45:12,873 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748589354598)---
2025-05-30 16:45:12,874 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹'
2025-05-30 16:45:12,874 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:45:12,874 - INFO - app.agent_runner.common.tools_registry - Attempting Cloudflare bypass with cloudscraper for https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:45:13,371 - INFO - app.agent_runner.common.tools_registry - Decoded content: ï¿½574... (truncated for preview)
2025-05-30 16:45:13,371 - WARNING - app.agent_runner.common.tools_registry - Failed to parse JSON response: Expecting value: line 1 column 1 (char 0)
2025-05-30 16:45:13,373 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:45:13,373 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:45:13,397 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:45:13,400 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:45:14,278 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:45:14,740 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ¢Ğ²Ğ¾Ğ¹ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² â€” 574 Ğ±Ğ±. Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ´ÑĞºĞ°Ğ·Ğ°Ñ‚ÑŒ, ĞºĞ°Ğº Ğ¸Ñ… Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ğ»Ğ¸ 
2025-05-30 16:45:14,740 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_38647f5e19'}
2025-05-30 16:45:14,740 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1095, 'output_tokens': 33, 'total_tokens': 1128, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:45:14,740 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1095 C:33 T:1128
2025-05-30 16:45:14,740 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1128 tokens recorded.
2025-05-30 16:45:14,741 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:45:14,741 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 16:45:14,742 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ¢Ğ²Ğ¾Ğ¹ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² â€” 574 Ğ±Ğ±. Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ´ÑĞºĞ°Ğ·Ğ°Ñ‚ÑŒ, ĞºĞ°Ğº Ğ¸Ñ… Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ğ»Ğ¸ ...
2025-05-30 16:45:14,744 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: aabee661-f032-4161-8a2d-52c10befed51)
2025-05-30 16:45:14,744 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: aabee661-f032-4161-8a2d-52c10befed51.
2025-05-30 16:45:14,746 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Ğ¢Ğ²Ğ¾Ğ¹ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² â€” 574 Ğ±Ğ±. Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ´ÑĞºĞ°Ğ·Ğ°Ñ‚ÑŒ, ĞºĞ°Ğº Ğ¸Ñ… Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ğ»Ğ¸ ...
2025-05-30 16:45:14,746 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Ğ¢Ğ²Ğ¾Ğ¹ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² â€” 574 Ğ±Ğ±. Ğ•ÑĞ»Ğ¸...'
2025-05-30 16:45:14,747 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'aabee661-f032-4161-8a2d-52c10befed51', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1060, 'completion_tokens': 16, 'total_tokens': 1076, 'timestamp': '2025-05-30T11:45:12.872133+00:00'}
2025-05-30 16:45:14,747 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: aabee661-f032-4161-8a2d-52c10befed51
2025-05-30 16:45:14,751 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: aabee661-f032-4161-8a2d-52c10befed51, db_id: 1000
2025-05-30 16:45:14,781 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1000 for interaction_id: aabee661-f032-4161-8a2d-52c10befed51 on attempt 1
2025-05-30 16:45:14,788 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: aabee661-f032-4161-8a2d-52c10befed51, db_id: 469
2025-05-30 16:45:14,791 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'aabee661-f032-4161-8a2d-52c10befed51', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1095, 'completion_tokens': 33, 'total_tokens': 1128, 'timestamp': '2025-05-30T11:45:14.740566+00:00'}
2025-05-30 16:45:14,791 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: aabee661-f032-4161-8a2d-52c10befed51
2025-05-30 16:45:14,793 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1000 for interaction_id: aabee661-f032-4161-8a2d-52c10befed51 on attempt 1
2025-05-30 16:45:14,797 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: aabee661-f032-4161-8a2d-52c10befed51, db_id: 470
2025-05-30 16:46:38,310 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 16:46:38,310 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 16:46:38,310 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 16:46:38,310 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4405560144) was cancelled.
2025-05-30 16:46:38,311 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4405560144) stopping. Performing cleanup...
2025-05-30 16:46:38,311 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:46:38,315 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 16:46:38,316 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 16:46:38,316 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:46:38,316 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 16:46:38,316 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:46:38,316 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4405560144) cleanup complete.
2025-05-30 16:46:38,316 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 16:46:38,316 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 16:46:38,316 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4405559952) was cancelled.
2025-05-30 16:46:38,317 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4405559952) stopping. Performing cleanup...
2025-05-30 16:46:38,317 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:46:38,320 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 16:46:38,320 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 16:46:38,320 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:46:38,321 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 16:46:38,321 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:46:38,321 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4405559952) cleanup complete.
2025-05-30 16:46:38,321 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 16:46:38,321 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 16:46:38,321 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4405560096) was cancelled.
2025-05-30 16:46:38,321 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4405560096) stopping. Performing cleanup...
2025-05-30 16:46:38,321 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 16:46:38,321 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:46:38,321 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:46:38,321 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 16:46:38,321 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:46:38,323 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 16:46:38,324 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 16:46:38,324 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:46:38,324 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 16:46:38,324 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:46:38,324 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 16:46:38,324 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4405560096) cleanup complete.
2025-05-30 16:46:38,324 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 16:46:38,324 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 16:46:38,324 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 16:46:38,329 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:46:38,329 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 16:46:38,745 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:46:38,745 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:46:38,750 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:46:38,750 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:46:38,750 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:46:38,750 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:46:38,750 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:46:38,750 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:46:38,750 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:46:38,750 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:46:38,750 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:46:38,750 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:46:38,751 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:46:38,753 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:46:38,768 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:46:38,768 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:46:38,768 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:46:38,768 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:46:38,768 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:46:38,768 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:46:38,771 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:46:38,771 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4440686560) setup complete. Starting run loop.
2025-05-30 16:46:38,771 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:46:38,771 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:46:38,772 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:46:38,772 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4440785024) setup complete. Starting run loop.
2025-05-30 16:46:38,772 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:46:38,773 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:46:38,773 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:46:38,800 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:46:38,800 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:46:38,801 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:46:38,801 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:46:38,802 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:46:38,803 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:46:38,803 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:46:38,803 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:46:38,803 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:46:38,803 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:46:48,774 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 16:46:48,778 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 16:46:48,778 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4440785120) setup complete. Starting run loop.
2025-05-30 16:46:48,778 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 16:47:01,239 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 16:47:01,239 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 16:47:01,239 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4499404032) received shutdown request. Initiating graceful shutdown...
2025-05-30 16:47:01,239 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4499404032)...
2025-05-30 16:47:01,239 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 16:47:01,239 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 16:47:01,240 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4499404032) was cancelled.
2025-05-30 16:47:01,240 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4499404032) stopping. Performing cleanup...
2025-05-30 16:47:01,240 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 16:47:01,240 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 16:47:01,240 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 16:47:01,241 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-30 16:47:01,241 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 16:47:01,241 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 16:47:01,241 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 16:47:01,241 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:47:01,242 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 16:47:01,242 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 16:47:01,242 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 16:47:01,245 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 16:47:01,246 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 16:47:01,246 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:47:01,246 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 16:47:01,246 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 16:47:01,246 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 16:47:01,246 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4499404032) cleanup complete.
2025-05-30 16:47:01,246 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 16:47:01,246 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 16:47:01,249 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:47:01,249 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 16:47:01,249 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 16:47:01,250 - INFO - __main__ - Agent runner main finished.
2025-05-30 16:47:01,350 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 16:47:01,350 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 16:47:01,350 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 16:47:01,350 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4440686560) was cancelled.
2025-05-30 16:47:01,350 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4440686560) stopping. Performing cleanup...
2025-05-30 16:47:01,350 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:47:01,354 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 16:47:01,355 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 16:47:01,355 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:47:01,355 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 16:47:01,355 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:47:01,355 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4440686560) cleanup complete.
2025-05-30 16:47:01,355 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 16:47:01,355 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 16:47:01,355 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4440785024) was cancelled.
2025-05-30 16:47:01,355 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4440785024) stopping. Performing cleanup...
2025-05-30 16:47:01,355 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:47:01,358 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 16:47:01,359 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 16:47:01,359 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:47:01,359 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 16:47:01,359 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:47:01,359 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4440785024) cleanup complete.
2025-05-30 16:47:01,359 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 16:47:01,359 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 16:47:01,359 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4440785120) was cancelled.
2025-05-30 16:47:01,359 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4440785120) stopping. Performing cleanup...
2025-05-30 16:47:01,359 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 16:47:01,359 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:47:01,359 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:47:01,359 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 16:47:01,359 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:47:01,361 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 16:47:01,362 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 16:47:01,362 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:47:01,362 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 16:47:01,362 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:47:01,362 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 16:47:01,362 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4440785120) cleanup complete.
2025-05-30 16:47:01,362 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 16:47:01,362 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 16:47:01,362 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 16:47:01,365 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:47:01,365 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 16:47:01,491 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 16:47:01,491 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 16:47:01,491 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 16:47:01,491 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4389349536) received shutdown request. Initiating graceful shutdown...
2025-05-30 16:47:01,491 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4389349536)...
2025-05-30 16:47:01,491 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 16:47:01,491 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 16:47:01,491 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4389349536) was cancelled.
2025-05-30 16:47:01,491 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4389349536) stopping. Performing cleanup...
2025-05-30 16:47:01,491 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 16:47:01,491 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 16:47:01,491 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 16:47:01,491 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 16:47:01,491 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 16:47:01,491 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 16:47:01,491 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:47:01,492 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 16:47:01,492 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 16:47:01,492 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 16:47:01,496 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 16:47:01,497 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 16:47:01,497 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:47:01,497 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 16:47:01,497 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 16:47:01,497 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 16:47:01,497 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4389349536) cleanup complete.
2025-05-30 16:47:01,497 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 16:47:01,497 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 16:47:01,499 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:47:01,499 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 16:47:01,499 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 16:47:01,500 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 16:47:05,359 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:47:05,359 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:47:05,363 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:47:05,363 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:47:05,363 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:47:05,363 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:47:05,363 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:47:05,364 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:47:05,364 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:47:05,364 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:47:05,364 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:47:05,364 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:47:05,364 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:47:05,366 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:47:05,366 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:47:05,366 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:47:05,366 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:47:05,366 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:47:05,380 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:47:05,380 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:47:05,382 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:47:05,382 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4442817504) setup complete. Starting run loop.
2025-05-30 16:47:05,382 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:47:05,383 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:47:05,385 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:47:05,385 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4442831136) setup complete. Starting run loop.
2025-05-30 16:47:05,385 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:47:05,396 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:47:05,396 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:47:05,414 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:47:05,414 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:47:05,416 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 16:47:05,417 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 82558
2025-05-30 16:47:05,417 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 82558
2025-05-30 16:47:05,418 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 16:47:05,418 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:47:05,418 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:47:05,419 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 16:47:05,420 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 82559
2025-05-30 16:47:05,420 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 82559
2025-05-30 16:47:05,420 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 16:47:05,421 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:47:05,421 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:47:05,421 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:47:05,421 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:47:06,268 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:47:06,268 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 16:47:06,268 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 16:47:06,268 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 16:47:06,268 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 82559
2025-05-30 16:47:06,268 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 16:47:06,268 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 16:47:06,268 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 16:47:06,274 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 16:47:06,287 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 16:47:06,287 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 16:47:06,287 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 16:47:06,287 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4611092032) setup complete. Starting run loop.
2025-05-30 16:47:06,287 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 16:47:06,287 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 16:47:06,287 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 16:47:06,287 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 16:47:06,287 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:47:06,288 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 16:47:06,288 - INFO - aiogram.dispatcher - Start polling
2025-05-30 16:47:06,290 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:47:06,528 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 16:47:06,620 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:47:06,621 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 16:47:06,621 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 16:47:06,621 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 16:47:06,621 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 82558
2025-05-30 16:47:06,621 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 16:47:06,621 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 16:47:06,621 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 16:47:06,663 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 16:47:06,663 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 16:47:06,705 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 16:47:06,706 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 16:47:06,706 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 16:47:06,706 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 16:47:06,706 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 16:47:06,706 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:47:06,731 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 16:47:06,731 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 16:47:06,731 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 16:47:06,732 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 16:47:06,733 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET)
2025-05-30 16:47:06,733 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 16:47:06,733 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 16:47:06,788 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 16:47:06,792 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 16:47:07,400 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 16:47:07,405 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 16:47:07,405 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 16:47:07,405 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 16:47:07,405 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 16:47:07,405 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 16:47:07,405 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 16:47:07,405 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 16:47:07,405 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 16:47:07,406 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 16:47:07,406 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 16:47:07,407 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 16:47:07,407 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 16:47:07,407 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 16:47:07,407 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 16:47:07,407 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 16:47:07,418 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 16:47:07,418 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 16:47:07,418 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 16:47:07,418 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4639782432) setup complete. Starting run loop.
2025-05-30 16:47:07,418 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 16:47:07,418 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 16:47:07,418 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 16:47:07,418 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:47:07,421 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:47:15,398 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 16:47:15,403 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 16:47:15,403 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4442831184) setup complete. Starting run loop.
2025-05-30 16:47:15,403 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 16:47:30,544 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñƒ Ğ¼ĞµĞ½Ñ Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ?...'
2025-05-30 16:47:30,545 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 16:47:30,615 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 16:47:30,615 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 16:47:30,615 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:47:30,615 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: fff05602-6bec-471f-9f8d-e1a215c9b1f7)
2025-05-30 16:47:30,615 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 16:47:30,616 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-30 16:47:30,636 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: fff05602-6bec-471f-9f8d-e1a215c9b1f7, db_id: 1001
2025-05-30 16:47:30,651 - INFO - AGENT:agent_airsoft_0faa9616 - Loaded 20 messages from DB for thread '144641834'.
2025-05-30 16:47:30,651 - INFO - AGENT:agent_airsoft_0faa9616 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-30 16:47:30,651 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-30 16:47:30,720 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:47:30,720 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:47:30,745 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:47:30,748 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:47:31,615 - INFO - aiogram.event - Update id=804756344 is handled. Duration 1072 ms by bot id=1750613938
2025-05-30 16:47:31,877 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:47:31,883 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 16:47:31,883 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 16:47:31,883 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1043, 'output_tokens': 16, 'total_tokens': 1059, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:47:31,883 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1043 C:16 T:1059
2025-05-30 16:47:31,883 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1059 tokens recorded.
2025-05-30 16:47:31,884 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:47:31,884 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748589354598
2025-05-30 16:47:31,884 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748589354598)---
2025-05-30 16:47:31,886 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹'
2025-05-30 16:47:31,886 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:47:31,886 - INFO - app.agent_runner.common.tools_registry - Attempting Cloudflare bypass with cloudscraper for https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:47:32,404 - INFO - app.agent_runner.common.tools_registry - API Response Content Preview (first 1000 chars): ï¿½574
2025-05-30 16:47:32,404 - WARNING - app.agent_runner.common.tools_registry - Failed to parse JSON response: Expecting value: line 1 column 1 (char 0)
2025-05-30 16:47:32,405 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:47:32,406 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:47:32,430 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:47:32,432 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:47:33,230 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:47:33,719 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ£ Ñ‚ĞµĞ±Ñ Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ 574 Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°! Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ Ñ Ğ¸Ğ´ĞµÑĞ¼Ğ¸, ĞºĞ°Ğº Ğ¸Ñ… Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°
2025-05-30 16:47:33,719 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_38647f5e19'}
2025-05-30 16:47:33,719 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1078, 'output_tokens': 32, 'total_tokens': 1110, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:47:33,719 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1078 C:32 T:1110
2025-05-30 16:47:33,719 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1110 tokens recorded.
2025-05-30 16:47:33,720 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:47:33,720 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 16:47:33,721 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ£ Ñ‚ĞµĞ±Ñ Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ 574 Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°! Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ Ñ Ğ¸Ğ´ĞµÑĞ¼Ğ¸, ĞºĞ°Ğº Ğ¸Ñ… Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°...
2025-05-30 16:47:33,722 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: fff05602-6bec-471f-9f8d-e1a215c9b1f7)
2025-05-30 16:47:33,722 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: fff05602-6bec-471f-9f8d-e1a215c9b1f7.
2025-05-30 16:47:33,725 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Ğ£ Ñ‚ĞµĞ±Ñ Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ 574 Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°! Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ Ñ Ğ¸Ğ´ĞµÑĞ¼Ğ¸, ĞºĞ°Ğº Ğ¸Ñ… Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°...
2025-05-30 16:47:33,725 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Ğ£ Ñ‚ĞµĞ±Ñ Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ 574 Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°! Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ğ¼...'
2025-05-30 16:47:33,727 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'fff05602-6bec-471f-9f8d-e1a215c9b1f7', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1043, 'completion_tokens': 16, 'total_tokens': 1059, 'timestamp': '2025-05-30T11:47:31.883419+00:00'}
2025-05-30 16:47:33,727 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: fff05602-6bec-471f-9f8d-e1a215c9b1f7
2025-05-30 16:47:33,731 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: fff05602-6bec-471f-9f8d-e1a215c9b1f7, db_id: 1002
2025-05-30 16:47:33,760 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1002 for interaction_id: fff05602-6bec-471f-9f8d-e1a215c9b1f7 on attempt 1
2025-05-30 16:47:33,766 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: fff05602-6bec-471f-9f8d-e1a215c9b1f7, db_id: 471
2025-05-30 16:47:33,769 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'fff05602-6bec-471f-9f8d-e1a215c9b1f7', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1078, 'completion_tokens': 32, 'total_tokens': 1110, 'timestamp': '2025-05-30T11:47:33.719719+00:00'}
2025-05-30 16:47:33,769 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: fff05602-6bec-471f-9f8d-e1a215c9b1f7
2025-05-30 16:47:33,770 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1002 for interaction_id: fff05602-6bec-471f-9f8d-e1a215c9b1f7 on attempt 1
2025-05-30 16:47:33,773 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: fff05602-6bec-471f-9f8d-e1a215c9b1f7, db_id: 472
2025-05-30 16:48:13,547 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 16:48:13,548 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 16:48:13,548 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 16:48:13,548 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4442817504) was cancelled.
2025-05-30 16:48:13,548 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4442817504) stopping. Performing cleanup...
2025-05-30 16:48:13,548 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:48:13,554 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 16:48:13,555 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 16:48:13,555 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:48:13,555 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 16:48:13,555 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:48:13,555 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4442817504) cleanup complete.
2025-05-30 16:48:13,555 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 16:48:13,555 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 16:48:13,555 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4442831136) was cancelled.
2025-05-30 16:48:13,555 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4442831136) stopping. Performing cleanup...
2025-05-30 16:48:13,555 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:48:13,558 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 16:48:13,559 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 16:48:13,559 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:48:13,564 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 16:48:13,565 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:48:13,565 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4442831136) cleanup complete.
2025-05-30 16:48:13,566 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 16:48:13,566 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 16:48:13,567 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4442831184) was cancelled.
2025-05-30 16:48:13,568 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4442831184) stopping. Performing cleanup...
2025-05-30 16:48:13,568 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 16:48:13,568 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:48:13,570 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:48:13,570 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 16:48:13,571 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:48:13,576 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 16:48:13,577 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 16:48:13,577 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:48:13,577 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 16:48:13,577 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:48:13,577 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 16:48:13,577 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4442831184) cleanup complete.
2025-05-30 16:48:13,578 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 16:48:13,578 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 16:48:13,578 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 16:48:13,585 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:48:13,585 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 16:48:14,039 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:48:14,039 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:48:14,042 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:48:14,042 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:48:14,042 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:48:14,042 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:48:14,042 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:48:14,042 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:48:14,042 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:48:14,042 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:48:14,042 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:48:14,043 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:48:14,043 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:48:14,044 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:48:14,058 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:48:14,058 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:48:14,059 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:48:14,059 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:48:14,059 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:48:14,059 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:48:14,060 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:48:14,060 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4361707808) setup complete. Starting run loop.
2025-05-30 16:48:14,060 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:48:14,061 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:48:14,061 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:48:14,061 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4368651456) setup complete. Starting run loop.
2025-05-30 16:48:14,061 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:48:14,072 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:48:14,072 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:48:14,087 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:48:14,088 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:48:14,089 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:48:14,089 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:48:14,089 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:48:14,089 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:48:14,090 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:48:14,090 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:48:14,090 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:48:14,090 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:48:24,073 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 16:48:24,079 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 16:48:24,079 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4369300224) setup complete. Starting run loop.
2025-05-30 16:48:24,079 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 16:48:48,426 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-30 16:48:48,434 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-30 16:48:48,435 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-30 16:48:48,435 - INFO - app.db.crud.agent_crud - Updating agent config in DB for agent_id: agent_airsoft_0faa9616
2025-05-30 16:48:48,447 - INFO - app.db.crud.agent_crud - Agent config updated successfully for agent_id: agent_airsoft_0faa9616
2025-05-30 16:48:48,447 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616 was running. Attempting to restart it after config update.
2025-05-30 16:48:48,447 - INFO - app.services.process_manager - Restarting agent process for agent_airsoft_0faa9616...
2025-05-30 16:48:48,449 - INFO - app.services.process_manager - Stopping agent process agent_airsoft_0faa9616 (PID: 82558). Force: True
2025-05-30 16:48:48,449 - INFO - app.services.process_manager - SIGTERM sent to agent agent_airsoft_0faa9616 (PID: 82558)
2025-05-30 16:48:48,549 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 (PID: 82558) terminated gracefully after SIGTERM.
2025-05-30 16:48:48,551 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 marked as stopped in Redis.
2025-05-30 16:48:48,551 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 stopped (or stop attempted and assumed successful for restart). Pausing briefly...
2025-05-30 16:48:53,551 - INFO - app.services.process_manager - Proceeding to start agent agent_airsoft_0faa9616 after delay...
2025-05-30 16:48:53,554 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 16:48:53,555 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 82632
2025-05-30 16:48:53,555 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 82632
2025-05-30 16:48:53,556 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 successfully started as part of restart sequence.
2025-05-30 16:48:53,556 - INFO - app.api.routers.agent_api - Restart command issued for agent agent_airsoft_0faa9616 after config update.
2025-05-30 16:48:53,556 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:48:53,557 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:48:54,857 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:48:54,858 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 16:48:54,858 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 16:48:54,858 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 16:48:54,858 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 82632
2025-05-30 16:48:54,858 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 16:48:54,858 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 16:48:54,858 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 16:48:54,903 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 16:48:54,903 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 16:48:54,935 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 16:48:54,935 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 16:48:54,935 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 16:48:54,935 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 16:48:54,935 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 16:48:54,935 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:48:54,962 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 16:48:54,962 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 16:48:54,962 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 16:48:54,963 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 16:48:54,964 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET)
2025-05-30 16:48:54,964 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 16:48:54,964 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 16:48:55,016 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 16:48:55,019 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 16:48:55,667 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 16:48:55,670 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 16:48:55,670 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 16:48:55,670 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 16:48:55,670 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 16:48:55,670 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 16:48:55,670 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 16:48:55,670 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 16:48:55,670 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 16:48:55,671 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 16:48:55,671 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 16:48:55,671 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 16:48:55,671 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 16:48:55,671 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 16:48:55,671 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 16:48:55,671 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 16:48:55,681 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 16:48:55,681 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 16:48:55,681 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 16:48:55,681 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4540543776) setup complete. Starting run loop.
2025-05-30 16:48:55,681 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 16:48:55,681 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 16:48:55,681 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 16:48:55,681 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:48:55,685 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:49:30,980 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ ĞµÑ‰Ğµ Ñ€Ğ°Ğ·, ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñƒ Ğ¼ĞµĞ½Ñ Ğ±Ğ± Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ?...'
2025-05-30 16:49:30,981 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 16:49:30,985 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 16:49:30,985 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:49:30,985 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 16:49:30,986 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 0de2db75-1a8a-4f00-a20c-d172ad6ce480)
2025-05-30 16:49:30,986 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 16:49:30,986 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 16:49:30,987 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 16:49:31,032 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 0de2db75-1a8a-4f00-a20c-d172ad6ce480, db_id: 1003
2025-05-30 16:49:31,067 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:49:31,068 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:49:31,093 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:49:31,097 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:49:31,878 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:49:31,911 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 16:49:31,911 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 16:49:31,911 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 370, 'output_tokens': 16, 'total_tokens': 386, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:49:31,911 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:370 C:16 T:386
2025-05-30 16:49:31,911 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 386 tokens recorded.
2025-05-30 16:49:31,912 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:49:31,912 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748589354598
2025-05-30 16:49:31,912 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748589354598)---
2025-05-30 16:49:31,913 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹'
2025-05-30 16:49:31,913 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:49:31,913 - INFO - app.agent_runner.common.tools_registry - Attempting Cloudflare bypass with cloudscraper for https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:49:31,985 - INFO - aiogram.event - Update id=804756345 is handled. Duration 1005 ms by bot id=1750613938
2025-05-30 16:49:32,387 - ERROR - app.agent_runner.common.tools_registry - Unexpected error in API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹': object of type 'int' has no len()
Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/agent_runner/common/tools_registry.py", line 353, in make_api_request
    effective_logger.debug(f"Successfully parsed JSON response with {len(json_response)} top-level items")
                                                                     ^^^^^^^^^^^^^^^^^^
TypeError: object of type 'int' has no len()
2025-05-30 16:49:32,391 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:49:32,391 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:49:32,414 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:49:32,417 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:49:33,056 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:49:33,567 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğµ, Ğ²Ğ¾Ğ·Ğ½Ğ¸ĞºĞ»Ğ° Ğ½ĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ°Ñ Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞµ ÑƒĞ·Ğ½Ğ°Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ². Ğ”Ğ°Ğ²Ğ°Ğ¹ Ğ¿Ğ¾Ğ¿Ñ€Ğ¾
2025-05-30 16:49:33,568 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 16:49:33,568 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 428, 'output_tokens': 44, 'total_tokens': 472, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:49:33,568 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:428 C:44 T:472
2025-05-30 16:49:33,568 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 472 tokens recorded.
2025-05-30 16:49:33,569 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:49:33,569 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 16:49:33,569 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğµ, Ğ²Ğ¾Ğ·Ğ½Ğ¸ĞºĞ»Ğ° Ğ½ĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ°Ñ Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞµ ÑƒĞ·Ğ½Ğ°Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ². Ğ”Ğ°Ğ²Ğ°Ğ¹ Ğ¿Ğ¾Ğ¿Ñ€Ğ¾...
2025-05-30 16:49:33,571 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 0de2db75-1a8a-4f00-a20c-d172ad6ce480)
2025-05-30 16:49:33,571 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: 0de2db75-1a8a-4f00-a20c-d172ad6ce480.
2025-05-30 16:49:33,573 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğµ, Ğ²Ğ¾Ğ·Ğ½Ğ¸ĞºĞ»Ğ° Ğ½ĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ°Ñ Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞµ ÑƒĞ·Ğ½Ğ°Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ². Ğ”Ğ°Ğ²Ğ°Ğ¹ Ğ¿Ğ¾Ğ¿Ñ€Ğ¾...
2025-05-30 16:49:33,573 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğµ, Ğ²Ğ¾Ğ·Ğ½Ğ¸ĞºĞ»Ğ° Ğ½ĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ°Ñ Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ...'
2025-05-30 16:49:33,574 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '0de2db75-1a8a-4f00-a20c-d172ad6ce480', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 370, 'completion_tokens': 16, 'total_tokens': 386, 'timestamp': '2025-05-30T11:49:31.911333+00:00'}
2025-05-30 16:49:33,574 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 0de2db75-1a8a-4f00-a20c-d172ad6ce480
2025-05-30 16:49:33,578 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 0de2db75-1a8a-4f00-a20c-d172ad6ce480, db_id: 1004
2025-05-30 16:49:33,608 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1004 for interaction_id: 0de2db75-1a8a-4f00-a20c-d172ad6ce480 on attempt 1
2025-05-30 16:49:33,613 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 0de2db75-1a8a-4f00-a20c-d172ad6ce480, db_id: 473
2025-05-30 16:49:33,615 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '0de2db75-1a8a-4f00-a20c-d172ad6ce480', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 428, 'completion_tokens': 44, 'total_tokens': 472, 'timestamp': '2025-05-30T11:49:33.568147+00:00'}
2025-05-30 16:49:33,615 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 0de2db75-1a8a-4f00-a20c-d172ad6ce480
2025-05-30 16:49:33,616 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1004 for interaction_id: 0de2db75-1a8a-4f00-a20c-d172ad6ce480 on attempt 1
2025-05-30 16:49:33,619 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 0de2db75-1a8a-4f00-a20c-d172ad6ce480, db_id: 474
2025-05-30 16:51:30,701 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 16:51:30,701 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 16:51:30,701 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 16:51:30,701 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4361707808) was cancelled.
2025-05-30 16:51:30,701 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4361707808) stopping. Performing cleanup...
2025-05-30 16:51:30,701 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:51:30,706 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 16:51:30,707 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 16:51:30,707 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:51:30,708 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 16:51:30,708 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:51:30,708 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4361707808) cleanup complete.
2025-05-30 16:51:30,708 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 16:51:30,708 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 16:51:30,708 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4368651456) was cancelled.
2025-05-30 16:51:30,708 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4368651456) stopping. Performing cleanup...
2025-05-30 16:51:30,708 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:51:30,711 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 16:51:30,711 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 16:51:30,712 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:51:30,712 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 16:51:30,712 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:51:30,712 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4368651456) cleanup complete.
2025-05-30 16:51:30,712 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 16:51:30,712 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 16:51:30,712 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4369300224) was cancelled.
2025-05-30 16:51:30,712 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4369300224) stopping. Performing cleanup...
2025-05-30 16:51:30,712 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 16:51:30,712 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:51:30,712 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:51:30,712 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 16:51:30,712 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:51:30,715 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 16:51:30,716 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 16:51:30,716 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:51:30,716 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 16:51:30,716 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:51:30,716 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 16:51:30,716 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4369300224) cleanup complete.
2025-05-30 16:51:30,716 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 16:51:30,716 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 16:51:30,716 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 16:51:30,727 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:51:30,728 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 16:51:31,189 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:51:31,189 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:51:31,194 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:51:31,194 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:51:31,194 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:51:31,194 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:51:31,194 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:51:31,194 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:51:31,194 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:51:31,194 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:51:31,194 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:51:31,195 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:51:31,195 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:51:31,197 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:51:31,211 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:51:31,211 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:51:31,211 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:51:31,211 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:51:31,211 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:51:31,211 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:51:31,214 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:51:31,214 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4405601744) setup complete. Starting run loop.
2025-05-30 16:51:31,214 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:51:31,214 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:51:31,214 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:51:31,214 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4405412400) setup complete. Starting run loop.
2025-05-30 16:51:31,214 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:51:31,216 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:51:31,216 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:51:31,245 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:51:31,245 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:51:31,246 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:51:31,246 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:51:31,246 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:51:31,247 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:51:31,247 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:51:31,248 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:51:31,248 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:51:31,248 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:51:34,895 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 16:51:34,896 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4540543776) received shutdown request. Initiating graceful shutdown...
2025-05-30 16:51:34,896 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4540543776)...
2025-05-30 16:51:34,896 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 16:51:34,896 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 16:51:34,896 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4540543776) was cancelled.
2025-05-30 16:51:34,896 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4540543776) stopping. Performing cleanup...
2025-05-30 16:51:34,896 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 16:51:34,896 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 16:51:34,897 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 16:51:34,897 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 16:51:34,897 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-30 16:51:34,897 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 16:51:34,897 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 16:51:34,897 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 16:51:34,897 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:51:34,898 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 16:51:34,898 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 16:51:34,898 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 16:51:34,902 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 16:51:34,903 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 16:51:34,903 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:51:34,903 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 16:51:34,903 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 16:51:34,903 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 16:51:34,903 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4540543776) cleanup complete.
2025-05-30 16:51:34,903 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 16:51:34,903 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 16:51:34,904 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:51:34,904 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 16:51:34,904 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 16:51:34,905 - INFO - __main__ - Agent runner main finished.
2025-05-30 16:51:35,068 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 16:51:35,068 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 16:51:35,068 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 16:51:35,068 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4405601744) was cancelled.
2025-05-30 16:51:35,068 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4405601744) stopping. Performing cleanup...
2025-05-30 16:51:35,068 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:51:35,073 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 16:51:35,074 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 16:51:35,074 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:51:35,074 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 16:51:35,074 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:51:35,074 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4405601744) cleanup complete.
2025-05-30 16:51:35,074 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 16:51:35,074 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 16:51:35,074 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4405412400) was cancelled.
2025-05-30 16:51:35,074 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4405412400) stopping. Performing cleanup...
2025-05-30 16:51:35,074 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:51:35,077 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 16:51:35,078 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 16:51:35,078 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:51:35,078 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 16:51:35,078 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:51:35,078 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4405412400) cleanup complete.
2025-05-30 16:51:35,078 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 16:51:35,078 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 16:51:35,078 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4405412208) was cancelled.
2025-05-30 16:51:35,078 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4405412208) stopping. Performing cleanup...
2025-05-30 16:51:35,078 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 16:51:35,078 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:51:35,078 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:51:35,078 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 16:51:35,078 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:51:35,081 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 16:51:35,082 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 16:51:35,082 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:51:35,082 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 16:51:35,082 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:51:35,082 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 16:51:35,082 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4405412208) cleanup complete.
2025-05-30 16:51:35,082 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 16:51:35,082 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 16:51:35,082 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 16:51:35,085 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:51:35,085 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 16:51:35,148 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 16:51:35,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 16:51:35,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 16:51:35,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4611092032) received shutdown request. Initiating graceful shutdown...
2025-05-30 16:51:35,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4611092032)...
2025-05-30 16:51:35,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 16:51:35,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 16:51:35,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4611092032) was cancelled.
2025-05-30 16:51:35,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4611092032) stopping. Performing cleanup...
2025-05-30 16:51:35,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 16:51:35,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 16:51:35,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 16:51:35,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 16:51:35,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 16:51:35,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 16:51:35,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:51:35,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 16:51:35,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 16:51:35,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 16:51:35,153 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 16:51:35,154 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 16:51:35,154 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:51:35,154 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 16:51:35,154 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 16:51:35,154 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 16:51:35,154 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4611092032) cleanup complete.
2025-05-30 16:51:35,154 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 16:51:35,154 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 16:51:35,159 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:51:35,159 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 16:51:35,159 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 16:51:35,160 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 16:51:37,846 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:51:37,847 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:51:37,851 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:51:37,851 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:51:37,851 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:51:37,851 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:51:37,851 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:51:37,851 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:51:37,851 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:51:37,851 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:51:37,852 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:51:37,852 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:51:37,852 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:51:37,855 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:51:37,855 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:51:37,855 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:51:37,855 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:51:37,855 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:51:37,855 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:51:37,855 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:51:37,869 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:51:37,870 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:51:37,870 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4403781920) setup complete. Starting run loop.
2025-05-30 16:51:37,870 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:51:37,870 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4405229712) setup complete. Starting run loop.
2025-05-30 16:51:37,870 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:51:37,870 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:51:37,871 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:51:37,871 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:51:37,900 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:51:37,900 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:51:37,902 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 16:51:37,903 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 82829
2025-05-30 16:51:37,903 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 82829
2025-05-30 16:51:37,903 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 16:51:37,903 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:51:37,903 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:51:37,905 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 16:51:37,905 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 82830
2025-05-30 16:51:37,905 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 82830
2025-05-30 16:51:37,906 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 16:51:37,906 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:51:37,907 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:51:37,907 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:51:37,907 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:51:38,785 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:51:38,786 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 16:51:38,786 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 16:51:38,786 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 16:51:38,786 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 82830
2025-05-30 16:51:38,786 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 16:51:38,786 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 16:51:38,786 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 16:51:38,791 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 16:51:38,804 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 16:51:38,805 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 16:51:38,805 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 16:51:38,805 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4620937616) setup complete. Starting run loop.
2025-05-30 16:51:38,805 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 16:51:38,805 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 16:51:38,805 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 16:51:38,805 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 16:51:38,805 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:51:38,805 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 16:51:38,805 - INFO - aiogram.dispatcher - Start polling
2025-05-30 16:51:38,808 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:51:39,058 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 16:51:39,144 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:51:39,145 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 16:51:39,145 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 16:51:39,145 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 16:51:39,145 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 82829
2025-05-30 16:51:39,145 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 16:51:39,145 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 16:51:39,145 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 16:51:39,194 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 16:51:39,194 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 16:51:39,242 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 16:51:39,242 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 16:51:39,242 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 16:51:39,242 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 16:51:39,242 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 16:51:39,242 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:51:39,268 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 16:51:39,268 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 16:51:39,268 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 16:51:39,269 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 16:51:39,270 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET)
2025-05-30 16:51:39,270 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 16:51:39,270 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 16:51:39,325 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 16:51:39,329 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 16:51:40,003 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 16:51:40,006 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 16:51:40,006 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 16:51:40,006 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 16:51:40,006 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 16:51:40,006 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 16:51:40,006 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 16:51:40,006 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 16:51:40,006 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 16:51:40,007 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 16:51:40,007 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 16:51:40,007 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 16:51:40,007 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 16:51:40,007 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 16:51:40,007 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 16:51:40,007 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 16:51:40,018 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 16:51:40,018 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 16:51:40,018 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 16:51:40,018 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4657214192) setup complete. Starting run loop.
2025-05-30 16:51:40,018 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 16:51:40,018 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 16:51:40,018 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 16:51:40,018 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:51:40,021 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:51:47,872 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 16:51:47,877 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 16:51:47,877 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4405230096) setup complete. Starting run loop.
2025-05-30 16:51:47,877 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 16:51:54,784 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ¼Ğ¾Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ...'
2025-05-30 16:51:54,785 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache miss for user 144641834, agent agent_airsoft_0faa9616. Checking DB.
2025-05-30 16:51:54,853 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - User 144641834 (DBID: 1) IS authorized for agent agent_airsoft_0faa9616 via DB.
2025-05-30 16:51:54,857 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 16:51:54,857 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:51:54,857 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 16:51:54,858 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 0c91858e-8268-4c65-bf0b-073489c5bbb8)
2025-05-30 16:51:54,858 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 16:51:54,859 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-30 16:51:54,881 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 0c91858e-8268-4c65-bf0b-073489c5bbb8, db_id: 1005
2025-05-30 16:51:54,896 - INFO - AGENT:agent_airsoft_0faa9616 - Loaded 20 messages from DB for thread '144641834'.
2025-05-30 16:51:54,896 - INFO - AGENT:agent_airsoft_0faa9616 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-30 16:51:54,897 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-30 16:51:54,946 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:51:54,947 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:51:54,972 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:51:54,975 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:51:55,858 - INFO - aiogram.event - Update id=804756346 is handled. Duration 1074 ms by bot id=1750613938
2025-05-30 16:51:56,481 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:51:56,487 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 16:51:56,487 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 16:51:56,487 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1006, 'output_tokens': 16, 'total_tokens': 1022, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:51:56,487 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1006 C:16 T:1022
2025-05-30 16:51:56,487 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1022 tokens recorded.
2025-05-30 16:51:56,488 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:51:56,488 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748589354598
2025-05-30 16:51:56,488 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748589354598)---
2025-05-30 16:51:56,490 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹'
2025-05-30 16:51:56,490 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:51:56,490 - INFO - app.agent_runner.common.tools_registry - Attempting Cloudflare bypass with cloudscraper for https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:51:56,995 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:51:56,995 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:51:57,020 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:51:57,023 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:51:57,911 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:51:58,404 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ¢Ğ²Ğ¾Ğ¹ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² â€” 574 Ğ±Ğ±. Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ´ÑĞºĞ°Ğ·Ğ°Ñ‚ÑŒ, ĞºĞ°Ğº Ğ¸Ñ… Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ Ğ¼Ğ°
2025-05-30 16:51:58,404 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 16:51:58,404 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1037, 'output_tokens': 34, 'total_tokens': 1071, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:51:58,404 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1037 C:34 T:1071
2025-05-30 16:51:58,404 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1071 tokens recorded.
2025-05-30 16:51:58,405 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:51:58,405 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 16:51:58,406 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ¢Ğ²Ğ¾Ğ¹ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² â€” 574 Ğ±Ğ±. Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ´ÑĞºĞ°Ğ·Ğ°Ñ‚ÑŒ, ĞºĞ°Ğº Ğ¸Ñ… Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ Ğ¼Ğ°...
2025-05-30 16:51:58,408 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 0c91858e-8268-4c65-bf0b-073489c5bbb8)
2025-05-30 16:51:58,408 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: 0c91858e-8268-4c65-bf0b-073489c5bbb8.
2025-05-30 16:51:58,410 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Ğ¢Ğ²Ğ¾Ğ¹ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² â€” 574 Ğ±Ğ±. Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ´ÑĞºĞ°Ğ·Ğ°Ñ‚ÑŒ, ĞºĞ°Ğº Ğ¸Ñ… Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ Ğ¼Ğ°...
2025-05-30 16:51:58,410 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Ğ¢Ğ²Ğ¾Ğ¹ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² â€” 574 Ğ±Ğ±. Ğ•ÑĞ»Ğ¸...'
2025-05-30 16:51:58,411 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '0c91858e-8268-4c65-bf0b-073489c5bbb8', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1006, 'completion_tokens': 16, 'total_tokens': 1022, 'timestamp': '2025-05-30T11:51:56.487322+00:00'}
2025-05-30 16:51:58,411 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 0c91858e-8268-4c65-bf0b-073489c5bbb8
2025-05-30 16:51:58,416 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 0c91858e-8268-4c65-bf0b-073489c5bbb8, db_id: 1006
2025-05-30 16:51:58,445 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1006 for interaction_id: 0c91858e-8268-4c65-bf0b-073489c5bbb8 on attempt 1
2025-05-30 16:51:58,451 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 0c91858e-8268-4c65-bf0b-073489c5bbb8, db_id: 475
2025-05-30 16:51:58,454 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '0c91858e-8268-4c65-bf0b-073489c5bbb8', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1037, 'completion_tokens': 34, 'total_tokens': 1071, 'timestamp': '2025-05-30T11:51:58.404863+00:00'}
2025-05-30 16:51:58,454 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 0c91858e-8268-4c65-bf0b-073489c5bbb8
2025-05-30 16:51:58,455 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1006 for interaction_id: 0c91858e-8268-4c65-bf0b-073489c5bbb8 on attempt 1
2025-05-30 16:51:58,458 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 0c91858e-8268-4c65-bf0b-073489c5bbb8, db_id: 476
2025-05-30 16:53:12,592 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 16:53:12,593 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 16:53:12,593 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 16:53:12,593 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4403781920) was cancelled.
2025-05-30 16:53:12,593 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4403781920) stopping. Performing cleanup...
2025-05-30 16:53:12,593 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:53:12,598 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 16:53:12,599 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 16:53:12,599 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:53:12,599 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 16:53:12,599 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:53:12,599 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4403781920) cleanup complete.
2025-05-30 16:53:12,599 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 16:53:12,599 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 16:53:12,599 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4405229712) was cancelled.
2025-05-30 16:53:12,599 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4405229712) stopping. Performing cleanup...
2025-05-30 16:53:12,599 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:53:12,603 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 16:53:12,604 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 16:53:12,604 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:53:12,604 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 16:53:12,604 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:53:12,604 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4405229712) cleanup complete.
2025-05-30 16:53:12,604 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 16:53:12,604 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 16:53:12,604 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4405230096) was cancelled.
2025-05-30 16:53:12,604 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4405230096) stopping. Performing cleanup...
2025-05-30 16:53:12,604 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 16:53:12,604 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:53:12,604 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:53:12,604 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 16:53:12,604 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:53:12,606 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 16:53:12,607 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 16:53:12,607 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:53:12,607 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 16:53:12,607 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:53:12,607 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 16:53:12,607 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4405230096) cleanup complete.
2025-05-30 16:53:12,608 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 16:53:12,608 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 16:53:12,608 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 16:53:12,614 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:53:12,614 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 16:53:13,082 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:53:13,082 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:53:13,086 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:53:13,086 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:53:13,086 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:53:13,086 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:53:13,086 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:53:13,087 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:53:13,087 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:53:13,087 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:53:13,087 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:53:13,087 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:53:13,087 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:53:13,089 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:53:13,103 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:53:13,103 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:53:13,105 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:53:13,105 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:53:13,105 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:53:13,105 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:53:13,106 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:53:13,106 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4451631952) setup complete. Starting run loop.
2025-05-30 16:53:13,106 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:53:13,107 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:53:13,108 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:53:13,108 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4451631712) setup complete. Starting run loop.
2025-05-30 16:53:13,108 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:53:13,119 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:53:13,119 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:53:13,136 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:53:13,136 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:53:13,137 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:53:13,137 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:53:13,137 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:53:13,138 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:53:13,139 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:53:13,139 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:53:13,139 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:53:13,139 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:53:14,406 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 16:53:14,406 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 16:53:14,406 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4657214192) received shutdown request. Initiating graceful shutdown...
2025-05-30 16:53:14,406 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4657214192)...
2025-05-30 16:53:14,406 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 16:53:14,406 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 16:53:14,406 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4657214192) was cancelled.
2025-05-30 16:53:14,406 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4657214192) stopping. Performing cleanup...
2025-05-30 16:53:14,406 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 16:53:14,406 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 16:53:14,407 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 16:53:14,407 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-30 16:53:14,407 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 16:53:14,407 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 16:53:14,407 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 16:53:14,407 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:53:14,407 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 16:53:14,408 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 16:53:14,408 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 16:53:14,411 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 16:53:14,412 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 16:53:14,412 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:53:14,412 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 16:53:14,412 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 16:53:14,412 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 16:53:14,412 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4657214192) cleanup complete.
2025-05-30 16:53:14,412 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 16:53:14,412 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 16:53:14,415 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:53:14,415 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 16:53:14,415 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 16:53:14,416 - INFO - __main__ - Agent runner main finished.
2025-05-30 16:53:14,548 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 16:53:14,548 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 16:53:14,548 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 16:53:14,548 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4451631952) was cancelled.
2025-05-30 16:53:14,549 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4451631952) stopping. Performing cleanup...
2025-05-30 16:53:14,549 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:53:14,553 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 16:53:14,554 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 16:53:14,554 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:53:14,554 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 16:53:14,554 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:53:14,554 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4451631952) cleanup complete.
2025-05-30 16:53:14,554 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 16:53:14,554 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 16:53:14,554 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4451631712) was cancelled.
2025-05-30 16:53:14,554 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4451631712) stopping. Performing cleanup...
2025-05-30 16:53:14,554 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:53:14,557 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 16:53:14,558 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 16:53:14,558 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:53:14,558 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 16:53:14,558 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:53:14,558 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4451631712) cleanup complete.
2025-05-30 16:53:14,558 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 16:53:14,558 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 16:53:14,558 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4451631520) was cancelled.
2025-05-30 16:53:14,558 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4451631520) stopping. Performing cleanup...
2025-05-30 16:53:14,558 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 16:53:14,558 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:53:14,558 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:53:14,558 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 16:53:14,558 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:53:14,560 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 16:53:14,561 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 16:53:14,561 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:53:14,561 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 16:53:14,561 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:53:14,561 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 16:53:14,561 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4451631520) cleanup complete.
2025-05-30 16:53:14,561 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 16:53:14,561 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 16:53:14,561 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 16:53:14,564 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:53:14,564 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 16:53:14,658 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 16:53:14,659 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 16:53:14,659 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 16:53:14,659 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4620937616) received shutdown request. Initiating graceful shutdown...
2025-05-30 16:53:14,659 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4620937616)...
2025-05-30 16:53:14,659 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 16:53:14,659 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 16:53:14,659 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4620937616) was cancelled.
2025-05-30 16:53:14,659 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4620937616) stopping. Performing cleanup...
2025-05-30 16:53:14,659 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 16:53:14,659 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 16:53:14,659 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 16:53:14,659 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 16:53:14,659 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 16:53:14,659 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 16:53:14,659 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:53:14,659 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 16:53:14,659 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 16:53:14,659 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 16:53:14,663 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 16:53:14,664 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 16:53:14,664 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:53:14,664 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 16:53:14,664 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 16:53:14,664 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 16:53:14,664 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4620937616) cleanup complete.
2025-05-30 16:53:14,664 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 16:53:14,664 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 16:53:14,668 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:53:14,668 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 16:53:14,668 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 16:53:14,668 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 16:53:16,011 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:53:16,011 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:53:16,015 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:53:16,015 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:53:16,015 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:53:16,016 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:53:16,016 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:53:16,016 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:53:16,016 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:53:16,016 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:53:16,016 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:53:16,016 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:53:16,016 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:53:16,018 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:53:16,018 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:53:16,019 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:53:16,019 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:53:16,019 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:53:16,019 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:53:16,019 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:53:16,035 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:53:16,036 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:53:16,036 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4442315936) setup complete. Starting run loop.
2025-05-30 16:53:16,036 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:53:16,037 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:53:16,037 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4452467872) setup complete. Starting run loop.
2025-05-30 16:53:16,037 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:53:16,038 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:53:16,038 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:53:16,065 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:53:16,066 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:53:16,068 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 16:53:16,068 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 82953
2025-05-30 16:53:16,068 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 82953
2025-05-30 16:53:16,069 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 16:53:16,069 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:53:16,069 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:53:16,070 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 16:53:16,071 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 82954
2025-05-30 16:53:16,071 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 82954
2025-05-30 16:53:16,071 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 16:53:16,072 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:53:16,072 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:53:16,072 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:53:16,072 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:53:16,932 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:53:16,933 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 16:53:16,933 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 16:53:16,933 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 16:53:16,933 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 82954
2025-05-30 16:53:16,933 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 16:53:16,933 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 16:53:16,933 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 16:53:16,938 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 16:53:16,951 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 16:53:16,952 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 16:53:16,952 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 16:53:16,952 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4435716352) setup complete. Starting run loop.
2025-05-30 16:53:16,952 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 16:53:16,952 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 16:53:16,952 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 16:53:16,952 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 16:53:16,952 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:53:16,952 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 16:53:16,952 - INFO - aiogram.dispatcher - Start polling
2025-05-30 16:53:16,954 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:53:17,196 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 16:53:17,286 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:53:17,287 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 16:53:17,287 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 16:53:17,287 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 16:53:17,287 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 82953
2025-05-30 16:53:17,287 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 16:53:17,287 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 16:53:17,287 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 16:53:17,333 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 16:53:17,333 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 16:53:17,375 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 16:53:17,375 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 16:53:17,376 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 16:53:17,376 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 16:53:17,376 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 16:53:17,376 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:53:17,401 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 16:53:17,401 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 16:53:17,401 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 16:53:17,402 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 16:53:17,403 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET)
2025-05-30 16:53:17,403 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 16:53:17,403 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 16:53:17,457 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 16:53:17,461 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 16:53:18,131 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 16:53:18,137 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 16:53:18,138 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 16:53:18,138 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 16:53:18,138 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 16:53:18,138 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 16:53:18,138 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 16:53:18,138 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 16:53:18,138 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 16:53:18,139 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 16:53:18,139 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 16:53:18,139 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 16:53:18,139 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 16:53:18,139 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 16:53:18,139 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 16:53:18,139 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 16:53:18,149 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 16:53:18,149 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 16:53:18,149 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 16:53:18,149 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4407767984) setup complete. Starting run loop.
2025-05-30 16:53:18,149 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 16:53:18,149 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 16:53:18,149 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 16:53:18,149 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:53:18,153 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:53:26,038 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 16:53:26,043 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 16:53:26,043 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4452467920) setup complete. Starting run loop.
2025-05-30 16:53:26,043 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 16:53:32,027 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñƒ Ğ¼ĞµĞ½Ñ Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ?...'
2025-05-30 16:53:32,029 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 16:53:32,099 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 16:53:32,099 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:53:32,099 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 16:53:32,100 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 8b6b3c2a-1fb2-459d-b1d5-0a923db57db9)
2025-05-30 16:53:32,100 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 16:53:32,100 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-30 16:53:32,121 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 8b6b3c2a-1fb2-459d-b1d5-0a923db57db9, db_id: 1007
2025-05-30 16:53:32,137 - INFO - AGENT:agent_airsoft_0faa9616 - Loaded 20 messages from DB for thread '144641834'.
2025-05-30 16:53:32,137 - INFO - AGENT:agent_airsoft_0faa9616 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-30 16:53:32,137 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-30 16:53:32,206 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:53:32,206 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:53:32,231 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:53:32,235 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:53:33,100 - INFO - aiogram.event - Update id=804756347 is handled. Duration 1073 ms by bot id=1750613938
2025-05-30 16:53:33,252 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:53:33,257 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 16:53:33,257 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_38647f5e19'}
2025-05-30 16:53:33,257 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 989, 'output_tokens': 16, 'total_tokens': 1005, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:53:33,257 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:989 C:16 T:1005
2025-05-30 16:53:33,257 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1005 tokens recorded.
2025-05-30 16:53:33,258 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:53:33,258 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748589354598
2025-05-30 16:53:33,258 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748589354598)---
2025-05-30 16:53:33,260 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹'
2025-05-30 16:53:33,260 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:53:33,260 - INFO - app.agent_runner.common.tools_registry - Attempting Cloudflare bypass with cloudscraper for https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:53:33,699 - INFO - app.agent_runner.common.tools_registry - API Response Content Preview (first 1000 chars): 574
2025-05-30 16:53:33,702 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:53:33,702 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:53:33,726 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:53:33,729 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:53:34,642 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:53:34,972 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ£ Ñ‚ĞµĞ±Ñ Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ 574 Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°! Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ Ñ Ğ¸Ğ´ĞµÑĞ¼Ğ¸, ĞºĞ°Ğº Ğ¸Ñ… Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°
2025-05-30 16:53:34,972 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_38647f5e19'}
2025-05-30 16:53:34,972 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1020, 'output_tokens': 32, 'total_tokens': 1052, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:53:34,972 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1020 C:32 T:1052
2025-05-30 16:53:34,972 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1052 tokens recorded.
2025-05-30 16:53:34,973 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:53:34,973 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 16:53:34,974 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ£ Ñ‚ĞµĞ±Ñ Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ 574 Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°! Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ Ñ Ğ¸Ğ´ĞµÑĞ¼Ğ¸, ĞºĞ°Ğº Ğ¸Ñ… Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°...
2025-05-30 16:53:34,976 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 8b6b3c2a-1fb2-459d-b1d5-0a923db57db9)
2025-05-30 16:53:34,976 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: 8b6b3c2a-1fb2-459d-b1d5-0a923db57db9.
2025-05-30 16:53:34,978 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Ğ£ Ñ‚ĞµĞ±Ñ Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ 574 Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°! Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ Ñ Ğ¸Ğ´ĞµÑĞ¼Ğ¸, ĞºĞ°Ğº Ğ¸Ñ… Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°...
2025-05-30 16:53:34,979 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Ğ£ Ñ‚ĞµĞ±Ñ Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ 574 Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°! Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ğ¼...'
2025-05-30 16:53:34,980 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '8b6b3c2a-1fb2-459d-b1d5-0a923db57db9', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 989, 'completion_tokens': 16, 'total_tokens': 1005, 'timestamp': '2025-05-30T11:53:33.257271+00:00'}
2025-05-30 16:53:34,980 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 8b6b3c2a-1fb2-459d-b1d5-0a923db57db9
2025-05-30 16:53:34,983 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 8b6b3c2a-1fb2-459d-b1d5-0a923db57db9, db_id: 1008
2025-05-30 16:53:35,010 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1008 for interaction_id: 8b6b3c2a-1fb2-459d-b1d5-0a923db57db9 on attempt 1
2025-05-30 16:53:35,016 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 8b6b3c2a-1fb2-459d-b1d5-0a923db57db9, db_id: 477
2025-05-30 16:53:35,019 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '8b6b3c2a-1fb2-459d-b1d5-0a923db57db9', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1020, 'completion_tokens': 32, 'total_tokens': 1052, 'timestamp': '2025-05-30T11:53:34.972450+00:00'}
2025-05-30 16:53:35,019 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 8b6b3c2a-1fb2-459d-b1d5-0a923db57db9
2025-05-30 16:53:35,020 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1008 for interaction_id: 8b6b3c2a-1fb2-459d-b1d5-0a923db57db9 on attempt 1
2025-05-30 16:53:35,023 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 8b6b3c2a-1fb2-459d-b1d5-0a923db57db9, db_id: 478
2025-05-30 16:54:27,816 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Gjcvjnhb pfgbcm d ,kjut...'
2025-05-30 16:54:27,818 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 16:54:27,823 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 16:54:27,823 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:54:27,823 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 16:54:27,824 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 2b2aee88-81f7-4426-811a-aecdf7d08d07)
2025-05-30 16:54:27,824 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 16:54:27,825 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 16:54:27,825 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 16:54:27,830 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:54:27,831 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:54:27,833 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 2b2aee88-81f7-4426-811a-aecdf7d08d07, db_id: 1009
2025-05-30 16:54:27,857 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:54:27,860 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:54:28,698 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:54:28,823 - INFO - aiogram.event - Update id=804756348 is handled. Duration 1006 ms by bot id=1750613938
2025-05-30 16:54:29,170 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğµ, Ñ‡Ñ‚Ğ¾ Ğ² Ğ²Ğ°ÑˆĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¸ Ğ¾Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ°. ĞœĞ¾Ğ¶ĞµÑ‚Ğµ, Ğ¿Ğ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ Ğ¸Ğ»Ğ¸ ÑƒÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ñ‚ÑŒ, Ñ‡Ñ‚Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ½Ğ¾ Ğ²Ñ‹ Ñ…Ğ¾
2025-05-30 16:54:29,170 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 16:54:29,170 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1072, 'output_tokens': 41, 'total_tokens': 1113, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:54:29,170 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1072 C:41 T:1113
2025-05-30 16:54:29,170 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1113 tokens recorded.
2025-05-30 16:54:29,171 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:54:29,171 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 16:54:29,172 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğµ, Ñ‡Ñ‚Ğ¾ Ğ² Ğ²Ğ°ÑˆĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¸ Ğ¾Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ°. ĞœĞ¾Ğ¶ĞµÑ‚Ğµ, Ğ¿Ğ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ Ğ¸Ğ»Ğ¸ ÑƒÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ñ‚ÑŒ, Ñ‡Ñ‚Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ½Ğ¾ Ğ²Ñ‹ Ñ…Ğ¾...
2025-05-30 16:54:29,174 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 2b2aee88-81f7-4426-811a-aecdf7d08d07)
2025-05-30 16:54:29,174 - INFO - AGENT:agent_airsoft_0faa9616 - Found 1 token usage events for InteractionID: 2b2aee88-81f7-4426-811a-aecdf7d08d07.
2025-05-30 16:54:29,176 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğµ, Ñ‡Ñ‚Ğ¾ Ğ² Ğ²Ğ°ÑˆĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¸ Ğ¾Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ°. ĞœĞ¾Ğ¶ĞµÑ‚Ğµ, Ğ¿Ğ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ Ğ¸Ğ»Ğ¸ ÑƒÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ñ‚ÑŒ, Ñ‡Ñ‚Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ½Ğ¾ Ğ²Ñ‹ Ñ…Ğ¾...
2025-05-30 16:54:29,176 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğµ, Ñ‡Ñ‚Ğ¾ Ğ² Ğ²Ğ°ÑˆĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¸ Ğ¾Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ°. ĞœĞ¾Ğ¶ĞµÑ‚Ğµ, Ğ¿Ğ¾...'
2025-05-30 16:54:29,178 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '2b2aee88-81f7-4426-811a-aecdf7d08d07', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1072, 'completion_tokens': 41, 'total_tokens': 1113, 'timestamp': '2025-05-30T11:54:29.170526+00:00'}
2025-05-30 16:54:29,178 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 2b2aee88-81f7-4426-811a-aecdf7d08d07
2025-05-30 16:54:29,181 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1010 for interaction_id: 2b2aee88-81f7-4426-811a-aecdf7d08d07 on attempt 1
2025-05-30 16:54:29,181 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 2b2aee88-81f7-4426-811a-aecdf7d08d07, db_id: 1010
2025-05-30 16:54:29,185 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 2b2aee88-81f7-4426-811a-aecdf7d08d07, db_id: 479
2025-05-30 16:54:43,873 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² Ğ±Ğ»Ğ¾Ğ³Ğµ...'
2025-05-30 16:54:43,875 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 16:54:43,879 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 16:54:43,879 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:54:43,879 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 16:54:43,881 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 8571b47a-d0fd-4240-af83-108cdbdc68e7)
2025-05-30 16:54:43,881 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 16:54:43,882 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 16:54:43,882 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 16:54:43,885 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:54:43,885 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:54:43,889 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 8571b47a-d0fd-4240-af83-108cdbdc68e7, db_id: 1011
2025-05-30 16:54:43,911 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:54:43,914 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:54:44,880 - INFO - aiogram.event - Update id=804756349 is handled. Duration 1006 ms by bot id=1750613938
2025-05-30 16:54:45,033 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:54:45,035 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 16:54:45,035 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 16:54:45,035 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1127, 'output_tokens': 16, 'total_tokens': 1143, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:54:45,035 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1127 C:16 T:1143
2025-05-30 16:54:45,035 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1143 tokens recorded.
2025-05-30 16:54:45,036 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:54:45,036 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748460000001
2025-05-30 16:54:45,036 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748460000001)---
2025-05-30 16:54:45,038 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'JSONPlaceholder POST'
2025-05-30 16:54:45,038 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://jsonplaceholder.typicode.com/posts
2025-05-30 16:54:45,038 - INFO - app.agent_runner.common.tools_registry - Attempting Cloudflare bypass with cloudscraper for https://jsonplaceholder.typicode.com/posts
2025-05-30 16:54:45,430 - INFO - app.agent_runner.common.tools_registry - API Response Content Preview (first 1000 chars): [
  {
    "userId": 1,
    "id": 1,
    "title": "sunt aut facere repellat provident occaecati excepturi optio reprehenderit",
    "body": "quia et suscipit\nsuscipit recusandae consequuntur expedita et cum\nreprehenderit molestiae ut ut quas totam\nnostrum rerum est autem sunt rem eveniet architecto"
  },
  {
    "userId": 1,
    "id": 2,
    "title": "qui est esse",
    "body": "est rerum tempore vitae\nsequi sint nihil reprehenderit dolor beatae ea dolores neque\nfugiat blanditiis voluptate porro vel nihil molestiae ut reiciendis\nqui aperiam non debitis possimus qui neque nisi nulla"
  },
  {
    "userId": 1,
    "id": 3,
    "title": "ea molestias quasi exercitationem repellat qui ipsa sit aut",
    "body": "et iusto sed quo iure\nvoluptatem occaecati omnis eligendi aut ad\nvoluptatem doloribus vel accusantium quis pariatur\nmolestiae porro eius odio et labore et velit aut"
  },
  {
    "userId": 1,
    "id": 4,
    "title": "eum et est occaecati",
    "body": "ullam et saepe reic
2025-05-30 16:54:45,432 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:54:45,432 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:54:45,456 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:54:45,459 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:54:47,229 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:54:48,433 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ’Ğ¾Ñ‚ Ğ¾Ğ´Ğ½Ğ° Ğ¸Ğ· Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¸Ğ· Ğ±Ğ»Ğ¾Ğ³Ğ°:

**Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº:** sunt aut facere repellat provident occaecati excepturi
2025-05-30 16:54:48,433 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 16:54:48,433 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 8847, 'output_tokens': 84, 'total_tokens': 8931, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:54:48,433 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:8847 C:84 T:8931
2025-05-30 16:54:48,433 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 8931 tokens recorded.
2025-05-30 16:54:48,434 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:54:48,434 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 16:54:48,435 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ’Ğ¾Ñ‚ Ğ¾Ğ´Ğ½Ğ° Ğ¸Ğ· Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¸Ğ· Ğ±Ğ»Ğ¾Ğ³Ğ°:

**Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº:** sunt aut facere repellat provident occaecati excepturi...
2025-05-30 16:54:48,437 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 8571b47a-d0fd-4240-af83-108cdbdc68e7)
2025-05-30 16:54:48,438 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: 8571b47a-d0fd-4240-af83-108cdbdc68e7.
2025-05-30 16:54:48,439 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Ğ’Ğ¾Ñ‚ Ğ¾Ğ´Ğ½Ğ° Ğ¸Ğ· Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¸Ğ· Ğ±Ğ»Ğ¾Ğ³Ğ°:

**Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº:** sunt aut facere repellat provident occaecati excepturi...
2025-05-30 16:54:48,439 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Ğ’Ğ¾Ñ‚ Ğ¾Ğ´Ğ½Ğ° Ğ¸Ğ· Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¸Ğ· Ğ±Ğ»Ğ¾Ğ³Ğ°:

**Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº:** sunt...'
2025-05-30 16:54:48,440 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '8571b47a-d0fd-4240-af83-108cdbdc68e7', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1127, 'completion_tokens': 16, 'total_tokens': 1143, 'timestamp': '2025-05-30T11:54:45.035607+00:00'}
2025-05-30 16:54:48,440 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 8571b47a-d0fd-4240-af83-108cdbdc68e7
2025-05-30 16:54:48,443 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1012 for interaction_id: 8571b47a-d0fd-4240-af83-108cdbdc68e7 on attempt 1
2025-05-30 16:54:48,443 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 8571b47a-d0fd-4240-af83-108cdbdc68e7, db_id: 1012
2025-05-30 16:54:48,447 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 8571b47a-d0fd-4240-af83-108cdbdc68e7, db_id: 480
2025-05-30 16:54:48,451 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '8571b47a-d0fd-4240-af83-108cdbdc68e7', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 8847, 'completion_tokens': 84, 'total_tokens': 8931, 'timestamp': '2025-05-30T11:54:48.433225+00:00'}
2025-05-30 16:54:48,451 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 8571b47a-d0fd-4240-af83-108cdbdc68e7
2025-05-30 16:54:48,452 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1012 for interaction_id: 8571b47a-d0fd-4240-af83-108cdbdc68e7 on attempt 1
2025-05-30 16:54:48,455 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 8571b47a-d0fd-4240-af83-108cdbdc68e7, db_id: 481
2025-05-30 16:55:25,796 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 16:55:25,796 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 16:55:25,796 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 16:55:25,797 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4442315936) was cancelled.
2025-05-30 16:55:25,797 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4442315936) stopping. Performing cleanup...
2025-05-30 16:55:25,797 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:55:25,801 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 16:55:25,802 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 16:55:25,802 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:55:25,802 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 16:55:25,802 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:55:25,802 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4442315936) cleanup complete.
2025-05-30 16:55:25,802 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 16:55:25,802 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 16:55:25,802 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4452467872) was cancelled.
2025-05-30 16:55:25,802 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4452467872) stopping. Performing cleanup...
2025-05-30 16:55:25,802 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:55:25,806 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 16:55:25,807 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 16:55:25,807 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:55:25,807 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 16:55:25,807 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:55:25,807 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4452467872) cleanup complete.
2025-05-30 16:55:25,807 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 16:55:25,807 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 16:55:25,807 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4452467920) was cancelled.
2025-05-30 16:55:25,807 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4452467920) stopping. Performing cleanup...
2025-05-30 16:55:25,807 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 16:55:25,807 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:55:25,807 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:55:25,807 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 16:55:25,807 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:55:25,809 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 16:55:25,810 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 16:55:25,810 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:55:25,810 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 16:55:25,810 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:55:25,810 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 16:55:25,810 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4452467920) cleanup complete.
2025-05-30 16:55:25,810 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 16:55:25,810 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 16:55:25,810 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 16:55:25,816 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:55:25,816 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 16:55:26,277 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:55:26,277 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:55:26,282 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:55:26,282 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:55:26,282 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:55:26,282 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:55:26,282 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:55:26,282 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:55:26,282 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:55:26,282 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:55:26,282 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:55:26,283 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:55:26,283 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:55:26,284 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:55:26,284 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:55:26,285 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:55:26,285 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:55:26,285 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:55:26,285 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:55:26,285 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:55:26,303 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:55:26,304 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:55:26,304 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4415027776) setup complete. Starting run loop.
2025-05-30 16:55:26,304 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:55:26,304 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4414651856) setup complete. Starting run loop.
2025-05-30 16:55:26,304 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:55:26,304 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:55:26,306 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:55:26,306 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:55:26,336 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:55:26,336 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:55:26,337 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:55:26,337 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:55:26,337 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:55:26,338 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:55:26,339 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:55:26,339 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:55:26,339 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:55:26,339 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:55:36,306 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 16:55:36,310 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 16:55:36,310 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4415027584) setup complete. Starting run loop.
2025-05-30 16:55:36,310 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 17:00:31,815 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Ñ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½?...'
2025-05-30 17:00:31,816 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 17:00:31,823 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 17:00:31,823 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 17:00:31,824 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 17:00:31,825 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: a6e5febe-f9aa-48ab-9cf6-1980488b0772)
2025-05-30 17:00:31,825 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 17:00:31,826 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 17:00:31,827 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 17:00:31,849 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 17:00:31,850 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 17:00:31,862 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: a6e5febe-f9aa-48ab-9cf6-1980488b0772, db_id: 1013
2025-05-30 17:00:31,882 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 17:00:31,889 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 17:00:32,823 - INFO - aiogram.event - Update id=804756350 is handled. Duration 1009 ms by bot id=1750613938
2025-05-30 17:00:34,759 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 17:00:34,762 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 17:00:34,762 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 17:00:34,763 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 8943, 'output_tokens': 12, 'total_tokens': 8955, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 17:00:34,763 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:8943 C:12 T:8955
2025-05-30 17:00:34,763 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 8955 tokens recorded.
2025-05-30 17:00:34,764 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 17:00:34,764 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: get_user_info_tool
2025-05-30 17:00:34,764 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (get_user_info_tool)---
2025-05-30 17:00:34,767 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 17:00:34,767 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 17:00:34,791 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 17:00:34,794 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 17:00:36,526 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 17:00:36,534 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 17:00:36,599 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 17:00:37,160 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ”Ğ°, Ğ•Ğ²Ğ³ĞµĞ½Ğ¸Ğ¹, Ñ‚Ñ‹ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½ Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ. Ğ•ÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ Ñ Ğ»ÑĞ±Ñ‹Ğ¼Ğ¸ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ°Ğ¼Ğ¸ Ğ¸Ğ»Ğ¸ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ°Ğ¼Ğ¸! ğŸ˜Š
2025-05-30 17:00:37,160 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 17:00:37,160 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 9014, 'output_tokens': 29, 'total_tokens': 9043, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 17:00:37,160 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:9014 C:29 T:9043
2025-05-30 17:00:37,160 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 9043 tokens recorded.
2025-05-30 17:00:37,161 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 17:00:37,161 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 17:00:37,162 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ”Ğ°, Ğ•Ğ²Ğ³ĞµĞ½Ğ¸Ğ¹, Ñ‚Ñ‹ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½ Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ. Ğ•ÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ Ñ Ğ»ÑĞ±Ñ‹Ğ¼Ğ¸ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ°Ğ¼Ğ¸ Ğ¸Ğ»Ğ¸ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ°Ğ¼Ğ¸! ğŸ˜Š...
2025-05-30 17:00:37,164 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: a6e5febe-f9aa-48ab-9cf6-1980488b0772)
2025-05-30 17:00:37,164 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: a6e5febe-f9aa-48ab-9cf6-1980488b0772.
2025-05-30 17:00:37,166 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Ğ”Ğ°, Ğ•Ğ²Ğ³ĞµĞ½Ğ¸Ğ¹, Ñ‚Ñ‹ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½ Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ. Ğ•ÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ Ñ Ğ»ÑĞ±Ñ‹Ğ¼Ğ¸ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ°Ğ¼Ğ¸ Ğ¸Ğ»Ğ¸ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ°Ğ¼Ğ¸! ğŸ˜Š...
2025-05-30 17:00:37,166 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Ğ”Ğ°, Ğ•Ğ²Ğ³ĞµĞ½Ğ¸Ğ¹, Ñ‚Ñ‹ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½ Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ. Ğ•ÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾,...'
2025-05-30 17:00:37,167 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'a6e5febe-f9aa-48ab-9cf6-1980488b0772', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 8943, 'completion_tokens': 12, 'total_tokens': 8955, 'timestamp': '2025-05-30T12:00:34.763085+00:00'}
2025-05-30 17:00:37,167 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: a6e5febe-f9aa-48ab-9cf6-1980488b0772
2025-05-30 17:00:37,180 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: a6e5febe-f9aa-48ab-9cf6-1980488b0772, db_id: 1014
2025-05-30 17:00:37,198 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1014 for interaction_id: a6e5febe-f9aa-48ab-9cf6-1980488b0772 on attempt 1
2025-05-30 17:00:37,203 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: a6e5febe-f9aa-48ab-9cf6-1980488b0772, db_id: 482
2025-05-30 17:00:37,207 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'a6e5febe-f9aa-48ab-9cf6-1980488b0772', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 9014, 'completion_tokens': 29, 'total_tokens': 9043, 'timestamp': '2025-05-30T12:00:37.160526+00:00'}
2025-05-30 17:00:37,207 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: a6e5febe-f9aa-48ab-9cf6-1980488b0772
2025-05-30 17:00:37,208 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1014 for interaction_id: a6e5febe-f9aa-48ab-9cf6-1980488b0772 on attempt 1
2025-05-30 17:00:37,211 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: a6e5febe-f9aa-48ab-9cf6-1980488b0772, db_id: 483
2025-05-30 17:04:16,348 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-30 17:04:16,358 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-30 17:04:16,359 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-30 17:04:16,359 - INFO - app.db.crud.agent_crud - Updating agent config in DB for agent_id: agent_airsoft_0faa9616
2025-05-30 17:04:16,371 - INFO - app.db.crud.agent_crud - Agent config updated successfully for agent_id: agent_airsoft_0faa9616
2025-05-30 17:04:16,371 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616 was running. Attempting to restart it after config update.
2025-05-30 17:04:16,371 - INFO - app.services.process_manager - Restarting agent process for agent_airsoft_0faa9616...
2025-05-30 17:04:16,372 - INFO - app.services.process_manager - Stopping agent process agent_airsoft_0faa9616 (PID: 82953). Force: True
2025-05-30 17:04:16,372 - INFO - app.services.process_manager - SIGTERM sent to agent agent_airsoft_0faa9616 (PID: 82953)
2025-05-30 17:04:16,472 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 (PID: 82953) terminated gracefully after SIGTERM.
2025-05-30 17:04:16,475 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 marked as stopped in Redis.
2025-05-30 17:04:16,475 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 stopped (or stop attempted and assumed successful for restart). Pausing briefly...
2025-05-30 17:04:21,475 - INFO - app.services.process_manager - Proceeding to start agent agent_airsoft_0faa9616 after delay...
2025-05-30 17:04:21,478 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 17:04:21,479 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 84503
2025-05-30 17:04:21,479 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 84503
2025-05-30 17:04:21,480 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 successfully started as part of restart sequence.
2025-05-30 17:04:21,480 - INFO - app.api.routers.agent_api - Restart command issued for agent agent_airsoft_0faa9616 after config update.
2025-05-30 17:04:21,480 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 17:04:21,480 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 17:04:22,846 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 17:04:22,846 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 17:04:22,846 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 17:04:22,846 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 17:04:22,846 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 84503
2025-05-30 17:04:22,846 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 17:04:22,846 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 17:04:22,846 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 17:04:22,888 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 17:04:22,888 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 17:04:22,925 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 17:04:22,925 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 17:04:22,925 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 17:04:22,925 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 17:04:22,925 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 17:04:22,926 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 17:04:22,951 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 17:04:22,951 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 17:04:22,951 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 17:04:22,952 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 17:04:22,953 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET)
2025-05-30 17:04:22,953 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 17:04:22,953 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 17:04:23,008 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 17:04:23,012 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 17:04:23,680 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 17:04:23,684 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 17:04:23,684 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 17:04:23,684 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 17:04:23,684 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 17:04:23,684 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 17:04:23,684 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 17:04:23,684 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 17:04:23,684 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 17:04:23,685 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 17:04:23,685 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 17:04:23,685 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 17:04:23,685 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 17:04:23,685 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 17:04:23,686 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 17:04:23,686 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 17:04:23,696 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 17:04:23,697 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 17:04:23,697 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 17:04:23,697 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4406588768) setup complete. Starting run loop.
2025-05-30 17:04:23,697 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 17:04:23,697 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 17:04:23,697 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 17:04:23,697 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 17:04:23,700 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 17:05:07,207 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'ĞŸĞ¾ÑĞ¾Ğ²ĞµÑ‚ÑƒĞ¹ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¸ Ğ½ĞµĞ´Ğ¾Ñ€Ğ¾Ğ³Ğ¾Ğ¹ Ğ¿Ñ€Ğ¸Ğ²Ğ¾Ğ´ ÑĞµÑ€Ğ¸Ğ¸ ĞĞš...'
2025-05-30 17:05:07,208 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 17:05:07,211 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 17:05:07,212 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 17:05:07,212 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 17:05:07,213 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 90e0c133-9fae-4a85-b7b5-d65a5dadeebc)
2025-05-30 17:05:07,213 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 17:05:07,213 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 17:05:07,213 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 17:05:07,222 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 90e0c133-9fae-4a85-b7b5-d65a5dadeebc, db_id: 1015
2025-05-30 17:05:07,260 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 17:05:07,260 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 17:05:07,285 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 17:05:07,289 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 17:05:08,212 - INFO - aiogram.event - Update id=804756351 is handled. Duration 1006 ms by bot id=1750613938
2025-05-30 17:05:08,372 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 17:05:08,561 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 17:05:08,561 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 17:05:08,561 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 380, 'output_tokens': 29, 'total_tokens': 409, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 17:05:08,561 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:380 C:29 T:409
2025-05-30 17:05:08,562 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 409 tokens recorded.
2025-05-30 17:05:08,562 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 17:05:08,562 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: webSearch-1748459212676
2025-05-30 17:05:08,562 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (webSearch-1748459212676)---
2025-05-30 17:05:11,856 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 17:05:11,857 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 17:05:11,881 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 17:05:11,884 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 17:05:12,748 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 17:05:18,880 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ•ÑĞ»Ğ¸ Ğ¸Ñ‰ĞµÑˆÑŒ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¸ Ğ½ĞµĞ´Ğ¾Ñ€Ğ¾Ğ³Ğ¾Ğ¹ Ğ¿Ñ€Ğ¸Ğ²Ğ¾Ğ´ ÑĞµÑ€Ğ¸Ğ¸ ĞĞš, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚ Cyma ĞĞš-74Ğœ (CM040
2025-05-30 17:05:18,880 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 17:05:18,880 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1036, 'output_tokens': 129, 'total_tokens': 1165, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 17:05:18,880 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1036 C:129 T:1165
2025-05-30 17:05:18,880 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1165 tokens recorded.
2025-05-30 17:05:18,881 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 17:05:18,881 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 17:05:18,882 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ•ÑĞ»Ğ¸ Ğ¸Ñ‰ĞµÑˆÑŒ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¸ Ğ½ĞµĞ´Ğ¾Ñ€Ğ¾Ğ³Ğ¾Ğ¹ Ğ¿Ñ€Ğ¸Ğ²Ğ¾Ğ´ ÑĞµÑ€Ğ¸Ğ¸ ĞĞš, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚ Cyma ĞĞš-74Ğœ (CM040...
2025-05-30 17:05:18,884 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 90e0c133-9fae-4a85-b7b5-d65a5dadeebc)
2025-05-30 17:05:18,884 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: 90e0c133-9fae-4a85-b7b5-d65a5dadeebc.
2025-05-30 17:05:18,886 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Ğ•ÑĞ»Ğ¸ Ğ¸Ñ‰ĞµÑˆÑŒ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¸ Ğ½ĞµĞ´Ğ¾Ñ€Ğ¾Ğ³Ğ¾Ğ¹ Ğ¿Ñ€Ğ¸Ğ²Ğ¾Ğ´ ÑĞµÑ€Ğ¸Ğ¸ ĞĞš, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚ Cyma ĞĞš-74Ğœ (CM040...
2025-05-30 17:05:18,886 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Ğ•ÑĞ»Ğ¸ Ğ¸Ñ‰ĞµÑˆÑŒ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¸ Ğ½ĞµĞ´Ğ¾Ñ€Ğ¾Ğ³Ğ¾Ğ¹ Ğ¿Ñ€Ğ¸Ğ²Ğ¾Ğ´ ÑĞµÑ€Ğ¸Ğ¸ Ğ...'
2025-05-30 17:05:18,887 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '90e0c133-9fae-4a85-b7b5-d65a5dadeebc', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 380, 'completion_tokens': 29, 'total_tokens': 409, 'timestamp': '2025-05-30T12:05:08.562013+00:00'}
2025-05-30 17:05:18,887 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 90e0c133-9fae-4a85-b7b5-d65a5dadeebc
2025-05-30 17:05:18,890 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1016 for interaction_id: 90e0c133-9fae-4a85-b7b5-d65a5dadeebc on attempt 1
2025-05-30 17:05:18,891 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 90e0c133-9fae-4a85-b7b5-d65a5dadeebc, db_id: 1016
2025-05-30 17:05:18,895 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 90e0c133-9fae-4a85-b7b5-d65a5dadeebc, db_id: 484
2025-05-30 17:05:18,899 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '90e0c133-9fae-4a85-b7b5-d65a5dadeebc', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1036, 'completion_tokens': 129, 'total_tokens': 1165, 'timestamp': '2025-05-30T12:05:18.880463+00:00'}
2025-05-30 17:05:18,899 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 90e0c133-9fae-4a85-b7b5-d65a5dadeebc
2025-05-30 17:05:18,900 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1016 for interaction_id: 90e0c133-9fae-4a85-b7b5-d65a5dadeebc on attempt 1
2025-05-30 17:05:18,903 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 90e0c133-9fae-4a85-b7b5-d65a5dadeebc, db_id: 485
2025-05-30 17:05:36,720 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 17:05:36,729 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 17:06:11,976 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ ÑÑ‚Ğ¾Ğ¸Ñ‚? Ğ”Ğ°Ğ¹ Ğ½Ğ° Ğ½ĞµĞ³Ğ¾ ÑÑÑ‹Ğ»ĞºÑƒ...'
2025-05-30 17:06:11,979 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 17:06:11,984 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 17:06:11,984 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 17:06:11,984 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 17:06:11,985 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 0c1bc227-9fcd-4e78-877d-60be1639be5e)
2025-05-30 17:06:11,985 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 17:06:11,986 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 17:06:11,986 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 17:06:11,988 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 17:06:11,988 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 17:06:11,993 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 0c1bc227-9fcd-4e78-877d-60be1639be5e, db_id: 1017
2025-05-30 17:06:12,013 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 17:06:12,016 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 17:06:12,984 - INFO - aiogram.event - Update id=804756352 is handled. Duration 1008 ms by bot id=1750613938
2025-05-30 17:06:13,055 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 17:06:15,495 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚ Cyma ĞĞš-74Ğœ (CM040C) ÑÑ‚Ğ¾Ğ¸Ñ‚ Ğ½ĞµĞ´Ğ¾Ñ€Ğ¾Ğ³Ğ¾, Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾ Ğ² Ñ€Ğ°Ğ¹Ğ¾Ğ½Ğµ ÑÑ€ĞµĞ´Ğ½ĞµĞ¹ Ñ†ĞµĞ½Ñ‹ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¸Ğ²Ğ¾Ğ´Ğ¾Ğ² ÑĞµÑ€Ğ¸Ğ¸ ĞĞš, Ğ½Ğ¾ 
2025-05-30 17:06:15,495 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 17:06:15,495 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1182, 'output_tokens': 101, 'total_tokens': 1283, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 17:06:15,495 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1182 C:101 T:1283
2025-05-30 17:06:15,495 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1283 tokens recorded.
2025-05-30 17:06:15,496 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 17:06:15,496 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 17:06:15,497 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚ Cyma ĞĞš-74Ğœ (CM040C) ÑÑ‚Ğ¾Ğ¸Ñ‚ Ğ½ĞµĞ´Ğ¾Ñ€Ğ¾Ğ³Ğ¾, Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾ Ğ² Ñ€Ğ°Ğ¹Ğ¾Ğ½Ğµ ÑÑ€ĞµĞ´Ğ½ĞµĞ¹ Ñ†ĞµĞ½Ñ‹ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¸Ğ²Ğ¾Ğ´Ğ¾Ğ² ÑĞµÑ€Ğ¸Ğ¸ ĞĞš, Ğ½Ğ¾ ...
2025-05-30 17:06:15,499 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 0c1bc227-9fcd-4e78-877d-60be1639be5e)
2025-05-30 17:06:15,499 - INFO - AGENT:agent_airsoft_0faa9616 - Found 1 token usage events for InteractionID: 0c1bc227-9fcd-4e78-877d-60be1639be5e.
2025-05-30 17:06:15,501 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚ Cyma ĞĞš-74Ğœ (CM040C) ÑÑ‚Ğ¾Ğ¸Ñ‚ Ğ½ĞµĞ´Ğ¾Ñ€Ğ¾Ğ³Ğ¾, Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾ Ğ² Ñ€Ğ°Ğ¹Ğ¾Ğ½Ğµ ÑÑ€ĞµĞ´Ğ½ĞµĞ¹ Ñ†ĞµĞ½Ñ‹ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¸Ğ²Ğ¾Ğ´Ğ¾Ğ² ÑĞµÑ€Ğ¸Ğ¸ ĞĞš, Ğ½Ğ¾ ...
2025-05-30 17:06:15,501 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚ Cyma ĞĞš-74Ğœ (CM040C) ÑÑ‚Ğ¾Ğ¸Ñ‚ Ğ½ĞµĞ´Ğ¾Ñ€Ğ¾Ğ³Ğ¾, Ğ¾Ğ±Ñ‹Ñ‡Ğ½...'
2025-05-30 17:06:15,502 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '0c1bc227-9fcd-4e78-877d-60be1639be5e', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1182, 'completion_tokens': 101, 'total_tokens': 1283, 'timestamp': '2025-05-30T12:06:15.495877+00:00'}
2025-05-30 17:06:15,502 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 0c1bc227-9fcd-4e78-877d-60be1639be5e
2025-05-30 17:06:15,506 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 0c1bc227-9fcd-4e78-877d-60be1639be5e, db_id: 1018
2025-05-30 17:06:15,506 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1018 for interaction_id: 0c1bc227-9fcd-4e78-877d-60be1639be5e on attempt 1
2025-05-30 17:06:15,510 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 0c1bc227-9fcd-4e78-877d-60be1639be5e, db_id: 486
2025-05-30 17:09:11,924 - INFO - app.api.routers.sse_api - SSE connection requested for agent agent_airsoft_0faa9616, thread 9fb8e3a6-7879-4612-9e53-9d1bbaea8257
2025-05-30 17:09:24,671 - INFO - app.api.routers.sse_api - Message published to agent:agent_airsoft_0faa9616:input for agent agent_airsoft_0faa9616, thread 9fb8e3a6-7879-4612-9e53-9d1bbaea8257
2025-05-30 17:09:24,671 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 9fb8e3a6-7879-4612-9e53-9d1bbaea8257
2025-05-30 17:09:24,672 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 9fb8e3a6-7879-4612-9e53-9d1bbaea8257, InteractionID: 51857ce9-2fc5-4b92-b9c9-240a991524bd)
2025-05-30 17:09:24,672 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 17:09:24,673 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '9fb8e3a6-7879-4612-9e53-9d1bbaea8257' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-30 17:09:24,683 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 51857ce9-2fc5-4b92-b9c9-240a991524bd, db_id: 1019
2025-05-30 17:09:24,729 - INFO - AGENT:agent_airsoft_0faa9616 - Loaded 5 messages from DB for thread '9fb8e3a6-7879-4612-9e53-9d1bbaea8257'.
2025-05-30 17:09:24,729 - INFO - AGENT:agent_airsoft_0faa9616 - Added thread '9fb8e3a6-7879-4612-9e53-9d1bbaea8257' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-30 17:09:24,729 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 9fb8e3a6-7879-4612-9e53-9d1bbaea8257 (Initial history messages: 5)
2025-05-30 17:09:24,731 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 17:09:24,731 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 17:09:24,760 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 17:09:24,763 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 17:09:26,117 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 17:09:26,119 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 17:09:26,119 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 17:09:26,119 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 742, 'output_tokens': 16, 'total_tokens': 758, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 17:09:26,119 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:742 C:16 T:758
2025-05-30 17:09:26,119 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 758 tokens recorded.
2025-05-30 17:09:26,120 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 17:09:26,120 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748589354598
2025-05-30 17:09:26,120 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748589354598)---
2025-05-30 17:09:26,121 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹'
2025-05-30 17:09:26,121 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 17:09:26,121 - INFO - app.agent_runner.common.tools_registry - Attempting Cloudflare bypass with cloudscraper for https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 17:09:26,632 - INFO - app.agent_runner.common.tools_registry - API Response Content Preview (first 50 chars): 1482
2025-05-30 17:09:26,634 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 17:09:26,634 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 17:09:26,658 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 17:09:26,662 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 17:09:27,757 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 17:09:28,195 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ£ Ğ²Ğ°Ñ Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ 1482 Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ° (Ğ±Ğ±). Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ´ÑĞºĞ°Ğ·Ğ°Ñ‚ÑŒ, ĞºĞ°Ğº Ğ¸Ñ… Ğ²Ñ‹Ğ³Ğ¾Ğ´Ğ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ!
2025-05-30 17:09:28,195 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 17:09:28,195 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 774, 'output_tokens': 30, 'total_tokens': 804, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 17:09:28,195 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:774 C:30 T:804
2025-05-30 17:09:28,195 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 804 tokens recorded.
2025-05-30 17:09:28,196 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 17:09:28,196 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 17:09:28,197 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ£ Ğ²Ğ°Ñ Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ 1482 Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ° (Ğ±Ğ±). Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ´ÑĞºĞ°Ğ·Ğ°Ñ‚ÑŒ, ĞºĞ°Ğº Ğ¸Ñ… Ğ²Ñ‹Ğ³Ğ¾Ğ´Ğ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ!...
2025-05-30 17:09:28,198 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 9fb8e3a6-7879-4612-9e53-9d1bbaea8257, InteractionID: 51857ce9-2fc5-4b92-b9c9-240a991524bd)
2025-05-30 17:09:28,199 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: 51857ce9-2fc5-4b92-b9c9-240a991524bd.
2025-05-30 17:09:28,202 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '51857ce9-2fc5-4b92-b9c9-240a991524bd', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '9fb8e3a6-7879-4612-9e53-9d1bbaea8257', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 742, 'completion_tokens': 16, 'total_tokens': 758, 'timestamp': '2025-05-30T12:09:26.119122+00:00'}
2025-05-30 17:09:28,202 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 51857ce9-2fc5-4b92-b9c9-240a991524bd
2025-05-30 17:09:28,205 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1020 for interaction_id: 51857ce9-2fc5-4b92-b9c9-240a991524bd on attempt 1
2025-05-30 17:09:28,206 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 51857ce9-2fc5-4b92-b9c9-240a991524bd, db_id: 1020
2025-05-30 17:09:28,211 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 51857ce9-2fc5-4b92-b9c9-240a991524bd, db_id: 487
2025-05-30 17:09:28,214 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '51857ce9-2fc5-4b92-b9c9-240a991524bd', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '9fb8e3a6-7879-4612-9e53-9d1bbaea8257', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 774, 'completion_tokens': 30, 'total_tokens': 804, 'timestamp': '2025-05-30T12:09:28.195680+00:00'}
2025-05-30 17:09:28,214 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 51857ce9-2fc5-4b92-b9c9-240a991524bd
2025-05-30 17:09:28,216 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1020 for interaction_id: 51857ce9-2fc5-4b92-b9c9-240a991524bd on attempt 1
2025-05-30 17:09:28,219 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 51857ce9-2fc5-4b92-b9c9-240a991524bd, db_id: 488
2025-05-30 17:10:36,927 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 17:10:36,936 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 17:11:44,281 - INFO - app.api.routers.sse_api - Message published to agent:agent_airsoft_0faa9616:input for agent agent_airsoft_0faa9616, thread 9fb8e3a6-7879-4612-9e53-9d1bbaea8257
2025-05-30 17:11:44,281 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 9fb8e3a6-7879-4612-9e53-9d1bbaea8257
2025-05-30 17:11:44,283 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 9fb8e3a6-7879-4612-9e53-9d1bbaea8257, InteractionID: 1dd1e883-f915-4b0e-8f49-22200f64c5c0)
2025-05-30 17:11:44,283 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 17:11:44,283 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '9fb8e3a6-7879-4612-9e53-9d1bbaea8257' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 17:11:44,284 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 9fb8e3a6-7879-4612-9e53-9d1bbaea8257 (Initial history messages: 0)
2025-05-30 17:11:44,292 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 1dd1e883-f915-4b0e-8f49-22200f64c5c0, db_id: 1021
2025-05-30 17:11:44,293 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 17:11:44,295 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 17:11:44,326 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 17:11:44,331 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 17:11:45,494 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 17:11:45,496 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 17:11:45,496 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 17:11:45,496 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 816, 'output_tokens': 12, 'total_tokens': 828, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 17:11:45,496 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:816 C:12 T:828
2025-05-30 17:11:45,496 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 828 tokens recorded.
2025-05-30 17:11:45,497 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 17:11:45,497 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: get_user_info_tool
2025-05-30 17:11:45,497 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (get_user_info_tool)---
2025-05-30 17:11:45,500 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 17:11:45,500 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 17:11:45,525 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 17:11:45,528 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 17:11:46,612 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 17:11:46,942 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ’Ñ‹ ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ½Ğµ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ñ‹. Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ Ñ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ¾Ğ¼ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸.
2025-05-30 17:11:46,942 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 17:11:46,942 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 865, 'output_tokens': 19, 'total_tokens': 884, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 17:11:46,942 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:865 C:19 T:884
2025-05-30 17:11:46,942 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 884 tokens recorded.
2025-05-30 17:11:46,943 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 17:11:46,943 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 17:11:46,944 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ’Ñ‹ ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ½Ğµ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ñ‹. Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ Ñ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ¾Ğ¼ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸....
2025-05-30 17:11:46,946 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 9fb8e3a6-7879-4612-9e53-9d1bbaea8257, InteractionID: 1dd1e883-f915-4b0e-8f49-22200f64c5c0)
2025-05-30 17:11:46,946 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: 1dd1e883-f915-4b0e-8f49-22200f64c5c0.
2025-05-30 17:11:46,950 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '1dd1e883-f915-4b0e-8f49-22200f64c5c0', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '9fb8e3a6-7879-4612-9e53-9d1bbaea8257', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 816, 'completion_tokens': 12, 'total_tokens': 828, 'timestamp': '2025-05-30T12:11:45.496810+00:00'}
2025-05-30 17:11:46,950 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 1dd1e883-f915-4b0e-8f49-22200f64c5c0
2025-05-30 17:11:46,952 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1022 for interaction_id: 1dd1e883-f915-4b0e-8f49-22200f64c5c0 on attempt 1
2025-05-30 17:11:46,953 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 1dd1e883-f915-4b0e-8f49-22200f64c5c0, db_id: 1022
2025-05-30 17:11:46,957 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 1dd1e883-f915-4b0e-8f49-22200f64c5c0, db_id: 489
2025-05-30 17:11:46,962 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '1dd1e883-f915-4b0e-8f49-22200f64c5c0', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '9fb8e3a6-7879-4612-9e53-9d1bbaea8257', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 865, 'completion_tokens': 19, 'total_tokens': 884, 'timestamp': '2025-05-30T12:11:46.942744+00:00'}
2025-05-30 17:11:46,962 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 1dd1e883-f915-4b0e-8f49-22200f64c5c0
2025-05-30 17:11:46,963 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1022 for interaction_id: 1dd1e883-f915-4b0e-8f49-22200f64c5c0 on attempt 1
2025-05-30 17:11:46,967 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 1dd1e883-f915-4b0e-8f49-22200f64c5c0, db_id: 490
2025-05-30 17:15:37,113 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 17:15:37,123 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 17:20:37,406 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 17:20:37,416 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 17:25:37,763 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 17:25:37,772 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 17:30:38,151 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 17:30:38,161 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 17:35:38,521 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 17:35:38,532 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 17:40:38,877 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 17:40:38,887 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 17:45:39,245 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 17:45:39,256 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 17:50:19,367 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 17:50:19,367 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 17:50:19,368 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4406588768) received shutdown request. Initiating graceful shutdown...
2025-05-30 17:50:19,368 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4406588768)...
2025-05-30 17:50:19,368 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 17:50:19,368 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 17:50:19,368 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4406588768) was cancelled.
2025-05-30 17:50:19,369 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4406588768) stopping. Performing cleanup...
2025-05-30 17:50:19,369 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 17:50:19,368 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 17:50:19,369 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 17:50:19,370 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-30 17:50:19,370 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 17:50:19,370 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 17:50:19,370 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 17:50:19,370 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 17:50:19,370 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 17:50:19,371 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 17:50:19,371 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 17:50:19,378 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 17:50:19,379 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 17:50:19,379 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 17:50:19,379 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 17:50:19,379 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 17:50:19,379 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 17:50:19,379 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4406588768) cleanup complete.
2025-05-30 17:50:19,379 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 17:50:19,379 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 17:50:19,385 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 17:50:19,385 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 17:50:19,385 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 17:50:19,386 - INFO - __main__ - Agent runner main finished.
2025-05-30 17:50:19,395 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 17:50:19,626 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 17:50:19,626 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 17:50:19,626 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 17:50:19,627 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4435716352) received shutdown request. Initiating graceful shutdown...
2025-05-30 17:50:19,627 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4435716352)...
2025-05-30 17:50:19,627 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 17:50:19,627 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 17:50:19,627 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4435716352) was cancelled.
2025-05-30 17:50:19,627 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4435716352) stopping. Performing cleanup...
2025-05-30 17:50:19,627 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 17:50:19,627 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 17:50:19,627 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 17:50:19,627 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 17:50:19,627 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 17:50:19,628 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 17:50:19,628 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 17:50:19,628 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 17:50:19,628 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 17:50:19,629 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 17:50:19,634 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 17:50:19,635 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 17:50:19,636 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 17:50:19,636 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 17:50:19,636 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 17:50:19,636 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 17:50:19,636 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4435716352) cleanup complete.
2025-05-30 17:50:19,637 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 17:50:19,637 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 17:50:19,643 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 17:50:19,643 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 17:50:19,643 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 17:50:19,645 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 18:00:59,406 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 18:00:59,406 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 18:00:59,411 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 18:00:59,411 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 18:00:59,411 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 18:00:59,411 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 18:00:59,411 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 18:00:59,411 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 18:00:59,411 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 18:00:59,411 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 18:00:59,412 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 18:00:59,412 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 18:00:59,412 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 18:00:59,416 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 18:00:59,416 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 18:00:59,416 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 18:00:59,416 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 18:00:59,416 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 18:00:59,432 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 18:00:59,432 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 18:00:59,434 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 18:00:59,434 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4416310544) setup complete. Starting run loop.
2025-05-30 18:00:59,434 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 18:00:59,435 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 18:00:59,436 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 18:00:59,436 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4416321824) setup complete. Starting run loop.
2025-05-30 18:00:59,436 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 18:00:59,437 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 18:00:59,437 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 18:00:59,471 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 18:00:59,471 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 18:00:59,473 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 18:00:59,474 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 87203
2025-05-30 18:00:59,474 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 87203
2025-05-30 18:00:59,475 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 18:00:59,475 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 18:00:59,475 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 18:00:59,477 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 18:00:59,477 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 87204
2025-05-30 18:00:59,477 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 87204
2025-05-30 18:00:59,478 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 18:00:59,478 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 18:00:59,479 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 18:00:59,479 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 18:00:59,479 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 18:01:00,397 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 18:01:00,398 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 18:01:00,398 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 18:01:00,398 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 18:01:00,398 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 87204
2025-05-30 18:01:00,398 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 18:01:00,398 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 18:01:00,398 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 18:01:00,405 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 18:01:00,419 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 18:01:00,419 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 18:01:00,419 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 18:01:00,419 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4627294368) setup complete. Starting run loop.
2025-05-30 18:01:00,419 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 18:01:00,419 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 18:01:00,419 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 18:01:00,419 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 18:01:00,419 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 18:01:00,419 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 18:01:00,419 - INFO - aiogram.dispatcher - Start polling
2025-05-30 18:01:00,424 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 18:01:00,671 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 18:01:00,797 - INFO - app.api.routers.sse_api - SSE connection requested for agent agent_airsoft_0faa9616, thread 9fb8e3a6-7879-4612-9e53-9d1bbaea8257
2025-05-30 18:01:00,842 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 18:01:00,843 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 18:01:00,843 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 18:01:00,843 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 18:01:00,843 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 87203
2025-05-30 18:01:00,843 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 18:01:00,843 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 18:01:00,843 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 18:01:00,895 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 18:01:00,895 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 18:01:00,954 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 18:01:00,954 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 18:01:00,955 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 18:01:00,955 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 18:01:00,955 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 18:01:00,955 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 18:01:00,982 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 18:01:00,982 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 18:01:00,982 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 18:01:00,983 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 18:01:00,984 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET)
2025-05-30 18:01:00,984 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 18:01:00,984 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 18:01:01,043 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 18:01:01,049 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 18:01:02,041 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 18:01:02,046 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 18:01:02,047 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: kb_retriever_5_6_7) for datasources: ['5', '6', '7'] with description: Airsoft datastore description
2025-05-30 18:01:02,047 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 18:01:02,047 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'airsoft-rus.ru' (ID: webSearch-1748459212676) with description: ĞŸĞ¾Ğ¸ÑĞº Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ ÑÑ‚Ñ€Ğ°Ğ¹ĞºĞ±Ğ¾Ğ»Ñƒ Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼ Ğ´Ğ»Ñ ÑÑ‚Ñ€Ğ°Ğ¹ĞºĞ±Ğ¾Ğ»Ğ° Ğ½Ğ° ÑĞ°Ğ¹Ñ‚Ğµ.
2025-05-30 18:01:02,047 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 18:01:02,047 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 18:01:02,047 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 18:01:02,047 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 18:01:02,047 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 18:01:02,048 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 18:01:02,048 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 18:01:02,048 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 18:01:02,048 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 18:01:02,048 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 18:01:02,048 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 18:01:02,059 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 18:01:02,059 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 18:01:02,059 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 18:01:02,059 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4451300800) setup complete. Starting run loop.
2025-05-30 18:01:02,059 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 18:01:02,059 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 18:01:02,059 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 18:01:02,059 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 18:01:02,063 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 18:01:09,437 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 18:01:09,443 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 18:01:09,443 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4416321872) setup complete. Starting run loop.
2025-05-30 18:01:09,443 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 18:02:18,869 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 18:02:18,869 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 18:02:18,870 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4451300800) received shutdown request. Initiating graceful shutdown...
2025-05-30 18:02:18,870 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4451300800)...
2025-05-30 18:02:18,870 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 18:02:18,870 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 18:02:18,870 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4451300800) was cancelled.
2025-05-30 18:02:18,870 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4451300800) stopping. Performing cleanup...
2025-05-30 18:02:18,870 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 18:02:18,870 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 18:02:18,870 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 18:02:18,871 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 0) on start/restart.
2025-05-30 18:02:18,871 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 18:02:18,871 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 18:02:18,871 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 18:02:18,871 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 18:02:18,871 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 18:02:18,871 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 18:02:18,871 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 18:02:18,876 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 18:02:18,876 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 18:02:18,876 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 18:02:18,877 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 18:02:18,877 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 18:02:18,877 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 18:02:18,877 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4451300800) cleanup complete.
2025-05-30 18:02:18,877 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 18:02:18,877 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 18:02:18,877 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 18:02:18,877 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 18:02:18,877 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 18:02:18,877 - INFO - __main__ - Agent runner main finished.
2025-05-30 18:02:19,121 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 18:02:19,122 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 18:02:19,122 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 18:02:19,122 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4627294368) received shutdown request. Initiating graceful shutdown...
2025-05-30 18:02:19,122 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4627294368)...
2025-05-30 18:02:19,122 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 18:02:19,122 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 18:02:19,122 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4627294368) was cancelled.
2025-05-30 18:02:19,122 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4627294368) stopping. Performing cleanup...
2025-05-30 18:02:19,122 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 18:02:19,122 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 18:02:19,122 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 18:02:19,122 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 18:02:19,122 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 18:02:19,122 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 18:02:19,122 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 18:02:19,122 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 18:02:19,122 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 18:02:19,122 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 18:02:19,125 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 18:02:19,126 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 18:02:19,126 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 18:02:19,127 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 18:02:19,127 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 18:02:19,127 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 18:02:19,127 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4627294368) cleanup complete.
2025-05-30 18:02:19,127 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 18:02:19,127 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 18:02:19,127 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 18:02:19,127 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 18:02:19,127 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 18:02:19,127 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 18:02:23,573 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 18:02:23,573 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 18:02:23,577 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 18:02:23,577 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 18:02:23,577 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 18:02:23,577 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 18:02:23,577 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 18:02:23,577 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 18:02:23,578 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 18:02:23,578 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 18:02:23,578 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 18:02:23,578 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 18:02:23,578 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 18:02:23,580 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 18:02:23,580 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 18:02:23,580 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 18:02:23,596 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 18:02:23,596 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 18:02:23,596 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 18:02:23,596 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 18:02:23,597 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 18:02:23,597 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4606102128) setup complete. Starting run loop.
2025-05-30 18:02:23,597 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 18:02:23,599 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 18:02:23,599 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 18:02:23,599 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4606113744) setup complete. Starting run loop.
2025-05-30 18:02:23,599 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 18:02:23,610 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 18:02:23,610 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 18:02:23,630 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 18:02:23,630 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 18:02:23,632 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 18:02:23,633 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 87329
2025-05-30 18:02:23,633 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 87329
2025-05-30 18:02:23,633 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 18:02:23,633 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 18:02:23,633 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 18:02:23,635 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 18:02:23,636 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 87330
2025-05-30 18:02:23,636 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 87330
2025-05-30 18:02:23,636 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 18:02:23,637 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 18:02:23,637 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 18:02:23,637 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 18:02:23,637 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 18:02:24,545 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 18:02:24,546 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 18:02:24,546 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 18:02:24,546 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 18:02:24,546 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 87330
2025-05-30 18:02:24,546 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 18:02:24,546 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 18:02:24,546 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 18:02:24,550 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 18:02:24,563 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 18:02:24,563 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 18:02:24,563 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 18:02:24,563 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4389742944) setup complete. Starting run loop.
2025-05-30 18:02:24,564 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 18:02:24,564 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 18:02:24,564 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 18:02:24,564 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 18:02:24,564 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 18:02:24,564 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 18:02:24,564 - INFO - aiogram.dispatcher - Start polling
2025-05-30 18:02:24,566 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 18:02:24,807 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 18:02:24,843 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 18:02:24,844 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 18:02:24,844 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 18:02:24,844 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 18:02:24,844 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 87329
2025-05-30 18:02:24,844 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 18:02:24,844 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 18:02:24,844 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 18:02:24,885 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 18:02:24,885 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 18:02:24,926 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 18:02:24,926 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 18:02:24,926 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 18:02:24,926 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 18:02:24,926 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 18:02:24,926 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 18:02:24,951 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 18:02:24,951 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 18:02:24,951 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 18:02:24,952 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 18:02:24,953 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET)
2025-05-30 18:02:24,953 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 18:02:24,953 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 18:02:25,008 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 18:02:25,010 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 18:02:26,893 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 18:02:26,895 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 18:02:26,895 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'airsoft' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7'] with description: Airsoft datastore description
2025-05-30 18:02:26,895 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 18:02:26,896 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'airsoft-rus.ru' (ID: webSearch-1748459212676) with description: ĞŸĞ¾Ğ¸ÑĞº Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ ÑÑ‚Ñ€Ğ°Ğ¹ĞºĞ±Ğ¾Ğ»Ñƒ Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼ Ğ´Ğ»Ñ ÑÑ‚Ñ€Ğ°Ğ¹ĞºĞ±Ğ¾Ğ»Ğ° Ğ½Ğ° ÑĞ°Ğ¹Ñ‚Ğµ.
2025-05-30 18:02:26,896 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 18:02:26,896 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 18:02:26,896 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 18:02:26,896 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 18:02:26,897 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 18:02:26,897 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 18:02:26,897 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 18:02:26,897 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 18:02:26,897 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 18:02:26,897 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 18:02:26,897 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 18:02:26,921 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 18:02:26,921 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 18:02:26,921 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 18:02:26,921 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4663506224) setup complete. Starting run loop.
2025-05-30 18:02:26,921 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 18:02:26,921 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 18:02:26,921 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 18:02:26,921 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 18:02:26,924 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 18:02:26,973 - INFO - app.api.routers.sse_api - SSE connection requested for agent agent_airsoft_0faa9616, thread 9fb8e3a6-7879-4612-9e53-9d1bbaea8257
2025-05-30 18:02:33,612 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 18:02:33,617 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 18:02:33,617 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4606114128) setup complete. Starting run loop.
2025-05-30 18:02:33,617 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 18:03:40,334 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 18:03:40,334 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 18:03:40,335 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4663506224) received shutdown request. Initiating graceful shutdown...
2025-05-30 18:03:40,335 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4663506224)...
2025-05-30 18:03:40,335 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 18:03:40,335 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 18:03:40,335 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4663506224) was cancelled.
2025-05-30 18:03:40,335 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 18:03:40,335 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4663506224) stopping. Performing cleanup...
2025-05-30 18:03:40,335 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 18:03:40,335 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 18:03:40,336 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 0) on start/restart.
2025-05-30 18:03:40,336 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 18:03:40,337 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 18:03:40,337 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 18:03:40,337 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 18:03:40,337 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 18:03:40,337 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 18:03:40,337 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 18:03:40,342 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 18:03:40,343 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 18:03:40,343 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 18:03:40,343 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 18:03:40,343 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 18:03:40,343 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 18:03:40,343 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4663506224) cleanup complete.
2025-05-30 18:03:40,343 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 18:03:40,343 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 18:03:40,343 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 18:03:40,343 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 18:03:40,343 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 18:03:40,343 - INFO - __main__ - Agent runner main finished.
2025-05-30 18:03:40,586 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 18:03:40,586 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 18:03:40,586 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 18:03:40,586 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4389742944) received shutdown request. Initiating graceful shutdown...
2025-05-30 18:03:40,586 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4389742944)...
2025-05-30 18:03:40,586 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 18:03:40,586 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 18:03:40,586 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4389742944) was cancelled.
2025-05-30 18:03:40,586 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4389742944) stopping. Performing cleanup...
2025-05-30 18:03:40,586 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 18:03:40,586 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 18:03:40,586 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 18:03:40,586 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 18:03:40,586 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 18:03:40,587 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 18:03:40,587 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 18:03:40,587 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 18:03:40,587 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 18:03:40,587 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 18:03:40,591 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 18:03:40,592 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 18:03:40,592 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 18:03:40,592 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 18:03:40,593 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 18:03:40,593 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 18:03:40,593 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4389742944) cleanup complete.
2025-05-30 18:03:40,593 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 18:03:40,593 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 18:03:40,593 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 18:03:40,593 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 18:03:40,593 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 18:03:40,593 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 18:03:44,628 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 18:03:44,628 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 18:03:44,632 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 18:03:44,632 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 18:03:44,632 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 18:03:44,632 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 18:03:44,632 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 18:03:44,632 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 18:03:44,632 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 18:03:44,632 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 18:03:44,633 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 18:03:44,633 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 18:03:44,633 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 18:03:44,634 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 18:03:44,649 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 18:03:44,649 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 18:03:44,649 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 18:03:44,649 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 18:03:44,649 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 18:03:44,649 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 18:03:44,654 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 18:03:44,654 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4376042656) setup complete. Starting run loop.
2025-05-30 18:03:44,654 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 18:03:44,655 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 18:03:44,656 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 18:03:44,656 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4384112864) setup complete. Starting run loop.
2025-05-30 18:03:44,656 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 18:03:44,657 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 18:03:44,657 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 18:03:44,685 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 18:03:44,685 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 18:03:44,687 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 18:03:44,688 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 87479
2025-05-30 18:03:44,688 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 87479
2025-05-30 18:03:44,688 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 18:03:44,688 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 18:03:44,688 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 18:03:44,690 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 18:03:44,690 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 87480
2025-05-30 18:03:44,690 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 87480
2025-05-30 18:03:44,691 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 18:03:44,692 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 18:03:44,692 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 18:03:44,692 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 18:03:44,692 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 18:03:45,553 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 18:03:45,553 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 18:03:45,553 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 18:03:45,553 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 18:03:45,553 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 87480
2025-05-30 18:03:45,553 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 18:03:45,553 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 18:03:45,553 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 18:03:45,559 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 18:03:45,572 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 18:03:45,572 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 18:03:45,572 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 18:03:45,572 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4753058720) setup complete. Starting run loop.
2025-05-30 18:03:45,572 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 18:03:45,572 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 18:03:45,572 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 18:03:45,572 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 18:03:45,572 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 18:03:45,572 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 18:03:45,573 - INFO - aiogram.dispatcher - Start polling
2025-05-30 18:03:45,575 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 18:03:45,816 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 18:03:45,865 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 18:03:45,865 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 18:03:45,865 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 18:03:45,865 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 18:03:45,865 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 87479
2025-05-30 18:03:45,865 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 18:03:45,865 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 18:03:45,865 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 18:03:45,910 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 18:03:45,910 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 18:03:45,948 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 18:03:45,948 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 18:03:45,948 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 18:03:45,948 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 18:03:45,948 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 18:03:45,949 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 18:03:45,974 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 18:03:45,974 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 18:03:45,974 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 18:03:45,975 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET) wirh description: ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ±Ğ»Ğ¾Ğ³Ğ°)
2025-05-30 18:03:45,976 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET) wirh description: Ğ£Ğ·Ğ½Ğ°Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² (Ğ±Ğ±) Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.)
2025-05-30 18:03:45,976 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 18:03:45,976 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 18:03:46,029 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 18:03:46,033 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 18:03:46,848 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 18:03:46,851 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 18:03:46,851 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'airsoft' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7'] with description: Airsoft datastore description
2025-05-30 18:03:46,851 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 18:03:46,851 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'airsoft-rus.ru' (ID: webSearch-1748459212676) with description: ĞŸĞ¾Ğ¸ÑĞº Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ ÑÑ‚Ñ€Ğ°Ğ¹ĞºĞ±Ğ¾Ğ»Ñƒ Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼ Ğ´Ğ»Ñ ÑÑ‚Ñ€Ğ°Ğ¹ĞºĞ±Ğ¾Ğ»Ğ° Ğ½Ğ° ÑĞ°Ğ¹Ñ‚Ğµ.
2025-05-30 18:03:46,851 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 18:03:46,851 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 18:03:46,851 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 18:03:46,851 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 18:03:46,852 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 18:03:46,852 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 18:03:46,852 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 18:03:46,852 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 18:03:46,852 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 18:03:46,852 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 18:03:46,852 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 18:03:46,862 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 18:03:46,862 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 18:03:46,862 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 18:03:46,862 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4756059392) setup complete. Starting run loop.
2025-05-30 18:03:46,862 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 18:03:46,863 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 18:03:46,863 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 18:03:46,863 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 18:03:46,866 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 18:03:48,454 - INFO - app.api.routers.sse_api - SSE connection requested for agent agent_airsoft_0faa9616, thread 9fb8e3a6-7879-4612-9e53-9d1bbaea8257
2025-05-30 18:03:54,657 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 18:03:54,662 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 18:03:54,662 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4384112912) setup complete. Starting run loop.
2025-05-30 18:03:54,663 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 18:08:54,864 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 18:08:54,873 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 18:13:55,075 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 18:13:55,084 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 18:14:08,250 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 18:14:08,250 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 18:14:08,251 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4756059392) received shutdown request. Initiating graceful shutdown...
2025-05-30 18:14:08,251 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4756059392)...
2025-05-30 18:14:08,251 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 18:14:08,251 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 18:14:08,251 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4756059392) was cancelled.
2025-05-30 18:14:08,251 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4756059392) stopping. Performing cleanup...
2025-05-30 18:14:08,251 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 18:14:08,251 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 18:14:08,251 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 18:14:08,253 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 0) on start/restart.
2025-05-30 18:14:08,253 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 18:14:08,253 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 18:14:08,253 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 18:14:08,253 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 18:14:08,253 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 18:14:08,253 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 18:14:08,253 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 18:14:08,258 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 18:14:08,259 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 18:14:08,259 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 18:14:08,259 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 18:14:08,259 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 18:14:08,259 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 18:14:08,259 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4756059392) cleanup complete.
2025-05-30 18:14:08,259 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 18:14:08,259 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 18:14:08,260 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 18:14:08,260 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 18:14:08,260 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 18:14:08,260 - INFO - __main__ - Agent runner main finished.
2025-05-30 18:14:08,503 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 18:14:08,503 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 18:14:08,503 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 18:14:08,503 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4753058720) received shutdown request. Initiating graceful shutdown...
2025-05-30 18:14:08,503 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4753058720)...
2025-05-30 18:14:08,503 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 18:14:08,503 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 18:14:08,503 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4753058720) was cancelled.
2025-05-30 18:14:08,503 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4753058720) stopping. Performing cleanup...
2025-05-30 18:14:08,503 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 18:14:08,503 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 18:14:08,503 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 18:14:08,503 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 18:14:08,503 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 18:14:08,503 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 18:14:08,503 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 18:14:08,503 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 18:14:08,503 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 18:14:08,503 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 18:14:08,509 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 18:14:08,510 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 18:14:08,510 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 18:14:08,510 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 18:14:08,510 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 18:14:08,510 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 18:14:08,510 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4753058720) cleanup complete.
2025-05-30 18:14:08,510 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 18:14:08,510 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 18:14:08,511 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 18:14:08,511 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 18:14:08,511 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 18:14:08,511 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 18:14:10,112 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 18:14:10,112 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 18:14:10,116 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 18:14:10,116 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 18:14:10,116 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 18:14:10,116 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 18:14:10,117 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 18:14:10,117 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 18:14:10,117 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 18:14:10,117 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 18:14:10,117 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 18:14:10,117 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 18:14:10,117 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 18:14:10,119 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 18:14:10,120 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 18:14:10,120 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 18:14:10,133 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 18:14:10,133 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 18:14:10,133 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 18:14:10,133 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 18:14:10,135 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 18:14:10,135 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4384719696) setup complete. Starting run loop.
2025-05-30 18:14:10,135 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 18:14:10,135 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 18:14:10,136 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 18:14:10,136 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4384719504) setup complete. Starting run loop.
2025-05-30 18:14:10,136 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 18:14:10,146 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 18:14:10,146 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 18:14:10,166 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 18:14:10,166 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 18:14:10,168 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 18:14:10,169 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 87713
2025-05-30 18:14:10,169 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 87713
2025-05-30 18:14:10,169 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 18:14:10,169 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 18:14:10,169 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 18:14:10,171 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 18:14:10,172 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 87714
2025-05-30 18:14:10,172 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 87714
2025-05-30 18:14:10,172 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 18:14:10,173 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 18:14:10,173 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 18:14:10,173 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 18:14:10,173 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 18:14:11,052 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 18:14:11,053 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 18:14:11,053 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 18:14:11,053 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 18:14:11,053 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 87714
2025-05-30 18:14:11,053 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 18:14:11,053 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 18:14:11,053 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 18:14:11,060 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 18:14:11,073 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 18:14:11,073 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 18:14:11,073 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 18:14:11,073 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4391626768) setup complete. Starting run loop.
2025-05-30 18:14:11,073 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 18:14:11,074 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 18:14:11,074 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 18:14:11,074 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 18:14:11,074 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 18:14:11,074 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 18:14:11,074 - INFO - aiogram.dispatcher - Start polling
2025-05-30 18:14:11,077 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 18:14:11,328 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 18:14:11,386 - INFO - app.api.routers.sse_api - SSE connection requested for agent agent_airsoft_0faa9616, thread 9fb8e3a6-7879-4612-9e53-9d1bbaea8257
2025-05-30 18:14:11,416 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 18:14:11,417 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 18:14:11,417 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 18:14:11,417 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 18:14:11,417 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 87713
2025-05-30 18:14:11,417 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 18:14:11,417 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 18:14:11,417 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 18:14:11,469 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 18:14:11,469 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 18:14:11,513 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 18:14:11,513 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 18:14:11,513 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 18:14:11,513 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 18:14:11,513 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 18:14:11,513 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 18:14:11,539 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 18:14:11,539 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 18:14:11,539 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 18:14:11,540 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET) wirh description: ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ±Ğ»Ğ¾Ğ³Ğ°)
2025-05-30 18:14:11,541 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET) wirh description: Ğ£Ğ·Ğ½Ğ°Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² (Ğ±Ğ±) Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.)
2025-05-30 18:14:11,541 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 18:14:11,541 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 18:14:11,597 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 18:14:11,602 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 18:14:12,237 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 18:14:12,240 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 18:14:12,241 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'airsoft' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7'] with description: Airsoft datastore description
2025-05-30 18:14:12,241 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 18:14:12,241 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'airsoft-rus.ru' (ID: webSearch-1748459212676) with description: ĞŸĞ¾Ğ¸ÑĞº Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ ÑÑ‚Ñ€Ğ°Ğ¹ĞºĞ±Ğ¾Ğ»Ñƒ Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼ Ğ´Ğ»Ñ ÑÑ‚Ñ€Ğ°Ğ¹ĞºĞ±Ğ¾Ğ»Ğ° Ğ½Ğ° ÑĞ°Ğ¹Ñ‚Ğµ.
2025-05-30 18:14:12,241 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 18:14:12,241 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 18:14:12,241 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 18:14:12,241 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 18:14:12,241 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 18:14:12,242 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 18:14:12,242 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 18:14:12,242 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 18:14:12,242 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->agent
2025-05-30 18:14:12,242 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 18:14:12,242 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 18:14:12,252 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 18:14:12,252 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 18:14:12,252 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 18:14:12,252 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4457362832) setup complete. Starting run loop.
2025-05-30 18:14:12,252 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 18:14:12,252 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 18:14:12,252 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 18:14:12,252 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 18:14:12,254 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 18:14:20,147 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 18:14:20,152 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 18:14:20,152 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4384719648) setup complete. Starting run loop.
2025-05-30 18:14:20,152 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 18:16:06,786 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-30 18:16:06,792 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-30 18:16:06,793 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-30 18:16:06,793 - INFO - app.db.crud.agent_crud - Updating agent config in DB for agent_id: agent_airsoft_0faa9616
2025-05-30 18:16:06,811 - INFO - app.db.crud.agent_crud - Agent config updated successfully for agent_id: agent_airsoft_0faa9616
2025-05-30 18:16:06,811 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616 was running. Attempting to restart it after config update.
2025-05-30 18:16:06,811 - INFO - app.services.process_manager - Restarting agent process for agent_airsoft_0faa9616...
2025-05-30 18:16:06,813 - INFO - app.services.process_manager - Stopping agent process agent_airsoft_0faa9616 (PID: 87713). Force: True
2025-05-30 18:16:06,813 - INFO - app.services.process_manager - SIGTERM sent to agent agent_airsoft_0faa9616 (PID: 87713)
2025-05-30 18:16:06,915 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 (PID: 87713) terminated gracefully after SIGTERM.
2025-05-30 18:16:06,917 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 marked as stopped in Redis.
2025-05-30 18:16:06,917 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 stopped (or stop attempted and assumed successful for restart). Pausing briefly...
2025-05-30 18:16:11,918 - INFO - app.services.process_manager - Proceeding to start agent agent_airsoft_0faa9616 after delay...
2025-05-30 18:16:11,920 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 18:16:11,922 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 87776
2025-05-30 18:16:11,922 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 87776
2025-05-30 18:16:11,922 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 successfully started as part of restart sequence.
2025-05-30 18:16:11,922 - INFO - app.api.routers.agent_api - Restart command issued for agent agent_airsoft_0faa9616 after config update.
2025-05-30 18:16:11,922 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 18:16:11,923 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 18:16:13,285 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 18:16:13,285 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 18:16:13,285 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 18:16:13,285 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 18:16:13,285 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 87776
2025-05-30 18:16:13,285 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 18:16:13,285 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 18:16:13,286 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 18:16:13,327 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 18:16:13,327 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 18:16:13,364 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 18:16:13,364 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 18:16:13,364 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 18:16:13,364 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 18:16:13,364 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 18:16:13,364 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 18:16:13,390 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 18:16:13,390 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 18:16:13,390 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 18:16:13,391 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET) wirh description: ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ±Ğ»Ğ¾Ğ³Ğ°)
2025-05-30 18:16:13,392 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET) wirh description: Ğ£Ğ·Ğ½Ğ°Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² (Ğ±Ğ±) Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.)
2025-05-30 18:16:13,392 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 18:16:13,392 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 18:16:13,448 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 18:16:13,451 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 18:16:14,514 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 18:16:14,517 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 18:16:14,518 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'airsoft' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7'] with description: Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ 1Ñ
2025-05-30 18:16:14,518 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 18:16:14,518 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'airsoft-rus.ru' (ID: webSearch-1748459212676) with description: ĞŸĞ¾Ğ¸ÑĞº Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ ÑÑ‚Ñ€Ğ°Ğ¹ĞºĞ±Ğ¾Ğ»Ñƒ Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼ Ğ´Ğ»Ñ ÑÑ‚Ñ€Ğ°Ğ¹ĞºĞ±Ğ¾Ğ»Ğ° Ğ½Ğ° ÑĞ°Ğ¹Ñ‚Ğµ.
2025-05-30 18:16:14,518 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 18:16:14,518 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 18:16:14,518 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 18:16:14,518 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 18:16:14,518 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 18:16:14,519 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 18:16:14,519 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 18:16:14,519 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 18:16:14,519 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->agent
2025-05-30 18:16:14,519 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 18:16:14,519 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 18:16:14,529 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 18:16:14,529 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 18:16:14,529 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 18:16:14,529 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4784354896) setup complete. Starting run loop.
2025-05-30 18:16:14,529 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 18:16:14,529 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 18:16:14,529 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 18:16:14,529 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 18:16:14,533 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 18:19:20,339 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 18:19:20,348 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 18:23:09,294 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ñ ÑƒÑ‚1...'
2025-05-30 18:23:09,296 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache miss for user 144641834, agent agent_airsoft_0faa9616. Checking DB.
2025-05-30 18:23:09,395 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - User 144641834 (DBID: 1) IS authorized for agent agent_airsoft_0faa9616 via DB.
2025-05-30 18:23:09,399 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 18:23:09,399 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 18:23:09,399 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 18:23:09,400 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 3ced9f00-8bb3-4b48-87f6-ef2e5237ada2)
2025-05-30 18:23:09,400 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 18:23:09,400 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-30 18:23:09,431 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 3ced9f00-8bb3-4b48-87f6-ef2e5237ada2, db_id: 1023
2025-05-30 18:23:09,450 - INFO - AGENT:agent_airsoft_0faa9616 - Loaded 20 messages from DB for thread '144641834'.
2025-05-30 18:23:09,450 - INFO - AGENT:agent_airsoft_0faa9616 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-30 18:23:09,450 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-30 18:23:09,519 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 18:23:09,520 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 18:23:09,544 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 18:23:09,548 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 18:23:10,399 - INFO - aiogram.event - Update id=804756353 is handled. Duration 1105 ms by bot id=1750613938
2025-05-30 18:23:11,078 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 18:23:12,310 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 18:23:12,310 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 18:23:12,310 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1112, 'output_tokens': 36, 'total_tokens': 1148, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 18:23:12,310 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1112 C:36 T:1148
2025-05-30 18:23:12,310 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1148 tokens recorded.
2025-05-30 18:23:12,311 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 18:23:12,311 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: knowledgeBase-1748440512419
2025-05-30 18:23:12,311 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO RETRIEVE (knowledgeBase-1748440512419)---
2025-05-30 18:23:13,947 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 18:23:13,961 - INFO - httpx - HTTP Request: POST http://127.0.0.1:6333/collections/platformai/points/query "HTTP/1.1 200 OK"
2025-05-30 18:23:13,964 - INFO - AGENT:agent_airsoft_0faa9616 - ---CHECK RELEVANCE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 18:23:13,964 - INFO - AGENT:agent_airsoft_0faa9616 - Grading documents for question: 'Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ñ ÑƒÑ‚11?'
2025-05-30 18:23:13,964 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.0, streaming: False
2025-05-30 18:23:13,988 - INFO - AGENT:agent_airsoft_0faa9616 - Created grading LLM: gpt-4.1-mini via OpenAI
2025-05-30 18:23:15,276 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 18:23:15,291 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:916 C:6 T:922
2025-05-30 18:23:15,291 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for grading_llm: 922 tokens recorded.
2025-05-30 18:23:15,291 - INFO - AGENT:agent_airsoft_0faa9616 - Total token usage for grading_llm batch: 922 tokens.
2025-05-30 18:23:15,291 - INFO - AGENT:agent_airsoft_0faa9616 - Found 1 relevant documents out of 1 initial (after split).
2025-05-30 18:23:15,291 - INFO - AGENT:agent_airsoft_0faa9616 - ---ASSESS GRADED DOCUMENTS---
2025-05-30 18:23:15,291 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: RELEVANT DOCUMENTS FOUND, GENERATE---
2025-05-30 18:23:15,292 - INFO - AGENT:agent_airsoft_0faa9616 - ---GENERATE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 18:23:15,292 - INFO - AGENT:agent_airsoft_0faa9616 - Generating answer for question: 'Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ñ ÑƒÑ‚11?' using 1 documents.
2025-05-30 18:23:15,292 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 18:23:15,317 - INFO - AGENT:agent_airsoft_0faa9616 - Created generate LLM: gpt-4.1-mini via OpenAI
2025-05-30 18:23:22,138 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 18:23:24,750 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:885 C:81 T:966
2025-05-30 18:23:24,750 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for generation_llm: 966 tokens recorded.
2025-05-30 18:23:24,751 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 18:23:24,752 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 18:23:24,776 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 18:23:24,779 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 18:23:26,542 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 18:23:27,782 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ”Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ğ¡ Ğ£Ğ¢11 Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ¸Ğ· 4-5 Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ². Ğ•ÑĞ»Ğ¸ Ñƒ Ğ²Ğ°Ñ Ğ²ÑĞµĞ³Ğ¾ 2 Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸Ñ
2025-05-30 18:23:27,782 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 18:23:27,782 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1990, 'output_tokens': 98, 'total_tokens': 2088, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 18:23:27,782 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1990 C:98 T:2088
2025-05-30 18:23:27,782 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 2088 tokens recorded.
2025-05-30 18:23:27,783 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 18:23:27,783 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 18:23:27,784 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ”Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ğ¡ Ğ£Ğ¢11 Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ¸Ğ· 4-5 Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ². Ğ•ÑĞ»Ğ¸ Ñƒ Ğ²Ğ°Ñ Ğ²ÑĞµĞ³Ğ¾ 2 Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸Ñ...
2025-05-30 18:23:27,785 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 3ced9f00-8bb3-4b48-87f6-ef2e5237ada2)
2025-05-30 18:23:27,786 - INFO - AGENT:agent_airsoft_0faa9616 - Found 4 token usage events for InteractionID: 3ced9f00-8bb3-4b48-87f6-ef2e5237ada2.
2025-05-30 18:23:27,789 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Ğ”Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ğ¡ Ğ£Ğ¢11 Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ¸Ğ· 4-5 Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ². Ğ•ÑĞ»Ğ¸ Ñƒ Ğ²Ğ°Ñ Ğ²ÑĞµĞ³Ğ¾ 2 Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸Ñ...
2025-05-30 18:23:27,789 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Ğ”Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ğ¡ Ğ£Ğ¢11 Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ¸...'
2025-05-30 18:23:27,791 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '3ced9f00-8bb3-4b48-87f6-ef2e5237ada2', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1990, 'completion_tokens': 98, 'total_tokens': 2088, 'timestamp': '2025-05-30T13:23:27.782781+00:00'}
2025-05-30 18:23:27,791 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 3ced9f00-8bb3-4b48-87f6-ef2e5237ada2
2025-05-30 18:23:27,794 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 3ced9f00-8bb3-4b48-87f6-ef2e5237ada2, db_id: 1024
2025-05-30 18:23:27,823 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1024 for interaction_id: 3ced9f00-8bb3-4b48-87f6-ef2e5237ada2 on attempt 1
2025-05-30 18:23:27,828 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 3ced9f00-8bb3-4b48-87f6-ef2e5237ada2, db_id: 491
2025-05-30 18:23:27,831 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '3ced9f00-8bb3-4b48-87f6-ef2e5237ada2', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'generation_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 885, 'completion_tokens': 81, 'total_tokens': 966, 'timestamp': '2025-05-30T13:23:24.750869+00:00'}
2025-05-30 18:23:27,831 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 3ced9f00-8bb3-4b48-87f6-ef2e5237ada2
2025-05-30 18:23:27,832 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1024 for interaction_id: 3ced9f00-8bb3-4b48-87f6-ef2e5237ada2 on attempt 1
2025-05-30 18:23:27,835 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 3ced9f00-8bb3-4b48-87f6-ef2e5237ada2, db_id: 492
2025-05-30 18:23:27,837 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '3ced9f00-8bb3-4b48-87f6-ef2e5237ada2', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'grading_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 916, 'completion_tokens': 6, 'total_tokens': 922, 'timestamp': '2025-05-30T13:23:15.291071+00:00'}
2025-05-30 18:23:27,837 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 3ced9f00-8bb3-4b48-87f6-ef2e5237ada2
2025-05-30 18:23:27,838 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1024 for interaction_id: 3ced9f00-8bb3-4b48-87f6-ef2e5237ada2 on attempt 1
2025-05-30 18:23:27,840 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 3ced9f00-8bb3-4b48-87f6-ef2e5237ada2, db_id: 493
2025-05-30 18:23:27,842 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '3ced9f00-8bb3-4b48-87f6-ef2e5237ada2', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1112, 'completion_tokens': 36, 'total_tokens': 1148, 'timestamp': '2025-05-30T13:23:12.310408+00:00'}
2025-05-30 18:23:27,842 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 3ced9f00-8bb3-4b48-87f6-ef2e5237ada2
2025-05-30 18:23:27,843 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1024 for interaction_id: 3ced9f00-8bb3-4b48-87f6-ef2e5237ada2 on attempt 1
2025-05-30 18:23:27,845 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 3ced9f00-8bb3-4b48-87f6-ef2e5237ada2, db_id: 494
2025-05-30 18:24:20,561 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 18:24:20,570 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 18:29:20,755 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 18:29:20,763 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 18:33:13,035 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² 1Ñ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ñ‡Ñ‚Ğ¾-Ğ±Ñ‹ Ğ²ĞºÑ€ÑƒÑ‚Ğ¸Ñ‚ÑŒ Ğ»Ğ°Ğ¼...'
2025-05-30 18:33:13,037 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 18:33:13,043 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 18:33:13,043 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 18:33:13,043 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 18:33:13,045 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: efe325e8-7c41-4391-8b93-3e5a084e9225)
2025-05-30 18:33:13,045 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 18:33:13,046 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 18:33:13,046 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 18:33:13,053 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 18:33:13,054 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 18:33:13,068 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: efe325e8-7c41-4391-8b93-3e5a084e9225, db_id: 1025
2025-05-30 18:33:13,086 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 18:33:13,092 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 18:33:14,044 - INFO - aiogram.event - Update id=804756354 is handled. Duration 1009 ms by bot id=1750613938
2025-05-30 18:33:14,638 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 18:33:16,286 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: ĞĞ¹, ĞºĞ»Ğ°ÑÑĞ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ! ğŸ˜„ Ğ”Ğ»Ñ Ğ²ĞºÑ€ÑƒÑ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ Ğ»Ğ°Ğ¼Ğ¿Ğ¾Ñ‡ĞºĞ¸ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚ 1Ğ¡, ĞºĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾, Ğ½Ğµ Ğ½ÑƒĞ¶ĞµĞ½ â€” ÑÑ‚Ğ¾ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° Ğ´
2025-05-30 18:33:16,286 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 18:33:16,286 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 2115, 'output_tokens': 84, 'total_tokens': 2199, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 18:33:16,286 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:2115 C:84 T:2199
2025-05-30 18:33:16,286 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 2199 tokens recorded.
2025-05-30 18:33:16,287 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 18:33:16,287 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 18:33:16,288 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: ĞĞ¹, ĞºĞ»Ğ°ÑÑĞ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ! ğŸ˜„ Ğ”Ğ»Ñ Ğ²ĞºÑ€ÑƒÑ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ Ğ»Ğ°Ğ¼Ğ¿Ğ¾Ñ‡ĞºĞ¸ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚ 1Ğ¡, ĞºĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾, Ğ½Ğµ Ğ½ÑƒĞ¶ĞµĞ½ â€” ÑÑ‚Ğ¾ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° Ğ´...
2025-05-30 18:33:16,290 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: efe325e8-7c41-4391-8b93-3e5a084e9225)
2025-05-30 18:33:16,290 - INFO - AGENT:agent_airsoft_0faa9616 - Found 1 token usage events for InteractionID: efe325e8-7c41-4391-8b93-3e5a084e9225.
2025-05-30 18:33:16,292 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: ĞĞ¹, ĞºĞ»Ğ°ÑÑĞ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ! ğŸ˜„ Ğ”Ğ»Ñ Ğ²ĞºÑ€ÑƒÑ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ Ğ»Ğ°Ğ¼Ğ¿Ğ¾Ñ‡ĞºĞ¸ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚ 1Ğ¡, ĞºĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾, Ğ½Ğµ Ğ½ÑƒĞ¶ĞµĞ½ â€” ÑÑ‚Ğ¾ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° Ğ´...
2025-05-30 18:33:16,293 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'ĞĞ¹, ĞºĞ»Ğ°ÑÑĞ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ! ğŸ˜„ Ğ”Ğ»Ñ Ğ²ĞºÑ€ÑƒÑ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ Ğ»Ğ°Ğ¼Ğ¿Ğ¾Ñ‡Ğº...'
2025-05-30 18:33:16,295 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'efe325e8-7c41-4391-8b93-3e5a084e9225', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 2115, 'completion_tokens': 84, 'total_tokens': 2199, 'timestamp': '2025-05-30T13:33:16.286817+00:00'}
2025-05-30 18:33:16,295 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: efe325e8-7c41-4391-8b93-3e5a084e9225
2025-05-30 18:33:16,299 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: efe325e8-7c41-4391-8b93-3e5a084e9225, db_id: 1026
2025-05-30 18:33:16,300 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1026 for interaction_id: efe325e8-7c41-4391-8b93-3e5a084e9225 on attempt 1
2025-05-30 18:33:16,305 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: efe325e8-7c41-4391-8b93-3e5a084e9225, db_id: 495
2025-05-30 18:34:20,968 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 18:34:20,977 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 18:34:29,310 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹...'
2025-05-30 18:34:29,311 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 18:34:29,314 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 18:34:29,314 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 18:34:29,314 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 18:34:29,314 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 40ed77f9-d468-44f3-b833-1d176a9a0418)
2025-05-30 18:34:29,315 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 18:34:29,315 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 18:34:29,315 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 18:34:29,318 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 18:34:29,318 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 18:34:29,320 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 40ed77f9-d468-44f3-b833-1d176a9a0418, db_id: 1027
2025-05-30 18:34:29,343 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 18:34:29,346 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 18:34:30,314 - INFO - aiogram.event - Update id=804756355 is handled. Duration 1004 ms by bot id=1750613938
2025-05-30 18:34:30,620 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 18:34:30,906 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 18:34:30,906 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 18:34:30,906 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 2212, 'output_tokens': 37, 'total_tokens': 2249, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 18:34:30,906 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:2212 C:37 T:2249
2025-05-30 18:34:30,906 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 2249 tokens recorded.
2025-05-30 18:34:30,907 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 18:34:30,907 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: knowledgeBase-1748440512419
2025-05-30 18:34:30,907 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO RETRIEVE (knowledgeBase-1748440512419)---
2025-05-30 18:34:31,427 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 18:34:31,442 - INFO - httpx - HTTP Request: POST http://127.0.0.1:6333/collections/platformai/points/query "HTTP/1.1 200 OK"
2025-05-30 18:34:31,444 - INFO - AGENT:agent_airsoft_0faa9616 - ---CHECK RELEVANCE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 18:34:31,445 - INFO - AGENT:agent_airsoft_0faa9616 - Grading documents for question: 'ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹'
2025-05-30 18:34:31,445 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.0, streaming: False
2025-05-30 18:34:31,468 - INFO - AGENT:agent_airsoft_0faa9616 - Created grading LLM: gpt-4.1-mini via OpenAI
2025-05-30 18:34:32,770 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 18:34:32,781 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:904 C:6 T:910
2025-05-30 18:34:32,781 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for grading_llm: 910 tokens recorded.
2025-05-30 18:34:32,781 - INFO - AGENT:agent_airsoft_0faa9616 - Total token usage for grading_llm batch: 910 tokens.
2025-05-30 18:34:32,781 - INFO - AGENT:agent_airsoft_0faa9616 - Found 0 relevant documents out of 1 initial (after split).
2025-05-30 18:34:32,782 - INFO - AGENT:agent_airsoft_0faa9616 - ---ASSESS GRADED DOCUMENTS---
2025-05-30 18:34:32,782 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO RELEVANT DOCUMENTS, REWRITE---
2025-05-30 18:34:32,783 - INFO - AGENT:agent_airsoft_0faa9616 - ---TRANSFORM QUERY (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 18:34:32,783 - INFO - AGENT:agent_airsoft_0faa9616 - Rewrite attempt 1/3 for question: 'ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹'
2025-05-30 18:34:32,783 - INFO - AGENT:agent_airsoft_0faa9616 - Rewriting original question: ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹
2025-05-30 18:34:32,783 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: False
2025-05-30 18:34:32,807 - INFO - AGENT:agent_airsoft_0faa9616 - Created rewrite LLM: gpt-4.1-mini via OpenAI
2025-05-30 18:34:35,126 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 18:34:35,127 - INFO - AGENT:agent_airsoft_0faa9616 - Rewritten question: ĞŸĞ¾ĞºĞ°Ğ¶Ğ¸ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¸Ğ· Ğ±Ğ°Ğ·Ñ‹ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ¿Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ñƒ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² 1Ğ¡, Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ñ… Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° Ğ£Ğ¢11.
2025-05-30 18:34:35,127 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:4614 C:27 T:4641
2025-05-30 18:34:35,127 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for rewrite_llm: 4641 tokens recorded.
2025-05-30 18:34:35,128 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 18:34:35,128 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 18:34:35,152 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 18:34:35,155 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 18:34:36,764 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 18:34:37,947 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: ĞšĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾! Ğ’Ğ¾Ñ‚ Ğ¿ĞµÑ€ĞµÑ„Ğ¾Ñ€Ğ¼ÑƒĞ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ:

**ĞŸĞ¾ĞºĞ°Ğ¶Ğ¸ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¸Ğ· Ğ±Ğ°Ğ·Ñ‹ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ¿Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ñƒ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸
2025-05-30 18:34:37,947 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 18:34:37,947 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 3044, 'output_tokens': 54, 'total_tokens': 3098, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 18:34:37,947 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:3044 C:54 T:3098
2025-05-30 18:34:37,947 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 3098 tokens recorded.
2025-05-30 18:34:37,948 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 18:34:37,948 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 18:34:37,949 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: ĞšĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾! Ğ’Ğ¾Ñ‚ Ğ¿ĞµÑ€ĞµÑ„Ğ¾Ñ€Ğ¼ÑƒĞ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ:

**ĞŸĞ¾ĞºĞ°Ğ¶Ğ¸ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¸Ğ· Ğ±Ğ°Ğ·Ñ‹ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ¿Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ñƒ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸...
2025-05-30 18:34:37,951 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 40ed77f9-d468-44f3-b833-1d176a9a0418)
2025-05-30 18:34:37,952 - INFO - AGENT:agent_airsoft_0faa9616 - Found 4 token usage events for InteractionID: 40ed77f9-d468-44f3-b833-1d176a9a0418.
2025-05-30 18:34:37,954 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '40ed77f9-d468-44f3-b833-1d176a9a0418', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 2212, 'completion_tokens': 37, 'total_tokens': 2249, 'timestamp': '2025-05-30T13:34:30.906481+00:00'}
2025-05-30 18:34:37,955 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 40ed77f9-d468-44f3-b833-1d176a9a0418
2025-05-30 18:34:37,955 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: ĞšĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾! Ğ’Ğ¾Ñ‚ Ğ¿ĞµÑ€ĞµÑ„Ğ¾Ñ€Ğ¼ÑƒĞ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ:

**ĞŸĞ¾ĞºĞ°Ğ¶Ğ¸ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¸Ğ· Ğ±Ğ°Ğ·Ñ‹ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ¿Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ñƒ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸...
2025-05-30 18:34:37,955 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'ĞšĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾! Ğ’Ğ¾Ñ‚ Ğ¿ĞµÑ€ĞµÑ„Ğ¾Ñ€Ğ¼ÑƒĞ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ:

**ĞŸĞ¾ĞºĞ°Ğ¶Ğ¸...'
2025-05-30 18:34:37,957 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1027 for interaction_id: 40ed77f9-d468-44f3-b833-1d176a9a0418 on attempt 1
2025-05-30 18:34:37,958 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 40ed77f9-d468-44f3-b833-1d176a9a0418, db_id: 1028
2025-05-30 18:34:37,961 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 40ed77f9-d468-44f3-b833-1d176a9a0418, db_id: 496
2025-05-30 18:34:37,964 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '40ed77f9-d468-44f3-b833-1d176a9a0418', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 3044, 'completion_tokens': 54, 'total_tokens': 3098, 'timestamp': '2025-05-30T13:34:37.947611+00:00'}
2025-05-30 18:34:37,964 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 40ed77f9-d468-44f3-b833-1d176a9a0418
2025-05-30 18:34:37,965 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1028 for interaction_id: 40ed77f9-d468-44f3-b833-1d176a9a0418 on attempt 1
2025-05-30 18:34:37,968 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 40ed77f9-d468-44f3-b833-1d176a9a0418, db_id: 497
2025-05-30 18:34:37,972 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '40ed77f9-d468-44f3-b833-1d176a9a0418', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'rewrite_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 4614, 'completion_tokens': 27, 'total_tokens': 4641, 'timestamp': '2025-05-30T13:34:35.127565+00:00'}
2025-05-30 18:34:37,972 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 40ed77f9-d468-44f3-b833-1d176a9a0418
2025-05-30 18:34:37,973 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1028 for interaction_id: 40ed77f9-d468-44f3-b833-1d176a9a0418 on attempt 1
2025-05-30 18:34:37,976 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 40ed77f9-d468-44f3-b833-1d176a9a0418, db_id: 498
2025-05-30 18:34:37,978 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '40ed77f9-d468-44f3-b833-1d176a9a0418', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'grading_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 904, 'completion_tokens': 6, 'total_tokens': 910, 'timestamp': '2025-05-30T13:34:32.781797+00:00'}
2025-05-30 18:34:37,978 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 40ed77f9-d468-44f3-b833-1d176a9a0418
2025-05-30 18:34:37,980 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1028 for interaction_id: 40ed77f9-d468-44f3-b833-1d176a9a0418 on attempt 1
2025-05-30 18:34:37,982 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 40ed77f9-d468-44f3-b833-1d176a9a0418, db_id: 499
2025-05-30 18:39:21,165 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 18:39:21,173 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 18:44:21,355 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 18:44:21,364 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 18:44:55,071 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 18:44:55,071 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 18:44:55,072 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4784354896) received shutdown request. Initiating graceful shutdown...
2025-05-30 18:44:55,073 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4784354896)...
2025-05-30 18:44:55,073 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 18:44:55,073 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 18:44:55,073 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4784354896) was cancelled.
2025-05-30 18:44:55,073 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4784354896) stopping. Performing cleanup...
2025-05-30 18:44:55,073 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 18:44:55,073 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 18:44:55,073 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 18:44:55,075 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-30 18:44:55,075 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 18:44:55,075 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 18:44:55,075 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 18:44:55,075 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 18:44:55,075 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 18:44:55,075 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 18:44:55,075 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 18:44:55,080 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 18:44:55,081 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 18:44:55,081 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 18:44:55,081 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 18:44:55,081 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 18:44:55,081 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 18:44:55,081 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4784354896) cleanup complete.
2025-05-30 18:44:55,081 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 18:44:55,081 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 18:44:55,086 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 18:44:55,086 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 18:44:55,086 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 18:44:55,086 - INFO - __main__ - Agent runner main finished.
2025-05-30 18:44:55,324 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 18:44:55,324 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 18:44:55,324 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 18:44:55,325 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4391626768) received shutdown request. Initiating graceful shutdown...
2025-05-30 18:44:55,325 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4391626768)...
2025-05-30 18:44:55,325 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 18:44:55,325 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 18:44:55,325 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4391626768) was cancelled.
2025-05-30 18:44:55,325 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4391626768) stopping. Performing cleanup...
2025-05-30 18:44:55,325 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 18:44:55,325 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 18:44:55,325 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 18:44:55,325 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 18:44:55,325 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 18:44:55,325 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 18:44:55,325 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 18:44:55,325 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 18:44:55,325 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 18:44:55,325 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 18:44:55,329 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 18:44:55,330 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 18:44:55,330 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 18:44:55,330 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 18:44:55,330 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 18:44:55,330 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 18:44:55,330 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4391626768) cleanup complete.
2025-05-30 18:44:55,330 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 18:44:55,330 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 18:44:55,335 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 18:44:55,335 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 18:44:55,335 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 18:44:55,336 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 18:44:59,007 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 18:44:59,007 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 18:44:59,012 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 18:44:59,012 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 18:44:59,012 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 18:44:59,012 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 18:44:59,012 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 18:44:59,012 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 18:44:59,012 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 18:44:59,012 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 18:44:59,013 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 18:44:59,013 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 18:44:59,013 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 18:44:59,015 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 18:44:59,016 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 18:44:59,016 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 18:44:59,016 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 18:44:59,016 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 18:44:59,016 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 18:44:59,016 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 18:44:59,031 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 18:44:59,031 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4376028768) setup complete. Starting run loop.
2025-05-30 18:44:59,031 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 18:44:59,031 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 18:44:59,032 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 18:44:59,032 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4377705024) setup complete. Starting run loop.
2025-05-30 18:44:59,032 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 18:44:59,033 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 18:44:59,033 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 18:44:59,062 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 18:44:59,062 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 18:44:59,064 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 18:44:59,064 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 88254
2025-05-30 18:44:59,064 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 88254
2025-05-30 18:44:59,065 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 18:44:59,065 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 18:44:59,065 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 18:44:59,067 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 18:44:59,067 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 88255
2025-05-30 18:44:59,067 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 88255
2025-05-30 18:44:59,068 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 18:44:59,068 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 18:44:59,068 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 18:44:59,068 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 18:44:59,068 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 18:44:59,934 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 18:44:59,934 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 18:44:59,934 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 18:44:59,934 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 18:44:59,934 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 88255
2025-05-30 18:44:59,935 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 18:44:59,935 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 18:44:59,935 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 18:44:59,940 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 18:44:59,953 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 18:44:59,954 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 18:44:59,954 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 18:44:59,954 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4625246416) setup complete. Starting run loop.
2025-05-30 18:44:59,954 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 18:44:59,954 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 18:44:59,954 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 18:44:59,954 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 18:44:59,954 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 18:44:59,954 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 18:44:59,954 - INFO - aiogram.dispatcher - Start polling
2025-05-30 18:44:59,957 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 18:45:00,204 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 18:45:00,287 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 18:45:00,288 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 18:45:00,288 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 18:45:00,288 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 18:45:00,288 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 88254
2025-05-30 18:45:00,288 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 18:45:00,288 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 18:45:00,288 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 18:45:00,329 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 18:45:00,329 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 18:45:00,375 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 18:45:00,375 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 18:45:00,375 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 18:45:00,375 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 18:45:00,375 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 18:45:00,375 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 18:45:00,415 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 18:45:00,415 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 18:45:00,415 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 18:45:00,416 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET) wirh description: ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ±Ğ»Ğ¾Ğ³Ğ°)
2025-05-30 18:45:00,417 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET) wirh description: Ğ£Ğ·Ğ½Ğ°Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² (Ğ±Ğ±) Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.)
2025-05-30 18:45:00,417 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 18:45:00,417 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 18:45:00,471 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 18:45:00,474 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 18:45:01,294 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 18:45:01,297 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 18:45:01,298 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'airsoft' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7'] with description: Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ 1Ñ
2025-05-30 18:45:01,298 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 18:45:01,298 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'airsoft-rus.ru' (ID: webSearch-1748459212676) with description: ĞŸĞ¾Ğ¸ÑĞº Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ ÑÑ‚Ñ€Ğ°Ğ¹ĞºĞ±Ğ¾Ğ»Ñƒ Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼ Ğ´Ğ»Ñ ÑÑ‚Ñ€Ğ°Ğ¹ĞºĞ±Ğ¾Ğ»Ğ° Ğ½Ğ° ÑĞ°Ğ¹Ñ‚Ğµ.
2025-05-30 18:45:01,298 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 18:45:01,298 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 18:45:01,298 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 18:45:01,298 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 18:45:01,298 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 18:45:01,299 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 18:45:01,299 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 18:45:01,299 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 18:45:01,299 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->agent
2025-05-30 18:45:01,299 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 18:45:01,299 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 18:45:01,308 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 18:45:01,308 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 18:45:01,308 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 18:45:01,308 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4493194736) setup complete. Starting run loop.
2025-05-30 18:45:01,308 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 18:45:01,308 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 18:45:01,308 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 18:45:01,308 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 18:45:01,311 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 18:45:09,034 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 18:45:09,038 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 18:45:09,038 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4377704832) setup complete. Starting run loop.
2025-05-30 18:45:09,038 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 18:45:39,073 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ñ ÑƒÑ‚11?...'
2025-05-30 18:45:39,074 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 18:45:39,144 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 18:45:39,144 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 18:45:39,144 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 18:45:39,145 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: ab57b974-6b72-4019-9698-5d016f5c4aff)
2025-05-30 18:45:39,145 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 18:45:39,145 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-30 18:45:39,167 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: ab57b974-6b72-4019-9698-5d016f5c4aff, db_id: 1029
2025-05-30 18:45:39,183 - INFO - AGENT:agent_airsoft_0faa9616 - Loaded 20 messages from DB for thread '144641834'.
2025-05-30 18:45:39,184 - INFO - AGENT:agent_airsoft_0faa9616 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-30 18:45:39,184 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-30 18:45:39,249 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 18:45:39,250 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 18:45:39,275 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 18:45:39,278 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 18:45:40,144 - INFO - aiogram.event - Update id=804756356 is handled. Duration 1070 ms by bot id=1750613938
2025-05-30 18:45:40,614 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 18:45:40,852 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 18:45:40,852 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 18:45:40,852 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1250, 'output_tokens': 34, 'total_tokens': 1284, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 18:45:40,852 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1250 C:34 T:1284
2025-05-30 18:45:40,852 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1284 tokens recorded.
2025-05-30 18:45:40,853 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 18:45:40,853 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: knowledgeBase-1748440512419
2025-05-30 18:45:40,853 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO RETRIEVE (knowledgeBase-1748440512419)---
2025-05-30 18:45:41,438 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 18:45:41,452 - INFO - httpx - HTTP Request: POST http://127.0.0.1:6333/collections/platformai/points/query "HTTP/1.1 200 OK"
2025-05-30 18:45:41,454 - INFO - AGENT:agent_airsoft_0faa9616 - ---CHECK RELEVANCE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 18:45:41,455 - INFO - AGENT:agent_airsoft_0faa9616 - Grading documents for question: 'Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ñ ÑƒÑ‚11?'
2025-05-30 18:45:41,455 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.0, streaming: False
2025-05-30 18:45:41,479 - INFO - AGENT:agent_airsoft_0faa9616 - Created grading LLM: gpt-4.1-mini via OpenAI
2025-05-30 18:45:43,892 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 18:45:43,905 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:914 C:6 T:920
2025-05-30 18:45:43,905 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for grading_llm: 920 tokens recorded.
2025-05-30 18:45:43,905 - INFO - AGENT:agent_airsoft_0faa9616 - Total token usage for grading_llm batch: 920 tokens.
2025-05-30 18:45:43,905 - INFO - AGENT:agent_airsoft_0faa9616 - Found 0 relevant documents out of 1 initial (after split).
2025-05-30 18:45:43,906 - INFO - AGENT:agent_airsoft_0faa9616 - ---ASSESS GRADED DOCUMENTS---
2025-05-30 18:45:43,906 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO RELEVANT DOCUMENTS, REWRITE---
2025-05-30 18:45:43,907 - INFO - AGENT:agent_airsoft_0faa9616 - ---TRANSFORM QUERY (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 18:45:43,907 - INFO - AGENT:agent_airsoft_0faa9616 - Rewrite attempt 1/3 for question: 'Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ñ ÑƒÑ‚11?'
2025-05-30 18:45:43,907 - INFO - AGENT:agent_airsoft_0faa9616 - Rewriting original question: Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ñ ÑƒÑ‚11?
2025-05-30 18:45:43,907 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: False
2025-05-30 18:45:43,931 - INFO - AGENT:agent_airsoft_0faa9616 - Created rewrite LLM: gpt-4.1-mini via OpenAI
2025-05-30 18:45:45,757 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 18:45:45,759 - INFO - AGENT:agent_airsoft_0faa9616 - Rewritten question: ĞšĞ°ĞºĞ¾Ğµ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ² Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ³Ğ¾ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ğ¡:Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ»ĞµĞ¹ 11 (Ğ£Ğ¢11) Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ Ñ‚Ğ¸Ğ¿Ğ¾Ğ²Ğ¾Ğ¹ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñ‹ Ğ¸ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸?
2025-05-30 18:45:45,759 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:2837 C:39 T:2876
2025-05-30 18:45:45,759 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for rewrite_llm: 2876 tokens recorded.
2025-05-30 18:45:45,760 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 18:45:45,760 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 18:45:45,784 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 18:45:45,787 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 18:45:47,478 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 18:45:47,705 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 18:45:47,705 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 18:45:47,705 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 2095, 'output_tokens': 42, 'total_tokens': 2137, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 18:45:47,705 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:2095 C:42 T:2137
2025-05-30 18:45:47,705 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 2137 tokens recorded.
2025-05-30 18:45:47,706 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 18:45:47,706 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: knowledgeBase-1748440512419
2025-05-30 18:45:47,706 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO RETRIEVE (knowledgeBase-1748440512419)---
2025-05-30 18:45:49,013 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 18:45:49,025 - INFO - httpx - HTTP Request: POST http://127.0.0.1:6333/collections/platformai/points/query "HTTP/1.1 200 OK"
2025-05-30 18:45:49,026 - INFO - AGENT:agent_airsoft_0faa9616 - ---CHECK RELEVANCE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 18:45:49,027 - INFO - AGENT:agent_airsoft_0faa9616 - Grading documents for question: 'ĞšĞ°ĞºĞ¾Ğµ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ² Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ³Ğ¾ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ğ¡:Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ»ĞµĞ¹ 11 (Ğ£Ğ¢11) Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ Ñ‚Ğ¸Ğ¿Ğ¾Ğ²Ğ¾Ğ¹ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñ‹ Ğ¸ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸?'
2025-05-30 18:45:49,027 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.0, streaming: False
2025-05-30 18:45:49,051 - INFO - AGENT:agent_airsoft_0faa9616 - Created grading LLM: gpt-4.1-mini via OpenAI
2025-05-30 18:45:50,047 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 18:45:50,965 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:938 C:6 T:944
2025-05-30 18:45:50,965 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for grading_llm: 944 tokens recorded.
2025-05-30 18:45:50,965 - INFO - AGENT:agent_airsoft_0faa9616 - Total token usage for grading_llm batch: 1864 tokens.
2025-05-30 18:45:50,965 - INFO - AGENT:agent_airsoft_0faa9616 - Found 0 relevant documents out of 1 initial (after split).
2025-05-30 18:45:50,966 - INFO - AGENT:agent_airsoft_0faa9616 - ---ASSESS GRADED DOCUMENTS---
2025-05-30 18:45:50,966 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO RELEVANT DOCUMENTS, REWRITE---
2025-05-30 18:45:50,966 - INFO - AGENT:agent_airsoft_0faa9616 - ---TRANSFORM QUERY (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 18:45:50,966 - INFO - AGENT:agent_airsoft_0faa9616 - Rewrite attempt 2/3 for question: 'Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ñ ÑƒÑ‚11?'
2025-05-30 18:45:50,966 - INFO - AGENT:agent_airsoft_0faa9616 - Rewriting original question: Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ñ ÑƒÑ‚11?
2025-05-30 18:45:50,967 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: False
2025-05-30 18:45:50,990 - INFO - AGENT:agent_airsoft_0faa9616 - Created rewrite LLM: gpt-4.1-mini via OpenAI
2025-05-30 18:45:52,493 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 18:45:52,494 - INFO - AGENT:agent_airsoft_0faa9616 - Rewritten question: ĞšĞ°ĞºĞ¾Ğµ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ² Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ³Ğ¾ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ğ¡:Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ»ĞµĞ¹ 11 (Ğ£Ğ¢11) Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ Ñ‚Ğ¸Ğ¿Ğ¾Ğ²Ğ¾Ğ¹ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñ‹, Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ¸ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµĞ¼Ñ‹Ñ… ÑÑ‚Ğ°Ğ¿Ğ¾Ğ² Ğ²Ğ½ĞµĞ´Ñ€ĞµĞ½Ğ¸Ñ?
2025-05-30 18:45:52,494 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:4088 C:46 T:4134
2025-05-30 18:45:52,494 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for rewrite_llm: 4134 tokens recorded.
2025-05-30 18:45:52,496 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 18:45:52,496 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 18:45:52,520 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 18:45:52,524 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 18:45:54,028 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 18:45:54,940 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 18:45:54,940 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 18:45:54,940 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 2955, 'output_tokens': 54, 'total_tokens': 3009, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 18:45:54,940 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:2955 C:54 T:3009
2025-05-30 18:45:54,940 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 3009 tokens recorded.
2025-05-30 18:45:54,941 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 18:45:54,941 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: knowledgeBase-1748440512419
2025-05-30 18:45:54,941 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO RETRIEVE (knowledgeBase-1748440512419)---
2025-05-30 18:45:55,473 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 18:45:55,483 - INFO - httpx - HTTP Request: POST http://127.0.0.1:6333/collections/platformai/points/query "HTTP/1.1 200 OK"
2025-05-30 18:45:55,485 - INFO - AGENT:agent_airsoft_0faa9616 - ---CHECK RELEVANCE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 18:45:55,485 - INFO - AGENT:agent_airsoft_0faa9616 - Grading documents for question: 'ĞšĞ°ĞºĞ¾Ğµ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ² Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ³Ğ¾ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ğ¡:Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ»ĞµĞ¹ 11 (Ğ£Ğ¢11) Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ Ñ‚Ğ¸Ğ¿Ğ¾Ğ²Ğ¾Ğ¹ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñ‹, Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ¸ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµĞ¼Ñ‹Ñ… ÑÑ‚Ğ°Ğ¿Ğ¾Ğ² Ğ²Ğ½ĞµĞ´Ñ€ĞµĞ½Ğ¸Ñ?'
2025-05-30 18:45:55,485 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.0, streaming: False
2025-05-30 18:45:55,509 - INFO - AGENT:agent_airsoft_0faa9616 - Created grading LLM: gpt-4.1-mini via OpenAI
2025-05-30 18:45:56,483 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 18:45:56,490 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:945 C:6 T:951
2025-05-30 18:45:56,490 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for grading_llm: 951 tokens recorded.
2025-05-30 18:45:56,490 - INFO - AGENT:agent_airsoft_0faa9616 - Total token usage for grading_llm batch: 2815 tokens.
2025-05-30 18:45:56,490 - INFO - AGENT:agent_airsoft_0faa9616 - Found 0 relevant documents out of 1 initial (after split).
2025-05-30 18:45:56,491 - INFO - AGENT:agent_airsoft_0faa9616 - ---ASSESS GRADED DOCUMENTS---
2025-05-30 18:45:56,491 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO RELEVANT DOCUMENTS, REWRITE---
2025-05-30 18:45:56,491 - INFO - AGENT:agent_airsoft_0faa9616 - ---TRANSFORM QUERY (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 18:45:56,491 - INFO - AGENT:agent_airsoft_0faa9616 - Rewrite attempt 3/3 for question: 'Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ñ ÑƒÑ‚11?'
2025-05-30 18:45:56,491 - INFO - AGENT:agent_airsoft_0faa9616 - Rewriting original question: Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ñ ÑƒÑ‚11?
2025-05-30 18:45:56,492 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: False
2025-05-30 18:45:56,515 - INFO - AGENT:agent_airsoft_0faa9616 - Created rewrite LLM: gpt-4.1-mini via OpenAI
2025-05-30 18:46:02,315 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 18:46:02,318 - INFO - AGENT:agent_airsoft_0faa9616 - Rewritten question: ĞšĞ°ĞºĞ¾Ğµ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ² Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ³Ğ¾ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ğ¡:Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ»ĞµĞ¹ 11 (Ğ£Ğ¢11) Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ Ñ‚Ğ¸Ğ¿Ğ¾Ğ²Ğ¾Ğ¹ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñ‹, Ğ¿Ñ€ĞµĞ´Ğ¿Ğ¾Ğ»Ğ°Ğ³Ğ°ĞµĞ¼Ğ¾Ğ¹ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ¸ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµĞ¼Ñ‹Ñ… ÑÑ‚Ğ°Ğ¿Ğ¾Ğ² Ğ²Ğ½ĞµĞ´Ñ€ĞµĞ½Ğ¸Ñ?
2025-05-30 18:46:02,318 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:5364 C:48 T:5412
2025-05-30 18:46:02,318 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for rewrite_llm: 5412 tokens recorded.
2025-05-30 18:46:02,319 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 18:46:02,319 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 18:46:02,343 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 18:46:02,348 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 18:46:04,885 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 18:46:07,290 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ’ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ñ Ğ½Ğ° Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ² Ğ´Ğ»Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ³Ğ¾ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ğ¡:Ğ£
2025-05-30 18:46:07,290 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 18:46:07,291 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 3829, 'output_tokens': 157, 'total_tokens': 3986, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 18:46:07,291 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:3829 C:157 T:3986
2025-05-30 18:46:07,291 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 3986 tokens recorded.
2025-05-30 18:46:07,292 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 18:46:07,292 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 18:46:07,293 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ’ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ñ Ğ½Ğ° Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ² Ğ´Ğ»Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ³Ğ¾ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ğ¡:Ğ£...
2025-05-30 18:46:07,295 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: ab57b974-6b72-4019-9698-5d016f5c4aff)
2025-05-30 18:46:07,295 - INFO - AGENT:agent_airsoft_0faa9616 - Found 10 token usage events for InteractionID: ab57b974-6b72-4019-9698-5d016f5c4aff.
2025-05-30 18:46:07,298 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'ab57b974-6b72-4019-9698-5d016f5c4aff', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1250, 'completion_tokens': 34, 'total_tokens': 1284, 'timestamp': '2025-05-30T13:45:40.852587+00:00'}
2025-05-30 18:46:07,298 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: ab57b974-6b72-4019-9698-5d016f5c4aff
2025-05-30 18:46:07,302 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Ğ’ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ñ Ğ½Ğ° Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ² Ğ´Ğ»Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ³Ğ¾ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ğ¡:Ğ£...
2025-05-30 18:46:07,302 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Ğ’ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ñ Ğ½Ğ° Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ...'
2025-05-30 18:46:07,316 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: ab57b974-6b72-4019-9698-5d016f5c4aff, db_id: 1030
2025-05-30 18:46:07,331 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1030 for interaction_id: ab57b974-6b72-4019-9698-5d016f5c4aff on attempt 1
2025-05-30 18:46:07,336 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: ab57b974-6b72-4019-9698-5d016f5c4aff, db_id: 500
2025-05-30 18:46:07,338 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'ab57b974-6b72-4019-9698-5d016f5c4aff', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 3829, 'completion_tokens': 157, 'total_tokens': 3986, 'timestamp': '2025-05-30T13:46:07.291039+00:00'}
2025-05-30 18:46:07,339 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: ab57b974-6b72-4019-9698-5d016f5c4aff
2025-05-30 18:46:07,340 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1030 for interaction_id: ab57b974-6b72-4019-9698-5d016f5c4aff on attempt 1
2025-05-30 18:46:07,342 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: ab57b974-6b72-4019-9698-5d016f5c4aff, db_id: 501
2025-05-30 18:46:07,345 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'ab57b974-6b72-4019-9698-5d016f5c4aff', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'rewrite_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 5364, 'completion_tokens': 48, 'total_tokens': 5412, 'timestamp': '2025-05-30T13:46:02.318250+00:00'}
2025-05-30 18:46:07,345 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: ab57b974-6b72-4019-9698-5d016f5c4aff
2025-05-30 18:46:07,346 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1030 for interaction_id: ab57b974-6b72-4019-9698-5d016f5c4aff on attempt 1
2025-05-30 18:46:07,349 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: ab57b974-6b72-4019-9698-5d016f5c4aff, db_id: 502
2025-05-30 18:46:07,351 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'ab57b974-6b72-4019-9698-5d016f5c4aff', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'grading_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 945, 'completion_tokens': 6, 'total_tokens': 951, 'timestamp': '2025-05-30T13:45:56.490249+00:00'}
2025-05-30 18:46:07,351 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: ab57b974-6b72-4019-9698-5d016f5c4aff
2025-05-30 18:46:07,352 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1030 for interaction_id: ab57b974-6b72-4019-9698-5d016f5c4aff on attempt 1
2025-05-30 18:46:07,354 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: ab57b974-6b72-4019-9698-5d016f5c4aff, db_id: 503
2025-05-30 18:46:07,356 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'ab57b974-6b72-4019-9698-5d016f5c4aff', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 2955, 'completion_tokens': 54, 'total_tokens': 3009, 'timestamp': '2025-05-30T13:45:54.940516+00:00'}
2025-05-30 18:46:07,356 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: ab57b974-6b72-4019-9698-5d016f5c4aff
2025-05-30 18:46:07,357 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1030 for interaction_id: ab57b974-6b72-4019-9698-5d016f5c4aff on attempt 1
2025-05-30 18:46:07,358 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: ab57b974-6b72-4019-9698-5d016f5c4aff, db_id: 504
2025-05-30 18:46:07,361 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'ab57b974-6b72-4019-9698-5d016f5c4aff', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'rewrite_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 4088, 'completion_tokens': 46, 'total_tokens': 4134, 'timestamp': '2025-05-30T13:45:52.494900+00:00'}
2025-05-30 18:46:07,361 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: ab57b974-6b72-4019-9698-5d016f5c4aff
2025-05-30 18:46:07,361 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1030 for interaction_id: ab57b974-6b72-4019-9698-5d016f5c4aff on attempt 1
2025-05-30 18:46:07,364 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: ab57b974-6b72-4019-9698-5d016f5c4aff, db_id: 505
2025-05-30 18:46:07,366 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'ab57b974-6b72-4019-9698-5d016f5c4aff', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'grading_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 938, 'completion_tokens': 6, 'total_tokens': 944, 'timestamp': '2025-05-30T13:45:50.965209+00:00'}
2025-05-30 18:46:07,366 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: ab57b974-6b72-4019-9698-5d016f5c4aff
2025-05-30 18:46:07,367 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1030 for interaction_id: ab57b974-6b72-4019-9698-5d016f5c4aff on attempt 1
2025-05-30 18:46:07,369 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: ab57b974-6b72-4019-9698-5d016f5c4aff, db_id: 506
2025-05-30 18:46:07,371 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'ab57b974-6b72-4019-9698-5d016f5c4aff', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 2095, 'completion_tokens': 42, 'total_tokens': 2137, 'timestamp': '2025-05-30T13:45:47.705866+00:00'}
2025-05-30 18:46:07,371 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: ab57b974-6b72-4019-9698-5d016f5c4aff
2025-05-30 18:46:07,372 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1030 for interaction_id: ab57b974-6b72-4019-9698-5d016f5c4aff on attempt 1
2025-05-30 18:46:07,374 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: ab57b974-6b72-4019-9698-5d016f5c4aff, db_id: 507
2025-05-30 18:46:07,376 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'ab57b974-6b72-4019-9698-5d016f5c4aff', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'rewrite_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 2837, 'completion_tokens': 39, 'total_tokens': 2876, 'timestamp': '2025-05-30T13:45:45.759241+00:00'}
2025-05-30 18:46:07,376 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: ab57b974-6b72-4019-9698-5d016f5c4aff
2025-05-30 18:46:07,377 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1030 for interaction_id: ab57b974-6b72-4019-9698-5d016f5c4aff on attempt 1
2025-05-30 18:46:07,379 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: ab57b974-6b72-4019-9698-5d016f5c4aff, db_id: 508
2025-05-30 18:46:07,382 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'ab57b974-6b72-4019-9698-5d016f5c4aff', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'grading_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 914, 'completion_tokens': 6, 'total_tokens': 920, 'timestamp': '2025-05-30T13:45:43.905529+00:00'}
2025-05-30 18:46:07,382 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: ab57b974-6b72-4019-9698-5d016f5c4aff
2025-05-30 18:46:07,383 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1030 for interaction_id: ab57b974-6b72-4019-9698-5d016f5c4aff on attempt 1
2025-05-30 18:46:07,385 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: ab57b974-6b72-4019-9698-5d016f5c4aff, db_id: 509
2025-05-30 18:50:09,234 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 18:50:09,242 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 18:55:09,437 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 18:55:09,447 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 19:00:09,631 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 19:00:09,639 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 19:05:09,951 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 19:05:09,959 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 19:10:10,152 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 19:10:10,161 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 19:15:10,342 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 19:15:10,350 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 19:16:14,310 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 19:16:14,310 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 19:16:14,310 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 19:16:14,311 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4376028768) was cancelled.
2025-05-30 19:16:14,311 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4376028768) stopping. Performing cleanup...
2025-05-30 19:16:14,311 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:16:14,314 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 19:16:14,315 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 19:16:14,315 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:16:14,316 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 19:16:14,316 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:16:14,316 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4376028768) cleanup complete.
2025-05-30 19:16:14,316 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 19:16:14,316 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 19:16:14,316 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4377705024) was cancelled.
2025-05-30 19:16:14,316 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4377705024) stopping. Performing cleanup...
2025-05-30 19:16:14,316 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:16:14,319 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 19:16:14,320 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 19:16:14,320 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:16:14,320 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 19:16:14,320 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:16:14,320 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4377705024) cleanup complete.
2025-05-30 19:16:14,321 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 19:16:14,321 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 19:16:14,321 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4377704832) was cancelled.
2025-05-30 19:16:14,321 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4377704832) stopping. Performing cleanup...
2025-05-30 19:16:14,321 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 19:16:14,321 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:16:14,321 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:16:14,321 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 19:16:14,321 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:16:14,323 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 19:16:14,324 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 19:16:14,324 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:16:14,324 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 19:16:14,324 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:16:14,324 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 19:16:14,324 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4377704832) cleanup complete.
2025-05-30 19:16:14,325 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 19:16:14,325 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 19:16:14,325 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 19:16:14,334 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 19:16:14,334 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 19:16:14,836 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 19:16:14,836 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 19:16:14,841 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 19:16:14,841 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 19:16:14,841 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 19:16:14,841 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 19:16:14,841 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 19:16:14,841 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 19:16:14,841 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 19:16:14,842 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 19:16:14,842 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 19:16:14,842 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 19:16:14,842 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 19:16:14,844 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 19:16:14,857 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 19:16:14,858 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 19:16:14,858 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 19:16:14,858 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 19:16:14,858 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 19:16:14,858 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 19:16:14,860 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 19:16:14,860 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4417094288) setup complete. Starting run loop.
2025-05-30 19:16:14,860 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 19:16:14,860 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 19:16:14,860 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 19:16:14,861 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4417094096) setup complete. Starting run loop.
2025-05-30 19:16:14,861 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 19:16:14,871 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 19:16:14,871 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 19:16:14,890 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 19:16:14,890 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 19:16:14,891 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:16:14,891 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 19:16:14,891 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 19:16:14,892 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:16:14,893 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:16:14,893 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:16:14,893 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 19:16:14,893 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 19:16:24,872 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 19:16:24,876 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 19:16:24,876 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4417094240) setup complete. Starting run loop.
2025-05-30 19:16:24,876 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 19:21:25,124 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 19:21:25,131 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 19:26:25,490 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 19:26:25,500 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 19:31:25,845 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 19:31:25,853 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 19:36:26,094 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 19:36:26,101 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 19:39:34,358 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 19:39:34,359 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 19:39:34,359 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 19:39:34,359 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4417094288) was cancelled.
2025-05-30 19:39:34,359 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4417094288) stopping. Performing cleanup...
2025-05-30 19:39:34,359 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:39:34,364 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 19:39:34,365 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 19:39:34,365 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:39:34,365 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 19:39:34,366 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:39:34,366 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4417094288) cleanup complete.
2025-05-30 19:39:34,366 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 19:39:34,366 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 19:39:34,366 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4417094096) was cancelled.
2025-05-30 19:39:34,366 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4417094096) stopping. Performing cleanup...
2025-05-30 19:39:34,366 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:39:34,370 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 19:39:34,371 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 19:39:34,371 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:39:34,372 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 19:39:34,372 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:39:34,372 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4417094096) cleanup complete.
2025-05-30 19:39:34,372 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 19:39:34,372 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 19:39:34,372 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4417094240) was cancelled.
2025-05-30 19:39:34,372 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4417094240) stopping. Performing cleanup...
2025-05-30 19:39:34,372 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 19:39:34,372 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:39:34,372 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:39:34,372 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 19:39:34,372 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:39:34,374 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 19:39:34,375 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 19:39:34,375 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:39:34,375 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 19:39:34,375 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:39:34,375 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 19:39:34,375 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4417094240) cleanup complete.
2025-05-30 19:39:34,375 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 19:39:34,375 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 19:39:34,375 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 19:39:34,379 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 19:39:34,379 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 19:39:34,865 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 19:39:34,865 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 19:39:34,869 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 19:39:34,869 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 19:39:34,869 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 19:39:34,869 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 19:39:34,869 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 19:39:34,869 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 19:39:34,869 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 19:39:34,869 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 19:39:34,870 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 19:39:34,870 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 19:39:34,870 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 19:39:34,872 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 19:39:34,885 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 19:39:34,885 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 19:39:34,885 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 19:39:34,885 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 19:39:34,885 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 19:39:34,885 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 19:39:34,887 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 19:39:34,887 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 19:39:34,887 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4582769584) setup complete. Starting run loop.
2025-05-30 19:39:34,887 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 19:39:34,888 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 19:39:34,888 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4582769392) setup complete. Starting run loop.
2025-05-30 19:39:34,888 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 19:39:34,889 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 19:39:34,889 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 19:39:34,921 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 19:39:34,921 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 19:39:34,922 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:39:34,922 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 19:39:34,922 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 19:39:34,923 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:39:34,923 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:39:34,923 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:39:34,923 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 19:39:34,923 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 19:39:44,890 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 19:39:44,895 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 19:39:44,895 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4582769536) setup complete. Starting run loop.
2025-05-30 19:39:44,895 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 19:40:15,082 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 19:40:15,083 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 19:40:15,083 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 19:40:15,083 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4582769584) was cancelled.
2025-05-30 19:40:15,083 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4582769584) stopping. Performing cleanup...
2025-05-30 19:40:15,083 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:40:15,087 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 19:40:15,088 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 19:40:15,088 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:40:15,089 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 19:40:15,089 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:40:15,089 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4582769584) cleanup complete.
2025-05-30 19:40:15,089 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 19:40:15,089 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 19:40:15,089 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4582769392) was cancelled.
2025-05-30 19:40:15,089 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4582769392) stopping. Performing cleanup...
2025-05-30 19:40:15,089 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:40:15,092 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 19:40:15,093 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 19:40:15,093 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:40:15,093 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 19:40:15,093 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:40:15,093 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4582769392) cleanup complete.
2025-05-30 19:40:15,093 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 19:40:15,093 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 19:40:15,093 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4582769536) was cancelled.
2025-05-30 19:40:15,093 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4582769536) stopping. Performing cleanup...
2025-05-30 19:40:15,094 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 19:40:15,094 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:40:15,094 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:40:15,094 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 19:40:15,094 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:40:15,096 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 19:40:15,097 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 19:40:15,097 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:40:15,097 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 19:40:15,097 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:40:15,098 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 19:40:15,098 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4582769536) cleanup complete.
2025-05-30 19:40:15,098 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 19:40:15,098 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 19:40:15,098 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 19:40:15,100 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 19:40:15,100 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 19:40:15,548 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 19:40:15,548 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 19:40:15,553 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 19:40:15,553 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 19:40:15,553 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 19:40:15,553 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 19:40:15,553 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 19:40:15,553 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 19:40:15,553 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 19:40:15,553 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 19:40:15,554 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 19:40:15,554 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 19:40:15,554 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 19:40:15,556 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 19:40:15,556 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 19:40:15,556 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 19:40:15,569 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 19:40:15,569 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 19:40:15,569 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 19:40:15,569 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 19:40:15,571 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 19:40:15,571 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4384918224) setup complete. Starting run loop.
2025-05-30 19:40:15,571 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 19:40:15,571 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 19:40:15,573 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 19:40:15,573 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4384929696) setup complete. Starting run loop.
2025-05-30 19:40:15,573 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 19:40:15,584 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 19:40:15,584 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 19:40:15,602 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 19:40:15,602 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 19:40:15,603 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:40:15,603 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 19:40:15,603 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 19:40:15,603 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:40:15,604 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:40:15,604 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:40:15,604 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 19:40:15,604 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 19:40:25,585 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 19:40:25,589 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 19:40:25,590 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4384929744) setup complete. Starting run loop.
2025-05-30 19:40:25,590 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 19:40:27,173 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 19:40:27,173 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 19:40:27,173 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 19:40:27,173 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4384918224) was cancelled.
2025-05-30 19:40:27,173 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4384918224) stopping. Performing cleanup...
2025-05-30 19:40:27,173 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:40:27,178 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 19:40:27,179 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 19:40:27,179 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:40:27,179 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 19:40:27,179 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:40:27,179 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4384918224) cleanup complete.
2025-05-30 19:40:27,180 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 19:40:27,180 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 19:40:27,180 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4384929696) was cancelled.
2025-05-30 19:40:27,180 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4384929696) stopping. Performing cleanup...
2025-05-30 19:40:27,180 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:40:27,183 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 19:40:27,184 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 19:40:27,184 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:40:27,184 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 19:40:27,184 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:40:27,184 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4384929696) cleanup complete.
2025-05-30 19:40:27,184 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 19:40:27,184 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 19:40:27,184 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4384929744) was cancelled.
2025-05-30 19:40:27,185 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4384929744) stopping. Performing cleanup...
2025-05-30 19:40:27,185 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 19:40:27,185 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:40:27,185 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:40:27,185 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 19:40:27,185 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:40:27,186 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 19:40:27,188 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 19:40:27,188 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:40:27,188 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 19:40:27,188 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:40:27,188 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 19:40:27,188 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4384929744) cleanup complete.
2025-05-30 19:40:27,188 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 19:40:27,188 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 19:40:27,188 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 19:40:27,191 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 19:40:27,191 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 19:40:27,601 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 19:40:27,601 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 19:40:27,606 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 19:40:27,606 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 19:40:27,606 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 19:40:27,606 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 19:40:27,606 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 19:40:27,606 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 19:40:27,606 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 19:40:27,606 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 19:40:27,606 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 19:40:27,606 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 19:40:27,606 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 19:40:27,608 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 19:40:27,621 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 19:40:27,621 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 19:40:27,621 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 19:40:27,621 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 19:40:27,622 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 19:40:27,622 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 19:40:27,623 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 19:40:27,623 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4413596464) setup complete. Starting run loop.
2025-05-30 19:40:27,623 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 19:40:27,623 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 19:40:27,624 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 19:40:27,624 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4414768192) setup complete. Starting run loop.
2025-05-30 19:40:27,624 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 19:40:27,626 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 19:40:27,626 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 19:40:27,651 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 19:40:27,651 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 19:40:27,652 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:40:27,652 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 19:40:27,652 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 19:40:27,653 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:40:27,654 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:40:27,654 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:40:27,654 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 19:40:27,654 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 19:40:36,809 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 19:40:36,809 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 19:40:36,809 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 19:40:36,809 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4413596464) was cancelled.
2025-05-30 19:40:36,809 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4413596464) stopping. Performing cleanup...
2025-05-30 19:40:36,809 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:40:36,815 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 19:40:36,816 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 19:40:36,816 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:40:36,816 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 19:40:36,816 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:40:36,816 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4413596464) cleanup complete.
2025-05-30 19:40:36,816 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 19:40:36,816 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 19:40:36,816 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4414768192) was cancelled.
2025-05-30 19:40:36,816 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4414768192) stopping. Performing cleanup...
2025-05-30 19:40:36,816 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:40:36,819 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 19:40:36,820 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 19:40:36,820 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:40:36,820 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 19:40:36,820 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:40:36,820 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4414768192) cleanup complete.
2025-05-30 19:40:36,820 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 19:40:36,820 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 19:40:36,820 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4414768000) was cancelled.
2025-05-30 19:40:36,820 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4414768000) stopping. Performing cleanup...
2025-05-30 19:40:36,820 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 19:40:36,820 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:40:36,820 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:40:36,821 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 19:40:36,821 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:40:36,823 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 19:40:36,823 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 19:40:36,823 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:40:36,824 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 19:40:36,824 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:40:36,824 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 19:40:36,824 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4414768000) cleanup complete.
2025-05-30 19:40:36,824 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 19:40:36,824 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 19:40:36,824 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 19:40:36,827 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 19:40:36,827 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 19:40:37,149 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 19:40:37,149 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 19:40:37,153 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 19:40:37,153 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 19:40:37,153 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 19:40:37,153 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 19:40:37,153 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 19:40:37,154 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 19:40:37,154 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 19:40:37,154 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 19:40:37,154 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 19:40:37,154 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 19:40:37,154 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 19:40:37,156 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 19:40:37,156 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 19:40:37,156 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 19:40:37,169 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 19:40:37,169 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 19:40:37,171 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 19:40:37,171 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4576477984) setup complete. Starting run loop.
2025-05-30 19:40:37,171 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 19:40:37,171 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 19:40:37,171 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 19:40:37,171 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 19:40:37,172 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 19:40:37,172 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4576477792) setup complete. Starting run loop.
2025-05-30 19:40:37,173 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 19:40:37,184 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 19:40:37,184 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 19:40:37,201 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 19:40:37,201 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 19:40:37,202 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:40:37,202 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 19:40:37,202 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 19:40:37,203 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:40:37,204 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:40:37,204 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:40:37,204 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 19:40:37,204 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 19:40:47,184 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 19:40:47,188 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 19:40:47,188 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4576477936) setup complete. Starting run loop.
2025-05-30 19:40:47,188 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 19:43:33,023 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 19:43:33,024 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 19:43:33,024 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 19:43:33,025 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4576477984) was cancelled.
2025-05-30 19:43:33,025 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4576477984) stopping. Performing cleanup...
2025-05-30 19:43:33,025 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:43:33,030 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 19:43:33,031 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 19:43:33,031 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:43:33,031 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 19:43:33,031 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:43:33,031 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4576477984) cleanup complete.
2025-05-30 19:43:33,031 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 19:43:33,031 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 19:43:33,031 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4576477792) was cancelled.
2025-05-30 19:43:33,031 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4576477792) stopping. Performing cleanup...
2025-05-30 19:43:33,031 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:43:33,034 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 19:43:33,035 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 19:43:33,035 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:43:33,035 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 19:43:33,035 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:43:33,035 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4576477792) cleanup complete.
2025-05-30 19:43:33,035 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 19:43:33,035 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 19:43:33,035 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4576477936) was cancelled.
2025-05-30 19:43:33,035 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4576477936) stopping. Performing cleanup...
2025-05-30 19:43:33,035 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 19:43:33,035 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:43:33,035 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:43:33,035 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 19:43:33,035 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:43:33,038 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 19:43:33,039 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 19:43:33,039 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:43:33,039 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 19:43:33,039 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:43:33,039 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 19:43:33,039 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4576477936) cleanup complete.
2025-05-30 19:43:33,039 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 19:43:33,039 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 19:43:33,039 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 19:43:33,042 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 19:43:33,042 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 19:43:33,524 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 19:43:33,524 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 19:43:33,528 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 19:43:33,528 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 19:43:33,528 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 19:43:33,528 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 19:43:33,528 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 19:43:33,529 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 19:43:33,529 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 19:43:33,529 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 19:43:33,529 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 19:43:33,529 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 19:43:33,529 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 19:43:33,532 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 19:43:33,546 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 19:43:33,546 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 19:43:33,546 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 19:43:33,546 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 19:43:33,546 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 19:43:33,547 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 19:43:33,549 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 19:43:33,549 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4445382816) setup complete. Starting run loop.
2025-05-30 19:43:33,549 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 19:43:33,549 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 19:43:33,550 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 19:43:33,550 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4447565680) setup complete. Starting run loop.
2025-05-30 19:43:33,551 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 19:43:33,562 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 19:43:33,562 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 19:43:33,579 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 19:43:33,579 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 19:43:33,580 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:43:33,580 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 19:43:33,580 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 19:43:33,581 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:43:33,582 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:43:33,582 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:43:33,582 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 19:43:33,582 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 19:43:43,562 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 19:43:43,567 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 19:43:43,567 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4447565728) setup complete. Starting run loop.
2025-05-30 19:43:43,567 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 19:44:57,437 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 19:44:57,438 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 19:44:57,438 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 19:44:57,438 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4445382816) was cancelled.
2025-05-30 19:44:57,438 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4445382816) stopping. Performing cleanup...
2025-05-30 19:44:57,438 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:44:57,442 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 19:44:57,443 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 19:44:57,443 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:44:57,443 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 19:44:57,443 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:44:57,443 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4445382816) cleanup complete.
2025-05-30 19:44:57,444 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 19:44:57,444 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 19:44:57,444 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4447565680) was cancelled.
2025-05-30 19:44:57,444 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4447565680) stopping. Performing cleanup...
2025-05-30 19:44:57,444 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:44:57,447 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 19:44:57,448 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 19:44:57,448 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:44:57,449 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 19:44:57,449 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:44:57,449 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4447565680) cleanup complete.
2025-05-30 19:44:57,449 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 19:44:57,449 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 19:44:57,449 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4447565728) was cancelled.
2025-05-30 19:44:57,449 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4447565728) stopping. Performing cleanup...
2025-05-30 19:44:57,449 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 19:44:57,449 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:44:57,449 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:44:57,449 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 19:44:57,449 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:44:57,452 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 19:44:57,453 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 19:44:57,453 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:44:57,453 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 19:44:57,453 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:44:57,453 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 19:44:57,453 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4447565728) cleanup complete.
2025-05-30 19:44:57,453 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 19:44:57,453 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 19:44:57,453 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 19:44:57,456 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 19:44:57,456 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 19:44:57,917 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 19:44:57,917 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 19:44:57,921 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 19:44:57,921 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 19:44:57,921 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 19:44:57,921 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 19:44:57,921 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 19:44:57,921 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 19:44:57,921 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 19:44:57,921 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 19:44:57,921 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 19:44:57,922 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 19:44:57,922 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 19:44:57,924 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 19:44:57,938 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 19:44:57,938 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 19:44:57,938 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 19:44:57,938 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 19:44:57,938 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 19:44:57,938 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 19:44:57,942 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 19:44:57,942 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4465502896) setup complete. Starting run loop.
2025-05-30 19:44:57,942 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 19:44:57,942 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 19:44:57,942 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 19:44:57,942 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4465621232) setup complete. Starting run loop.
2025-05-30 19:44:57,942 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 19:44:57,944 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 19:44:57,944 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 19:44:57,967 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 19:44:57,967 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 19:44:57,967 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:44:57,967 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 19:44:57,967 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 19:44:57,968 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:44:57,968 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:44:57,969 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:44:57,969 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 19:44:57,969 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 19:45:04,309 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 19:45:04,309 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 19:45:04,309 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 19:45:04,310 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4465502896) was cancelled.
2025-05-30 19:45:04,310 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4465502896) stopping. Performing cleanup...
2025-05-30 19:45:04,310 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:45:04,313 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 19:45:04,314 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 19:45:04,314 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:45:04,315 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 19:45:04,315 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:45:04,315 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4465502896) cleanup complete.
2025-05-30 19:45:04,315 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 19:45:04,315 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 19:45:04,315 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4465621232) was cancelled.
2025-05-30 19:45:04,315 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4465621232) stopping. Performing cleanup...
2025-05-30 19:45:04,315 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:45:04,319 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 19:45:04,320 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 19:45:04,321 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:45:04,321 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 19:45:04,321 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:45:04,321 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4465621232) cleanup complete.
2025-05-30 19:45:04,321 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 19:45:04,321 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 19:45:04,321 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4465621280) was cancelled.
2025-05-30 19:45:04,321 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4465621280) stopping. Performing cleanup...
2025-05-30 19:45:04,321 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 19:45:04,321 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:45:04,321 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:45:04,321 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 19:45:04,321 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:45:04,323 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 19:45:04,323 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 19:45:04,323 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:45:04,324 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 19:45:04,324 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:45:04,324 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 19:45:04,324 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4465621280) cleanup complete.
2025-05-30 19:45:04,324 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 19:45:04,324 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 19:45:04,324 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 19:45:04,327 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 19:45:04,327 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 19:45:04,663 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 19:45:04,663 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 19:45:04,668 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 19:45:04,668 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 19:45:04,668 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 19:45:04,668 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 19:45:04,668 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 19:45:04,668 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 19:45:04,668 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 19:45:04,668 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 19:45:04,668 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 19:45:04,668 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 19:45:04,668 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 19:45:04,670 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 19:45:04,670 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 19:45:04,670 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 19:45:04,684 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 19:45:04,684 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 19:45:04,684 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 19:45:04,684 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 19:45:04,685 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 19:45:04,685 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4626809776) setup complete. Starting run loop.
2025-05-30 19:45:04,685 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 19:45:04,686 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 19:45:04,687 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 19:45:04,687 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4626809536) setup complete. Starting run loop.
2025-05-30 19:45:04,687 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 19:45:04,688 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 19:45:04,688 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 19:45:04,716 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 19:45:04,716 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 19:45:04,717 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:45:04,717 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 19:45:04,717 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 19:45:04,718 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:45:04,719 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:45:04,719 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:45:04,719 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 19:45:04,719 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 19:45:14,690 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 19:45:14,695 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 19:45:14,695 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4626809344) setup complete. Starting run loop.
2025-05-30 19:45:14,695 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 19:45:18,408 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 19:45:18,408 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 19:45:18,408 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 19:45:18,408 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4626809776) was cancelled.
2025-05-30 19:45:18,408 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4626809776) stopping. Performing cleanup...
2025-05-30 19:45:18,408 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:45:18,413 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 19:45:18,414 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 19:45:18,414 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:45:18,414 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 19:45:18,414 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:45:18,414 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4626809776) cleanup complete.
2025-05-30 19:45:18,414 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 19:45:18,414 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 19:45:18,414 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4626809536) was cancelled.
2025-05-30 19:45:18,414 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4626809536) stopping. Performing cleanup...
2025-05-30 19:45:18,414 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:45:18,417 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 19:45:18,418 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 19:45:18,418 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:45:18,418 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 19:45:18,418 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:45:18,418 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4626809536) cleanup complete.
2025-05-30 19:45:18,418 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 19:45:18,418 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 19:45:18,418 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4626809344) was cancelled.
2025-05-30 19:45:18,418 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4626809344) stopping. Performing cleanup...
2025-05-30 19:45:18,418 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 19:45:18,418 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:45:18,418 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:45:18,418 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 19:45:18,418 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:45:18,420 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 19:45:18,421 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 19:45:18,421 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:45:18,421 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 19:45:18,421 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:45:18,421 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 19:45:18,421 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4626809344) cleanup complete.
2025-05-30 19:45:18,421 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 19:45:18,421 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 19:45:18,421 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 19:45:18,424 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 19:45:18,424 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 19:45:18,764 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 19:45:18,764 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 19:45:18,769 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 19:45:18,769 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 19:45:18,769 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 19:45:18,769 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 19:45:18,769 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 19:45:18,769 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 19:45:18,769 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 19:45:18,769 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 19:45:18,769 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 19:45:18,769 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 19:45:18,769 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 19:45:18,771 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 19:45:18,771 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 19:45:18,771 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 19:45:18,785 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 19:45:18,785 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 19:45:18,785 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 19:45:18,785 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 19:45:18,786 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 19:45:18,786 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4434133312) setup complete. Starting run loop.
2025-05-30 19:45:18,786 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 19:45:18,787 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 19:45:18,788 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 19:45:18,788 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4434147376) setup complete. Starting run loop.
2025-05-30 19:45:18,788 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 19:45:18,789 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 19:45:18,789 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 19:45:18,817 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 19:45:18,817 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 19:45:18,818 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:45:18,818 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 19:45:18,818 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 19:45:18,819 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:45:18,820 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:45:18,820 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:45:18,820 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 19:45:18,820 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 19:45:28,790 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 19:45:28,792 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 19:45:28,792 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4434147424) setup complete. Starting run loop.
2025-05-30 19:45:28,792 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 19:45:28,987 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 19:45:28,987 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 19:45:28,987 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 19:45:28,987 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4434133312) was cancelled.
2025-05-30 19:45:28,987 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4434133312) stopping. Performing cleanup...
2025-05-30 19:45:28,987 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:45:28,990 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 19:45:28,991 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 19:45:28,991 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:45:28,991 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 19:45:28,991 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:45:28,991 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4434133312) cleanup complete.
2025-05-30 19:45:28,991 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 19:45:28,991 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 19:45:28,991 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4434147376) was cancelled.
2025-05-30 19:45:28,992 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4434147376) stopping. Performing cleanup...
2025-05-30 19:45:28,992 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:45:28,995 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 19:45:28,996 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 19:45:28,996 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:45:28,996 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 19:45:28,996 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:45:28,996 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4434147376) cleanup complete.
2025-05-30 19:45:28,996 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 19:45:28,997 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 19:45:28,997 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4434147424) was cancelled.
2025-05-30 19:45:28,997 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4434147424) stopping. Performing cleanup...
2025-05-30 19:45:28,997 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 19:45:28,997 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:45:28,997 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:45:28,997 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 19:45:28,997 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:45:28,998 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 19:45:28,999 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 19:45:28,999 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:45:28,999 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 19:45:28,999 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:45:28,999 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 19:45:29,000 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4434147424) cleanup complete.
2025-05-30 19:45:29,000 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 19:45:29,000 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 19:45:29,000 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 19:45:29,002 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 19:45:29,002 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 19:45:29,415 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 19:45:29,415 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 19:45:29,419 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 19:45:29,419 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 19:45:29,419 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 19:45:29,419 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 19:45:29,419 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 19:45:29,419 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 19:45:29,419 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 19:45:29,419 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 19:45:29,420 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 19:45:29,420 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 19:45:29,420 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 19:45:29,422 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 19:45:29,436 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 19:45:29,437 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 19:45:29,437 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 19:45:29,437 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 19:45:29,437 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 19:45:29,437 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 19:45:29,440 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 19:45:29,440 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4375361680) setup complete. Starting run loop.
2025-05-30 19:45:29,440 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 19:45:29,440 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 19:45:29,440 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 19:45:29,440 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4375708448) setup complete. Starting run loop.
2025-05-30 19:45:29,440 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 19:45:29,442 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 19:45:29,442 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 19:45:29,470 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 19:45:29,471 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 19:45:29,472 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:45:29,472 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 19:45:29,472 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 19:45:29,473 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:45:29,473 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:45:29,473 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:45:29,473 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 19:45:29,473 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 19:45:39,443 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 19:45:39,448 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 19:45:39,448 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4375708496) setup complete. Starting run loop.
2025-05-30 19:45:39,448 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 19:45:42,663 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 19:45:42,663 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 19:45:42,664 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 19:45:42,664 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4375361680) was cancelled.
2025-05-30 19:45:42,664 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4375361680) stopping. Performing cleanup...
2025-05-30 19:45:42,664 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:45:42,668 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 19:45:42,669 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 19:45:42,669 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:45:42,669 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 19:45:42,670 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:45:42,670 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4375361680) cleanup complete.
2025-05-30 19:45:42,670 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 19:45:42,670 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 19:45:42,670 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4375708448) was cancelled.
2025-05-30 19:45:42,670 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4375708448) stopping. Performing cleanup...
2025-05-30 19:45:42,670 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:45:42,674 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 19:45:42,675 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 19:45:42,675 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:45:42,675 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 19:45:42,675 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:45:42,675 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4375708448) cleanup complete.
2025-05-30 19:45:42,675 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 19:45:42,675 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 19:45:42,676 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4375708496) was cancelled.
2025-05-30 19:45:42,676 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4375708496) stopping. Performing cleanup...
2025-05-30 19:45:42,676 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 19:45:42,676 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:45:42,676 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:45:42,676 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 19:45:42,676 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:45:42,679 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 19:45:42,680 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 19:45:42,680 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:45:42,681 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 19:45:42,681 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:45:42,681 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 19:45:42,681 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4375708496) cleanup complete.
2025-05-30 19:45:42,681 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 19:45:42,681 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 19:45:42,681 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 19:45:42,685 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 19:45:42,685 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 19:45:43,001 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 19:45:43,001 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 19:45:43,005 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 19:45:43,005 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 19:45:43,005 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 19:45:43,005 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 19:45:43,005 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 19:45:43,006 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 19:45:43,006 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 19:45:43,006 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 19:45:43,006 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 19:45:43,006 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 19:45:43,006 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 19:45:43,008 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 19:45:43,008 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 19:45:43,008 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 19:45:43,008 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 19:45:43,008 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 19:45:43,022 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 19:45:43,022 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 19:45:43,023 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 19:45:43,024 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 19:45:43,024 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4437296000) setup complete. Starting run loop.
2025-05-30 19:45:43,024 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 19:45:43,024 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 19:45:43,024 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4437295952) setup complete. Starting run loop.
2025-05-30 19:45:43,024 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 19:45:43,034 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 19:45:43,035 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 19:45:43,052 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 19:45:43,052 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 19:45:43,053 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:45:43,053 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 19:45:43,053 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 19:45:43,054 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:45:43,054 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:45:43,055 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:45:43,055 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 19:45:43,055 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 19:45:47,686 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 19:45:47,686 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 19:45:47,686 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 19:45:47,686 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4437295952) was cancelled.
2025-05-30 19:45:47,686 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4437295952) stopping. Performing cleanup...
2025-05-30 19:45:47,686 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:45:47,692 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 19:45:47,692 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 19:45:47,692 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:45:47,693 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 19:45:47,693 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:45:47,693 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4437295952) cleanup complete.
2025-05-30 19:45:47,693 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 19:45:47,693 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 19:45:47,693 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4437296000) was cancelled.
2025-05-30 19:45:47,693 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4437296000) stopping. Performing cleanup...
2025-05-30 19:45:47,693 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:45:47,696 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 19:45:47,697 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 19:45:47,697 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:45:47,697 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 19:45:47,697 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:45:47,697 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4437296000) cleanup complete.
2025-05-30 19:45:47,697 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 19:45:47,697 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 19:45:47,697 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4437295568) was cancelled.
2025-05-30 19:45:47,697 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4437295568) stopping. Performing cleanup...
2025-05-30 19:45:47,697 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 19:45:47,697 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:45:47,697 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:45:47,697 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 19:45:47,697 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:45:47,699 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 19:45:47,700 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 19:45:47,700 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:45:47,700 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 19:45:47,700 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:45:47,700 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 19:45:47,700 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4437295568) cleanup complete.
2025-05-30 19:45:47,700 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 19:45:47,700 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 19:45:47,700 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 19:45:47,703 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 19:45:47,703 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 19:45:48,023 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 19:45:48,023 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 19:45:48,027 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 19:45:48,027 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 19:45:48,027 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 19:45:48,027 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 19:45:48,027 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 19:45:48,028 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 19:45:48,028 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 19:45:48,028 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 19:45:48,028 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 19:45:48,028 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 19:45:48,028 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 19:45:48,030 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 19:45:48,030 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 19:45:48,030 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 19:45:48,044 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 19:45:48,044 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 19:45:48,044 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 19:45:48,044 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 19:45:48,047 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 19:45:48,047 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4412080976) setup complete. Starting run loop.
2025-05-30 19:45:48,047 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 19:45:48,047 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 19:45:48,048 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 19:45:48,048 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4412080736) setup complete. Starting run loop.
2025-05-30 19:45:48,048 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 19:45:48,059 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 19:45:48,059 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 19:45:48,077 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 19:45:48,077 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 19:45:48,078 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:45:48,078 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 19:45:48,078 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 19:45:48,079 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:45:48,079 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:45:48,080 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:45:48,080 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 19:45:48,080 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 19:45:58,060 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 19:45:58,065 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 19:45:58,065 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4412080544) setup complete. Starting run loop.
2025-05-30 19:45:58,065 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 19:46:36,179 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 19:46:36,180 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 19:46:36,180 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 19:46:36,180 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4412080976) was cancelled.
2025-05-30 19:46:36,180 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4412080976) stopping. Performing cleanup...
2025-05-30 19:46:36,180 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:46:36,185 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 19:46:36,186 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 19:46:36,186 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:46:36,187 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 19:46:36,187 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:46:36,187 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4412080976) cleanup complete.
2025-05-30 19:46:36,187 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 19:46:36,187 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 19:46:36,187 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4412080736) was cancelled.
2025-05-30 19:46:36,187 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4412080736) stopping. Performing cleanup...
2025-05-30 19:46:36,187 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:46:36,190 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 19:46:36,191 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 19:46:36,191 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:46:36,191 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 19:46:36,191 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:46:36,191 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4412080736) cleanup complete.
2025-05-30 19:46:36,191 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 19:46:36,191 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 19:46:36,192 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4412080544) was cancelled.
2025-05-30 19:46:36,192 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4412080544) stopping. Performing cleanup...
2025-05-30 19:46:36,192 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 19:46:36,192 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:46:36,192 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:46:36,192 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 19:46:36,192 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:46:36,193 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 19:46:36,194 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 19:46:36,194 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:46:36,194 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 19:46:36,194 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:46:36,194 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 19:46:36,194 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4412080544) cleanup complete.
2025-05-30 19:46:36,194 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 19:46:36,194 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 19:46:36,194 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 19:46:36,197 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 19:46:36,197 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 19:46:36,634 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 19:46:36,634 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 19:46:36,638 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 19:46:36,638 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 19:46:36,638 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 19:46:36,639 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 19:46:36,639 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 19:46:36,639 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 19:46:36,639 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 19:46:36,639 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 19:46:36,639 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 19:46:36,639 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 19:46:36,639 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 19:46:36,641 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 19:46:36,641 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 19:46:36,641 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 19:46:36,655 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 19:46:36,656 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 19:46:36,656 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 19:46:36,656 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 19:46:36,657 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 19:46:36,657 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4394449760) setup complete. Starting run loop.
2025-05-30 19:46:36,657 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 19:46:36,659 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 19:46:36,660 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 19:46:36,660 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4395072640) setup complete. Starting run loop.
2025-05-30 19:46:36,660 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 19:46:36,670 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 19:46:36,670 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 19:46:36,688 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 19:46:36,688 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 19:46:36,689 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:46:36,689 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 19:46:36,689 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 19:46:36,690 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:46:36,691 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:46:36,691 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:46:36,691 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 19:46:36,691 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 19:46:46,671 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 19:46:46,676 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 19:46:46,676 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4395072448) setup complete. Starting run loop.
2025-05-30 19:46:46,676 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 19:47:53,714 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 19:47:53,714 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 19:47:53,714 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 19:47:53,715 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4394449760) was cancelled.
2025-05-30 19:47:53,715 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4394449760) stopping. Performing cleanup...
2025-05-30 19:47:53,715 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:47:53,719 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 19:47:53,720 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 19:47:53,720 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:47:53,720 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 19:47:53,720 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:47:53,720 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4394449760) cleanup complete.
2025-05-30 19:47:53,720 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 19:47:53,720 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 19:47:53,721 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4395072640) was cancelled.
2025-05-30 19:47:53,721 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4395072640) stopping. Performing cleanup...
2025-05-30 19:47:53,721 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:47:53,724 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 19:47:53,725 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 19:47:53,725 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:47:53,725 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 19:47:53,725 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:47:53,725 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4395072640) cleanup complete.
2025-05-30 19:47:53,725 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 19:47:53,725 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 19:47:53,725 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4395072448) was cancelled.
2025-05-30 19:47:53,725 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4395072448) stopping. Performing cleanup...
2025-05-30 19:47:53,725 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 19:47:53,725 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:47:53,725 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:47:53,725 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 19:47:53,725 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:47:53,727 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 19:47:53,728 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 19:47:53,728 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:47:53,728 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 19:47:53,728 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:47:53,728 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 19:47:53,728 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4395072448) cleanup complete.
2025-05-30 19:47:53,728 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 19:47:53,728 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 19:47:53,728 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 19:47:53,733 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 19:47:53,733 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 19:47:54,181 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 19:47:54,181 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 19:47:54,184 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 19:47:54,184 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 19:47:54,184 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 19:47:54,184 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 19:47:54,184 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 19:47:54,184 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 19:47:54,184 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 19:47:54,184 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 19:47:54,184 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 19:47:54,184 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 19:47:54,185 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 19:47:54,186 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 19:47:54,201 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 19:47:54,202 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 19:47:54,202 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 19:47:54,202 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 19:47:54,202 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 19:47:54,202 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 19:47:54,203 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 19:47:54,203 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 19:47:54,203 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4404576336) setup complete. Starting run loop.
2025-05-30 19:47:54,203 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 19:47:54,203 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4404576528) setup complete. Starting run loop.
2025-05-30 19:47:54,203 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 19:47:54,203 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 19:47:54,204 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 19:47:54,204 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 19:47:54,228 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 19:47:54,228 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 19:47:54,228 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:47:54,228 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 19:47:54,228 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 19:47:54,229 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:47:54,229 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:47:54,230 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:47:54,230 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 19:47:54,230 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 19:48:04,205 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 19:48:04,209 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 19:48:04,210 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4404585792) setup complete. Starting run loop.
2025-05-30 19:48:04,210 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 19:49:04,175 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 19:49:04,176 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 19:49:04,176 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 19:49:04,176 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4404576528) was cancelled.
2025-05-30 19:49:04,176 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4404576528) stopping. Performing cleanup...
2025-05-30 19:49:04,176 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:49:04,181 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 19:49:04,182 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 19:49:04,182 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:49:04,182 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 19:49:04,182 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:49:04,182 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4404576528) cleanup complete.
2025-05-30 19:49:04,182 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 19:49:04,182 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 19:49:04,182 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4404576336) was cancelled.
2025-05-30 19:49:04,182 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4404576336) stopping. Performing cleanup...
2025-05-30 19:49:04,182 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:49:04,185 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 19:49:04,186 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 19:49:04,186 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:49:04,186 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 19:49:04,186 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:49:04,186 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4404576336) cleanup complete.
2025-05-30 19:49:04,186 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 19:49:04,186 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 19:49:04,186 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4404585792) was cancelled.
2025-05-30 19:49:04,186 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4404585792) stopping. Performing cleanup...
2025-05-30 19:49:04,187 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 19:49:04,187 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:49:04,187 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:49:04,187 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 19:49:04,187 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:49:04,189 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 19:49:04,190 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 19:49:04,190 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:49:04,190 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 19:49:04,190 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:49:04,190 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 19:49:04,190 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4404585792) cleanup complete.
2025-05-30 19:49:04,190 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 19:49:04,190 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 19:49:04,190 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 19:49:04,193 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 19:49:04,193 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 19:49:04,562 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 19:49:04,562 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 19:49:04,567 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 19:49:04,567 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 19:49:04,567 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 19:49:04,567 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 19:49:04,567 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 19:49:04,567 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 19:49:04,567 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 19:49:04,567 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 19:49:04,567 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 19:49:04,567 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 19:49:04,567 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 19:49:04,570 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 19:49:04,570 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 19:49:04,570 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 19:49:04,570 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 19:49:04,570 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 19:49:04,570 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 19:49:04,570 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 19:49:04,585 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 19:49:04,585 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4416603152) setup complete. Starting run loop.
2025-05-30 19:49:04,585 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 19:49:04,586 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 19:49:04,587 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 19:49:04,587 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4416602960) setup complete. Starting run loop.
2025-05-30 19:49:04,587 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 19:49:04,588 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 19:49:04,588 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 19:49:04,616 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 19:49:04,616 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 19:49:04,617 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:49:04,617 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 19:49:04,617 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 19:49:04,618 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:49:04,619 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:49:04,619 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:49:04,619 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 19:49:04,619 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 19:49:14,588 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 19:49:14,593 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 19:49:14,593 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4416603104) setup complete. Starting run loop.
2025-05-30 19:49:14,593 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 19:49:17,401 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 19:49:17,401 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 19:49:17,401 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 19:49:17,401 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4416603152) was cancelled.
2025-05-30 19:49:17,401 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4416603152) stopping. Performing cleanup...
2025-05-30 19:49:17,401 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:49:17,407 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 19:49:17,408 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 19:49:17,408 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:49:17,408 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 19:49:17,408 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:49:17,408 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4416603152) cleanup complete.
2025-05-30 19:49:17,408 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 19:49:17,408 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 19:49:17,408 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4416602960) was cancelled.
2025-05-30 19:49:17,408 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4416602960) stopping. Performing cleanup...
2025-05-30 19:49:17,408 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:49:17,411 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 19:49:17,411 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 19:49:17,411 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:49:17,411 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 19:49:17,411 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:49:17,412 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4416602960) cleanup complete.
2025-05-30 19:49:17,412 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 19:49:17,412 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 19:49:17,412 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4416603104) was cancelled.
2025-05-30 19:49:17,412 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4416603104) stopping. Performing cleanup...
2025-05-30 19:49:17,412 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 19:49:17,412 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:49:17,412 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:49:17,412 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 19:49:17,412 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:49:17,414 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 19:49:17,415 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 19:49:17,415 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:49:17,415 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 19:49:17,415 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:49:17,415 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 19:49:17,415 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4416603104) cleanup complete.
2025-05-30 19:49:17,415 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 19:49:17,415 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 19:49:17,415 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 19:49:17,417 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 19:49:17,417 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 19:49:17,784 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 19:49:17,784 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 19:49:17,788 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 19:49:17,788 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 19:49:17,788 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 19:49:17,788 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 19:49:17,789 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 19:49:17,789 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 19:49:17,789 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 19:49:17,789 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 19:49:17,789 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 19:49:17,789 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 19:49:17,789 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 19:49:17,791 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 19:49:17,791 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 19:49:17,791 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 19:49:17,791 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 19:49:17,791 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 19:49:17,805 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 19:49:17,805 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 19:49:17,806 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 19:49:17,806 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4419479904) setup complete. Starting run loop.
2025-05-30 19:49:17,806 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 19:49:17,806 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 19:49:17,807 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 19:49:17,807 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4419484080) setup complete. Starting run loop.
2025-05-30 19:49:17,807 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 19:49:17,809 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 19:49:17,809 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 19:49:17,836 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 19:49:17,836 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 19:49:17,837 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:49:17,837 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 19:49:17,837 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 19:49:17,838 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:49:17,839 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:49:17,839 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:49:17,839 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 19:49:17,839 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 19:49:27,809 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 19:49:27,815 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 19:49:27,815 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4419484128) setup complete. Starting run loop.
2025-05-30 19:49:27,815 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 19:49:38,782 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 19:49:38,782 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 19:49:38,783 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 19:49:38,783 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4419479904) was cancelled.
2025-05-30 19:49:38,783 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4419479904) stopping. Performing cleanup...
2025-05-30 19:49:38,783 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:49:38,787 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 19:49:38,787 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 19:49:38,787 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:49:38,788 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 19:49:38,788 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:49:38,788 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4419479904) cleanup complete.
2025-05-30 19:49:38,788 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 19:49:38,788 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 19:49:38,788 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4419484080) was cancelled.
2025-05-30 19:49:38,788 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4419484080) stopping. Performing cleanup...
2025-05-30 19:49:38,788 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:49:38,791 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 19:49:38,791 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 19:49:38,791 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:49:38,791 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 19:49:38,791 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:49:38,791 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4419484080) cleanup complete.
2025-05-30 19:49:38,792 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 19:49:38,792 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 19:49:38,792 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4419484128) was cancelled.
2025-05-30 19:49:38,792 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4419484128) stopping. Performing cleanup...
2025-05-30 19:49:38,792 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 19:49:38,792 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:49:38,792 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:49:38,792 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 19:49:38,792 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:49:38,795 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 19:49:38,796 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 19:49:38,796 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:49:38,796 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 19:49:38,796 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:49:38,796 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 19:49:38,796 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4419484128) cleanup complete.
2025-05-30 19:49:38,796 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 19:49:38,796 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 19:49:38,797 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 19:49:38,799 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 19:49:38,799 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 19:49:39,216 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 19:49:39,216 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 19:49:39,220 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 19:49:39,220 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 19:49:39,220 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 19:49:39,220 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 19:49:39,220 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 19:49:39,221 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 19:49:39,221 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 19:49:39,221 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 19:49:39,221 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 19:49:39,221 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 19:49:39,221 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 19:49:39,223 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 19:49:39,223 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 19:49:39,223 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 19:49:39,223 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 19:49:39,223 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 19:49:39,223 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 19:49:39,223 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 19:49:39,239 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 19:49:39,240 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 19:49:39,240 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4447732080) setup complete. Starting run loop.
2025-05-30 19:49:39,240 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 19:49:39,240 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 19:49:39,240 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4446560736) setup complete. Starting run loop.
2025-05-30 19:49:39,240 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 19:49:39,251 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 19:49:39,251 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 19:49:39,269 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 19:49:39,269 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 19:49:39,270 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:49:39,270 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 19:49:39,270 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 19:49:39,270 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:49:39,271 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:49:39,271 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:49:39,271 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 19:49:39,271 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 19:49:49,253 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 19:49:49,258 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 19:49:49,258 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4447732464) setup complete. Starting run loop.
2025-05-30 19:49:49,258 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 19:49:49,634 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 19:49:49,634 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 19:49:49,634 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 19:49:49,634 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4446560736) was cancelled.
2025-05-30 19:49:49,634 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4446560736) stopping. Performing cleanup...
2025-05-30 19:49:49,634 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:49:49,638 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 19:49:49,638 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 19:49:49,639 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:49:49,639 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 19:49:49,639 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:49:49,639 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4446560736) cleanup complete.
2025-05-30 19:49:49,639 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 19:49:49,639 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 19:49:49,639 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4447732080) was cancelled.
2025-05-30 19:49:49,639 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4447732080) stopping. Performing cleanup...
2025-05-30 19:49:49,639 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:49:49,642 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 19:49:49,643 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 19:49:49,643 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:49:49,644 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 19:49:49,644 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:49:49,644 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4447732080) cleanup complete.
2025-05-30 19:49:49,644 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 19:49:49,644 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 19:49:49,644 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4447732464) was cancelled.
2025-05-30 19:49:49,644 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4447732464) stopping. Performing cleanup...
2025-05-30 19:49:49,644 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 19:49:49,644 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:49:49,644 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:49:49,644 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 19:49:49,644 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:49:49,646 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 19:49:49,647 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 19:49:49,647 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:49:49,647 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 19:49:49,647 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:49:49,647 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 19:49:49,647 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4447732464) cleanup complete.
2025-05-30 19:49:49,647 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 19:49:49,647 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 19:49:49,647 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 19:49:49,649 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 19:49:49,649 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 19:49:50,091 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 19:49:50,091 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 19:49:50,094 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 19:49:50,094 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 19:49:50,095 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 19:49:50,095 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 19:49:50,095 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 19:49:50,095 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 19:49:50,095 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 19:49:50,095 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 19:49:50,095 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 19:49:50,095 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 19:49:50,095 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 19:49:50,098 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 19:49:50,098 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 19:49:50,098 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 19:49:50,098 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 19:49:50,098 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 19:49:50,098 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 19:49:50,098 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 19:49:50,115 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 19:49:50,115 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4423538240) setup complete. Starting run loop.
2025-05-30 19:49:50,115 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 19:49:50,116 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 19:49:50,118 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 19:49:50,118 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4424727248) setup complete. Starting run loop.
2025-05-30 19:49:50,118 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 19:49:50,128 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 19:49:50,128 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 19:49:50,148 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 19:49:50,148 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 19:49:50,149 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:49:50,149 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 19:49:50,149 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 19:49:50,150 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:49:50,151 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:49:50,151 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:49:50,151 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 19:49:50,151 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 19:49:59,308 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 19:49:59,308 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 19:49:59,308 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 19:49:59,308 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4423538240) was cancelled.
2025-05-30 19:49:59,308 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4423538240) stopping. Performing cleanup...
2025-05-30 19:49:59,308 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:49:59,312 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 19:49:59,313 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 19:49:59,313 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:49:59,313 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 19:49:59,313 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:49:59,313 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4423538240) cleanup complete.
2025-05-30 19:49:59,313 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 19:49:59,313 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 19:49:59,313 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4424727248) was cancelled.
2025-05-30 19:49:59,313 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4424727248) stopping. Performing cleanup...
2025-05-30 19:49:59,313 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:49:59,316 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 19:49:59,317 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 19:49:59,317 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:49:59,317 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 19:49:59,317 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:49:59,317 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4424727248) cleanup complete.
2025-05-30 19:49:59,317 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 19:49:59,317 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 19:49:59,317 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4424727056) was cancelled.
2025-05-30 19:49:59,317 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4424727056) stopping. Performing cleanup...
2025-05-30 19:49:59,317 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 19:49:59,317 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:49:59,318 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:49:59,318 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 19:49:59,318 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:49:59,320 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 19:49:59,321 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 19:49:59,321 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:49:59,321 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 19:49:59,321 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:49:59,321 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 19:49:59,321 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4424727056) cleanup complete.
2025-05-30 19:49:59,321 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 19:49:59,321 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 19:49:59,321 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 19:49:59,324 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 19:49:59,324 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 19:49:59,730 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 19:49:59,730 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 19:49:59,735 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 19:49:59,735 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 19:49:59,735 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 19:49:59,735 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 19:49:59,735 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 19:49:59,735 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 19:49:59,735 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 19:49:59,735 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 19:49:59,736 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 19:49:59,736 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 19:49:59,736 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 19:49:59,737 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 19:49:59,737 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 19:49:59,738 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 19:49:59,738 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 19:49:59,738 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 19:49:59,752 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 19:49:59,752 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 19:49:59,753 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 19:49:59,754 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 19:49:59,754 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4435821296) setup complete. Starting run loop.
2025-05-30 19:49:59,755 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 19:49:59,755 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 19:49:59,755 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4435821536) setup complete. Starting run loop.
2025-05-30 19:49:59,755 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 19:49:59,757 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 19:49:59,757 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 19:49:59,784 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 19:49:59,784 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 19:49:59,785 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:49:59,785 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 19:49:59,785 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 19:49:59,786 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:49:59,787 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:49:59,787 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:49:59,787 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 19:49:59,787 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 19:50:05,123 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 19:50:05,123 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 19:50:05,123 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 19:50:05,123 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4435821536) was cancelled.
2025-05-30 19:50:05,123 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4435821536) stopping. Performing cleanup...
2025-05-30 19:50:05,123 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:50:05,128 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 19:50:05,129 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 19:50:05,129 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:50:05,129 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 19:50:05,129 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:50:05,129 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4435821536) cleanup complete.
2025-05-30 19:50:05,130 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 19:50:05,130 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 19:50:05,130 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4435821296) was cancelled.
2025-05-30 19:50:05,130 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4435821296) stopping. Performing cleanup...
2025-05-30 19:50:05,130 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:50:05,133 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 19:50:05,134 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 19:50:05,134 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:50:05,134 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 19:50:05,134 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:50:05,134 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4435821296) cleanup complete.
2025-05-30 19:50:05,134 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 19:50:05,134 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 19:50:05,134 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4435821104) was cancelled.
2025-05-30 19:50:05,134 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4435821104) stopping. Performing cleanup...
2025-05-30 19:50:05,134 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 19:50:05,134 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:50:05,135 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:50:05,135 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 19:50:05,135 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:50:05,137 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 19:50:05,138 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 19:50:05,138 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:50:05,138 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 19:50:05,138 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:50:05,138 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 19:50:05,138 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4435821104) cleanup complete.
2025-05-30 19:50:05,138 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 19:50:05,138 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 19:50:05,138 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 19:50:05,140 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 19:50:05,141 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 19:50:05,446 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 19:50:05,446 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 19:50:05,450 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 19:50:05,450 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 19:50:05,450 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 19:50:05,450 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 19:50:05,450 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 19:50:05,450 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 19:50:05,450 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 19:50:05,450 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 19:50:05,450 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 19:50:05,451 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 19:50:05,451 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 19:50:05,453 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 19:50:05,453 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 19:50:05,453 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 19:50:05,453 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 19:50:05,453 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 19:50:05,453 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 19:50:05,453 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 19:50:05,468 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 19:50:05,468 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 19:50:05,468 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4704403872) setup complete. Starting run loop.
2025-05-30 19:50:05,468 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 19:50:05,469 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 19:50:05,469 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4703849552) setup complete. Starting run loop.
2025-05-30 19:50:05,469 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 19:50:05,470 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 19:50:05,470 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 19:50:05,498 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 19:50:05,498 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 19:50:05,499 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:50:05,499 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 19:50:05,499 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 19:50:05,500 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:50:05,501 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:50:05,501 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:50:05,501 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 19:50:05,501 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 19:50:15,471 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 19:50:15,475 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 19:50:15,475 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4704412416) setup complete. Starting run loop.
2025-05-30 19:50:15,475 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 19:52:02,461 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 19:52:02,461 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 19:52:02,461 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 19:52:02,462 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4704403872) was cancelled.
2025-05-30 19:52:02,462 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4704403872) stopping. Performing cleanup...
2025-05-30 19:52:02,462 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:52:02,467 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 19:52:02,467 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 19:52:02,468 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:52:02,468 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 19:52:02,468 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:52:02,468 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4704403872) cleanup complete.
2025-05-30 19:52:02,468 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 19:52:02,468 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 19:52:02,468 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4703849552) was cancelled.
2025-05-30 19:52:02,468 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4703849552) stopping. Performing cleanup...
2025-05-30 19:52:02,468 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:52:02,471 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 19:52:02,471 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 19:52:02,471 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:52:02,472 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 19:52:02,472 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:52:02,472 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4703849552) cleanup complete.
2025-05-30 19:52:02,472 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 19:52:02,472 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 19:52:02,472 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4704412416) was cancelled.
2025-05-30 19:52:02,472 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4704412416) stopping. Performing cleanup...
2025-05-30 19:52:02,472 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 19:52:02,472 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:52:02,472 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:52:02,472 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 19:52:02,472 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:52:02,474 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 19:52:02,475 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 19:52:02,475 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:52:02,475 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 19:52:02,475 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:52:02,475 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 19:52:02,475 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4704412416) cleanup complete.
2025-05-30 19:52:02,475 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 19:52:02,475 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 19:52:02,475 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 19:52:02,481 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 19:52:02,481 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 19:52:02,861 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 19:52:02,861 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 19:52:02,865 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 19:52:02,865 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 19:52:02,865 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 19:52:02,865 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 19:52:02,865 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 19:52:02,865 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 19:52:02,865 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 19:52:02,865 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 19:52:02,866 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 19:52:02,866 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 19:52:02,866 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 19:52:02,868 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 19:52:02,868 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 19:52:02,868 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 19:52:02,882 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 19:52:02,882 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 19:52:02,882 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 19:52:02,882 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 19:52:02,885 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 19:52:02,885 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4443341456) setup complete. Starting run loop.
2025-05-30 19:52:02,886 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 19:52:02,886 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 19:52:02,886 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 19:52:02,886 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4443341216) setup complete. Starting run loop.
2025-05-30 19:52:02,886 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 19:52:02,887 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 19:52:02,887 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 19:52:02,918 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 19:52:02,918 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 19:52:02,919 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:52:02,919 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 19:52:02,919 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 19:52:02,920 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:52:02,921 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:52:02,921 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:52:02,921 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 19:52:02,921 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 19:52:12,888 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 19:52:12,892 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 19:52:12,892 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4443340928) setup complete. Starting run loop.
2025-05-30 19:52:12,892 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 19:52:12,892 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 19:52:12,892 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 19:52:12,892 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 19:52:12,892 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4443341456) was cancelled.
2025-05-30 19:52:12,892 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4443341456) stopping. Performing cleanup...
2025-05-30 19:52:12,892 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:52:12,896 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 19:52:12,897 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 19:52:12,897 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:52:12,898 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 19:52:12,898 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:52:12,898 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4443341456) cleanup complete.
2025-05-30 19:52:12,898 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 19:52:12,898 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 19:52:12,898 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4443341216) was cancelled.
2025-05-30 19:52:12,898 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4443341216) stopping. Performing cleanup...
2025-05-30 19:52:12,898 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:52:12,901 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 19:52:12,902 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 19:52:12,902 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:52:12,902 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 19:52:12,902 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:52:12,903 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4443341216) cleanup complete.
2025-05-30 19:52:12,903 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 19:52:12,903 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 19:52:12,903 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4443340928) was cancelled.
2025-05-30 19:52:12,903 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4443340928) stopping. Performing cleanup...
2025-05-30 19:52:12,903 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 19:52:12,903 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:52:12,903 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:52:12,903 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 19:52:12,903 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 19:52:12,905 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 19:52:12,906 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 19:52:12,906 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:52:12,906 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 19:52:12,906 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 19:52:12,906 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 19:52:12,906 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4443340928) cleanup complete.
2025-05-30 19:52:12,906 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 19:52:12,906 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 19:52:12,907 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 19:52:12,909 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 19:52:12,909 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 19:52:13,229 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 19:52:13,229 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 19:52:13,233 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 19:52:13,233 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 19:52:13,234 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 19:52:13,234 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 19:52:13,234 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 19:52:13,234 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 19:52:13,234 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 19:52:13,234 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 19:52:13,234 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 19:52:13,234 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 19:52:13,234 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 19:52:13,236 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 19:52:13,236 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 19:52:13,236 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 19:52:13,236 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 19:52:13,236 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 19:52:13,236 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 19:52:13,236 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 19:52:13,251 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 19:52:13,251 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4375705648) setup complete. Starting run loop.
2025-05-30 19:52:13,251 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 19:52:13,252 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 19:52:13,253 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 19:52:13,253 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4379263056) setup complete. Starting run loop.
2025-05-30 19:52:13,253 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 19:52:13,254 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 19:52:13,254 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 19:52:13,281 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 19:52:13,281 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 19:52:13,282 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:52:13,282 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 19:52:13,282 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 19:52:13,282 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 19:52:13,283 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 19:52:13,283 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 19:52:13,283 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 19:52:13,283 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 19:52:23,255 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 19:52:23,259 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 19:52:23,259 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4379263104) setup complete. Starting run loop.
2025-05-30 19:52:23,259 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 19:57:23,473 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 19:57:23,482 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 20:02:23,855 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 20:02:23,866 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 20:05:11,964 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 20:05:11,965 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 20:05:11,965 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 20:05:11,965 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4375705648) was cancelled.
2025-05-30 20:05:11,965 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4375705648) stopping. Performing cleanup...
2025-05-30 20:05:11,965 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 20:05:11,969 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 20:05:11,970 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 20:05:11,970 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:05:11,970 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 20:05:11,970 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 20:05:11,970 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4375705648) cleanup complete.
2025-05-30 20:05:11,970 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 20:05:11,970 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 20:05:11,970 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4379263056) was cancelled.
2025-05-30 20:05:11,970 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4379263056) stopping. Performing cleanup...
2025-05-30 20:05:11,970 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 20:05:11,973 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 20:05:11,974 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 20:05:11,974 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:05:11,974 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 20:05:11,974 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 20:05:11,974 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4379263056) cleanup complete.
2025-05-30 20:05:11,974 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 20:05:11,974 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 20:05:11,974 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4379263104) was cancelled.
2025-05-30 20:05:11,974 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4379263104) stopping. Performing cleanup...
2025-05-30 20:05:11,974 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 20:05:11,974 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:05:11,974 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 20:05:11,974 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 20:05:11,974 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 20:05:11,976 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 20:05:11,977 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 20:05:11,977 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:05:11,977 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 20:05:11,977 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 20:05:11,977 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 20:05:11,977 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4379263104) cleanup complete.
2025-05-30 20:05:11,977 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 20:05:11,977 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 20:05:11,977 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 20:05:11,981 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 20:05:11,981 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 20:05:12,450 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 20:05:12,450 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 20:05:12,454 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 20:05:12,454 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 20:05:12,454 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 20:05:12,454 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 20:05:12,454 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 20:05:12,455 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 20:05:12,455 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 20:05:12,455 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 20:05:12,455 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 20:05:12,455 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 20:05:12,455 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 20:05:12,458 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 20:05:12,458 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 20:05:12,458 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 20:05:12,472 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 20:05:12,472 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 20:05:12,473 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 20:05:12,473 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 20:05:12,473 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 20:05:12,473 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4377716704) setup complete. Starting run loop.
2025-05-30 20:05:12,473 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 20:05:12,473 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 20:05:12,474 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 20:05:12,474 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4377721648) setup complete. Starting run loop.
2025-05-30 20:05:12,474 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 20:05:12,487 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 20:05:12,487 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 20:05:12,508 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 20:05:12,508 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 20:05:12,509 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 20:05:12,509 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 20:05:12,509 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 20:05:12,510 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 20:05:12,511 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:05:12,511 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 20:05:12,511 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 20:05:12,511 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 20:05:22,487 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 20:05:22,491 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 20:05:22,491 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4377721456) setup complete. Starting run loop.
2025-05-30 20:05:22,492 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 20:05:51,474 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 20:05:51,475 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 20:05:51,475 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 20:05:51,475 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4377716704) was cancelled.
2025-05-30 20:05:51,475 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4377716704) stopping. Performing cleanup...
2025-05-30 20:05:51,475 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 20:05:51,479 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 20:05:51,480 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 20:05:51,480 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:05:51,480 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 20:05:51,480 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 20:05:51,480 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4377716704) cleanup complete.
2025-05-30 20:05:51,480 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 20:05:51,480 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 20:05:51,480 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4377721648) was cancelled.
2025-05-30 20:05:51,480 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4377721648) stopping. Performing cleanup...
2025-05-30 20:05:51,480 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 20:05:51,483 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 20:05:51,484 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 20:05:51,484 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:05:51,484 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 20:05:51,484 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 20:05:51,484 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4377721648) cleanup complete.
2025-05-30 20:05:51,485 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 20:05:51,485 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 20:05:51,485 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4377721456) was cancelled.
2025-05-30 20:05:51,485 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4377721456) stopping. Performing cleanup...
2025-05-30 20:05:51,485 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 20:05:51,485 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:05:51,485 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 20:05:51,485 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 20:05:51,485 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 20:05:51,487 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 20:05:51,488 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 20:05:51,488 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:05:51,488 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 20:05:51,488 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 20:05:51,488 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 20:05:51,488 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4377721456) cleanup complete.
2025-05-30 20:05:51,488 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 20:05:51,488 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 20:05:51,488 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 20:05:51,491 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 20:05:51,491 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 20:05:51,886 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 20:05:51,886 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 20:05:51,890 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 20:05:51,890 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 20:05:51,890 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 20:05:51,890 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 20:05:51,890 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 20:05:51,890 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 20:05:51,890 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 20:05:51,890 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 20:05:51,890 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 20:05:51,890 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 20:05:51,890 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 20:05:51,892 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 20:05:51,892 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 20:05:51,892 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 20:05:51,907 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 20:05:51,907 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 20:05:51,907 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 20:05:51,907 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 20:05:51,908 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 20:05:51,908 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4881494816) setup complete. Starting run loop.
2025-05-30 20:05:51,908 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 20:05:51,909 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 20:05:51,910 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 20:05:51,910 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4868693152) setup complete. Starting run loop.
2025-05-30 20:05:51,910 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 20:05:51,912 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 20:05:51,912 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 20:05:51,939 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 20:05:51,940 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 20:05:51,940 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 20:05:51,941 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 20:05:51,941 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 20:05:51,941 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 20:05:51,942 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:05:51,942 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 20:05:51,942 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 20:05:51,942 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 20:05:55,665 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 20:05:55,665 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 20:05:55,665 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 20:05:55,665 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4881494816) was cancelled.
2025-05-30 20:05:55,665 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4881494816) stopping. Performing cleanup...
2025-05-30 20:05:55,665 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 20:05:55,669 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 20:05:55,670 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 20:05:55,670 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:05:55,671 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 20:05:55,671 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 20:05:55,671 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4881494816) cleanup complete.
2025-05-30 20:05:55,671 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 20:05:55,671 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 20:05:55,671 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4868693152) was cancelled.
2025-05-30 20:05:55,671 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4868693152) stopping. Performing cleanup...
2025-05-30 20:05:55,671 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 20:05:55,673 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 20:05:55,674 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 20:05:55,674 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:05:55,674 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 20:05:55,674 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 20:05:55,674 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4868693152) cleanup complete.
2025-05-30 20:05:55,674 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 20:05:55,674 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 20:05:55,674 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4882662176) was cancelled.
2025-05-30 20:05:55,675 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4882662176) stopping. Performing cleanup...
2025-05-30 20:05:55,675 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 20:05:55,675 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:05:55,675 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 20:05:55,675 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 20:05:55,675 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 20:05:55,677 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 20:05:55,678 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 20:05:55,678 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:05:55,678 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 20:05:55,678 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 20:05:55,678 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 20:05:55,678 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4882662176) cleanup complete.
2025-05-30 20:05:55,678 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 20:05:55,678 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 20:05:55,678 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 20:05:55,680 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 20:05:55,681 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 20:05:56,001 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 20:05:56,001 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 20:05:56,005 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 20:05:56,005 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 20:05:56,005 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 20:05:56,005 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 20:05:56,005 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 20:05:56,006 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 20:05:56,006 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 20:05:56,006 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 20:05:56,006 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 20:05:56,006 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 20:05:56,006 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 20:05:56,008 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 20:05:56,008 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 20:05:56,008 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 20:05:56,022 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 20:05:56,022 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 20:05:56,022 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 20:05:56,022 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 20:05:56,023 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 20:05:56,023 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4594025776) setup complete. Starting run loop.
2025-05-30 20:05:56,023 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 20:05:56,024 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 20:05:56,024 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 20:05:56,025 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4594025632) setup complete. Starting run loop.
2025-05-30 20:05:56,025 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 20:05:56,026 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 20:05:56,026 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 20:05:56,055 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 20:05:56,055 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 20:05:56,056 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 20:05:56,056 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 20:05:56,056 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 20:05:56,057 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 20:05:56,058 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:05:56,058 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 20:05:56,058 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 20:05:56,058 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 20:06:06,026 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 20:06:06,030 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 20:06:06,030 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4594025584) setup complete. Starting run loop.
2025-05-30 20:06:06,031 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 20:06:20,136 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 20:06:20,136 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 20:06:20,136 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 20:06:20,137 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4594025776) was cancelled.
2025-05-30 20:06:20,137 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4594025776) stopping. Performing cleanup...
2025-05-30 20:06:20,137 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 20:06:20,141 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 20:06:20,142 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 20:06:20,142 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:06:20,142 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 20:06:20,142 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 20:06:20,142 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4594025776) cleanup complete.
2025-05-30 20:06:20,142 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 20:06:20,142 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 20:06:20,142 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4594025632) was cancelled.
2025-05-30 20:06:20,142 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4594025632) stopping. Performing cleanup...
2025-05-30 20:06:20,142 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 20:06:20,147 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 20:06:20,148 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 20:06:20,148 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:06:20,149 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 20:06:20,149 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 20:06:20,149 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4594025632) cleanup complete.
2025-05-30 20:06:20,149 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 20:06:20,149 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 20:06:20,149 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4594025584) was cancelled.
2025-05-30 20:06:20,149 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4594025584) stopping. Performing cleanup...
2025-05-30 20:06:20,149 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 20:06:20,149 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:06:20,149 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 20:06:20,149 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 20:06:20,149 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 20:06:20,151 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 20:06:20,152 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 20:06:20,152 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:06:20,152 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 20:06:20,152 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 20:06:20,153 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 20:06:20,153 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4594025584) cleanup complete.
2025-05-30 20:06:20,153 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 20:06:20,153 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 20:06:20,153 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 20:06:20,156 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 20:06:20,156 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 20:06:20,559 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 20:06:20,559 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 20:06:20,562 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 20:06:20,562 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 20:06:20,562 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 20:06:20,562 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 20:06:20,562 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 20:06:20,562 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 20:06:20,562 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 20:06:20,562 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 20:06:20,562 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 20:06:20,562 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 20:06:20,563 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 20:06:20,564 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 20:06:20,579 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 20:06:20,579 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 20:06:20,579 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 20:06:20,579 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 20:06:20,579 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 20:06:20,579 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 20:06:20,581 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 20:06:20,581 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 20:06:20,581 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4450583424) setup complete. Starting run loop.
2025-05-30 20:06:20,581 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 20:06:20,582 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 20:06:20,582 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4450583232) setup complete. Starting run loop.
2025-05-30 20:06:20,582 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 20:06:20,583 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 20:06:20,583 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 20:06:20,610 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 20:06:20,610 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 20:06:20,611 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 20:06:20,611 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 20:06:20,611 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 20:06:20,612 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 20:06:20,613 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:06:20,613 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 20:06:20,613 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 20:06:20,613 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 20:06:30,584 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 20:06:30,589 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 20:06:30,589 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4450583376) setup complete. Starting run loop.
2025-05-30 20:06:30,589 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 20:09:11,747 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 20:09:11,747 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 20:09:11,747 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 20:09:11,748 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4450583424) was cancelled.
2025-05-30 20:09:11,748 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4450583424) stopping. Performing cleanup...
2025-05-30 20:09:11,748 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 20:09:11,751 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 20:09:11,753 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 20:09:11,753 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:09:11,753 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 20:09:11,753 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 20:09:11,753 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4450583424) cleanup complete.
2025-05-30 20:09:11,753 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 20:09:11,754 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 20:09:11,754 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4450583232) was cancelled.
2025-05-30 20:09:11,754 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4450583232) stopping. Performing cleanup...
2025-05-30 20:09:11,754 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 20:09:11,757 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 20:09:11,757 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 20:09:11,757 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:09:11,758 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 20:09:11,758 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 20:09:11,758 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4450583232) cleanup complete.
2025-05-30 20:09:11,758 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 20:09:11,758 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 20:09:11,758 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4450583376) was cancelled.
2025-05-30 20:09:11,758 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4450583376) stopping. Performing cleanup...
2025-05-30 20:09:11,758 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 20:09:11,758 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:09:11,758 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 20:09:11,758 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 20:09:11,758 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 20:09:11,760 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 20:09:11,760 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 20:09:11,760 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:09:11,761 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 20:09:11,761 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 20:09:11,761 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 20:09:11,761 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4450583376) cleanup complete.
2025-05-30 20:09:11,761 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 20:09:11,761 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 20:09:11,761 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 20:09:11,765 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 20:09:11,765 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 20:09:12,131 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 20:09:12,131 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 20:09:12,136 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 20:09:12,136 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 20:09:12,136 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 20:09:12,136 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 20:09:12,136 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 20:09:12,136 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 20:09:12,136 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 20:09:12,136 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 20:09:12,136 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 20:09:12,136 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 20:09:12,136 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 20:09:12,139 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 20:09:12,142 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 20:09:12,142 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 20:09:12,161 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 20:09:12,161 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 20:09:12,161 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 20:09:12,161 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 20:09:12,162 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 20:09:12,162 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4431675360) setup complete. Starting run loop.
2025-05-30 20:09:12,162 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 20:09:12,163 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 20:09:12,164 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 20:09:12,164 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4431668976) setup complete. Starting run loop.
2025-05-30 20:09:12,164 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 20:09:12,165 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 20:09:12,165 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 20:09:12,192 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 20:09:12,192 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 20:09:12,193 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 20:09:12,193 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 20:09:12,193 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 20:09:12,194 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 20:09:12,194 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:09:12,194 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 20:09:12,194 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 20:09:12,194 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 20:09:22,165 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 20:09:22,170 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 20:09:22,170 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4432066944) setup complete. Starting run loop.
2025-05-30 20:09:22,170 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 20:10:10,968 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 20:10:10,969 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 20:10:10,969 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 20:10:10,969 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4431675360) was cancelled.
2025-05-30 20:10:10,969 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4431675360) stopping. Performing cleanup...
2025-05-30 20:10:10,969 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 20:10:10,973 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 20:10:10,974 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 20:10:10,974 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:10:10,974 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 20:10:10,974 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 20:10:10,974 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4431675360) cleanup complete.
2025-05-30 20:10:10,974 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 20:10:10,974 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 20:10:10,974 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4431668976) was cancelled.
2025-05-30 20:10:10,974 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4431668976) stopping. Performing cleanup...
2025-05-30 20:10:10,974 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 20:10:10,978 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 20:10:10,979 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 20:10:10,979 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:10:10,979 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 20:10:10,979 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 20:10:10,979 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4431668976) cleanup complete.
2025-05-30 20:10:10,979 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 20:10:10,979 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 20:10:10,979 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4432066944) was cancelled.
2025-05-30 20:10:10,979 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4432066944) stopping. Performing cleanup...
2025-05-30 20:10:10,979 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 20:10:10,979 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:10:10,979 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 20:10:10,979 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 20:10:10,979 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 20:10:10,982 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 20:10:10,983 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 20:10:10,983 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:10:10,983 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 20:10:10,983 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 20:10:10,983 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 20:10:10,983 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4432066944) cleanup complete.
2025-05-30 20:10:10,983 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 20:10:10,983 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 20:10:10,983 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 20:10:10,986 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 20:10:10,986 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 20:10:11,388 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 20:10:11,388 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 20:10:11,392 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 20:10:11,392 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 20:10:11,392 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 20:10:11,392 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 20:10:11,392 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 20:10:11,392 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 20:10:11,392 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 20:10:11,392 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 20:10:11,392 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 20:10:11,393 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 20:10:11,393 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 20:10:11,395 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 20:10:11,395 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 20:10:11,395 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 20:10:11,395 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 20:10:11,395 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 20:10:11,395 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 20:10:11,395 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 20:10:11,412 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 20:10:11,412 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 20:10:11,412 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4372382640) setup complete. Starting run loop.
2025-05-30 20:10:11,412 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 20:10:11,413 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 20:10:11,413 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4372382400) setup complete. Starting run loop.
2025-05-30 20:10:11,413 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 20:10:11,414 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 20:10:11,414 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 20:10:11,443 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 20:10:11,444 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 20:10:11,445 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 20:10:11,445 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 20:10:11,445 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 20:10:11,446 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 20:10:11,446 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:10:11,446 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 20:10:11,446 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 20:10:11,446 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 20:10:21,415 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 20:10:21,420 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 20:10:21,420 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4372382208) setup complete. Starting run loop.
2025-05-30 20:10:21,420 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 20:11:02,010 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 20:11:02,011 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 20:11:02,010 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 20:11:02,011 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 20:11:02,011 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4493194736) received shutdown request. Initiating graceful shutdown...
2025-05-30 20:11:02,011 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4493194736)...
2025-05-30 20:11:02,011 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 20:11:02,011 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 20:11:02,011 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4493194736) was cancelled.
2025-05-30 20:11:02,011 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4493194736) stopping. Performing cleanup...
2025-05-30 20:11:02,011 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 20:11:02,013 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-30 20:11:02,013 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 20:11:02,013 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 20:11:02,013 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 20:11:02,013 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 20:11:02,013 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 20:11:02,013 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 20:11:02,013 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 20:11:02,017 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 20:11:02,018 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 20:11:02,018 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:11:02,018 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 20:11:02,018 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 20:11:02,018 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 20:11:02,018 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4493194736) cleanup complete.
2025-05-30 20:11:02,018 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 20:11:02,018 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 20:11:02,023 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 20:11:02,023 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 20:11:02,023 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 20:11:02,023 - INFO - __main__ - Agent runner main finished.
2025-05-30 20:11:02,160 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 20:11:02,160 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 20:11:02,160 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 20:11:02,161 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4372382640) was cancelled.
2025-05-30 20:11:02,161 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4372382640) stopping. Performing cleanup...
2025-05-30 20:11:02,161 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 20:11:02,165 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 20:11:02,166 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 20:11:02,166 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:11:02,166 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 20:11:02,166 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 20:11:02,166 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4372382640) cleanup complete.
2025-05-30 20:11:02,166 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 20:11:02,166 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 20:11:02,166 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4372382400) was cancelled.
2025-05-30 20:11:02,166 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4372382400) stopping. Performing cleanup...
2025-05-30 20:11:02,166 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 20:11:02,169 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 20:11:02,169 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 20:11:02,169 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:11:02,170 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 20:11:02,170 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 20:11:02,170 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4372382400) cleanup complete.
2025-05-30 20:11:02,170 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 20:11:02,170 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 20:11:02,170 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4372382208) was cancelled.
2025-05-30 20:11:02,170 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4372382208) stopping. Performing cleanup...
2025-05-30 20:11:02,170 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 20:11:02,170 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:11:02,170 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 20:11:02,170 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 20:11:02,170 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 20:11:02,172 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 20:11:02,173 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 20:11:02,173 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:11:02,173 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 20:11:02,173 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 20:11:02,173 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 20:11:02,173 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4372382208) cleanup complete.
2025-05-30 20:11:02,173 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 20:11:02,173 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 20:11:02,173 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 20:11:02,176 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 20:11:02,176 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 20:11:02,262 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 20:11:02,263 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 20:11:02,263 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 20:11:02,263 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4625246416) received shutdown request. Initiating graceful shutdown...
2025-05-30 20:11:02,263 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4625246416)...
2025-05-30 20:11:02,263 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 20:11:02,263 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 20:11:02,263 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4625246416) was cancelled.
2025-05-30 20:11:02,263 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4625246416) stopping. Performing cleanup...
2025-05-30 20:11:02,263 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 20:11:02,263 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 20:11:02,263 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 20:11:02,263 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 20:11:02,263 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 20:11:02,263 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 20:11:02,263 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 20:11:02,263 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 20:11:02,263 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 20:11:02,263 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 20:11:02,269 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 20:11:02,269 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 20:11:02,270 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:11:02,270 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 20:11:02,270 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 20:11:02,270 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 20:11:02,270 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4625246416) cleanup complete.
2025-05-30 20:11:02,270 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 20:11:02,270 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 20:11:02,276 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 20:11:02,277 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 20:11:02,277 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 20:11:02,277 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 20:11:13,570 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 20:11:13,570 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 20:11:13,575 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 20:11:13,575 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 20:11:13,575 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 20:11:13,575 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 20:11:13,575 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 20:11:13,575 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 20:11:13,575 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 20:11:13,575 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 20:11:13,575 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 20:11:13,575 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 20:11:13,575 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 20:11:13,578 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 20:11:13,578 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 20:11:13,578 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 20:11:13,578 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 20:11:13,578 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 20:11:13,578 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 20:11:13,578 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 20:11:13,593 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 20:11:13,593 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 20:11:13,593 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4395355312) setup complete. Starting run loop.
2025-05-30 20:11:13,593 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 20:11:13,593 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 20:11:13,593 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4395366400) setup complete. Starting run loop.
2025-05-30 20:11:13,593 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 20:11:13,594 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 20:11:13,594 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 20:11:13,622 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 20:11:13,622 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 20:11:13,623 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 20:11:13,624 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 91867
2025-05-30 20:11:13,624 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 91867
2025-05-30 20:11:13,625 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 20:11:13,625 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 20:11:13,625 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 20:11:13,626 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 20:11:13,627 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 91868
2025-05-30 20:11:13,627 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 91868
2025-05-30 20:11:13,627 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 20:11:13,628 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:11:13,628 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 20:11:13,628 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 20:11:13,628 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 20:11:14,510 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 20:11:14,511 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 20:11:14,511 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 20:11:14,511 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 20:11:14,511 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 91868
2025-05-30 20:11:14,511 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 20:11:14,511 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 20:11:14,511 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 20:11:14,516 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 20:11:14,529 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 20:11:14,529 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 20:11:14,529 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 20:11:14,529 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4422952928) setup complete. Starting run loop.
2025-05-30 20:11:14,529 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 20:11:14,529 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 20:11:14,529 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 20:11:14,529 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 20:11:14,529 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 20:11:14,529 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 20:11:14,529 - INFO - aiogram.dispatcher - Start polling
2025-05-30 20:11:14,533 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 20:11:14,778 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 20:11:14,920 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 20:11:14,955 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 20:11:14,955 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 20:11:14,955 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 20:11:14,955 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 91867
2025-05-30 20:11:14,955 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 20:11:14,955 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 20:11:14,955 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 20:11:14,961 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 20:11:14,962 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 20:11:15,007 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 20:11:15,007 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 20:11:15,007 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 20:11:15,007 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 20:11:15,007 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 20:11:15,007 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 20:11:15,033 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 20:11:15,033 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 20:11:15,033 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 20:11:15,034 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET) wirh description: ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ±Ğ»Ğ¾Ğ³Ğ°)
2025-05-30 20:11:15,035 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET) wirh description: Ğ£Ğ·Ğ½Ğ°Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² (Ğ±Ğ±) Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.)
2025-05-30 20:11:15,035 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 20:11:15,035 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 20:11:15,089 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 20:11:15,092 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 20:11:16,045 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 20:11:16,048 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 20:11:16,048 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'airsoft' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7'] with description: Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ 1Ñ
2025-05-30 20:11:16,048 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 20:11:16,048 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'airsoft-rus.ru' (ID: webSearch-1748459212676) with description: ĞŸĞ¾Ğ¸ÑĞº Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ ÑÑ‚Ñ€Ğ°Ğ¹ĞºĞ±Ğ¾Ğ»Ñƒ Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼ Ğ´Ğ»Ñ ÑÑ‚Ñ€Ğ°Ğ¹ĞºĞ±Ğ¾Ğ»Ğ° Ğ½Ğ° ÑĞ°Ğ¹Ñ‚Ğµ.
2025-05-30 20:11:16,048 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 20:11:16,048 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 20:11:16,048 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 20:11:16,048 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 20:11:16,049 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 20:11:16,049 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 20:11:16,049 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 20:11:16,049 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 20:11:16,049 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->agent
2025-05-30 20:11:16,049 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 20:11:16,049 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 20:11:16,079 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 20:11:16,080 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 20:11:16,080 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 20:11:16,080 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4338128976) setup complete. Starting run loop.
2025-05-30 20:11:16,080 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 20:11:16,080 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 20:11:16,080 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 20:11:16,080 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 20:11:16,087 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 20:11:23,595 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 20:11:23,600 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 20:11:23,600 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4395366448) setup complete. Starting run loop.
2025-05-30 20:11:23,600 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 20:12:59,523 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-30 20:12:59,535 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-30 20:12:59,536 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-30 20:12:59,536 - INFO - app.db.crud.agent_crud - Updating agent config in DB for agent_id: agent_airsoft_0faa9616
2025-05-30 20:12:59,551 - INFO - app.db.crud.agent_crud - Agent config updated successfully for agent_id: agent_airsoft_0faa9616
2025-05-30 20:12:59,551 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616 was running. Attempting to restart it after config update.
2025-05-30 20:12:59,551 - INFO - app.services.process_manager - Restarting agent process for agent_airsoft_0faa9616...
2025-05-30 20:12:59,554 - INFO - app.services.process_manager - Stopping agent process agent_airsoft_0faa9616 (PID: 91867). Force: True
2025-05-30 20:12:59,554 - INFO - app.services.process_manager - SIGTERM sent to agent agent_airsoft_0faa9616 (PID: 91867)
2025-05-30 20:12:59,655 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 (PID: 91867) terminated gracefully after SIGTERM.
2025-05-30 20:12:59,657 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 marked as stopped in Redis.
2025-05-30 20:12:59,657 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 stopped (or stop attempted and assumed successful for restart). Pausing briefly...
2025-05-30 20:13:04,658 - INFO - app.services.process_manager - Proceeding to start agent agent_airsoft_0faa9616 after delay...
2025-05-30 20:13:04,660 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 20:13:04,662 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 91941
2025-05-30 20:13:04,662 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 91941
2025-05-30 20:13:04,663 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 successfully started as part of restart sequence.
2025-05-30 20:13:04,663 - INFO - app.api.routers.agent_api - Restart command issued for agent agent_airsoft_0faa9616 after config update.
2025-05-30 20:13:04,663 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:13:04,663 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 20:13:06,109 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 20:13:06,110 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 20:13:06,110 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 20:13:06,110 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 20:13:06,110 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 91941
2025-05-30 20:13:06,110 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 20:13:06,110 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 20:13:06,110 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 20:13:06,152 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 20:13:06,152 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 20:13:06,183 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 20:13:06,183 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 20:13:06,183 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 20:13:06,183 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 20:13:06,183 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 20:13:06,183 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 20:13:06,211 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 20:13:06,211 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 20:13:06,211 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 20:13:06,212 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET) wirh description: ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ±Ğ»Ğ¾Ğ³Ğ°)
2025-05-30 20:13:06,213 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET) wirh description: Ğ£Ğ·Ğ½Ğ°Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² (Ğ±Ğ±) Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.)
2025-05-30 20:13:06,213 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 20:13:06,213 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 20:13:06,268 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 20:13:06,272 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 20:13:07,253 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 20:13:07,257 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 20:13:07,257 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'airsoft' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7'] with description: Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ 1Ñ
2025-05-30 20:13:07,257 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 20:13:07,257 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'airsoft-rus.ru' (ID: webSearch-1748459212676) with description: ĞŸĞ¾Ğ¸ÑĞº Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ ÑÑ‚Ñ€Ğ°Ğ¹ĞºĞ±Ğ¾Ğ»Ñƒ Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼ Ğ´Ğ»Ñ ÑÑ‚Ñ€Ğ°Ğ¹ĞºĞ±Ğ¾Ğ»Ğ° Ğ½Ğ° ÑĞ°Ğ¹Ñ‚Ğµ.
2025-05-30 20:13:07,257 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 20:13:07,257 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 20:13:07,257 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 20:13:07,258 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 20:13:07,258 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 20:13:07,258 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 20:13:07,258 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 20:13:07,258 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 20:13:07,258 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->agent
2025-05-30 20:13:07,258 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 20:13:07,259 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 20:13:07,270 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 20:13:07,270 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 20:13:07,270 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 20:13:07,270 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4547033040) setup complete. Starting run loop.
2025-05-30 20:13:07,270 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 20:13:07,270 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 20:13:07,270 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 20:13:07,270 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 20:13:07,273 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 20:14:02,205 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'ĞŸÑ€Ğ¸Ğ²ĞµÑ‚. ĞšÑ‚Ğ¾ Ñ‚Ñ‹?...'
2025-05-30 20:14:02,207 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache miss for user 144641834, agent agent_airsoft_0faa9616. Checking DB.
2025-05-30 20:14:02,317 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - User 144641834 (DBID: 1) IS authorized for agent agent_airsoft_0faa9616 via DB.
2025-05-30 20:14:02,320 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 20:14:02,320 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 20:14:02,320 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 20:14:02,321 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: ad25b7a1-7909-42c5-9c00-97846f73e735)
2025-05-30 20:14:02,321 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 20:14:02,322 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-30 20:14:02,346 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: ad25b7a1-7909-42c5-9c00-97846f73e735, db_id: 1031
2025-05-30 20:14:02,364 - INFO - AGENT:agent_airsoft_0faa9616 - Loaded 20 messages from DB for thread '144641834'.
2025-05-30 20:14:02,364 - INFO - AGENT:agent_airsoft_0faa9616 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-30 20:14:02,364 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-30 20:14:02,422 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 20:14:02,422 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 20:14:02,447 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 20:14:02,451 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 20:14:03,321 - INFO - aiogram.event - Update id=804756357 is handled. Duration 1116 ms by bot id=1750613938
2025-05-30 20:14:03,382 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 20:14:04,191 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! Ğ¯ ĞœĞ°ÑˆĞ°, Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ½ĞµÑ‚-Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğ° airsoft-rus. ĞŸĞ¾Ğ¼Ğ¾Ğ³Ğ°Ñ Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ¾Ğ¼ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ², Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°Ñ Ğ½Ğ° Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ
2025-05-30 20:14:04,191 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_38647f5e19'}
2025-05-30 20:14:04,191 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1365, 'output_tokens': 51, 'total_tokens': 1416, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 20:14:04,191 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1365 C:51 T:1416
2025-05-30 20:14:04,191 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1416 tokens recorded.
2025-05-30 20:14:04,192 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 20:14:04,192 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 20:14:04,193 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! Ğ¯ ĞœĞ°ÑˆĞ°, Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ½ĞµÑ‚-Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğ° airsoft-rus. ĞŸĞ¾Ğ¼Ğ¾Ğ³Ğ°Ñ Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ¾Ğ¼ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ², Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°Ñ Ğ½Ğ° Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ...
2025-05-30 20:14:04,195 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: ad25b7a1-7909-42c5-9c00-97846f73e735)
2025-05-30 20:14:04,195 - INFO - AGENT:agent_airsoft_0faa9616 - Found 1 token usage events for InteractionID: ad25b7a1-7909-42c5-9c00-97846f73e735.
2025-05-30 20:14:04,198 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! Ğ¯ ĞœĞ°ÑˆĞ°, Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ½ĞµÑ‚-Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğ° airsoft-rus. ĞŸĞ¾Ğ¼Ğ¾Ğ³Ğ°Ñ Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ¾Ğ¼ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ², Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°Ñ Ğ½Ğ° Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ...
2025-05-30 20:14:04,198 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! Ğ¯ ĞœĞ°ÑˆĞ°, Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ½ĞµÑ‚-Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğ° airsoft...'
2025-05-30 20:14:04,200 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'ad25b7a1-7909-42c5-9c00-97846f73e735', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1365, 'completion_tokens': 51, 'total_tokens': 1416, 'timestamp': '2025-05-30T15:14:04.191938+00:00'}
2025-05-30 20:14:04,200 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: ad25b7a1-7909-42c5-9c00-97846f73e735
2025-05-30 20:14:04,204 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: ad25b7a1-7909-42c5-9c00-97846f73e735, db_id: 1032
2025-05-30 20:14:04,236 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1032 for interaction_id: ad25b7a1-7909-42c5-9c00-97846f73e735 on attempt 1
2025-05-30 20:14:04,240 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: ad25b7a1-7909-42c5-9c00-97846f73e735, db_id: 510
2025-05-30 20:14:48,384 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'ĞšĞ°ĞºĞ¸Ğµ ĞµÑÑ‚ÑŒ Ğ½ÑĞ°Ğ½ÑÑ‹ Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğµ Ğ½Ğ° 1Ñ ÑƒÑ‚11?...'
2025-05-30 20:14:48,386 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 20:14:48,390 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 20:14:48,390 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 20:14:48,390 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 20:14:48,391 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: e201ce5f-9898-427a-8460-93428fc094cd)
2025-05-30 20:14:48,391 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 20:14:48,392 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 20:14:48,392 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 20:14:48,394 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 20:14:48,394 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 20:14:48,398 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: e201ce5f-9898-427a-8460-93428fc094cd, db_id: 1033
2025-05-30 20:14:48,421 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 20:14:48,424 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 20:14:49,389 - INFO - aiogram.event - Update id=804756358 is handled. Duration 1005 ms by bot id=1750613938
2025-05-30 20:14:52,725 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 20:14:56,977 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: ĞŸÑ€Ğ¸ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğµ Ğ½Ğ° 1Ğ¡:Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ»ĞµĞ¹ 11 (Ğ£Ğ¢11) ĞµÑÑ‚ÑŒ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ²Ğ°Ğ¶Ğ½Ñ‹Ñ… Ğ½ÑĞ°Ğ½ÑĞ¾Ğ², ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ ÑÑ‚Ğ¾Ğ¸Ñ‚ ÑƒÑ‡Ğ¸Ñ‚Ñ‹
2025-05-30 20:14:56,977 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_38647f5e19'}
2025-05-30 20:14:56,977 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1438, 'output_tokens': 253, 'total_tokens': 1691, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 20:14:56,977 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1438 C:253 T:1691
2025-05-30 20:14:56,977 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1691 tokens recorded.
2025-05-30 20:14:56,978 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 20:14:56,978 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 20:14:56,979 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: ĞŸÑ€Ğ¸ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğµ Ğ½Ğ° 1Ğ¡:Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ»ĞµĞ¹ 11 (Ğ£Ğ¢11) ĞµÑÑ‚ÑŒ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ²Ğ°Ğ¶Ğ½Ñ‹Ñ… Ğ½ÑĞ°Ğ½ÑĞ¾Ğ², ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ ÑÑ‚Ğ¾Ğ¸Ñ‚ ÑƒÑ‡Ğ¸Ñ‚Ñ‹...
2025-05-30 20:14:56,982 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: e201ce5f-9898-427a-8460-93428fc094cd)
2025-05-30 20:14:56,982 - INFO - AGENT:agent_airsoft_0faa9616 - Found 1 token usage events for InteractionID: e201ce5f-9898-427a-8460-93428fc094cd.
2025-05-30 20:14:56,983 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: ĞŸÑ€Ğ¸ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğµ Ğ½Ğ° 1Ğ¡:Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ»ĞµĞ¹ 11 (Ğ£Ğ¢11) ĞµÑÑ‚ÑŒ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ²Ğ°Ğ¶Ğ½Ñ‹Ñ… Ğ½ÑĞ°Ğ½ÑĞ¾Ğ², ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ ÑÑ‚Ğ¾Ğ¸Ñ‚ ÑƒÑ‡Ğ¸Ñ‚Ñ‹...
2025-05-30 20:14:56,983 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'ĞŸÑ€Ğ¸ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğµ Ğ½Ğ° 1Ğ¡:Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ»ĞµĞ¹ 11 (Ğ£Ğ¢11) ...'
2025-05-30 20:14:56,985 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'e201ce5f-9898-427a-8460-93428fc094cd', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1438, 'completion_tokens': 253, 'total_tokens': 1691, 'timestamp': '2025-05-30T15:14:56.977897+00:00'}
2025-05-30 20:14:56,985 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: e201ce5f-9898-427a-8460-93428fc094cd
2025-05-30 20:14:56,987 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1034 for interaction_id: e201ce5f-9898-427a-8460-93428fc094cd on attempt 1
2025-05-30 20:14:56,988 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: e201ce5f-9898-427a-8460-93428fc094cd, db_id: 1034
2025-05-30 20:14:56,993 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: e201ce5f-9898-427a-8460-93428fc094cd, db_id: 511
2025-05-30 20:16:23,793 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 20:16:23,804 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 20:18:46,543 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹, ĞºĞ°ĞºĞ¸Ğµ Ñ‚Ğ°Ğ¼ Ğ½ÑĞ°Ğ½ÑÑ‹ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° ...'
2025-05-30 20:18:46,545 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 20:18:46,550 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 20:18:46,550 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 20:18:46,550 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 20:18:46,551 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: afc78495-f64a-4ce6-99d2-4766df0ee43f)
2025-05-30 20:18:46,551 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 20:18:46,552 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 20:18:46,552 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 20:18:46,556 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 20:18:46,556 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 20:18:46,562 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: afc78495-f64a-4ce6-99d2-4766df0ee43f, db_id: 1035
2025-05-30 20:18:46,581 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 20:18:46,584 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 20:18:47,550 - INFO - aiogram.event - Update id=804756359 is handled. Duration 1008 ms by bot id=1750613938
2025-05-30 20:18:48,810 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 20:18:49,002 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 20:18:49,002 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 20:18:49,002 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1715, 'output_tokens': 30, 'total_tokens': 1745, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 20:18:49,002 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1715 C:30 T:1745
2025-05-30 20:18:49,002 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1745 tokens recorded.
2025-05-30 20:18:49,003 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 20:18:49,003 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: knowledgeBase-1748440512419
2025-05-30 20:18:49,003 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO RETRIEVE (knowledgeBase-1748440512419)---
2025-05-30 20:18:49,524 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 20:18:49,542 - INFO - httpx - HTTP Request: POST http://127.0.0.1:6333/collections/platformai/points/query "HTTP/1.1 200 OK"
2025-05-30 20:18:49,547 - INFO - AGENT:agent_airsoft_0faa9616 - ---CHECK RELEVANCE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 20:18:49,547 - INFO - AGENT:agent_airsoft_0faa9616 - Grading documents for question: 'ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹, ĞºĞ°ĞºĞ¸Ğµ Ñ‚Ğ°Ğ¼ Ğ½ÑĞ°Ğ½ÑÑ‹ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ¾Ğ·Ğ²ÑƒÑ‡ĞµĞ½Ñ‹.'
2025-05-30 20:18:49,547 - INFO - AGENT:agent_airsoft_0faa9616 - Using KB-specific model configuration for KB IDs: ['5', '6', '7']
2025-05-30 20:18:49,547 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-nano, temp: 0.0, streaming: False
2025-05-30 20:18:49,571 - INFO - AGENT:agent_airsoft_0faa9616 - Created grading LLM for KB ['5', '6', '7']: gpt-4.1-nano via OpenAI
2025-05-30 20:18:50,490 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 20:18:50,503 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:916 C:6 T:922
2025-05-30 20:18:50,503 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for grading_llm: 922 tokens recorded.
2025-05-30 20:18:50,503 - INFO - AGENT:agent_airsoft_0faa9616 - Total token usage for grading_llm batch: 922 tokens.
2025-05-30 20:18:50,503 - INFO - AGENT:agent_airsoft_0faa9616 - Found 0 relevant documents out of 1 initial (after split).
2025-05-30 20:18:50,504 - INFO - AGENT:agent_airsoft_0faa9616 - ---ASSESS GRADED DOCUMENTS---
2025-05-30 20:18:50,504 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO RELEVANT DOCUMENTS, REWRITE---
2025-05-30 20:18:50,504 - INFO - AGENT:agent_airsoft_0faa9616 - ---TRANSFORM QUERY (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 20:18:50,505 - INFO - AGENT:agent_airsoft_0faa9616 - Using KB-specific model configuration for rewrite. KB IDs: ['5', '6', '7']
2025-05-30 20:18:50,505 - INFO - AGENT:agent_airsoft_0faa9616 - Rewrite attempt 1/3 for question: 'ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹, ĞºĞ°ĞºĞ¸Ğµ Ñ‚Ğ°Ğ¼ Ğ½ÑĞ°Ğ½ÑÑ‹ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ¾Ğ·Ğ²ÑƒÑ‡ĞµĞ½Ñ‹.'
2025-05-30 20:18:50,505 - INFO - AGENT:agent_airsoft_0faa9616 - Rewriting original question: ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹, ĞºĞ°ĞºĞ¸Ğµ Ñ‚Ğ°Ğ¼ Ğ½ÑĞ°Ğ½ÑÑ‹ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ¾Ğ·Ğ²ÑƒÑ‡ĞµĞ½Ñ‹.
2025-05-30 20:18:50,505 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-nano, temp: 0.0, streaming: False
2025-05-30 20:18:50,529 - INFO - AGENT:agent_airsoft_0faa9616 - Created rewrite LLM for KB ['5', '6', '7']: gpt-4.1-nano via OpenAI
2025-05-30 20:18:51,511 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 20:18:51,513 - INFO - AGENT:agent_airsoft_0faa9616 - Rewritten question: ĞšĞ°ĞºĞ¸Ğµ Ğ½ÑĞ°Ğ½ÑÑ‹ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ğ¡ Ğ£Ğ¢11 Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ñ‹ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹?
2025-05-30 20:18:51,513 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:3672 C:19 T:3691
2025-05-30 20:18:51,513 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for rewrite_llm: 3691 tokens recorded.
2025-05-30 20:18:51,514 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 20:18:51,514 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 20:18:51,538 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 20:18:51,541 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 20:18:56,943 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 20:18:57,136 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 20:18:57,136 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 20:18:57,136 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 2535, 'output_tokens': 31, 'total_tokens': 2566, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 20:18:57,136 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:2535 C:31 T:2566
2025-05-30 20:18:57,136 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 2566 tokens recorded.
2025-05-30 20:18:57,137 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 20:18:57,137 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: knowledgeBase-1748440512419
2025-05-30 20:18:57,137 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO RETRIEVE (knowledgeBase-1748440512419)---
2025-05-30 20:18:57,713 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 20:18:57,723 - INFO - httpx - HTTP Request: POST http://127.0.0.1:6333/collections/platformai/points/query "HTTP/1.1 200 OK"
2025-05-30 20:18:57,725 - INFO - AGENT:agent_airsoft_0faa9616 - ---CHECK RELEVANCE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 20:18:57,725 - INFO - AGENT:agent_airsoft_0faa9616 - Grading documents for question: 'ĞšĞ°ĞºĞ¸Ğµ Ğ½ÑĞ°Ğ½ÑÑ‹ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ğ¡ Ğ£Ğ¢11 Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ñ‹ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹?'
2025-05-30 20:18:57,726 - INFO - AGENT:agent_airsoft_0faa9616 - Using KB-specific model configuration for KB IDs: ['5', '6', '7']
2025-05-30 20:18:57,726 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-nano, temp: 0.0, streaming: False
2025-05-30 20:18:57,749 - INFO - AGENT:agent_airsoft_0faa9616 - Created grading LLM for KB ['5', '6', '7']: gpt-4.1-nano via OpenAI
2025-05-30 20:18:58,469 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 20:18:58,479 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:917 C:6 T:923
2025-05-30 20:18:58,479 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for grading_llm: 923 tokens recorded.
2025-05-30 20:18:58,479 - INFO - AGENT:agent_airsoft_0faa9616 - Total token usage for grading_llm batch: 1845 tokens.
2025-05-30 20:18:58,479 - INFO - AGENT:agent_airsoft_0faa9616 - Found 1 relevant documents out of 1 initial (after split).
2025-05-30 20:18:58,480 - INFO - AGENT:agent_airsoft_0faa9616 - ---ASSESS GRADED DOCUMENTS---
2025-05-30 20:18:58,480 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: RELEVANT DOCUMENTS FOUND, GENERATE---
2025-05-30 20:18:58,481 - INFO - AGENT:agent_airsoft_0faa9616 - ---GENERATE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 20:18:58,481 - INFO - AGENT:agent_airsoft_0faa9616 - Using KB-specific model configuration for generation. KB IDs: ['5', '6', '7']
2025-05-30 20:18:58,481 - INFO - AGENT:agent_airsoft_0faa9616 - Generating answer for question: 'ĞšĞ°ĞºĞ¸Ğµ Ğ½ÑĞ°Ğ½ÑÑ‹ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ğ¡ Ğ£Ğ¢11 Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ñ‹ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹?' using 1 documents.
2025-05-30 20:18:58,481 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-nano, temp: 0.1, streaming: True
2025-05-30 20:18:58,504 - INFO - AGENT:agent_airsoft_0faa9616 - Created generate LLM for KB ['5', '6', '7']: gpt-4.1-nano via OpenAI
2025-05-30 20:18:59,103 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 20:19:00,354 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:886 C:86 T:972
2025-05-30 20:19:00,354 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for generation_llm: 972 tokens recorded.
2025-05-30 20:19:00,356 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 20:19:00,356 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 20:19:00,380 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 20:19:00,382 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 20:19:01,971 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 20:19:06,995 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ’ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ñ‹ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ Ğ½ÑĞ°Ğ½ÑÑ‹ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ğ¡ Ğ£Ğ¢11:

- ĞÑƒĞ¶Ğ½Ğ¾ Ñ€ĞµÑˆĞ¸Ñ‚ÑŒ, Ğ¿ĞµÑ€ĞµĞ½Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ»Ğ¸ ÑĞ²Ğ¾Ñ Ğ±Ğ¸Ğ·Ğ½
2025-05-30 20:19:06,995 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 20:19:06,995 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 3413, 'output_tokens': 360, 'total_tokens': 3773, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 20:19:06,995 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:3413 C:360 T:3773
2025-05-30 20:19:06,995 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 3773 tokens recorded.
2025-05-30 20:19:06,996 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 20:19:06,996 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 20:19:06,997 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ’ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ñ‹ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ Ğ½ÑĞ°Ğ½ÑÑ‹ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ğ¡ Ğ£Ğ¢11:

- ĞÑƒĞ¶Ğ½Ğ¾ Ñ€ĞµÑˆĞ¸Ñ‚ÑŒ, Ğ¿ĞµÑ€ĞµĞ½Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ»Ğ¸ ÑĞ²Ğ¾Ñ Ğ±Ğ¸Ğ·Ğ½...
2025-05-30 20:19:07,000 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: afc78495-f64a-4ce6-99d2-4766df0ee43f)
2025-05-30 20:19:07,001 - INFO - AGENT:agent_airsoft_0faa9616 - Found 7 token usage events for InteractionID: afc78495-f64a-4ce6-99d2-4766df0ee43f.
2025-05-30 20:19:07,003 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'afc78495-f64a-4ce6-99d2-4766df0ee43f', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1715, 'completion_tokens': 30, 'total_tokens': 1745, 'timestamp': '2025-05-30T15:18:49.002936+00:00'}
2025-05-30 20:19:07,003 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: afc78495-f64a-4ce6-99d2-4766df0ee43f
2025-05-30 20:19:07,005 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Ğ’ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ñ‹ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ Ğ½ÑĞ°Ğ½ÑÑ‹ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ğ¡ Ğ£Ğ¢11:

- ĞÑƒĞ¶Ğ½Ğ¾ Ñ€ĞµÑˆĞ¸Ñ‚ÑŒ, Ğ¿ĞµÑ€ĞµĞ½Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ»Ğ¸ ÑĞ²Ğ¾Ñ Ğ±Ğ¸Ğ·Ğ½...
2025-05-30 20:19:07,005 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Ğ’ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ñ‹ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ Ğ½ÑĞ°Ğ½ÑÑ‹ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ°...'
2025-05-30 20:19:07,008 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: afc78495-f64a-4ce6-99d2-4766df0ee43f, db_id: 1036
2025-05-30 20:19:07,008 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1036 for interaction_id: afc78495-f64a-4ce6-99d2-4766df0ee43f on attempt 1
2025-05-30 20:19:07,012 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: afc78495-f64a-4ce6-99d2-4766df0ee43f, db_id: 512
2025-05-30 20:19:07,015 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'afc78495-f64a-4ce6-99d2-4766df0ee43f', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 3413, 'completion_tokens': 360, 'total_tokens': 3773, 'timestamp': '2025-05-30T15:19:06.995396+00:00'}
2025-05-30 20:19:07,015 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: afc78495-f64a-4ce6-99d2-4766df0ee43f
2025-05-30 20:19:07,016 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1036 for interaction_id: afc78495-f64a-4ce6-99d2-4766df0ee43f on attempt 1
2025-05-30 20:19:07,019 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: afc78495-f64a-4ce6-99d2-4766df0ee43f, db_id: 513
2025-05-30 20:19:07,021 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'afc78495-f64a-4ce6-99d2-4766df0ee43f', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'generation_llm', 'model_id': 'gpt-4.1-nano-2025-04-14', 'prompt_tokens': 886, 'completion_tokens': 86, 'total_tokens': 972, 'timestamp': '2025-05-30T15:19:00.354987+00:00'}
2025-05-30 20:19:07,021 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: afc78495-f64a-4ce6-99d2-4766df0ee43f
2025-05-30 20:19:07,022 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1036 for interaction_id: afc78495-f64a-4ce6-99d2-4766df0ee43f on attempt 1
2025-05-30 20:19:07,024 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: afc78495-f64a-4ce6-99d2-4766df0ee43f, db_id: 514
2025-05-30 20:19:07,027 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'afc78495-f64a-4ce6-99d2-4766df0ee43f', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'grading_llm', 'model_id': 'gpt-4.1-nano-2025-04-14', 'prompt_tokens': 917, 'completion_tokens': 6, 'total_tokens': 923, 'timestamp': '2025-05-30T15:18:58.479599+00:00'}
2025-05-30 20:19:07,027 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: afc78495-f64a-4ce6-99d2-4766df0ee43f
2025-05-30 20:19:07,028 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1036 for interaction_id: afc78495-f64a-4ce6-99d2-4766df0ee43f on attempt 1
2025-05-30 20:19:07,031 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: afc78495-f64a-4ce6-99d2-4766df0ee43f, db_id: 515
2025-05-30 20:19:07,033 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'afc78495-f64a-4ce6-99d2-4766df0ee43f', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 2535, 'completion_tokens': 31, 'total_tokens': 2566, 'timestamp': '2025-05-30T15:18:57.136626+00:00'}
2025-05-30 20:19:07,033 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: afc78495-f64a-4ce6-99d2-4766df0ee43f
2025-05-30 20:19:07,034 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1036 for interaction_id: afc78495-f64a-4ce6-99d2-4766df0ee43f on attempt 1
2025-05-30 20:19:07,036 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: afc78495-f64a-4ce6-99d2-4766df0ee43f, db_id: 516
2025-05-30 20:19:07,038 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'afc78495-f64a-4ce6-99d2-4766df0ee43f', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'rewrite_llm', 'model_id': 'gpt-4.1-nano-2025-04-14', 'prompt_tokens': 3672, 'completion_tokens': 19, 'total_tokens': 3691, 'timestamp': '2025-05-30T15:18:51.513155+00:00'}
2025-05-30 20:19:07,038 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: afc78495-f64a-4ce6-99d2-4766df0ee43f
2025-05-30 20:19:07,040 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1036 for interaction_id: afc78495-f64a-4ce6-99d2-4766df0ee43f on attempt 1
2025-05-30 20:19:07,042 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: afc78495-f64a-4ce6-99d2-4766df0ee43f, db_id: 517
2025-05-30 20:19:07,045 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'afc78495-f64a-4ce6-99d2-4766df0ee43f', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'grading_llm', 'model_id': 'gpt-4.1-nano-2025-04-14', 'prompt_tokens': 916, 'completion_tokens': 6, 'total_tokens': 922, 'timestamp': '2025-05-30T15:18:50.503458+00:00'}
2025-05-30 20:19:07,045 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: afc78495-f64a-4ce6-99d2-4766df0ee43f
2025-05-30 20:19:07,046 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1036 for interaction_id: afc78495-f64a-4ce6-99d2-4766df0ee43f on attempt 1
2025-05-30 20:19:07,048 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: afc78495-f64a-4ce6-99d2-4766df0ee43f, db_id: 518
2025-05-30 20:21:23,988 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 20:21:23,996 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 20:22:27,788 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-30 20:22:27,806 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-30 20:22:27,807 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-30 20:22:27,807 - INFO - app.db.crud.agent_crud - Updating agent config in DB for agent_id: agent_airsoft_0faa9616
2025-05-30 20:22:27,830 - INFO - app.db.crud.agent_crud - Agent config updated successfully for agent_id: agent_airsoft_0faa9616
2025-05-30 20:22:27,830 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616 was running. Attempting to restart it after config update.
2025-05-30 20:22:27,830 - INFO - app.services.process_manager - Restarting agent process for agent_airsoft_0faa9616...
2025-05-30 20:22:27,831 - INFO - app.services.process_manager - Stopping agent process agent_airsoft_0faa9616 (PID: 91941). Force: True
2025-05-30 20:22:27,831 - INFO - app.services.process_manager - SIGTERM sent to agent agent_airsoft_0faa9616 (PID: 91941)
2025-05-30 20:22:27,931 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 (PID: 91941) terminated gracefully after SIGTERM.
2025-05-30 20:22:27,933 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 marked as stopped in Redis.
2025-05-30 20:22:27,933 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 stopped (or stop attempted and assumed successful for restart). Pausing briefly...
2025-05-30 20:22:32,934 - INFO - app.services.process_manager - Proceeding to start agent agent_airsoft_0faa9616 after delay...
2025-05-30 20:22:32,936 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 20:22:32,937 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 92074
2025-05-30 20:22:32,937 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 92074
2025-05-30 20:22:32,937 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 successfully started as part of restart sequence.
2025-05-30 20:22:32,937 - INFO - app.api.routers.agent_api - Restart command issued for agent agent_airsoft_0faa9616 after config update.
2025-05-30 20:22:32,938 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:22:32,938 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 20:22:34,363 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 20:22:34,364 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 20:22:34,364 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 20:22:34,364 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 20:22:34,364 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 92074
2025-05-30 20:22:34,364 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 20:22:34,364 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 20:22:34,364 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 20:22:34,406 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 20:22:34,406 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 20:22:34,449 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 20:22:34,449 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 20:22:34,449 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 20:22:34,449 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 20:22:34,449 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 20:22:34,449 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 20:22:34,474 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 20:22:34,475 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 20:22:34,475 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 20:22:34,476 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET) wirh description: ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ±Ğ»Ğ¾Ğ³Ğ°)
2025-05-30 20:22:34,476 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET) wirh description: Ğ£Ğ·Ğ½Ğ°Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² (Ğ±Ğ±) Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.)
2025-05-30 20:22:34,477 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 20:22:34,477 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 20:22:34,531 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 20:22:34,535 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 20:22:35,147 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 20:22:35,150 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 20:22:35,150 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'airsoft' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7'] with description: Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ 1Ñ
2025-05-30 20:22:35,150 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 20:22:35,150 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'airsoft-rus.ru' (ID: webSearch-1748459212676) with description: ĞŸĞ¾Ğ¸ÑĞº Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ ÑÑ‚Ñ€Ğ°Ğ¹ĞºĞ±Ğ¾Ğ»Ñƒ Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼ Ğ´Ğ»Ñ ÑÑ‚Ñ€Ğ°Ğ¹ĞºĞ±Ğ¾Ğ»Ğ° Ğ½Ğ° ÑĞ°Ğ¹Ñ‚Ğµ.
2025-05-30 20:22:35,150 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 20:22:35,150 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 20:22:35,150 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 20:22:35,150 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 20:22:35,151 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 20:22:35,151 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 20:22:35,151 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 20:22:35,151 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 20:22:35,151 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->agent
2025-05-30 20:22:35,151 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 20:22:35,151 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 20:22:35,162 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 20:22:35,162 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 20:22:35,162 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 20:22:35,162 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4463944544) setup complete. Starting run loop.
2025-05-30 20:22:35,162 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 20:22:35,162 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 20:22:35,162 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 20:22:35,163 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 20:22:35,166 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 20:22:57,982 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Ñ‡Ñ‚Ğ¾ Ñƒ Ñ‚ĞµĞ±Ñ ĞµÑÑ‚ÑŒ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ½Ğ° Ñ‚ĞµĞ¼Ñƒ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¹?...'
2025-05-30 20:22:57,983 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 20:22:57,990 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 20:22:57,990 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 20:22:57,990 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 20:22:57,991 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: b7a45529-ca31-4244-b83c-268e4c1744f2)
2025-05-30 20:22:57,991 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 20:22:57,992 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 20:22:57,992 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 20:22:57,999 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: b7a45529-ca31-4244-b83c-268e4c1744f2, db_id: 1037
2025-05-30 20:22:58,066 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 20:22:58,066 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 20:22:58,091 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 20:22:58,095 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 20:22:58,991 - INFO - aiogram.event - Update id=804756360 is handled. Duration 1011 ms by bot id=1750613938
2025-05-30 20:22:59,130 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 20:22:59,139 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 20:22:59,139 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 20:22:59,139 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 381, 'output_tokens': 23, 'total_tokens': 404, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 20:22:59,139 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:381 C:23 T:404
2025-05-30 20:22:59,139 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 404 tokens recorded.
2025-05-30 20:22:59,140 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 20:22:59,140 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: knowledgeBase-1748440512419
2025-05-30 20:22:59,140 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO RETRIEVE (knowledgeBase-1748440512419)---
2025-05-30 20:22:59,668 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 20:22:59,682 - INFO - httpx - HTTP Request: POST http://127.0.0.1:6333/collections/platformai/points/query "HTTP/1.1 200 OK"
2025-05-30 20:22:59,685 - INFO - AGENT:agent_airsoft_0faa9616 - ---CHECK RELEVANCE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 20:22:59,685 - INFO - AGENT:agent_airsoft_0faa9616 - Grading documents for question: 'Ñ‡Ñ‚Ğ¾ Ñƒ Ñ‚ĞµĞ±Ñ ĞµÑÑ‚ÑŒ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ½Ğ° Ñ‚ĞµĞ¼Ñƒ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¹?'
2025-05-30 20:22:59,685 - INFO - AGENT:agent_airsoft_0faa9616 - Using KB-specific model configuration for KB IDs: ['5', '6', '7']
2025-05-30 20:22:59,685 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: mistralai/mistral-small-3.1-24b-instruct:free, temp: 0.0, streaming: False
2025-05-30 20:22:59,708 - INFO - AGENT:agent_airsoft_0faa9616 - Created grading LLM for KB ['5', '6', '7']: mistralai/mistral-small-3.1-24b-instruct:free via OpenAI
2025-05-30 20:23:00,191 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 400 Bad Request"
2025-05-30 20:23:00,197 - ERROR - AGENT:agent_airsoft_0faa9616 - Error processing document for grading ('## ĞœĞ˜ĞĞ¤Ğ˜Ğ Ğ ĞĞ¡Ğ¡Ğ˜Ğ˜ Ğ¤Ğ•Ğ”Ğ•Ğ ĞĞ›Ğ¬ĞĞĞ¯ ĞĞĞ›ĞĞ“ĞĞ’ĞĞ¯ Ğ¡Ğ›Ğ£Ğ–Ğ‘Ğ Ğ£Ğ¤ĞĞ¡ Ğ ĞĞ¡Ğ¡Ğ˜Ğ˜ ĞŸĞ Ğ¡Ğ’Ğ•Ğ Ğ”Ğ›ĞĞ’Ğ¡ĞšĞĞ™ ĞĞ‘Ğ›ĞĞ¡Ğ¢Ğ˜

**ĞœĞ•Ğ–Ğ ĞĞ™ĞĞĞĞĞ¯ Ğ˜ĞĞ¡...'): Error code: 400 - {'error': {'message': 'invalid model ID', 'type': 'invalid_request_error', 'param': None, 'code': None}}
Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/agent_runner/langgraph/factory.py", line 420, in process_doc
    invocation_result = await chain.ainvoke({"question": current_question, "context": doc_content})
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3071, in ainvoke
    input = await asyncio.create_task(part(), context=context)  # type: ignore
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3780, in ainvoke
    results = await asyncio.gather(
              ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3770, in _ainvoke_step
    return await asyncio.create_task(  # type: ignore
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 5377, in ainvoke
    return await self.bound.ainvoke(
           ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 328, in ainvoke
    llm_result = await self.agenerate_prompt(
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 853, in agenerate_prompt
    return await self.agenerate(
           ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 813, in agenerate
    raise exceptions[0]
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 981, in _agenerate_with_cache
    result = await self._agenerate(
             ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_openai/chat_models/base.py", line 1098, in _agenerate
    _handle_openai_bad_request(e)
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_openai/chat_models/base.py", line 1094, in _agenerate
    response = await self.root_async_client.beta.chat.completions.parse(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/resources/beta/chat/completions.py", line 437, in parse
    return await self._post(
           ^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1767, in post
    return await self.request(cast_to, opts, stream=stream, stream_cls=stream_cls)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1461, in request
    return await self._request(
           ^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1562, in _request
    raise self._make_status_error_from_response(err.response) from None
openai.BadRequestError: Error code: 400 - {'error': {'message': 'invalid model ID', 'type': 'invalid_request_error', 'param': None, 'code': None}}
2025-05-30 20:23:00,198 - INFO - AGENT:agent_airsoft_0faa9616 - Found 0 relevant documents out of 1 initial (after split).
2025-05-30 20:23:00,199 - INFO - AGENT:agent_airsoft_0faa9616 - ---ASSESS GRADED DOCUMENTS---
2025-05-30 20:23:00,199 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO RELEVANT DOCUMENTS, REWRITE---
2025-05-30 20:23:00,200 - INFO - AGENT:agent_airsoft_0faa9616 - ---TRANSFORM QUERY (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 20:23:00,200 - INFO - AGENT:agent_airsoft_0faa9616 - Using KB-specific model configuration for rewrite. KB IDs: ['5', '6', '7']
2025-05-30 20:23:00,200 - INFO - AGENT:agent_airsoft_0faa9616 - Rewrite attempt 1/3 for question: 'Ñ‡Ñ‚Ğ¾ Ñƒ Ñ‚ĞµĞ±Ñ ĞµÑÑ‚ÑŒ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ½Ğ° Ñ‚ĞµĞ¼Ñƒ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¹?'
2025-05-30 20:23:00,200 - INFO - AGENT:agent_airsoft_0faa9616 - Rewriting original question: Ñ‡Ñ‚Ğ¾ Ñƒ Ñ‚ĞµĞ±Ñ ĞµÑÑ‚ÑŒ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ½Ğ° Ñ‚ĞµĞ¼Ñƒ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¹?
2025-05-30 20:23:00,200 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: mistralai/mistral-small-3.1-24b-instruct:free, temp: 0.0, streaming: False
2025-05-30 20:23:00,224 - INFO - AGENT:agent_airsoft_0faa9616 - Created rewrite LLM for KB ['5', '6', '7']: mistralai/mistral-small-3.1-24b-instruct:free via OpenAI
2025-05-30 20:23:00,684 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 400 Bad Request"
2025-05-30 20:23:00,686 - ERROR - AGENT:agent_airsoft_0faa9616 - Error during question rewriting: Error code: 400 - {'error': {'message': 'invalid model ID', 'type': 'invalid_request_error', 'param': None, 'code': None}}
Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/agent_runner/langgraph/factory.py", line 517, in _rewrite_node
    response = await model.ainvoke([prompt_msg])
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 328, in ainvoke
    llm_result = await self.agenerate_prompt(
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 853, in agenerate_prompt
    return await self.agenerate(
           ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 813, in agenerate
    raise exceptions[0]
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 981, in _agenerate_with_cache
    result = await self._agenerate(
             ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_openai/chat_models/base.py", line 1122, in _agenerate
    response = await self.async_client.create(**payload)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/resources/chat/completions/completions.py", line 2000, in create
    return await self._post(
           ^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1767, in post
    return await self.request(cast_to, opts, stream=stream, stream_cls=stream_cls)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1461, in request
    return await self._request(
           ^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1562, in _request
    raise self._make_status_error_from_response(err.response) from None
openai.BadRequestError: Error code: 400 - {'error': {'message': 'invalid model ID', 'type': 'invalid_request_error', 'param': None, 'code': None}}
2025-05-30 20:23:00,687 - WARNING - AGENT:agent_airsoft_0faa9616 - Max rewrites (3) reached or rewrite failed for original question: 'Ñ‡Ñ‚Ğ¾ Ñƒ Ñ‚ĞµĞ±Ñ ĞµÑÑ‚ÑŒ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ½Ğ° Ñ‚ĞµĞ¼Ñƒ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¹?'
2025-05-30 20:23:00,688 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 20:23:00,688 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 20:23:00,712 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 20:23:00,714 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 20:23:01,564 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 20:23:03,097 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ’ Ğ½Ğ°ÑˆĞµĞ¹ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ ĞµÑÑ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ, ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ğ°Ñ Ñ Ğ¤ĞµĞ´ĞµÑ€Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¹ ÑĞ»ÑƒĞ¶Ğ±Ğ¾Ğ¹ Ğ Ğ¾ÑÑĞ¸Ğ¸, Ğ² Ñ‚Ğ¾Ğ¼ Ñ‡Ğ¸ÑĞ»Ğµ Ğ¿
2025-05-30 20:23:03,097 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 20:23:03,097 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1174, 'output_tokens': 71, 'total_tokens': 1245, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 20:23:03,097 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1174 C:71 T:1245
2025-05-30 20:23:03,097 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1245 tokens recorded.
2025-05-30 20:23:03,098 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 20:23:03,098 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 20:23:03,099 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ’ Ğ½Ğ°ÑˆĞµĞ¹ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ ĞµÑÑ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ, ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ğ°Ñ Ñ Ğ¤ĞµĞ´ĞµÑ€Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¹ ÑĞ»ÑƒĞ¶Ğ±Ğ¾Ğ¹ Ğ Ğ¾ÑÑĞ¸Ğ¸, Ğ² Ñ‚Ğ¾Ğ¼ Ñ‡Ğ¸ÑĞ»Ğµ Ğ¿...
2025-05-30 20:23:03,101 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: b7a45529-ca31-4244-b83c-268e4c1744f2)
2025-05-30 20:23:03,101 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: b7a45529-ca31-4244-b83c-268e4c1744f2.
2025-05-30 20:23:03,104 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Ğ’ Ğ½Ğ°ÑˆĞµĞ¹ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ ĞµÑÑ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ, ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ğ°Ñ Ñ Ğ¤ĞµĞ´ĞµÑ€Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¹ ÑĞ»ÑƒĞ¶Ğ±Ğ¾Ğ¹ Ğ Ğ¾ÑÑĞ¸Ğ¸, Ğ² Ñ‚Ğ¾Ğ¼ Ñ‡Ğ¸ÑĞ»Ğµ Ğ¿...
2025-05-30 20:23:03,104 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Ğ’ Ğ½Ğ°ÑˆĞµĞ¹ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ ĞµÑÑ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ, ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ğ°Ñ Ñ Ğ¤...'
2025-05-30 20:23:03,105 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'b7a45529-ca31-4244-b83c-268e4c1744f2', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 381, 'completion_tokens': 23, 'total_tokens': 404, 'timestamp': '2025-05-30T15:22:59.139969+00:00'}
2025-05-30 20:23:03,105 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: b7a45529-ca31-4244-b83c-268e4c1744f2
2025-05-30 20:23:03,107 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1038 for interaction_id: b7a45529-ca31-4244-b83c-268e4c1744f2 on attempt 1
2025-05-30 20:23:03,108 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: b7a45529-ca31-4244-b83c-268e4c1744f2, db_id: 1038
2025-05-30 20:23:03,112 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: b7a45529-ca31-4244-b83c-268e4c1744f2, db_id: 519
2025-05-30 20:23:03,115 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'b7a45529-ca31-4244-b83c-268e4c1744f2', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1174, 'completion_tokens': 71, 'total_tokens': 1245, 'timestamp': '2025-05-30T15:23:03.097244+00:00'}
2025-05-30 20:23:03,115 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: b7a45529-ca31-4244-b83c-268e4c1744f2
2025-05-30 20:23:03,116 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1038 for interaction_id: b7a45529-ca31-4244-b83c-268e4c1744f2 on attempt 1
2025-05-30 20:23:03,120 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: b7a45529-ca31-4244-b83c-268e4c1744f2, db_id: 520
2025-05-30 20:26:24,178 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 20:26:24,187 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 20:31:24,372 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 20:31:24,380 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 20:36:24,576 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 20:36:24,588 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 20:41:24,790 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 20:41:24,802 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 20:46:24,979 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 20:46:24,986 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 20:46:43,592 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-30 20:46:43,600 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-30 20:46:43,601 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-30 20:46:43,601 - INFO - app.db.crud.agent_crud - Updating agent config in DB for agent_id: agent_airsoft_0faa9616
2025-05-30 20:46:43,623 - INFO - app.db.crud.agent_crud - Agent config updated successfully for agent_id: agent_airsoft_0faa9616
2025-05-30 20:46:43,623 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616 was running. Attempting to restart it after config update.
2025-05-30 20:46:43,623 - INFO - app.services.process_manager - Restarting agent process for agent_airsoft_0faa9616...
2025-05-30 20:46:43,625 - INFO - app.services.process_manager - Stopping agent process agent_airsoft_0faa9616 (PID: 92074). Force: True
2025-05-30 20:46:43,625 - INFO - app.services.process_manager - SIGTERM sent to agent agent_airsoft_0faa9616 (PID: 92074)
2025-05-30 20:46:43,726 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 (PID: 92074) terminated gracefully after SIGTERM.
2025-05-30 20:46:43,729 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 marked as stopped in Redis.
2025-05-30 20:46:43,729 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 stopped (or stop attempted and assumed successful for restart). Pausing briefly...
2025-05-30 20:46:48,728 - INFO - app.services.process_manager - Proceeding to start agent agent_airsoft_0faa9616 after delay...
2025-05-30 20:46:48,730 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 20:46:48,735 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 93329
2025-05-30 20:46:48,735 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 93329
2025-05-30 20:46:48,735 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 successfully started as part of restart sequence.
2025-05-30 20:46:48,735 - INFO - app.api.routers.agent_api - Restart command issued for agent agent_airsoft_0faa9616 after config update.
2025-05-30 20:46:48,736 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:46:48,736 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 20:46:50,395 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 20:46:50,395 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 20:46:50,395 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 20:46:50,395 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 20:46:50,395 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 93329
2025-05-30 20:46:50,395 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 20:46:50,395 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 20:46:50,395 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 20:46:50,440 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 20:46:50,440 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 20:46:50,481 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 20:46:50,482 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 20:46:50,482 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 20:46:50,482 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 20:46:50,482 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 20:46:50,482 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 20:46:50,507 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 20:46:50,507 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 20:46:50,507 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 20:46:50,508 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET) wirh description: ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ±Ğ»Ğ¾Ğ³Ğ°)
2025-05-30 20:46:50,509 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET) wirh description: Ğ£Ğ·Ğ½Ğ°Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² (Ğ±Ğ±) Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.)
2025-05-30 20:46:50,509 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 20:46:50,509 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 20:46:50,570 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 20:46:50,578 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 20:46:51,358 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 20:46:51,361 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 20:46:51,361 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'airsoft' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7'] with description: Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ 1Ñ
2025-05-30 20:46:51,361 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 20:46:51,361 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'airsoft-rus.ru' (ID: webSearch-1748459212676) with description: ĞŸĞ¾Ğ¸ÑĞº Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ ÑÑ‚Ñ€Ğ°Ğ¹ĞºĞ±Ğ¾Ğ»Ñƒ Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼ Ğ´Ğ»Ñ ÑÑ‚Ñ€Ğ°Ğ¹ĞºĞ±Ğ¾Ğ»Ğ° Ğ½Ğ° ÑĞ°Ğ¹Ñ‚Ğµ.
2025-05-30 20:46:51,361 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 20:46:51,361 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 20:46:51,361 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 20:46:51,361 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 20:46:51,362 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 20:46:51,362 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 20:46:51,362 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 20:46:51,362 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 20:46:51,362 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->agent
2025-05-30 20:46:51,362 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 20:46:51,362 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 20:46:51,372 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 20:46:51,372 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 20:46:51,372 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 20:46:51,372 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4560582416) setup complete. Starting run loop.
2025-05-30 20:46:51,372 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 20:46:51,372 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 20:46:51,372 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 20:46:51,372 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 20:46:51,376 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 20:47:10,673 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-30 20:47:10,679 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-30 20:47:10,682 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-30 20:47:10,682 - INFO - app.db.crud.agent_crud - Updating agent config in DB for agent_id: agent_airsoft_0faa9616
2025-05-30 20:47:10,697 - INFO - app.db.crud.agent_crud - Agent config updated successfully for agent_id: agent_airsoft_0faa9616
2025-05-30 20:47:10,697 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616 was running. Attempting to restart it after config update.
2025-05-30 20:47:10,698 - INFO - app.services.process_manager - Restarting agent process for agent_airsoft_0faa9616...
2025-05-30 20:47:10,701 - INFO - app.services.process_manager - Stopping agent process agent_airsoft_0faa9616 (PID: 93329). Force: True
2025-05-30 20:47:10,701 - INFO - app.services.process_manager - SIGTERM sent to agent agent_airsoft_0faa9616 (PID: 93329)
2025-05-30 20:47:10,802 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 (PID: 93329) terminated gracefully after SIGTERM.
2025-05-30 20:47:10,804 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 marked as stopped in Redis.
2025-05-30 20:47:10,804 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 stopped (or stop attempted and assumed successful for restart). Pausing briefly...
2025-05-30 20:47:15,804 - INFO - app.services.process_manager - Proceeding to start agent agent_airsoft_0faa9616 after delay...
2025-05-30 20:47:15,807 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 20:47:15,808 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 93356
2025-05-30 20:47:15,808 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 93356
2025-05-30 20:47:15,809 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 successfully started as part of restart sequence.
2025-05-30 20:47:15,809 - INFO - app.api.routers.agent_api - Restart command issued for agent agent_airsoft_0faa9616 after config update.
2025-05-30 20:47:15,809 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 20:47:15,809 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 20:47:17,066 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 20:47:17,066 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 20:47:17,066 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 20:47:17,066 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 20:47:17,066 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 93356
2025-05-30 20:47:17,066 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 20:47:17,066 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 20:47:17,066 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 20:47:17,109 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 20:47:17,109 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 20:47:17,145 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 20:47:17,145 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 20:47:17,145 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 20:47:17,145 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 20:47:17,145 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 20:47:17,145 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 20:47:17,170 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 20:47:17,170 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 20:47:17,170 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 20:47:17,171 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET) wirh description: ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ±Ğ»Ğ¾Ğ³Ğ°)
2025-05-30 20:47:17,172 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET) wirh description: Ğ£Ğ·Ğ½Ğ°Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² (Ğ±Ğ±) Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.)
2025-05-30 20:47:17,172 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 20:47:17,172 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 20:47:17,227 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 20:47:17,230 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 20:47:18,320 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 20:47:18,322 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 20:47:18,323 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'airsoft' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7'] with description: Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ 1Ñ
2025-05-30 20:47:18,323 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 20:47:18,323 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'airsoft-rus.ru' (ID: webSearch-1748459212676) with description: ĞŸĞ¾Ğ¸ÑĞº Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ ÑÑ‚Ñ€Ğ°Ğ¹ĞºĞ±Ğ¾Ğ»Ñƒ Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼ Ğ´Ğ»Ñ ÑÑ‚Ñ€Ğ°Ğ¹ĞºĞ±Ğ¾Ğ»Ğ° Ğ½Ğ° ÑĞ°Ğ¹Ñ‚Ğµ.
2025-05-30 20:47:18,323 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 20:47:18,323 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 20:47:18,323 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 20:47:18,323 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 20:47:18,323 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 20:47:18,324 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 20:47:18,324 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 20:47:18,324 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 20:47:18,324 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->agent
2025-05-30 20:47:18,324 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 20:47:18,324 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 20:47:18,334 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 20:47:18,334 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 20:47:18,334 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 20:47:18,334 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4792367344) setup complete. Starting run loop.
2025-05-30 20:47:18,334 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 20:47:18,334 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 20:47:18,334 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 20:47:18,334 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 20:47:18,338 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 20:51:25,177 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 20:51:25,186 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 20:56:25,365 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 20:56:25,374 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 21:01:25,570 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 21:01:25,580 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 21:06:25,759 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 21:06:25,769 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 21:11:25,969 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 21:11:25,979 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 21:13:04,354 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-30 21:13:04,365 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-30 21:13:04,368 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-30 21:13:04,368 - INFO - app.db.crud.agent_crud - Updating agent config in DB for agent_id: agent_airsoft_0faa9616
2025-05-30 21:13:04,399 - INFO - app.db.crud.agent_crud - Agent config updated successfully for agent_id: agent_airsoft_0faa9616
2025-05-30 21:13:04,400 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616 was running. Attempting to restart it after config update.
2025-05-30 21:13:04,400 - INFO - app.services.process_manager - Restarting agent process for agent_airsoft_0faa9616...
2025-05-30 21:13:04,401 - INFO - app.services.process_manager - Stopping agent process agent_airsoft_0faa9616 (PID: 93356). Force: True
2025-05-30 21:13:04,401 - INFO - app.services.process_manager - SIGTERM sent to agent agent_airsoft_0faa9616 (PID: 93356)
2025-05-30 21:13:04,502 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 (PID: 93356) terminated gracefully after SIGTERM.
2025-05-30 21:13:04,505 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 marked as stopped in Redis.
2025-05-30 21:13:04,505 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 stopped (or stop attempted and assumed successful for restart). Pausing briefly...
2025-05-30 21:13:09,506 - INFO - app.services.process_manager - Proceeding to start agent agent_airsoft_0faa9616 after delay...
2025-05-30 21:13:09,509 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 21:13:09,512 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 93863
2025-05-30 21:13:09,512 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 93863
2025-05-30 21:13:09,513 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 successfully started as part of restart sequence.
2025-05-30 21:13:09,513 - INFO - app.api.routers.agent_api - Restart command issued for agent agent_airsoft_0faa9616 after config update.
2025-05-30 21:13:09,513 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 21:13:09,513 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 21:13:11,086 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 21:13:11,087 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 21:13:11,087 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 21:13:11,087 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 21:13:11,087 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 93863
2025-05-30 21:13:11,087 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 21:13:11,087 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 21:13:11,087 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 21:13:11,130 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 21:13:11,130 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 21:13:11,171 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 21:13:11,172 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 21:13:11,172 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 21:13:11,172 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 21:13:11,172 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 21:13:11,172 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 21:13:11,197 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 21:13:11,197 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 21:13:11,197 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 21:13:11,198 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET) wirh description: ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ±Ğ»Ğ¾Ğ³Ğ°)
2025-05-30 21:13:11,199 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET) wirh description: Ğ£Ğ·Ğ½Ğ°Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² (Ğ±Ğ±) Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.)
2025-05-30 21:13:11,199 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 21:13:11,199 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 21:13:11,257 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 21:13:11,266 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 21:13:12,709 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 21:13:12,715 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 21:13:12,715 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'airsoft' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7'] with description: Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ 1Ñ
2025-05-30 21:13:12,715 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 21:13:12,715 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'airsoft-rus.ru' (ID: webSearch-1748459212676) with description: ĞŸĞ¾Ğ¸ÑĞº Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ ÑÑ‚Ñ€Ğ°Ğ¹ĞºĞ±Ğ¾Ğ»Ñƒ Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼ Ğ´Ğ»Ñ ÑÑ‚Ñ€Ğ°Ğ¹ĞºĞ±Ğ¾Ğ»Ğ° Ğ½Ğ° ÑĞ°Ğ¹Ñ‚Ğµ.
2025-05-30 21:13:12,715 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 21:13:12,715 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 21:13:12,715 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 21:13:12,715 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 21:13:12,716 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 21:13:12,717 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 21:13:12,717 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 21:13:12,717 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 21:13:12,717 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->agent
2025-05-30 21:13:12,717 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 21:13:12,717 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 21:13:12,728 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 21:13:12,728 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 21:13:12,729 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 21:13:12,729 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4693653696) setup complete. Starting run loop.
2025-05-30 21:13:12,729 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 21:13:12,729 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 21:13:12,729 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 21:13:12,729 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 21:13:12,734 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 21:13:23,398 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-30 21:13:23,403 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-30 21:13:23,403 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-30 21:13:23,404 - INFO - app.db.crud.agent_crud - Updating agent config in DB for agent_id: agent_airsoft_0faa9616
2025-05-30 21:13:23,412 - INFO - app.db.crud.agent_crud - Agent config updated successfully for agent_id: agent_airsoft_0faa9616
2025-05-30 21:13:23,413 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616 was running. Attempting to restart it after config update.
2025-05-30 21:13:23,413 - INFO - app.services.process_manager - Restarting agent process for agent_airsoft_0faa9616...
2025-05-30 21:13:23,414 - INFO - app.services.process_manager - Stopping agent process agent_airsoft_0faa9616 (PID: 93863). Force: True
2025-05-30 21:13:23,414 - INFO - app.services.process_manager - SIGTERM sent to agent agent_airsoft_0faa9616 (PID: 93863)
2025-05-30 21:13:23,514 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 (PID: 93863) terminated gracefully after SIGTERM.
2025-05-30 21:13:23,517 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 marked as stopped in Redis.
2025-05-30 21:13:23,517 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 stopped (or stop attempted and assumed successful for restart). Pausing briefly...
2025-05-30 21:13:28,517 - INFO - app.services.process_manager - Proceeding to start agent agent_airsoft_0faa9616 after delay...
2025-05-30 21:13:28,520 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 21:13:28,521 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 93892
2025-05-30 21:13:28,521 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 93892
2025-05-30 21:13:28,521 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 successfully started as part of restart sequence.
2025-05-30 21:13:28,521 - INFO - app.api.routers.agent_api - Restart command issued for agent agent_airsoft_0faa9616 after config update.
2025-05-30 21:13:28,521 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 21:13:28,522 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 21:13:29,810 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 21:13:29,810 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 21:13:29,810 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 21:13:29,810 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 21:13:29,810 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 93892
2025-05-30 21:13:29,810 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 21:13:29,810 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 21:13:29,810 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 21:13:29,854 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 21:13:29,854 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 21:13:29,890 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 21:13:29,890 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 21:13:29,890 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 21:13:29,890 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 21:13:29,890 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 21:13:29,891 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 21:13:29,916 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 21:13:29,916 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 21:13:29,916 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 21:13:29,917 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET) wirh description: ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ±Ğ»Ğ¾Ğ³Ğ°)
2025-05-30 21:13:29,918 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET) wirh description: Ğ£Ğ·Ğ½Ğ°Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² (Ğ±Ğ±) Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.)
2025-05-30 21:13:29,918 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 21:13:29,918 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 21:13:29,976 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 21:13:29,984 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 21:13:30,868 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 21:13:30,871 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 21:13:30,871 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'airsoft' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7'] with description: Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ 1Ñ
2025-05-30 21:13:30,871 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 21:13:30,872 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'airsoft-rus.ru' (ID: webSearch-1748459212676) with description: ĞŸĞ¾Ğ¸ÑĞº Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ ÑÑ‚Ñ€Ğ°Ğ¹ĞºĞ±Ğ¾Ğ»Ñƒ Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼ Ğ´Ğ»Ñ ÑÑ‚Ñ€Ğ°Ğ¹ĞºĞ±Ğ¾Ğ»Ğ° Ğ½Ğ° ÑĞ°Ğ¹Ñ‚Ğµ.
2025-05-30 21:13:30,872 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 21:13:30,872 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 21:13:30,872 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 21:13:30,872 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 21:13:30,872 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 21:13:30,872 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 21:13:30,873 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 21:13:30,873 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 21:13:30,873 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->agent
2025-05-30 21:13:30,873 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 21:13:30,873 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 21:13:30,883 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 21:13:30,883 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 21:13:30,883 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 21:13:30,883 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4695914592) setup complete. Starting run loop.
2025-05-30 21:13:30,883 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 21:13:30,883 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 21:13:30,883 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 21:13:30,883 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 21:13:30,887 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 21:16:26,335 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 21:16:26,346 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 21:24:23,921 - ERROR - aiogram.dispatcher - Failed to fetch updates - TelegramNetworkError: HTTP Client says - Request timeout error
2025-05-30 21:24:23,925 - WARNING - aiogram.dispatcher - Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 1750613938)
2025-05-30 21:26:57,597 - ERROR - aiogram.dispatcher - Failed to fetch updates - TelegramNetworkError: HTTP Client says - Request timeout error
2025-05-30 21:26:57,661 - WARNING - aiogram.dispatcher - Sleep for 1.249376 seconds and try again... (tryings = 1, bot id = 1750613938)
2025-05-30 21:27:09,162 - INFO - aiogram.dispatcher - Connection established (tryings = 2, bot id = 1750613938)
2025-05-30 21:31:09,087 - ERROR - aiogram.dispatcher - Failed to fetch updates - TelegramNetworkError: HTTP Client says - Request timeout error
2025-05-30 21:31:09,092 - WARNING - aiogram.dispatcher - Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 1750613938)
2025-05-30 21:31:20,429 - INFO - aiogram.dispatcher - Connection established (tryings = 1, bot id = 1750613938)
2025-05-30 21:32:33,748 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 21:32:33,758 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 21:37:37,570 - ERROR - aiogram.dispatcher - Failed to fetch updates - TelegramNetworkError: HTTP Client says - Request timeout error
2025-05-30 21:37:37,570 - WARNING - aiogram.dispatcher - Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 1750613938)
2025-05-30 21:37:48,841 - INFO - aiogram.dispatcher - Connection established (tryings = 1, bot id = 1750613938)
2025-05-30 21:39:25,603 - ERROR - aiogram.dispatcher - Failed to fetch updates - TelegramNetworkError: HTTP Client says - Request timeout error
2025-05-30 21:39:25,604 - WARNING - aiogram.dispatcher - Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 1750613938)
2025-05-30 21:39:41,566 - INFO - aiogram.dispatcher - Connection established (tryings = 1, bot id = 1750613938)
2025-05-30 21:52:54,151 - ERROR - aiogram.dispatcher - Failed to fetch updates - TelegramNetworkError: HTTP Client says - Request timeout error
2025-05-30 21:52:54,153 - WARNING - aiogram.dispatcher - Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 1750613938)
2025-05-30 21:53:05,435 - INFO - aiogram.dispatcher - Connection established (tryings = 1, bot id = 1750613938)
2025-05-30 21:54:43,502 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 21:54:43,515 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 21:59:43,716 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 21:59:43,725 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 22:04:07,237 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-30 22:04:07,249 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-30 22:04:07,252 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-30 22:04:07,252 - INFO - app.db.crud.agent_crud - Updating agent config in DB for agent_id: agent_airsoft_0faa9616
2025-05-30 22:04:07,284 - INFO - app.db.crud.agent_crud - Agent config updated successfully for agent_id: agent_airsoft_0faa9616
2025-05-30 22:04:07,284 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616 was running. Attempting to restart it after config update.
2025-05-30 22:04:07,284 - INFO - app.services.process_manager - Restarting agent process for agent_airsoft_0faa9616...
2025-05-30 22:04:07,291 - INFO - app.services.process_manager - Stopping agent process agent_airsoft_0faa9616 (PID: 93892). Force: True
2025-05-30 22:04:07,291 - INFO - app.services.process_manager - SIGTERM sent to agent agent_airsoft_0faa9616 (PID: 93892)
2025-05-30 22:04:07,393 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 (PID: 93892) terminated gracefully after SIGTERM.
2025-05-30 22:04:07,395 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 marked as stopped in Redis.
2025-05-30 22:04:07,395 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 stopped (or stop attempted and assumed successful for restart). Pausing briefly...
2025-05-30 22:04:12,396 - INFO - app.services.process_manager - Proceeding to start agent agent_airsoft_0faa9616 after delay...
2025-05-30 22:04:12,398 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 22:04:12,401 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 94482
2025-05-30 22:04:12,401 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 94482
2025-05-30 22:04:12,402 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 successfully started as part of restart sequence.
2025-05-30 22:04:12,402 - INFO - app.api.routers.agent_api - Restart command issued for agent agent_airsoft_0faa9616 after config update.
2025-05-30 22:04:12,402 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:04:12,402 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 22:04:13,932 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 22:04:13,932 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 22:04:13,932 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 22:04:13,932 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 22:04:13,932 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 94482
2025-05-30 22:04:13,932 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 22:04:13,932 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 22:04:13,932 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 22:04:13,972 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 22:04:13,972 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 22:04:14,012 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 22:04:14,012 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 22:04:14,012 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 22:04:14,012 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 22:04:14,012 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 22:04:14,012 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 22:04:14,038 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 22:04:14,038 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 22:04:14,038 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 22:04:14,039 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET) wirh description: Ğ£Ğ·Ğ½Ğ°Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² (Ğ±Ğ±) Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.)
2025-05-30 22:04:14,039 - INFO - AGENT:agent_airsoft_0faa9616 - Added 3 tools from centralized registry
2025-05-30 22:04:14,039 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 22:04:14,095 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 22:04:14,101 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 22:04:15,156 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 22:04:15,173 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 22:04:15,182 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'airsoft' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7'] with description: Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ 1Ñ
2025-05-30 22:04:15,182 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 22:04:15,183 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'airsoft-rus.ru' (ID: webSearch-1748459212676) with description: ĞŸĞ¾Ğ¸ÑĞº Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ ÑÑ‚Ñ€Ğ°Ğ¹ĞºĞ±Ğ¾Ğ»Ñƒ Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼ Ğ´Ğ»Ñ ÑÑ‚Ñ€Ğ°Ğ¹ĞºĞ±Ğ¾Ğ»Ğ° Ğ½Ğ° ÑĞ°Ğ¹Ñ‚Ğµ.
2025-05-30 22:04:15,183 - INFO - AGENT:agent_airsoft_0faa9616 - Found 1 additional API request configurations
2025-05-30 22:04:15,183 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 5 (4 safe, 1 datastore).
2025-05-30 22:04:15,184 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 5 total, 4 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 22:04:15,184 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 22:04:15,189 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 22:04:15,189 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 22:04:15,189 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 22:04:15,189 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 22:04:15,189 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->agent
2025-05-30 22:04:15,190 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 22:04:15,190 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 22:04:15,208 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 22:04:15,208 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 22:04:15,208 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 22:04:15,208 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4458460944) setup complete. Starting run loop.
2025-05-30 22:04:15,208 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 22:04:15,208 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 22:04:15,208 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 22:04:15,208 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 22:04:15,212 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 22:04:43,912 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 22:04:43,920 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 22:05:15,418 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Ñ‡Ñ‚Ğ¾ Ñƒ Ñ‚ĞµĞ±Ñ ĞµÑÑ‚ÑŒ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ½Ğ° Ñ‚ĞµĞ¼Ñƒ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¹?...'
2025-05-30 22:05:15,421 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache miss for user 144641834, agent agent_airsoft_0faa9616. Checking DB.
2025-05-30 22:05:15,456 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - User 144641834 (DBID: 1) IS authorized for agent agent_airsoft_0faa9616 via DB.
2025-05-30 22:05:15,462 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 22:05:15,462 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 22:05:15,462 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 22:05:15,463 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 6727df6d-a14a-48aa-9611-b5db56a27113)
2025-05-30 22:05:15,463 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 22:05:15,464 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 22:05:15,464 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 22:05:15,474 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 6727df6d-a14a-48aa-9611-b5db56a27113, db_id: 1039
2025-05-30 22:05:15,513 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:05:15,513 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 22:05:15,538 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 22:05:15,541 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 5 tools.
2025-05-30 22:05:16,461 - INFO - aiogram.event - Update id=804756361 is handled. Duration 1047 ms by bot id=1750613938
2025-05-30 22:05:17,455 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:05:17,590 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 22:05:17,590 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 22:05:17,590 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 361, 'output_tokens': 23, 'total_tokens': 384, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 22:05:17,590 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:361 C:23 T:384
2025-05-30 22:05:17,590 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 384 tokens recorded.
2025-05-30 22:05:17,591 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 22:05:17,591 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: knowledgeBase-1748440512419
2025-05-30 22:05:17,591 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO RETRIEVE (knowledgeBase-1748440512419)---
2025-05-30 22:05:18,564 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 22:05:18,596 - INFO - httpx - HTTP Request: POST http://127.0.0.1:6333/collections/platformai/points/query "HTTP/1.1 200 OK"
2025-05-30 22:05:18,601 - INFO - AGENT:agent_airsoft_0faa9616 - ---CHECK RELEVANCE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:05:18,601 - INFO - AGENT:agent_airsoft_0faa9616 - Grading documents for question: 'Ñ‡Ñ‚Ğ¾ Ñƒ Ñ‚ĞµĞ±Ñ ĞµÑÑ‚ÑŒ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ½Ğ° Ñ‚ĞµĞ¼Ñƒ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¹?'
2025-05-30 22:05:18,601 - INFO - AGENT:agent_airsoft_0faa9616 - Using KB-specific model configuration for KB IDs: ['5', '6', '7']
2025-05-30 22:05:18,601 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenRouter, model: mistralai/mistral-small-3.1-24b-instruct:free, temp: 0.0, streaming: False
2025-05-30 22:05:18,626 - INFO - AGENT:agent_airsoft_0faa9616 - Created grading LLM for KB ['5', '6', '7']: mistralai/mistral-small-3.1-24b-instruct:free via OpenRouter
2025-05-30 22:05:21,101 - INFO - httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:05:24,564 - ERROR - AGENT:agent_airsoft_0faa9616 - Error processing document for grading ('## ĞœĞ˜ĞĞ¤Ğ˜Ğ Ğ ĞĞ¡Ğ¡Ğ˜Ğ˜ Ğ¤Ğ•Ğ”Ğ•Ğ ĞĞ›Ğ¬ĞĞĞ¯ ĞĞĞ›ĞĞ“ĞĞ’ĞĞ¯ Ğ¡Ğ›Ğ£Ğ–Ğ‘Ğ Ğ£Ğ¤ĞĞ¡ Ğ ĞĞ¡Ğ¡Ğ˜Ğ˜ ĞŸĞ Ğ¡Ğ’Ğ•Ğ Ğ”Ğ›ĞĞ’Ğ¡ĞšĞĞ™ ĞĞ‘Ğ›ĞĞ¡Ğ¢Ğ˜

**ĞœĞ•Ğ–Ğ ĞĞ™ĞĞĞĞĞ¯ Ğ˜ĞĞ¡...'): 1 validation error for Grade
  Invalid JSON: expected value at line 1 column 1 [type=json_invalid, input_value='Ğ”Ğ°, Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ ... Ğ±ÑƒĞ´ĞµÑ‚:\n\n**yes**', input_type=str]
    For further information visit https://errors.pydantic.dev/2.10/v/json_invalid
Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/agent_runner/langgraph/factory.py", line 420, in process_doc
    invocation_result = await chain.ainvoke({"question": current_question, "context": doc_content})
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3071, in ainvoke
    input = await asyncio.create_task(part(), context=context)  # type: ignore
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3780, in ainvoke
    results = await asyncio.gather(
              ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3770, in _ainvoke_step
    return await asyncio.create_task(  # type: ignore
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 5377, in ainvoke
    return await self.bound.ainvoke(
           ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 328, in ainvoke
    llm_result = await self.agenerate_prompt(
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 853, in agenerate_prompt
    return await self.agenerate(
           ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 813, in agenerate
    raise exceptions[0]
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 981, in _agenerate_with_cache
    result = await self._agenerate(
             ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_openai/chat_models/base.py", line 1094, in _agenerate
    response = await self.root_async_client.beta.chat.completions.parse(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/resources/beta/chat/completions.py", line 437, in parse
    return await self._post(
           ^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1767, in post
    return await self.request(cast_to, opts, stream=stream, stream_cls=stream_cls)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1461, in request
    return await self._request(
           ^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1564, in _request
    return await self._process_response(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1661, in _process_response
    return await api_response.parse()
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_response.py", line 432, in parse
    parsed = self._options.post_parser(parsed)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/resources/beta/chat/completions.py", line 431, in parser
    return _parse_chat_completion(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/lib/_parsing/_completions.py", line 110, in parse_chat_completion
    "parsed": maybe_parse_content(
              ^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/lib/_parsing/_completions.py", line 161, in maybe_parse_content
    return _parse_content(response_format, message.content)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/lib/_parsing/_completions.py", line 221, in _parse_content
    return cast(ResponseFormatT, model_parse_json(response_format, content))
                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_compat.py", line 169, in model_parse_json
    return model.model_validate_json(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/pydantic/main.py", line 656, in model_validate_json
    return cls.__pydantic_validator__.validate_json(json_data, strict=strict, context=context)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for Grade
  Invalid JSON: expected value at line 1 column 1 [type=json_invalid, input_value='Ğ”Ğ°, Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ ... Ğ±ÑƒĞ´ĞµÑ‚:\n\n**yes**', input_type=str]
    For further information visit https://errors.pydantic.dev/2.10/v/json_invalid
2025-05-30 22:05:24,564 - INFO - AGENT:agent_airsoft_0faa9616 - Found 0 relevant documents out of 1 initial (after split).
2025-05-30 22:05:24,565 - INFO - AGENT:agent_airsoft_0faa9616 - ---ASSESS GRADED DOCUMENTS---
2025-05-30 22:05:24,565 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO RELEVANT DOCUMENTS, REWRITE---
2025-05-30 22:05:24,566 - INFO - AGENT:agent_airsoft_0faa9616 - ---TRANSFORM QUERY (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:05:24,566 - INFO - AGENT:agent_airsoft_0faa9616 - Using KB-specific model configuration for rewrite. KB IDs: ['5', '6', '7']
2025-05-30 22:05:24,566 - INFO - AGENT:agent_airsoft_0faa9616 - Rewrite attempt 1/3 for question: 'Ñ‡Ñ‚Ğ¾ Ñƒ Ñ‚ĞµĞ±Ñ ĞµÑÑ‚ÑŒ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ½Ğ° Ñ‚ĞµĞ¼Ñƒ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¹?'
2025-05-30 22:05:24,566 - INFO - AGENT:agent_airsoft_0faa9616 - Rewriting original question: Ñ‡Ñ‚Ğ¾ Ñƒ Ñ‚ĞµĞ±Ñ ĞµÑÑ‚ÑŒ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ½Ğ° Ñ‚ĞµĞ¼Ñƒ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¹?
2025-05-30 22:05:24,566 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenRouter, model: mistralai/mistral-small-3.1-24b-instruct:free, temp: 0.0, streaming: False
2025-05-30 22:05:24,591 - INFO - AGENT:agent_airsoft_0faa9616 - Created rewrite LLM for KB ['5', '6', '7']: mistralai/mistral-small-3.1-24b-instruct:free via OpenRouter
2025-05-30 22:05:26,937 - INFO - httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:05:27,200 - INFO - AGENT:agent_airsoft_0faa9616 - Rewritten question: ĞšĞ°ĞºĞ¸Ğµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ¸Ğ»Ğ¸ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ ĞµÑÑ‚ÑŒ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ¿Ğ¾ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¼Ñƒ Ğ·Ğ°ĞºĞ¾Ğ½Ğ¾Ğ´Ğ°Ñ‚ĞµĞ»ÑŒÑÑ‚Ğ²Ñƒ Ğ¸ Ğ¿Ñ€Ğ¾Ñ†ĞµĞ´ÑƒÑ€Ğ°Ğ¼?
2025-05-30 22:05:27,200 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1516 C:27 T:1543
2025-05-30 22:05:27,200 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for rewrite_llm: 1543 tokens recorded.
2025-05-30 22:05:27,201 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:05:27,201 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 22:05:27,225 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 22:05:27,228 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 5 tools.
2025-05-30 22:05:29,802 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:05:29,913 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 22:05:29,913 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 22:05:29,913 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1151, 'output_tokens': 27, 'total_tokens': 1178, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 22:05:29,913 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1151 C:27 T:1178
2025-05-30 22:05:29,913 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1178 tokens recorded.
2025-05-30 22:05:29,914 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 22:05:29,914 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: knowledgeBase-1748440512419
2025-05-30 22:05:29,914 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO RETRIEVE (knowledgeBase-1748440512419)---
2025-05-30 22:05:30,474 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 22:05:30,486 - INFO - httpx - HTTP Request: POST http://127.0.0.1:6333/collections/platformai/points/query "HTTP/1.1 200 OK"
2025-05-30 22:05:30,488 - INFO - AGENT:agent_airsoft_0faa9616 - ---CHECK RELEVANCE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:05:30,488 - INFO - AGENT:agent_airsoft_0faa9616 - Grading documents for question: 'ĞšĞ°ĞºĞ¸Ğµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ¸Ğ»Ğ¸ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ ĞµÑÑ‚ÑŒ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ¿Ğ¾ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¼Ñƒ Ğ·Ğ°ĞºĞ¾Ğ½Ğ¾Ğ´Ğ°Ñ‚ĞµĞ»ÑŒÑÑ‚Ğ²Ñƒ Ğ¸ Ğ¿Ñ€Ğ¾Ñ†ĞµĞ´ÑƒÑ€Ğ°Ğ¼?'
2025-05-30 22:05:30,488 - INFO - AGENT:agent_airsoft_0faa9616 - Using KB-specific model configuration for KB IDs: ['5', '6', '7']
2025-05-30 22:05:30,488 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenRouter, model: mistralai/mistral-small-3.1-24b-instruct:free, temp: 0.0, streaming: False
2025-05-30 22:05:30,513 - INFO - AGENT:agent_airsoft_0faa9616 - Created grading LLM for KB ['5', '6', '7']: mistralai/mistral-small-3.1-24b-instruct:free via OpenRouter
2025-05-30 22:05:34,201 - INFO - httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:05:36,456 - ERROR - AGENT:agent_airsoft_0faa9616 - Error processing document for grading ('EVGENIY.IK@BK.RU

## Ğ£Ğ²Ğ°Ğ¶Ğ°ĞµĞ¼Ñ‹Ğ¹ Ğ•Ğ²Ğ³ĞµĞ½Ğ¸Ğ¹ Ğ’Ğ»Ğ°Ğ´Ğ¸ÑĞ»Ğ°Ğ²Ğ¾Ğ²Ğ¸Ñ‡!

ĞœĞµĞ¶Ñ€Ğ°Ğ¹Ğ¾Ğ½Ğ½Ğ°Ñ Ğ¸Ğ½ÑĞ¿ĞµĞºÑ†Ğ¸Ñ Ğ¤ĞµĞ´ĞµÑ€Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¹ Ñ...'): 1 validation error for Grade
  Invalid JSON: expected value at line 1 column 1 [type=json_invalid, input_value='Ğ”Ğ°Ğ²Ğ°Ğ¹Ñ‚Ğµ Ğ¾Ñ†ĞµĞ½...\nĞÑ†ĞµĞ½ĞºĞ°: **yes**', input_type=str]
    For further information visit https://errors.pydantic.dev/2.10/v/json_invalid
Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/agent_runner/langgraph/factory.py", line 420, in process_doc
    invocation_result = await chain.ainvoke({"question": current_question, "context": doc_content})
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3071, in ainvoke
    input = await asyncio.create_task(part(), context=context)  # type: ignore
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3780, in ainvoke
    results = await asyncio.gather(
              ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3770, in _ainvoke_step
    return await asyncio.create_task(  # type: ignore
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 5377, in ainvoke
    return await self.bound.ainvoke(
           ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 328, in ainvoke
    llm_result = await self.agenerate_prompt(
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 853, in agenerate_prompt
    return await self.agenerate(
           ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 813, in agenerate
    raise exceptions[0]
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 981, in _agenerate_with_cache
    result = await self._agenerate(
             ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_openai/chat_models/base.py", line 1094, in _agenerate
    response = await self.root_async_client.beta.chat.completions.parse(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/resources/beta/chat/completions.py", line 437, in parse
    return await self._post(
           ^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1767, in post
    return await self.request(cast_to, opts, stream=stream, stream_cls=stream_cls)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1461, in request
    return await self._request(
           ^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1564, in _request
    return await self._process_response(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1661, in _process_response
    return await api_response.parse()
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_response.py", line 432, in parse
    parsed = self._options.post_parser(parsed)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/resources/beta/chat/completions.py", line 431, in parser
    return _parse_chat_completion(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/lib/_parsing/_completions.py", line 110, in parse_chat_completion
    "parsed": maybe_parse_content(
              ^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/lib/_parsing/_completions.py", line 161, in maybe_parse_content
    return _parse_content(response_format, message.content)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/lib/_parsing/_completions.py", line 221, in _parse_content
    return cast(ResponseFormatT, model_parse_json(response_format, content))
                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_compat.py", line 169, in model_parse_json
    return model.model_validate_json(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/pydantic/main.py", line 656, in model_validate_json
    return cls.__pydantic_validator__.validate_json(json_data, strict=strict, context=context)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for Grade
  Invalid JSON: expected value at line 1 column 1 [type=json_invalid, input_value='Ğ”Ğ°Ğ²Ğ°Ğ¹Ñ‚Ğµ Ğ¾Ñ†ĞµĞ½...\nĞÑ†ĞµĞ½ĞºĞ°: **yes**', input_type=str]
    For further information visit https://errors.pydantic.dev/2.10/v/json_invalid
2025-05-30 22:05:36,456 - INFO - AGENT:agent_airsoft_0faa9616 - Found 0 relevant documents out of 1 initial (after split).
2025-05-30 22:05:36,457 - INFO - AGENT:agent_airsoft_0faa9616 - ---ASSESS GRADED DOCUMENTS---
2025-05-30 22:05:36,457 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO RELEVANT DOCUMENTS, REWRITE---
2025-05-30 22:05:36,458 - INFO - AGENT:agent_airsoft_0faa9616 - ---TRANSFORM QUERY (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:05:36,458 - INFO - AGENT:agent_airsoft_0faa9616 - Using KB-specific model configuration for rewrite. KB IDs: ['5', '6', '7']
2025-05-30 22:05:36,458 - INFO - AGENT:agent_airsoft_0faa9616 - Rewrite attempt 2/3 for question: 'Ñ‡Ñ‚Ğ¾ Ñƒ Ñ‚ĞµĞ±Ñ ĞµÑÑ‚ÑŒ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ½Ğ° Ñ‚ĞµĞ¼Ñƒ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¹?'
2025-05-30 22:05:36,458 - INFO - AGENT:agent_airsoft_0faa9616 - Rewriting original question: Ñ‡Ñ‚Ğ¾ Ñƒ Ñ‚ĞµĞ±Ñ ĞµÑÑ‚ÑŒ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ½Ğ° Ñ‚ĞµĞ¼Ñƒ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¹?
2025-05-30 22:05:36,458 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenRouter, model: mistralai/mistral-small-3.1-24b-instruct:free, temp: 0.0, streaming: False
2025-05-30 22:05:36,483 - INFO - AGENT:agent_airsoft_0faa9616 - Created rewrite LLM for KB ['5', '6', '7']: mistralai/mistral-small-3.1-24b-instruct:free via OpenRouter
2025-05-30 22:05:39,221 - INFO - httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:05:39,475 - INFO - AGENT:agent_airsoft_0faa9616 - Rewritten question: ĞšĞ°ĞºĞ¸Ğµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ¸Ğ»Ğ¸ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ ĞµÑÑ‚ÑŒ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ¿Ğ¾ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¼Ñƒ Ğ·Ğ°ĞºĞ¾Ğ½Ğ¾Ğ´Ğ°Ñ‚ĞµĞ»ÑŒÑÑ‚Ğ²Ñƒ Ğ¸ Ğ¿Ñ€Ğ¾Ñ†ĞµĞ´ÑƒÑ€Ğ°Ğ¼?
2025-05-30 22:05:39,475 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:2956 C:27 T:2983
2025-05-30 22:05:39,475 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for rewrite_llm: 2983 tokens recorded.
2025-05-30 22:05:39,476 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:05:39,476 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 22:05:39,500 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 22:05:39,502 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 5 tools.
2025-05-30 22:05:40,339 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:05:43,344 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ’ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ ĞµÑÑ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ, ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ğ°Ñ Ñ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğ¼ Ğ·Ğ°ĞºĞ¾Ğ½Ğ¾Ğ´Ğ°Ñ‚ĞµĞ»ÑŒÑÑ‚Ğ²Ğ¾Ğ¼ Ğ¸ Ğ¿Ñ€Ğ¾Ñ†ĞµĞ´ÑƒÑ€Ğ°Ğ¼Ğ¸, Ğ² Ñ‡Ğ°ÑÑ‚Ğ½Ğ¾ÑÑ‚Ğ¸:


2025-05-30 22:05:43,344 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_38647f5e19'}
2025-05-30 22:05:43,344 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1946, 'output_tokens': 162, 'total_tokens': 2108, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 22:05:43,344 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1946 C:162 T:2108
2025-05-30 22:05:43,344 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 2108 tokens recorded.
2025-05-30 22:05:43,345 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 22:05:43,345 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 22:05:43,346 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ’ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ ĞµÑÑ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ, ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ğ°Ñ Ñ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğ¼ Ğ·Ğ°ĞºĞ¾Ğ½Ğ¾Ğ´Ğ°Ñ‚ĞµĞ»ÑŒÑÑ‚Ğ²Ğ¾Ğ¼ Ğ¸ Ğ¿Ñ€Ğ¾Ñ†ĞµĞ´ÑƒÑ€Ğ°Ğ¼Ğ¸, Ğ² Ñ‡Ğ°ÑÑ‚Ğ½Ğ¾ÑÑ‚Ğ¸:

...
2025-05-30 22:05:43,348 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 6727df6d-a14a-48aa-9611-b5db56a27113)
2025-05-30 22:05:43,349 - INFO - AGENT:agent_airsoft_0faa9616 - Found 5 token usage events for InteractionID: 6727df6d-a14a-48aa-9611-b5db56a27113.
2025-05-30 22:05:43,355 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Ğ’ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ ĞµÑÑ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ, ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ğ°Ñ Ñ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğ¼ Ğ·Ğ°ĞºĞ¾Ğ½Ğ¾Ğ´Ğ°Ñ‚ĞµĞ»ÑŒÑÑ‚Ğ²Ğ¾Ğ¼ Ğ¸ Ğ¿Ñ€Ğ¾Ñ†ĞµĞ´ÑƒÑ€Ğ°Ğ¼Ğ¸, Ğ² Ñ‡Ğ°ÑÑ‚Ğ½Ğ¾ÑÑ‚Ğ¸:

...
2025-05-30 22:05:43,355 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Ğ’ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ ĞµÑÑ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ, ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ğ°Ñ Ñ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²...'
2025-05-30 22:05:43,355 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '6727df6d-a14a-48aa-9611-b5db56a27113', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 361, 'completion_tokens': 23, 'total_tokens': 384, 'timestamp': '2025-05-30T17:05:17.590755+00:00'}
2025-05-30 22:05:43,355 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 6727df6d-a14a-48aa-9611-b5db56a27113
2025-05-30 22:05:43,358 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 6727df6d-a14a-48aa-9611-b5db56a27113, db_id: 1040
2025-05-30 22:05:43,358 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1040 for interaction_id: 6727df6d-a14a-48aa-9611-b5db56a27113 on attempt 1
2025-05-30 22:05:43,363 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 6727df6d-a14a-48aa-9611-b5db56a27113, db_id: 521
2025-05-30 22:05:43,367 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '6727df6d-a14a-48aa-9611-b5db56a27113', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1946, 'completion_tokens': 162, 'total_tokens': 2108, 'timestamp': '2025-05-30T17:05:43.344610+00:00'}
2025-05-30 22:05:43,367 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 6727df6d-a14a-48aa-9611-b5db56a27113
2025-05-30 22:05:43,368 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1040 for interaction_id: 6727df6d-a14a-48aa-9611-b5db56a27113 on attempt 1
2025-05-30 22:05:43,372 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 6727df6d-a14a-48aa-9611-b5db56a27113, db_id: 522
2025-05-30 22:05:43,376 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '6727df6d-a14a-48aa-9611-b5db56a27113', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'rewrite_llm', 'model_id': 'mistralai/mistral-small-3.1-24b-instruct:free', 'prompt_tokens': 2956, 'completion_tokens': 27, 'total_tokens': 2983, 'timestamp': '2025-05-30T17:05:39.475216+00:00'}
2025-05-30 22:05:43,376 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 6727df6d-a14a-48aa-9611-b5db56a27113
2025-05-30 22:05:43,377 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1040 for interaction_id: 6727df6d-a14a-48aa-9611-b5db56a27113 on attempt 1
2025-05-30 22:05:43,379 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 6727df6d-a14a-48aa-9611-b5db56a27113, db_id: 523
2025-05-30 22:05:43,382 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '6727df6d-a14a-48aa-9611-b5db56a27113', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1151, 'completion_tokens': 27, 'total_tokens': 1178, 'timestamp': '2025-05-30T17:05:29.913580+00:00'}
2025-05-30 22:05:43,382 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 6727df6d-a14a-48aa-9611-b5db56a27113
2025-05-30 22:05:43,383 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1040 for interaction_id: 6727df6d-a14a-48aa-9611-b5db56a27113 on attempt 1
2025-05-30 22:05:43,385 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 6727df6d-a14a-48aa-9611-b5db56a27113, db_id: 524
2025-05-30 22:05:43,388 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '6727df6d-a14a-48aa-9611-b5db56a27113', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'rewrite_llm', 'model_id': 'mistralai/mistral-small-3.1-24b-instruct:free', 'prompt_tokens': 1516, 'completion_tokens': 27, 'total_tokens': 1543, 'timestamp': '2025-05-30T17:05:27.200186+00:00'}
2025-05-30 22:05:43,388 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 6727df6d-a14a-48aa-9611-b5db56a27113
2025-05-30 22:05:43,388 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1040 for interaction_id: 6727df6d-a14a-48aa-9611-b5db56a27113 on attempt 1
2025-05-30 22:05:43,391 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 6727df6d-a14a-48aa-9611-b5db56a27113, db_id: 525
2025-05-30 22:09:42,844 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 22:09:42,844 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 22:09:42,844 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 22:09:42,845 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4395355312) was cancelled.
2025-05-30 22:09:42,845 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4395355312) stopping. Performing cleanup...
2025-05-30 22:09:42,845 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 22:09:42,852 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 22:09:42,854 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 22:09:42,854 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:09:42,854 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 22:09:42,854 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 22:09:42,854 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4395355312) cleanup complete.
2025-05-30 22:09:42,854 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 22:09:42,854 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 22:09:42,854 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4395366400) was cancelled.
2025-05-30 22:09:42,854 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4395366400) stopping. Performing cleanup...
2025-05-30 22:09:42,854 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 22:09:42,858 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 22:09:42,859 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 22:09:42,859 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:09:42,860 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 22:09:42,860 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 22:09:42,860 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4395366400) cleanup complete.
2025-05-30 22:09:42,860 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 22:09:42,860 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 22:09:42,860 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4395366448) was cancelled.
2025-05-30 22:09:42,860 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4395366448) stopping. Performing cleanup...
2025-05-30 22:09:42,860 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 22:09:42,860 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:09:42,861 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 22:09:42,861 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 22:09:42,861 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 22:09:42,864 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 22:09:42,865 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 22:09:42,865 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:09:42,865 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 22:09:42,865 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 22:09:42,865 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 22:09:42,865 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4395366448) cleanup complete.
2025-05-30 22:09:42,865 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 22:09:42,865 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 22:09:42,865 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 22:09:42,884 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 22:09:42,885 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 22:09:43,460 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 22:09:43,460 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 22:09:43,465 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 22:09:43,465 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 22:09:43,465 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 22:09:43,465 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 22:09:43,465 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 22:09:43,465 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 22:09:43,465 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 22:09:43,465 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 22:09:43,466 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 22:09:43,466 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 22:09:43,466 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 22:09:43,470 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 22:09:43,470 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 22:09:43,470 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 22:09:43,489 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 22:09:43,489 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 22:09:43,489 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 22:09:43,489 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 22:09:43,491 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 22:09:43,491 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 22:09:43,491 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4578468176) setup complete. Starting run loop.
2025-05-30 22:09:43,491 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 22:09:43,491 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 22:09:43,491 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4578575088) setup complete. Starting run loop.
2025-05-30 22:09:43,491 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 22:09:43,494 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 22:09:43,494 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 22:09:43,536 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 22:09:43,536 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 22:09:43,537 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 22:09:43,537 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 22:09:43,537 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 22:09:43,537 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 22:09:43,538 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:09:43,538 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 22:09:43,538 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 22:09:43,538 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 22:09:53,494 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 22:09:53,499 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 22:09:53,499 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4578575136) setup complete. Starting run loop.
2025-05-30 22:09:53,499 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 22:10:35,568 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 22:10:35,568 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 22:10:35,569 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 22:10:35,569 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4578468176) was cancelled.
2025-05-30 22:10:35,569 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4578468176) stopping. Performing cleanup...
2025-05-30 22:10:35,569 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 22:10:35,573 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 22:10:35,574 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 22:10:35,574 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:10:35,574 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 22:10:35,574 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 22:10:35,574 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4578468176) cleanup complete.
2025-05-30 22:10:35,574 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 22:10:35,574 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 22:10:35,574 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4578575088) was cancelled.
2025-05-30 22:10:35,574 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4578575088) stopping. Performing cleanup...
2025-05-30 22:10:35,574 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 22:10:35,577 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 22:10:35,578 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 22:10:35,578 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:10:35,578 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 22:10:35,578 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 22:10:35,578 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4578575088) cleanup complete.
2025-05-30 22:10:35,578 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 22:10:35,578 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 22:10:35,578 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4578575136) was cancelled.
2025-05-30 22:10:35,578 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4578575136) stopping. Performing cleanup...
2025-05-30 22:10:35,578 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 22:10:35,579 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:10:35,579 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 22:10:35,579 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 22:10:35,579 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 22:10:35,581 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 22:10:35,582 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 22:10:35,582 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:10:35,582 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 22:10:35,582 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 22:10:35,582 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 22:10:35,582 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4578575136) cleanup complete.
2025-05-30 22:10:35,582 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 22:10:35,582 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 22:10:35,582 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 22:10:35,587 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 22:10:35,587 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 22:10:36,049 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 22:10:36,049 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 22:10:36,053 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 22:10:36,053 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 22:10:36,053 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 22:10:36,053 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 22:10:36,053 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 22:10:36,053 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 22:10:36,053 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 22:10:36,053 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 22:10:36,053 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 22:10:36,053 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 22:10:36,053 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 22:10:36,056 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 22:10:36,057 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 22:10:36,057 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 22:10:36,057 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 22:10:36,057 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 22:10:36,057 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 22:10:36,057 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 22:10:36,073 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 22:10:36,073 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4709091568) setup complete. Starting run loop.
2025-05-30 22:10:36,073 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 22:10:36,074 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 22:10:36,075 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 22:10:36,075 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4709664048) setup complete. Starting run loop.
2025-05-30 22:10:36,075 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 22:10:36,076 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 22:10:36,076 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 22:10:36,106 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 22:10:36,106 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 22:10:36,107 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 22:10:36,107 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 22:10:36,107 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 22:10:36,108 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 22:10:36,108 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:10:36,109 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 22:10:36,109 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 22:10:36,109 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 22:10:46,076 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 22:10:46,081 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 22:10:46,081 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4709663856) setup complete. Starting run loop.
2025-05-30 22:10:46,081 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 22:11:15,519 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 22:11:15,520 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4458460944) received shutdown request. Initiating graceful shutdown...
2025-05-30 22:11:15,520 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4458460944)...
2025-05-30 22:11:15,520 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 22:11:15,520 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 22:11:15,520 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4458460944) was cancelled.
2025-05-30 22:11:15,520 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4458460944) stopping. Performing cleanup...
2025-05-30 22:11:15,520 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 22:11:15,521 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-30 22:11:15,521 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 22:11:15,521 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 22:11:15,521 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 22:11:15,521 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 22:11:15,522 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 22:11:15,522 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 22:11:15,522 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 22:11:15,520 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 22:11:15,524 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 22:11:15,525 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 22:11:15,526 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 22:11:15,527 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 22:11:15,527 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:11:15,528 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 22:11:15,528 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 22:11:15,528 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 22:11:15,528 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4458460944) cleanup complete.
2025-05-30 22:11:15,528 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 22:11:15,528 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 22:11:15,530 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 22:11:15,530 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 22:11:15,530 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 22:11:15,531 - INFO - __main__ - Agent runner main finished.
2025-05-30 22:11:15,656 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 22:11:15,656 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 22:11:15,656 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 22:11:15,656 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4709091568) was cancelled.
2025-05-30 22:11:15,656 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4709091568) stopping. Performing cleanup...
2025-05-30 22:11:15,656 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 22:11:15,661 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 22:11:15,662 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 22:11:15,662 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:11:15,662 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 22:11:15,662 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 22:11:15,662 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4709091568) cleanup complete.
2025-05-30 22:11:15,663 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 22:11:15,663 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 22:11:15,663 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4709664048) was cancelled.
2025-05-30 22:11:15,663 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4709664048) stopping. Performing cleanup...
2025-05-30 22:11:15,663 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 22:11:15,666 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 22:11:15,666 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 22:11:15,666 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:11:15,666 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 22:11:15,666 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 22:11:15,666 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4709664048) cleanup complete.
2025-05-30 22:11:15,667 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 22:11:15,667 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 22:11:15,667 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4709663856) was cancelled.
2025-05-30 22:11:15,667 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4709663856) stopping. Performing cleanup...
2025-05-30 22:11:15,667 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 22:11:15,667 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:11:15,667 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 22:11:15,667 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 22:11:15,667 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 22:11:15,669 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 22:11:15,669 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 22:11:15,669 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:11:15,669 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 22:11:15,669 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 22:11:15,669 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 22:11:15,669 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4709663856) cleanup complete.
2025-05-30 22:11:15,669 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 22:11:15,669 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 22:11:15,670 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 22:11:15,673 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 22:11:15,673 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 22:11:15,777 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 22:11:15,777 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 22:11:15,777 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 22:11:15,778 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4422952928) received shutdown request. Initiating graceful shutdown...
2025-05-30 22:11:15,778 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4422952928)...
2025-05-30 22:11:15,778 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 22:11:15,778 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 22:11:15,778 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4422952928) was cancelled.
2025-05-30 22:11:15,778 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4422952928) stopping. Performing cleanup...
2025-05-30 22:11:15,778 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 22:11:15,779 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 22:11:15,779 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 22:11:15,779 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 22:11:15,779 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 22:11:15,779 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 22:11:15,779 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 22:11:15,780 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 22:11:15,780 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 22:11:15,780 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 22:11:15,786 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 22:11:15,787 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 22:11:15,787 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:11:15,788 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 22:11:15,789 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 22:11:15,789 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 22:11:15,789 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4422952928) cleanup complete.
2025-05-30 22:11:15,789 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 22:11:15,789 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 22:11:15,798 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 22:11:15,798 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 22:11:15,798 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 22:11:15,800 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 22:11:21,537 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 22:11:21,538 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 22:11:21,542 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 22:11:21,542 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 22:11:21,542 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 22:11:21,542 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 22:11:21,542 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 22:11:21,542 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 22:11:21,542 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 22:11:21,542 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 22:11:21,543 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 22:11:21,543 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 22:11:21,543 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 22:11:21,545 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 22:11:21,545 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 22:11:21,545 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 22:11:21,545 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 22:11:21,546 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 22:11:21,546 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 22:11:21,546 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 22:11:21,560 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 22:11:21,561 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4397059632) setup complete. Starting run loop.
2025-05-30 22:11:21,561 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 22:11:21,561 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 22:11:21,561 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 22:11:21,561 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4397464224) setup complete. Starting run loop.
2025-05-30 22:11:21,561 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 22:11:21,563 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 22:11:21,563 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 22:11:21,592 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 22:11:21,592 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 22:11:21,594 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 22:11:21,595 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 94755
2025-05-30 22:11:21,595 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 94755
2025-05-30 22:11:21,596 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 22:11:21,596 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 22:11:21,596 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 22:11:21,597 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 22:11:21,598 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 94756
2025-05-30 22:11:21,598 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 94756
2025-05-30 22:11:21,598 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 22:11:21,599 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:11:21,599 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 22:11:21,599 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 22:11:21,599 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 22:11:22,498 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 22:11:22,499 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 22:11:22,499 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 22:11:22,499 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 22:11:22,499 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 94756
2025-05-30 22:11:22,499 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 22:11:22,499 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 22:11:22,499 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 22:11:22,504 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 22:11:22,517 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 22:11:22,517 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 22:11:22,517 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 22:11:22,517 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4404160672) setup complete. Starting run loop.
2025-05-30 22:11:22,517 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 22:11:22,517 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 22:11:22,517 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 22:11:22,517 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 22:11:22,518 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 22:11:22,518 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 22:11:22,518 - INFO - aiogram.dispatcher - Start polling
2025-05-30 22:11:22,521 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 22:11:22,763 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 22:11:22,836 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 22:11:22,836 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 22:11:22,836 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 22:11:22,836 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 22:11:22,836 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 94755
2025-05-30 22:11:22,836 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 22:11:22,836 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 22:11:22,836 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 22:11:22,878 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 22:11:22,878 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 22:11:22,922 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 22:11:22,922 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 22:11:22,922 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 22:11:22,922 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 22:11:22,922 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 22:11:22,922 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 22:11:22,947 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 22:11:22,947 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 22:11:22,948 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 22:11:22,949 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET) wirh description: Ğ£Ğ·Ğ½Ğ°Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² (Ğ±Ğ±) Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.)
2025-05-30 22:11:22,949 - INFO - AGENT:agent_airsoft_0faa9616 - Added 3 tools from centralized registry
2025-05-30 22:11:22,949 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 22:11:23,005 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 22:11:23,012 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 22:11:23,623 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 22:11:23,625 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 22:11:23,625 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'airsoft' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7'] with description: Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ 1Ñ
2025-05-30 22:11:23,625 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 22:11:23,625 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'airsoft-rus.ru' (ID: webSearch-1748459212676) with description: ĞŸĞ¾Ğ¸ÑĞº Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ ÑÑ‚Ñ€Ğ°Ğ¹ĞºĞ±Ğ¾Ğ»Ñƒ Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼ Ğ´Ğ»Ñ ÑÑ‚Ñ€Ğ°Ğ¹ĞºĞ±Ğ¾Ğ»Ğ° Ğ½Ğ° ÑĞ°Ğ¹Ñ‚Ğµ.
2025-05-30 22:11:23,625 - INFO - AGENT:agent_airsoft_0faa9616 - Found 1 additional API request configurations
2025-05-30 22:11:23,625 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 5 (4 safe, 1 datastore).
2025-05-30 22:11:23,625 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 5 total, 4 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 22:11:23,625 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 22:11:23,627 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 22:11:23,627 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 22:11:23,627 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 22:11:23,627 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 22:11:23,627 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->agent
2025-05-30 22:11:23,627 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 22:11:23,627 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 22:11:23,639 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 22:11:23,639 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 22:11:23,639 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 22:11:23,639 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4849514448) setup complete. Starting run loop.
2025-05-30 22:11:23,639 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 22:11:23,639 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 22:11:23,639 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 22:11:23,639 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 22:11:23,642 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 22:11:31,563 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 22:11:31,567 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 22:11:31,567 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4397464032) setup complete. Starting run loop.
2025-05-30 22:11:31,567 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 22:11:39,984 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Ğ§Ñ‚Ğ¾ Ñƒ Ñ‚ĞµĞ±Ñ ĞµÑÑ‚ÑŒ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ½Ğ° Ñ‚ĞµĞ¼Ñƒ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° ...'
2025-05-30 22:11:39,985 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 22:11:40,059 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 22:11:40,059 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 22:11:40,060 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 22:11:40,060 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 50137803-0e12-4937-bf00-8b36491c5bd9)
2025-05-30 22:11:40,060 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 22:11:40,061 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-30 22:11:40,086 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 50137803-0e12-4937-bf00-8b36491c5bd9, db_id: 1041
2025-05-30 22:11:40,101 - INFO - AGENT:agent_airsoft_0faa9616 - Loaded 20 messages from DB for thread '144641834'.
2025-05-30 22:11:40,101 - INFO - AGENT:agent_airsoft_0faa9616 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-30 22:11:40,101 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-30 22:11:40,161 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:11:40,161 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 22:11:40,187 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 22:11:40,190 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 5 tools.
2025-05-30 22:11:41,061 - INFO - aiogram.event - Update id=804756362 is handled. Duration 1077 ms by bot id=1750613938
2025-05-30 22:11:41,466 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:11:41,753 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 22:11:41,753 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 22:11:41,753 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1960, 'output_tokens': 29, 'total_tokens': 1989, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 22:11:41,753 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1960 C:29 T:1989
2025-05-30 22:11:41,753 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1989 tokens recorded.
2025-05-30 22:11:41,754 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 22:11:41,754 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: knowledgeBase-1748440512419
2025-05-30 22:11:41,754 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO RETRIEVE (knowledgeBase-1748440512419)---
2025-05-30 22:11:43,350 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 22:11:43,368 - INFO - httpx - HTTP Request: POST http://127.0.0.1:6333/collections/platformai/points/query "HTTP/1.1 200 OK"
2025-05-30 22:11:43,371 - INFO - AGENT:agent_airsoft_0faa9616 - ---CHECK RELEVANCE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:11:43,372 - INFO - AGENT:agent_airsoft_0faa9616 - Grading documents for question: 'Ğ§Ñ‚Ğ¾ Ñƒ Ñ‚ĞµĞ±Ñ ĞµÑÑ‚ÑŒ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ½Ğ° Ñ‚ĞµĞ¼Ñƒ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° ÑƒÑ‚11?'
2025-05-30 22:11:43,372 - INFO - AGENT:agent_airsoft_0faa9616 - Using KB-specific model configuration for KB IDs: ['5', '6', '7']
2025-05-30 22:11:43,372 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenRouter, model: mistralai/mistral-small-3.1-24b-instruct:free, temp: 0.0, streaming: False
2025-05-30 22:11:43,396 - INFO - AGENT:agent_airsoft_0faa9616 - Created grading LLM for KB ['5', '6', '7']: mistralai/mistral-small-3.1-24b-instruct:free via OpenRouter
2025-05-30 22:11:44,999 - INFO - httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:11:45,215 - ERROR - AGENT:agent_airsoft_0faa9616 - Error processing document for grading ('## ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´ Ğ½Ğ° ÑƒÑ‚ 11

Ğ”Ğ»Ñ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ½ÑƒĞ¶Ğ½Ğ¾ Ñ€ĞµÑˆĞ¸Ñ‚ÑŒ Ğ±ÑƒĞ´ĞµĞ¼ Ğ» Ğ¼Ñ‹ Ğ¿ĞµÑ€ĞµĞ½Ğ¾ÑĞ¸Ñ‚ÑŒ ÑĞ²Ğ¾Ñ Ğ±Ğ¸Ğ·Ğ½ĞµÑ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ Ğ² Ğ½Ğ¾Ğ²ÑƒÑ 1Ñ, Ğ¸Ğ»...'): 1 validation error for Grade
  Invalid JSON: expected value at line 1 column 1 [type=json_invalid, input_value='yes', input_type=str]
    For further information visit https://errors.pydantic.dev/2.10/v/json_invalid
Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/agent_runner/langgraph/factory.py", line 420, in process_doc
    invocation_result = await chain.ainvoke({"question": current_question, "context": doc_content})
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3071, in ainvoke
    input = await asyncio.create_task(part(), context=context)  # type: ignore
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3780, in ainvoke
    results = await asyncio.gather(
              ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3770, in _ainvoke_step
    return await asyncio.create_task(  # type: ignore
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 5377, in ainvoke
    return await self.bound.ainvoke(
           ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 328, in ainvoke
    llm_result = await self.agenerate_prompt(
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 853, in agenerate_prompt
    return await self.agenerate(
           ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 813, in agenerate
    raise exceptions[0]
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 981, in _agenerate_with_cache
    result = await self._agenerate(
             ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_openai/chat_models/base.py", line 1094, in _agenerate
    response = await self.root_async_client.beta.chat.completions.parse(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/resources/beta/chat/completions.py", line 437, in parse
    return await self._post(
           ^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1767, in post
    return await self.request(cast_to, opts, stream=stream, stream_cls=stream_cls)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1461, in request
    return await self._request(
           ^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1564, in _request
    return await self._process_response(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1661, in _process_response
    return await api_response.parse()
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_response.py", line 432, in parse
    parsed = self._options.post_parser(parsed)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/resources/beta/chat/completions.py", line 431, in parser
    return _parse_chat_completion(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/lib/_parsing/_completions.py", line 110, in parse_chat_completion
    "parsed": maybe_parse_content(
              ^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/lib/_parsing/_completions.py", line 161, in maybe_parse_content
    return _parse_content(response_format, message.content)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/lib/_parsing/_completions.py", line 221, in _parse_content
    return cast(ResponseFormatT, model_parse_json(response_format, content))
                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_compat.py", line 169, in model_parse_json
    return model.model_validate_json(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/pydantic/main.py", line 656, in model_validate_json
    return cls.__pydantic_validator__.validate_json(json_data, strict=strict, context=context)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for Grade
  Invalid JSON: expected value at line 1 column 1 [type=json_invalid, input_value='yes', input_type=str]
    For further information visit https://errors.pydantic.dev/2.10/v/json_invalid
2025-05-30 22:11:45,216 - INFO - AGENT:agent_airsoft_0faa9616 - Found 0 relevant documents out of 1 initial (after split).
2025-05-30 22:11:45,217 - INFO - AGENT:agent_airsoft_0faa9616 - ---ASSESS GRADED DOCUMENTS---
2025-05-30 22:11:45,217 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO RELEVANT DOCUMENTS, REWRITE---
2025-05-30 22:11:45,218 - INFO - AGENT:agent_airsoft_0faa9616 - ---TRANSFORM QUERY (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:11:45,218 - INFO - AGENT:agent_airsoft_0faa9616 - Using KB-specific model configuration for rewrite. KB IDs: ['5', '6', '7']
2025-05-30 22:11:45,218 - INFO - AGENT:agent_airsoft_0faa9616 - Rewrite attempt 1/3 for question: 'Ğ§Ñ‚Ğ¾ Ñƒ Ñ‚ĞµĞ±Ñ ĞµÑÑ‚ÑŒ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ½Ğ° Ñ‚ĞµĞ¼Ñƒ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° ÑƒÑ‚11?'
2025-05-30 22:11:45,218 - INFO - AGENT:agent_airsoft_0faa9616 - Rewriting original question: Ğ§Ñ‚Ğ¾ Ñƒ Ñ‚ĞµĞ±Ñ ĞµÑÑ‚ÑŒ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ½Ğ° Ñ‚ĞµĞ¼Ñƒ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° ÑƒÑ‚11?
2025-05-30 22:11:45,218 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenRouter, model: mistralai/mistral-small-3.1-24b-instruct:free, temp: 0.0, streaming: False
2025-05-30 22:11:45,243 - INFO - AGENT:agent_airsoft_0faa9616 - Created rewrite LLM for KB ['5', '6', '7']: mistralai/mistral-small-3.1-24b-instruct:free via OpenRouter
2025-05-30 22:11:52,670 - INFO - httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:11:53,285 - INFO - AGENT:agent_airsoft_0faa9616 - Rewritten question: ĞšĞ°ĞºĞ¸Ğµ ÑÑ‚Ğ°Ğ¿Ñ‹ Ğ¸ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ñƒ Ğ½Ğ° 1Ğ¡:Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ»ĞµĞ¹ 11 (Ğ£Ğ¢11) Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ñ‹ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹?
2025-05-30 22:11:53,285 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:4368 C:40 T:4408
2025-05-30 22:11:53,285 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for rewrite_llm: 4408 tokens recorded.
2025-05-30 22:11:53,286 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:11:53,286 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 22:11:53,312 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 22:11:53,315 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 5 tools.
2025-05-30 22:11:54,792 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:11:55,469 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 22:11:55,469 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 22:11:55,469 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 2792, 'output_tokens': 45, 'total_tokens': 2837, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 22:11:55,469 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:2792 C:45 T:2837
2025-05-30 22:11:55,469 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 2837 tokens recorded.
2025-05-30 22:11:55,470 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 22:11:55,470 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: knowledgeBase-1748440512419
2025-05-30 22:11:55,470 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO RETRIEVE (knowledgeBase-1748440512419)---
2025-05-30 22:11:55,983 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 22:11:55,997 - INFO - httpx - HTTP Request: POST http://127.0.0.1:6333/collections/platformai/points/query "HTTP/1.1 200 OK"
2025-05-30 22:11:55,999 - INFO - AGENT:agent_airsoft_0faa9616 - ---CHECK RELEVANCE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:11:56,000 - INFO - AGENT:agent_airsoft_0faa9616 - Grading documents for question: 'ĞšĞ°ĞºĞ¸Ğµ ÑÑ‚Ğ°Ğ¿Ñ‹ Ğ¸ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ñƒ Ğ½Ğ° 1Ğ¡:Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ»ĞµĞ¹ 11 (Ğ£Ğ¢11) Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ñ‹ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹?'
2025-05-30 22:11:56,000 - INFO - AGENT:agent_airsoft_0faa9616 - Using KB-specific model configuration for KB IDs: ['5', '6', '7']
2025-05-30 22:11:56,000 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenRouter, model: mistralai/mistral-small-3.1-24b-instruct:free, temp: 0.0, streaming: False
2025-05-30 22:11:56,024 - INFO - AGENT:agent_airsoft_0faa9616 - Created grading LLM for KB ['5', '6', '7']: mistralai/mistral-small-3.1-24b-instruct:free via OpenRouter
2025-05-30 22:11:57,583 - INFO - httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:11:57,593 - ERROR - AGENT:agent_airsoft_0faa9616 - Error processing document for grading ('## ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´ Ğ½Ğ° ÑƒÑ‚ 11

Ğ”Ğ»Ñ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ½ÑƒĞ¶Ğ½Ğ¾ Ñ€ĞµÑˆĞ¸Ñ‚ÑŒ Ğ±ÑƒĞ´ĞµĞ¼ Ğ» Ğ¼Ñ‹ Ğ¿ĞµÑ€ĞµĞ½Ğ¾ÑĞ¸Ñ‚ÑŒ ÑĞ²Ğ¾Ñ Ğ±Ğ¸Ğ·Ğ½ĞµÑ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ Ğ² Ğ½Ğ¾Ğ²ÑƒÑ 1Ñ, Ğ¸Ğ»...'): 1 validation error for Grade
  Invalid JSON: expected value at line 1 column 1 [type=json_invalid, input_value='yes', input_type=str]
    For further information visit https://errors.pydantic.dev/2.10/v/json_invalid
Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/agent_runner/langgraph/factory.py", line 420, in process_doc
    invocation_result = await chain.ainvoke({"question": current_question, "context": doc_content})
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3071, in ainvoke
    input = await asyncio.create_task(part(), context=context)  # type: ignore
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3780, in ainvoke
    results = await asyncio.gather(
              ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3770, in _ainvoke_step
    return await asyncio.create_task(  # type: ignore
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 5377, in ainvoke
    return await self.bound.ainvoke(
           ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 328, in ainvoke
    llm_result = await self.agenerate_prompt(
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 853, in agenerate_prompt
    return await self.agenerate(
           ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 813, in agenerate
    raise exceptions[0]
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 981, in _agenerate_with_cache
    result = await self._agenerate(
             ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_openai/chat_models/base.py", line 1094, in _agenerate
    response = await self.root_async_client.beta.chat.completions.parse(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/resources/beta/chat/completions.py", line 437, in parse
    return await self._post(
           ^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1767, in post
    return await self.request(cast_to, opts, stream=stream, stream_cls=stream_cls)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1461, in request
    return await self._request(
           ^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1564, in _request
    return await self._process_response(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1661, in _process_response
    return await api_response.parse()
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_response.py", line 432, in parse
    parsed = self._options.post_parser(parsed)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/resources/beta/chat/completions.py", line 431, in parser
    return _parse_chat_completion(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/lib/_parsing/_completions.py", line 110, in parse_chat_completion
    "parsed": maybe_parse_content(
              ^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/lib/_parsing/_completions.py", line 161, in maybe_parse_content
    return _parse_content(response_format, message.content)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/lib/_parsing/_completions.py", line 221, in _parse_content
    return cast(ResponseFormatT, model_parse_json(response_format, content))
                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_compat.py", line 169, in model_parse_json
    return model.model_validate_json(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/pydantic/main.py", line 656, in model_validate_json
    return cls.__pydantic_validator__.validate_json(json_data, strict=strict, context=context)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for Grade
  Invalid JSON: expected value at line 1 column 1 [type=json_invalid, input_value='yes', input_type=str]
    For further information visit https://errors.pydantic.dev/2.10/v/json_invalid
2025-05-30 22:11:57,593 - INFO - AGENT:agent_airsoft_0faa9616 - Found 0 relevant documents out of 1 initial (after split).
2025-05-30 22:11:57,594 - INFO - AGENT:agent_airsoft_0faa9616 - ---ASSESS GRADED DOCUMENTS---
2025-05-30 22:11:57,594 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO RELEVANT DOCUMENTS, REWRITE---
2025-05-30 22:11:57,595 - INFO - AGENT:agent_airsoft_0faa9616 - ---TRANSFORM QUERY (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:11:57,595 - INFO - AGENT:agent_airsoft_0faa9616 - Using KB-specific model configuration for rewrite. KB IDs: ['5', '6', '7']
2025-05-30 22:11:57,595 - INFO - AGENT:agent_airsoft_0faa9616 - Rewrite attempt 2/3 for question: 'Ğ§Ñ‚Ğ¾ Ñƒ Ñ‚ĞµĞ±Ñ ĞµÑÑ‚ÑŒ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ½Ğ° Ñ‚ĞµĞ¼Ñƒ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° ÑƒÑ‚11?'
2025-05-30 22:11:57,595 - INFO - AGENT:agent_airsoft_0faa9616 - Rewriting original question: Ğ§Ñ‚Ğ¾ Ñƒ Ñ‚ĞµĞ±Ñ ĞµÑÑ‚ÑŒ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ½Ğ° Ñ‚ĞµĞ¼Ñƒ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° ÑƒÑ‚11?
2025-05-30 22:11:57,596 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenRouter, model: mistralai/mistral-small-3.1-24b-instruct:free, temp: 0.0, streaming: False
2025-05-30 22:11:57,620 - INFO - AGENT:agent_airsoft_0faa9616 - Created rewrite LLM for KB ['5', '6', '7']: mistralai/mistral-small-3.1-24b-instruct:free via OpenRouter
2025-05-30 22:12:08,644 - INFO - httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:12:16,531 - INFO - AGENT:agent_airsoft_0faa9616 - Rewritten question: ĞšĞ°ĞºĞ¸Ğµ ÑÑ‚Ğ°Ğ¿Ñ‹ Ğ¸ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ñƒ Ğ½Ğ° 1Ğ¡:Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ»ĞµĞ¹ 11 (Ğ£Ğ¢11) Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ñ‹ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹?
2025-05-30 22:12:16,532 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:5813 C:40 T:5853
2025-05-30 22:12:16,532 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for rewrite_llm: 5853 tokens recorded.
2025-05-30 22:12:16,533 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:12:16,533 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 22:12:16,559 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 22:12:16,562 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 5 tools.
2025-05-30 22:12:17,862 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:12:24,960 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ’ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ñ‹ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ ÑÑ‚Ğ°Ğ¿Ñ‹ Ğ¸ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ñƒ Ğ½Ğ° 1Ğ¡:Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ»ĞµĞ¹ 11 (Ğ£Ğ¢11
2025-05-30 22:12:24,961 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 22:12:24,961 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 3640, 'output_tokens': 411, 'total_tokens': 4051, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 22:12:24,961 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:3640 C:411 T:4051
2025-05-30 22:12:24,961 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 4051 tokens recorded.
2025-05-30 22:12:24,962 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 22:12:24,962 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 22:12:24,963 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ’ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ñ‹ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ ÑÑ‚Ğ°Ğ¿Ñ‹ Ğ¸ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ñƒ Ğ½Ğ° 1Ğ¡:Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ»ĞµĞ¹ 11 (Ğ£Ğ¢11...
2025-05-30 22:12:24,965 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 50137803-0e12-4937-bf00-8b36491c5bd9)
2025-05-30 22:12:24,966 - INFO - AGENT:agent_airsoft_0faa9616 - Found 5 token usage events for InteractionID: 50137803-0e12-4937-bf00-8b36491c5bd9.
2025-05-30 22:12:24,969 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '50137803-0e12-4937-bf00-8b36491c5bd9', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1960, 'completion_tokens': 29, 'total_tokens': 1989, 'timestamp': '2025-05-30T17:11:41.753322+00:00'}
2025-05-30 22:12:24,969 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 50137803-0e12-4937-bf00-8b36491c5bd9
2025-05-30 22:12:24,969 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Ğ’ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ñ‹ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ ÑÑ‚Ğ°Ğ¿Ñ‹ Ğ¸ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ñƒ Ğ½Ğ° 1Ğ¡:Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ»ĞµĞ¹ 11 (Ğ£Ğ¢11...
2025-05-30 22:12:24,970 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Ğ’ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ñ‹ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ ÑÑ‚Ğ°Ğ¿Ñ‹ Ğ¸ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†...'
2025-05-30 22:12:24,973 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 50137803-0e12-4937-bf00-8b36491c5bd9, db_id: 1042
2025-05-30 22:12:25,000 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1042 for interaction_id: 50137803-0e12-4937-bf00-8b36491c5bd9 on attempt 1
2025-05-30 22:12:25,007 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 50137803-0e12-4937-bf00-8b36491c5bd9, db_id: 526
2025-05-30 22:12:25,010 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '50137803-0e12-4937-bf00-8b36491c5bd9', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 3640, 'completion_tokens': 411, 'total_tokens': 4051, 'timestamp': '2025-05-30T17:12:24.961349+00:00'}
2025-05-30 22:12:25,010 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 50137803-0e12-4937-bf00-8b36491c5bd9
2025-05-30 22:12:25,011 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1042 for interaction_id: 50137803-0e12-4937-bf00-8b36491c5bd9 on attempt 1
2025-05-30 22:12:25,014 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 50137803-0e12-4937-bf00-8b36491c5bd9, db_id: 527
2025-05-30 22:12:25,016 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '50137803-0e12-4937-bf00-8b36491c5bd9', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'rewrite_llm', 'model_id': 'mistralai/mistral-small-3.1-24b-instruct:free', 'prompt_tokens': 5813, 'completion_tokens': 40, 'total_tokens': 5853, 'timestamp': '2025-05-30T17:12:16.532650+00:00'}
2025-05-30 22:12:25,016 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 50137803-0e12-4937-bf00-8b36491c5bd9
2025-05-30 22:12:25,017 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1042 for interaction_id: 50137803-0e12-4937-bf00-8b36491c5bd9 on attempt 1
2025-05-30 22:12:25,019 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 50137803-0e12-4937-bf00-8b36491c5bd9, db_id: 528
2025-05-30 22:12:25,021 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '50137803-0e12-4937-bf00-8b36491c5bd9', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 2792, 'completion_tokens': 45, 'total_tokens': 2837, 'timestamp': '2025-05-30T17:11:55.469266+00:00'}
2025-05-30 22:12:25,021 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 50137803-0e12-4937-bf00-8b36491c5bd9
2025-05-30 22:12:25,022 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1042 for interaction_id: 50137803-0e12-4937-bf00-8b36491c5bd9 on attempt 1
2025-05-30 22:12:25,024 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 50137803-0e12-4937-bf00-8b36491c5bd9, db_id: 529
2025-05-30 22:12:25,026 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '50137803-0e12-4937-bf00-8b36491c5bd9', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'rewrite_llm', 'model_id': 'mistralai/mistral-small-3.1-24b-instruct:free', 'prompt_tokens': 4368, 'completion_tokens': 40, 'total_tokens': 4408, 'timestamp': '2025-05-30T17:11:53.285122+00:00'}
2025-05-30 22:12:25,026 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 50137803-0e12-4937-bf00-8b36491c5bd9
2025-05-30 22:12:25,027 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1042 for interaction_id: 50137803-0e12-4937-bf00-8b36491c5bd9 on attempt 1
2025-05-30 22:12:25,029 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 50137803-0e12-4937-bf00-8b36491c5bd9, db_id: 530
2025-05-30 22:16:31,738 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 22:16:31,747 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 22:18:06,208 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 22:18:06,209 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 22:18:06,210 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 22:18:06,210 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4397059632) was cancelled.
2025-05-30 22:18:06,210 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4397059632) stopping. Performing cleanup...
2025-05-30 22:18:06,210 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 22:18:06,215 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 22:18:06,216 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 22:18:06,216 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:18:06,216 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 22:18:06,216 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 22:18:06,216 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4397059632) cleanup complete.
2025-05-30 22:18:06,216 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 22:18:06,216 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 22:18:06,217 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4397464224) was cancelled.
2025-05-30 22:18:06,217 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4397464224) stopping. Performing cleanup...
2025-05-30 22:18:06,217 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 22:18:06,219 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 22:18:06,220 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 22:18:06,220 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:18:06,220 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 22:18:06,220 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 22:18:06,220 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4397464224) cleanup complete.
2025-05-30 22:18:06,220 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 22:18:06,220 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 22:18:06,220 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4397464032) was cancelled.
2025-05-30 22:18:06,220 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4397464032) stopping. Performing cleanup...
2025-05-30 22:18:06,220 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 22:18:06,220 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:18:06,221 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 22:18:06,221 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 22:18:06,221 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 22:18:06,223 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 22:18:06,224 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 22:18:06,224 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:18:06,224 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 22:18:06,224 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 22:18:06,224 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 22:18:06,224 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4397464032) cleanup complete.
2025-05-30 22:18:06,224 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 22:18:06,224 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 22:18:06,224 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 22:18:06,235 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 22:18:06,235 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 22:18:06,707 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 22:18:06,707 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 22:18:06,711 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 22:18:06,711 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 22:18:06,711 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 22:18:06,711 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 22:18:06,711 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 22:18:06,711 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 22:18:06,711 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 22:18:06,711 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 22:18:06,712 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 22:18:06,712 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 22:18:06,712 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 22:18:06,716 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 22:18:06,716 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 22:18:06,716 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 22:18:06,716 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 22:18:06,716 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 22:18:06,716 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 22:18:06,716 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 22:18:06,733 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 22:18:06,734 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 22:18:06,734 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4410622560) setup complete. Starting run loop.
2025-05-30 22:18:06,734 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 22:18:06,734 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 22:18:06,734 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4410622752) setup complete. Starting run loop.
2025-05-30 22:18:06,734 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 22:18:06,735 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 22:18:06,735 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 22:18:06,765 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 22:18:06,765 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 22:18:06,766 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 22:18:06,766 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 22:18:06,766 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 22:18:06,767 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 22:18:06,768 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:18:06,768 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 22:18:06,768 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 22:18:06,768 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 22:18:09,868 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 22:18:09,868 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4849514448) received shutdown request. Initiating graceful shutdown...
2025-05-30 22:18:09,868 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4849514448)...
2025-05-30 22:18:09,868 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 22:18:09,868 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 22:18:09,869 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4849514448) was cancelled.
2025-05-30 22:18:09,869 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4849514448) stopping. Performing cleanup...
2025-05-30 22:18:09,869 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 22:18:09,868 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 22:18:09,869 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 22:18:09,870 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 22:18:09,870 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-30 22:18:09,877 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 22:18:09,877 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 22:18:09,878 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 22:18:09,878 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 22:18:09,879 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 22:18:09,879 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 22:18:09,879 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 22:18:09,884 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 22:18:09,885 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 22:18:09,885 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:18:09,885 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 22:18:09,885 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 22:18:09,885 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 22:18:09,885 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4849514448) cleanup complete.
2025-05-30 22:18:09,885 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 22:18:09,886 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 22:18:09,896 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 22:18:09,896 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 22:18:09,896 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 22:18:09,900 - INFO - __main__ - Agent runner main finished.
2025-05-30 22:18:09,988 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 22:18:09,988 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 22:18:09,988 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 22:18:09,988 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4410622752) was cancelled.
2025-05-30 22:18:09,988 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4410622752) stopping. Performing cleanup...
2025-05-30 22:18:09,988 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 22:18:09,992 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 22:18:09,993 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 22:18:09,993 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:18:09,993 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 22:18:09,993 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 22:18:09,993 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4410622752) cleanup complete.
2025-05-30 22:18:09,993 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 22:18:09,993 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 22:18:09,993 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4410622560) was cancelled.
2025-05-30 22:18:09,993 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4410622560) stopping. Performing cleanup...
2025-05-30 22:18:09,993 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 22:18:09,996 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 22:18:09,997 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 22:18:09,997 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:18:09,997 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 22:18:09,997 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 22:18:09,997 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4410622560) cleanup complete.
2025-05-30 22:18:09,997 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 22:18:09,997 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 22:18:09,998 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4410622704) was cancelled.
2025-05-30 22:18:09,998 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4410622704) stopping. Performing cleanup...
2025-05-30 22:18:09,998 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 22:18:09,998 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:18:09,998 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 22:18:09,998 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 22:18:09,998 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 22:18:10,000 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 22:18:10,004 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 22:18:10,004 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:18:10,004 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 22:18:10,004 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 22:18:10,004 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 22:18:10,004 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4410622704) cleanup complete.
2025-05-30 22:18:10,004 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 22:18:10,004 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 22:18:10,004 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 22:18:10,007 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 22:18:10,007 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 22:18:10,121 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 22:18:10,121 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 22:18:10,121 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 22:18:10,121 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4404160672) received shutdown request. Initiating graceful shutdown...
2025-05-30 22:18:10,121 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4404160672)...
2025-05-30 22:18:10,122 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 22:18:10,122 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 22:18:10,122 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4404160672) was cancelled.
2025-05-30 22:18:10,122 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4404160672) stopping. Performing cleanup...
2025-05-30 22:18:10,122 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 22:18:10,122 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 22:18:10,122 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 22:18:10,122 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 22:18:10,122 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 22:18:10,122 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 22:18:10,122 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 22:18:10,122 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 22:18:10,122 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 22:18:10,122 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 22:18:10,127 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 22:18:10,128 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 22:18:10,128 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:18:10,128 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 22:18:10,128 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 22:18:10,128 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 22:18:10,128 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4404160672) cleanup complete.
2025-05-30 22:18:10,128 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 22:18:10,128 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 22:18:10,133 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 22:18:10,133 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 22:18:10,133 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 22:18:10,134 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 22:18:13,436 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 22:18:13,436 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 22:18:13,441 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 22:18:13,441 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 22:18:13,441 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 22:18:13,441 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 22:18:13,441 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 22:18:13,441 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 22:18:13,441 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 22:18:13,441 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 22:18:13,441 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 22:18:13,441 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 22:18:13,441 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 22:18:13,444 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 22:18:13,444 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 22:18:13,444 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 22:18:13,444 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 22:18:13,444 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 22:18:13,444 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 22:18:13,444 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 22:18:13,460 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 22:18:13,460 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4355360432) setup complete. Starting run loop.
2025-05-30 22:18:13,460 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 22:18:13,461 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 22:18:13,462 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 22:18:13,462 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4380114048) setup complete. Starting run loop.
2025-05-30 22:18:13,462 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 22:18:13,473 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 22:18:13,473 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 22:18:13,492 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 22:18:13,492 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 22:18:13,494 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 22:18:13,494 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 94997
2025-05-30 22:18:13,495 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 94997
2025-05-30 22:18:13,495 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 22:18:13,495 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 22:18:13,495 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 22:18:13,496 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 22:18:13,497 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 94998
2025-05-30 22:18:13,497 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 94998
2025-05-30 22:18:13,498 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 22:18:13,498 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:18:13,498 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 22:18:13,498 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 22:18:13,498 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 22:18:14,374 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 22:18:14,375 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 22:18:14,375 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 22:18:14,375 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 22:18:14,375 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 94998
2025-05-30 22:18:14,375 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 22:18:14,375 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 22:18:14,375 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 22:18:14,380 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 22:18:14,393 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 22:18:14,393 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 22:18:14,393 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 22:18:14,393 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4638763120) setup complete. Starting run loop.
2025-05-30 22:18:14,393 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 22:18:14,393 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 22:18:14,393 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 22:18:14,393 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 22:18:14,393 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 22:18:14,393 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 22:18:14,393 - INFO - aiogram.dispatcher - Start polling
2025-05-30 22:18:14,396 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 22:18:14,635 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 22:18:14,732 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 22:18:14,733 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 22:18:14,733 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 22:18:14,733 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 22:18:14,733 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 94997
2025-05-30 22:18:14,733 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 22:18:14,733 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 22:18:14,733 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 22:18:14,775 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 22:18:14,775 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 22:18:14,820 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 22:18:14,820 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 22:18:14,820 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 22:18:14,820 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 22:18:14,820 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 22:18:14,820 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 22:18:14,845 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 22:18:14,845 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 22:18:14,845 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 22:18:14,847 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET) wirh description: Ğ£Ğ·Ğ½Ğ°Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² (Ğ±Ğ±) Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.)
2025-05-30 22:18:14,847 - INFO - AGENT:agent_airsoft_0faa9616 - Added 3 tools from centralized registry
2025-05-30 22:18:14,847 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 22:18:14,922 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 22:18:14,927 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 22:18:15,564 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 22:18:15,567 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 22:18:15,567 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'airsoft' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7'] with description: Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ 1Ñ
2025-05-30 22:18:15,567 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 22:18:15,567 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'airsoft-rus.ru' (ID: webSearch-1748459212676) with description: ĞŸĞ¾Ğ¸ÑĞº Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ ÑÑ‚Ñ€Ğ°Ğ¹ĞºĞ±Ğ¾Ğ»Ñƒ Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼ Ğ´Ğ»Ñ ÑÑ‚Ñ€Ğ°Ğ¹ĞºĞ±Ğ¾Ğ»Ğ° Ğ½Ğ° ÑĞ°Ğ¹Ñ‚Ğµ.
2025-05-30 22:18:15,567 - INFO - AGENT:agent_airsoft_0faa9616 - Found 1 additional API request configurations
2025-05-30 22:18:15,567 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 5 (4 safe, 1 datastore).
2025-05-30 22:18:15,567 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 5 total, 4 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 22:18:15,567 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 22:18:15,569 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 22:18:15,569 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 22:18:15,569 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 22:18:15,569 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 22:18:15,570 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->agent
2025-05-30 22:18:15,570 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 22:18:15,570 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 22:18:15,580 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 22:18:15,580 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 22:18:15,580 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 22:18:15,580 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4683348256) setup complete. Starting run loop.
2025-05-30 22:18:15,580 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 22:18:15,580 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 22:18:15,580 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 22:18:15,580 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 22:18:15,584 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 22:18:23,473 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 22:18:23,477 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 22:18:23,477 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4380489968) setup complete. Starting run loop.
2025-05-30 22:18:23,477 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 22:19:20,491 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Ğ’ ĞºĞ°ĞºĞ¾Ğµ Ğ¾Ñ‚Ğ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¹ Ğ½ĞµĞ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ ÑĞ²Ğ¸Ñ‚ÑŒÑÑ?...'
2025-05-30 22:19:20,493 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 22:19:20,572 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 22:19:20,572 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 22:19:20,572 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 22:19:20,575 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: d4f0ce2e-2c11-4314-ae4b-d522e93b9663)
2025-05-30 22:19:20,575 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 22:19:20,575 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-30 22:19:20,603 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: d4f0ce2e-2c11-4314-ae4b-d522e93b9663, db_id: 1043
2025-05-30 22:19:20,617 - INFO - AGENT:agent_airsoft_0faa9616 - Loaded 20 messages from DB for thread '144641834'.
2025-05-30 22:19:20,617 - INFO - AGENT:agent_airsoft_0faa9616 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-30 22:19:20,617 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-30 22:19:20,667 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:19:20,667 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 22:19:20,694 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 22:19:20,697 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 5 tools.
2025-05-30 22:19:21,573 - INFO - aiogram.event - Update id=804756363 is handled. Duration 1082 ms by bot id=1750613938
2025-05-30 22:19:22,104 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:19:24,028 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ§Ñ‚Ğ¾Ğ±Ñ‹ ÑƒĞ·Ğ½Ğ°Ñ‚ÑŒ, Ğ² ĞºĞ°ĞºĞ¾Ğµ Ğ¸Ğ¼ĞµĞ½Ğ½Ğ¾ Ğ¾Ñ‚Ğ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¹ Ğ¸Ğ½ÑĞ¿ĞµĞºÑ†Ğ¸Ğ¸ Ğ²Ğ°Ğ¼ Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑĞ²Ğ¸Ñ‚ÑŒÑÑ, Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾ Ğ¾Ñ€Ğ¸ĞµĞ½Ñ‚Ğ¸Ñ€ÑƒÑÑ‚ÑÑ Ğ¿
2025-05-30 22:19:24,029 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 22:19:24,029 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 2262, 'output_tokens': 96, 'total_tokens': 2358, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 22:19:24,029 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:2262 C:96 T:2358
2025-05-30 22:19:24,029 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 2358 tokens recorded.
2025-05-30 22:19:24,030 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 22:19:24,030 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 22:19:24,031 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ§Ñ‚Ğ¾Ğ±Ñ‹ ÑƒĞ·Ğ½Ğ°Ñ‚ÑŒ, Ğ² ĞºĞ°ĞºĞ¾Ğµ Ğ¸Ğ¼ĞµĞ½Ğ½Ğ¾ Ğ¾Ñ‚Ğ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¹ Ğ¸Ğ½ÑĞ¿ĞµĞºÑ†Ğ¸Ğ¸ Ğ²Ğ°Ğ¼ Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑĞ²Ğ¸Ñ‚ÑŒÑÑ, Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾ Ğ¾Ñ€Ğ¸ĞµĞ½Ñ‚Ğ¸Ñ€ÑƒÑÑ‚ÑÑ Ğ¿...
2025-05-30 22:19:24,033 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: d4f0ce2e-2c11-4314-ae4b-d522e93b9663)
2025-05-30 22:19:24,033 - INFO - AGENT:agent_airsoft_0faa9616 - Found 1 token usage events for InteractionID: d4f0ce2e-2c11-4314-ae4b-d522e93b9663.
2025-05-30 22:19:24,034 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Ğ§Ñ‚Ğ¾Ğ±Ñ‹ ÑƒĞ·Ğ½Ğ°Ñ‚ÑŒ, Ğ² ĞºĞ°ĞºĞ¾Ğµ Ğ¸Ğ¼ĞµĞ½Ğ½Ğ¾ Ğ¾Ñ‚Ğ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¹ Ğ¸Ğ½ÑĞ¿ĞµĞºÑ†Ğ¸Ğ¸ Ğ²Ğ°Ğ¼ Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑĞ²Ğ¸Ñ‚ÑŒÑÑ, Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾ Ğ¾Ñ€Ğ¸ĞµĞ½Ñ‚Ğ¸Ñ€ÑƒÑÑ‚ÑÑ Ğ¿...
2025-05-30 22:19:24,035 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Ğ§Ñ‚Ğ¾Ğ±Ñ‹ ÑƒĞ·Ğ½Ğ°Ñ‚ÑŒ, Ğ² ĞºĞ°ĞºĞ¾Ğµ Ğ¸Ğ¼ĞµĞ½Ğ½Ğ¾ Ğ¾Ñ‚Ğ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¹ Ğ¸...'
2025-05-30 22:19:24,037 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'd4f0ce2e-2c11-4314-ae4b-d522e93b9663', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 2262, 'completion_tokens': 96, 'total_tokens': 2358, 'timestamp': '2025-05-30T17:19:24.029111+00:00'}
2025-05-30 22:19:24,037 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: d4f0ce2e-2c11-4314-ae4b-d522e93b9663
2025-05-30 22:19:24,041 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: d4f0ce2e-2c11-4314-ae4b-d522e93b9663, db_id: 1044
2025-05-30 22:19:24,070 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1044 for interaction_id: d4f0ce2e-2c11-4314-ae4b-d522e93b9663 on attempt 1
2025-05-30 22:19:24,075 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: d4f0ce2e-2c11-4314-ae4b-d522e93b9663, db_id: 531
2025-05-30 22:19:56,160 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ¿Ğ¸ÑÑŒĞ¼Ğµ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹....'
2025-05-30 22:19:56,161 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 22:19:56,166 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 22:19:56,166 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 22:19:56,167 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 22:19:56,168 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: a6d03e9a-e015-4af6-9a9e-3448795f58ee)
2025-05-30 22:19:56,168 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 22:19:56,168 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 22:19:56,168 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 22:19:56,172 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:19:56,173 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 22:19:56,176 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: a6d03e9a-e015-4af6-9a9e-3448795f58ee, db_id: 1045
2025-05-30 22:19:56,199 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 22:19:56,201 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 5 tools.
2025-05-30 22:19:57,166 - INFO - aiogram.event - Update id=804756364 is handled. Duration 1008 ms by bot id=1750613938
2025-05-30 22:19:57,480 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:19:57,694 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 22:19:57,694 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_38647f5e19'}
2025-05-30 22:19:57,694 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 2375, 'output_tokens': 31, 'total_tokens': 2406, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 22:19:57,695 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:2375 C:31 T:2406
2025-05-30 22:19:57,695 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 2406 tokens recorded.
2025-05-30 22:19:57,695 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 22:19:57,696 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: knowledgeBase-1748440512419
2025-05-30 22:19:57,696 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO RETRIEVE (knowledgeBase-1748440512419)---
2025-05-30 22:19:58,228 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 22:19:58,247 - INFO - httpx - HTTP Request: POST http://127.0.0.1:6333/collections/platformai/points/query "HTTP/1.1 200 OK"
2025-05-30 22:19:58,250 - INFO - AGENT:agent_airsoft_0faa9616 - ---CHECK RELEVANCE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:19:58,250 - INFO - AGENT:agent_airsoft_0faa9616 - Grading documents for question: 'ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ¿Ğ¸ÑÑŒĞ¼Ğµ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹.'
2025-05-30 22:19:58,250 - INFO - AGENT:agent_airsoft_0faa9616 - Using KB-specific model configuration for KB IDs: ['5', '6', '7']
2025-05-30 22:19:58,250 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenRouter, model: mistralai/mistral-small-3.1-24b-instruct:free, temp: 0.0, streaming: False
2025-05-30 22:19:58,275 - INFO - AGENT:agent_airsoft_0faa9616 - Created grading LLM for KB ['5', '6', '7']: mistralai/mistral-small-3.1-24b-instruct:free via OpenRouter
2025-05-30 22:20:01,734 - INFO - httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:20:01,916 - ERROR - AGENT:agent_airsoft_0faa9616 - Error processing document for grading ('EVGENIY.IK@BK.RU

## Ğ£Ğ²Ğ°Ğ¶Ğ°ĞµĞ¼Ñ‹Ğ¹ Ğ•Ğ²Ğ³ĞµĞ½Ğ¸Ğ¹ Ğ’Ğ»Ğ°Ğ´Ğ¸ÑĞ»Ğ°Ğ²Ğ¾Ğ²Ğ¸Ñ‡!

ĞœĞµĞ¶Ñ€Ğ°Ğ¹Ğ¾Ğ½Ğ½Ğ°Ñ Ğ¸Ğ½ÑĞ¿ĞµĞºÑ†Ğ¸Ñ Ğ¤ĞµĞ´ĞµÑ€Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¹ Ñ...'): 1 validation error for Grade
  Invalid JSON: expected value at line 1 column 1 [type=json_invalid, input_value='yes', input_type=str]
    For further information visit https://errors.pydantic.dev/2.10/v/json_invalid
Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/agent_runner/langgraph/factory.py", line 420, in process_doc
    invocation_result = await chain.ainvoke({"question": current_question, "context": doc_content})
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3071, in ainvoke
    input = await asyncio.create_task(part(), context=context)  # type: ignore
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3780, in ainvoke
    results = await asyncio.gather(
              ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3770, in _ainvoke_step
    return await asyncio.create_task(  # type: ignore
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 5377, in ainvoke
    return await self.bound.ainvoke(
           ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 328, in ainvoke
    llm_result = await self.agenerate_prompt(
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 853, in agenerate_prompt
    return await self.agenerate(
           ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 813, in agenerate
    raise exceptions[0]
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 981, in _agenerate_with_cache
    result = await self._agenerate(
             ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_openai/chat_models/base.py", line 1094, in _agenerate
    response = await self.root_async_client.beta.chat.completions.parse(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/resources/beta/chat/completions.py", line 437, in parse
    return await self._post(
           ^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1767, in post
    return await self.request(cast_to, opts, stream=stream, stream_cls=stream_cls)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1461, in request
    return await self._request(
           ^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1564, in _request
    return await self._process_response(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1661, in _process_response
    return await api_response.parse()
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_response.py", line 432, in parse
    parsed = self._options.post_parser(parsed)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/resources/beta/chat/completions.py", line 431, in parser
    return _parse_chat_completion(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/lib/_parsing/_completions.py", line 110, in parse_chat_completion
    "parsed": maybe_parse_content(
              ^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/lib/_parsing/_completions.py", line 161, in maybe_parse_content
    return _parse_content(response_format, message.content)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/lib/_parsing/_completions.py", line 221, in _parse_content
    return cast(ResponseFormatT, model_parse_json(response_format, content))
                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_compat.py", line 169, in model_parse_json
    return model.model_validate_json(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/pydantic/main.py", line 656, in model_validate_json
    return cls.__pydantic_validator__.validate_json(json_data, strict=strict, context=context)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for Grade
  Invalid JSON: expected value at line 1 column 1 [type=json_invalid, input_value='yes', input_type=str]
    For further information visit https://errors.pydantic.dev/2.10/v/json_invalid
2025-05-30 22:20:01,916 - INFO - AGENT:agent_airsoft_0faa9616 - Found 0 relevant documents out of 1 initial (after split).
2025-05-30 22:20:01,917 - INFO - AGENT:agent_airsoft_0faa9616 - ---ASSESS GRADED DOCUMENTS---
2025-05-30 22:20:01,917 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO RELEVANT DOCUMENTS, REWRITE---
2025-05-30 22:20:01,918 - INFO - AGENT:agent_airsoft_0faa9616 - ---TRANSFORM QUERY (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:20:01,918 - INFO - AGENT:agent_airsoft_0faa9616 - Using KB-specific model configuration for rewrite. KB IDs: ['5', '6', '7']
2025-05-30 22:20:01,918 - INFO - AGENT:agent_airsoft_0faa9616 - Rewrite attempt 1/3 for question: 'ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ¿Ğ¸ÑÑŒĞ¼Ğµ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹.'
2025-05-30 22:20:01,918 - INFO - AGENT:agent_airsoft_0faa9616 - Rewriting original question: ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ¿Ğ¸ÑÑŒĞ¼Ğµ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹.
2025-05-30 22:20:01,918 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenRouter, model: mistralai/mistral-small-3.1-24b-instruct:free, temp: 0.0, streaming: False
2025-05-30 22:20:01,945 - INFO - AGENT:agent_airsoft_0faa9616 - Created rewrite LLM for KB ['5', '6', '7']: mistralai/mistral-small-3.1-24b-instruct:free via OpenRouter
2025-05-30 22:20:04,110 - INFO - httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:20:04,502 - INFO - AGENT:agent_airsoft_0faa9616 - Rewritten question: ĞĞ°Ğ¹Ğ´Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ¿Ğ¸ÑÑŒĞ¼Ğ¾ Ñ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ¼ Ğ² Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²ÑƒÑ Ğ¸Ğ½ÑĞ¿ĞµĞºÑ†Ğ¸Ñ.
2025-05-30 22:20:04,502 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:5131 C:24 T:5155
2025-05-30 22:20:04,502 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for rewrite_llm: 5155 tokens recorded.
2025-05-30 22:20:04,503 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:20:04,503 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 22:20:04,527 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 22:20:04,531 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 5 tools.
2025-05-30 22:20:05,859 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:20:06,093 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 22:20:06,093 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 22:20:06,093 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 3171, 'output_tokens': 31, 'total_tokens': 3202, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 22:20:06,094 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:3171 C:31 T:3202
2025-05-30 22:20:06,094 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 3202 tokens recorded.
2025-05-30 22:20:06,094 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 22:20:06,094 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: knowledgeBase-1748440512419
2025-05-30 22:20:06,094 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO RETRIEVE (knowledgeBase-1748440512419)---
2025-05-30 22:20:06,714 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 22:20:06,725 - INFO - httpx - HTTP Request: POST http://127.0.0.1:6333/collections/platformai/points/query "HTTP/1.1 200 OK"
2025-05-30 22:20:06,727 - INFO - AGENT:agent_airsoft_0faa9616 - ---CHECK RELEVANCE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:20:06,727 - INFO - AGENT:agent_airsoft_0faa9616 - Grading documents for question: 'ĞĞ°Ğ¹Ğ´Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ¿Ğ¸ÑÑŒĞ¼Ğ¾ Ñ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ¼ Ğ² Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²ÑƒÑ Ğ¸Ğ½ÑĞ¿ĞµĞºÑ†Ğ¸Ñ.'
2025-05-30 22:20:06,727 - INFO - AGENT:agent_airsoft_0faa9616 - Using KB-specific model configuration for KB IDs: ['5', '6', '7']
2025-05-30 22:20:06,727 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenRouter, model: mistralai/mistral-small-3.1-24b-instruct:free, temp: 0.0, streaming: False
2025-05-30 22:20:06,752 - INFO - AGENT:agent_airsoft_0faa9616 - Created grading LLM for KB ['5', '6', '7']: mistralai/mistral-small-3.1-24b-instruct:free via OpenRouter
2025-05-30 22:20:09,919 - INFO - httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:20:10,047 - ERROR - AGENT:agent_airsoft_0faa9616 - Error processing document for grading ('EVGENIY.IK@BK.RU

## Ğ£Ğ²Ğ°Ğ¶Ğ°ĞµĞ¼Ñ‹Ğ¹ Ğ•Ğ²Ğ³ĞµĞ½Ğ¸Ğ¹ Ğ’Ğ»Ğ°Ğ´Ğ¸ÑĞ»Ğ°Ğ²Ğ¾Ğ²Ğ¸Ñ‡!

ĞœĞµĞ¶Ñ€Ğ°Ğ¹Ğ¾Ğ½Ğ½Ğ°Ñ Ğ¸Ğ½ÑĞ¿ĞµĞºÑ†Ğ¸Ñ Ğ¤ĞµĞ´ĞµÑ€Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¹ Ñ...'): 1 validation error for Grade
  Invalid JSON: expected value at line 1 column 1 [type=json_invalid, input_value='yes', input_type=str]
    For further information visit https://errors.pydantic.dev/2.10/v/json_invalid
Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/agent_runner/langgraph/factory.py", line 420, in process_doc
    invocation_result = await chain.ainvoke({"question": current_question, "context": doc_content})
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3071, in ainvoke
    input = await asyncio.create_task(part(), context=context)  # type: ignore
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3780, in ainvoke
    results = await asyncio.gather(
              ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3770, in _ainvoke_step
    return await asyncio.create_task(  # type: ignore
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 5377, in ainvoke
    return await self.bound.ainvoke(
           ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 328, in ainvoke
    llm_result = await self.agenerate_prompt(
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 853, in agenerate_prompt
    return await self.agenerate(
           ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 813, in agenerate
    raise exceptions[0]
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 981, in _agenerate_with_cache
    result = await self._agenerate(
             ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_openai/chat_models/base.py", line 1094, in _agenerate
    response = await self.root_async_client.beta.chat.completions.parse(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/resources/beta/chat/completions.py", line 437, in parse
    return await self._post(
           ^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1767, in post
    return await self.request(cast_to, opts, stream=stream, stream_cls=stream_cls)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1461, in request
    return await self._request(
           ^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1564, in _request
    return await self._process_response(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1661, in _process_response
    return await api_response.parse()
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_response.py", line 432, in parse
    parsed = self._options.post_parser(parsed)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/resources/beta/chat/completions.py", line 431, in parser
    return _parse_chat_completion(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/lib/_parsing/_completions.py", line 110, in parse_chat_completion
    "parsed": maybe_parse_content(
              ^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/lib/_parsing/_completions.py", line 161, in maybe_parse_content
    return _parse_content(response_format, message.content)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/lib/_parsing/_completions.py", line 221, in _parse_content
    return cast(ResponseFormatT, model_parse_json(response_format, content))
                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_compat.py", line 169, in model_parse_json
    return model.model_validate_json(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/pydantic/main.py", line 656, in model_validate_json
    return cls.__pydantic_validator__.validate_json(json_data, strict=strict, context=context)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for Grade
  Invalid JSON: expected value at line 1 column 1 [type=json_invalid, input_value='yes', input_type=str]
    For further information visit https://errors.pydantic.dev/2.10/v/json_invalid
2025-05-30 22:20:10,047 - INFO - AGENT:agent_airsoft_0faa9616 - Found 0 relevant documents out of 1 initial (after split).
2025-05-30 22:20:10,048 - INFO - AGENT:agent_airsoft_0faa9616 - ---ASSESS GRADED DOCUMENTS---
2025-05-30 22:20:10,048 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO RELEVANT DOCUMENTS, REWRITE---
2025-05-30 22:20:10,049 - INFO - AGENT:agent_airsoft_0faa9616 - ---TRANSFORM QUERY (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:20:10,049 - INFO - AGENT:agent_airsoft_0faa9616 - Using KB-specific model configuration for rewrite. KB IDs: ['5', '6', '7']
2025-05-30 22:20:10,049 - INFO - AGENT:agent_airsoft_0faa9616 - Rewrite attempt 2/3 for question: 'ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ¿Ğ¸ÑÑŒĞ¼Ğµ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹.'
2025-05-30 22:20:10,049 - INFO - AGENT:agent_airsoft_0faa9616 - Rewriting original question: ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ¿Ğ¸ÑÑŒĞ¼Ğµ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹.
2025-05-30 22:20:10,049 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenRouter, model: mistralai/mistral-small-3.1-24b-instruct:free, temp: 0.0, streaming: False
2025-05-30 22:20:10,074 - INFO - AGENT:agent_airsoft_0faa9616 - Created rewrite LLM for KB ['5', '6', '7']: mistralai/mistral-small-3.1-24b-instruct:free via OpenRouter
2025-05-30 22:20:12,485 - INFO - httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:20:12,997 - INFO - AGENT:agent_airsoft_0faa9616 - Rewritten question: ĞĞ°Ğ¹Ğ´Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ñ‚ĞµĞºÑÑ‚ Ğ¿Ğ¸ÑÑŒĞ¼Ğ° Ñ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ¼ Ğ² Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²ÑƒÑ Ğ¸Ğ½ÑĞ¿ĞµĞºÑ†Ğ¸Ñ.
2025-05-30 22:20:12,997 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:6575 C:25 T:6600
2025-05-30 22:20:12,997 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for rewrite_llm: 6600 tokens recorded.
2025-05-30 22:20:12,998 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:20:12,999 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 22:20:13,023 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 22:20:13,025 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 5 tools.
2025-05-30 22:20:14,534 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:20:14,678 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 22:20:14,678 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 22:20:14,678 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 3969, 'output_tokens': 32, 'total_tokens': 4001, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 22:20:14,678 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:3969 C:32 T:4001
2025-05-30 22:20:14,678 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 4001 tokens recorded.
2025-05-30 22:20:14,679 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 22:20:14,679 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: knowledgeBase-1748440512419
2025-05-30 22:20:14,679 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO RETRIEVE (knowledgeBase-1748440512419)---
2025-05-30 22:20:15,236 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 22:20:15,249 - INFO - httpx - HTTP Request: POST http://127.0.0.1:6333/collections/platformai/points/query "HTTP/1.1 200 OK"
2025-05-30 22:20:15,251 - INFO - AGENT:agent_airsoft_0faa9616 - ---CHECK RELEVANCE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:20:15,251 - INFO - AGENT:agent_airsoft_0faa9616 - Grading documents for question: 'ĞĞ°Ğ¹Ğ´Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ñ‚ĞµĞºÑÑ‚ Ğ¿Ğ¸ÑÑŒĞ¼Ğ° Ñ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ¼ Ğ² Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²ÑƒÑ Ğ¸Ğ½ÑĞ¿ĞµĞºÑ†Ğ¸Ñ.'
2025-05-30 22:20:15,251 - INFO - AGENT:agent_airsoft_0faa9616 - Using KB-specific model configuration for KB IDs: ['5', '6', '7']
2025-05-30 22:20:15,251 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenRouter, model: mistralai/mistral-small-3.1-24b-instruct:free, temp: 0.0, streaming: False
2025-05-30 22:20:15,276 - INFO - AGENT:agent_airsoft_0faa9616 - Created grading LLM for KB ['5', '6', '7']: mistralai/mistral-small-3.1-24b-instruct:free via OpenRouter
2025-05-30 22:20:18,610 - INFO - httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:20:18,701 - ERROR - AGENT:agent_airsoft_0faa9616 - Error processing document for grading ('EVGENIY.IK@BK.RU

## Ğ£Ğ²Ğ°Ğ¶Ğ°ĞµĞ¼Ñ‹Ğ¹ Ğ•Ğ²Ğ³ĞµĞ½Ğ¸Ğ¹ Ğ’Ğ»Ğ°Ğ´Ğ¸ÑĞ»Ğ°Ğ²Ğ¾Ğ²Ğ¸Ñ‡!

ĞœĞµĞ¶Ñ€Ğ°Ğ¹Ğ¾Ğ½Ğ½Ğ°Ñ Ğ¸Ğ½ÑĞ¿ĞµĞºÑ†Ğ¸Ñ Ğ¤ĞµĞ´ĞµÑ€Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ¹ Ñ...'): 1 validation error for Grade
  Invalid JSON: expected value at line 1 column 1 [type=json_invalid, input_value='yes', input_type=str]
    For further information visit https://errors.pydantic.dev/2.10/v/json_invalid
Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/agent_runner/langgraph/factory.py", line 420, in process_doc
    invocation_result = await chain.ainvoke({"question": current_question, "context": doc_content})
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3071, in ainvoke
    input = await asyncio.create_task(part(), context=context)  # type: ignore
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3780, in ainvoke
    results = await asyncio.gather(
              ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3770, in _ainvoke_step
    return await asyncio.create_task(  # type: ignore
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 5377, in ainvoke
    return await self.bound.ainvoke(
           ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 328, in ainvoke
    llm_result = await self.agenerate_prompt(
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 853, in agenerate_prompt
    return await self.agenerate(
           ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 813, in agenerate
    raise exceptions[0]
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 981, in _agenerate_with_cache
    result = await self._agenerate(
             ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_openai/chat_models/base.py", line 1094, in _agenerate
    response = await self.root_async_client.beta.chat.completions.parse(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/resources/beta/chat/completions.py", line 437, in parse
    return await self._post(
           ^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1767, in post
    return await self.request(cast_to, opts, stream=stream, stream_cls=stream_cls)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1461, in request
    return await self._request(
           ^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1564, in _request
    return await self._process_response(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1661, in _process_response
    return await api_response.parse()
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_response.py", line 432, in parse
    parsed = self._options.post_parser(parsed)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/resources/beta/chat/completions.py", line 431, in parser
    return _parse_chat_completion(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/lib/_parsing/_completions.py", line 110, in parse_chat_completion
    "parsed": maybe_parse_content(
              ^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/lib/_parsing/_completions.py", line 161, in maybe_parse_content
    return _parse_content(response_format, message.content)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/lib/_parsing/_completions.py", line 221, in _parse_content
    return cast(ResponseFormatT, model_parse_json(response_format, content))
                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_compat.py", line 169, in model_parse_json
    return model.model_validate_json(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/pydantic/main.py", line 656, in model_validate_json
    return cls.__pydantic_validator__.validate_json(json_data, strict=strict, context=context)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for Grade
  Invalid JSON: expected value at line 1 column 1 [type=json_invalid, input_value='yes', input_type=str]
    For further information visit https://errors.pydantic.dev/2.10/v/json_invalid
2025-05-30 22:20:18,701 - INFO - AGENT:agent_airsoft_0faa9616 - Found 0 relevant documents out of 1 initial (after split).
2025-05-30 22:20:18,702 - INFO - AGENT:agent_airsoft_0faa9616 - ---ASSESS GRADED DOCUMENTS---
2025-05-30 22:20:18,702 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO RELEVANT DOCUMENTS, REWRITE---
2025-05-30 22:20:18,703 - INFO - AGENT:agent_airsoft_0faa9616 - ---TRANSFORM QUERY (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:20:18,703 - INFO - AGENT:agent_airsoft_0faa9616 - Using KB-specific model configuration for rewrite. KB IDs: ['5', '6', '7']
2025-05-30 22:20:18,703 - INFO - AGENT:agent_airsoft_0faa9616 - Rewrite attempt 3/3 for question: 'ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ¿Ğ¸ÑÑŒĞ¼Ğµ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹.'
2025-05-30 22:20:18,703 - INFO - AGENT:agent_airsoft_0faa9616 - Rewriting original question: ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ¿Ğ¸ÑÑŒĞ¼Ğµ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹.
2025-05-30 22:20:18,703 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenRouter, model: mistralai/mistral-small-3.1-24b-instruct:free, temp: 0.0, streaming: False
2025-05-30 22:20:18,728 - INFO - AGENT:agent_airsoft_0faa9616 - Created rewrite LLM for KB ['5', '6', '7']: mistralai/mistral-small-3.1-24b-instruct:free via OpenRouter
2025-05-30 22:20:22,213 - INFO - httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:20:22,397 - INFO - AGENT:agent_airsoft_0faa9616 - Rewritten question: ĞĞ°Ğ¹Ğ´Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ñ‚ĞµĞºÑÑ‚ Ğ¿Ğ¸ÑÑŒĞ¼Ğ° Ñ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ¼ Ğ² Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²ÑƒÑ Ğ¸Ğ½ÑĞ¿ĞµĞºÑ†Ğ¸Ñ.
2025-05-30 22:20:22,397 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:8024 C:25 T:8049
2025-05-30 22:20:22,397 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for rewrite_llm: 8049 tokens recorded.
2025-05-30 22:20:22,398 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:20:22,398 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 22:20:22,423 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 22:20:22,425 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 5 tools.
2025-05-30 22:20:23,851 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:20:30,641 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ’Ğ¾Ñ‚ Ñ‚ĞµĞºÑÑ‚ Ğ¿Ğ¸ÑÑŒĞ¼Ğ° Ñ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ¼ Ğ² Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²ÑƒÑ Ğ¸Ğ½ÑĞ¿ĞµĞºÑ†Ğ¸Ñ Ğ¸Ğ· Ğ±Ğ°Ğ·Ñ‹ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹:

---

**ĞœĞµĞ¶Ñ€Ğ°Ğ¹Ğ¾Ğ½Ğ½Ğ°Ñ Ğ¸Ğ½ÑĞ¿ĞµĞºÑ†Ğ¸Ñ Ğ¤ĞµĞ´ĞµÑ€
2025-05-30 22:20:30,642 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 22:20:30,642 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 4768, 'output_tokens': 341, 'total_tokens': 5109, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 22:20:30,642 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:4768 C:341 T:5109
2025-05-30 22:20:30,642 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 5109 tokens recorded.
2025-05-30 22:20:30,643 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 22:20:30,643 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 22:20:30,644 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ’Ğ¾Ñ‚ Ñ‚ĞµĞºÑÑ‚ Ğ¿Ğ¸ÑÑŒĞ¼Ğ° Ñ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ¼ Ğ² Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²ÑƒÑ Ğ¸Ğ½ÑĞ¿ĞµĞºÑ†Ğ¸Ñ Ğ¸Ğ· Ğ±Ğ°Ğ·Ñ‹ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹:

---

**ĞœĞµĞ¶Ñ€Ğ°Ğ¹Ğ¾Ğ½Ğ½Ğ°Ñ Ğ¸Ğ½ÑĞ¿ĞµĞºÑ†Ğ¸Ñ Ğ¤ĞµĞ´ĞµÑ€...
2025-05-30 22:20:30,647 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: a6d03e9a-e015-4af6-9a9e-3448795f58ee)
2025-05-30 22:20:30,647 - INFO - AGENT:agent_airsoft_0faa9616 - Found 7 token usage events for InteractionID: a6d03e9a-e015-4af6-9a9e-3448795f58ee.
2025-05-30 22:20:30,652 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'a6d03e9a-e015-4af6-9a9e-3448795f58ee', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 2375, 'completion_tokens': 31, 'total_tokens': 2406, 'timestamp': '2025-05-30T17:19:57.695038+00:00'}
2025-05-30 22:20:30,652 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: a6d03e9a-e015-4af6-9a9e-3448795f58ee
2025-05-30 22:20:30,655 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Ğ’Ğ¾Ñ‚ Ñ‚ĞµĞºÑÑ‚ Ğ¿Ğ¸ÑÑŒĞ¼Ğ° Ñ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ¼ Ğ² Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²ÑƒÑ Ğ¸Ğ½ÑĞ¿ĞµĞºÑ†Ğ¸Ñ Ğ¸Ğ· Ğ±Ğ°Ğ·Ñ‹ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹:

---

**ĞœĞµĞ¶Ñ€Ğ°Ğ¹Ğ¾Ğ½Ğ½Ğ°Ñ Ğ¸Ğ½ÑĞ¿ĞµĞºÑ†Ğ¸Ñ Ğ¤ĞµĞ´ĞµÑ€...
2025-05-30 22:20:30,655 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Ğ’Ğ¾Ñ‚ Ñ‚ĞµĞºÑÑ‚ Ğ¿Ğ¸ÑÑŒĞ¼Ğ° Ñ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ¼ Ğ² Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²ÑƒÑ Ğ¸Ğ½ÑĞ¿ĞµĞºÑ†Ğ¸Ñ Ğ¸...'
2025-05-30 22:20:30,657 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1046 for interaction_id: a6d03e9a-e015-4af6-9a9e-3448795f58ee on attempt 1
2025-05-30 22:20:30,657 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: a6d03e9a-e015-4af6-9a9e-3448795f58ee, db_id: 1046
2025-05-30 22:20:30,663 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: a6d03e9a-e015-4af6-9a9e-3448795f58ee, db_id: 532
2025-05-30 22:20:30,666 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'a6d03e9a-e015-4af6-9a9e-3448795f58ee', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 4768, 'completion_tokens': 341, 'total_tokens': 5109, 'timestamp': '2025-05-30T17:20:30.642811+00:00'}
2025-05-30 22:20:30,666 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: a6d03e9a-e015-4af6-9a9e-3448795f58ee
2025-05-30 22:20:30,667 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1046 for interaction_id: a6d03e9a-e015-4af6-9a9e-3448795f58ee on attempt 1
2025-05-30 22:20:30,671 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: a6d03e9a-e015-4af6-9a9e-3448795f58ee, db_id: 533
2025-05-30 22:20:30,674 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'a6d03e9a-e015-4af6-9a9e-3448795f58ee', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'rewrite_llm', 'model_id': 'mistralai/mistral-small-3.1-24b-instruct:free', 'prompt_tokens': 8024, 'completion_tokens': 25, 'total_tokens': 8049, 'timestamp': '2025-05-30T17:20:22.397359+00:00'}
2025-05-30 22:20:30,674 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: a6d03e9a-e015-4af6-9a9e-3448795f58ee
2025-05-30 22:20:30,676 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1046 for interaction_id: a6d03e9a-e015-4af6-9a9e-3448795f58ee on attempt 1
2025-05-30 22:20:30,678 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: a6d03e9a-e015-4af6-9a9e-3448795f58ee, db_id: 534
2025-05-30 22:20:30,680 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'a6d03e9a-e015-4af6-9a9e-3448795f58ee', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 3969, 'completion_tokens': 32, 'total_tokens': 4001, 'timestamp': '2025-05-30T17:20:14.678912+00:00'}
2025-05-30 22:20:30,680 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: a6d03e9a-e015-4af6-9a9e-3448795f58ee
2025-05-30 22:20:30,681 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1046 for interaction_id: a6d03e9a-e015-4af6-9a9e-3448795f58ee on attempt 1
2025-05-30 22:20:30,683 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: a6d03e9a-e015-4af6-9a9e-3448795f58ee, db_id: 535
2025-05-30 22:20:30,685 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'a6d03e9a-e015-4af6-9a9e-3448795f58ee', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'rewrite_llm', 'model_id': 'mistralai/mistral-small-3.1-24b-instruct:free', 'prompt_tokens': 6575, 'completion_tokens': 25, 'total_tokens': 6600, 'timestamp': '2025-05-30T17:20:12.997874+00:00'}
2025-05-30 22:20:30,685 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: a6d03e9a-e015-4af6-9a9e-3448795f58ee
2025-05-30 22:20:30,686 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1046 for interaction_id: a6d03e9a-e015-4af6-9a9e-3448795f58ee on attempt 1
2025-05-30 22:20:30,688 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: a6d03e9a-e015-4af6-9a9e-3448795f58ee, db_id: 536
2025-05-30 22:20:30,691 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'a6d03e9a-e015-4af6-9a9e-3448795f58ee', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 3171, 'completion_tokens': 31, 'total_tokens': 3202, 'timestamp': '2025-05-30T17:20:06.094036+00:00'}
2025-05-30 22:20:30,691 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: a6d03e9a-e015-4af6-9a9e-3448795f58ee
2025-05-30 22:20:30,692 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1046 for interaction_id: a6d03e9a-e015-4af6-9a9e-3448795f58ee on attempt 1
2025-05-30 22:20:30,694 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: a6d03e9a-e015-4af6-9a9e-3448795f58ee, db_id: 537
2025-05-30 22:20:30,696 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'a6d03e9a-e015-4af6-9a9e-3448795f58ee', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'rewrite_llm', 'model_id': 'mistralai/mistral-small-3.1-24b-instruct:free', 'prompt_tokens': 5131, 'completion_tokens': 24, 'total_tokens': 5155, 'timestamp': '2025-05-30T17:20:04.502537+00:00'}
2025-05-30 22:20:30,696 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: a6d03e9a-e015-4af6-9a9e-3448795f58ee
2025-05-30 22:20:30,697 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1046 for interaction_id: a6d03e9a-e015-4af6-9a9e-3448795f58ee on attempt 1
2025-05-30 22:20:30,699 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: a6d03e9a-e015-4af6-9a9e-3448795f58ee, db_id: 538
2025-05-30 22:21:48,911 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 22:21:48,912 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 22:21:48,912 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 22:21:48,913 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4355360432) was cancelled.
2025-05-30 22:21:48,913 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4355360432) stopping. Performing cleanup...
2025-05-30 22:21:48,913 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 22:21:48,916 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 22:21:48,917 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 22:21:48,917 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:21:48,918 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 22:21:48,918 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 22:21:48,918 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4355360432) cleanup complete.
2025-05-30 22:21:48,918 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 22:21:48,918 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 22:21:48,918 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4380114048) was cancelled.
2025-05-30 22:21:48,918 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4380114048) stopping. Performing cleanup...
2025-05-30 22:21:48,918 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 22:21:48,921 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 22:21:48,921 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 22:21:48,921 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:21:48,921 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 22:21:48,921 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 22:21:48,921 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4380114048) cleanup complete.
2025-05-30 22:21:48,922 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 22:21:48,922 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 22:21:48,922 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4380489968) was cancelled.
2025-05-30 22:21:48,922 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4380489968) stopping. Performing cleanup...
2025-05-30 22:21:48,922 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 22:21:48,922 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:21:48,922 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 22:21:48,922 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 22:21:48,922 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 22:21:48,925 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 22:21:48,925 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 22:21:48,925 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:21:48,926 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 22:21:48,926 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 22:21:48,926 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 22:21:48,926 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4380489968) cleanup complete.
2025-05-30 22:21:48,926 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 22:21:48,926 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 22:21:48,926 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 22:21:48,934 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 22:21:48,934 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 22:21:49,352 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 22:21:49,352 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 22:21:49,358 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 22:21:49,358 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 22:21:49,358 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 22:21:49,358 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 22:21:49,358 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 22:21:49,358 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 22:21:49,358 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 22:21:49,358 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 22:21:49,358 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 22:21:49,358 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 22:21:49,358 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 22:21:49,361 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 22:21:49,361 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 22:21:49,361 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 22:21:49,376 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 22:21:49,376 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 22:21:49,376 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 22:21:49,376 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 22:21:49,379 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 22:21:49,379 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4440959664) setup complete. Starting run loop.
2025-05-30 22:21:49,379 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 22:21:49,381 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 22:21:49,381 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 22:21:49,382 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4440769264) setup complete. Starting run loop.
2025-05-30 22:21:49,382 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 22:21:49,385 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 22:21:49,385 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 22:21:49,414 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 22:21:49,414 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 22:21:49,415 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 22:21:49,415 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 22:21:49,415 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 22:21:49,416 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 22:21:49,417 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:21:49,417 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 22:21:49,417 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 22:21:49,417 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 22:21:59,385 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 22:21:59,392 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 22:21:59,392 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4440769648) setup complete. Starting run loop.
2025-05-30 22:21:59,392 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 22:23:08,370 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° ÑƒÑ‚11?...'
2025-05-30 22:23:08,372 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 22:23:08,387 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 22:23:08,387 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 22:23:08,389 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 22:23:08,394 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 980c610d-c1c5-4153-8a17-5a90a215d20c)
2025-05-30 22:23:08,395 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 22:23:08,396 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 22:23:08,397 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 22:23:08,411 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:23:08,411 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 22:23:08,438 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 980c610d-c1c5-4153-8a17-5a90a215d20c, db_id: 1047
2025-05-30 22:23:08,442 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 22:23:08,445 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 5 tools.
2025-05-30 22:23:09,387 - INFO - aiogram.event - Update id=804756365 is handled. Duration 1018 ms by bot id=1750613938
2025-05-30 22:23:09,926 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:23:13,393 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ”Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ğ¡:Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ»ĞµĞ¹ 11 (Ğ£Ğ¢11) Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ Ğ¸Ğ¼ĞµÑ‚ÑŒ ÑˆÑ‚Ğ°Ñ‚ Ğ¸Ğ· 2-3 Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² 1Ğ¡. 
2025-05-30 22:23:13,393 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_38647f5e19'}
2025-05-30 22:23:13,393 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 5130, 'output_tokens': 171, 'total_tokens': 5301, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 22:23:13,393 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:5130 C:171 T:5301
2025-05-30 22:23:13,393 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 5301 tokens recorded.
2025-05-30 22:23:13,394 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 22:23:13,394 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 22:23:13,395 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ”Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ğ¡:Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ»ĞµĞ¹ 11 (Ğ£Ğ¢11) Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ Ğ¸Ğ¼ĞµÑ‚ÑŒ ÑˆÑ‚Ğ°Ñ‚ Ğ¸Ğ· 2-3 Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² 1Ğ¡. ...
2025-05-30 22:23:13,396 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 980c610d-c1c5-4153-8a17-5a90a215d20c)
2025-05-30 22:23:13,397 - INFO - AGENT:agent_airsoft_0faa9616 - Found 1 token usage events for InteractionID: 980c610d-c1c5-4153-8a17-5a90a215d20c.
2025-05-30 22:23:13,399 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Ğ”Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ğ¡:Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ»ĞµĞ¹ 11 (Ğ£Ğ¢11) Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ Ğ¸Ğ¼ĞµÑ‚ÑŒ ÑˆÑ‚Ğ°Ñ‚ Ğ¸Ğ· 2-3 Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² 1Ğ¡. ...
2025-05-30 22:23:13,399 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Ğ”Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ğ¡:Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ»ĞµĞ¹ 11 (Ğ£Ğ¢11) ...'
2025-05-30 22:23:13,400 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '980c610d-c1c5-4153-8a17-5a90a215d20c', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 5130, 'completion_tokens': 171, 'total_tokens': 5301, 'timestamp': '2025-05-30T17:23:13.393244+00:00'}
2025-05-30 22:23:13,400 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 980c610d-c1c5-4153-8a17-5a90a215d20c
2025-05-30 22:23:13,406 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 980c610d-c1c5-4153-8a17-5a90a215d20c, db_id: 1048
2025-05-30 22:23:13,435 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1048 for interaction_id: 980c610d-c1c5-4153-8a17-5a90a215d20c on attempt 1
2025-05-30 22:23:13,439 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 980c610d-c1c5-4153-8a17-5a90a215d20c, db_id: 539
2025-05-30 22:23:28,463 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Ğ¿Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹...'
2025-05-30 22:23:28,466 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 22:23:28,469 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 22:23:28,469 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 22:23:28,469 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 22:23:28,471 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 333db720-8948-48c7-88a0-81c3032f5710)
2025-05-30 22:23:28,471 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 22:23:28,472 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 22:23:28,472 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 22:23:28,475 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:23:28,475 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 22:23:28,478 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 333db720-8948-48c7-88a0-81c3032f5710, db_id: 1049
2025-05-30 22:23:28,503 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 22:23:28,506 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 5 tools.
2025-05-30 22:23:29,469 - INFO - aiogram.event - Update id=804756366 is handled. Duration 1007 ms by bot id=1750613938
2025-05-30 22:23:29,885 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:23:30,188 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 22:23:30,188 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_38647f5e19'}
2025-05-30 22:23:30,188 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 5314, 'output_tokens': 36, 'total_tokens': 5350, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 22:23:30,188 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:5314 C:36 T:5350
2025-05-30 22:23:30,188 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 5350 tokens recorded.
2025-05-30 22:23:30,189 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 22:23:30,189 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: knowledgeBase-1748440512419
2025-05-30 22:23:30,189 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO RETRIEVE (knowledgeBase-1748440512419)---
2025-05-30 22:23:30,821 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 22:23:30,841 - INFO - httpx - HTTP Request: POST http://127.0.0.1:6333/collections/platformai/points/query "HTTP/1.1 200 OK"
2025-05-30 22:23:30,843 - INFO - AGENT:agent_airsoft_0faa9616 - ---CHECK RELEVANCE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:23:30,844 - INFO - AGENT:agent_airsoft_0faa9616 - Grading documents for question: 'Ğ¿Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹'
2025-05-30 22:23:30,844 - INFO - AGENT:agent_airsoft_0faa9616 - Using KB-specific model configuration for KB IDs: ['5', '6', '7']
2025-05-30 22:23:30,844 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenRouter, model: mistralai/mistral-small-3.1-24b-instruct:free, temp: 0.0, streaming: False
2025-05-30 22:23:30,868 - INFO - AGENT:agent_airsoft_0faa9616 - Created grading LLM for KB ['5', '6', '7']: mistralai/mistral-small-3.1-24b-instruct:free via OpenRouter
2025-05-30 22:23:33,930 - INFO - httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:23:33,973 - ERROR - AGENT:agent_airsoft_0faa9616 - Error processing document for grading ('ĞšĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ° Ğ²ĞµĞ´ĞµĞ½Ğ¸Ñ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ¸ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ²Ğ¾Ğ´Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ´ Ñ€ĞµĞ²ÑŒÑ Ğ¸ ÑĞ»ĞµĞ´Ğ¸Ñ‚ÑŒ Ğ·Ğ° ÑÑ‚Ğ¸Ğ¼ ...'): 1 validation error for Grade
  Invalid JSON: expected ident at line 1 column 2 [type=json_invalid, input_value='no', input_type=str]
    For further information visit https://errors.pydantic.dev/2.10/v/json_invalid
Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/agent_runner/langgraph/factory.py", line 420, in process_doc
    invocation_result = await chain.ainvoke({"question": current_question, "context": doc_content})
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3071, in ainvoke
    input = await asyncio.create_task(part(), context=context)  # type: ignore
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3780, in ainvoke
    results = await asyncio.gather(
              ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3770, in _ainvoke_step
    return await asyncio.create_task(  # type: ignore
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 5377, in ainvoke
    return await self.bound.ainvoke(
           ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 328, in ainvoke
    llm_result = await self.agenerate_prompt(
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 853, in agenerate_prompt
    return await self.agenerate(
           ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 813, in agenerate
    raise exceptions[0]
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 981, in _agenerate_with_cache
    result = await self._agenerate(
             ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_openai/chat_models/base.py", line 1094, in _agenerate
    response = await self.root_async_client.beta.chat.completions.parse(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/resources/beta/chat/completions.py", line 437, in parse
    return await self._post(
           ^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1767, in post
    return await self.request(cast_to, opts, stream=stream, stream_cls=stream_cls)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1461, in request
    return await self._request(
           ^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1564, in _request
    return await self._process_response(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1661, in _process_response
    return await api_response.parse()
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_response.py", line 432, in parse
    parsed = self._options.post_parser(parsed)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/resources/beta/chat/completions.py", line 431, in parser
    return _parse_chat_completion(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/lib/_parsing/_completions.py", line 110, in parse_chat_completion
    "parsed": maybe_parse_content(
              ^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/lib/_parsing/_completions.py", line 161, in maybe_parse_content
    return _parse_content(response_format, message.content)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/lib/_parsing/_completions.py", line 221, in _parse_content
    return cast(ResponseFormatT, model_parse_json(response_format, content))
                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_compat.py", line 169, in model_parse_json
    return model.model_validate_json(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/pydantic/main.py", line 656, in model_validate_json
    return cls.__pydantic_validator__.validate_json(json_data, strict=strict, context=context)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for Grade
  Invalid JSON: expected ident at line 1 column 2 [type=json_invalid, input_value='no', input_type=str]
    For further information visit https://errors.pydantic.dev/2.10/v/json_invalid
2025-05-30 22:23:33,975 - INFO - AGENT:agent_airsoft_0faa9616 - Found 0 relevant documents out of 1 initial (after split).
2025-05-30 22:23:33,976 - INFO - AGENT:agent_airsoft_0faa9616 - ---ASSESS GRADED DOCUMENTS---
2025-05-30 22:23:33,976 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO RELEVANT DOCUMENTS, REWRITE---
2025-05-30 22:23:33,977 - INFO - AGENT:agent_airsoft_0faa9616 - ---TRANSFORM QUERY (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:23:33,977 - INFO - AGENT:agent_airsoft_0faa9616 - Using KB-specific model configuration for rewrite. KB IDs: ['5', '6', '7']
2025-05-30 22:23:33,977 - INFO - AGENT:agent_airsoft_0faa9616 - Rewrite attempt 1/3 for question: 'Ğ¿Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹'
2025-05-30 22:23:33,977 - INFO - AGENT:agent_airsoft_0faa9616 - Rewriting original question: Ğ¿Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹
2025-05-30 22:23:33,977 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenRouter, model: mistralai/mistral-small-3.1-24b-instruct:free, temp: 0.0, streaming: False
2025-05-30 22:23:34,004 - INFO - AGENT:agent_airsoft_0faa9616 - Created rewrite LLM for KB ['5', '6', '7']: mistralai/mistral-small-3.1-24b-instruct:free via OpenRouter
2025-05-30 22:23:37,594 - INFO - httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:23:39,130 - INFO - AGENT:agent_airsoft_0faa9616 - Rewritten question: ĞĞ°Ğ¹Ğ´Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğµ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ², Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ñ… Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ğ¡:Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ»ĞµĞ¹ 11 (Ğ£Ğ¢11).
2025-05-30 22:23:39,130 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:10556 C:42 T:10598
2025-05-30 22:23:39,130 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for rewrite_llm: 10598 tokens recorded.
2025-05-30 22:23:39,132 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:23:39,132 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 22:23:39,156 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 22:23:39,159 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 5 tools.
2025-05-30 22:23:48,652 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:23:49,451 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 22:23:49,452 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 22:23:49,452 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 6156, 'output_tokens': 42, 'total_tokens': 6198, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 22:23:49,452 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:6156 C:42 T:6198
2025-05-30 22:23:49,452 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 6198 tokens recorded.
2025-05-30 22:23:49,453 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 22:23:49,453 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: knowledgeBase-1748440512419
2025-05-30 22:23:49,453 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO RETRIEVE (knowledgeBase-1748440512419)---
2025-05-30 22:23:50,599 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 22:23:50,614 - INFO - httpx - HTTP Request: POST http://127.0.0.1:6333/collections/platformai/points/query "HTTP/1.1 200 OK"
2025-05-30 22:23:50,617 - INFO - AGENT:agent_airsoft_0faa9616 - ---CHECK RELEVANCE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:23:50,617 - INFO - AGENT:agent_airsoft_0faa9616 - Grading documents for question: 'ĞĞ°Ğ¹Ğ´Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğµ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ², Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ñ… Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ğ¡:Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ»ĞµĞ¹ 11 (Ğ£Ğ¢11).'
2025-05-30 22:23:50,617 - INFO - AGENT:agent_airsoft_0faa9616 - Using KB-specific model configuration for KB IDs: ['5', '6', '7']
2025-05-30 22:23:50,617 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenRouter, model: mistralai/mistral-small-3.1-24b-instruct:free, temp: 0.0, streaming: False
2025-05-30 22:23:50,642 - INFO - AGENT:agent_airsoft_0faa9616 - Created grading LLM for KB ['5', '6', '7']: mistralai/mistral-small-3.1-24b-instruct:free via OpenRouter
2025-05-30 22:23:52,953 - INFO - httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:23:53,066 - ERROR - AGENT:agent_airsoft_0faa9616 - Error processing document for grading ('## ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´ Ğ½Ğ° ÑƒÑ‚ 11

Ğ”Ğ»Ñ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ½ÑƒĞ¶Ğ½Ğ¾ Ñ€ĞµÑˆĞ¸Ñ‚ÑŒ Ğ±ÑƒĞ´ĞµĞ¼ Ğ» Ğ¼Ñ‹ Ğ¿ĞµÑ€ĞµĞ½Ğ¾ÑĞ¸Ñ‚ÑŒ ÑĞ²Ğ¾Ñ Ğ±Ğ¸Ğ·Ğ½ĞµÑ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ Ğ² Ğ½Ğ¾Ğ²ÑƒÑ 1Ñ, Ğ¸Ğ»...'): 1 validation error for Grade
  Invalid JSON: expected value at line 1 column 1 [type=json_invalid, input_value='yes', input_type=str]
    For further information visit https://errors.pydantic.dev/2.10/v/json_invalid
Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/agent_runner/langgraph/factory.py", line 420, in process_doc
    invocation_result = await chain.ainvoke({"question": current_question, "context": doc_content})
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3071, in ainvoke
    input = await asyncio.create_task(part(), context=context)  # type: ignore
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3780, in ainvoke
    results = await asyncio.gather(
              ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3770, in _ainvoke_step
    return await asyncio.create_task(  # type: ignore
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 5377, in ainvoke
    return await self.bound.ainvoke(
           ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 328, in ainvoke
    llm_result = await self.agenerate_prompt(
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 853, in agenerate_prompt
    return await self.agenerate(
           ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 813, in agenerate
    raise exceptions[0]
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 981, in _agenerate_with_cache
    result = await self._agenerate(
             ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_openai/chat_models/base.py", line 1094, in _agenerate
    response = await self.root_async_client.beta.chat.completions.parse(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/resources/beta/chat/completions.py", line 437, in parse
    return await self._post(
           ^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1767, in post
    return await self.request(cast_to, opts, stream=stream, stream_cls=stream_cls)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1461, in request
    return await self._request(
           ^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1564, in _request
    return await self._process_response(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1661, in _process_response
    return await api_response.parse()
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_response.py", line 432, in parse
    parsed = self._options.post_parser(parsed)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/resources/beta/chat/completions.py", line 431, in parser
    return _parse_chat_completion(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/lib/_parsing/_completions.py", line 110, in parse_chat_completion
    "parsed": maybe_parse_content(
              ^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/lib/_parsing/_completions.py", line 161, in maybe_parse_content
    return _parse_content(response_format, message.content)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/lib/_parsing/_completions.py", line 221, in _parse_content
    return cast(ResponseFormatT, model_parse_json(response_format, content))
                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_compat.py", line 169, in model_parse_json
    return model.model_validate_json(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/pydantic/main.py", line 656, in model_validate_json
    return cls.__pydantic_validator__.validate_json(json_data, strict=strict, context=context)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for Grade
  Invalid JSON: expected value at line 1 column 1 [type=json_invalid, input_value='yes', input_type=str]
    For further information visit https://errors.pydantic.dev/2.10/v/json_invalid
2025-05-30 22:23:53,066 - INFO - AGENT:agent_airsoft_0faa9616 - Found 0 relevant documents out of 1 initial (after split).
2025-05-30 22:23:53,067 - INFO - AGENT:agent_airsoft_0faa9616 - ---ASSESS GRADED DOCUMENTS---
2025-05-30 22:23:53,067 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO RELEVANT DOCUMENTS, REWRITE---
2025-05-30 22:23:53,068 - INFO - AGENT:agent_airsoft_0faa9616 - ---TRANSFORM QUERY (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:23:53,068 - INFO - AGENT:agent_airsoft_0faa9616 - Using KB-specific model configuration for rewrite. KB IDs: ['5', '6', '7']
2025-05-30 22:23:53,068 - INFO - AGENT:agent_airsoft_0faa9616 - Rewrite attempt 2/3 for question: 'Ğ¿Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹'
2025-05-30 22:23:53,068 - INFO - AGENT:agent_airsoft_0faa9616 - Rewriting original question: Ğ¿Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹
2025-05-30 22:23:53,069 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenRouter, model: mistralai/mistral-small-3.1-24b-instruct:free, temp: 0.0, streaming: False
2025-05-30 22:23:53,093 - INFO - AGENT:agent_airsoft_0faa9616 - Created rewrite LLM for KB ['5', '6', '7']: mistralai/mistral-small-3.1-24b-instruct:free via OpenRouter
2025-05-30 22:23:56,743 - INFO - httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:23:58,299 - INFO - AGENT:agent_airsoft_0faa9616 - Rewritten question: ĞĞ°Ğ¹Ğ´Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğµ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ², Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ñ… Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ğ¡:Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ»ĞµĞ¹ 11 (Ğ£Ğ¢11).
2025-05-30 22:23:58,299 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:11976 C:42 T:12018
2025-05-30 22:23:58,299 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for rewrite_llm: 12018 tokens recorded.
2025-05-30 22:23:58,300 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:23:58,300 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 22:23:58,328 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 22:23:58,331 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 5 tools.
2025-05-30 22:23:59,841 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:24:02,314 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ”Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ğ¡:Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ»ĞµĞ¹ 11 (Ğ£Ğ¢11) Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ Ğ¸Ğ¼ĞµÑ‚ÑŒ ÑˆÑ‚Ğ°Ñ‚ Ğ¸Ğ· 2-3 Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ². ĞŸÑ€Ğ¸
2025-05-30 22:24:02,314 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_38647f5e19'}
2025-05-30 22:24:02,314 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 7004, 'output_tokens': 154, 'total_tokens': 7158, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 22:24:02,314 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:7004 C:154 T:7158
2025-05-30 22:24:02,314 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 7158 tokens recorded.
2025-05-30 22:24:02,315 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 22:24:02,315 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 22:24:02,316 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ”Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ğ¡:Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ»ĞµĞ¹ 11 (Ğ£Ğ¢11) Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ Ğ¸Ğ¼ĞµÑ‚ÑŒ ÑˆÑ‚Ğ°Ñ‚ Ğ¸Ğ· 2-3 Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ². ĞŸÑ€Ğ¸...
2025-05-30 22:24:02,320 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 333db720-8948-48c7-88a0-81c3032f5710)
2025-05-30 22:24:02,320 - INFO - AGENT:agent_airsoft_0faa9616 - Found 5 token usage events for InteractionID: 333db720-8948-48c7-88a0-81c3032f5710.
2025-05-30 22:24:02,324 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Ğ”Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ğ¡:Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ»ĞµĞ¹ 11 (Ğ£Ğ¢11) Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ Ğ¸Ğ¼ĞµÑ‚ÑŒ ÑˆÑ‚Ğ°Ñ‚ Ğ¸Ğ· 2-3 Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ². ĞŸÑ€Ğ¸...
2025-05-30 22:24:02,324 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Ğ”Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° 1Ğ¡:Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ»ĞµĞ¹ 11 (Ğ£Ğ¢11) ...'
2025-05-30 22:24:02,325 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '333db720-8948-48c7-88a0-81c3032f5710', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 5314, 'completion_tokens': 36, 'total_tokens': 5350, 'timestamp': '2025-05-30T17:23:30.188681+00:00'}
2025-05-30 22:24:02,325 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 333db720-8948-48c7-88a0-81c3032f5710
2025-05-30 22:24:02,329 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 333db720-8948-48c7-88a0-81c3032f5710, db_id: 1050
2025-05-30 22:24:02,330 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1050 for interaction_id: 333db720-8948-48c7-88a0-81c3032f5710 on attempt 1
2025-05-30 22:24:02,336 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 333db720-8948-48c7-88a0-81c3032f5710, db_id: 540
2025-05-30 22:24:02,340 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '333db720-8948-48c7-88a0-81c3032f5710', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 7004, 'completion_tokens': 154, 'total_tokens': 7158, 'timestamp': '2025-05-30T17:24:02.314607+00:00'}
2025-05-30 22:24:02,340 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 333db720-8948-48c7-88a0-81c3032f5710
2025-05-30 22:24:02,342 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1050 for interaction_id: 333db720-8948-48c7-88a0-81c3032f5710 on attempt 1
2025-05-30 22:24:02,346 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 333db720-8948-48c7-88a0-81c3032f5710, db_id: 541
2025-05-30 22:24:02,351 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '333db720-8948-48c7-88a0-81c3032f5710', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'rewrite_llm', 'model_id': 'mistralai/mistral-small-3.1-24b-instruct:free', 'prompt_tokens': 11976, 'completion_tokens': 42, 'total_tokens': 12018, 'timestamp': '2025-05-30T17:23:58.299291+00:00'}
2025-05-30 22:24:02,351 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 333db720-8948-48c7-88a0-81c3032f5710
2025-05-30 22:24:02,354 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1050 for interaction_id: 333db720-8948-48c7-88a0-81c3032f5710 on attempt 1
2025-05-30 22:24:02,357 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 333db720-8948-48c7-88a0-81c3032f5710, db_id: 542
2025-05-30 22:24:02,359 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '333db720-8948-48c7-88a0-81c3032f5710', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 6156, 'completion_tokens': 42, 'total_tokens': 6198, 'timestamp': '2025-05-30T17:23:49.452145+00:00'}
2025-05-30 22:24:02,359 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 333db720-8948-48c7-88a0-81c3032f5710
2025-05-30 22:24:02,360 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1050 for interaction_id: 333db720-8948-48c7-88a0-81c3032f5710 on attempt 1
2025-05-30 22:24:02,362 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 333db720-8948-48c7-88a0-81c3032f5710, db_id: 543
2025-05-30 22:24:02,364 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '333db720-8948-48c7-88a0-81c3032f5710', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'rewrite_llm', 'model_id': 'mistralai/mistral-small-3.1-24b-instruct:free', 'prompt_tokens': 10556, 'completion_tokens': 42, 'total_tokens': 10598, 'timestamp': '2025-05-30T17:23:39.130764+00:00'}
2025-05-30 22:24:02,364 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 333db720-8948-48c7-88a0-81c3032f5710
2025-05-30 22:24:02,365 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1050 for interaction_id: 333db720-8948-48c7-88a0-81c3032f5710 on attempt 1
2025-05-30 22:24:02,367 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 333db720-8948-48c7-88a0-81c3032f5710, db_id: 544
2025-05-30 22:24:55,232 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-30 22:24:55,243 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-30 22:24:55,244 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-30 22:24:55,245 - INFO - app.db.crud.agent_crud - Updating agent config in DB for agent_id: agent_airsoft_0faa9616
2025-05-30 22:24:55,273 - INFO - app.db.crud.agent_crud - Agent config updated successfully for agent_id: agent_airsoft_0faa9616
2025-05-30 22:24:55,273 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616 was running. Attempting to restart it after config update.
2025-05-30 22:24:55,273 - INFO - app.services.process_manager - Restarting agent process for agent_airsoft_0faa9616...
2025-05-30 22:24:55,275 - INFO - app.services.process_manager - Stopping agent process agent_airsoft_0faa9616 (PID: 94997). Force: True
2025-05-30 22:24:55,275 - INFO - app.services.process_manager - SIGTERM sent to agent agent_airsoft_0faa9616 (PID: 94997)
2025-05-30 22:24:55,375 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 (PID: 94997) terminated gracefully after SIGTERM.
2025-05-30 22:24:55,378 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 marked as stopped in Redis.
2025-05-30 22:24:55,378 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 stopped (or stop attempted and assumed successful for restart). Pausing briefly...
2025-05-30 22:25:00,379 - INFO - app.services.process_manager - Proceeding to start agent agent_airsoft_0faa9616 after delay...
2025-05-30 22:25:00,382 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 22:25:00,383 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 95252
2025-05-30 22:25:00,383 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 95252
2025-05-30 22:25:00,384 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 successfully started as part of restart sequence.
2025-05-30 22:25:00,384 - INFO - app.api.routers.agent_api - Restart command issued for agent agent_airsoft_0faa9616 after config update.
2025-05-30 22:25:00,384 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:25:00,385 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 22:25:01,882 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 22:25:01,882 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 22:25:01,882 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 22:25:01,882 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 22:25:01,882 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 95252
2025-05-30 22:25:01,882 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 22:25:01,882 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 22:25:01,882 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 22:25:01,926 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 22:25:01,926 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 22:25:01,963 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 22:25:01,964 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 22:25:01,964 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 22:25:01,964 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 22:25:01,964 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 22:25:01,964 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 22:25:01,989 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 22:25:01,989 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 22:25:01,989 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 22:25:01,991 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET) wirh description: Ğ£Ğ·Ğ½Ğ°Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² (Ğ±Ğ±) Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.)
2025-05-30 22:25:01,991 - INFO - AGENT:agent_airsoft_0faa9616 - Added 3 tools from centralized registry
2025-05-30 22:25:01,991 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 22:25:02,049 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 22:25:02,054 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 22:25:04,123 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 22:25:04,126 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 22:25:04,126 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'airsoft' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7'] with description: Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ 1Ñ
2025-05-30 22:25:04,126 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 22:25:04,126 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'airsoft-rus.ru' (ID: webSearch-1748459212676) with description: ĞŸĞ¾Ğ¸ÑĞº Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ ÑÑ‚Ñ€Ğ°Ğ¹ĞºĞ±Ğ¾Ğ»Ñƒ Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼ Ğ´Ğ»Ñ ÑÑ‚Ñ€Ğ°Ğ¹ĞºĞ±Ğ¾Ğ»Ğ° Ğ½Ğ° ÑĞ°Ğ¹Ñ‚Ğµ.
2025-05-30 22:25:04,126 - INFO - AGENT:agent_airsoft_0faa9616 - Found 1 additional API request configurations
2025-05-30 22:25:04,126 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 5 (4 safe, 1 datastore).
2025-05-30 22:25:04,126 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 5 total, 4 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 22:25:04,126 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 22:25:04,128 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 22:25:04,129 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 22:25:04,129 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 22:25:04,129 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 22:25:04,129 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->agent
2025-05-30 22:25:04,129 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 22:25:04,129 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 22:25:04,139 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 22:25:04,139 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 22:25:04,139 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 22:25:04,139 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4513626496) setup complete. Starting run loop.
2025-05-30 22:25:04,139 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 22:25:04,139 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 22:25:04,139 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 22:25:04,139 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 22:25:04,142 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 22:26:25,569 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹, ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² ÑĞ¾Ğ²Ğµ...'
2025-05-30 22:26:25,572 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 22:26:25,581 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 22:26:25,581 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 22:26:25,581 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 22:26:25,583 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 710358f6-2330-47a4-8756-5ebe662337f2)
2025-05-30 22:26:25,583 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 22:26:25,584 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 22:26:25,584 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 22:26:25,595 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 710358f6-2330-47a4-8756-5ebe662337f2, db_id: 1051
2025-05-30 22:26:25,652 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:26:25,652 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 22:26:25,678 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 22:26:25,681 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 5 tools.
2025-05-30 22:26:26,582 - INFO - aiogram.event - Update id=804756367 is handled. Duration 1013 ms by bot id=1750613938
2025-05-30 22:26:26,861 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:26:27,094 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 22:26:27,094 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 22:26:27,094 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 371, 'output_tokens': 34, 'total_tokens': 405, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 22:26:27,094 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:371 C:34 T:405
2025-05-30 22:26:27,094 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 405 tokens recorded.
2025-05-30 22:26:27,095 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 22:26:27,095 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: knowledgeBase-1748440512419
2025-05-30 22:26:27,095 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO RETRIEVE (knowledgeBase-1748440512419)---
2025-05-30 22:26:27,610 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 22:26:27,628 - INFO - httpx - HTTP Request: POST http://127.0.0.1:6333/collections/platformai/points/query "HTTP/1.1 200 OK"
2025-05-30 22:26:27,631 - INFO - AGENT:agent_airsoft_0faa9616 - ---CHECK RELEVANCE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:26:27,631 - INFO - AGENT:agent_airsoft_0faa9616 - Grading documents for question: 'ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹, ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² ÑĞ¾Ğ²ĞµÑ‚ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ´Ğ° Ğ½Ğ° ÑƒÑ‚11?'
2025-05-30 22:26:27,631 - INFO - AGENT:agent_airsoft_0faa9616 - Using KB-specific model configuration for KB IDs: ['5', '6', '7']
2025-05-30 22:26:27,631 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenRouter, model: tngtech/deepseek-r1t-chimera:free, temp: 0.0, streaming: False
2025-05-30 22:26:27,656 - INFO - AGENT:agent_airsoft_0faa9616 - Created grading LLM for KB ['5', '6', '7']: tngtech/deepseek-r1t-chimera:free via OpenRouter
2025-05-30 22:26:31,564 - INFO - httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:26:31,677 - ERROR - AGENT:agent_airsoft_0faa9616 - Error processing document for grading ('## ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´ Ğ½Ğ° ÑƒÑ‚ 11

Ğ”Ğ»Ñ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ½ÑƒĞ¶Ğ½Ğ¾ Ñ€ĞµÑˆĞ¸Ñ‚ÑŒ Ğ±ÑƒĞ´ĞµĞ¼ Ğ» Ğ¼Ñ‹ Ğ¿ĞµÑ€ĞµĞ½Ğ¾ÑĞ¸Ñ‚ÑŒ ÑĞ²Ğ¾Ñ Ğ±Ğ¸Ğ·Ğ½ĞµÑ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ Ğ² Ğ½Ğ¾Ğ²ÑƒÑ 1Ñ, Ğ¸Ğ»...'): 1 validation error for Grade
  Invalid JSON: expected value at line 1 column 1 [type=json_invalid, input_value='yes\nyes', input_type=str]
    For further information visit https://errors.pydantic.dev/2.10/v/json_invalid
Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/agent_runner/langgraph/factory.py", line 420, in process_doc
    invocation_result = await chain.ainvoke({"question": current_question, "context": doc_content})
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3071, in ainvoke
    input = await asyncio.create_task(part(), context=context)  # type: ignore
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3780, in ainvoke
    results = await asyncio.gather(
              ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3770, in _ainvoke_step
    return await asyncio.create_task(  # type: ignore
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 5377, in ainvoke
    return await self.bound.ainvoke(
           ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 328, in ainvoke
    llm_result = await self.agenerate_prompt(
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 853, in agenerate_prompt
    return await self.agenerate(
           ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 813, in agenerate
    raise exceptions[0]
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 981, in _agenerate_with_cache
    result = await self._agenerate(
             ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_openai/chat_models/base.py", line 1094, in _agenerate
    response = await self.root_async_client.beta.chat.completions.parse(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/resources/beta/chat/completions.py", line 437, in parse
    return await self._post(
           ^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1767, in post
    return await self.request(cast_to, opts, stream=stream, stream_cls=stream_cls)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1461, in request
    return await self._request(
           ^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1564, in _request
    return await self._process_response(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1661, in _process_response
    return await api_response.parse()
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_response.py", line 432, in parse
    parsed = self._options.post_parser(parsed)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/resources/beta/chat/completions.py", line 431, in parser
    return _parse_chat_completion(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/lib/_parsing/_completions.py", line 110, in parse_chat_completion
    "parsed": maybe_parse_content(
              ^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/lib/_parsing/_completions.py", line 161, in maybe_parse_content
    return _parse_content(response_format, message.content)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/lib/_parsing/_completions.py", line 221, in _parse_content
    return cast(ResponseFormatT, model_parse_json(response_format, content))
                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_compat.py", line 169, in model_parse_json
    return model.model_validate_json(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/pydantic/main.py", line 656, in model_validate_json
    return cls.__pydantic_validator__.validate_json(json_data, strict=strict, context=context)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for Grade
  Invalid JSON: expected value at line 1 column 1 [type=json_invalid, input_value='yes\nyes', input_type=str]
    For further information visit https://errors.pydantic.dev/2.10/v/json_invalid
2025-05-30 22:26:31,678 - INFO - AGENT:agent_airsoft_0faa9616 - Found 0 relevant documents out of 1 initial (after split).
2025-05-30 22:26:31,679 - INFO - AGENT:agent_airsoft_0faa9616 - ---ASSESS GRADED DOCUMENTS---
2025-05-30 22:26:31,679 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO RELEVANT DOCUMENTS, REWRITE---
2025-05-30 22:26:31,679 - INFO - AGENT:agent_airsoft_0faa9616 - ---TRANSFORM QUERY (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:26:31,679 - INFO - AGENT:agent_airsoft_0faa9616 - Using KB-specific model configuration for rewrite. KB IDs: ['5', '6', '7']
2025-05-30 22:26:31,680 - INFO - AGENT:agent_airsoft_0faa9616 - Rewrite attempt 1/3 for question: 'ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹, ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² ÑĞ¾Ğ²ĞµÑ‚ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ´Ğ° Ğ½Ğ° ÑƒÑ‚11?'
2025-05-30 22:26:31,680 - INFO - AGENT:agent_airsoft_0faa9616 - Rewriting original question: ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹, ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² ÑĞ¾Ğ²ĞµÑ‚ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ´Ğ° Ğ½Ğ° ÑƒÑ‚11?
2025-05-30 22:26:31,680 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenRouter, model: tngtech/deepseek-r1t-chimera:free, temp: 0.0, streaming: False
2025-05-30 22:26:31,706 - INFO - AGENT:agent_airsoft_0faa9616 - Created rewrite LLM for KB ['5', '6', '7']: tngtech/deepseek-r1t-chimera:free via OpenRouter
2025-05-30 22:26:34,029 - INFO - httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:26:34,648 - INFO - AGENT:agent_airsoft_0faa9616 - Rewritten question: Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° Ğ£Ğ¢11 ÑĞ¾Ğ³Ğ»Ğ°ÑĞ½Ğ¾ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹?
Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° Ğ£Ğ¢11 ÑĞ¾Ğ³Ğ»Ğ°ÑĞ½Ğ¾ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹?
2025-05-30 22:26:34,648 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1413 C:41 T:1454
2025-05-30 22:26:34,648 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for rewrite_llm: 1454 tokens recorded.
2025-05-30 22:26:34,649 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:26:34,650 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 22:26:34,674 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 22:26:34,676 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 5 tools.
2025-05-30 22:26:37,101 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:26:37,380 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 22:26:37,380 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 22:26:37,380 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1213, 'output_tokens': 34, 'total_tokens': 1247, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 22:26:37,380 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1213 C:34 T:1247
2025-05-30 22:26:37,380 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1247 tokens recorded.
2025-05-30 22:26:37,381 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 22:26:37,381 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: knowledgeBase-1748440512419
2025-05-30 22:26:37,381 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO RETRIEVE (knowledgeBase-1748440512419)---
2025-05-30 22:26:37,921 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 22:26:37,934 - INFO - httpx - HTTP Request: POST http://127.0.0.1:6333/collections/platformai/points/query "HTTP/1.1 200 OK"
2025-05-30 22:26:37,936 - INFO - AGENT:agent_airsoft_0faa9616 - ---CHECK RELEVANCE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:26:37,936 - INFO - AGENT:agent_airsoft_0faa9616 - Grading documents for question: 'Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° Ğ£Ğ¢11 ÑĞ¾Ğ³Ğ»Ğ°ÑĞ½Ğ¾ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹?
Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° Ğ£Ğ¢11 ÑĞ¾Ğ³Ğ»Ğ°ÑĞ½Ğ¾ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹?'
2025-05-30 22:26:37,936 - INFO - AGENT:agent_airsoft_0faa9616 - Using KB-specific model configuration for KB IDs: ['5', '6', '7']
2025-05-30 22:26:37,936 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenRouter, model: tngtech/deepseek-r1t-chimera:free, temp: 0.0, streaming: False
2025-05-30 22:26:37,961 - INFO - AGENT:agent_airsoft_0faa9616 - Created grading LLM for KB ['5', '6', '7']: tngtech/deepseek-r1t-chimera:free via OpenRouter
2025-05-30 22:26:40,106 - INFO - httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:26:43,308 - ERROR - AGENT:agent_airsoft_0faa9616 - Error processing document for grading ('# **8) Ğ’ÑÑĞºĞ¾Ğµ**

8.1) Ğ’ÑÑĞºĞ¸Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ¸ Ğ¼ĞµÑ…Ğ°Ğ½Ğ¸Ğ·Ğ¼Ñ‹ ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¿ĞµÑ€ĞµĞ¿Ğ¸ÑÑ‹Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ´ Ğ½Ğ¾Ğ²ÑƒÑ 1Ñ. Ğ¢Ñƒ...'): 1 validation error for Grade
  Invalid JSON: expected value at line 1 column 1 [type=json_invalid, input_value='Okay, let\'s see. The us...ument is relevant.\nyes', input_type=str]
    For further information visit https://errors.pydantic.dev/2.10/v/json_invalid
Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/agent_runner/langgraph/factory.py", line 420, in process_doc
    invocation_result = await chain.ainvoke({"question": current_question, "context": doc_content})
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3071, in ainvoke
    input = await asyncio.create_task(part(), context=context)  # type: ignore
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3780, in ainvoke
    results = await asyncio.gather(
              ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3770, in _ainvoke_step
    return await asyncio.create_task(  # type: ignore
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 5377, in ainvoke
    return await self.bound.ainvoke(
           ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 328, in ainvoke
    llm_result = await self.agenerate_prompt(
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 853, in agenerate_prompt
    return await self.agenerate(
           ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 813, in agenerate
    raise exceptions[0]
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 981, in _agenerate_with_cache
    result = await self._agenerate(
             ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_openai/chat_models/base.py", line 1094, in _agenerate
    response = await self.root_async_client.beta.chat.completions.parse(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/resources/beta/chat/completions.py", line 437, in parse
    return await self._post(
           ^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1767, in post
    return await self.request(cast_to, opts, stream=stream, stream_cls=stream_cls)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1461, in request
    return await self._request(
           ^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1564, in _request
    return await self._process_response(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1661, in _process_response
    return await api_response.parse()
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_response.py", line 432, in parse
    parsed = self._options.post_parser(parsed)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/resources/beta/chat/completions.py", line 431, in parser
    return _parse_chat_completion(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/lib/_parsing/_completions.py", line 110, in parse_chat_completion
    "parsed": maybe_parse_content(
              ^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/lib/_parsing/_completions.py", line 161, in maybe_parse_content
    return _parse_content(response_format, message.content)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/lib/_parsing/_completions.py", line 221, in _parse_content
    return cast(ResponseFormatT, model_parse_json(response_format, content))
                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_compat.py", line 169, in model_parse_json
    return model.model_validate_json(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/pydantic/main.py", line 656, in model_validate_json
    return cls.__pydantic_validator__.validate_json(json_data, strict=strict, context=context)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for Grade
  Invalid JSON: expected value at line 1 column 1 [type=json_invalid, input_value='Okay, let\'s see. The us...ument is relevant.\nyes', input_type=str]
    For further information visit https://errors.pydantic.dev/2.10/v/json_invalid
2025-05-30 22:26:43,309 - INFO - AGENT:agent_airsoft_0faa9616 - Found 0 relevant documents out of 1 initial (after split).
2025-05-30 22:26:43,310 - INFO - AGENT:agent_airsoft_0faa9616 - ---ASSESS GRADED DOCUMENTS---
2025-05-30 22:26:43,310 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO RELEVANT DOCUMENTS, REWRITE---
2025-05-30 22:26:43,310 - INFO - AGENT:agent_airsoft_0faa9616 - ---TRANSFORM QUERY (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:26:43,310 - INFO - AGENT:agent_airsoft_0faa9616 - Using KB-specific model configuration for rewrite. KB IDs: ['5', '6', '7']
2025-05-30 22:26:43,311 - INFO - AGENT:agent_airsoft_0faa9616 - Rewrite attempt 2/3 for question: 'ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹, ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² ÑĞ¾Ğ²ĞµÑ‚ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ´Ğ° Ğ½Ğ° ÑƒÑ‚11?'
2025-05-30 22:26:43,311 - INFO - AGENT:agent_airsoft_0faa9616 - Rewriting original question: ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹, ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² ÑĞ¾Ğ²ĞµÑ‚ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ´Ğ° Ğ½Ğ° ÑƒÑ‚11?
2025-05-30 22:26:43,311 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenRouter, model: tngtech/deepseek-r1t-chimera:free, temp: 0.0, streaming: False
2025-05-30 22:26:43,335 - INFO - AGENT:agent_airsoft_0faa9616 - Created rewrite LLM for KB ['5', '6', '7']: tngtech/deepseek-r1t-chimera:free via OpenRouter
2025-05-30 22:26:45,700 - INFO - httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:26:46,300 - INFO - AGENT:agent_airsoft_0faa9616 - Rewritten question: Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° Ğ£Ğ¢11 ÑĞ¾Ğ³Ğ»Ğ°ÑĞ½Ğ¾ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹, Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ Ğ²ĞµĞ´ÑƒÑ‰ĞµĞ³Ğ¾ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ° Ğ¸ Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… ĞºĞ¾Ğ½ÑÑƒĞ»ÑŒÑ‚Ğ°Ğ½Ñ‚Ğ¾Ğ²?
2025-05-30 22:26:46,300 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:2777 C:34 T:2811
2025-05-30 22:26:46,300 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for rewrite_llm: 2811 tokens recorded.
2025-05-30 22:26:46,301 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:26:46,301 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 22:26:46,325 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 22:26:46,327 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 5 tools.
2025-05-30 22:26:47,546 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:26:48,124 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 22:26:48,124 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 22:26:48,124 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 2048, 'output_tokens': 45, 'total_tokens': 2093, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 22:26:48,124 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:2048 C:45 T:2093
2025-05-30 22:26:48,124 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 2093 tokens recorded.
2025-05-30 22:26:48,125 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 22:26:48,125 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: knowledgeBase-1748440512419
2025-05-30 22:26:48,125 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO RETRIEVE (knowledgeBase-1748440512419)---
2025-05-30 22:26:48,787 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 22:26:48,800 - INFO - httpx - HTTP Request: POST http://127.0.0.1:6333/collections/platformai/points/query "HTTP/1.1 200 OK"
2025-05-30 22:26:48,802 - INFO - AGENT:agent_airsoft_0faa9616 - ---CHECK RELEVANCE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:26:48,802 - INFO - AGENT:agent_airsoft_0faa9616 - Grading documents for question: 'Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° Ğ£Ğ¢11 ÑĞ¾Ğ³Ğ»Ğ°ÑĞ½Ğ¾ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹, Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ Ğ²ĞµĞ´ÑƒÑ‰ĞµĞ³Ğ¾ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ° Ğ¸ Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… ĞºĞ¾Ğ½ÑÑƒĞ»ÑŒÑ‚Ğ°Ğ½Ñ‚Ğ¾Ğ²?'
2025-05-30 22:26:48,802 - INFO - AGENT:agent_airsoft_0faa9616 - Using KB-specific model configuration for KB IDs: ['5', '6', '7']
2025-05-30 22:26:48,802 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenRouter, model: tngtech/deepseek-r1t-chimera:free, temp: 0.0, streaming: False
2025-05-30 22:26:48,826 - INFO - AGENT:agent_airsoft_0faa9616 - Created grading LLM for KB ['5', '6', '7']: tngtech/deepseek-r1t-chimera:free via OpenRouter
2025-05-30 22:26:50,926 - INFO - httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:26:56,764 - ERROR - AGENT:agent_airsoft_0faa9616 - Error processing document for grading ('ĞšĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ° Ğ²ĞµĞ´ĞµĞ½Ğ¸Ñ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ¸ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ²Ğ¾Ğ´Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ´ Ñ€ĞµĞ²ÑŒÑ Ğ¸ ÑĞ»ĞµĞ´Ğ¸Ñ‚ÑŒ Ğ·Ğ° ÑÑ‚Ğ¸Ğ¼ ...'): 1 validation error for Grade
  Invalid JSON: expected value at line 1 column 1 [type=json_invalid, input_value='Okay, let\'s see. The us...The answer is yes.\nyes', input_type=str]
    For further information visit https://errors.pydantic.dev/2.10/v/json_invalid
Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/agent_runner/langgraph/factory.py", line 420, in process_doc
    invocation_result = await chain.ainvoke({"question": current_question, "context": doc_content})
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3071, in ainvoke
    input = await asyncio.create_task(part(), context=context)  # type: ignore
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3780, in ainvoke
    results = await asyncio.gather(
              ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 3770, in _ainvoke_step
    return await asyncio.create_task(  # type: ignore
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/runnables/base.py", line 5377, in ainvoke
    return await self.bound.ainvoke(
           ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 328, in ainvoke
    llm_result = await self.agenerate_prompt(
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 853, in agenerate_prompt
    return await self.agenerate(
           ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 813, in agenerate
    raise exceptions[0]
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_core/language_models/chat_models.py", line 981, in _agenerate_with_cache
    result = await self._agenerate(
             ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langchain_openai/chat_models/base.py", line 1094, in _agenerate
    response = await self.root_async_client.beta.chat.completions.parse(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/resources/beta/chat/completions.py", line 437, in parse
    return await self._post(
           ^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1767, in post
    return await self.request(cast_to, opts, stream=stream, stream_cls=stream_cls)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1461, in request
    return await self._request(
           ^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1564, in _request
    return await self._process_response(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_base_client.py", line 1661, in _process_response
    return await api_response.parse()
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_response.py", line 432, in parse
    parsed = self._options.post_parser(parsed)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/resources/beta/chat/completions.py", line 431, in parser
    return _parse_chat_completion(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/lib/_parsing/_completions.py", line 110, in parse_chat_completion
    "parsed": maybe_parse_content(
              ^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/lib/_parsing/_completions.py", line 161, in maybe_parse_content
    return _parse_content(response_format, message.content)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/lib/_parsing/_completions.py", line 221, in _parse_content
    return cast(ResponseFormatT, model_parse_json(response_format, content))
                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/openai/_compat.py", line 169, in model_parse_json
    return model.model_validate_json(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/pydantic/main.py", line 656, in model_validate_json
    return cls.__pydantic_validator__.validate_json(json_data, strict=strict, context=context)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
pydantic_core._pydantic_core.ValidationError: 1 validation error for Grade
  Invalid JSON: expected value at line 1 column 1 [type=json_invalid, input_value='Okay, let\'s see. The us...The answer is yes.\nyes', input_type=str]
    For further information visit https://errors.pydantic.dev/2.10/v/json_invalid
2025-05-30 22:26:56,765 - INFO - AGENT:agent_airsoft_0faa9616 - Found 0 relevant documents out of 1 initial (after split).
2025-05-30 22:26:56,766 - INFO - AGENT:agent_airsoft_0faa9616 - ---ASSESS GRADED DOCUMENTS---
2025-05-30 22:26:56,766 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO RELEVANT DOCUMENTS, REWRITE---
2025-05-30 22:26:56,767 - INFO - AGENT:agent_airsoft_0faa9616 - ---TRANSFORM QUERY (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:26:56,767 - INFO - AGENT:agent_airsoft_0faa9616 - Using KB-specific model configuration for rewrite. KB IDs: ['5', '6', '7']
2025-05-30 22:26:56,767 - INFO - AGENT:agent_airsoft_0faa9616 - Rewrite attempt 3/3 for question: 'ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹, ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² ÑĞ¾Ğ²ĞµÑ‚ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ´Ğ° Ğ½Ğ° ÑƒÑ‚11?'
2025-05-30 22:26:56,767 - INFO - AGENT:agent_airsoft_0faa9616 - Rewriting original question: ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹, ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² ÑĞ¾Ğ²ĞµÑ‚ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ´Ğ° Ğ½Ğ° ÑƒÑ‚11?
2025-05-30 22:26:56,767 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenRouter, model: tngtech/deepseek-r1t-chimera:free, temp: 0.0, streaming: False
2025-05-30 22:26:56,794 - INFO - AGENT:agent_airsoft_0faa9616 - Created rewrite LLM for KB ['5', '6', '7']: tngtech/deepseek-r1t-chimera:free via OpenRouter
2025-05-30 22:26:59,590 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 22:26:59,597 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 22:27:00,190 - INFO - httpx - HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:27:00,748 - INFO - AGENT:agent_airsoft_0faa9616 - Rewritten question: Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° Ğ£Ğ¢11, Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ Ğ²ĞµĞ´ÑƒÑ‰ĞµĞ³Ğ¾ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ° Ğ¸ Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… ĞºĞ¾Ğ½ÑÑƒĞ»ÑŒÑ‚Ğ°Ğ½Ñ‚Ğ¾Ğ², ÑĞ¾Ğ³Ğ»Ğ°ÑĞ½Ğ¾ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹?
2025-05-30 22:27:00,749 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:4148 C:35 T:4183
2025-05-30 22:27:00,749 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for rewrite_llm: 4183 tokens recorded.
2025-05-30 22:27:00,750 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:27:00,751 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 22:27:00,776 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 22:27:00,779 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 5 tools.
2025-05-30 22:27:01,842 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:27:03,919 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ¡Ğ¾Ğ³Ğ»Ğ°ÑĞ½Ğ¾ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹, Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° Ğ£Ğ¢11 Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¹ ÑˆÑ‚Ğ°Ñ‚:

- 2-3 Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ°;
- 1 Ğ²Ğµ
2025-05-30 22:27:03,919 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 22:27:03,919 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 2895, 'output_tokens': 134, 'total_tokens': 3029, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 22:27:03,919 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:2895 C:134 T:3029
2025-05-30 22:27:03,919 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 3029 tokens recorded.
2025-05-30 22:27:03,920 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 22:27:03,920 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 22:27:03,921 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ¡Ğ¾Ğ³Ğ»Ğ°ÑĞ½Ğ¾ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹, Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° Ğ£Ğ¢11 Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¹ ÑˆÑ‚Ğ°Ñ‚:

- 2-3 Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ°;
- 1 Ğ²Ğµ...
2025-05-30 22:27:03,924 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 710358f6-2330-47a4-8756-5ebe662337f2)
2025-05-30 22:27:03,925 - INFO - AGENT:agent_airsoft_0faa9616 - Found 7 token usage events for InteractionID: 710358f6-2330-47a4-8756-5ebe662337f2.
2025-05-30 22:27:03,929 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '710358f6-2330-47a4-8756-5ebe662337f2', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 371, 'completion_tokens': 34, 'total_tokens': 405, 'timestamp': '2025-05-30T17:26:27.094418+00:00'}
2025-05-30 22:27:03,929 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 710358f6-2330-47a4-8756-5ebe662337f2
2025-05-30 22:27:03,930 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Ğ¡Ğ¾Ğ³Ğ»Ğ°ÑĞ½Ğ¾ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹, Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° Ğ£Ğ¢11 Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¹ ÑˆÑ‚Ğ°Ñ‚:

- 2-3 Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ°;
- 1 Ğ²Ğµ...
2025-05-30 22:27:03,930 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Ğ¡Ğ¾Ğ³Ğ»Ğ°ÑĞ½Ğ¾ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹, Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° Ğ£Ğ¢11 Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½...'
2025-05-30 22:27:03,932 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1051 for interaction_id: 710358f6-2330-47a4-8756-5ebe662337f2 on attempt 1
2025-05-30 22:27:03,935 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 710358f6-2330-47a4-8756-5ebe662337f2, db_id: 1052
2025-05-30 22:27:03,940 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 710358f6-2330-47a4-8756-5ebe662337f2, db_id: 545
2025-05-30 22:27:03,944 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '710358f6-2330-47a4-8756-5ebe662337f2', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 2895, 'completion_tokens': 134, 'total_tokens': 3029, 'timestamp': '2025-05-30T17:27:03.919797+00:00'}
2025-05-30 22:27:03,944 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 710358f6-2330-47a4-8756-5ebe662337f2
2025-05-30 22:27:03,946 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1052 for interaction_id: 710358f6-2330-47a4-8756-5ebe662337f2 on attempt 1
2025-05-30 22:27:03,949 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 710358f6-2330-47a4-8756-5ebe662337f2, db_id: 546
2025-05-30 22:27:03,952 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '710358f6-2330-47a4-8756-5ebe662337f2', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'rewrite_llm', 'model_id': 'tngtech/deepseek-r1t-chimera:free', 'prompt_tokens': 4148, 'completion_tokens': 35, 'total_tokens': 4183, 'timestamp': '2025-05-30T17:27:00.749093+00:00'}
2025-05-30 22:27:03,952 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 710358f6-2330-47a4-8756-5ebe662337f2
2025-05-30 22:27:03,953 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1052 for interaction_id: 710358f6-2330-47a4-8756-5ebe662337f2 on attempt 1
2025-05-30 22:27:03,956 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 710358f6-2330-47a4-8756-5ebe662337f2, db_id: 547
2025-05-30 22:27:03,959 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '710358f6-2330-47a4-8756-5ebe662337f2', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 2048, 'completion_tokens': 45, 'total_tokens': 2093, 'timestamp': '2025-05-30T17:26:48.124924+00:00'}
2025-05-30 22:27:03,959 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 710358f6-2330-47a4-8756-5ebe662337f2
2025-05-30 22:27:03,959 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1052 for interaction_id: 710358f6-2330-47a4-8756-5ebe662337f2 on attempt 1
2025-05-30 22:27:03,962 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 710358f6-2330-47a4-8756-5ebe662337f2, db_id: 548
2025-05-30 22:27:03,964 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '710358f6-2330-47a4-8756-5ebe662337f2', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'rewrite_llm', 'model_id': 'tngtech/deepseek-r1t-chimera:free', 'prompt_tokens': 2777, 'completion_tokens': 34, 'total_tokens': 2811, 'timestamp': '2025-05-30T17:26:46.300156+00:00'}
2025-05-30 22:27:03,964 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 710358f6-2330-47a4-8756-5ebe662337f2
2025-05-30 22:27:03,965 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1052 for interaction_id: 710358f6-2330-47a4-8756-5ebe662337f2 on attempt 1
2025-05-30 22:27:03,967 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 710358f6-2330-47a4-8756-5ebe662337f2, db_id: 549
2025-05-30 22:27:03,969 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '710358f6-2330-47a4-8756-5ebe662337f2', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1213, 'completion_tokens': 34, 'total_tokens': 1247, 'timestamp': '2025-05-30T17:26:37.380978+00:00'}
2025-05-30 22:27:03,969 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 710358f6-2330-47a4-8756-5ebe662337f2
2025-05-30 22:27:03,970 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1052 for interaction_id: 710358f6-2330-47a4-8756-5ebe662337f2 on attempt 1
2025-05-30 22:27:03,972 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 710358f6-2330-47a4-8756-5ebe662337f2, db_id: 550
2025-05-30 22:27:03,974 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '710358f6-2330-47a4-8756-5ebe662337f2', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'rewrite_llm', 'model_id': 'tngtech/deepseek-r1t-chimera:free', 'prompt_tokens': 1413, 'completion_tokens': 41, 'total_tokens': 1454, 'timestamp': '2025-05-30T17:26:34.648919+00:00'}
2025-05-30 22:27:03,974 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 710358f6-2330-47a4-8756-5ebe662337f2
2025-05-30 22:27:03,975 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1052 for interaction_id: 710358f6-2330-47a4-8756-5ebe662337f2 on attempt 1
2025-05-30 22:27:03,977 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 710358f6-2330-47a4-8756-5ebe662337f2, db_id: 551
2025-05-30 22:27:14,797 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-30 22:27:14,805 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-30 22:27:14,805 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-30 22:27:14,805 - INFO - app.db.crud.agent_crud - Updating agent config in DB for agent_id: agent_airsoft_0faa9616
2025-05-30 22:27:14,817 - INFO - app.db.crud.agent_crud - Agent config updated successfully for agent_id: agent_airsoft_0faa9616
2025-05-30 22:27:14,817 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616 was running. Attempting to restart it after config update.
2025-05-30 22:27:14,817 - INFO - app.services.process_manager - Restarting agent process for agent_airsoft_0faa9616...
2025-05-30 22:27:14,822 - INFO - app.services.process_manager - Stopping agent process agent_airsoft_0faa9616 (PID: 95252). Force: True
2025-05-30 22:27:14,822 - INFO - app.services.process_manager - SIGTERM sent to agent agent_airsoft_0faa9616 (PID: 95252)
2025-05-30 22:27:14,924 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 (PID: 95252) terminated gracefully after SIGTERM.
2025-05-30 22:27:14,926 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 marked as stopped in Redis.
2025-05-30 22:27:14,926 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 stopped (or stop attempted and assumed successful for restart). Pausing briefly...
2025-05-30 22:27:19,927 - INFO - app.services.process_manager - Proceeding to start agent agent_airsoft_0faa9616 after delay...
2025-05-30 22:27:19,930 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 22:27:19,931 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 95319
2025-05-30 22:27:19,931 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 95319
2025-05-30 22:27:19,932 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 successfully started as part of restart sequence.
2025-05-30 22:27:19,932 - INFO - app.api.routers.agent_api - Restart command issued for agent agent_airsoft_0faa9616 after config update.
2025-05-30 22:27:19,932 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 22:27:19,932 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 22:27:21,313 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 22:27:21,314 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 22:27:21,314 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 22:27:21,314 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 22:27:21,314 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 95319
2025-05-30 22:27:21,314 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 22:27:21,314 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 22:27:21,314 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 22:27:21,358 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 22:27:21,358 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 22:27:21,400 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 22:27:21,400 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 22:27:21,400 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 22:27:21,400 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 22:27:21,400 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 22:27:21,400 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 22:27:21,425 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 22:27:21,426 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 22:27:21,426 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 22:27:21,427 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET) wirh description: Ğ£Ğ·Ğ½Ğ°Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² (Ğ±Ğ±) Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.)
2025-05-30 22:27:21,427 - INFO - AGENT:agent_airsoft_0faa9616 - Added 3 tools from centralized registry
2025-05-30 22:27:21,427 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 22:27:21,481 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 22:27:21,485 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 22:27:22,113 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 22:27:22,115 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 22:27:22,116 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'airsoft' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7'] with description: Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ 1Ñ
2025-05-30 22:27:22,116 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 22:27:22,116 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'airsoft-rus.ru' (ID: webSearch-1748459212676) with description: ĞŸĞ¾Ğ¸ÑĞº Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ ÑÑ‚Ñ€Ğ°Ğ¹ĞºĞ±Ğ¾Ğ»Ñƒ Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼ Ğ´Ğ»Ñ ÑÑ‚Ñ€Ğ°Ğ¹ĞºĞ±Ğ¾Ğ»Ğ° Ğ½Ğ° ÑĞ°Ğ¹Ñ‚Ğµ.
2025-05-30 22:27:22,116 - INFO - AGENT:agent_airsoft_0faa9616 - Found 1 additional API request configurations
2025-05-30 22:27:22,116 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 5 (4 safe, 1 datastore).
2025-05-30 22:27:22,116 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 5 total, 4 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 22:27:22,116 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 22:27:22,118 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 22:27:22,118 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 22:27:22,118 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 22:27:22,118 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 22:27:22,118 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->agent
2025-05-30 22:27:22,119 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 22:27:22,119 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 22:27:22,129 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 22:27:22,129 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 22:27:22,129 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 22:27:22,129 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4643977216) setup complete. Starting run loop.
2025-05-30 22:27:22,129 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 22:27:22,130 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 22:27:22,130 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 22:27:22,130 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 22:27:22,131 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 22:27:32,594 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹, ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² ÑĞ¾Ğ²Ğµ...'
2025-05-30 22:27:32,596 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 22:27:32,606 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 22:27:32,606 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 22:27:32,606 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 22:27:32,607 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 6a1c72fb-0158-497d-aca2-3cc0caf404c6)
2025-05-30 22:27:32,607 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 22:27:32,607 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 22:27:32,607 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 22:27:32,615 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 6a1c72fb-0158-497d-aca2-3cc0caf404c6, db_id: 1053
2025-05-30 22:27:32,681 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:27:32,682 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 22:27:32,707 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 22:27:32,710 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 5 tools.
2025-05-30 22:27:33,606 - INFO - aiogram.event - Update id=804756368 is handled. Duration 1012 ms by bot id=1750613938
2025-05-30 22:27:34,138 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:27:34,379 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 22:27:34,379 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 22:27:34,379 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 371, 'output_tokens': 34, 'total_tokens': 405, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 22:27:34,379 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:371 C:34 T:405
2025-05-30 22:27:34,379 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 405 tokens recorded.
2025-05-30 22:27:34,380 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 22:27:34,380 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: knowledgeBase-1748440512419
2025-05-30 22:27:34,380 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO RETRIEVE (knowledgeBase-1748440512419)---
2025-05-30 22:27:34,957 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 22:27:34,972 - INFO - httpx - HTTP Request: POST http://127.0.0.1:6333/collections/platformai/points/query "HTTP/1.1 200 OK"
2025-05-30 22:27:34,975 - INFO - AGENT:agent_airsoft_0faa9616 - ---CHECK RELEVANCE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:27:34,975 - INFO - AGENT:agent_airsoft_0faa9616 - Grading documents for question: 'ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹, ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² ÑĞ¾Ğ²ĞµÑ‚ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ´Ğ° Ğ½Ğ° ÑƒÑ‚11?'
2025-05-30 22:27:34,975 - INFO - AGENT:agent_airsoft_0faa9616 - Using KB-specific model configuration for KB IDs: ['5', '6', '7']
2025-05-30 22:27:34,975 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-nano, temp: 0.0, streaming: False
2025-05-30 22:27:35,000 - INFO - AGENT:agent_airsoft_0faa9616 - Created grading LLM for KB ['5', '6', '7']: gpt-4.1-nano via OpenAI
2025-05-30 22:27:35,740 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:27:35,752 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:936 C:6 T:942
2025-05-30 22:27:35,753 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for grading_llm: 942 tokens recorded.
2025-05-30 22:27:35,753 - INFO - AGENT:agent_airsoft_0faa9616 - Total token usage for grading_llm batch: 942 tokens.
2025-05-30 22:27:35,753 - INFO - AGENT:agent_airsoft_0faa9616 - Found 0 relevant documents out of 1 initial (after split).
2025-05-30 22:27:35,753 - INFO - AGENT:agent_airsoft_0faa9616 - ---ASSESS GRADED DOCUMENTS---
2025-05-30 22:27:35,753 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO RELEVANT DOCUMENTS, REWRITE---
2025-05-30 22:27:35,754 - INFO - AGENT:agent_airsoft_0faa9616 - ---TRANSFORM QUERY (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:27:35,754 - INFO - AGENT:agent_airsoft_0faa9616 - Using KB-specific model configuration for rewrite. KB IDs: ['5', '6', '7']
2025-05-30 22:27:35,754 - INFO - AGENT:agent_airsoft_0faa9616 - Rewrite attempt 1/3 for question: 'ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹, ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² ÑĞ¾Ğ²ĞµÑ‚ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ´Ğ° Ğ½Ğ° ÑƒÑ‚11?'
2025-05-30 22:27:35,754 - INFO - AGENT:agent_airsoft_0faa9616 - Rewriting original question: ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹, ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² ÑĞ¾Ğ²ĞµÑ‚ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ´Ğ° Ğ½Ğ° ÑƒÑ‚11?
2025-05-30 22:27:35,754 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-nano, temp: 0.0, streaming: False
2025-05-30 22:27:35,779 - INFO - AGENT:agent_airsoft_0faa9616 - Created rewrite LLM for KB ['5', '6', '7']: gpt-4.1-nano via OpenAI
2025-05-30 22:27:37,519 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:27:37,520 - INFO - AGENT:agent_airsoft_0faa9616 - Rewritten question: Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° Ğ£Ğ¢11 ÑĞ¾Ğ³Ğ»Ğ°ÑĞ½Ğ¾ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹?
2025-05-30 22:27:37,521 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1297 C:18 T:1315
2025-05-30 22:27:37,521 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for rewrite_llm: 1315 tokens recorded.
2025-05-30 22:27:37,522 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:27:37,522 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 22:27:37,546 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 22:27:37,550 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 5 tools.
2025-05-30 22:27:39,053 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:27:39,124 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 22:27:39,124 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 22:27:39,124 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1195, 'output_tokens': 36, 'total_tokens': 1231, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 22:27:39,124 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1195 C:36 T:1231
2025-05-30 22:27:39,124 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1231 tokens recorded.
2025-05-30 22:27:39,125 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 22:27:39,125 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: knowledgeBase-1748440512419
2025-05-30 22:27:39,125 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO RETRIEVE (knowledgeBase-1748440512419)---
2025-05-30 22:27:39,575 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 22:27:39,586 - INFO - httpx - HTTP Request: POST http://127.0.0.1:6333/collections/platformai/points/query "HTTP/1.1 200 OK"
2025-05-30 22:27:39,588 - INFO - AGENT:agent_airsoft_0faa9616 - ---CHECK RELEVANCE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:27:39,589 - INFO - AGENT:agent_airsoft_0faa9616 - Grading documents for question: 'Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° Ğ£Ğ¢11 ÑĞ¾Ğ³Ğ»Ğ°ÑĞ½Ğ¾ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹?'
2025-05-30 22:27:39,589 - INFO - AGENT:agent_airsoft_0faa9616 - Using KB-specific model configuration for KB IDs: ['5', '6', '7']
2025-05-30 22:27:39,589 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-nano, temp: 0.0, streaming: False
2025-05-30 22:27:39,613 - INFO - AGENT:agent_airsoft_0faa9616 - Created grading LLM for KB ['5', '6', '7']: gpt-4.1-nano via OpenAI
2025-05-30 22:27:40,304 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:27:40,312 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:931 C:6 T:937
2025-05-30 22:27:40,312 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for grading_llm: 937 tokens recorded.
2025-05-30 22:27:40,312 - INFO - AGENT:agent_airsoft_0faa9616 - Total token usage for grading_llm batch: 1879 tokens.
2025-05-30 22:27:40,312 - INFO - AGENT:agent_airsoft_0faa9616 - Found 0 relevant documents out of 1 initial (after split).
2025-05-30 22:27:40,312 - INFO - AGENT:agent_airsoft_0faa9616 - ---ASSESS GRADED DOCUMENTS---
2025-05-30 22:27:40,312 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO RELEVANT DOCUMENTS, REWRITE---
2025-05-30 22:27:40,313 - INFO - AGENT:agent_airsoft_0faa9616 - ---TRANSFORM QUERY (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:27:40,313 - INFO - AGENT:agent_airsoft_0faa9616 - Using KB-specific model configuration for rewrite. KB IDs: ['5', '6', '7']
2025-05-30 22:27:40,313 - INFO - AGENT:agent_airsoft_0faa9616 - Rewrite attempt 2/3 for question: 'ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹, ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² ÑĞ¾Ğ²ĞµÑ‚ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ´Ğ° Ğ½Ğ° ÑƒÑ‚11?'
2025-05-30 22:27:40,313 - INFO - AGENT:agent_airsoft_0faa9616 - Rewriting original question: ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹, ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² ÑĞ¾Ğ²ĞµÑ‚ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ´Ğ° Ğ½Ğ° ÑƒÑ‚11?
2025-05-30 22:27:40,313 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-nano, temp: 0.0, streaming: False
2025-05-30 22:27:40,338 - INFO - AGENT:agent_airsoft_0faa9616 - Created rewrite LLM for KB ['5', '6', '7']: gpt-4.1-nano via OpenAI
2025-05-30 22:27:41,321 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:27:41,324 - INFO - AGENT:agent_airsoft_0faa9616 - Rewritten question: Ğ¡Ğ¾Ğ³Ğ»Ğ°ÑĞ½Ğ¾ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹, ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° Ğ£Ğ¢11?
2025-05-30 22:27:41,324 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:2499 C:19 T:2518
2025-05-30 22:27:41,324 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for rewrite_llm: 2518 tokens recorded.
2025-05-30 22:27:41,325 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:27:41,325 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 22:27:41,349 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 22:27:41,354 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 5 tools.
2025-05-30 22:27:42,764 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:27:43,152 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 22:27:43,152 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 22:27:43,152 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 2020, 'output_tokens': 36, 'total_tokens': 2056, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 22:27:43,152 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:2020 C:36 T:2056
2025-05-30 22:27:43,152 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 2056 tokens recorded.
2025-05-30 22:27:43,153 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 22:27:43,153 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: knowledgeBase-1748440512419
2025-05-30 22:27:43,153 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO RETRIEVE (knowledgeBase-1748440512419)---
2025-05-30 22:27:43,458 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 22:27:43,468 - INFO - httpx - HTTP Request: POST http://127.0.0.1:6333/collections/platformai/points/query "HTTP/1.1 200 OK"
2025-05-30 22:27:43,470 - INFO - AGENT:agent_airsoft_0faa9616 - ---CHECK RELEVANCE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:27:43,470 - INFO - AGENT:agent_airsoft_0faa9616 - Grading documents for question: 'Ğ¡Ğ¾Ğ³Ğ»Ğ°ÑĞ½Ğ¾ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹, ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° Ğ£Ğ¢11?'
2025-05-30 22:27:43,471 - INFO - AGENT:agent_airsoft_0faa9616 - Using KB-specific model configuration for KB IDs: ['5', '6', '7']
2025-05-30 22:27:43,471 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-nano, temp: 0.0, streaming: False
2025-05-30 22:27:43,495 - INFO - AGENT:agent_airsoft_0faa9616 - Created grading LLM for KB ['5', '6', '7']: gpt-4.1-nano via OpenAI
2025-05-30 22:27:44,252 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:27:44,262 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:931 C:6 T:937
2025-05-30 22:27:44,262 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for grading_llm: 937 tokens recorded.
2025-05-30 22:27:44,262 - INFO - AGENT:agent_airsoft_0faa9616 - Total token usage for grading_llm batch: 2816 tokens.
2025-05-30 22:27:44,262 - INFO - AGENT:agent_airsoft_0faa9616 - Found 0 relevant documents out of 1 initial (after split).
2025-05-30 22:27:44,262 - INFO - AGENT:agent_airsoft_0faa9616 - ---ASSESS GRADED DOCUMENTS---
2025-05-30 22:27:44,262 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO RELEVANT DOCUMENTS, REWRITE---
2025-05-30 22:27:44,263 - INFO - AGENT:agent_airsoft_0faa9616 - ---TRANSFORM QUERY (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:27:44,263 - INFO - AGENT:agent_airsoft_0faa9616 - Using KB-specific model configuration for rewrite. KB IDs: ['5', '6', '7']
2025-05-30 22:27:44,263 - INFO - AGENT:agent_airsoft_0faa9616 - Rewrite attempt 3/3 for question: 'ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹, ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² ÑĞ¾Ğ²ĞµÑ‚ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ´Ğ° Ğ½Ğ° ÑƒÑ‚11?'
2025-05-30 22:27:44,263 - INFO - AGENT:agent_airsoft_0faa9616 - Rewriting original question: ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹, ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² ÑĞ¾Ğ²ĞµÑ‚ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ´Ğ° Ğ½Ğ° ÑƒÑ‚11?
2025-05-30 22:27:44,263 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-nano, temp: 0.0, streaming: False
2025-05-30 22:27:44,289 - INFO - AGENT:agent_airsoft_0faa9616 - Created rewrite LLM for KB ['5', '6', '7']: gpt-4.1-nano via OpenAI
2025-05-30 22:27:45,257 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:27:45,259 - INFO - AGENT:agent_airsoft_0faa9616 - Rewritten question: Ğ¡Ğ¾Ğ³Ğ»Ğ°ÑĞ½Ğ¾ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹, ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ² Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° Ğ£Ğ¢11?
2025-05-30 22:27:45,259 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:3700 C:19 T:3719
2025-05-30 22:27:45,259 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for rewrite_llm: 3719 tokens recorded.
2025-05-30 22:27:45,261 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 22:27:45,261 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 22:27:45,285 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 22:27:45,290 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 5 tools.
2025-05-30 22:27:46,426 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 22:27:49,431 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ¡Ğ¾Ğ³Ğ»Ğ°ÑĞ½Ğ¾ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹, Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° Ğ£Ğ¢11 Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ Ğ¸Ğ¼ĞµÑ‚ÑŒ ÑˆÑ‚Ğ°Ñ‚ Ğ¸Ğ· 2-3 Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ². ĞŸÑ€Ğ¸ ÑÑ‚Ğ¾Ğ¼ Ğ¾
2025-05-30 22:27:49,431 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 22:27:49,431 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 2845, 'output_tokens': 145, 'total_tokens': 2990, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 22:27:49,431 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:2845 C:145 T:2990
2025-05-30 22:27:49,431 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 2990 tokens recorded.
2025-05-30 22:27:49,432 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 22:27:49,432 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 22:27:49,433 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ¡Ğ¾Ğ³Ğ»Ğ°ÑĞ½Ğ¾ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹, Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° Ğ£Ğ¢11 Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ Ğ¸Ğ¼ĞµÑ‚ÑŒ ÑˆÑ‚Ğ°Ñ‚ Ğ¸Ğ· 2-3 Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ². ĞŸÑ€Ğ¸ ÑÑ‚Ğ¾Ğ¼ Ğ¾...
2025-05-30 22:27:49,434 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 6a1c72fb-0158-497d-aca2-3cc0caf404c6)
2025-05-30 22:27:49,435 - INFO - AGENT:agent_airsoft_0faa9616 - Found 10 token usage events for InteractionID: 6a1c72fb-0158-497d-aca2-3cc0caf404c6.
2025-05-30 22:27:49,439 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '6a1c72fb-0158-497d-aca2-3cc0caf404c6', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 371, 'completion_tokens': 34, 'total_tokens': 405, 'timestamp': '2025-05-30T17:27:34.379569+00:00'}
2025-05-30 22:27:49,439 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 6a1c72fb-0158-497d-aca2-3cc0caf404c6
2025-05-30 22:27:49,441 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1054 for interaction_id: 6a1c72fb-0158-497d-aca2-3cc0caf404c6 on attempt 1
2025-05-30 22:27:49,441 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Ğ¡Ğ¾Ğ³Ğ»Ğ°ÑĞ½Ğ¾ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹, Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° Ğ£Ğ¢11 Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ Ğ¸Ğ¼ĞµÑ‚ÑŒ ÑˆÑ‚Ğ°Ñ‚ Ğ¸Ğ· 2-3 Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ¸ÑÑ‚Ğ¾Ğ². ĞŸÑ€Ğ¸ ÑÑ‚Ğ¾Ğ¼ Ğ¾...
2025-05-30 22:27:49,441 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Ğ¡Ğ¾Ğ³Ğ»Ğ°ÑĞ½Ğ¾ Ğ±Ğ°Ğ·Ğµ Ğ·Ğ½Ğ°Ğ½Ğ¸Ğ¹, Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ° Ğ½Ğ° Ğ£Ğ¢11 Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½...'
2025-05-30 22:27:49,442 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 6a1c72fb-0158-497d-aca2-3cc0caf404c6, db_id: 1054
2025-05-30 22:27:49,445 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 6a1c72fb-0158-497d-aca2-3cc0caf404c6, db_id: 552
2025-05-30 22:27:49,448 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '6a1c72fb-0158-497d-aca2-3cc0caf404c6', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 2845, 'completion_tokens': 145, 'total_tokens': 2990, 'timestamp': '2025-05-30T17:27:49.431976+00:00'}
2025-05-30 22:27:49,448 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 6a1c72fb-0158-497d-aca2-3cc0caf404c6
2025-05-30 22:27:49,449 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1054 for interaction_id: 6a1c72fb-0158-497d-aca2-3cc0caf404c6 on attempt 1
2025-05-30 22:27:49,452 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 6a1c72fb-0158-497d-aca2-3cc0caf404c6, db_id: 553
2025-05-30 22:27:49,455 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '6a1c72fb-0158-497d-aca2-3cc0caf404c6', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'rewrite_llm', 'model_id': 'gpt-4.1-nano-2025-04-14', 'prompt_tokens': 3700, 'completion_tokens': 19, 'total_tokens': 3719, 'timestamp': '2025-05-30T17:27:45.259972+00:00'}
2025-05-30 22:27:49,455 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 6a1c72fb-0158-497d-aca2-3cc0caf404c6
2025-05-30 22:27:49,456 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1054 for interaction_id: 6a1c72fb-0158-497d-aca2-3cc0caf404c6 on attempt 1
2025-05-30 22:27:49,459 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 6a1c72fb-0158-497d-aca2-3cc0caf404c6, db_id: 554
2025-05-30 22:27:49,462 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '6a1c72fb-0158-497d-aca2-3cc0caf404c6', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'grading_llm', 'model_id': 'gpt-4.1-nano-2025-04-14', 'prompt_tokens': 931, 'completion_tokens': 6, 'total_tokens': 937, 'timestamp': '2025-05-30T17:27:44.262172+00:00'}
2025-05-30 22:27:49,462 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 6a1c72fb-0158-497d-aca2-3cc0caf404c6
2025-05-30 22:27:49,463 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1054 for interaction_id: 6a1c72fb-0158-497d-aca2-3cc0caf404c6 on attempt 1
2025-05-30 22:27:49,465 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 6a1c72fb-0158-497d-aca2-3cc0caf404c6, db_id: 555
2025-05-30 22:27:49,468 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '6a1c72fb-0158-497d-aca2-3cc0caf404c6', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 2020, 'completion_tokens': 36, 'total_tokens': 2056, 'timestamp': '2025-05-30T17:27:43.152422+00:00'}
2025-05-30 22:27:49,468 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 6a1c72fb-0158-497d-aca2-3cc0caf404c6
2025-05-30 22:27:49,468 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1054 for interaction_id: 6a1c72fb-0158-497d-aca2-3cc0caf404c6 on attempt 1
2025-05-30 22:27:49,472 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 6a1c72fb-0158-497d-aca2-3cc0caf404c6, db_id: 556
2025-05-30 22:27:49,474 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '6a1c72fb-0158-497d-aca2-3cc0caf404c6', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'rewrite_llm', 'model_id': 'gpt-4.1-nano-2025-04-14', 'prompt_tokens': 2499, 'completion_tokens': 19, 'total_tokens': 2518, 'timestamp': '2025-05-30T17:27:41.324314+00:00'}
2025-05-30 22:27:49,474 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 6a1c72fb-0158-497d-aca2-3cc0caf404c6
2025-05-30 22:27:49,475 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1054 for interaction_id: 6a1c72fb-0158-497d-aca2-3cc0caf404c6 on attempt 1
2025-05-30 22:27:49,476 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 6a1c72fb-0158-497d-aca2-3cc0caf404c6, db_id: 557
2025-05-30 22:27:49,479 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '6a1c72fb-0158-497d-aca2-3cc0caf404c6', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'grading_llm', 'model_id': 'gpt-4.1-nano-2025-04-14', 'prompt_tokens': 931, 'completion_tokens': 6, 'total_tokens': 937, 'timestamp': '2025-05-30T17:27:40.312117+00:00'}
2025-05-30 22:27:49,479 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 6a1c72fb-0158-497d-aca2-3cc0caf404c6
2025-05-30 22:27:49,479 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1054 for interaction_id: 6a1c72fb-0158-497d-aca2-3cc0caf404c6 on attempt 1
2025-05-30 22:27:49,482 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 6a1c72fb-0158-497d-aca2-3cc0caf404c6, db_id: 558
2025-05-30 22:27:49,484 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '6a1c72fb-0158-497d-aca2-3cc0caf404c6', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1195, 'completion_tokens': 36, 'total_tokens': 1231, 'timestamp': '2025-05-30T17:27:39.124357+00:00'}
2025-05-30 22:27:49,484 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 6a1c72fb-0158-497d-aca2-3cc0caf404c6
2025-05-30 22:27:49,485 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1054 for interaction_id: 6a1c72fb-0158-497d-aca2-3cc0caf404c6 on attempt 1
2025-05-30 22:27:49,487 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 6a1c72fb-0158-497d-aca2-3cc0caf404c6, db_id: 559
2025-05-30 22:27:49,490 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '6a1c72fb-0158-497d-aca2-3cc0caf404c6', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'rewrite_llm', 'model_id': 'gpt-4.1-nano-2025-04-14', 'prompt_tokens': 1297, 'completion_tokens': 18, 'total_tokens': 1315, 'timestamp': '2025-05-30T17:27:37.521039+00:00'}
2025-05-30 22:27:49,490 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 6a1c72fb-0158-497d-aca2-3cc0caf404c6
2025-05-30 22:27:49,490 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1054 for interaction_id: 6a1c72fb-0158-497d-aca2-3cc0caf404c6 on attempt 1
2025-05-30 22:27:49,492 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 6a1c72fb-0158-497d-aca2-3cc0caf404c6, db_id: 560
2025-05-30 22:27:49,494 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '6a1c72fb-0158-497d-aca2-3cc0caf404c6', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'grading_llm', 'model_id': 'gpt-4.1-nano-2025-04-14', 'prompt_tokens': 936, 'completion_tokens': 6, 'total_tokens': 942, 'timestamp': '2025-05-30T17:27:35.753019+00:00'}
2025-05-30 22:27:49,494 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 6a1c72fb-0158-497d-aca2-3cc0caf404c6
2025-05-30 22:27:49,495 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1054 for interaction_id: 6a1c72fb-0158-497d-aca2-3cc0caf404c6 on attempt 1
2025-05-30 22:27:49,497 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 6a1c72fb-0158-497d-aca2-3cc0caf404c6, db_id: 561
2025-05-30 22:31:59,764 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 22:31:59,774 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 22:36:59,931 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 22:36:59,941 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 22:42:00,121 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 22:42:00,130 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 22:46:27,571 - ERROR - aiogram.dispatcher - Failed to fetch updates - TelegramNetworkError: HTTP Client says - ServerDisconnectedError: Server disconnected
2025-05-30 22:46:27,573 - WARNING - aiogram.dispatcher - Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 1750613938)
2025-05-30 22:46:38,937 - INFO - aiogram.dispatcher - Connection established (tryings = 1, bot id = 1750613938)
2025-05-30 22:47:00,317 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 22:47:00,325 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 22:52:00,592 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 22:52:00,602 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 22:53:54,472 - ERROR - aiogram.dispatcher - Failed to fetch updates - TelegramNetworkError: HTTP Client says - ServerDisconnectedError: Server disconnected
2025-05-30 22:53:54,474 - WARNING - aiogram.dispatcher - Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 1750613938)
2025-05-30 22:54:05,733 - INFO - aiogram.dispatcher - Connection established (tryings = 1, bot id = 1750613938)
2025-05-30 22:54:46,174 - ERROR - aiogram.dispatcher - Failed to fetch updates - TelegramNetworkError: HTTP Client says - ServerDisconnectedError: Server disconnected
2025-05-30 22:54:46,175 - WARNING - aiogram.dispatcher - Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 1750613938)
2025-05-30 22:54:57,447 - INFO - aiogram.dispatcher - Connection established (tryings = 1, bot id = 1750613938)
2025-05-30 22:55:58,274 - ERROR - aiogram.dispatcher - Failed to fetch updates - TelegramNetworkError: HTTP Client says - ServerDisconnectedError: Server disconnected
2025-05-30 22:55:58,275 - WARNING - aiogram.dispatcher - Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 1750613938)
2025-05-30 22:56:09,537 - INFO - aiogram.dispatcher - Connection established (tryings = 1, bot id = 1750613938)
2025-05-30 22:57:00,125 - ERROR - aiogram.dispatcher - Failed to fetch updates - TelegramNetworkError: HTTP Client says - ServerDisconnectedError: Server disconnected
2025-05-30 22:57:00,126 - WARNING - aiogram.dispatcher - Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 1750613938)
2025-05-30 22:57:00,841 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 22:57:00,849 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 22:57:11,388 - INFO - aiogram.dispatcher - Connection established (tryings = 1, bot id = 1750613938)
2025-05-30 22:58:32,489 - ERROR - aiogram.dispatcher - Failed to fetch updates - TelegramNetworkError: HTTP Client says - ServerDisconnectedError: Server disconnected
2025-05-30 22:58:32,490 - WARNING - aiogram.dispatcher - Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 1750613938)
2025-05-30 22:58:43,752 - INFO - aiogram.dispatcher - Connection established (tryings = 1, bot id = 1750613938)
2025-05-30 23:00:04,592 - ERROR - aiogram.dispatcher - Failed to fetch updates - TelegramNetworkError: HTTP Client says - ServerDisconnectedError: Server disconnected
2025-05-30 23:00:04,593 - WARNING - aiogram.dispatcher - Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 1750613938)
2025-05-30 23:00:15,912 - INFO - aiogram.dispatcher - Connection established (tryings = 1, bot id = 1750613938)
2025-05-30 23:00:15,913 - ERROR - aiogram.dispatcher - Failed to fetch updates - TelegramNetworkError: HTTP Client says - ServerDisconnectedError: Server disconnected
2025-05-30 23:00:15,913 - WARNING - aiogram.dispatcher - Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 1750613938)
2025-05-30 23:00:27,157 - INFO - aiogram.dispatcher - Connection established (tryings = 1, bot id = 1750613938)
2025-05-30 23:01:48,277 - ERROR - aiogram.dispatcher - Failed to fetch updates - TelegramNetworkError: HTTP Client says - ServerDisconnectedError: Server disconnected
2025-05-30 23:01:48,278 - WARNING - aiogram.dispatcher - Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 1750613938)
2025-05-30 23:01:59,541 - INFO - aiogram.dispatcher - Connection established (tryings = 1, bot id = 1750613938)
2025-05-30 23:02:01,036 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 23:02:01,044 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 23:03:30,619 - ERROR - aiogram.dispatcher - Failed to fetch updates - TelegramNetworkError: HTTP Client says - ServerDisconnectedError: Server disconnected
2025-05-30 23:03:30,621 - WARNING - aiogram.dispatcher - Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 1750613938)
2025-05-30 23:03:41,941 - INFO - aiogram.dispatcher - Connection established (tryings = 1, bot id = 1750613938)
2025-05-30 23:04:22,438 - ERROR - aiogram.dispatcher - Failed to fetch updates - TelegramNetworkError: HTTP Client says - ServerDisconnectedError: Server disconnected
2025-05-30 23:04:22,438 - WARNING - aiogram.dispatcher - Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 1750613938)
2025-05-30 23:04:33,678 - INFO - aiogram.dispatcher - Connection established (tryings = 1, bot id = 1750613938)
2025-05-30 23:05:24,283 - ERROR - aiogram.dispatcher - Failed to fetch updates - TelegramNetworkError: HTTP Client says - ServerDisconnectedError: Server disconnected
2025-05-30 23:05:24,284 - WARNING - aiogram.dispatcher - Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 1750613938)
2025-05-30 23:05:35,525 - INFO - aiogram.dispatcher - Connection established (tryings = 1, bot id = 1750613938)
2025-05-30 23:06:05,795 - ERROR - aiogram.dispatcher - Failed to fetch updates - TelegramNetworkError: HTTP Client says - ServerDisconnectedError: Server disconnected
2025-05-30 23:06:05,796 - WARNING - aiogram.dispatcher - Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 1750613938)
2025-05-30 23:06:17,570 - INFO - aiogram.dispatcher - Connection established (tryings = 1, bot id = 1750613938)
2025-05-30 23:06:47,879 - ERROR - aiogram.dispatcher - Failed to fetch updates - TelegramNetworkError: HTTP Client says - ServerDisconnectedError: Server disconnected
2025-05-30 23:06:47,880 - WARNING - aiogram.dispatcher - Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 1750613938)
2025-05-30 23:06:59,142 - INFO - aiogram.dispatcher - Connection established (tryings = 1, bot id = 1750613938)
2025-05-30 23:07:01,216 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 23:07:01,224 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 23:07:49,626 - ERROR - aiogram.dispatcher - Failed to fetch updates - TelegramNetworkError: HTTP Client says - ServerDisconnectedError: Server disconnected
2025-05-30 23:07:49,627 - WARNING - aiogram.dispatcher - Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 1750613938)
2025-05-30 23:08:00,864 - INFO - aiogram.dispatcher - Connection established (tryings = 1, bot id = 1750613938)
2025-05-30 23:08:00,865 - ERROR - aiogram.dispatcher - Failed to fetch updates - TelegramNetworkError: HTTP Client says - ServerDisconnectedError: Server disconnected
2025-05-30 23:08:00,865 - WARNING - aiogram.dispatcher - Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 1750613938)
2025-05-30 23:08:12,106 - INFO - aiogram.dispatcher - Connection established (tryings = 1, bot id = 1750613938)
2025-05-30 23:08:32,265 - ERROR - aiogram.dispatcher - Failed to fetch updates - TelegramNetworkError: HTTP Client says - ServerDisconnectedError: Server disconnected
2025-05-30 23:08:32,266 - WARNING - aiogram.dispatcher - Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 1750613938)
2025-05-30 23:08:43,516 - INFO - aiogram.dispatcher - Connection established (tryings = 1, bot id = 1750613938)
2025-05-30 23:08:43,517 - ERROR - aiogram.dispatcher - Failed to fetch updates - TelegramNetworkError: HTTP Client says - ServerDisconnectedError: Server disconnected
2025-05-30 23:08:43,517 - WARNING - aiogram.dispatcher - Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 1750613938)
2025-05-30 23:08:54,759 - INFO - aiogram.dispatcher - Connection established (tryings = 1, bot id = 1750613938)
2025-05-30 23:09:25,058 - ERROR - aiogram.dispatcher - Failed to fetch updates - TelegramNetworkError: HTTP Client says - ServerDisconnectedError: Server disconnected
2025-05-30 23:09:25,058 - WARNING - aiogram.dispatcher - Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 1750613938)
2025-05-30 23:09:36,300 - INFO - aiogram.dispatcher - Connection established (tryings = 1, bot id = 1750613938)
2025-05-30 23:10:06,737 - ERROR - aiogram.dispatcher - Failed to fetch updates - TelegramNetworkError: HTTP Client says - ServerDisconnectedError: Server disconnected
2025-05-30 23:10:06,738 - WARNING - aiogram.dispatcher - Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 1750613938)
2025-05-30 23:10:17,990 - INFO - aiogram.dispatcher - Connection established (tryings = 1, bot id = 1750613938)
2025-05-30 23:12:01,438 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 23:12:01,448 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 23:17:01,641 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 23:17:01,651 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 23:22:01,836 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 23:22:01,843 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 23:27:02,055 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 23:27:02,065 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 23:32:02,266 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 23:32:02,279 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 23:39:35,639 - ERROR - aiogram.dispatcher - Failed to fetch updates - TelegramNetworkError: HTTP Client says - Request timeout error
2025-05-30 23:39:35,640 - WARNING - aiogram.dispatcher - Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 1750613938)
2025-05-30 23:50:15,770 - ERROR - aiogram.dispatcher - Failed to fetch updates - TelegramNetworkError: HTTP Client says - Request timeout error
2025-05-30 23:50:15,771 - WARNING - aiogram.dispatcher - Sleep for 1.339789 seconds and try again... (tryings = 1, bot id = 1750613938)
2025-05-30 23:55:36,462 - ERROR - aiogram.dispatcher - Failed to fetch updates - TelegramNetworkError: HTTP Client says - Request timeout error
2025-05-30 23:55:36,464 - WARNING - aiogram.dispatcher - Sleep for 1.742348 seconds and try again... (tryings = 2, bot id = 1750613938)
2025-05-30 23:55:48,455 - INFO - aiogram.dispatcher - Connection established (tryings = 3, bot id = 1750613938)
2025-05-30 23:58:52,057 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 23:58:52,067 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-31 00:03:52,303 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-31 00:03:52,313 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-31 00:08:52,520 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-31 00:08:52,528 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-31 00:13:52,725 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-31 00:13:52,734 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-31 00:18:52,992 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-31 00:18:53,001 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-31 00:23:53,357 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-31 00:23:53,368 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-31 00:28:53,680 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-31 00:28:53,687 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-31 00:33:53,886 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-31 00:33:53,898 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-31 00:38:54,127 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-31 00:38:54,139 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-31 00:43:54,322 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-31 00:43:54,331 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-31 00:48:54,521 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-31 00:48:54,530 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-31 00:53:54,740 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-31 00:53:54,751 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
