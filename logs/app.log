2025-05-30 15:04:42,818 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 15:04:42,818 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 15:04:42,819 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 15:04:42,819 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 15:04:42,819 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 71896
2025-05-30 15:04:42,819 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 15:04:42,819 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 15:04:42,819 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 15:04:42,824 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 15:04:42,824 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 15:04:42,937 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 15:04:42,938 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 15:04:42,938 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 15:04:42,938 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 15:04:42,938 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 15:04:42,938 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 15:04:42,963 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 15:04:42,963 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 15:04:42,963 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 15:04:42,964 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 15:04:42,965 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET)
2025-05-30 15:04:42,965 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 15:04:42,965 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 15:04:43,018 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 15:04:43,022 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 15:04:43,620 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 15:04:43,622 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 15:04:43,623 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 15:04:43,623 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 15:04:43,623 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 15:04:43,623 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 15:04:43,623 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 15:04:43,623 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 15:04:43,623 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 15:04:43,623 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 15:04:43,624 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 15:04:43,624 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 15:04:43,624 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 15:04:43,624 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 15:04:43,624 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 15:04:43,624 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 15:04:43,634 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 15:04:43,634 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 15:04:43,634 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 15:04:43,634 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4669418928) setup complete. Starting run loop.
2025-05-30 15:04:43,634 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 15:04:43,634 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 15:04:43,634 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 15:04:43,634 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 15:04:43,637 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 15:06:35,187 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 15:06:35,189 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: c6df5350-fb4d-45b5-87c3-f3396e809f4a)
2025-05-30 15:06:35,189 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 15:06:35,189 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 15:06:35,189 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 15:06:35,272 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 15:06:35,272 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 15:06:35,300 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 15:06:35,304 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 15:06:36,313 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 15:06:36,318 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 15:06:36,318 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 15:06:36,318 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 363, 'output_tokens': 12, 'total_tokens': 375, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 15:06:36,318 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:363 C:12 T:375
2025-05-30 15:06:36,318 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 375 tokens recorded.
2025-05-30 15:06:36,319 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 15:06:36,319 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: get_user_info_tool
2025-05-30 15:06:36,319 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (get_user_info_tool)---
2025-05-30 15:06:36,322 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 15:06:36,322 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 15:06:36,346 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 15:06:36,349 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 15:06:37,767 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 15:06:37,790 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 15:06:37,790 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 15:06:37,790 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 434, 'output_tokens': 16, 'total_tokens': 450, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 15:06:37,790 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:434 C:16 T:450
2025-05-30 15:06:37,790 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 450 tokens recorded.
2025-05-30 15:06:37,791 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 15:06:37,791 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748589354598
2025-05-30 15:06:37,791 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748589354598)---
2025-05-30 15:06:37,792 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹'
2025-05-30 15:06:37,792 - INFO - app.agent_runner.common.tools_registry - Function parameters: api_config=True, log_adapter=True, state=True
2025-05-30 15:06:37,792 - INFO - app.agent_runner.common.tools_registry - State type: <class 'dict'>
2025-05-30 15:06:37,792 - INFO - app.agent_runner.common.tools_registry - State keys: ['messages', 'documents', 'question', 'original_question', 'rewrite_count', 'channel', 'user_data', 'token_usage_events']
2025-05-30 15:06:37,792 - INFO - app.agent_runner.common.tools_registry - User data extracted: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 15:06:37,792 - INFO - app.agent_runner.common.tools_registry - Final user_data for API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹': {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 15:06:37,792 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 15:06:37,792 - INFO - app.agent_runner.common.tools_registry - Headers type: <class 'dict'>, value: {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36', 'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7', 'Accept-Language': 'ru-RU,ru;q=0.9,en;q=0.8', 'Accept-Encoding': 'gzip, deflate, br', 'DNT': '1', 'Connection': 'keep-alive', 'Upgrade-Insecure-Requests': '1', 'Sec-Fetch-Dest': 'document', 'Sec-Fetch-Mode': 'navigate', 'Sec-Fetch-Site': 'same-origin', 'Sec-Fetch-User': '?1', 'Cache-Control': 'max-age=0', 'Referer': 'https://airsoft-rus.ru/', 'Cookie': 'PHPSESSID=gq3cMIY4z4t5OLt12aMMcFrus6CEIhZR'}
2025-05-30 15:06:37,792 - INFO - app.agent_runner.common.tools_registry - Query Params: {'type': 'info', 'tel': '79222088435'}
2025-05-30 15:06:38,160 - ERROR - app.agent_runner.common.tools_registry - HTTP error making GET request to https://airsoft-rus.ru/obmen_rus/bals.php: 403 ï¿½ï¿½ï¿½  ï¿½ï¿½Tï¿½ï¿½ï¿½Wï¿½[<Ù±	Uï¿½:ï¿½ï¿½Vï¿½ï¿½qJï¿½sï¿½ï¿½ß«ï¿½#ï¿½(ï¿½iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½eï¿½ï¿½isï¿½u.nEï¿½Â‚ï¿½ï¿½hï¿½ï¿½%/(ï¿½1ï¿½ï¿½006ï¿½L@Ğ¯ï¿½ï¿½sSï¿½ï¿½ï¿½ï¿½-i?ï¿½ï¿½_xï¿½ï¿½ï¿½ï¿½\ï¿½uï¿½K\ï¿½ï¿½\0ï¿½  ï¿½456ï¿½ï¿½ï¿½yï¿½ï¿½`ï¿½ï¿½ï¿½ky20ï¿½ï¿½f]æ‹‰ï¿½Dï¿½Û Iï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½_ï¿½ï¿½vC=P)O5È™ï¿½=ï¿½ËŠï¿½ï¿½ï¿½_ï¿½cï¿½ï¿½:ï¿½ï¿½ï¿½6ï¿½mï¿½:ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½1gï¿½fï¿½xï¿½ï¿½ï¿½"ï¿½ï¿½ï¿½ï¿½ï¿½bï¿½ï¿½ï¿½ï¿½ï¿½[ï¿½@ ï¿½ï¿½ï¿½Ø’ï¿½*ï¿½9ï¿½ç©8ï¿½ï¿½ .ï¿½iï¿½ï¿½@ï¿½_ï¿½t*B ï¿½ï¿½TÜ©ï¿½k},ï¿½ï¿½Gï¿½ï¿½uï¿½ï¿½Hï¿½~ï¿½ï¿½ï¿½Rï¿½ï¿½<ï¿½#Ûµï¿½d]ry
ï¿½Fvsï¿½ï¿½'ï¿½ï¿½ï¿½E\ï¿½dIï¿½É±ï¿½wï¿½ï¿½ï¿½ï¿½ï¿½Sp<ï¿½;ï¿½ï¿½urï¿½ï¿½ï¿½/LÓ•<Â­ï¿½<ï¿½ï¿½ï¿½ï¿½M?ï¿½ï¿½5pï¿½ï¿½Nï¿½ï¿½iï¿½ï¿½1ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½@pï¿½6Eï¿½ï¿½ï¿½ï¿½hï¿½ï¿½ï¿½p#ï¿½ï¿½ï¿½[ï¿½ï¿½,sï¿½ï¿½	vï¿½
ï¿½ï¿½ï¿½cï¿½ï¿½ï¿½+>ï¿½$ï¿½?! ï¿½ï¿½ï¿½ï¿½,cï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½rï¿½ï¿½~ï¿½ï¿½7ï¿½W|ï¿½]ï¿½ï¿½ï¿½Iï¿½ï¿½7ï¿½ï¿½ï¿½	ï¿½ï¿½ï¿½ï¿½
ï¿½ï¿½ï¿½Oï¿½ï¿½ï¿½jeï¿½@ï¿½ï¿½5ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½c7zdï¿½ÒŠEdï¿½ï¿½2ï¿½ï¿½ï¿½|2]ï¿½Óšï¿½ï¿½7ï¿½ï¿½0ï¿½ï¿½+ï¿½ï¿½ï¿½*ï¿½w4tï¿½%:ï¿½"ï¿½0ï¿½ï¿½UFb$>0D9ï¿½5jï¿½U)ï¿½Mï¿½ï¿½3nï¿½Bï¿½ï¿½ï¿½ï¿½N7ï¿½S)ï¿½,ï¿½ï¿½ŞƒsP7ï¿½S)ï¿½ï¿½kï¿½)ï¿½ï¿½"lï¿½ï¿½3ï¿½?uï¿½ï¿½ï¿½\ï¿½w"ï¿½q7ï¿½2ï¿½ï¿½b`ï¿½Vsï¿½Rï¿½oï¿½ï¿½ï¿½ï¿½ï¿½SKï¿½+ï¿½ï¿½(4	4sï¿½%ï¿½ï¿½&ï¿½ï¿½ï¿½	Eï¿½jAï¿½ï¿½EfJiï¿½ï¿½d;&ï¿½^<ï¿½ï¿½_ï¿½ï¿½ï¿½"7ï¿½ï¿½?_ï¿½|ï¿½xÄ±`@İ›ï¿½ï¿½'ï¿½ï¿½G)lFIï¿½Bqï¿½tST+ZZAï¿½Aï¿½ï¿½ï¿½ï¿½gï¿½ï¿½ï¿½ï¿½à¶«
ï¿½ï¿½ï¿½i&
ï¿½ï¿½ï¿½gv&8+&ï¿½iï¿½#SLTï¿½xï¿½Kï¿½ï¿½iï¿½ï¿½ZÑ¢ï¿½*ï¿½ï¿½M=ï¿½Sï¿½ï¿½Eï¿½ID.+Lï¿½ï¿½Mï¿½PHï¿½ï¿½YL4ï¿½ÑY.Lï¿½ï¿½	ï¿½rIBrcgï¿½t!ï¿½&gï¿½ëº³\*ï¿½fï¿½ï¿½rVï¿½lï¿½[]ï¿½4
\4+ï¿½ï¿½ï¿½ï¿½	o+ï¿½ï¿½BUï¿½UGDï¿½!,ï¿½ï¿½ Bï¿½ï¿½ï¿½ï¿½ï¿½?ï¿½ï¿½ï¿½dï¿½.ß¬ï¿½tï¿½3ï¿½ï¿½tï¿½ï¿½ï¿½ï¿½ï¿½tFï¿½ï¿½ï¿½aW9}Df+|LQï¿½4ï¿½gï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½`ï¿½ï¿½ï¿½c"&bï¿½w>ï¿½$ï¿½ï¿½|Lï¿½1ï¿½ï¿½ï¿½{Rï¿½
~ï¿½ï¿½ï¿½ï¿½/ï¿½WZï¿½ï¿½ ï¿½ï¿½ï¿½2vuï¿½^ï¿½ï¿½H6Ôœoyï¿½ï¿½ï¿½ï¿½~ï¿½ï¿½ï¿½uï¿½oï¿½ï¿½6ï¿½ï¿½.(Eï¿½uUï¿½Lï¿½ï¿½KuEï¿½$y4Tï¿½Y?e32ï¿½ï¿½t0xï¿½ï¿½ï¿½ï¿½^ï¿½(ï¿½ï¿½ï¿½ï¿½ï¿½~ï¿½ï¿½;Zï¿½ï¿½ï¿½ò†¼½G^ï¿½&ï¿½ï¿½oA1N]:ï¿½ï¿½ï¿½Ë·ï¿½ï¿½:ï¿½ï¿½ï¿½ï¿½Fï¿½o'~{ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½-ï¿½ï¿½8ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½7&ï¿½!w-Ë„ï¿½ï¿½ï¿½4ï¿½ï¿½lï¿½"ï¿½6ï¿½Õ¦ï¿½ï¿½Hï¿½#7)ï¿½ï¿½n(ï¿½Fï¿½  }ï¿½Oyï¿½Èï¿½ï¿½loÇ‡$iï¿½ï¿½ï¿½qï¿½~ï¿½,l:Tyw'ï¿½ï¿½;ï¿½ï¿½bLï¿½6Ê¾Hoï¿½ï¿½SWhï¿½ï¿½ï¿½|ï¿½ï¿½]ï¿½$ï¿½?.ï¿½ï¿½ï¿½ï¿½zï¿½ï¿½ï¿½k>ï¿½ï¿½hï¿½ï¿½ï¿½sRï¿½ï¿½AGï¿½ß¾ï¿½ï¿½Gï¿½ï¿½/i+)ï¿½YO-,qï¿½ï¿½3Fï¿½ï¿½ï¿½ï¿½ï¿½9[ï¿½M6ï¿½ï¿½D-ï¿½ï¿½ï¿½aï¿½"ï¿½geï¿½rï¿½Pï¿½JIï¿½2HUQmï¿½zï¿½rï¿½Ş ï¿½ï¿½ï¿½oï¿½ï¿½;ï¿½ï¿½ï¿½-{{ï¿½ï¿½hï¿½ï¿½ï¿½ï¿½ï¿½x{ï¿½ï¿½ï¿½ï¿½>/ï¿½ï¿½ï¿½yï¿½ï¿½ï¿½ï¿½ï¿½ï¿½-Jï¿½ï¿½ï¿½ï¿½ï¿½ï¿½*=:Mï¿½yï¿½ï¿½ï¿½"ï¿½cmï¿½2ï¿½ï¿½ï¿½ï¿½qï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Aï¿½ï¿½ï¿½Ø˜ï¿½ï¿½VLï¿½ï¿½ï¿½ï¿½Í¬DVRï¿½ï¿½ï¿½HWï¿½Ê—ï¿½ï¿½mï¿½9]ï¿½Cï¿½+R(ï¿½Ì¥Cjï¿½H%ï¿½Hï¿½1ï¿½Jï¿½e[ï¿½ï¿½ï¿½xGï¿½-ï¿½A#ï¿½ï¿½4b{Lï¿½ï¿½>ï¿½} gï¿½U<8 0ï¿½ï¿½A1  bï¿½ï¿½ ï¿½+ï¿½k6ï¿½tï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½XopS@ï¿½ï¿½!ï¿½bc ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Lbï¿½iï¿½ï¿½oBAï¿½ï¿½ï¿½=ï¿½vfï¿½@J`ï¿½ï¿½Tï¿½ï¿½qï¿½ï¿½ï¿½
\ï¿½ï¿½aï¿½ï¿½ï¿½ï¿½6ï¿½nÑ³m}
ï¿½4Éœxï¿½5'ï¿½ï¿½ï¿½Tï¿½p4ï¿½ï¿½ï¿½S2ï¿½ï¿½QQï¿½Óº"ï¿½ï¿½ï¿½ï¿½Sï¿½r6ï¿½>ï¿½N-=9yï¿½ï¿½ï¿½ï¿½i_Y=*,Nhe?ï¿½;,X*ï¿½ï¿½R+ï¿½y d$Kï¿½v;	ï¿½c$ï¿½Tï¿½ï¿½4ï¿½ï¿½)p%ï¿½"=ï¿½	D×·Nï¿½N'%ï¿½ï¿½ß‚ï¿½ï¿½âQMhX~ï¿½\KNï¿½ï¿½	CeB6ï¿½ï¿½Iï¿½ï¿½ï¿½ï¿½lï¿½ï¿½ï¿½ï¿½U=ï¿½8Gba{!?:ï¿½Lbï¿½ï¿½ï¿½|ï¿½2Bï¿½ï¿½ï¿½ï¿½ï¿½î¤~ï¿½ï¿½,ogimWnï¿½mï¿½ï¿½ï¿½Kï¿½Dï¿½ ï¿½2+Yï¿½ï¿½<Yï¿½@^,kï¿½ï¿½}6kï¿½4ï¿½ï¿½55&1ï¿½ï¿½ï¿½uqï¿½Xï¿½ï¿½hc]ï¿½ï¿½ï¿½xï¿½ï¿½[ M
N!ï¿½ï¿½ï¿½ï¿½ï¿½TO7jï¿½&Gï¿½ï¿½+]ï¿½`ï¿½ï¿½tVï¿½gï¿½oï¿½Ó³{t{ï¿½cï¿½&ï¿½vfGQï¿½Ôeu60ï¿½ï¿½9ï¿½Éªï¿½-%Aï¿½ï¿½ï¿½7ï¿½QUï¿½=`eï¿½ï¿½ï¿½i$ï¿½45ï¿½ï¿½ï¿½+Û¤.6ï¿½ï¿½{Tï¿½ï¿½ï¿½qï¿½ï¿½ï¿½vï¿½ï¿½bÒ›ï¿½Cï¿½ï¿½|(#*3 ï¿½&ï¿½ï¿½tï¿½xEï¿½ï¿½\zï¿½bHï¿½w×&ï¿½[Ô¶ï¿½ï¿½Cï¿½ï¿½ï¿½9gï¿½Sï¿½]
o7ï¿½Moï¿½ï¿½Cï¿½{ï¿½ï¿½Sï¿½uÈ­ï¿½&ï¿½ï¿½pï¿½>?ï¿½Oï¿½ï¿½5:ï¿½ï¿½ï¿½vtFKï¿½H@ï¿½]sï¿½eï¿½ï¿½7\Fï¿½I ï¿½H|Mt[`Ï–'ï¿½QyNï¿½Y-ï¿½Idï¿½ï¿½-ï¿½#Yï¿½Gï¿½ï¿½ï¿½Â¥ï¿½ï¿½vYï¿½Óº%ï¿½ï¿½"ï¿½ï¿½ï¿½ka-ï¿½fï¿½ï¿½}ï¿½t_ï¿½ï¿½ï¿½sï¿½Ê§Fï¿½URï¿½ï¿½<İ¼ï¿½\&ï¿½hyï¿½Ü›+ï¿½Oï¿½4;,ï¿½gï¿½jï¿½ï¿½:ï¿½F~[fï¿½%ï¿½&Ö•ï¿½
ï¿½-ï¿½dm1$ï¿½Usp~ï¿½ï¿½ï¿½ï¿½,ï¿½ï¿½"ï¿½ï¿½<ï¿½ï¿½zï¿½ï¿½ï¿½Å«dï¿½@l^ï¿½H*ï¿½}{oï¿½1ï¿½ï¿½|#ï¿½ï¿½aTï¿½ï¿½ï¿½ï¿½"ï¿½+OMe3ï¿½.ï¿½cï¿½ï¿½[.B21ï¿½ß¾8ï¿½)\u1ï¿½ï¿½|ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½.^K<ï¿½ï¿½0y3ï¿½İ©ï¿½Nï¿½	ï¿½bï¿½uï¿½ï¿½ï¿½ï¿½wŞ«hï¿½fÂ½j;ï¿½ï¿½Jpï¿½RSï¿½vï¿½Ó¶ï¿½w2ï¿½Hï¿½Mï¿½\ONï¿½Û¸ï¿½ï¿½ï¿½~ï¿½6ï¿½uï¿½ï¿½6Ê¼ï¿½ï¿½ï¿½t>ï¿½ï¿½|Mï¿½ï¿½ï¿½&ï¿½ï¿½ï¿½Lİ“ï¿½ï¿½Â™]ï¿½Ô„%rq_ï¿½ï¿½ï¿½ï¿½:pï¿½ï¿½xAï¿½ï¿½ï¿½9$ï¿½ï¿½Û’`ï¿½mÈ¯ï¿½İ¾ï¿½ï¿½dÑ fï¿½ï¿½ï¿½
n
.rï¿½P:fï¿½MSï¿½ï¿½ï¿½ï¿½Ge,ï¿½ï¿½ï¿½Ğ‹ï¿½ï¿½^mï¿½ï¿½ï¿½ë½¼ï¿½xï¿½ï¿½7,ÒHï¿½Hï¿½=ï¿½jï¿½A[ï¿½ï¿½"Ğ„0-ï¿½ï¿½^ï¿½<ï¿½ï¿½E3UFï¿½ï¿½ï¿½szï¿½ï¿½ÑZï¿½ï¿½gï¿½[ï¿½pï¿½Çï¿½ ï¿½Moï¿½ï¿½ï¿½ï¿½ï¿½ï¿½xï¿½(!vï¿½qï¿½=ï¿½ï¿½{ï¿½/ï¿½<nï¿½+ï¿½4!ï¿½Xï¿½0ï¿½k57ï¿½*ï¿½<ë„§fï¿½Hï¿½e9ï¿½ï¿½lï¿½ï¿½ï¿½cï¿½wyï¿½ï¿½uï¿½ï¿½yï¿½ï¿½ï¿½ï¿½ï¿½ï¿½iï¿½[{ï¿½ï¿½ï¿½Eï¿½ï¿½vGï¿½ï¿½vï¿½	ï¿½_ï¿½ï¿½[ï¿½ï¿½ï¿½Vaeï¿½)ï¿½Tï¿½ï¿½Rï¿½ï¿½1H-ï¿½(ï¿½]|ï¿½7ï¿½cï¿½ï¿½-ï¿½ï¿½yï¿½n\8ï¿½ï¿½ï¿½ï¿½Hï¿½ï¿½"ï¿½ï¿½oØ›ï¿½ï¿½nm#ï¿½ï¿½.ï¿½oï¿½ï¿½DmGwDï¿½ï¿½%ï¿½^+.ï¿½ï¿½ï¿½(ï¿½@ï¿½ï¿½+ï¿½ï¿½ï¿½ï¿½rï¿½Wï¿½czï¿½ï¿½Cï¿½Dï¿½ï¿½ï¿½Jï¿½]Eï¿½ï¿½DWï¿½ï¿½-@[*ï¿½ï¿½4ï¿½ï¿½ï¿½V>ï¿½hÒ…ï¿½ï¿½"ï¿½}Uï¿½ï¿½iï¿½ï¿½ï¿½^ï¿½-&hï¿½ï¿½~aï¿½ï¿½6u8ï¿½),cKï¿½ï¿½ï¿½ï¿½vxï¿½ï¿½ï¿½reï¿½ï¿½Oï¿½ï¿½K-ï¿½ï¿½o6gjï¿½k5>ï¿½- ï¿½ï¿½"&ï¿½ï¿½Rkï¿½dï¿½ï¿½&tt ï¿½ï¿½ fbnaï¿½R|s*ï¿½#ï¿½ï¿½ï¿½C(ï¿½
ï¿½T0}q:ï¿½ï¿½iNBï¿½Bï¿½8/8w1ï¿½s>ï¿½&ï¿½ï¿½,ï¿½ï¿½ï¿½ï¿½Fï¿½iï¿½ï¿½YI0ï¿½vï¿½ï¿½N~'%ï¿½*wï¿½ï¿½ï¿½xdï¿½)ï¿½9ï¿½ï¿½Kï¿½Yï¿½ï¿½%&?t^Ä¯4ï¿½ljTc\8|x+snï¿½ï¿½2ï¿½ï¿½gï¿½<ï¿½ï¿½ï¿½}Çï¿½]É€a}`ï¿½ï¿½{ï¿½1Pï¿½ï¿½ï¿½Ã—1
ï¿½Pï¿½ï¿½ ï¿½Ê›vï¿½Iï¿½<pï¿½;ï¿½ï¿½}ï¿½ï¿½|ï¿½ï¿½mï¿½Wï¿½ï¿½wn0Óï¿½ï¿½ï¿½	Wï¿½ï¿½JGZ\O3$ï¿½[Jxï¿½
ï¿½Pï¿½ï¿½ ï¿½nï¿½ï¿½ï¿½ï„”1ï¿½Xï¿½ï¿½c'ï¿½aGï¿½yq{
Slï¿½jpjï¿½ï¿½ï¿½ j(*ï¿½ï¿½ï¿½@ï¿½Xï¿½ï¿½cAAï¿½p)iAï¿½Oï¿½ï¿½+8W~ï¿½G$ï¿½ÉŒ7fË°[ï¿½ï¿½Dï¿½ï¿½G	Eï¿½ï¿½sï¿½5ï¿½ï¿½U?ï¿½ uVï¿½ï¿½rï¿½Å°_Âï¿½yÂ“ï¿½n8ï¿½ ï¿½xï¿½ï¿½L$zÃ€ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Aï¿½ï¿½/:Ts9HXï¿½|ï¿½Efï¿½Öšï¿½ï¿½ï¿½ï¿½ï¿½Qï¿½Zrï¿½=8Xï¿½Ó^K16ï¿½ñ¶¬`ï¿½ï¿½IDvŞŸ/ ï¿½jDzß„Â«ï¿½ï¿½*}i<ï¿½ï¿½ï¿½ï¿½ï¿½Iï¿½aï¿½rvï¿½ï¿½ï¿½4ï¿½Cvï¿½tï¿½ï¿½ï¿½ï¿½ï¿½3×ˆ[5Aï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Bï¿½ï¿½ï¿½Zï¿½ï¿½ï¿½d$Xpzç›¹Vï¿½ÛµNï¿½ï¿½ï¿½ï¿½ï¿½46ï¿½ZZï¿½}ï¿½?ï¿½ï¿½pï¿½}ï¿½ï¿½ï¿½
'ï¿½ï¿½6IMï¿½ï¿½'ï¿½ï¿½ï¿½^6ï¿½ï¿½ï¿½ï¿½ï¿½;Yï¿½Ãï¿½-ï¿½Qï¿½sï¿½ï¿½ï¿½1İ;Gï¿½ï¿½â•MÜI ï¿½rï¿½ï¿½sRï¿½ï¿½ï¿½:ï¿½ï¿½t`ï¿½ï¿½a_ï¿½5ï¿½Xï¿½ï¿½ï¿½ï¿½yï¿½Kï¿½ï¿½6ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½7G7Eï¿½ï¿½Mï¿½ï¿½2r5ï¿½ï¿½ï¿½Ò»ï¿½wï¿½ï¿½ï¿½,ï¿½]ï¿½IÅ‚ï¿½ï¿½hï¿½Mï¿½Öµlï¿½ï¿½7Yï¿½ï¿½Uï¿½ï¿½ï¿½ï¿½Rï¿½ï¿½etï¿½R+ï¿½tï¿½Ò«Bï¿½ï¿½ï¿½^ï¿½ï¿½ï¿½^Ôµ2ï¿½ï¿½Ä½ï¿½ï¿½ï¿½ï¿½?vï¿½ï¿½'ï¿½dk'ï¿½ï¿½È²ï¿½ï¿½"|<ï¿½,ï¿½ï¿½W6ï¿½ï¿½Iï¿½ï¿½\×¹ï¿½ß°g8;"qvp0!F{/&ï¿½XTï¿½ï¿½ï¿½?ï¿½>:ï¿½V"ÂJï¿½ï¿½İ†ï¿½ï¿½&ï¿½gY:Ğšm%Xï¿½ï¿½!ï¿½Gï¿½_ï¿½-UFï¿½dnï¿½ï¿½Dï¿½ï¿½ ï¿½bï¿½ï¿½:yzï¿½ï¿½ï¿½ï¿½Rï¿½ï¿½ï¿½1ï¿½ï¿½iï¿½ï¿½ï¿½ï¿½Fï¿½xï¿½ï¿½ï¿½ï¿½pï¿½[ï¿½ï¿½ï¿½Jï¿½ï¿½(ï¿½Ó¹ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½08-&+ï²ï¿½9ï¿½ï¿½jLï¿½)ï¿½ï¿½qï¿½ï¿½ï¿½ï¿½ï¿½Wjï¿½xï¿½Nï¿½ï¿½ï¿½ï¿½ï¿½vC}]_Öï¿½ï¿½ï¿½ï¿½ÈŸ3ï¿½uYË’llï¿½UÍ˜ï¿½wï¿½\(ï¿½ï¿½0Xï¿½%mDFï¿½|2ï¿½Qï¿½Jï¿½wï¿½Zï¿½ï¿½"ï¿½ï¿½Gï¿½shï¿½ï¿½Ø†XXuï¿½2mï¿½Kï¿½ï¿½Kcï¿½ï¿½kï¿½ï¿½oYï¿½ï¿½ï¿½qaG1Lï¿½ï¿½Mï¿½ï¿½ï¿½>ï¿½ï¿½eUï¿½	ï¿½8ï¿½fï¿½ï¿½ï¿½~$ï¿½ï¿½5<ï¿½N(	oï¿½|ï¿½D:Sï¿½bï¿½ï¿½ï¿½ï¿½H(ï¿½Bï¿½|ï¿½Dï¿½=kï¿½ï¿½y(Oï¿½aï¿½lÍ½ï¿½;5ï¿½^Obï¿½ï¿½ï¿½ï¿½]ï¿½ï¿½
bï¿½ï¿½ï¿½%._ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½8Nï¿½ï¿½	ï¿½î‹ï¿½fØª$~bï¿½ï¿½ï¿½ï¿½opPï¿½ï¿½ï¿½ =xw1ï¿½ï¿½ï¿½ï¿½gï¿½ï¿½dEï¿½nu#ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½hlï¿½ï¿½ï¿½^ï¿½ï¿½i1ï¿½_+ï¿½ï¿½Mï¿½ï¿½~5ï¿½ï¿½ï¿½ï¿½ï¿½adï¿½ï¿½Õdï¿½ ï¿½5cï¿½q)ï¿½L7ï¿½Cï¿½dï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Lï¿½HB8 ï¿½ï¿½ï¿½ï¿½w2ï¿½ï¿½_ï¿½bï¿½]s_ï¿½ï¿½c ï¿½$S`ï¿½ï¿½P*ï¿½ï¿½Éºï¿½^sï¿½6@U$ï¿½&ï¿½Y|Ù

 ]wï¿½ï¿½ï¿½ï¿½Oé™‰OHM)ï¿½mï¿½ä…©Pï¿½Æ‘ï¿½[ï¿½ï¿½ï¿½Uï¿½WLï¿½ï¿½ ï¿½_ï¿½ï¿½dï¿½Ûï¿½ï¿½Uï¿½ï¿½ï¿½ï¿½ï¿½á…¾ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½F9"ï¿½N4@ï¿½ï¿½8ï¿½.ï¿½7t'Tï¿½{h=ï¿½ï¿½ï¿½ï¿½k0^ï¿½ï¿½ï¿½|]ï¿½.Zï¿½ï¿½ï¿½ï¿½hLï¿½9aï¿½Iï¿½ï¿½ï¿½ï¿½)ï¿½~~ï¿½ï¿½3ï¿½;`ï¿½ï¿½ï¿½ï¿½ï¿½Gï¿½QVï¿½ï¿½ò ®“6K>ï¿½:ï¿½ï¿½nl~ï¿½?ï¿½ï¿½ï¿½ï¿½4ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½,ï¿½ï¿½Bï¿½ï¿½ï¿½Eï¿½ï¿½ï¿½ï¿½`ï¿½Rï¿½ï¿½UVwDZï¿½ï¿½)ï¿½|]F
sï¿½Eï¿½ï¿½.ooï¿½ï¿½ï¿½ï¿½İ˜ï¿½-xï¿½ï¿½oï¿½/ï¿½ï¿½ï¿½uï¿½ï¿½.]ï¿½ï¿½ï¿½vï¿½ï¿½ï¿½ï¿½ï¿½Ç’ï¿½Ç‘C	ï¿½yYS]Dï¿½ï¿½;Jï¿½Ks?.cï¿½ï¿½ï¿½qÆ¿ï¿½bï¿½ï¿½ï¿½ï¿½H/Xg
ï¿½A.ï¿½ï¿½ï¿½ï¿½ï¿½;ï¿½ï¿½kï¿½9ï¿½ï¿½ï—¿ï¿½`ï¿½tï¿½ï¿½"zï¿½y4ï¿½ï¿½Ï‹eï¿½	ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½K]ï¿½_~eï¿½ï¿½ï¿½'ï¿½ï¿½1ï¿½
ï¿½{}ï¿½+hï¿½hï¿½.[ï¿½luï¿½ï¿½ï¿½ï¿½ß¿ï¿½Jï¿½ï¿½ï¿½[ï¿½ï¿½Iï¿½}ï¿½_ï¿½ï¿½ï¿½ï¿½.ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Şº+ï¿½Qwï¿½ï¿½#ï¿½ï¿½ï¿½
2025-05-30 15:06:38,162 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 15:06:38,162 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 15:06:38,192 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 15:06:38,195 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 15:06:39,358 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 15:06:40,175 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğš ÑĞ¾Ğ¶Ğ°Ğ»ĞµĞ½Ğ¸Ñ, ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ½Ğµ ÑƒĞ´Ğ°ĞµÑ‚ÑÑ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ²Ğ°ÑˆĞ¸Ñ… Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°Ñ… Ğ¸Ğ·-Ğ·Ğ° Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸.
2025-05-30 15:06:40,175 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 15:06:40,175 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 4124, 'output_tokens': 40, 'total_tokens': 4164, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 15:06:40,175 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:4124 C:40 T:4164
2025-05-30 15:06:40,175 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 4164 tokens recorded.
2025-05-30 15:06:40,176 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 15:06:40,176 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 15:06:40,177 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğš ÑĞ¾Ğ¶Ğ°Ğ»ĞµĞ½Ğ¸Ñ, ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ½Ğµ ÑƒĞ´Ğ°ĞµÑ‚ÑÑ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ²Ğ°ÑˆĞ¸Ñ… Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°Ñ… Ğ¸Ğ·-Ğ·Ğ° Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸....
2025-05-30 15:06:40,179 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: c6df5350-fb4d-45b5-87c3-f3396e809f4a)
2025-05-30 15:06:40,179 - INFO - AGENT:agent_airsoft_0faa9616 - Found 3 token usage events for InteractionID: c6df5350-fb4d-45b5-87c3-f3396e809f4a.
2025-05-30 15:38:51,097 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 15:38:51,098 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4669418928) received shutdown request. Initiating graceful shutdown...
2025-05-30 15:38:51,098 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4669418928)...
2025-05-30 15:38:51,098 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 15:38:51,098 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 15:38:51,098 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4669418928) was cancelled.
2025-05-30 15:38:51,098 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4669418928) stopping. Performing cleanup...
2025-05-30 15:38:51,098 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 15:38:51,099 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-30 15:38:51,100 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 15:38:51,100 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 15:38:51,100 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 15:38:51,100 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 15:38:51,100 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 15:38:51,100 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 15:38:51,100 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 15:38:51,104 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 15:38:51,105 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 15:38:51,105 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:38:51,106 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 15:38:51,106 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 15:38:51,106 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 15:38:51,106 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4669418928) cleanup complete.
2025-05-30 15:38:51,106 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 15:38:51,106 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 15:38:51,107 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 15:38:51,107 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 15:38:51,107 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 15:38:51,108 - INFO - __main__ - Agent runner main finished.
2025-05-30 15:41:46,701 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 15:41:46,701 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 15:41:46,707 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 15:41:46,707 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 15:41:46,707 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 15:41:46,707 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 15:41:46,707 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 15:41:46,708 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 15:41:46,708 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 15:41:46,708 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 15:41:46,708 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 15:41:46,708 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 15:41:46,708 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 15:41:46,710 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 15:41:46,710 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 15:41:46,710 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 15:41:46,726 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 15:41:46,726 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 15:41:46,726 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 15:41:46,726 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 15:41:46,728 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 15:41:46,728 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4489446128) setup complete. Starting run loop.
2025-05-30 15:41:46,729 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 15:41:46,729 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 15:41:46,730 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 15:41:46,730 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4489445936) setup complete. Starting run loop.
2025-05-30 15:41:46,730 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 15:41:46,730 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 15:41:46,730 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 15:41:46,765 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 15:41:46,765 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 15:41:46,767 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 15:41:46,768 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 74738
2025-05-30 15:41:46,768 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 74738
2025-05-30 15:41:46,769 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 15:41:46,769 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 15:41:46,769 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 15:41:46,770 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 15:41:46,771 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 74739
2025-05-30 15:41:46,771 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 74739
2025-05-30 15:41:46,772 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 15:41:46,773 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:41:46,773 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 15:41:46,773 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 15:41:46,773 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 15:41:47,657 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 15:41:47,657 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 15:41:47,657 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 15:41:47,657 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 15:41:47,657 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 74739
2025-05-30 15:41:47,657 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 15:41:47,657 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 15:41:47,657 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 15:41:47,664 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 15:41:47,676 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 15:41:47,676 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 15:41:47,676 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 15:41:47,676 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4737394800) setup complete. Starting run loop.
2025-05-30 15:41:47,676 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 15:41:47,676 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 15:41:47,676 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 15:41:47,676 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 15:41:47,677 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 15:41:47,677 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 15:41:47,677 - INFO - aiogram.dispatcher - Start polling
2025-05-30 15:41:47,679 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 15:41:47,922 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 15:41:48,069 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 15:41:48,070 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 15:41:48,070 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 15:41:48,070 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 15:41:48,070 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 74738
2025-05-30 15:41:48,070 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 15:41:48,070 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 15:41:48,070 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 15:41:48,113 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 15:41:48,113 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 15:41:48,155 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 15:41:48,155 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 15:41:48,155 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 15:41:48,155 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 15:41:48,155 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 15:41:48,156 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 15:41:48,181 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 15:41:48,181 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 15:41:48,181 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 15:41:48,182 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 15:41:48,183 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET)
2025-05-30 15:41:48,183 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 15:41:48,183 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 15:41:48,240 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 15:41:48,244 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 15:41:49,132 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 15:41:49,136 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 15:41:49,136 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 15:41:49,136 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 15:41:49,136 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 15:41:49,136 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 15:41:49,136 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 15:41:49,136 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 15:41:49,136 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 15:41:49,137 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 15:41:49,137 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 15:41:49,138 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 15:41:49,138 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 15:41:49,138 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 15:41:49,138 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 15:41:49,138 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 15:41:49,148 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 15:41:49,148 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 15:41:49,148 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 15:41:49,148 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4657133472) setup complete. Starting run loop.
2025-05-30 15:41:49,149 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 15:41:49,149 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 15:41:49,149 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 15:41:49,149 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 15:41:49,151 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 15:41:56,730 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 15:41:56,735 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 15:41:56,735 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4489445696) setup complete. Starting run loop.
2025-05-30 15:41:56,735 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 15:42:08,788 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 15:42:08,787 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 15:42:08,788 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4657133472) received shutdown request. Initiating graceful shutdown...
2025-05-30 15:42:08,788 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4657133472)...
2025-05-30 15:42:08,788 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 15:42:08,788 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 15:42:08,788 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4657133472) was cancelled.
2025-05-30 15:42:08,788 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4657133472) stopping. Performing cleanup...
2025-05-30 15:42:08,788 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 15:42:08,788 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 15:42:08,788 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 15:42:08,789 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 0) on start/restart.
2025-05-30 15:42:08,789 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 15:42:08,789 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 15:42:08,789 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 15:42:08,790 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 15:42:08,790 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 15:42:08,790 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 15:42:08,790 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 15:42:08,794 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 15:42:08,795 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 15:42:08,795 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:42:08,795 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 15:42:08,795 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 15:42:08,795 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 15:42:08,795 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4657133472) cleanup complete.
2025-05-30 15:42:08,795 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 15:42:08,795 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 15:42:08,796 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 15:42:08,796 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 15:42:08,796 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 15:42:08,796 - INFO - __main__ - Agent runner main finished.
2025-05-30 15:42:08,928 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 15:42:08,928 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 15:42:08,928 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 15:42:08,928 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4489446128) was cancelled.
2025-05-30 15:42:08,928 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4489446128) stopping. Performing cleanup...
2025-05-30 15:42:08,928 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:42:08,932 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 15:42:08,933 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 15:42:08,933 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:42:08,933 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 15:42:08,933 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:42:08,933 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4489446128) cleanup complete.
2025-05-30 15:42:08,934 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 15:42:08,934 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 15:42:08,934 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4489445936) was cancelled.
2025-05-30 15:42:08,934 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4489445936) stopping. Performing cleanup...
2025-05-30 15:42:08,934 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:42:08,936 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 15:42:08,937 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 15:42:08,937 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:42:08,938 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 15:42:08,938 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:42:08,938 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4489445936) cleanup complete.
2025-05-30 15:42:08,938 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 15:42:08,938 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 15:42:08,938 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4489445696) was cancelled.
2025-05-30 15:42:08,938 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4489445696) stopping. Performing cleanup...
2025-05-30 15:42:08,938 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 15:42:08,938 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:42:08,938 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 15:42:08,938 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 15:42:08,938 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:42:08,940 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 15:42:08,941 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 15:42:08,941 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:42:08,941 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 15:42:08,941 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:42:08,941 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 15:42:08,941 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4489445696) cleanup complete.
2025-05-30 15:42:08,941 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 15:42:08,941 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 15:42:08,941 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 15:42:08,943 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 15:42:08,943 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 15:42:09,039 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 15:42:09,040 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 15:42:09,040 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 15:42:09,040 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4737394800) received shutdown request. Initiating graceful shutdown...
2025-05-30 15:42:09,040 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4737394800)...
2025-05-30 15:42:09,040 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 15:42:09,040 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 15:42:09,040 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4737394800) was cancelled.
2025-05-30 15:42:09,040 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4737394800) stopping. Performing cleanup...
2025-05-30 15:42:09,040 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 15:42:09,040 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 15:42:09,040 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 15:42:09,040 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 15:42:09,040 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 15:42:09,040 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 15:42:09,040 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 15:42:09,040 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 15:42:09,040 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 15:42:09,040 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 15:42:09,044 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 15:42:09,045 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 15:42:09,045 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:42:09,045 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 15:42:09,045 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 15:42:09,045 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 15:42:09,045 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4737394800) cleanup complete.
2025-05-30 15:42:09,045 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 15:42:09,045 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 15:42:09,045 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 15:42:09,045 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 15:42:09,045 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 15:42:09,046 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 15:42:13,391 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 15:42:13,391 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 15:42:13,395 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 15:42:13,395 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 15:42:13,395 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 15:42:13,395 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 15:42:13,395 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 15:42:13,396 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 15:42:13,396 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 15:42:13,396 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 15:42:13,396 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 15:42:13,396 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 15:42:13,396 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 15:42:13,398 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 15:42:13,412 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 15:42:13,412 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 15:42:13,412 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 15:42:13,412 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 15:42:13,412 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 15:42:13,412 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 15:42:13,415 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 15:42:13,415 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 15:42:13,415 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4581137568) setup complete. Starting run loop.
2025-05-30 15:42:13,415 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 15:42:13,416 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 15:42:13,416 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4647782112) setup complete. Starting run loop.
2025-05-30 15:42:13,416 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 15:42:13,417 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 15:42:13,417 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 15:42:13,446 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 15:42:13,446 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 15:42:13,448 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 15:42:13,449 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 74875
2025-05-30 15:42:13,449 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 74875
2025-05-30 15:42:13,449 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 15:42:13,449 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 15:42:13,449 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 15:42:13,451 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 15:42:13,451 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 74876
2025-05-30 15:42:13,451 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 74876
2025-05-30 15:42:13,452 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 15:42:13,453 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:42:13,453 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 15:42:13,453 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 15:42:13,453 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 15:42:14,299 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 15:42:14,299 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 15:42:14,299 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 15:42:14,299 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 15:42:14,300 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 74876
2025-05-30 15:42:14,300 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 15:42:14,300 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 15:42:14,300 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 15:42:14,305 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 15:42:14,318 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 15:42:14,318 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 15:42:14,318 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 15:42:14,318 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4430325536) setup complete. Starting run loop.
2025-05-30 15:42:14,318 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 15:42:14,318 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 15:42:14,318 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 15:42:14,318 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 15:42:14,318 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 15:42:14,318 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 15:42:14,318 - INFO - aiogram.dispatcher - Start polling
2025-05-30 15:42:14,321 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 15:42:14,571 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 15:42:14,593 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 15:42:14,594 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 15:42:14,594 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 15:42:14,594 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 15:42:14,594 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 74875
2025-05-30 15:42:14,594 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 15:42:14,594 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 15:42:14,594 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 15:42:14,637 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 15:42:14,637 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 15:42:14,677 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 15:42:14,677 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 15:42:14,677 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 15:42:14,677 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 15:42:14,677 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 15:42:14,677 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 15:42:14,702 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 15:42:14,702 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 15:42:14,702 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 15:42:14,704 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 15:42:14,704 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET)
2025-05-30 15:42:14,704 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 15:42:14,704 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 15:42:14,759 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 15:42:14,763 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 15:42:15,372 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 15:42:15,375 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 15:42:15,376 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 15:42:15,376 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 15:42:15,376 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 15:42:15,376 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 15:42:15,376 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 15:42:15,376 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 15:42:15,376 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 15:42:15,376 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 15:42:15,377 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 15:42:15,377 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 15:42:15,377 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 15:42:15,377 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 15:42:15,377 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 15:42:15,377 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 15:42:15,388 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 15:42:15,388 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 15:42:15,388 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 15:42:15,388 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4645565744) setup complete. Starting run loop.
2025-05-30 15:42:15,388 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 15:42:15,388 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 15:42:15,388 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 15:42:15,388 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 15:42:15,392 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 15:42:23,417 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 15:42:23,421 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 15:42:23,421 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4647781920) setup complete. Starting run loop.
2025-05-30 15:42:23,421 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 15:43:37,173 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - User 144641834 (ChatID: 144641834) triggered /start for agent agent_airsoft_0faa9616
2025-05-30 15:43:37,501 - INFO - aiogram.event - Update id=804756332 is handled. Duration 327 ms by bot id=1750613938
2025-05-30 15:43:51,394 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñƒ Ğ¼ĞµĞ½Ñ Ğ±Ğ±?...'
2025-05-30 15:43:51,396 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 15:43:51,433 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 15:43:51,433 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 15:43:51,433 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 15:43:51,434 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 77d32b1e-7779-40ae-a75c-971928cda2f9)
2025-05-30 15:43:51,434 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 15:43:51,434 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-30 15:43:51,457 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 77d32b1e-7779-40ae-a75c-971928cda2f9, db_id: 979
2025-05-30 15:43:51,471 - INFO - AGENT:agent_airsoft_0faa9616 - Loaded 20 messages from DB for thread '144641834'.
2025-05-30 15:43:51,472 - INFO - AGENT:agent_airsoft_0faa9616 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-30 15:43:51,472 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-30 15:43:51,537 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 15:43:51,538 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 15:43:51,563 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 15:43:51,566 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 15:43:52,434 - INFO - aiogram.event - Update id=804756333 is handled. Duration 1040 ms by bot id=1750613938
2025-05-30 15:43:53,088 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 15:43:53,134 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 15:43:53,134 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 15:43:53,134 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 982, 'output_tokens': 16, 'total_tokens': 998, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 15:43:53,134 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:982 C:16 T:998
2025-05-30 15:43:53,134 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 998 tokens recorded.
2025-05-30 15:43:53,135 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 15:43:53,135 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748589354598
2025-05-30 15:43:53,135 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748589354598)---
2025-05-30 15:43:53,137 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹'
2025-05-30 15:43:53,137 - INFO - app.agent_runner.common.tools_registry - Function parameters: api_config=True, log_adapter=True, state=True
2025-05-30 15:43:53,137 - INFO - app.agent_runner.common.tools_registry - State type: <class 'dict'>
2025-05-30 15:43:53,137 - INFO - app.agent_runner.common.tools_registry - State keys: ['messages', 'documents', 'question', 'original_question', 'rewrite_count', 'channel', 'user_data', 'token_usage_events']
2025-05-30 15:43:53,137 - INFO - app.agent_runner.common.tools_registry - User data extracted: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 15:43:53,137 - INFO - app.agent_runner.common.tools_registry - Final user_data for API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹': {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 15:43:53,137 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 15:43:53,137 - INFO - app.agent_runner.common.tools_registry - Headers type: <class 'dict'>, value: {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36', 'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7', 'Accept-Language': 'ru-RU,ru;q=0.9,en;q=0.8', 'Accept-Encoding': 'gzip, deflate, br', 'DNT': '1', 'Connection': 'keep-alive', 'Upgrade-Insecure-Requests': '1', 'Sec-Fetch-Dest': 'document', 'Sec-Fetch-Mode': 'navigate', 'Sec-Fetch-Site': 'same-origin', 'Sec-Fetch-User': '?1', 'Cache-Control': 'max-age=0', 'Referer': 'https://airsoft-rus.ru/', 'Cookie': 'PHPSESSID=gq3cMIY4z4t5OLt12aMMcFrus6CEIhZR'}
2025-05-30 15:43:53,137 - INFO - app.agent_runner.common.tools_registry - Query Params: {'type': 'info', 'tel': '79222088435'}
2025-05-30 15:43:53,137 - INFO - app.agent_runner.common.tools_registry - Attempting Cloudflare bypass with cloudscraper for https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 15:43:53,528 - INFO - app.agent_runner.common.tools_registry - Cloudscraper request successful with status 200
2025-05-30 15:43:53,530 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 15:43:53,531 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 15:43:53,554 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 15:43:53,557 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 15:43:54,517 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 15:43:55,308 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğµ, Ñ‡Ñ‚Ğ¾ ÑĞ½Ğ¾Ğ²Ğ° Ğ²Ğ¾Ğ·Ğ½Ğ¸ĞºĞ»Ğ° Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾ Ñ‚Ğ²Ğ¾Ğ¸Ñ… Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°Ñ…. ĞÑ‡ĞµĞ½ÑŒ Ğ¶Ğ°Ğ»ÑŒ! ĞœĞ¾Ğ¶
2025-05-30 15:43:55,308 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 15:43:55,308 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1017, 'output_tokens': 51, 'total_tokens': 1068, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 15:43:55,308 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1017 C:51 T:1068
2025-05-30 15:43:55,308 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1068 tokens recorded.
2025-05-30 15:43:55,309 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 15:43:55,309 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 15:43:55,310 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğµ, Ñ‡Ñ‚Ğ¾ ÑĞ½Ğ¾Ğ²Ğ° Ğ²Ğ¾Ğ·Ğ½Ğ¸ĞºĞ»Ğ° Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾ Ñ‚Ğ²Ğ¾Ğ¸Ñ… Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°Ñ…. ĞÑ‡ĞµĞ½ÑŒ Ğ¶Ğ°Ğ»ÑŒ! ĞœĞ¾Ğ¶...
2025-05-30 15:43:55,311 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 77d32b1e-7779-40ae-a75c-971928cda2f9)
2025-05-30 15:43:55,312 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: 77d32b1e-7779-40ae-a75c-971928cda2f9.
2025-05-30 15:43:55,313 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğµ, Ñ‡Ñ‚Ğ¾ ÑĞ½Ğ¾Ğ²Ğ° Ğ²Ğ¾Ğ·Ğ½Ğ¸ĞºĞ»Ğ° Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾ Ñ‚Ğ²Ğ¾Ğ¸Ñ… Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°Ñ…. ĞÑ‡ĞµĞ½ÑŒ Ğ¶Ğ°Ğ»ÑŒ! ĞœĞ¾Ğ¶...
2025-05-30 15:43:55,313 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğµ, Ñ‡Ñ‚Ğ¾ ÑĞ½Ğ¾Ğ²Ğ° Ğ²Ğ¾Ğ·Ğ½Ğ¸ĞºĞ»Ğ° Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸ĞµĞ¼ Ğ¸...'
2025-05-30 15:43:55,314 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '77d32b1e-7779-40ae-a75c-971928cda2f9', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 982, 'completion_tokens': 16, 'total_tokens': 998, 'timestamp': '2025-05-30T10:43:53.134549+00:00'}
2025-05-30 15:43:55,314 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 77d32b1e-7779-40ae-a75c-971928cda2f9
2025-05-30 15:43:55,319 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 77d32b1e-7779-40ae-a75c-971928cda2f9, db_id: 980
2025-05-30 15:43:55,346 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 980 for interaction_id: 77d32b1e-7779-40ae-a75c-971928cda2f9 on attempt 1
2025-05-30 15:43:55,352 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 77d32b1e-7779-40ae-a75c-971928cda2f9, db_id: 448
2025-05-30 15:43:55,355 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '77d32b1e-7779-40ae-a75c-971928cda2f9', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1017, 'completion_tokens': 51, 'total_tokens': 1068, 'timestamp': '2025-05-30T10:43:55.308358+00:00'}
2025-05-30 15:43:55,355 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 77d32b1e-7779-40ae-a75c-971928cda2f9
2025-05-30 15:43:55,356 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 980 for interaction_id: 77d32b1e-7779-40ae-a75c-971928cda2f9 on attempt 1
2025-05-30 15:43:55,359 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 77d32b1e-7779-40ae-a75c-971928cda2f9, db_id: 449
2025-05-30 15:44:59,976 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 15:44:59,976 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 15:44:59,976 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 15:44:59,976 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4581137568) was cancelled.
2025-05-30 15:44:59,976 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4581137568) stopping. Performing cleanup...
2025-05-30 15:44:59,976 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:44:59,980 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 15:44:59,981 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 15:44:59,981 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:44:59,981 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 15:44:59,981 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:44:59,981 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4581137568) cleanup complete.
2025-05-30 15:44:59,981 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 15:44:59,981 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 15:44:59,981 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4647782112) was cancelled.
2025-05-30 15:44:59,981 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4647782112) stopping. Performing cleanup...
2025-05-30 15:44:59,981 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:44:59,984 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 15:44:59,985 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 15:44:59,985 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:44:59,985 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 15:44:59,985 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:44:59,985 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4647782112) cleanup complete.
2025-05-30 15:44:59,985 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 15:44:59,985 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 15:44:59,985 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4647781920) was cancelled.
2025-05-30 15:44:59,985 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4647781920) stopping. Performing cleanup...
2025-05-30 15:44:59,985 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 15:44:59,985 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:44:59,985 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 15:44:59,985 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 15:44:59,985 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:44:59,987 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 15:44:59,988 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 15:44:59,988 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:44:59,988 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 15:44:59,988 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:44:59,988 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 15:44:59,988 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4647781920) cleanup complete.
2025-05-30 15:44:59,988 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 15:44:59,988 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 15:44:59,988 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 15:44:59,993 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 15:44:59,993 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 15:45:00,451 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 15:45:00,451 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 15:45:00,456 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 15:45:00,456 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 15:45:00,456 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 15:45:00,456 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 15:45:00,456 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 15:45:00,456 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 15:45:00,456 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 15:45:00,456 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 15:45:00,457 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 15:45:00,457 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 15:45:00,457 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 15:45:00,459 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 15:45:00,474 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 15:45:00,474 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 15:45:00,474 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 15:45:00,474 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 15:45:00,474 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 15:45:00,474 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 15:45:00,476 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 15:45:00,476 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 15:45:00,476 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4601533728) setup complete. Starting run loop.
2025-05-30 15:45:00,476 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 15:45:00,477 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 15:45:00,477 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4601919440) setup complete. Starting run loop.
2025-05-30 15:45:00,477 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 15:45:00,478 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 15:45:00,478 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 15:45:00,506 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 15:45:00,506 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 15:45:00,507 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 15:45:00,507 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 15:45:00,507 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 15:45:00,508 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 15:45:00,509 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:45:00,509 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 15:45:00,509 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 15:45:00,509 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 15:45:10,480 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 15:45:10,484 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 15:45:10,484 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4601919488) setup complete. Starting run loop.
2025-05-30 15:45:10,484 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 15:46:13,759 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 15:46:13,759 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 15:46:13,759 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 15:46:13,759 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4601533728) was cancelled.
2025-05-30 15:46:13,759 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4601533728) stopping. Performing cleanup...
2025-05-30 15:46:13,759 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:46:13,764 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 15:46:13,765 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 15:46:13,765 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:46:13,765 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 15:46:13,765 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:46:13,765 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4601533728) cleanup complete.
2025-05-30 15:46:13,765 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 15:46:13,766 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 15:46:13,766 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4601919440) was cancelled.
2025-05-30 15:46:13,766 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4601919440) stopping. Performing cleanup...
2025-05-30 15:46:13,766 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:46:13,769 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 15:46:13,770 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 15:46:13,770 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:46:13,770 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 15:46:13,770 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:46:13,770 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4601919440) cleanup complete.
2025-05-30 15:46:13,770 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 15:46:13,770 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 15:46:13,770 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4601919488) was cancelled.
2025-05-30 15:46:13,770 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4601919488) stopping. Performing cleanup...
2025-05-30 15:46:13,770 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 15:46:13,770 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:46:13,771 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 15:46:13,771 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 15:46:13,771 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:46:13,773 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 15:46:13,774 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 15:46:13,774 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:46:13,774 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 15:46:13,774 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:46:13,774 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 15:46:13,774 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4601919488) cleanup complete.
2025-05-30 15:46:13,774 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 15:46:13,774 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 15:46:13,774 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 15:46:13,778 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 15:46:13,778 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 15:46:14,247 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 15:46:14,247 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 15:46:14,251 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 15:46:14,251 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 15:46:14,251 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 15:46:14,251 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 15:46:14,251 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 15:46:14,251 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 15:46:14,251 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 15:46:14,251 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 15:46:14,252 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 15:46:14,252 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 15:46:14,252 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 15:46:14,254 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 15:46:14,270 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 15:46:14,270 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 15:46:14,271 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 15:46:14,271 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 15:46:14,271 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 15:46:14,271 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 15:46:14,273 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 15:46:14,273 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4409187488) setup complete. Starting run loop.
2025-05-30 15:46:14,273 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 15:46:14,273 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 15:46:14,273 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 15:46:14,273 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4412900320) setup complete. Starting run loop.
2025-05-30 15:46:14,273 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 15:46:14,275 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 15:46:14,275 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 15:46:14,305 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 15:46:14,305 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 15:46:14,306 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 15:46:14,306 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 15:46:14,306 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 15:46:14,307 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 15:46:14,308 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:46:14,308 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 15:46:14,308 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 15:46:14,308 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 15:46:24,275 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 15:46:24,279 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 15:46:24,279 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4412900032) setup complete. Starting run loop.
2025-05-30 15:46:24,279 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 15:50:58,445 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 15:50:58,445 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 15:50:58,445 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 15:50:58,445 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4409187488) was cancelled.
2025-05-30 15:50:58,445 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4409187488) stopping. Performing cleanup...
2025-05-30 15:50:58,445 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:50:58,449 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 15:50:58,450 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 15:50:58,450 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:50:58,450 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 15:50:58,450 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:50:58,450 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4409187488) cleanup complete.
2025-05-30 15:50:58,450 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 15:50:58,450 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 15:50:58,450 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4412900320) was cancelled.
2025-05-30 15:50:58,450 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4412900320) stopping. Performing cleanup...
2025-05-30 15:50:58,450 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:50:58,453 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 15:50:58,454 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 15:50:58,454 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:50:58,455 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 15:50:58,455 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:50:58,455 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4412900320) cleanup complete.
2025-05-30 15:50:58,455 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 15:50:58,455 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 15:50:58,455 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4412900032) was cancelled.
2025-05-30 15:50:58,455 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4412900032) stopping. Performing cleanup...
2025-05-30 15:50:58,455 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 15:50:58,455 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:50:58,455 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 15:50:58,455 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 15:50:58,455 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:50:58,457 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 15:50:58,458 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 15:50:58,458 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:50:58,458 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 15:50:58,458 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:50:58,458 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 15:50:58,458 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4412900032) cleanup complete.
2025-05-30 15:50:58,458 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 15:50:58,458 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 15:50:58,458 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 15:50:58,461 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 15:50:58,461 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 15:50:58,937 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 15:50:58,937 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 15:50:58,942 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 15:50:58,942 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 15:50:58,942 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 15:50:58,942 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 15:50:58,942 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 15:50:58,942 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 15:50:58,942 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 15:50:58,942 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 15:50:58,942 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 15:50:58,943 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 15:50:58,943 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 15:50:58,945 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 15:50:58,961 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 15:50:58,961 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 15:50:58,961 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 15:50:58,961 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 15:50:58,962 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 15:50:58,962 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 15:50:58,963 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 15:50:58,963 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4719123616) setup complete. Starting run loop.
2025-05-30 15:50:58,963 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 15:50:58,963 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 15:50:58,963 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 15:50:58,963 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4733008208) setup complete. Starting run loop.
2025-05-30 15:50:58,963 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 15:50:58,975 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 15:50:58,975 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 15:50:58,995 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 15:50:58,995 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 15:50:58,996 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 15:50:58,996 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 15:50:58,996 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 15:50:58,997 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 15:50:58,998 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:50:58,998 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 15:50:58,998 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 15:50:58,998 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 15:51:01,444 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 15:51:01,445 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4645565744) received shutdown request. Initiating graceful shutdown...
2025-05-30 15:51:01,445 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4645565744)...
2025-05-30 15:51:01,445 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 15:51:01,445 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 15:51:01,445 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 15:51:01,445 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4645565744) was cancelled.
2025-05-30 15:51:01,445 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4645565744) stopping. Performing cleanup...
2025-05-30 15:51:01,445 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 15:51:01,445 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 15:51:01,445 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 15:51:01,446 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-30 15:51:01,446 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 15:51:01,446 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 15:51:01,446 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 15:51:01,446 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 15:51:01,447 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 15:51:01,447 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 15:51:01,447 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 15:51:01,456 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 15:51:01,458 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 15:51:01,458 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:51:01,460 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 15:51:01,461 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 15:51:01,461 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 15:51:01,461 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4645565744) cleanup complete.
2025-05-30 15:51:01,461 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 15:51:01,461 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 15:51:01,471 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 15:51:01,471 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 15:51:01,471 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 15:51:01,475 - INFO - __main__ - Agent runner main finished.
2025-05-30 15:51:01,616 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 15:51:01,617 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 15:51:01,617 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 15:51:01,617 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4719123616) was cancelled.
2025-05-30 15:51:01,617 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4719123616) stopping. Performing cleanup...
2025-05-30 15:51:01,617 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:51:01,622 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 15:51:01,622 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 15:51:01,623 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:51:01,623 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 15:51:01,623 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:51:01,623 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4719123616) cleanup complete.
2025-05-30 15:51:01,623 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 15:51:01,623 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 15:51:01,623 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4733008208) was cancelled.
2025-05-30 15:51:01,623 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4733008208) stopping. Performing cleanup...
2025-05-30 15:51:01,623 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:51:01,626 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 15:51:01,626 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 15:51:01,626 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:51:01,627 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 15:51:01,627 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:51:01,627 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4733008208) cleanup complete.
2025-05-30 15:51:01,627 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 15:51:01,627 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 15:51:01,627 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4733008256) was cancelled.
2025-05-30 15:51:01,627 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4733008256) stopping. Performing cleanup...
2025-05-30 15:51:01,627 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 15:51:01,627 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:51:01,627 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 15:51:01,627 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 15:51:01,627 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:51:01,629 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 15:51:01,629 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 15:51:01,629 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:51:01,629 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 15:51:01,629 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:51:01,629 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 15:51:01,629 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4733008256) cleanup complete.
2025-05-30 15:51:01,629 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 15:51:01,629 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 15:51:01,630 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 15:51:01,632 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 15:51:01,632 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 15:51:01,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 15:51:01,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 15:51:01,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 15:51:01,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4430325536) received shutdown request. Initiating graceful shutdown...
2025-05-30 15:51:01,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4430325536)...
2025-05-30 15:51:01,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 15:51:01,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 15:51:01,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4430325536) was cancelled.
2025-05-30 15:51:01,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4430325536) stopping. Performing cleanup...
2025-05-30 15:51:01,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 15:51:01,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 15:51:01,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 15:51:01,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 15:51:01,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 15:51:01,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 15:51:01,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 15:51:01,698 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 15:51:01,698 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 15:51:01,698 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 15:51:01,702 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 15:51:01,703 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 15:51:01,703 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:51:01,703 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 15:51:01,703 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 15:51:01,703 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 15:51:01,703 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4430325536) cleanup complete.
2025-05-30 15:51:01,703 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 15:51:01,703 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 15:51:01,707 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 15:51:01,708 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 15:51:01,708 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 15:51:01,708 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 15:51:07,065 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 15:51:07,065 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 15:51:07,069 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 15:51:07,069 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 15:51:07,069 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 15:51:07,069 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 15:51:07,069 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 15:51:07,069 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 15:51:07,069 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 15:51:07,069 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 15:51:07,070 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 15:51:07,070 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 15:51:07,070 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 15:51:07,072 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 15:51:07,072 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 15:51:07,072 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 15:51:07,087 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 15:51:07,087 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 15:51:07,087 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 15:51:07,087 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 15:51:07,089 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 15:51:07,089 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 15:51:07,089 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4451206400) setup complete. Starting run loop.
2025-05-30 15:51:07,089 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 15:51:07,090 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 15:51:07,090 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4451206208) setup complete. Starting run loop.
2025-05-30 15:51:07,090 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 15:51:07,091 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 15:51:07,091 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 15:51:07,120 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 15:51:07,120 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 15:51:07,121 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 15:51:07,122 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 75287
2025-05-30 15:51:07,122 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 75287
2025-05-30 15:51:07,123 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 15:51:07,123 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 15:51:07,123 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 15:51:07,125 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 15:51:07,125 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 75288
2025-05-30 15:51:07,125 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 75288
2025-05-30 15:51:07,126 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 15:51:07,127 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:51:07,127 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 15:51:07,127 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 15:51:07,127 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 15:51:08,051 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 15:51:08,052 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 15:51:08,052 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 15:51:08,052 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 15:51:08,052 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 75288
2025-05-30 15:51:08,052 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 15:51:08,052 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 15:51:08,052 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 15:51:08,058 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 15:51:08,072 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 15:51:08,072 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 15:51:08,072 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 15:51:08,072 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4666091824) setup complete. Starting run loop.
2025-05-30 15:51:08,072 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 15:51:08,072 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 15:51:08,072 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 15:51:08,072 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 15:51:08,072 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 15:51:08,072 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 15:51:08,072 - INFO - aiogram.dispatcher - Start polling
2025-05-30 15:51:08,075 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 15:51:08,323 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 15:51:08,404 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 15:51:08,405 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 15:51:08,405 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 15:51:08,405 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 15:51:08,405 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 75287
2025-05-30 15:51:08,405 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 15:51:08,405 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 15:51:08,405 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 15:51:08,447 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 15:51:08,447 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 15:51:08,490 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 15:51:08,490 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 15:51:08,491 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 15:51:08,491 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 15:51:08,491 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 15:51:08,491 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 15:51:08,516 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 15:51:08,517 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 15:51:08,517 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 15:51:08,518 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 15:51:08,518 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET)
2025-05-30 15:51:08,518 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 15:51:08,518 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 15:51:08,574 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 15:51:08,577 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 15:51:09,406 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 15:51:09,408 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 15:51:09,408 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 15:51:09,408 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 15:51:09,409 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 15:51:09,409 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 15:51:09,409 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 15:51:09,409 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 15:51:09,409 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 15:51:09,409 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 15:51:09,409 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 15:51:09,410 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 15:51:09,410 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 15:51:09,410 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 15:51:09,410 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 15:51:09,410 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 15:51:09,420 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 15:51:09,420 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 15:51:09,420 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 15:51:09,420 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4835062656) setup complete. Starting run loop.
2025-05-30 15:51:09,420 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 15:51:09,420 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 15:51:09,420 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 15:51:09,420 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 15:51:09,423 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 15:51:17,091 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 15:51:17,098 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 15:51:17,098 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4451206352) setup complete. Starting run loop.
2025-05-30 15:51:17,098 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 15:51:34,980 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'ĞšĞ°ĞºĞ¾Ğ¹ Ñƒ Ğ¼ĞµĞ½Ñ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²?...'
2025-05-30 15:51:34,981 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache miss for user 144641834, agent agent_airsoft_0faa9616. Checking DB.
2025-05-30 15:51:35,055 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - User 144641834 (DBID: 1) IS authorized for agent agent_airsoft_0faa9616 via DB.
2025-05-30 15:51:35,060 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 15:51:35,060 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 15:51:35,060 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 15:51:35,061 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: e973735e-bfc3-4535-85ea-d439c050ab59)
2025-05-30 15:51:35,061 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 15:51:35,061 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-30 15:51:35,082 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: e973735e-bfc3-4535-85ea-d439c050ab59, db_id: 981
2025-05-30 15:51:35,097 - INFO - AGENT:agent_airsoft_0faa9616 - Loaded 20 messages from DB for thread '144641834'.
2025-05-30 15:51:35,097 - INFO - AGENT:agent_airsoft_0faa9616 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-30 15:51:35,097 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-30 15:51:35,165 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 15:51:35,165 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 15:51:35,190 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 15:51:35,193 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 15:51:36,061 - INFO - aiogram.event - Update id=804756334 is handled. Duration 1081 ms by bot id=1750613938
2025-05-30 15:51:36,165 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 15:51:36,192 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 15:51:36,192 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 15:51:36,192 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1009, 'output_tokens': 16, 'total_tokens': 1025, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 15:51:36,192 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1009 C:16 T:1025
2025-05-30 15:51:36,192 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1025 tokens recorded.
2025-05-30 15:51:36,193 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 15:51:36,193 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748589354598
2025-05-30 15:51:36,193 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748589354598)---
2025-05-30 15:51:36,195 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹'
2025-05-30 15:51:36,195 - INFO - app.agent_runner.common.tools_registry - Function parameters: api_config=True, log_adapter=True, state=True
2025-05-30 15:51:36,195 - INFO - app.agent_runner.common.tools_registry - State type: <class 'dict'>
2025-05-30 15:51:36,195 - INFO - app.agent_runner.common.tools_registry - State keys: ['messages', 'documents', 'question', 'original_question', 'rewrite_count', 'channel', 'user_data', 'token_usage_events']
2025-05-30 15:51:36,195 - INFO - app.agent_runner.common.tools_registry - User data extracted: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 15:51:36,195 - INFO - app.agent_runner.common.tools_registry - Final user_data for API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹': {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 15:51:36,195 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 15:51:36,195 - INFO - app.agent_runner.common.tools_registry - Headers type: <class 'dict'>, value: {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36', 'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7', 'Accept-Language': 'ru-RU,ru;q=0.9,en;q=0.8', 'Accept-Encoding': 'gzip, deflate, br', 'DNT': '1', 'Connection': 'keep-alive', 'Upgrade-Insecure-Requests': '1', 'Sec-Fetch-Dest': 'document', 'Sec-Fetch-Mode': 'navigate', 'Sec-Fetch-Site': 'same-origin', 'Sec-Fetch-User': '?1', 'Cache-Control': 'max-age=0', 'Referer': 'https://airsoft-rus.ru/', 'Cookie': 'PHPSESSID=gq3cMIY4z4t5OLt12aMMcFrus6CEIhZR'}
2025-05-30 15:51:36,195 - INFO - app.agent_runner.common.tools_registry - Query Params: {'type': 'info', 'tel': '79222088435'}
2025-05-30 15:51:36,195 - INFO - app.agent_runner.common.tools_registry - Attempting Cloudflare bypass with cloudscraper for https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 15:51:36,852 - INFO - app.agent_runner.common.tools_registry - Cloudscraper request successful with status 200
2025-05-30 15:51:36,852 - INFO - app.agent_runner.common.tools_registry - API Response Status: 200
2025-05-30 15:51:36,852 - INFO - app.agent_runner.common.tools_registry - API Response Headers: {'Date': 'Fri, 30 May 2025 10:51:36 GMT', 'Content-Type': 'text/html; charset=UTF-8', 'Transfer-Encoding': 'chunked', 'Connection': 'keep-alive', 'Server': 'cloudflare', 'Nel': '{"success_fraction":0,"report_to":"cf-nel","max_age":604800}', 'Cf-Ray': '947dad61cc51665b-AMS', 'Vary': 'HTTPS', 'X-Powered-By': 'PHP/7.3.33', 'P3p': 'policyref="/bitrix/p3p.xml", CP="NON DSP COR CUR ADM DEV PSA PSD OUR UNR BUS UNI COM NAV INT DEM STA"', 'X-Powered-Cms': 'Bitrix Site Manager (16899fb15b29f3b6cb9157e0b568ff46)', 'Expires': 'Thu, 19 Nov 1981 08:52:00 GMT', 'Cache-Control': 'no-store, no-cache, must-revalidate', 'Pragma': 'no-cache', 'X-Frame-Options': 'SAMEORIGIN', 'Content-Encoding': 'br', 'Permissions-Policy': 'browsing-topics=()', 'Strict-Transport-Security': ': max-age=3600', 'Cf-Cache-Status': 'DYNAMIC', 'Report-To': '{"endpoints":[{"url":"https:\\/\\/a.nel.cloudflare.com\\/report\\/v4?s=flBwb%2BrECsWIPuBNh2YS3kFesuf3Sk3tHhWPH%2BRrTMhRem8uBplqdwbXBHOtXDbWt1B9i7QeM%2FbVhyt0WoYtYZ4B5WAyEmeVskGKirLsHDWukaLPhEdNTKlfFRX5ZKVj"}],"group":"cf-nel","max_age":604800}', 'Set-Cookie': 'PHPSESSID=7IAlIWh4ZG1tSsH5AIKi9b0B9E8TeS8K; HttpOnly; Secure; Path=/', 'server-timing': 'cfL4;desc="?proto=TCP&rtt=111980&min_rtt=111224&rtt_var=42249&sent=5&recv=6&lost=0&retrans=0&sent_bytes=2882&recv_bytes=1326&delivery_rate=36359&cwnd=252&unsent_bytes=0&cid=754d92300b9490e5&ts=375&x=0"'}
2025-05-30 15:51:36,852 - INFO - app.agent_runner.common.tools_registry - API Response Content-Type: text/html; charset=UTF-8
2025-05-30 15:51:36,852 - INFO - app.agent_runner.common.tools_registry - API Response Content Length: 7 bytes
2025-05-30 15:51:36,852 - INFO - app.agent_runner.common.tools_registry - API Response Content Preview (first 1000 chars): ï¿½574
2025-05-30 15:51:36,852 - WARNING - app.agent_runner.common.tools_registry - Failed to parse JSON response: Expecting value: line 1 column 1 (char 0)
2025-05-30 15:51:36,852 - INFO - app.agent_runner.common.tools_registry - Returning raw text response
2025-05-30 15:51:36,854 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 15:51:36,854 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 15:51:36,878 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 15:51:36,881 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 15:51:37,837 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 15:51:38,795 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ•Ğ²Ğ³ĞµĞ½Ğ¸Ğ¹, Ğº ÑĞ¾Ğ¶Ğ°Ğ»ĞµĞ½Ğ¸Ñ, ÑĞµĞ¹Ñ‡Ğ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¸Ñ‚ÑŒ Ñ‚Ğ²Ğ¾Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² Ğ¸Ğ·-Ğ·Ğ°
2025-05-30 15:51:38,795 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 15:51:38,795 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1044, 'output_tokens': 60, 'total_tokens': 1104, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 15:51:38,795 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1044 C:60 T:1104
2025-05-30 15:51:38,796 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1104 tokens recorded.
2025-05-30 15:51:38,797 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 15:51:38,797 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 15:51:38,798 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ•Ğ²Ğ³ĞµĞ½Ğ¸Ğ¹, Ğº ÑĞ¾Ğ¶Ğ°Ğ»ĞµĞ½Ğ¸Ñ, ÑĞµĞ¹Ñ‡Ğ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¸Ñ‚ÑŒ Ñ‚Ğ²Ğ¾Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² Ğ¸Ğ·-Ğ·Ğ°...
2025-05-30 15:51:38,799 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: e973735e-bfc3-4535-85ea-d439c050ab59)
2025-05-30 15:51:38,800 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: e973735e-bfc3-4535-85ea-d439c050ab59.
2025-05-30 15:51:38,801 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Ğ•Ğ²Ğ³ĞµĞ½Ğ¸Ğ¹, Ğº ÑĞ¾Ğ¶Ğ°Ğ»ĞµĞ½Ğ¸Ñ, ÑĞµĞ¹Ñ‡Ğ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¸Ñ‚ÑŒ Ñ‚Ğ²Ğ¾Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² Ğ¸Ğ·-Ğ·Ğ°...
2025-05-30 15:51:38,802 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Ğ•Ğ²Ğ³ĞµĞ½Ğ¸Ğ¹, Ğº ÑĞ¾Ğ¶Ğ°Ğ»ĞµĞ½Ğ¸Ñ, ÑĞµĞ¹Ñ‡Ğ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ ĞºĞ¾Ñ€Ñ€...'
2025-05-30 15:51:38,802 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'e973735e-bfc3-4535-85ea-d439c050ab59', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1009, 'completion_tokens': 16, 'total_tokens': 1025, 'timestamp': '2025-05-30T10:51:36.192917+00:00'}
2025-05-30 15:51:38,802 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: e973735e-bfc3-4535-85ea-d439c050ab59
2025-05-30 15:51:38,807 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: e973735e-bfc3-4535-85ea-d439c050ab59, db_id: 982
2025-05-30 15:51:38,834 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 982 for interaction_id: e973735e-bfc3-4535-85ea-d439c050ab59 on attempt 1
2025-05-30 15:51:38,839 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: e973735e-bfc3-4535-85ea-d439c050ab59, db_id: 450
2025-05-30 15:51:38,842 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'e973735e-bfc3-4535-85ea-d439c050ab59', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1044, 'completion_tokens': 60, 'total_tokens': 1104, 'timestamp': '2025-05-30T10:51:38.796003+00:00'}
2025-05-30 15:51:38,842 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: e973735e-bfc3-4535-85ea-d439c050ab59
2025-05-30 15:51:38,843 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 982 for interaction_id: e973735e-bfc3-4535-85ea-d439c050ab59 on attempt 1
2025-05-30 15:51:38,846 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: e973735e-bfc3-4535-85ea-d439c050ab59, db_id: 451
2025-05-30 15:56:17,278 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 15:56:17,286 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 15:56:46,090 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 15:56:46,090 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4835062656) received shutdown request. Initiating graceful shutdown...
2025-05-30 15:56:46,090 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4835062656)...
2025-05-30 15:56:46,090 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 15:56:46,090 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 15:56:46,090 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 15:56:46,090 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4835062656) was cancelled.
2025-05-30 15:56:46,090 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4835062656) stopping. Performing cleanup...
2025-05-30 15:56:46,090 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 15:56:46,090 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 15:56:46,091 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 15:56:46,091 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-30 15:56:46,092 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 15:56:46,092 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 15:56:46,092 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 15:56:46,092 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 15:56:46,092 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 15:56:46,092 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 15:56:46,092 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 15:56:46,096 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 15:56:46,097 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 15:56:46,097 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:56:46,098 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 15:56:46,098 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 15:56:46,098 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 15:56:46,098 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4835062656) cleanup complete.
2025-05-30 15:56:46,098 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 15:56:46,098 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 15:56:46,103 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 15:56:46,103 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 15:56:46,103 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 15:56:46,104 - INFO - __main__ - Agent runner main finished.
2025-05-30 15:56:46,273 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 15:56:46,273 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 15:56:46,273 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 15:56:46,273 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4451206400) was cancelled.
2025-05-30 15:56:46,273 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4451206400) stopping. Performing cleanup...
2025-05-30 15:56:46,273 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:56:46,278 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 15:56:46,279 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 15:56:46,279 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:56:46,279 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 15:56:46,279 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:56:46,279 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4451206400) cleanup complete.
2025-05-30 15:56:46,279 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 15:56:46,279 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 15:56:46,279 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4451206208) was cancelled.
2025-05-30 15:56:46,279 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4451206208) stopping. Performing cleanup...
2025-05-30 15:56:46,279 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:56:46,282 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 15:56:46,283 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 15:56:46,283 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:56:46,283 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 15:56:46,283 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:56:46,283 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4451206208) cleanup complete.
2025-05-30 15:56:46,283 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 15:56:46,283 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 15:56:46,283 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4451206352) was cancelled.
2025-05-30 15:56:46,283 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4451206352) stopping. Performing cleanup...
2025-05-30 15:56:46,283 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 15:56:46,283 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:56:46,284 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 15:56:46,284 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 15:56:46,284 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:56:46,286 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 15:56:46,287 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 15:56:46,287 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:56:46,287 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 15:56:46,287 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:56:46,287 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 15:56:46,287 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4451206352) cleanup complete.
2025-05-30 15:56:46,287 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 15:56:46,287 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 15:56:46,287 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 15:56:46,294 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 15:56:46,294 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 15:56:46,341 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 15:56:46,341 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 15:56:46,341 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 15:56:46,341 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4666091824) received shutdown request. Initiating graceful shutdown...
2025-05-30 15:56:46,341 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4666091824)...
2025-05-30 15:56:46,341 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 15:56:46,341 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 15:56:46,341 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4666091824) was cancelled.
2025-05-30 15:56:46,341 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4666091824) stopping. Performing cleanup...
2025-05-30 15:56:46,341 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 15:56:46,341 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 15:56:46,341 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 15:56:46,342 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 15:56:46,342 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 15:56:46,342 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 15:56:46,342 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 15:56:46,342 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 15:56:46,342 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 15:56:46,342 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 15:56:46,345 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 15:56:46,346 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 15:56:46,346 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:56:46,346 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 15:56:46,346 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 15:56:46,346 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 15:56:46,346 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4666091824) cleanup complete.
2025-05-30 15:56:46,347 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 15:56:46,347 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 15:56:46,353 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 15:56:46,353 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 15:56:46,353 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 15:56:46,353 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 15:56:52,278 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 15:56:52,278 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 15:56:52,282 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 15:56:52,282 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 15:56:52,282 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 15:56:52,282 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 15:56:52,282 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 15:56:52,283 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 15:56:52,283 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 15:56:52,283 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 15:56:52,283 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 15:56:52,283 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 15:56:52,283 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 15:56:52,285 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 15:56:52,300 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 15:56:52,300 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 15:56:52,300 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 15:56:52,300 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 15:56:52,300 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 15:56:52,300 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 15:56:52,302 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 15:56:52,302 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 15:56:52,302 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4440933008) setup complete. Starting run loop.
2025-05-30 15:56:52,302 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 15:56:52,303 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 15:56:52,303 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4440932816) setup complete. Starting run loop.
2025-05-30 15:56:52,303 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 15:56:52,304 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 15:56:52,304 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 15:56:52,336 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 15:56:52,336 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 15:56:52,337 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 15:56:52,338 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 75815
2025-05-30 15:56:52,338 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 75815
2025-05-30 15:56:52,339 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 15:56:52,339 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 15:56:52,339 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 15:56:52,341 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 15:56:52,341 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 75816
2025-05-30 15:56:52,341 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 75816
2025-05-30 15:56:52,342 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 15:56:52,342 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:56:52,343 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 15:56:52,343 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 15:56:52,343 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 15:56:53,239 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 15:56:53,239 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 15:56:53,239 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 15:56:53,239 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 15:56:53,239 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 75816
2025-05-30 15:56:53,239 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 15:56:53,239 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 15:56:53,239 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 15:56:53,244 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 15:56:53,257 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 15:56:53,257 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 15:56:53,257 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 15:56:53,257 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4392233360) setup complete. Starting run loop.
2025-05-30 15:56:53,257 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 15:56:53,257 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 15:56:53,257 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 15:56:53,258 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 15:56:53,258 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 15:56:53,258 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 15:56:53,258 - INFO - aiogram.dispatcher - Start polling
2025-05-30 15:56:53,261 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 15:56:53,503 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 15:56:53,599 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 15:56:53,600 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 15:56:53,600 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 15:56:53,600 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 15:56:53,600 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 75815
2025-05-30 15:56:53,600 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 15:56:53,600 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 15:56:53,600 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 15:56:53,642 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 15:56:53,643 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 15:56:53,687 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 15:56:53,688 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 15:56:53,688 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 15:56:53,688 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 15:56:53,688 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 15:56:53,688 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 15:56:53,713 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 15:56:53,714 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 15:56:53,714 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 15:56:53,715 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 15:56:53,715 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET)
2025-05-30 15:56:53,715 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 15:56:53,716 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 15:56:53,771 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 15:56:53,776 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 15:56:54,386 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 15:56:54,389 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 15:56:54,389 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 15:56:54,389 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 15:56:54,389 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 15:56:54,389 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 15:56:54,389 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 15:56:54,389 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 15:56:54,390 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 15:56:54,390 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 15:56:54,390 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 15:56:54,390 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 15:56:54,391 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 15:56:54,391 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 15:56:54,391 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 15:56:54,391 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 15:56:54,401 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 15:56:54,402 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 15:56:54,402 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 15:56:54,403 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4786074880) setup complete. Starting run loop.
2025-05-30 15:56:54,404 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 15:56:54,404 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 15:56:54,405 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 15:56:54,406 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 15:56:54,416 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 15:57:02,305 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 15:57:02,309 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 15:57:02,309 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4440932960) setup complete. Starting run loop.
2025-05-30 15:57:02,309 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 15:57:36,746 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑŒ Ğ¼Ğ¾Ğ¸ Ğ±Ğ±...'
2025-05-30 15:57:36,748 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 15:57:36,814 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 15:57:36,814 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 15:57:36,814 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 15:57:36,815 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: a8cbd766-cb77-4a09-b329-6f23fb921f1b)
2025-05-30 15:57:36,815 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 15:57:36,816 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-30 15:57:36,837 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: a8cbd766-cb77-4a09-b329-6f23fb921f1b, db_id: 983
2025-05-30 15:57:36,852 - INFO - AGENT:agent_airsoft_0faa9616 - Loaded 20 messages from DB for thread '144641834'.
2025-05-30 15:57:36,852 - INFO - AGENT:agent_airsoft_0faa9616 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-30 15:57:36,852 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-30 15:57:36,913 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 15:57:36,913 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 15:57:36,938 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 15:57:36,942 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 15:57:37,816 - INFO - aiogram.event - Update id=804756335 is handled. Duration 1068 ms by bot id=1750613938
2025-05-30 15:57:38,248 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 15:57:38,275 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 15:57:38,275 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 15:57:38,275 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1013, 'output_tokens': 16, 'total_tokens': 1029, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 15:57:38,275 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1013 C:16 T:1029
2025-05-30 15:57:38,275 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1029 tokens recorded.
2025-05-30 15:57:38,276 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 15:57:38,276 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748589354598
2025-05-30 15:57:38,276 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748589354598)---
2025-05-30 15:57:38,278 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹'
2025-05-30 15:57:38,278 - INFO - app.agent_runner.common.tools_registry - Function parameters: api_config=True, log_adapter=True, state=True
2025-05-30 15:57:38,278 - INFO - app.agent_runner.common.tools_registry - State type: <class 'dict'>
2025-05-30 15:57:38,278 - INFO - app.agent_runner.common.tools_registry - State keys: ['messages', 'documents', 'question', 'original_question', 'rewrite_count', 'channel', 'user_data', 'token_usage_events']
2025-05-30 15:57:38,278 - INFO - app.agent_runner.common.tools_registry - User data extracted: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 15:57:38,278 - INFO - app.agent_runner.common.tools_registry - Final user_data for API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹': {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 15:57:38,278 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 15:57:38,278 - INFO - app.agent_runner.common.tools_registry - Headers type: <class 'dict'>, value: {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36', 'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7', 'Accept-Language': 'ru-RU,ru;q=0.9,en;q=0.8', 'Accept-Encoding': 'gzip, deflate, br', 'DNT': '1', 'Connection': 'keep-alive', 'Upgrade-Insecure-Requests': '1', 'Sec-Fetch-Dest': 'document', 'Sec-Fetch-Mode': 'navigate', 'Sec-Fetch-Site': 'same-origin', 'Sec-Fetch-User': '?1', 'Cache-Control': 'max-age=0', 'Referer': 'https://airsoft-rus.ru/', 'Cookie': 'PHPSESSID=gq3cMIY4z4t5OLt12aMMcFrus6CEIhZR'}
2025-05-30 15:57:38,278 - INFO - app.agent_runner.common.tools_registry - Query Params: {'type': 'info', 'tel': '79222088435'}
2025-05-30 15:57:38,278 - INFO - app.agent_runner.common.tools_registry - Attempting Cloudflare bypass with cloudscraper for https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 15:57:38,782 - INFO - app.agent_runner.common.tools_registry - Cloudscraper request successful with status 200
2025-05-30 15:57:38,782 - INFO - app.agent_runner.common.tools_registry - API Response Status: 200
2025-05-30 15:57:38,782 - INFO - app.agent_runner.common.tools_registry - API Response Headers: {'Date': 'Fri, 30 May 2025 10:57:38 GMT', 'Content-Type': 'text/html; charset=UTF-8', 'Transfer-Encoding': 'chunked', 'Connection': 'keep-alive', 'Server': 'cloudflare', 'Nel': '{"success_fraction":0,"report_to":"cf-nel","max_age":604800}', 'Cf-Ray': '947db6389b0db8c6-AMS', 'Vary': 'HTTPS', 'X-Powered-By': 'PHP/7.3.33', 'P3p': 'policyref="/bitrix/p3p.xml", CP="NON DSP COR CUR ADM DEV PSA PSD OUR UNR BUS UNI COM NAV INT DEM STA"', 'X-Powered-Cms': 'Bitrix Site Manager (16899fb15b29f3b6cb9157e0b568ff46)', 'Expires': 'Thu, 19 Nov 1981 08:52:00 GMT', 'Cache-Control': 'no-store, no-cache, must-revalidate', 'Pragma': 'no-cache', 'X-Frame-Options': 'SAMEORIGIN', 'Content-Encoding': 'br', 'Permissions-Policy': 'browsing-topics=()', 'Strict-Transport-Security': ': max-age=3600', 'Cf-Cache-Status': 'DYNAMIC', 'Report-To': '{"endpoints":[{"url":"https:\\/\\/a.nel.cloudflare.com\\/report\\/v4?s=AtlbRv5QR%2Fjsn3ZLaqZnBuuC81smbNhyKt5OvbIIsxl6lNpnoWRlQEbQwQBNYyfgEpgghKqe5fOQSrP6Sue0crKRkepmjGdzDb4tvXV%2FhrOB7jzRJEwpdAddVEWYBIrP"}],"group":"cf-nel","max_age":604800}', 'Set-Cookie': 'PHPSESSID=AXFkWwYa2GggImCbCnIYrK7zeC9lTPe3; HttpOnly; Secure; Path=/', 'server-timing': 'cfL4;desc="?proto=TCP&rtt=113731&min_rtt=113576&rtt_var=42901&sent=5&recv=6&lost=0&retrans=0&sent_bytes=2882&recv_bytes=1326&delivery_rate=35220&cwnd=252&unsent_bytes=0&cid=e4b2af8fd69e351c&ts=258&x=0"'}
2025-05-30 15:57:38,782 - INFO - app.agent_runner.common.tools_registry - API Response Content-Type: text/html; charset=UTF-8
2025-05-30 15:57:38,782 - INFO - app.agent_runner.common.tools_registry - API Response Content Length: 7 bytes
2025-05-30 15:57:38,782 - INFO - app.agent_runner.common.tools_registry - API Response Content Preview (first 1000 chars): ï¿½574
2025-05-30 15:57:38,782 - WARNING - app.agent_runner.common.tools_registry - Failed to parse JSON response: Expecting value: line 1 column 1 (char 0)
2025-05-30 15:57:38,782 - INFO - app.agent_runner.common.tools_registry - Returning raw text response
2025-05-30 15:57:38,784 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 15:57:38,784 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 15:57:38,808 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 15:57:38,811 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 15:57:39,669 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 15:57:40,569 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ•Ğ²Ğ³ĞµĞ½Ğ¸Ğ¹, Ğº ÑĞ¾Ğ¶Ğ°Ğ»ĞµĞ½Ğ¸Ñ, ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ½Ğµ ÑƒĞ´Ğ°Ñ‘Ñ‚ÑÑ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ñ‚Ğ²Ğ¾Ğ¸Ñ… Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°Ñ… Ğ¸Ğ·-Ğ·Ğ° Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¾
2025-05-30 15:57:40,569 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 15:57:40,569 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1048, 'output_tokens': 54, 'total_tokens': 1102, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 15:57:40,569 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1048 C:54 T:1102
2025-05-30 15:57:40,569 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1102 tokens recorded.
2025-05-30 15:57:40,570 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 15:57:40,570 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 15:57:40,571 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ•Ğ²Ğ³ĞµĞ½Ğ¸Ğ¹, Ğº ÑĞ¾Ğ¶Ğ°Ğ»ĞµĞ½Ğ¸Ñ, ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ½Ğµ ÑƒĞ´Ğ°Ñ‘Ñ‚ÑÑ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ñ‚Ğ²Ğ¾Ğ¸Ñ… Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°Ñ… Ğ¸Ğ·-Ğ·Ğ° Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¾...
2025-05-30 15:57:40,573 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: a8cbd766-cb77-4a09-b329-6f23fb921f1b)
2025-05-30 15:57:40,573 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: a8cbd766-cb77-4a09-b329-6f23fb921f1b.
2025-05-30 15:57:40,575 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Ğ•Ğ²Ğ³ĞµĞ½Ğ¸Ğ¹, Ğº ÑĞ¾Ğ¶Ğ°Ğ»ĞµĞ½Ğ¸Ñ, ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ½Ğµ ÑƒĞ´Ğ°Ñ‘Ñ‚ÑÑ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ñ‚Ğ²Ğ¾Ğ¸Ñ… Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°Ñ… Ğ¸Ğ·-Ğ·Ğ° Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¾...
2025-05-30 15:57:40,575 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Ğ•Ğ²Ğ³ĞµĞ½Ğ¸Ğ¹, Ğº ÑĞ¾Ğ¶Ğ°Ğ»ĞµĞ½Ğ¸Ñ, ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ½Ğµ ÑƒĞ´Ğ°Ñ‘Ñ‚ÑÑ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¸...'
2025-05-30 15:57:40,576 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'a8cbd766-cb77-4a09-b329-6f23fb921f1b', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1013, 'completion_tokens': 16, 'total_tokens': 1029, 'timestamp': '2025-05-30T10:57:38.275604+00:00'}
2025-05-30 15:57:40,576 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: a8cbd766-cb77-4a09-b329-6f23fb921f1b
2025-05-30 15:57:40,589 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: a8cbd766-cb77-4a09-b329-6f23fb921f1b, db_id: 984
2025-05-30 15:57:40,607 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 984 for interaction_id: a8cbd766-cb77-4a09-b329-6f23fb921f1b on attempt 1
2025-05-30 15:57:40,613 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: a8cbd766-cb77-4a09-b329-6f23fb921f1b, db_id: 452
2025-05-30 15:57:40,616 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'a8cbd766-cb77-4a09-b329-6f23fb921f1b', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1048, 'completion_tokens': 54, 'total_tokens': 1102, 'timestamp': '2025-05-30T10:57:40.569872+00:00'}
2025-05-30 15:57:40,616 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: a8cbd766-cb77-4a09-b329-6f23fb921f1b
2025-05-30 15:57:40,617 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 984 for interaction_id: a8cbd766-cb77-4a09-b329-6f23fb921f1b on attempt 1
2025-05-30 15:57:40,620 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: a8cbd766-cb77-4a09-b329-6f23fb921f1b, db_id: 453
2025-05-30 15:58:21,604 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 15:58:21,604 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 15:58:21,604 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 15:58:21,604 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4440933008) was cancelled.
2025-05-30 15:58:21,604 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4440933008) stopping. Performing cleanup...
2025-05-30 15:58:21,604 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:58:21,608 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 15:58:21,609 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 15:58:21,609 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:58:21,609 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 15:58:21,609 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:58:21,610 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4440933008) cleanup complete.
2025-05-30 15:58:21,610 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 15:58:21,610 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 15:58:21,610 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4440932816) was cancelled.
2025-05-30 15:58:21,610 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4440932816) stopping. Performing cleanup...
2025-05-30 15:58:21,610 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:58:21,613 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 15:58:21,614 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 15:58:21,614 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:58:21,615 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 15:58:21,615 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:58:21,615 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4440932816) cleanup complete.
2025-05-30 15:58:21,615 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 15:58:21,615 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 15:58:21,615 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4440932960) was cancelled.
2025-05-30 15:58:21,615 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4440932960) stopping. Performing cleanup...
2025-05-30 15:58:21,615 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 15:58:21,615 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:58:21,615 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 15:58:21,615 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 15:58:21,615 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:58:21,617 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 15:58:21,618 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 15:58:21,618 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:58:21,618 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 15:58:21,618 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:58:21,618 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 15:58:21,618 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4440932960) cleanup complete.
2025-05-30 15:58:21,618 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 15:58:21,618 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 15:58:21,618 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 15:58:21,623 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 15:58:21,623 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 15:58:22,121 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 15:58:22,121 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 15:58:22,124 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 15:58:22,125 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 15:58:22,125 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 15:58:22,125 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 15:58:22,125 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 15:58:22,125 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 15:58:22,125 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 15:58:22,125 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 15:58:22,125 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 15:58:22,125 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 15:58:22,125 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 15:58:22,127 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 15:58:22,155 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 15:58:22,155 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 15:58:22,155 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 15:58:22,155 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 15:58:22,155 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 15:58:22,155 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 15:58:22,157 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 15:58:22,157 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4426292816) setup complete. Starting run loop.
2025-05-30 15:58:22,157 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 15:58:22,157 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 15:58:22,159 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 15:58:22,160 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4437901440) setup complete. Starting run loop.
2025-05-30 15:58:22,160 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 15:58:22,160 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 15:58:22,160 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 15:58:22,186 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 15:58:22,186 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 15:58:22,188 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 15:58:22,188 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 15:58:22,188 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 15:58:22,188 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 15:58:22,189 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:58:22,189 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 15:58:22,189 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 15:58:22,189 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 15:58:32,161 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 15:58:32,165 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 15:58:32,165 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4437901488) setup complete. Starting run loop.
2025-05-30 15:58:32,165 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 15:59:38,382 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 15:59:38,382 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 15:59:38,382 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 15:59:38,382 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4426292816) was cancelled.
2025-05-30 15:59:38,382 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4426292816) stopping. Performing cleanup...
2025-05-30 15:59:38,382 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:59:38,386 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 15:59:38,387 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 15:59:38,387 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:59:38,387 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 15:59:38,387 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:59:38,387 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4426292816) cleanup complete.
2025-05-30 15:59:38,387 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 15:59:38,387 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 15:59:38,387 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4437901440) was cancelled.
2025-05-30 15:59:38,388 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4437901440) stopping. Performing cleanup...
2025-05-30 15:59:38,388 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:59:38,391 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 15:59:38,392 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 15:59:38,392 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:59:38,392 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 15:59:38,392 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:59:38,392 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4437901440) cleanup complete.
2025-05-30 15:59:38,392 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 15:59:38,392 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 15:59:38,392 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4437901488) was cancelled.
2025-05-30 15:59:38,392 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4437901488) stopping. Performing cleanup...
2025-05-30 15:59:38,392 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 15:59:38,392 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:59:38,392 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 15:59:38,393 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 15:59:38,393 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:59:38,394 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 15:59:38,395 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 15:59:38,395 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:59:38,395 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 15:59:38,395 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:59:38,395 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 15:59:38,395 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4437901488) cleanup complete.
2025-05-30 15:59:38,395 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 15:59:38,395 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 15:59:38,395 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 15:59:38,397 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 15:59:38,398 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 15:59:38,798 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 15:59:38,798 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 15:59:38,802 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 15:59:38,802 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 15:59:38,802 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 15:59:38,802 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 15:59:38,802 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 15:59:38,802 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 15:59:38,802 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 15:59:38,802 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 15:59:38,803 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 15:59:38,803 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 15:59:38,803 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 15:59:38,805 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 15:59:38,805 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 15:59:38,805 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 15:59:38,805 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 15:59:38,805 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 15:59:38,805 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 15:59:38,805 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 15:59:38,821 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 15:59:38,821 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4435562704) setup complete. Starting run loop.
2025-05-30 15:59:38,821 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 15:59:38,822 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 15:59:38,823 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 15:59:38,823 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4436409040) setup complete. Starting run loop.
2025-05-30 15:59:38,823 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 15:59:38,834 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 15:59:38,834 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 15:59:38,851 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 15:59:38,851 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 15:59:38,852 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 15:59:38,852 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 15:59:38,852 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 15:59:38,853 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 15:59:38,854 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:59:38,854 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 15:59:38,854 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 15:59:38,854 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 15:59:48,835 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 15:59:48,840 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 15:59:48,840 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4436409088) setup complete. Starting run loop.
2025-05-30 15:59:48,840 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 15:59:56,804 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 15:59:56,804 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 15:59:56,804 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4786074880) received shutdown request. Initiating graceful shutdown...
2025-05-30 15:59:56,804 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4786074880)...
2025-05-30 15:59:56,804 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 15:59:56,804 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 15:59:56,804 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4786074880) was cancelled.
2025-05-30 15:59:56,804 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 15:59:56,804 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4786074880) stopping. Performing cleanup...
2025-05-30 15:59:56,804 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 15:59:56,804 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 15:59:56,805 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-30 15:59:56,805 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 15:59:56,805 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 15:59:56,805 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 15:59:56,805 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 15:59:56,805 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 15:59:56,805 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 15:59:56,805 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 15:59:56,809 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 15:59:56,810 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 15:59:56,810 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:59:56,811 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 15:59:56,811 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 15:59:56,811 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 15:59:56,811 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4786074880) cleanup complete.
2025-05-30 15:59:56,811 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 15:59:56,811 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 15:59:56,814 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 15:59:56,814 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 15:59:56,814 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 15:59:56,814 - INFO - __main__ - Agent runner main finished.
2025-05-30 15:59:56,966 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 15:59:56,966 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 15:59:56,966 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 15:59:56,966 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4435562704) was cancelled.
2025-05-30 15:59:56,967 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4435562704) stopping. Performing cleanup...
2025-05-30 15:59:56,967 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:59:56,971 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 15:59:56,972 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 15:59:56,972 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:59:56,972 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 15:59:56,972 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:59:56,972 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4435562704) cleanup complete.
2025-05-30 15:59:56,972 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 15:59:56,972 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 15:59:56,973 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4436409040) was cancelled.
2025-05-30 15:59:56,973 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4436409040) stopping. Performing cleanup...
2025-05-30 15:59:56,973 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:59:56,976 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 15:59:56,976 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 15:59:56,976 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:59:56,977 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 15:59:56,977 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:59:56,977 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4436409040) cleanup complete.
2025-05-30 15:59:56,977 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 15:59:56,977 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 15:59:56,977 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4436409088) was cancelled.
2025-05-30 15:59:56,977 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4436409088) stopping. Performing cleanup...
2025-05-30 15:59:56,977 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 15:59:56,977 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:59:56,977 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 15:59:56,977 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 15:59:56,977 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 15:59:56,979 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 15:59:56,980 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 15:59:56,980 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:59:56,980 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 15:59:56,980 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 15:59:56,980 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 15:59:56,980 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4436409088) cleanup complete.
2025-05-30 15:59:56,980 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 15:59:56,980 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 15:59:56,980 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 15:59:56,983 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 15:59:56,983 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4392233360) received shutdown request. Initiating graceful shutdown...
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4392233360)...
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4392233360) was cancelled.
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4392233360) stopping. Performing cleanup...
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 15:59:57,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 15:59:57,058 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 15:59:57,059 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 15:59:57,059 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 15:59:57,060 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 15:59:57,060 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 15:59:57,060 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 15:59:57,060 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4392233360) cleanup complete.
2025-05-30 15:59:57,060 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 15:59:57,060 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 15:59:57,062 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 15:59:57,062 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 15:59:57,062 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 15:59:57,063 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 16:00:04,537 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:00:04,537 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:00:04,541 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:00:04,541 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:00:04,541 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:00:04,541 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:00:04,541 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:00:04,541 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:00:04,541 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:00:04,541 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:00:04,541 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:00:04,542 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:00:04,542 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:00:04,546 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:00:04,546 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:00:04,546 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:00:04,546 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:00:04,546 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:00:04,560 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:00:04,560 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:00:04,561 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:00:04,561 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4384850000) setup complete. Starting run loop.
2025-05-30 16:00:04,561 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:00:04,561 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:00:04,562 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:00:04,562 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4384864976) setup complete. Starting run loop.
2025-05-30 16:00:04,562 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:00:04,563 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:00:04,563 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:00:04,590 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:00:04,590 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:00:04,592 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 16:00:04,593 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 76626
2025-05-30 16:00:04,593 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 76626
2025-05-30 16:00:04,593 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 16:00:04,593 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:00:04,593 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:00:04,595 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 16:00:04,596 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 76627
2025-05-30 16:00:04,596 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 76627
2025-05-30 16:00:04,596 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 16:00:04,597 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:00:04,597 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:00:04,597 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:00:04,597 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:00:05,455 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:00:05,455 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 16:00:05,455 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 16:00:05,455 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 16:00:05,455 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 76627
2025-05-30 16:00:05,455 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 16:00:05,455 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 16:00:05,455 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 16:00:05,461 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 16:00:05,474 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 16:00:05,474 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 16:00:05,474 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 16:00:05,475 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4458834320) setup complete. Starting run loop.
2025-05-30 16:00:05,475 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 16:00:05,475 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 16:00:05,475 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 16:00:05,475 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 16:00:05,475 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:00:05,475 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 16:00:05,475 - INFO - aiogram.dispatcher - Start polling
2025-05-30 16:00:05,477 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:00:05,720 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 16:00:05,789 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:00:05,789 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 16:00:05,789 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 16:00:05,789 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 16:00:05,789 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 76626
2025-05-30 16:00:05,789 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 16:00:05,789 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 16:00:05,790 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 16:00:05,831 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 16:00:05,831 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 16:00:05,873 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 16:00:05,874 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 16:00:05,874 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 16:00:05,874 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 16:00:05,874 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 16:00:05,874 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:00:05,899 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 16:00:05,899 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 16:00:05,899 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 16:00:05,900 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 16:00:05,901 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET)
2025-05-30 16:00:05,901 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 16:00:05,901 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 16:00:05,954 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 16:00:05,957 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 16:00:06,581 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 16:00:06,584 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 16:00:06,584 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 16:00:06,584 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 16:00:06,584 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 16:00:06,584 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 16:00:06,584 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 16:00:06,584 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 16:00:06,584 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 16:00:06,585 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 16:00:06,585 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 16:00:06,585 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 16:00:06,585 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 16:00:06,585 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 16:00:06,585 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 16:00:06,585 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 16:00:06,596 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 16:00:06,596 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 16:00:06,596 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 16:00:06,596 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4646565168) setup complete. Starting run loop.
2025-05-30 16:00:06,596 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 16:00:06,596 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 16:00:06,596 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 16:00:06,596 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:00:06,599 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:00:14,563 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 16:00:14,569 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 16:00:14,569 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4384864784) setup complete. Starting run loop.
2025-05-30 16:00:14,569 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 16:00:56,681 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'ĞšĞ°ĞºĞ¾Ğ¹ Ñƒ Ğ¼ĞµĞ½Ñ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²?...'
2025-05-30 16:00:56,682 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 16:00:56,745 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 16:00:56,746 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:00:56,746 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 16:00:56,746 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 355d5be6-2a7e-41a6-ab18-f51a03313350)
2025-05-30 16:00:56,746 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 16:00:56,747 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-30 16:00:56,764 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 355d5be6-2a7e-41a6-ab18-f51a03313350, db_id: 985
2025-05-30 16:00:56,779 - INFO - AGENT:agent_airsoft_0faa9616 - Loaded 20 messages from DB for thread '144641834'.
2025-05-30 16:00:56,780 - INFO - AGENT:agent_airsoft_0faa9616 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-30 16:00:56,780 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-30 16:00:56,840 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:00:56,841 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:00:56,866 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:00:56,869 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:00:57,747 - INFO - aiogram.event - Update id=804756336 is handled. Duration 1066 ms by bot id=1750613938
2025-05-30 16:00:58,169 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:00:58,238 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 16:00:58,238 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 16:00:58,238 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1001, 'output_tokens': 16, 'total_tokens': 1017, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:00:58,238 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1001 C:16 T:1017
2025-05-30 16:00:58,238 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1017 tokens recorded.
2025-05-30 16:00:58,239 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:00:58,239 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748589354598
2025-05-30 16:00:58,239 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748589354598)---
2025-05-30 16:00:58,241 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹'
2025-05-30 16:00:58,241 - INFO - app.agent_runner.common.tools_registry - Function parameters: api_config=True, log_adapter=True, state=True
2025-05-30 16:00:58,241 - INFO - app.agent_runner.common.tools_registry - State type: <class 'dict'>
2025-05-30 16:00:58,241 - INFO - app.agent_runner.common.tools_registry - State keys: ['messages', 'documents', 'question', 'original_question', 'rewrite_count', 'channel', 'user_data', 'token_usage_events']
2025-05-30 16:00:58,241 - INFO - app.agent_runner.common.tools_registry - User data extracted: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:00:58,241 - INFO - app.agent_runner.common.tools_registry - Final user_data for API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹': {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:00:58,241 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:00:58,241 - INFO - app.agent_runner.common.tools_registry - Headers type: <class 'dict'>, value: {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36', 'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7', 'Accept-Language': 'ru-RU,ru;q=0.9,en;q=0.8', 'Accept-Encoding': 'gzip, deflate, br', 'DNT': '1', 'Connection': 'keep-alive', 'Upgrade-Insecure-Requests': '1', 'Sec-Fetch-Dest': 'document', 'Sec-Fetch-Mode': 'navigate', 'Sec-Fetch-Site': 'same-origin', 'Sec-Fetch-User': '?1', 'Cache-Control': 'max-age=0', 'Referer': 'https://airsoft-rus.ru/', 'Cookie': 'PHPSESSID=gq3cMIY4z4t5OLt12aMMcFrus6CEIhZR'}
2025-05-30 16:00:58,241 - INFO - app.agent_runner.common.tools_registry - Query Params: {'type': 'info', 'tel': '79222088435'}
2025-05-30 16:00:58,241 - INFO - app.agent_runner.common.tools_registry - Attempting Cloudflare bypass with cloudscraper for https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:00:58,851 - INFO - app.agent_runner.common.tools_registry - Cloudscraper request successful with status 200
2025-05-30 16:00:58,852 - INFO - app.agent_runner.common.tools_registry - API Response Status: 200
2025-05-30 16:00:58,852 - INFO - app.agent_runner.common.tools_registry - API Response Headers: {'Date': 'Fri, 30 May 2025 11:00:58 GMT', 'Content-Type': 'text/html; charset=UTF-8', 'Transfer-Encoding': 'chunked', 'Connection': 'keep-alive', 'Server': 'cloudflare', 'Nel': '{"success_fraction":0,"report_to":"cf-nel","max_age":604800}', 'Cf-Ray': '947dbb1a5bccf7ea-AMS', 'Vary': 'HTTPS', 'X-Powered-By': 'PHP/7.3.33', 'P3p': 'policyref="/bitrix/p3p.xml", CP="NON DSP COR CUR ADM DEV PSA PSD OUR UNR BUS UNI COM NAV INT DEM STA"', 'X-Powered-Cms': 'Bitrix Site Manager (16899fb15b29f3b6cb9157e0b568ff46)', 'Expires': 'Thu, 19 Nov 1981 08:52:00 GMT', 'Cache-Control': 'no-store, no-cache, must-revalidate', 'Pragma': 'no-cache', 'X-Frame-Options': 'SAMEORIGIN', 'Content-Encoding': 'br', 'Permissions-Policy': 'browsing-topics=()', 'Strict-Transport-Security': ': max-age=3600', 'Cf-Cache-Status': 'DYNAMIC', 'Report-To': '{"endpoints":[{"url":"https:\\/\\/a.nel.cloudflare.com\\/report\\/v4?s=kAZ0%2BLxGP0wvqXkaAzipYa0X9OwxXYaDAdb4ZeUhqUH7wH4Nd2xftLn7Dy7NNRhXPexLAK4SIsjJx1kaofkCrsnqZ5dzzfb18stdzwWoUujpht7OV0BkxaQttIE7pr2j"}],"group":"cf-nel","max_age":604800}', 'Set-Cookie': 'PHPSESSID=RRn5eRe97FKHJqrTaAfV42nTWKqQCmAz; HttpOnly; Secure; Path=/', 'server-timing': 'cfL4;desc="?proto=TCP&rtt=110901&min_rtt=110437&rtt_var=41745&sent=5&recv=6&lost=0&retrans=0&sent_bytes=2880&recv_bytes=1326&delivery_rate=36618&cwnd=233&unsent_bytes=0&cid=4d16b9941ea3335a&ts=373&x=0"'}
2025-05-30 16:00:58,852 - INFO - app.agent_runner.common.tools_registry - API Response Content-Type: text/html; charset=UTF-8
2025-05-30 16:00:58,852 - INFO - app.agent_runner.common.tools_registry - API Response Content Length: 7 bytes
2025-05-30 16:00:58,852 - INFO - app.agent_runner.common.tools_registry - API Response Encoding: utf-8
2025-05-30 16:00:58,852 - INFO - app.agent_runner.common.tools_registry - API Response Content Preview (first 1000 chars): ï¿½574
2025-05-30 16:00:58,852 - WARNING - app.agent_runner.common.tools_registry - Failed to parse JSON response: Expecting value: line 1 column 1 (char 0)
2025-05-30 16:00:58,852 - INFO - app.agent_runner.common.tools_registry - Returning raw text response
2025-05-30 16:00:58,853 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:00:58,853 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:00:58,877 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:00:58,880 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:00:59,981 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:01:00,690 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğµ, Ñ‡Ñ‚Ğ¾ ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ²Ğ¾Ğ·Ğ½Ğ¸ĞºĞ»Ğ° Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾ Ñ‚Ğ²Ğ¾Ğ¸Ñ… Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°Ñ…. ĞÑ‡
2025-05-30 16:01:00,690 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 16:01:00,690 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1036, 'output_tokens': 54, 'total_tokens': 1090, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:01:00,690 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1036 C:54 T:1090
2025-05-30 16:01:00,690 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1090 tokens recorded.
2025-05-30 16:01:00,691 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:01:00,691 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 16:01:00,692 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğµ, Ñ‡Ñ‚Ğ¾ ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ²Ğ¾Ğ·Ğ½Ğ¸ĞºĞ»Ğ° Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾ Ñ‚Ğ²Ğ¾Ğ¸Ñ… Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°Ñ…. ĞÑ‡...
2025-05-30 16:01:00,693 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 355d5be6-2a7e-41a6-ab18-f51a03313350)
2025-05-30 16:01:00,694 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: 355d5be6-2a7e-41a6-ab18-f51a03313350.
2025-05-30 16:01:00,696 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğµ, Ñ‡Ñ‚Ğ¾ ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ²Ğ¾Ğ·Ğ½Ğ¸ĞºĞ»Ğ° Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾ Ñ‚Ğ²Ğ¾Ğ¸Ñ… Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°Ñ…. ĞÑ‡...
2025-05-30 16:01:00,696 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğµ, Ñ‡Ñ‚Ğ¾ ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ²Ğ¾Ğ·Ğ½Ğ¸ĞºĞ»Ğ° Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ñ...'
2025-05-30 16:01:00,698 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '355d5be6-2a7e-41a6-ab18-f51a03313350', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1001, 'completion_tokens': 16, 'total_tokens': 1017, 'timestamp': '2025-05-30T11:00:58.238895+00:00'}
2025-05-30 16:01:00,698 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 355d5be6-2a7e-41a6-ab18-f51a03313350
2025-05-30 16:01:00,702 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 355d5be6-2a7e-41a6-ab18-f51a03313350, db_id: 986
2025-05-30 16:01:00,727 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 986 for interaction_id: 355d5be6-2a7e-41a6-ab18-f51a03313350 on attempt 1
2025-05-30 16:01:00,733 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 355d5be6-2a7e-41a6-ab18-f51a03313350, db_id: 454
2025-05-30 16:01:00,737 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '355d5be6-2a7e-41a6-ab18-f51a03313350', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1036, 'completion_tokens': 54, 'total_tokens': 1090, 'timestamp': '2025-05-30T11:01:00.690221+00:00'}
2025-05-30 16:01:00,737 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 355d5be6-2a7e-41a6-ab18-f51a03313350
2025-05-30 16:01:00,738 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 986 for interaction_id: 355d5be6-2a7e-41a6-ab18-f51a03313350 on attempt 1
2025-05-30 16:01:00,741 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 355d5be6-2a7e-41a6-ab18-f51a03313350, db_id: 455
2025-05-30 16:01:35,252 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 16:01:35,252 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 16:01:35,252 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 16:01:35,252 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4384850000) was cancelled.
2025-05-30 16:01:35,252 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4384850000) stopping. Performing cleanup...
2025-05-30 16:01:35,252 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:01:35,257 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 16:01:35,258 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 16:01:35,258 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:01:35,258 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 16:01:35,258 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:01:35,258 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4384850000) cleanup complete.
2025-05-30 16:01:35,258 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 16:01:35,258 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 16:01:35,258 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4384864976) was cancelled.
2025-05-30 16:01:35,258 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4384864976) stopping. Performing cleanup...
2025-05-30 16:01:35,258 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:01:35,262 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 16:01:35,262 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 16:01:35,262 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:01:35,263 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 16:01:35,263 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:01:35,263 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4384864976) cleanup complete.
2025-05-30 16:01:35,263 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 16:01:35,263 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 16:01:35,263 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4384864784) was cancelled.
2025-05-30 16:01:35,263 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4384864784) stopping. Performing cleanup...
2025-05-30 16:01:35,263 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 16:01:35,263 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:01:35,263 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:01:35,263 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 16:01:35,263 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:01:35,266 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 16:01:35,267 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 16:01:35,267 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:01:35,267 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 16:01:35,267 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:01:35,267 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 16:01:35,267 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4384864784) cleanup complete.
2025-05-30 16:01:35,267 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 16:01:35,267 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 16:01:35,267 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 16:01:35,272 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:01:35,272 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 16:01:35,776 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:01:35,776 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:01:35,781 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:01:35,781 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:01:35,781 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:01:35,781 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:01:35,781 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:01:35,781 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:01:35,781 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:01:35,781 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:01:35,781 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:01:35,782 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:01:35,782 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:01:35,785 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:01:35,785 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:01:35,785 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:01:35,799 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:01:35,799 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:01:35,799 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:01:35,799 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:01:35,800 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:01:35,800 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4436050864) setup complete. Starting run loop.
2025-05-30 16:01:35,800 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:01:35,801 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:01:35,802 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:01:35,802 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4436064784) setup complete. Starting run loop.
2025-05-30 16:01:35,802 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:01:35,804 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:01:35,804 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:01:35,832 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:01:35,832 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:01:35,833 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:01:35,833 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:01:35,833 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:01:35,834 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:01:35,834 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:01:35,835 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:01:35,835 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:01:35,835 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:01:45,804 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 16:01:45,808 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 16:01:45,808 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4436064592) setup complete. Starting run loop.
2025-05-30 16:01:45,808 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 16:01:53,242 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 16:01:53,242 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 16:01:53,242 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 16:01:53,242 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4436050864) was cancelled.
2025-05-30 16:01:53,242 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4436050864) stopping. Performing cleanup...
2025-05-30 16:01:53,242 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:01:53,246 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 16:01:53,247 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 16:01:53,247 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:01:53,247 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 16:01:53,247 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:01:53,247 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4436050864) cleanup complete.
2025-05-30 16:01:53,247 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 16:01:53,247 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 16:01:53,247 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4436064784) was cancelled.
2025-05-30 16:01:53,247 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4436064784) stopping. Performing cleanup...
2025-05-30 16:01:53,247 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:01:53,252 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 16:01:53,253 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 16:01:53,253 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:01:53,253 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 16:01:53,253 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:01:53,253 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4436064784) cleanup complete.
2025-05-30 16:01:53,253 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 16:01:53,253 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 16:01:53,253 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4436064592) was cancelled.
2025-05-30 16:01:53,253 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4436064592) stopping. Performing cleanup...
2025-05-30 16:01:53,253 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 16:01:53,253 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:01:53,253 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:01:53,253 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 16:01:53,253 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:01:53,256 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 16:01:53,257 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 16:01:53,257 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:01:53,258 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 16:01:53,258 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:01:53,258 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 16:01:53,258 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4436064592) cleanup complete.
2025-05-30 16:01:53,258 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 16:01:53,258 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 16:01:53,258 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 16:01:53,263 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:01:53,263 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 16:01:53,662 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:01:53,662 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:01:53,666 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:01:53,667 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:01:53,667 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:01:53,667 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:01:53,667 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:01:53,667 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:01:53,667 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:01:53,667 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:01:53,667 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:01:53,667 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:01:53,667 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:01:53,669 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:01:53,669 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:01:53,669 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:01:53,669 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:01:53,669 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:01:53,669 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:01:53,669 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:01:53,685 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:01:53,685 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4453018000) setup complete. Starting run loop.
2025-05-30 16:01:53,685 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:01:53,685 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:01:53,686 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:01:53,686 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4453022224) setup complete. Starting run loop.
2025-05-30 16:01:53,686 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:01:53,687 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:01:53,687 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:01:53,716 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:01:53,716 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:01:53,717 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:01:53,717 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:01:53,717 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:01:53,718 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:01:53,719 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:01:53,719 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:01:53,719 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:01:53,719 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:01:57,487 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 16:01:57,487 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 16:01:57,487 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4646565168) received shutdown request. Initiating graceful shutdown...
2025-05-30 16:01:57,487 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4646565168)...
2025-05-30 16:01:57,487 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 16:01:57,487 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 16:01:57,487 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4646565168) was cancelled.
2025-05-30 16:01:57,487 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 16:01:57,487 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4646565168) stopping. Performing cleanup...
2025-05-30 16:01:57,487 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 16:01:57,487 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 16:01:57,488 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-30 16:01:57,488 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 16:01:57,488 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 16:01:57,488 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 16:01:57,488 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:01:57,488 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 16:01:57,488 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 16:01:57,488 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 16:01:57,492 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 16:01:57,493 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 16:01:57,493 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:01:57,493 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 16:01:57,493 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 16:01:57,493 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 16:01:57,493 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4646565168) cleanup complete.
2025-05-30 16:01:57,493 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 16:01:57,493 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 16:01:57,496 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:01:57,496 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 16:01:57,496 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 16:01:57,496 - INFO - __main__ - Agent runner main finished.
2025-05-30 16:01:57,641 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 16:01:57,641 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 16:01:57,641 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 16:01:57,641 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4453018000) was cancelled.
2025-05-30 16:01:57,641 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4453018000) stopping. Performing cleanup...
2025-05-30 16:01:57,641 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:01:57,644 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 16:01:57,645 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 16:01:57,645 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:01:57,645 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 16:01:57,645 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:01:57,645 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4453018000) cleanup complete.
2025-05-30 16:01:57,645 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 16:01:57,645 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 16:01:57,645 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4453022224) was cancelled.
2025-05-30 16:01:57,645 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4453022224) stopping. Performing cleanup...
2025-05-30 16:01:57,645 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:01:57,648 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 16:01:57,649 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 16:01:57,649 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:01:57,649 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 16:01:57,649 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:01:57,649 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4453022224) cleanup complete.
2025-05-30 16:01:57,649 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 16:01:57,649 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 16:01:57,649 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4453022608) was cancelled.
2025-05-30 16:01:57,649 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4453022608) stopping. Performing cleanup...
2025-05-30 16:01:57,649 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 16:01:57,649 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:01:57,649 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:01:57,649 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 16:01:57,649 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:01:57,651 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 16:01:57,652 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 16:01:57,652 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:01:57,652 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 16:01:57,652 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:01:57,652 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 16:01:57,652 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4453022608) cleanup complete.
2025-05-30 16:01:57,652 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 16:01:57,652 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 16:01:57,652 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 16:01:57,654 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:01:57,654 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 16:01:57,739 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 16:01:57,739 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 16:01:57,739 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 16:01:57,739 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4458834320) received shutdown request. Initiating graceful shutdown...
2025-05-30 16:01:57,739 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4458834320)...
2025-05-30 16:01:57,739 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 16:01:57,739 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 16:01:57,739 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4458834320) was cancelled.
2025-05-30 16:01:57,739 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4458834320) stopping. Performing cleanup...
2025-05-30 16:01:57,739 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 16:01:57,739 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 16:01:57,739 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 16:01:57,739 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 16:01:57,739 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 16:01:57,739 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 16:01:57,739 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:01:57,740 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 16:01:57,740 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 16:01:57,740 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 16:01:57,744 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 16:01:57,745 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 16:01:57,745 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:01:57,745 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 16:01:57,745 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 16:01:57,745 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 16:01:57,745 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4458834320) cleanup complete.
2025-05-30 16:01:57,745 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 16:01:57,745 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 16:01:57,748 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:01:57,748 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 16:01:57,748 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 16:01:57,749 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 16:02:02,611 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:02:02,611 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:02:02,616 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:02:02,616 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:02:02,616 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:02:02,616 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:02:02,616 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:02:02,616 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:02:02,616 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:02:02,616 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:02:02,617 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:02:02,617 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:02:02,617 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:02:02,619 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:02:02,619 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:02:02,619 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:02:02,619 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:02:02,619 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:02:02,620 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:02:02,620 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:02:02,634 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:02:02,635 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:02:02,635 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4412097168) setup complete. Starting run loop.
2025-05-30 16:02:02,635 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:02:02,635 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:02:02,635 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4412097360) setup complete. Starting run loop.
2025-05-30 16:02:02,635 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:02:02,638 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:02:02,638 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:02:02,664 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:02:02,664 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:02:02,665 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 16:02:02,666 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 76892
2025-05-30 16:02:02,666 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 76892
2025-05-30 16:02:02,667 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 16:02:02,667 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:02:02,667 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:02:02,669 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 16:02:02,669 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 76893
2025-05-30 16:02:02,669 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 76893
2025-05-30 16:02:02,670 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 16:02:02,670 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:02:02,670 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:02:02,670 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:02:02,670 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:02:03,533 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:02:03,533 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 16:02:03,533 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 16:02:03,533 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 16:02:03,533 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 76893
2025-05-30 16:02:03,533 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 16:02:03,533 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 16:02:03,533 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 16:02:03,537 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 16:02:03,550 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 16:02:03,550 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 16:02:03,550 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 16:02:03,550 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4433176448) setup complete. Starting run loop.
2025-05-30 16:02:03,550 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 16:02:03,550 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 16:02:03,550 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 16:02:03,550 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 16:02:03,551 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:02:03,551 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 16:02:03,551 - INFO - aiogram.dispatcher - Start polling
2025-05-30 16:02:03,553 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:02:03,787 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 16:02:03,879 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:02:03,879 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 16:02:03,879 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 16:02:03,879 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 16:02:03,879 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 76892
2025-05-30 16:02:03,879 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 16:02:03,879 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 16:02:03,879 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 16:02:03,920 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 16:02:03,920 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 16:02:03,965 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 16:02:03,966 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 16:02:03,966 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 16:02:03,966 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 16:02:03,966 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 16:02:03,966 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:02:03,991 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 16:02:03,991 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 16:02:03,991 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 16:02:03,992 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 16:02:03,993 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET)
2025-05-30 16:02:03,993 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 16:02:03,993 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 16:02:04,048 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 16:02:04,050 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 16:02:04,655 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 16:02:04,658 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 16:02:04,658 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 16:02:04,658 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 16:02:04,658 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 16:02:04,658 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 16:02:04,658 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 16:02:04,658 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 16:02:04,658 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 16:02:04,659 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 16:02:04,659 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 16:02:04,659 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 16:02:04,659 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 16:02:04,659 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 16:02:04,659 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 16:02:04,660 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 16:02:04,670 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 16:02:04,670 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 16:02:04,670 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 16:02:04,670 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4490523520) setup complete. Starting run loop.
2025-05-30 16:02:04,670 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 16:02:04,670 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 16:02:04,670 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 16:02:04,670 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:02:04,674 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:02:12,638 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 16:02:12,643 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 16:02:12,643 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4412097312) setup complete. Starting run loop.
2025-05-30 16:02:12,643 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 16:02:20,808 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'ĞšĞ°ĞºĞ¾Ğ¹ Ñƒ Ğ¼ĞµĞ½Ñ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ±?...'
2025-05-30 16:02:20,810 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 16:02:20,877 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 16:02:20,877 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:02:20,877 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 16:02:20,878 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: b7d043a6-bd7c-4e1a-b5b7-6a3aaa61307d)
2025-05-30 16:02:20,878 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 16:02:20,878 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-30 16:02:20,898 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: b7d043a6-bd7c-4e1a-b5b7-6a3aaa61307d, db_id: 987
2025-05-30 16:02:20,913 - INFO - AGENT:agent_airsoft_0faa9616 - Loaded 20 messages from DB for thread '144641834'.
2025-05-30 16:02:20,913 - INFO - AGENT:agent_airsoft_0faa9616 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-30 16:02:20,913 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-30 16:02:20,960 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:02:20,960 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:02:20,985 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:02:20,988 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:02:21,878 - INFO - aiogram.event - Update id=804756337 is handled. Duration 1070 ms by bot id=1750613938
2025-05-30 16:02:22,349 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:02:22,354 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 16:02:22,354 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 16:02:22,354 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1034, 'output_tokens': 16, 'total_tokens': 1050, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:02:22,354 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1034 C:16 T:1050
2025-05-30 16:02:22,354 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1050 tokens recorded.
2025-05-30 16:02:22,355 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:02:22,355 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748589354598
2025-05-30 16:02:22,355 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748589354598)---
2025-05-30 16:02:22,357 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹'
2025-05-30 16:02:22,357 - INFO - app.agent_runner.common.tools_registry - Function parameters: api_config=True, log_adapter=True, state=True
2025-05-30 16:02:22,357 - INFO - app.agent_runner.common.tools_registry - State type: <class 'dict'>
2025-05-30 16:02:22,357 - INFO - app.agent_runner.common.tools_registry - State keys: ['messages', 'documents', 'question', 'original_question', 'rewrite_count', 'channel', 'user_data', 'token_usage_events']
2025-05-30 16:02:22,357 - INFO - app.agent_runner.common.tools_registry - User data extracted: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:02:22,358 - INFO - app.agent_runner.common.tools_registry - Final user_data for API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹': {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:02:22,358 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:02:22,358 - INFO - app.agent_runner.common.tools_registry - Headers type: <class 'dict'>, value: {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36', 'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7', 'Accept-Language': 'ru-RU,ru;q=0.9,en;q=0.8', 'Accept-Encoding': 'gzip, deflate, br', 'DNT': '1', 'Connection': 'keep-alive', 'Upgrade-Insecure-Requests': '1', 'Sec-Fetch-Dest': 'document', 'Sec-Fetch-Mode': 'navigate', 'Sec-Fetch-Site': 'same-origin', 'Sec-Fetch-User': '?1', 'Cache-Control': 'max-age=0', 'Referer': 'https://airsoft-rus.ru/', 'Cookie': 'PHPSESSID=gq3cMIY4z4t5OLt12aMMcFrus6CEIhZR'}
2025-05-30 16:02:22,358 - INFO - app.agent_runner.common.tools_registry - Query Params: {'type': 'info', 'tel': '79222088435'}
2025-05-30 16:02:22,358 - INFO - app.agent_runner.common.tools_registry - Attempting Cloudflare bypass with cloudscraper for https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:02:22,850 - INFO - app.agent_runner.common.tools_registry - Cloudscraper request successful with status 200
2025-05-30 16:02:22,850 - INFO - app.agent_runner.common.tools_registry - API Response Status: 200
2025-05-30 16:02:22,851 - INFO - app.agent_runner.common.tools_registry - API Response Headers: {'Date': 'Fri, 30 May 2025 11:02:22 GMT', 'Content-Type': 'text/html; charset=UTF-8', 'Transfer-Encoding': 'chunked', 'Connection': 'keep-alive', 'Server': 'cloudflare', 'Nel': '{"success_fraction":0,"report_to":"cf-nel","max_age":604800}', 'Cf-Ray': '947dbd28195b97fc-AMS', 'Vary': 'HTTPS', 'X-Powered-By': 'PHP/7.3.33', 'P3p': 'policyref="/bitrix/p3p.xml", CP="NON DSP COR CUR ADM DEV PSA PSD OUR UNR BUS UNI COM NAV INT DEM STA"', 'X-Powered-Cms': 'Bitrix Site Manager (16899fb15b29f3b6cb9157e0b568ff46)', 'Expires': 'Thu, 19 Nov 1981 08:52:00 GMT', 'Cache-Control': 'no-store, no-cache, must-revalidate', 'Pragma': 'no-cache', 'X-Frame-Options': 'SAMEORIGIN', 'Content-Encoding': 'br', 'Permissions-Policy': 'browsing-topics=()', 'Strict-Transport-Security': ': max-age=3600', 'Cf-Cache-Status': 'DYNAMIC', 'Report-To': '{"endpoints":[{"url":"https:\\/\\/a.nel.cloudflare.com\\/report\\/v4?s=%2FMXqJR6tOug5Vgr8yhYjjuPCo95tLnpulBRWy8NV3NETBTdPh5Av9NIb%2BP1eB1wpQGaYV0gHt5BJvSNdi6zsyQ%2BEHgpDwO%2BQeMgEo0CEff96BhiLN6iMMplusSlZxodI"}],"group":"cf-nel","max_age":604800}', 'Set-Cookie': 'PHPSESSID=jshYsbTHcQqTyyf7kK7abV3YANdraKkX; HttpOnly; Secure; Path=/', 'server-timing': 'cfL4;desc="?proto=TCP&rtt=113118&min_rtt=112148&rtt_var=42748&sent=5&recv=6&lost=0&retrans=0&sent_bytes=2881&recv_bytes=1326&delivery_rate=36059&cwnd=246&unsent_bytes=0&cid=e4f0566ea6f7e5fd&ts=249&x=0"'}
2025-05-30 16:02:22,851 - INFO - app.agent_runner.common.tools_registry - API Response Content-Type: text/html; charset=UTF-8
2025-05-30 16:02:22,851 - INFO - app.agent_runner.common.tools_registry - API Response Content Length: 7 bytes
2025-05-30 16:02:22,851 - INFO - app.agent_runner.common.tools_registry - API Response Encoding: UTF-8
2025-05-30 16:02:22,851 - WARNING - app.agent_runner.common.tools_registry - Failed to decode as UTF-8, falling back to response.text
2025-05-30 16:02:22,851 - INFO - app.agent_runner.common.tools_registry - API Response Content Preview (first 1000 chars): ï¿½574
2025-05-30 16:02:22,851 - WARNING - app.agent_runner.common.tools_registry - Failed to parse JSON response: Expecting value: line 1 column 1 (char 0)
2025-05-30 16:02:22,851 - INFO - app.agent_runner.common.tools_registry - Returning raw text response
2025-05-30 16:02:22,852 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:02:22,853 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:02:22,876 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:02:22,879 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:02:24,286 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:02:24,897 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ•Ğ²Ğ³ĞµĞ½Ğ¸Ğ¹, Ğº ÑĞ¾Ğ¶Ğ°Ğ»ĞµĞ½Ğ¸Ñ, ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ½Ğµ ÑĞ¼Ğ¾Ğ³Ğ»Ğ° Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾ Ñ‚Ğ²Ğ¾Ğ¸Ñ… Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°Ñ…. Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾, ÑÑ‚
2025-05-30 16:02:24,898 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 16:02:24,898 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1069, 'output_tokens': 51, 'total_tokens': 1120, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:02:24,898 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1069 C:51 T:1120
2025-05-30 16:02:24,898 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1120 tokens recorded.
2025-05-30 16:02:24,898 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:02:24,899 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 16:02:24,900 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ•Ğ²Ğ³ĞµĞ½Ğ¸Ğ¹, Ğº ÑĞ¾Ğ¶Ğ°Ğ»ĞµĞ½Ğ¸Ñ, ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ½Ğµ ÑĞ¼Ğ¾Ğ³Ğ»Ğ° Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾ Ñ‚Ğ²Ğ¾Ğ¸Ñ… Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°Ñ…. Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾, ÑÑ‚...
2025-05-30 16:02:24,901 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: b7d043a6-bd7c-4e1a-b5b7-6a3aaa61307d)
2025-05-30 16:02:24,902 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: b7d043a6-bd7c-4e1a-b5b7-6a3aaa61307d.
2025-05-30 16:02:24,904 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Ğ•Ğ²Ğ³ĞµĞ½Ğ¸Ğ¹, Ğº ÑĞ¾Ğ¶Ğ°Ğ»ĞµĞ½Ğ¸Ñ, ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ½Ğµ ÑĞ¼Ğ¾Ğ³Ğ»Ğ° Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾ Ñ‚Ğ²Ğ¾Ğ¸Ñ… Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°Ñ…. Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾, ÑÑ‚...
2025-05-30 16:02:24,904 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Ğ•Ğ²Ğ³ĞµĞ½Ğ¸Ğ¹, Ğº ÑĞ¾Ğ¶Ğ°Ğ»ĞµĞ½Ğ¸Ñ, ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ½Ğµ ÑĞ¼Ğ¾Ğ³Ğ»Ğ° Ğ¿Ğ¾Ğ»...'
2025-05-30 16:02:24,904 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'b7d043a6-bd7c-4e1a-b5b7-6a3aaa61307d', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1034, 'completion_tokens': 16, 'total_tokens': 1050, 'timestamp': '2025-05-30T11:02:22.354703+00:00'}
2025-05-30 16:02:24,904 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: b7d043a6-bd7c-4e1a-b5b7-6a3aaa61307d
2025-05-30 16:02:24,918 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: b7d043a6-bd7c-4e1a-b5b7-6a3aaa61307d, db_id: 988
2025-05-30 16:02:24,934 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 988 for interaction_id: b7d043a6-bd7c-4e1a-b5b7-6a3aaa61307d on attempt 1
2025-05-30 16:02:24,940 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: b7d043a6-bd7c-4e1a-b5b7-6a3aaa61307d, db_id: 456
2025-05-30 16:02:24,943 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'b7d043a6-bd7c-4e1a-b5b7-6a3aaa61307d', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1069, 'completion_tokens': 51, 'total_tokens': 1120, 'timestamp': '2025-05-30T11:02:24.898088+00:00'}
2025-05-30 16:02:24,943 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: b7d043a6-bd7c-4e1a-b5b7-6a3aaa61307d
2025-05-30 16:02:24,944 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 988 for interaction_id: b7d043a6-bd7c-4e1a-b5b7-6a3aaa61307d on attempt 1
2025-05-30 16:02:24,947 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: b7d043a6-bd7c-4e1a-b5b7-6a3aaa61307d, db_id: 457
2025-05-30 16:03:41,809 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 16:03:41,809 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 16:03:41,809 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 16:03:41,809 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4412097360) was cancelled.
2025-05-30 16:03:41,809 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4412097360) stopping. Performing cleanup...
2025-05-30 16:03:41,809 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:03:41,814 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 16:03:41,815 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 16:03:41,815 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:03:41,815 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 16:03:41,815 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:03:41,815 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4412097360) cleanup complete.
2025-05-30 16:03:41,815 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 16:03:41,815 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 16:03:41,815 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4412097168) was cancelled.
2025-05-30 16:03:41,815 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4412097168) stopping. Performing cleanup...
2025-05-30 16:03:41,815 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:03:41,818 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 16:03:41,819 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 16:03:41,819 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:03:41,819 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 16:03:41,819 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:03:41,819 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4412097168) cleanup complete.
2025-05-30 16:03:41,819 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 16:03:41,819 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 16:03:41,819 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4412097312) was cancelled.
2025-05-30 16:03:41,819 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4412097312) stopping. Performing cleanup...
2025-05-30 16:03:41,819 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 16:03:41,819 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:03:41,820 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:03:41,820 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 16:03:41,820 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:03:41,822 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 16:03:41,823 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 16:03:41,823 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:03:41,823 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 16:03:41,823 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:03:41,823 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 16:03:41,823 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4412097312) cleanup complete.
2025-05-30 16:03:41,823 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 16:03:41,823 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 16:03:41,823 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 16:03:41,829 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:03:41,829 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 16:03:42,347 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:03:42,347 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:03:42,352 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:03:42,352 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:03:42,352 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:03:42,352 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:03:42,352 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:03:42,353 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:03:42,353 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:03:42,353 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:03:42,353 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:03:42,353 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:03:42,353 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:03:42,356 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:03:42,356 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:03:42,356 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:03:42,356 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:03:42,356 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:03:42,370 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:03:42,370 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:03:42,372 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:03:42,373 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:03:42,373 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4482382736) setup complete. Starting run loop.
2025-05-30 16:03:42,373 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:03:42,373 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:03:42,373 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4479880464) setup complete. Starting run loop.
2025-05-30 16:03:42,373 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:03:42,374 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:03:42,374 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:03:42,402 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:03:42,402 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:03:42,403 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:03:42,403 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:03:42,403 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:03:42,404 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:03:42,404 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:03:42,404 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:03:42,404 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:03:42,404 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:03:49,447 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 16:03:49,447 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 16:03:49,447 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 16:03:49,447 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4479880464) was cancelled.
2025-05-30 16:03:49,447 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4479880464) stopping. Performing cleanup...
2025-05-30 16:03:49,447 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:03:49,452 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 16:03:49,453 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 16:03:49,453 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:03:49,453 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 16:03:49,453 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:03:49,453 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4479880464) cleanup complete.
2025-05-30 16:03:49,453 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 16:03:49,453 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 16:03:49,453 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4482382736) was cancelled.
2025-05-30 16:03:49,453 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4482382736) stopping. Performing cleanup...
2025-05-30 16:03:49,453 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:03:49,456 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 16:03:49,457 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 16:03:49,457 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:03:49,457 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 16:03:49,457 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:03:49,457 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4482382736) cleanup complete.
2025-05-30 16:03:49,457 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 16:03:49,457 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 16:03:49,457 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4482382544) was cancelled.
2025-05-30 16:03:49,457 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4482382544) stopping. Performing cleanup...
2025-05-30 16:03:49,457 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 16:03:49,457 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:03:49,457 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:03:49,457 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 16:03:49,458 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:03:49,460 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 16:03:49,461 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 16:03:49,461 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:03:49,461 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 16:03:49,461 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:03:49,461 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 16:03:49,461 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4482382544) cleanup complete.
2025-05-30 16:03:49,461 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 16:03:49,461 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 16:03:49,461 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 16:03:49,464 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:03:49,464 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 16:03:49,774 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:03:49,774 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:03:49,778 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:03:49,778 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:03:49,778 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:03:49,778 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:03:49,778 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:03:49,778 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:03:49,778 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:03:49,778 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:03:49,779 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:03:49,779 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:03:49,779 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:03:49,781 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:03:49,781 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:03:49,781 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:03:49,781 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:03:49,781 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:03:49,794 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:03:49,794 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:03:49,797 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:03:49,797 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4384885984) setup complete. Starting run loop.
2025-05-30 16:03:49,797 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:03:49,798 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:03:49,799 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:03:49,799 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4384897264) setup complete. Starting run loop.
2025-05-30 16:03:49,799 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:03:49,800 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:03:49,800 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:03:49,828 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:03:49,828 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:03:49,829 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:03:49,829 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:03:49,829 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:03:49,829 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:03:49,830 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:03:49,830 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:03:49,830 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:03:49,830 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:03:59,114 - INFO - app.services.process_manager - Restarting agent process for agent_airsoft_0faa9616...
2025-05-30 16:03:59,116 - INFO - app.services.process_manager - Stopping agent process agent_airsoft_0faa9616 (PID: 76892). Force: True
2025-05-30 16:03:59,116 - INFO - app.services.process_manager - SIGTERM sent to agent agent_airsoft_0faa9616 (PID: 76892)
2025-05-30 16:03:59,217 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 (PID: 76892) terminated gracefully after SIGTERM.
2025-05-30 16:03:59,220 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 marked as stopped in Redis.
2025-05-30 16:03:59,220 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 stopped (or stop attempted and assumed successful for restart). Pausing briefly...
2025-05-30 16:03:59,800 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 16:03:59,804 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 16:03:59,804 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4384897312) setup complete. Starting run loop.
2025-05-30 16:03:59,804 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 16:04:04,220 - INFO - app.services.process_manager - Proceeding to start agent agent_airsoft_0faa9616 after delay...
2025-05-30 16:04:04,223 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 16:04:04,224 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 77299
2025-05-30 16:04:04,224 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 77299
2025-05-30 16:04:04,225 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 successfully started as part of restart sequence.
2025-05-30 16:04:04,225 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:04:04,225 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:04:05,441 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:04:05,442 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 16:04:05,442 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 16:04:05,442 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 16:04:05,442 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 77299
2025-05-30 16:04:05,442 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 16:04:05,442 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 16:04:05,442 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 16:04:05,484 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 16:04:05,485 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 16:04:05,525 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 16:04:05,525 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 16:04:05,525 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 16:04:05,526 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 16:04:05,526 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 16:04:05,526 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:04:05,551 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 16:04:05,551 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 16:04:05,551 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 16:04:05,552 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 16:04:05,553 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET)
2025-05-30 16:04:05,553 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 16:04:05,553 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 16:04:05,607 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 16:04:05,611 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 16:04:06,223 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 16:04:06,227 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 16:04:06,227 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 16:04:06,228 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 16:04:06,228 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 16:04:06,228 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 16:04:06,228 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 16:04:06,228 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 16:04:06,228 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 16:04:06,228 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 16:04:06,229 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 16:04:06,229 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 16:04:06,229 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 16:04:06,229 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 16:04:06,229 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 16:04:06,229 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 16:04:06,240 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 16:04:06,240 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 16:04:06,240 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 16:04:06,240 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4530730048) setup complete. Starting run loop.
2025-05-30 16:04:06,240 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 16:04:06,240 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 16:04:06,240 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 16:04:06,240 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:04:06,243 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:04:13,729 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:04:13,729 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:04:40,451 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒ Ğ¼Ğ¾Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²...'
2025-05-30 16:04:40,452 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 16:04:40,456 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 16:04:40,456 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:04:40,456 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 16:04:40,457 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 59cff0eb-6ee7-47d1-a747-3077cb893c09)
2025-05-30 16:04:40,457 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 16:04:40,457 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 16:04:40,457 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 16:04:40,478 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 59cff0eb-6ee7-47d1-a747-3077cb893c09, db_id: 989
2025-05-30 16:04:40,503 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:04:40,503 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:04:40,528 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:04:40,531 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:04:41,457 - INFO - aiogram.event - Update id=804756338 is handled. Duration 1005 ms by bot id=1750613938
2025-05-30 16:04:41,915 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:04:41,921 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 16:04:41,921 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_38647f5e19'}
2025-05-30 16:04:41,921 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 364, 'output_tokens': 12, 'total_tokens': 376, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:04:41,921 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:364 C:12 T:376
2025-05-30 16:04:41,921 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 376 tokens recorded.
2025-05-30 16:04:41,922 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:04:41,922 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: get_user_info_tool
2025-05-30 16:04:41,922 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (get_user_info_tool)---
2025-05-30 16:04:41,924 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:04:41,924 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:04:41,948 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:04:41,951 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:04:42,905 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:04:42,930 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 16:04:42,930 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_38647f5e19'}
2025-05-30 16:04:42,930 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 435, 'output_tokens': 16, 'total_tokens': 451, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:04:42,930 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:435 C:16 T:451
2025-05-30 16:04:42,930 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 451 tokens recorded.
2025-05-30 16:04:42,931 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:04:42,931 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748589354598
2025-05-30 16:04:42,931 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748589354598)---
2025-05-30 16:04:42,933 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹'
2025-05-30 16:04:42,933 - INFO - app.agent_runner.common.tools_registry - Function parameters: api_config=True, log_adapter=True, state=True
2025-05-30 16:04:42,933 - INFO - app.agent_runner.common.tools_registry - State type: <class 'dict'>
2025-05-30 16:04:42,933 - INFO - app.agent_runner.common.tools_registry - State keys: ['messages', 'documents', 'question', 'original_question', 'rewrite_count', 'channel', 'user_data', 'token_usage_events']
2025-05-30 16:04:42,933 - INFO - app.agent_runner.common.tools_registry - User data extracted: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:04:42,933 - INFO - app.agent_runner.common.tools_registry - Final user_data for API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹': {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:04:42,933 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:04:42,933 - INFO - app.agent_runner.common.tools_registry - Headers type: <class 'dict'>, value: {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36', 'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7', 'Accept-Language': 'ru-RU,ru;q=0.9,en;q=0.8', 'Accept-Encoding': 'gzip, deflate, br', 'DNT': '1', 'Connection': 'keep-alive', 'Upgrade-Insecure-Requests': '1', 'Sec-Fetch-Dest': 'document', 'Sec-Fetch-Mode': 'navigate', 'Sec-Fetch-Site': 'same-origin', 'Sec-Fetch-User': '?1', 'Cache-Control': 'max-age=0', 'Referer': 'https://airsoft-rus.ru/', 'Cookie': 'PHPSESSID=gq3cMIY4z4t5OLt12aMMcFrus6CEIhZR'}
2025-05-30 16:04:42,933 - INFO - app.agent_runner.common.tools_registry - Query Params: {'type': 'info', 'tel': '79222088435'}
2025-05-30 16:04:42,933 - INFO - app.agent_runner.common.tools_registry - Attempting Cloudflare bypass with cloudscraper for https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:04:43,409 - INFO - app.agent_runner.common.tools_registry - Cloudscraper request successful with status 200
2025-05-30 16:04:43,409 - INFO - app.agent_runner.common.tools_registry - API Response Status: 200
2025-05-30 16:04:43,409 - INFO - app.agent_runner.common.tools_registry - API Response Headers: {'Date': 'Fri, 30 May 2025 11:04:43 GMT', 'Content-Type': 'text/html; charset=UTF-8', 'Transfer-Encoding': 'chunked', 'Connection': 'keep-alive', 'Server': 'cloudflare', 'Nel': '{"success_fraction":0,"report_to":"cf-nel","max_age":604800}', 'Cf-Ray': '947dc096bc95661c-AMS', 'Vary': 'HTTPS', 'X-Powered-By': 'PHP/7.3.33', 'P3p': 'policyref="/bitrix/p3p.xml", CP="NON DSP COR CUR ADM DEV PSA PSD OUR UNR BUS UNI COM NAV INT DEM STA"', 'X-Powered-Cms': 'Bitrix Site Manager (16899fb15b29f3b6cb9157e0b568ff46)', 'Expires': 'Thu, 19 Nov 1981 08:52:00 GMT', 'Cache-Control': 'no-store, no-cache, must-revalidate', 'Pragma': 'no-cache', 'X-Frame-Options': 'SAMEORIGIN', 'Content-Encoding': 'br', 'Permissions-Policy': 'browsing-topics=()', 'Strict-Transport-Security': ': max-age=3600', 'Cf-Cache-Status': 'DYNAMIC', 'Report-To': '{"endpoints":[{"url":"https:\\/\\/a.nel.cloudflare.com\\/report\\/v4?s=6Qp%2BXHikbdTA9nTFbGMnnnJYKwMdpHQ7zGIHwray94ukXX%2F%2BoBn18dEhEwIPnvJOX33hO6gLYLeC7JxecYQn5IEbNoETDQWHxLxVElNXNIwIyEN1g9edWEoSXu5%2Fa%2FGh"}],"group":"cf-nel","max_age":604800}', 'Set-Cookie': 'PHPSESSID=F5qlxdnWsPvNxfkYuKyGi4e0eFSW5qWN; HttpOnly; Secure; Path=/', 'server-timing': 'cfL4;desc="?proto=TCP&rtt=112263&min_rtt=111854&rtt_var=42237&sent=5&recv=6&lost=0&retrans=0&sent_bytes=2882&recv_bytes=1326&delivery_rate=36154&cwnd=252&unsent_bytes=0&cid=0871b604fdec16fb&ts=229&x=0"'}
2025-05-30 16:04:43,409 - INFO - app.agent_runner.common.tools_registry - API Response Content-Type: text/html; charset=UTF-8
2025-05-30 16:04:43,409 - INFO - app.agent_runner.common.tools_registry - API Response Content Length: 7 bytes
2025-05-30 16:04:43,409 - INFO - app.agent_runner.common.tools_registry - API Response Encoding: UTF-8
2025-05-30 16:04:43,409 - INFO - app.agent_runner.common.tools_registry - Successfully got decoded text content, encoding: UTF-8
2025-05-30 16:04:43,409 - INFO - app.agent_runner.common.tools_registry - API Response Content Preview (first 1000 chars): ï¿½574
2025-05-30 16:04:43,409 - WARNING - app.agent_runner.common.tools_registry - Failed to parse JSON response: Expecting value: line 1 column 1 (char 0)
2025-05-30 16:04:43,409 - INFO - app.agent_runner.common.tools_registry - Returning raw text response
2025-05-30 16:04:43,410 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:04:43,411 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:04:43,434 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:04:43,437 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:04:44,678 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:04:45,107 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ’Ğ°Ñˆ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² ÑĞ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ 574 Ğ±Ğ±. Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¾ Ñ‚Ğ¾Ğ¼, 
2025-05-30 16:04:45,107 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 16:04:45,107 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 470, 'output_tokens': 34, 'total_tokens': 504, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:04:45,107 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:470 C:34 T:504
2025-05-30 16:04:45,107 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 504 tokens recorded.
2025-05-30 16:04:45,108 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:04:45,108 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 16:04:45,109 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ’Ğ°Ñˆ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² ÑĞ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ 574 Ğ±Ğ±. Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¾ Ñ‚Ğ¾Ğ¼, ...
2025-05-30 16:04:45,111 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 59cff0eb-6ee7-47d1-a747-3077cb893c09)
2025-05-30 16:04:45,111 - INFO - AGENT:agent_airsoft_0faa9616 - Found 3 token usage events for InteractionID: 59cff0eb-6ee7-47d1-a747-3077cb893c09.
2025-05-30 16:04:45,114 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Ğ’Ğ°Ñˆ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² ÑĞ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ 574 Ğ±Ğ±. Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¾ Ñ‚Ğ¾Ğ¼, ...
2025-05-30 16:04:45,114 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Ğ’Ğ°Ñˆ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² ÑĞ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ 574 ...'
2025-05-30 16:04:45,114 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '59cff0eb-6ee7-47d1-a747-3077cb893c09', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 364, 'completion_tokens': 12, 'total_tokens': 376, 'timestamp': '2025-05-30T11:04:41.921198+00:00'}
2025-05-30 16:04:45,114 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 59cff0eb-6ee7-47d1-a747-3077cb893c09
2025-05-30 16:04:45,118 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 59cff0eb-6ee7-47d1-a747-3077cb893c09, db_id: 990
2025-05-30 16:04:45,146 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 990 for interaction_id: 59cff0eb-6ee7-47d1-a747-3077cb893c09 on attempt 1
2025-05-30 16:04:45,152 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 59cff0eb-6ee7-47d1-a747-3077cb893c09, db_id: 458
2025-05-30 16:04:45,154 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '59cff0eb-6ee7-47d1-a747-3077cb893c09', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 470, 'completion_tokens': 34, 'total_tokens': 504, 'timestamp': '2025-05-30T11:04:45.107540+00:00'}
2025-05-30 16:04:45,154 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 59cff0eb-6ee7-47d1-a747-3077cb893c09
2025-05-30 16:04:45,155 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 990 for interaction_id: 59cff0eb-6ee7-47d1-a747-3077cb893c09 on attempt 1
2025-05-30 16:04:45,159 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 59cff0eb-6ee7-47d1-a747-3077cb893c09, db_id: 459
2025-05-30 16:04:45,161 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '59cff0eb-6ee7-47d1-a747-3077cb893c09', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 435, 'completion_tokens': 16, 'total_tokens': 451, 'timestamp': '2025-05-30T11:04:42.930674+00:00'}
2025-05-30 16:04:45,161 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 59cff0eb-6ee7-47d1-a747-3077cb893c09
2025-05-30 16:04:45,162 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 990 for interaction_id: 59cff0eb-6ee7-47d1-a747-3077cb893c09 on attempt 1
2025-05-30 16:04:45,164 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 59cff0eb-6ee7-47d1-a747-3077cb893c09, db_id: 460
2025-05-30 16:05:22,664 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ¸Ğ· Ğ±Ğ»Ğ¾Ğ³Ğ°...'
2025-05-30 16:05:22,667 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 16:05:22,671 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 16:05:22,671 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:05:22,671 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 16:05:22,672 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 86f4139f-7e1f-4a59-bda7-0d8ca6524f9e)
2025-05-30 16:05:22,672 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 16:05:22,673 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 16:05:22,673 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 16:05:22,676 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:05:22,677 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:05:22,680 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 86f4139f-7e1f-4a59-bda7-0d8ca6524f9e, db_id: 991
2025-05-30 16:05:22,703 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:05:22,706 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:05:23,654 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:05:23,671 - INFO - aiogram.event - Update id=804756339 is handled. Duration 1006 ms by bot id=1750613938
2025-05-30 16:05:23,706 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 16:05:23,706 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_38647f5e19'}
2025-05-30 16:05:23,706 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 517, 'output_tokens': 16, 'total_tokens': 533, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:05:23,706 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:517 C:16 T:533
2025-05-30 16:05:23,706 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 533 tokens recorded.
2025-05-30 16:05:23,707 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:05:23,707 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748460000001
2025-05-30 16:05:23,707 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748460000001)---
2025-05-30 16:05:23,708 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'JSONPlaceholder POST'
2025-05-30 16:05:23,708 - INFO - app.agent_runner.common.tools_registry - Function parameters: api_config=True, log_adapter=True, state=True
2025-05-30 16:05:23,708 - INFO - app.agent_runner.common.tools_registry - State type: <class 'dict'>
2025-05-30 16:05:23,709 - INFO - app.agent_runner.common.tools_registry - State keys: ['messages', 'documents', 'question', 'original_question', 'rewrite_count', 'channel', 'user_data', 'token_usage_events']
2025-05-30 16:05:23,709 - INFO - app.agent_runner.common.tools_registry - User data extracted: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:05:23,709 - INFO - app.agent_runner.common.tools_registry - Final user_data for API tool 'JSONPlaceholder POST': {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:05:23,709 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://jsonplaceholder.typicode.com/posts
2025-05-30 16:05:23,709 - INFO - app.agent_runner.common.tools_registry - Headers type: <class 'dict'>, value: {'Content-Type': 'application/json'}
2025-05-30 16:05:23,709 - INFO - app.agent_runner.common.tools_registry - Query Params: {}
2025-05-30 16:05:23,709 - INFO - app.agent_runner.common.tools_registry - Attempting Cloudflare bypass with cloudscraper for https://jsonplaceholder.typicode.com/posts
2025-05-30 16:05:24,082 - INFO - app.agent_runner.common.tools_registry - Cloudscraper request successful with status 200
2025-05-30 16:05:24,082 - INFO - app.agent_runner.common.tools_registry - API Response Status: 200
2025-05-30 16:05:24,082 - INFO - app.agent_runner.common.tools_registry - API Response Headers: {'Date': 'Fri, 30 May 2025 11:05:24 GMT', 'Content-Type': 'application/json; charset=utf-8', 'Transfer-Encoding': 'chunked', 'Connection': 'keep-alive', 'Server': 'cloudflare', 'Server-Timing': 'cfCacheStatus;desc="HIT", cfL4;desc="?proto=TCP&rtt=112188&min_rtt=111967&rtt_var=42430&sent=5&recv=6&lost=0&retrans=0&sent_bytes=2873&recv_bytes=995&delivery_rate=35555&cwnd=252&unsent_bytes=0&cid=ba90f55c1bda4962&ts=126&x=0"', 'Cf-Ray': '947dc1958aea88ce-AMS', 'Report-To': '{"group":"heroku-nel","max_age":3600,"endpoints":[{"url":"https://nel.heroku.com/reports?ts=1745364533&sid=e11707d5-02a7-43ef-b45e-2cf4d2036f7d&s=uo710C4FIUNu4BFlCUNZBJLrAa9qxMz%2Bz8sjG2qw2BY%3D"}]}', 'Reporting-Endpoints': 'heroku-nel=https://nel.heroku.com/reports?ts=1745364533&sid=e11707d5-02a7-43ef-b45e-2cf4d2036f7d&s=uo710C4FIUNu4BFlCUNZBJLrAa9qxMz%2Bz8sjG2qw2BY%3D', 'Nel': '{"report_to":"heroku-nel","max_age":3600,"success_fraction":0.005,"failure_fraction":0.05,"response_headers":["Via"]}', 'X-Powered-By': 'Express', 'X-Ratelimit-Limit': '1000', 'X-Ratelimit-Remaining': '999', 'X-Ratelimit-Reset': '1745364561', 'Vary': 'Origin, Accept-Encoding', 'Access-Control-Allow-Credentials': 'true', 'Cache-Control': 'max-age=43200', 'Pragma': 'no-cache', 'Expires': '-1', 'X-Content-Type-Options': 'nosniff', 'Etag': 'W/"6b80-Ybsq/K6GwwqrYkAsFxqDXGC7DoM"', 'Content-Encoding': 'gzip', 'Via': '1.1 vegur', 'Age': '5524', 'Cf-Cache-Status': 'HIT', 'alt-svc': 'h3=":443"; ma=86400'}
2025-05-30 16:05:24,083 - INFO - app.agent_runner.common.tools_registry - API Response Content-Type: application/json; charset=utf-8
2025-05-30 16:05:24,083 - INFO - app.agent_runner.common.tools_registry - API Response Content Length: 27520 bytes
2025-05-30 16:05:24,083 - INFO - app.agent_runner.common.tools_registry - API Response Encoding: utf-8
2025-05-30 16:05:24,083 - INFO - app.agent_runner.common.tools_registry - Successfully got decoded text content, encoding: utf-8
2025-05-30 16:05:24,083 - INFO - app.agent_runner.common.tools_registry - API Response Content Preview (first 1000 chars): [
  {
    "userId": 1,
    "id": 1,
    "title": "sunt aut facere repellat provident occaecati excepturi optio reprehenderit",
    "body": "quia et suscipit\nsuscipit recusandae consequuntur expedita et cum\nreprehenderit molestiae ut ut quas totam\nnostrum rerum est autem sunt rem eveniet architecto"
  },
  {
    "userId": 1,
    "id": 2,
    "title": "qui est esse",
    "body": "est rerum tempore vitae\nsequi sint nihil reprehenderit dolor beatae ea dolores neque\nfugiat blanditiis voluptate porro vel nihil molestiae ut reiciendis\nqui aperiam non debitis possimus qui neque nisi nulla"
  },
  {
    "userId": 1,
    "id": 3,
    "title": "ea molestias quasi exercitationem repellat qui ipsa sit aut",
    "body": "et iusto sed quo iure\nvoluptatem occaecati omnis eligendi aut ad\nvoluptatem doloribus vel accusantium quis pariatur\nmolestiae porro eius odio et labore et velit aut"
  },
  {
    "userId": 1,
    "id": 4,
    "title": "eum et est occaecati",
    "body": "ullam et saepe reic
2025-05-30 16:05:24,083 - INFO - app.agent_runner.common.tools_registry - Response content truncated. Full length: 27520 characters
2025-05-30 16:05:24,083 - INFO - app.agent_runner.common.tools_registry - Successfully parsed JSON response with 100 top-level items
2025-05-30 16:05:24,085 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:05:24,085 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:05:24,108 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:05:24,111 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:05:25,323 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:05:26,354 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ’Ğ¾Ñ‚ Ğ¾Ğ´Ğ½Ğ° Ğ¸Ğ· Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¸Ğ· Ğ±Ğ»Ğ¾Ğ³Ğ°:

**Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº:** sunt aut facere repellat provident occaecati excepturi
2025-05-30 16:05:26,354 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 16:05:26,354 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 8237, 'output_tokens': 86, 'total_tokens': 8323, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:05:26,354 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:8237 C:86 T:8323
2025-05-30 16:05:26,354 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 8323 tokens recorded.
2025-05-30 16:05:26,355 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:05:26,355 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 16:05:26,356 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ’Ğ¾Ñ‚ Ğ¾Ğ´Ğ½Ğ° Ğ¸Ğ· Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¸Ğ· Ğ±Ğ»Ğ¾Ğ³Ğ°:

**Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº:** sunt aut facere repellat provident occaecati excepturi...
2025-05-30 16:05:26,358 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 86f4139f-7e1f-4a59-bda7-0d8ca6524f9e)
2025-05-30 16:05:26,358 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: 86f4139f-7e1f-4a59-bda7-0d8ca6524f9e.
2025-05-30 16:05:26,360 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Ğ’Ğ¾Ñ‚ Ğ¾Ğ´Ğ½Ğ° Ğ¸Ğ· Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¸Ğ· Ğ±Ğ»Ğ¾Ğ³Ğ°:

**Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº:** sunt aut facere repellat provident occaecati excepturi...
2025-05-30 16:05:26,360 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Ğ’Ğ¾Ñ‚ Ğ¾Ğ´Ğ½Ğ° Ğ¸Ğ· Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¸Ğ· Ğ±Ğ»Ğ¾Ğ³Ğ°:

**Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº:** sunt...'
2025-05-30 16:05:26,362 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '86f4139f-7e1f-4a59-bda7-0d8ca6524f9e', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 517, 'completion_tokens': 16, 'total_tokens': 533, 'timestamp': '2025-05-30T11:05:23.706584+00:00'}
2025-05-30 16:05:26,362 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 86f4139f-7e1f-4a59-bda7-0d8ca6524f9e
2025-05-30 16:05:26,365 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 992 for interaction_id: 86f4139f-7e1f-4a59-bda7-0d8ca6524f9e on attempt 1
2025-05-30 16:05:26,365 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 86f4139f-7e1f-4a59-bda7-0d8ca6524f9e, db_id: 992
2025-05-30 16:05:26,368 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 86f4139f-7e1f-4a59-bda7-0d8ca6524f9e, db_id: 461
2025-05-30 16:05:26,372 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '86f4139f-7e1f-4a59-bda7-0d8ca6524f9e', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 8237, 'completion_tokens': 86, 'total_tokens': 8323, 'timestamp': '2025-05-30T11:05:26.354748+00:00'}
2025-05-30 16:05:26,372 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 86f4139f-7e1f-4a59-bda7-0d8ca6524f9e
2025-05-30 16:05:26,373 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 992 for interaction_id: 86f4139f-7e1f-4a59-bda7-0d8ca6524f9e on attempt 1
2025-05-30 16:05:26,376 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 86f4139f-7e1f-4a59-bda7-0d8ca6524f9e, db_id: 462
2025-05-30 16:05:40,682 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Ğ¿ĞµÑ€ĞµĞ²ĞµĞ´Ğ¸...'
2025-05-30 16:05:40,683 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 16:05:40,687 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 16:05:40,688 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:05:40,688 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 16:05:40,689 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 3bda4c7b-ff9c-4828-b8eb-14b92e73fe3e)
2025-05-30 16:05:40,689 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 16:05:40,690 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 16:05:40,690 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 16:05:40,692 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:05:40,692 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:05:40,695 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 3bda4c7b-ff9c-4828-b8eb-14b92e73fe3e, db_id: 993
2025-05-30 16:05:40,718 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:05:40,721 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:05:41,689 - INFO - aiogram.event - Update id=804756340 is handled. Duration 1006 ms by bot id=1750613938
2025-05-30 16:05:42,026 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:05:43,303 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: ĞšĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾! Ğ’Ğ¾Ñ‚ Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ¸Ğ· Ğ±Ğ»Ğ¾Ğ³Ğ° Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¸Ğ¹:

**Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº:** "Ğ­Ñ‚Ğ¾ ĞµÑÑ‚ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ¾Ñ‚Ñ‚Ğ°Ğ»ĞºĞ¸Ğ²Ğ°ÑÑ‰
2025-05-30 16:05:43,303 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_38647f5e19'}
2025-05-30 16:05:43,303 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 8333, 'output_tokens': 112, 'total_tokens': 8445, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:05:43,303 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:8333 C:112 T:8445
2025-05-30 16:05:43,303 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 8445 tokens recorded.
2025-05-30 16:05:43,305 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:05:43,305 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 16:05:43,305 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: ĞšĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾! Ğ’Ğ¾Ñ‚ Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ¸Ğ· Ğ±Ğ»Ğ¾Ğ³Ğ° Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¸Ğ¹:

**Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº:** "Ğ­Ñ‚Ğ¾ ĞµÑÑ‚ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ¾Ñ‚Ñ‚Ğ°Ğ»ĞºĞ¸Ğ²Ğ°ÑÑ‰...
2025-05-30 16:05:43,307 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 3bda4c7b-ff9c-4828-b8eb-14b92e73fe3e)
2025-05-30 16:05:43,307 - INFO - AGENT:agent_airsoft_0faa9616 - Found 1 token usage events for InteractionID: 3bda4c7b-ff9c-4828-b8eb-14b92e73fe3e.
2025-05-30 16:05:43,308 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: ĞšĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾! Ğ’Ğ¾Ñ‚ Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ¸Ğ· Ğ±Ğ»Ğ¾Ğ³Ğ° Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¸Ğ¹:

**Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº:** "Ğ­Ñ‚Ğ¾ ĞµÑÑ‚ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ¾Ñ‚Ñ‚Ğ°Ğ»ĞºĞ¸Ğ²Ğ°ÑÑ‰...
2025-05-30 16:05:43,309 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'ĞšĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾! Ğ’Ğ¾Ñ‚ Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ¸Ğ· Ğ±Ğ»Ğ¾Ğ³Ğ° Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¸Ğ¹:

...'
2025-05-30 16:05:43,310 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '3bda4c7b-ff9c-4828-b8eb-14b92e73fe3e', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 8333, 'completion_tokens': 112, 'total_tokens': 8445, 'timestamp': '2025-05-30T11:05:43.303971+00:00'}
2025-05-30 16:05:43,310 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 3bda4c7b-ff9c-4828-b8eb-14b92e73fe3e
2025-05-30 16:05:43,312 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 993 for interaction_id: 3bda4c7b-ff9c-4828-b8eb-14b92e73fe3e on attempt 1
2025-05-30 16:05:43,314 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 3bda4c7b-ff9c-4828-b8eb-14b92e73fe3e, db_id: 994
2025-05-30 16:05:43,317 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 3bda4c7b-ff9c-4828-b8eb-14b92e73fe3e, db_id: 463
2025-05-30 16:09:00,008 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 16:09:00,018 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 16:12:42,766 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:12:42,766 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:12:42,771 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:12:42,771 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:12:42,771 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:12:42,771 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:12:42,771 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:12:42,771 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:12:42,771 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:12:42,771 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:12:42,771 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:12:42,772 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:12:42,772 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:12:42,778 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:12:42,778 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:12:42,778 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:12:42,793 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:12:42,793 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:12:42,793 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:12:42,793 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:12:42,795 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:12:42,795 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:12:42,795 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4409810080) setup complete. Starting run loop.
2025-05-30 16:12:42,795 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:12:42,796 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:12:42,796 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4425551312) setup complete. Starting run loop.
2025-05-30 16:12:42,796 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:12:42,796 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:12:42,796 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:12:42,829 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:12:42,829 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:12:42,830 - WARNING - app.services.process_manager - Agent agent_airsoft_0faa9616 status is 'running' in Redis, but PID 77299 not found. Updating status.
2025-05-30 16:12:42,832 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 16:12:42,833 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 81745
2025-05-30 16:12:42,833 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 81745
2025-05-30 16:12:42,834 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 16:12:42,834 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:12:42,834 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:12:42,835 - WARNING - app.services.process_manager - Integration telegram for agent agent_airsoft_0faa9616 status is 'running' in Redis, but PID 76893 not found. Updating status.
2025-05-30 16:12:42,836 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 16:12:42,836 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 81746
2025-05-30 16:12:42,836 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 81746
2025-05-30 16:12:42,837 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 16:12:42,838 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:12:42,838 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:12:42,838 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:12:42,838 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:12:43,764 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:12:43,764 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 16:12:43,764 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 16:12:43,764 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 16:12:43,764 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 81746
2025-05-30 16:12:43,764 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 16:12:43,764 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 16:12:43,764 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 16:12:43,770 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 16:12:43,784 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 16:12:43,784 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 16:12:43,784 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 16:12:43,784 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4457546816) setup complete. Starting run loop.
2025-05-30 16:12:43,784 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 16:12:43,784 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 16:12:43,784 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 16:12:43,784 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 16:12:43,784 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:12:43,784 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 16:12:43,784 - INFO - aiogram.dispatcher - Start polling
2025-05-30 16:12:43,788 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:12:44,095 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 16:12:44,217 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:12:44,217 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 16:12:44,217 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 16:12:44,217 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 16:12:44,217 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 81745
2025-05-30 16:12:44,217 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 16:12:44,217 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 16:12:44,217 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 16:12:44,262 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 16:12:44,262 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 16:12:44,308 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 16:12:44,308 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 16:12:44,308 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 16:12:44,308 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 16:12:44,308 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 16:12:44,308 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:12:44,334 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 16:12:44,334 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 16:12:44,334 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 16:12:44,335 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 16:12:44,336 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET)
2025-05-30 16:12:44,336 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 16:12:44,336 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 16:12:44,390 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 16:12:44,395 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 16:12:45,879 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 16:12:45,882 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 16:12:45,882 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 16:12:45,882 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 16:12:45,882 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 16:12:45,882 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 16:12:45,882 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 16:12:45,882 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 16:12:45,882 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 16:12:45,882 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 16:12:45,883 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 16:12:45,883 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 16:12:45,883 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 16:12:45,883 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 16:12:45,883 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 16:12:45,883 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 16:12:45,892 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 16:12:45,893 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 16:12:45,893 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 16:12:45,893 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4517229536) setup complete. Starting run loop.
2025-05-30 16:12:45,893 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 16:12:45,893 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 16:12:45,893 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 16:12:45,893 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:12:45,896 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:12:52,797 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 16:12:52,802 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 16:12:52,802 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4425557840) setup complete. Starting run loop.
2025-05-30 16:12:52,802 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 16:13:29,767 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñƒ Ğ¼ĞµĞ½Ñ Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ?...'
2025-05-30 16:13:29,768 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 16:13:29,833 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 16:13:29,834 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:13:29,834 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 16:13:29,834 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 4568d90d-0b69-4f17-a256-b5d19355e489)
2025-05-30 16:13:29,834 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 16:13:29,835 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 16:13:29,835 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 16:13:29,859 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 4568d90d-0b69-4f17-a256-b5d19355e489, db_id: 995
2025-05-30 16:13:29,894 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:13:29,895 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:13:29,920 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:13:29,923 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:13:30,834 - INFO - aiogram.event - Update id=804756341 is handled. Duration 1067 ms by bot id=1750613938
2025-05-30 16:13:31,249 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:13:31,296 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 16:13:31,296 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 16:13:31,296 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 363, 'output_tokens': 12, 'total_tokens': 375, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:13:31,296 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:363 C:12 T:375
2025-05-30 16:13:31,296 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 375 tokens recorded.
2025-05-30 16:13:31,297 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:13:31,297 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: get_user_info_tool
2025-05-30 16:13:31,297 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (get_user_info_tool)---
2025-05-30 16:13:31,299 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:13:31,299 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:13:31,324 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:13:31,326 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:13:32,984 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:13:32,986 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 16:13:32,986 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 16:13:32,986 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 434, 'output_tokens': 16, 'total_tokens': 450, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:13:32,986 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:434 C:16 T:450
2025-05-30 16:13:32,986 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 450 tokens recorded.
2025-05-30 16:13:32,987 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:13:32,987 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748589354598
2025-05-30 16:13:32,987 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748589354598)---
2025-05-30 16:13:32,988 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹'
2025-05-30 16:13:32,988 - INFO - app.agent_runner.common.tools_registry - Function parameters: api_config=True, log_adapter=True, state=True
2025-05-30 16:13:32,988 - INFO - app.agent_runner.common.tools_registry - State type: <class 'dict'>
2025-05-30 16:13:32,988 - INFO - app.agent_runner.common.tools_registry - State keys: ['messages', 'documents', 'question', 'original_question', 'rewrite_count', 'channel', 'user_data', 'token_usage_events']
2025-05-30 16:13:32,988 - INFO - app.agent_runner.common.tools_registry - User data extracted: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:13:32,988 - INFO - app.agent_runner.common.tools_registry - Final user_data for API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹': {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:13:32,988 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:13:32,988 - INFO - app.agent_runner.common.tools_registry - Headers type: <class 'dict'>, value: {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36', 'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7', 'Accept-Language': 'ru-RU,ru;q=0.9,en;q=0.8', 'Accept-Encoding': 'gzip, deflate, br', 'DNT': '1', 'Connection': 'keep-alive', 'Upgrade-Insecure-Requests': '1', 'Sec-Fetch-Dest': 'document', 'Sec-Fetch-Mode': 'navigate', 'Sec-Fetch-Site': 'same-origin', 'Sec-Fetch-User': '?1', 'Cache-Control': 'max-age=0', 'Referer': 'https://airsoft-rus.ru/', 'Cookie': 'PHPSESSID=gq3cMIY4z4t5OLt12aMMcFrus6CEIhZR'}
2025-05-30 16:13:32,988 - INFO - app.agent_runner.common.tools_registry - Query Params: {'type': 'info', 'tel': '79222088435'}
2025-05-30 16:13:32,988 - INFO - app.agent_runner.common.tools_registry - Attempting Cloudflare bypass with cloudscraper for https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:13:33,455 - INFO - app.agent_runner.common.tools_registry - Cloudscraper request successful with status 200
2025-05-30 16:13:33,455 - INFO - app.agent_runner.common.tools_registry - API Response Status: 200
2025-05-30 16:13:33,455 - INFO - app.agent_runner.common.tools_registry - API Response Headers: {'Date': 'Fri, 30 May 2025 11:13:33 GMT', 'Content-Type': 'text/html; charset=UTF-8', 'Transfer-Encoding': 'chunked', 'Connection': 'keep-alive', 'Server': 'cloudflare', 'Nel': '{"success_fraction":0,"report_to":"cf-nel","max_age":604800}', 'Cf-Ray': '947dcd876df3f5eb-AMS', 'Vary': 'HTTPS', 'X-Powered-By': 'PHP/7.3.33', 'P3p': 'policyref="/bitrix/p3p.xml", CP="NON DSP COR CUR ADM DEV PSA PSD OUR UNR BUS UNI COM NAV INT DEM STA"', 'X-Powered-Cms': 'Bitrix Site Manager (16899fb15b29f3b6cb9157e0b568ff46)', 'Expires': 'Thu, 19 Nov 1981 08:52:00 GMT', 'Cache-Control': 'no-store, no-cache, must-revalidate', 'Pragma': 'no-cache', 'X-Frame-Options': 'SAMEORIGIN', 'Content-Encoding': 'br', 'Permissions-Policy': 'browsing-topics=()', 'Strict-Transport-Security': ': max-age=3600', 'Cf-Cache-Status': 'DYNAMIC', 'Report-To': '{"endpoints":[{"url":"https:\\/\\/a.nel.cloudflare.com\\/report\\/v4?s=Uci2DubjtjFJlRmK2FBSZF9hn6VHhU4iqVjxM3QYIp5Kc1nurMSqozSgynnTgsrYWxCkuFtg71NrHsfNQGU64ujWXEqF1A0cA5tk603rTlwU7LN95E3EbKezdoP7X3DG"}],"group":"cf-nel","max_age":604800}', 'Set-Cookie': 'PHPSESSID=Xm6b4WeJNPx4bma6IuoySxfedCXkXLx6; HttpOnly; Secure; Path=/', 'server-timing': 'cfL4;desc="?proto=TCP&rtt=112194&min_rtt=111888&rtt_var=42176&sent=5&recv=6&lost=0&retrans=0&sent_bytes=2882&recv_bytes=1326&delivery_rate=36143&cwnd=238&unsent_bytes=0&cid=18819f457f344d4e&ts=219&x=0"'}
2025-05-30 16:13:33,455 - INFO - app.agent_runner.common.tools_registry - API Response Content-Type: text/html; charset=UTF-8
2025-05-30 16:13:33,455 - INFO - app.agent_runner.common.tools_registry - API Response Content Length: 7 bytes
2025-05-30 16:13:33,455 - INFO - app.agent_runner.common.tools_registry - API Response Encoding: UTF-8
2025-05-30 16:13:33,455 - INFO - app.agent_runner.common.tools_registry - Successfully got decoded text content, encoding: UTF-8
2025-05-30 16:13:33,455 - INFO - app.agent_runner.common.tools_registry - API Response Content Preview (first 1000 chars): ï¿½574
2025-05-30 16:13:33,455 - WARNING - app.agent_runner.common.tools_registry - Failed to parse JSON response: Expecting value: line 1 column 1 (char 0)
2025-05-30 16:13:33,455 - INFO - app.agent_runner.common.tools_registry - Returning raw text response
2025-05-30 16:13:33,457 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:13:33,457 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:13:33,481 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:13:33,484 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:13:34,323 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:13:34,765 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: ĞĞ° Ğ²Ğ°ÑˆĞµĞ¼ ÑÑ‡ĞµÑ‚Ñƒ ÑĞµĞ¹Ñ‡Ğ°Ñ 574 Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°. Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ ÑƒĞ·Ğ½Ğ°Ñ‚ÑŒ, ĞºĞ°Ğº Ğ¸Ñ… Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ
2025-05-30 16:13:34,765 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_38647f5e19'}
2025-05-30 16:13:34,765 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 469, 'output_tokens': 28, 'total_tokens': 497, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:13:34,765 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:469 C:28 T:497
2025-05-30 16:13:34,765 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 497 tokens recorded.
2025-05-30 16:13:34,766 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:13:34,766 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 16:13:34,767 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: ĞĞ° Ğ²Ğ°ÑˆĞµĞ¼ ÑÑ‡ĞµÑ‚Ñƒ ÑĞµĞ¹Ñ‡Ğ°Ñ 574 Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°. Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ ÑƒĞ·Ğ½Ğ°Ñ‚ÑŒ, ĞºĞ°Ğº Ğ¸Ñ… Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ...
2025-05-30 16:13:34,769 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 4568d90d-0b69-4f17-a256-b5d19355e489)
2025-05-30 16:13:34,769 - INFO - AGENT:agent_airsoft_0faa9616 - Found 3 token usage events for InteractionID: 4568d90d-0b69-4f17-a256-b5d19355e489.
2025-05-30 16:13:34,772 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: ĞĞ° Ğ²Ğ°ÑˆĞµĞ¼ ÑÑ‡ĞµÑ‚Ñƒ ÑĞµĞ¹Ñ‡Ğ°Ñ 574 Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°. Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ ÑƒĞ·Ğ½Ğ°Ñ‚ÑŒ, ĞºĞ°Ğº Ğ¸Ñ… Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ...
2025-05-30 16:13:34,772 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'ĞĞ° Ğ²Ğ°ÑˆĞµĞ¼ ÑÑ‡ĞµÑ‚Ñƒ ÑĞµĞ¹Ñ‡Ğ°Ñ 574 Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°. Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‚...'
2025-05-30 16:13:34,773 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '4568d90d-0b69-4f17-a256-b5d19355e489', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 363, 'completion_tokens': 12, 'total_tokens': 375, 'timestamp': '2025-05-30T11:13:31.296198+00:00'}
2025-05-30 16:13:34,773 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 4568d90d-0b69-4f17-a256-b5d19355e489
2025-05-30 16:13:34,777 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 4568d90d-0b69-4f17-a256-b5d19355e489, db_id: 996
2025-05-30 16:13:34,805 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 996 for interaction_id: 4568d90d-0b69-4f17-a256-b5d19355e489 on attempt 1
2025-05-30 16:13:34,810 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 4568d90d-0b69-4f17-a256-b5d19355e489, db_id: 464
2025-05-30 16:13:34,812 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '4568d90d-0b69-4f17-a256-b5d19355e489', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 469, 'completion_tokens': 28, 'total_tokens': 497, 'timestamp': '2025-05-30T11:13:34.765602+00:00'}
2025-05-30 16:13:34,812 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 4568d90d-0b69-4f17-a256-b5d19355e489
2025-05-30 16:13:34,813 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 996 for interaction_id: 4568d90d-0b69-4f17-a256-b5d19355e489 on attempt 1
2025-05-30 16:13:34,816 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 4568d90d-0b69-4f17-a256-b5d19355e489, db_id: 465
2025-05-30 16:13:34,819 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '4568d90d-0b69-4f17-a256-b5d19355e489', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 434, 'completion_tokens': 16, 'total_tokens': 450, 'timestamp': '2025-05-30T11:13:32.986372+00:00'}
2025-05-30 16:13:34,819 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 4568d90d-0b69-4f17-a256-b5d19355e489
2025-05-30 16:13:34,819 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 996 for interaction_id: 4568d90d-0b69-4f17-a256-b5d19355e489 on attempt 1
2025-05-30 16:13:34,821 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 4568d90d-0b69-4f17-a256-b5d19355e489, db_id: 466
2025-05-30 16:17:52,991 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 16:17:52,999 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 16:22:53,182 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 16:22:53,190 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 16:27:53,330 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 16:27:53,340 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 16:32:53,526 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 16:32:53,535 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 16:35:01,347 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 16:35:01,348 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 16:35:01,348 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 16:35:01,348 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4409810080) was cancelled.
2025-05-30 16:35:01,348 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4409810080) stopping. Performing cleanup...
2025-05-30 16:35:01,348 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:35:01,353 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 16:35:01,354 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 16:35:01,354 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:35:01,354 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 16:35:01,354 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:35:01,354 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4409810080) cleanup complete.
2025-05-30 16:35:01,354 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 16:35:01,354 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 16:35:01,354 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4425551312) was cancelled.
2025-05-30 16:35:01,354 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4425551312) stopping. Performing cleanup...
2025-05-30 16:35:01,354 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:35:01,357 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 16:35:01,358 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 16:35:01,358 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:35:01,359 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 16:35:01,359 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:35:01,359 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4425551312) cleanup complete.
2025-05-30 16:35:01,359 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 16:35:01,359 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 16:35:01,359 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4425557840) was cancelled.
2025-05-30 16:35:01,359 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4425557840) stopping. Performing cleanup...
2025-05-30 16:35:01,359 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 16:35:01,359 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:35:01,359 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:35:01,359 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 16:35:01,359 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:35:01,361 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 16:35:01,361 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 16:35:01,361 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:35:01,362 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 16:35:01,362 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:35:01,362 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 16:35:01,362 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4425557840) cleanup complete.
2025-05-30 16:35:01,362 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 16:35:01,362 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 16:35:01,362 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 16:35:01,369 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:35:01,369 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 16:35:01,838 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:35:01,839 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:35:01,842 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:35:01,842 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:35:01,842 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:35:01,842 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:35:01,842 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:35:01,842 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:35:01,842 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:35:01,842 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:35:01,842 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:35:01,843 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:35:01,843 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:35:01,845 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:35:01,845 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:35:01,845 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:35:01,845 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:35:01,845 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:35:01,861 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:35:01,861 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:35:01,864 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:35:01,864 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4426849440) setup complete. Starting run loop.
2025-05-30 16:35:01,864 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:35:01,864 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:35:01,865 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:35:01,865 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4438997472) setup complete. Starting run loop.
2025-05-30 16:35:01,865 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:35:01,865 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:35:01,865 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:35:01,897 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:35:01,897 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:35:01,898 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:35:01,898 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:35:01,898 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:35:01,899 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:35:01,899 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:35:01,900 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:35:01,900 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:35:01,900 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:35:03,136 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 16:35:03,136 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4517229536) received shutdown request. Initiating graceful shutdown...
2025-05-30 16:35:03,136 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4517229536)...
2025-05-30 16:35:03,136 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 16:35:03,136 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 16:35:03,136 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 16:35:03,136 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4517229536) was cancelled.
2025-05-30 16:35:03,137 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4517229536) stopping. Performing cleanup...
2025-05-30 16:35:03,137 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 16:35:03,137 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 16:35:03,137 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 16:35:03,137 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-30 16:35:03,138 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 16:35:03,138 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 16:35:03,138 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 16:35:03,138 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:35:03,138 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 16:35:03,138 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 16:35:03,138 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 16:35:03,142 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 16:35:03,143 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 16:35:03,143 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:35:03,144 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 16:35:03,144 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 16:35:03,144 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 16:35:03,144 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4517229536) cleanup complete.
2025-05-30 16:35:03,144 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 16:35:03,144 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 16:35:03,144 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:35:03,144 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 16:35:03,144 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 16:35:03,145 - INFO - __main__ - Agent runner main finished.
2025-05-30 16:35:03,309 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 16:35:03,310 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 16:35:03,310 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 16:35:03,310 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4426849440) was cancelled.
2025-05-30 16:35:03,310 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4426849440) stopping. Performing cleanup...
2025-05-30 16:35:03,310 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:35:03,314 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 16:35:03,315 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 16:35:03,315 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:35:03,315 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 16:35:03,315 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:35:03,315 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4426849440) cleanup complete.
2025-05-30 16:35:03,315 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 16:35:03,315 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 16:35:03,315 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4438997472) was cancelled.
2025-05-30 16:35:03,315 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4438997472) stopping. Performing cleanup...
2025-05-30 16:35:03,315 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:35:03,318 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 16:35:03,319 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 16:35:03,319 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:35:03,319 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 16:35:03,319 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:35:03,319 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4438997472) cleanup complete.
2025-05-30 16:35:03,319 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 16:35:03,319 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 16:35:03,319 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4438997520) was cancelled.
2025-05-30 16:35:03,319 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4438997520) stopping. Performing cleanup...
2025-05-30 16:35:03,319 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 16:35:03,319 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:35:03,319 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:35:03,319 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 16:35:03,319 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:35:03,321 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 16:35:03,322 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 16:35:03,322 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:35:03,322 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 16:35:03,322 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:35:03,322 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 16:35:03,322 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4438997520) cleanup complete.
2025-05-30 16:35:03,322 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 16:35:03,322 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 16:35:03,322 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 16:35:03,324 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:35:03,324 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 16:35:03,387 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 16:35:03,388 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 16:35:03,388 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 16:35:03,388 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4457546816) received shutdown request. Initiating graceful shutdown...
2025-05-30 16:35:03,388 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4457546816)...
2025-05-30 16:35:03,388 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 16:35:03,388 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 16:35:03,388 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4457546816) was cancelled.
2025-05-30 16:35:03,388 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4457546816) stopping. Performing cleanup...
2025-05-30 16:35:03,388 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 16:35:03,388 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 16:35:03,388 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 16:35:03,388 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 16:35:03,388 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 16:35:03,388 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 16:35:03,388 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:35:03,388 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 16:35:03,388 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 16:35:03,388 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 16:35:03,392 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 16:35:03,393 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 16:35:03,393 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:35:03,393 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 16:35:03,393 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 16:35:03,393 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 16:35:03,393 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4457546816) cleanup complete.
2025-05-30 16:35:03,393 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 16:35:03,393 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 16:35:03,398 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:35:03,398 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 16:35:03,398 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 16:35:03,399 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 16:35:07,423 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:35:07,423 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:35:07,427 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:35:07,427 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:35:07,427 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:35:07,427 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:35:07,427 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:35:07,428 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:35:07,428 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:35:07,428 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:35:07,428 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:35:07,428 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:35:07,428 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:35:07,430 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:35:07,430 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:35:07,430 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:35:07,444 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:35:07,444 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:35:07,444 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:35:07,444 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:35:07,445 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:35:07,445 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4466515104) setup complete. Starting run loop.
2025-05-30 16:35:07,445 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:35:07,446 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:35:07,447 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:35:07,447 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4470571472) setup complete. Starting run loop.
2025-05-30 16:35:07,447 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:35:07,448 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:35:07,448 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:35:07,474 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:35:07,474 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:35:07,476 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 16:35:07,477 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 82106
2025-05-30 16:35:07,477 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 82106
2025-05-30 16:35:07,478 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 16:35:07,478 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:35:07,478 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:35:07,479 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 16:35:07,480 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 82107
2025-05-30 16:35:07,480 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 82107
2025-05-30 16:35:07,481 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 16:35:07,481 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:35:07,481 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:35:07,481 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:35:07,481 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:35:08,366 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:35:08,366 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 16:35:08,367 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 16:35:08,367 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 16:35:08,367 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 82107
2025-05-30 16:35:08,367 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 16:35:08,367 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 16:35:08,367 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 16:35:08,372 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 16:35:08,385 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 16:35:08,386 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 16:35:08,386 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 16:35:08,386 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4546554016) setup complete. Starting run loop.
2025-05-30 16:35:08,386 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 16:35:08,386 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 16:35:08,386 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 16:35:08,386 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 16:35:08,386 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:35:08,386 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 16:35:08,386 - INFO - aiogram.dispatcher - Start polling
2025-05-30 16:35:08,389 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:35:08,630 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 16:35:08,749 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:35:08,749 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 16:35:08,749 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 16:35:08,749 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 16:35:08,749 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 82106
2025-05-30 16:35:08,749 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 16:35:08,749 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 16:35:08,749 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 16:35:08,795 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 16:35:08,795 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 16:35:08,838 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 16:35:08,838 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 16:35:08,838 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 16:35:08,838 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 16:35:08,838 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 16:35:08,838 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:35:08,864 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 16:35:08,864 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 16:35:08,864 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 16:35:08,865 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 16:35:08,866 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET)
2025-05-30 16:35:08,866 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 16:35:08,866 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 16:35:08,920 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 16:35:08,924 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 16:35:10,296 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 16:35:10,301 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 16:35:10,301 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 16:35:10,301 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 16:35:10,301 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 16:35:10,301 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 16:35:10,301 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 16:35:10,301 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 16:35:10,301 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 16:35:10,302 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 16:35:10,302 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 16:35:10,302 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 16:35:10,302 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 16:35:10,302 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 16:35:10,302 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 16:35:10,302 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 16:35:10,311 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 16:35:10,311 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 16:35:10,312 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 16:35:10,312 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4471092096) setup complete. Starting run loop.
2025-05-30 16:35:10,312 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 16:35:10,312 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 16:35:10,312 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 16:35:10,312 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:35:10,315 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:35:17,448 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 16:35:17,452 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 16:35:17,452 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4470571616) setup complete. Starting run loop.
2025-05-30 16:35:17,452 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 16:36:16,835 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ‚Ğ°Ğ¼ Ñƒ Ğ¼ĞµĞ½Ñ Ğ±Ğ±?...'
2025-05-30 16:36:16,837 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 16:36:16,911 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 16:36:16,911 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:36:16,911 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 16:36:16,911 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: c7dd0110-6203-44f4-bb45-c8d6015b99bc)
2025-05-30 16:36:16,912 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 16:36:16,912 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-30 16:36:16,934 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: c7dd0110-6203-44f4-bb45-c8d6015b99bc, db_id: 997
2025-05-30 16:36:16,949 - INFO - AGENT:agent_airsoft_0faa9616 - Loaded 20 messages from DB for thread '144641834'.
2025-05-30 16:36:16,950 - INFO - AGENT:agent_airsoft_0faa9616 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-30 16:36:16,950 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-30 16:36:16,998 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:36:16,999 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:36:17,024 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:36:17,027 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:36:17,911 - INFO - aiogram.event - Update id=804756342 is handled. Duration 1076 ms by bot id=1750613938
2025-05-30 16:36:18,583 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:36:18,612 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 16:36:18,612 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 16:36:18,612 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1078, 'output_tokens': 16, 'total_tokens': 1094, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:36:18,612 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1078 C:16 T:1094
2025-05-30 16:36:18,612 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1094 tokens recorded.
2025-05-30 16:36:18,613 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:36:18,613 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748589354598
2025-05-30 16:36:18,613 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748589354598)---
2025-05-30 16:36:18,614 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹'
2025-05-30 16:36:18,615 - INFO - app.agent_runner.common.tools_registry - Function parameters: api_config=True, log_adapter=True, state=True
2025-05-30 16:36:18,615 - INFO - app.agent_runner.common.tools_registry - State type: <class 'dict'>
2025-05-30 16:36:18,615 - INFO - app.agent_runner.common.tools_registry - State keys: ['messages', 'documents', 'question', 'original_question', 'rewrite_count', 'channel', 'user_data', 'token_usage_events']
2025-05-30 16:36:18,615 - INFO - app.agent_runner.common.tools_registry - User data extracted: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:36:18,615 - INFO - app.agent_runner.common.tools_registry - Final user_data for API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹': {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:36:18,615 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:36:18,615 - INFO - app.agent_runner.common.tools_registry - Attempting Cloudflare bypass with cloudscraper for https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:36:19,097 - WARNING - app.agent_runner.common.tools_registry - Failed to parse JSON response: Expecting value: line 1 column 1 (char 0)
2025-05-30 16:36:19,099 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:36:19,099 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:36:19,123 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:36:19,126 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:36:19,959 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:36:20,336 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ£ Ñ‚ĞµĞ±Ñ Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ 574 Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°! Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ñ€Ğ°ÑÑĞºĞ°Ğ¶Ñƒ, ĞºĞ°Ğº Ğ¸Ñ… Ğ²Ñ‹Ğ³Ğ¾Ğ´Ğ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ? ğŸ˜‰
2025-05-30 16:36:20,336 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 16:36:20,336 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1113, 'output_tokens': 27, 'total_tokens': 1140, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:36:20,336 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1113 C:27 T:1140
2025-05-30 16:36:20,336 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1140 tokens recorded.
2025-05-30 16:36:20,337 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:36:20,337 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 16:36:20,338 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ£ Ñ‚ĞµĞ±Ñ Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ 574 Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°! Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ñ€Ğ°ÑÑĞºĞ°Ğ¶Ñƒ, ĞºĞ°Ğº Ğ¸Ñ… Ğ²Ñ‹Ğ³Ğ¾Ğ´Ğ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ? ğŸ˜‰...
2025-05-30 16:36:20,340 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: c7dd0110-6203-44f4-bb45-c8d6015b99bc)
2025-05-30 16:36:20,340 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: c7dd0110-6203-44f4-bb45-c8d6015b99bc.
2025-05-30 16:36:20,342 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Ğ£ Ñ‚ĞµĞ±Ñ Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ 574 Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°! Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ñ€Ğ°ÑÑĞºĞ°Ğ¶Ñƒ, ĞºĞ°Ğº Ğ¸Ñ… Ğ²Ñ‹Ğ³Ğ¾Ğ´Ğ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ? ğŸ˜‰...
2025-05-30 16:36:20,342 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Ğ£ Ñ‚ĞµĞ±Ñ Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ 574 Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°! Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ñ€...'
2025-05-30 16:36:20,343 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'c7dd0110-6203-44f4-bb45-c8d6015b99bc', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1078, 'completion_tokens': 16, 'total_tokens': 1094, 'timestamp': '2025-05-30T11:36:18.612354+00:00'}
2025-05-30 16:36:20,343 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: c7dd0110-6203-44f4-bb45-c8d6015b99bc
2025-05-30 16:36:20,346 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: c7dd0110-6203-44f4-bb45-c8d6015b99bc, db_id: 998
2025-05-30 16:36:20,376 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 998 for interaction_id: c7dd0110-6203-44f4-bb45-c8d6015b99bc on attempt 1
2025-05-30 16:36:20,383 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: c7dd0110-6203-44f4-bb45-c8d6015b99bc, db_id: 467
2025-05-30 16:36:20,386 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'c7dd0110-6203-44f4-bb45-c8d6015b99bc', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1113, 'completion_tokens': 27, 'total_tokens': 1140, 'timestamp': '2025-05-30T11:36:20.336599+00:00'}
2025-05-30 16:36:20,386 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: c7dd0110-6203-44f4-bb45-c8d6015b99bc
2025-05-30 16:36:20,388 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 998 for interaction_id: c7dd0110-6203-44f4-bb45-c8d6015b99bc on attempt 1
2025-05-30 16:36:20,391 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: c7dd0110-6203-44f4-bb45-c8d6015b99bc, db_id: 468
2025-05-30 16:40:17,642 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 16:40:17,651 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 16:44:45,339 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 16:44:45,341 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 16:44:45,341 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 16:44:45,342 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4466515104) was cancelled.
2025-05-30 16:44:45,342 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4466515104) stopping. Performing cleanup...
2025-05-30 16:44:45,342 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:44:45,345 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 16:44:45,346 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 16:44:45,346 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:44:45,347 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 16:44:45,347 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:44:45,347 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4466515104) cleanup complete.
2025-05-30 16:44:45,347 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 16:44:45,347 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 16:44:45,347 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4470571472) was cancelled.
2025-05-30 16:44:45,347 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4470571472) stopping. Performing cleanup...
2025-05-30 16:44:45,347 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:44:45,351 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 16:44:45,352 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 16:44:45,352 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:44:45,352 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 16:44:45,352 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:44:45,352 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4470571472) cleanup complete.
2025-05-30 16:44:45,352 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 16:44:45,352 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 16:44:45,352 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4470571616) was cancelled.
2025-05-30 16:44:45,352 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4470571616) stopping. Performing cleanup...
2025-05-30 16:44:45,352 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 16:44:45,352 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:44:45,352 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:44:45,352 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 16:44:45,352 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:44:45,354 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 16:44:45,355 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 16:44:45,355 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:44:45,355 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 16:44:45,355 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:44:45,355 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 16:44:45,356 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4470571616) cleanup complete.
2025-05-30 16:44:45,356 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 16:44:45,356 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 16:44:45,356 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 16:44:45,365 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:44:45,365 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 16:44:45,830 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:44:45,830 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:44:45,834 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:44:45,834 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:44:45,834 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:44:45,834 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:44:45,834 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:44:45,834 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:44:45,834 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:44:45,834 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:44:45,835 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:44:45,835 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:44:45,835 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:44:45,837 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:44:45,837 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:44:45,837 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:44:45,852 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:44:45,852 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:44:45,852 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:44:45,852 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:44:45,855 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:44:45,855 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4412351040) setup complete. Starting run loop.
2025-05-30 16:44:45,855 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:44:45,855 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:44:45,855 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:44:45,856 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4412179808) setup complete. Starting run loop.
2025-05-30 16:44:45,856 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:44:45,857 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:44:45,857 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:44:45,887 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:44:45,887 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:44:45,888 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:44:45,888 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:44:45,888 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:44:45,888 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:44:45,889 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:44:45,889 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:44:45,889 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:44:45,889 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:44:48,155 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 16:44:48,155 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4471092096) received shutdown request. Initiating graceful shutdown...
2025-05-30 16:44:48,155 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4471092096)...
2025-05-30 16:44:48,155 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 16:44:48,155 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 16:44:48,155 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 16:44:48,155 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4471092096) was cancelled.
2025-05-30 16:44:48,155 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4471092096) stopping. Performing cleanup...
2025-05-30 16:44:48,156 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 16:44:48,156 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 16:44:48,156 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 16:44:48,157 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-30 16:44:48,158 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 16:44:48,158 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 16:44:48,158 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 16:44:48,158 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:44:48,160 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 16:44:48,160 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 16:44:48,160 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 16:44:48,164 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 16:44:48,165 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 16:44:48,165 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:44:48,165 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 16:44:48,165 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 16:44:48,165 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 16:44:48,165 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4471092096) cleanup complete.
2025-05-30 16:44:48,165 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 16:44:48,165 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 16:44:48,172 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:44:48,172 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 16:44:48,172 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 16:44:48,173 - INFO - __main__ - Agent runner main finished.
2025-05-30 16:44:48,307 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 16:44:48,307 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 16:44:48,307 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 16:44:48,307 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4412351040) was cancelled.
2025-05-30 16:44:48,307 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4412351040) stopping. Performing cleanup...
2025-05-30 16:44:48,307 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:44:48,312 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 16:44:48,312 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 16:44:48,312 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:44:48,313 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 16:44:48,313 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:44:48,313 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4412351040) cleanup complete.
2025-05-30 16:44:48,313 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 16:44:48,313 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 16:44:48,313 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4412179808) was cancelled.
2025-05-30 16:44:48,313 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4412179808) stopping. Performing cleanup...
2025-05-30 16:44:48,313 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:44:48,315 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 16:44:48,316 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 16:44:48,316 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:44:48,316 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 16:44:48,316 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:44:48,316 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4412179808) cleanup complete.
2025-05-30 16:44:48,316 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 16:44:48,316 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 16:44:48,316 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4412179616) was cancelled.
2025-05-30 16:44:48,316 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4412179616) stopping. Performing cleanup...
2025-05-30 16:44:48,316 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 16:44:48,316 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:44:48,317 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:44:48,317 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 16:44:48,317 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:44:48,318 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 16:44:48,319 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 16:44:48,319 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:44:48,319 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 16:44:48,319 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:44:48,319 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 16:44:48,319 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4412179616) cleanup complete.
2025-05-30 16:44:48,319 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 16:44:48,319 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 16:44:48,319 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 16:44:48,322 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:44:48,322 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 16:44:48,408 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 16:44:48,408 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 16:44:48,408 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 16:44:48,408 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4546554016) received shutdown request. Initiating graceful shutdown...
2025-05-30 16:44:48,408 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4546554016)...
2025-05-30 16:44:48,408 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 16:44:48,408 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 16:44:48,408 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4546554016) was cancelled.
2025-05-30 16:44:48,408 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4546554016) stopping. Performing cleanup...
2025-05-30 16:44:48,408 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 16:44:48,408 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 16:44:48,408 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 16:44:48,408 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 16:44:48,408 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 16:44:48,408 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 16:44:48,408 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:44:48,408 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 16:44:48,409 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 16:44:48,409 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 16:44:48,413 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 16:44:48,414 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 16:44:48,414 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:44:48,414 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 16:44:48,414 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 16:44:48,414 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 16:44:48,414 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4546554016) cleanup complete.
2025-05-30 16:44:48,414 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 16:44:48,414 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 16:44:48,418 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:44:48,418 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 16:44:48,418 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 16:44:48,419 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 16:44:49,838 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:44:49,838 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:44:49,842 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:44:49,842 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:44:49,842 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:44:49,842 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:44:49,842 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:44:49,843 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:44:49,843 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:44:49,843 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:44:49,843 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:44:49,843 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:44:49,843 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:44:49,845 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:44:49,845 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:44:49,845 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:44:49,845 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:44:49,845 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:44:49,859 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:44:49,859 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:44:49,860 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:44:49,861 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:44:49,861 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4405560144) setup complete. Starting run loop.
2025-05-30 16:44:49,861 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:44:49,861 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:44:49,861 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4405559952) setup complete. Starting run loop.
2025-05-30 16:44:49,861 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:44:49,864 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:44:49,864 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:44:49,890 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:44:49,890 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:44:49,892 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 16:44:49,893 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 82397
2025-05-30 16:44:49,893 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 82397
2025-05-30 16:44:49,893 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 16:44:49,893 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:44:49,893 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:44:49,895 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 16:44:49,896 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 82398
2025-05-30 16:44:49,896 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 82398
2025-05-30 16:44:49,896 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 16:44:49,897 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:44:49,897 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:44:49,897 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:44:49,897 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:44:50,761 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:44:50,762 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 16:44:50,762 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 16:44:50,762 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 16:44:50,762 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 82398
2025-05-30 16:44:50,762 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 16:44:50,762 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 16:44:50,762 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 16:44:50,767 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 16:44:50,781 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 16:44:50,781 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 16:44:50,781 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 16:44:50,781 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4389349536) setup complete. Starting run loop.
2025-05-30 16:44:50,781 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 16:44:50,781 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 16:44:50,781 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 16:44:50,781 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 16:44:50,781 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:44:50,781 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 16:44:50,781 - INFO - aiogram.dispatcher - Start polling
2025-05-30 16:44:50,785 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:44:51,039 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 16:44:51,106 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:44:51,107 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 16:44:51,107 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 16:44:51,107 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 16:44:51,107 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 82397
2025-05-30 16:44:51,107 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 16:44:51,107 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 16:44:51,107 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 16:44:51,147 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 16:44:51,147 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 16:44:51,192 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 16:44:51,192 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 16:44:51,192 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 16:44:51,192 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 16:44:51,192 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 16:44:51,192 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:44:51,217 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 16:44:51,218 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 16:44:51,218 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 16:44:51,219 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 16:44:51,219 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET)
2025-05-30 16:44:51,220 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 16:44:51,220 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 16:44:51,277 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 16:44:51,280 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 16:44:52,141 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 16:44:52,143 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 16:44:52,143 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 16:44:52,143 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 16:44:52,143 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 16:44:52,144 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 16:44:52,144 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 16:44:52,144 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 16:44:52,144 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 16:44:52,144 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 16:44:52,144 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 16:44:52,144 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 16:44:52,144 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 16:44:52,145 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 16:44:52,145 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 16:44:52,145 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 16:44:52,154 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 16:44:52,154 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 16:44:52,154 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 16:44:52,154 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4499404032) setup complete. Starting run loop.
2025-05-30 16:44:52,155 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 16:44:52,155 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 16:44:52,155 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 16:44:52,155 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:44:52,158 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:44:59,865 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 16:44:59,869 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 16:44:59,870 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4405560096) setup complete. Starting run loop.
2025-05-30 16:44:59,870 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 16:45:11,144 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ¼Ğ¾Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ...'
2025-05-30 16:45:11,145 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 16:45:11,207 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 16:45:11,207 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 16:45:11,209 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:45:11,210 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: aabee661-f032-4161-8a2d-52c10befed51)
2025-05-30 16:45:11,210 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 16:45:11,211 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-30 16:45:11,231 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: aabee661-f032-4161-8a2d-52c10befed51, db_id: 999
2025-05-30 16:45:11,247 - INFO - AGENT:agent_airsoft_0faa9616 - Loaded 20 messages from DB for thread '144641834'.
2025-05-30 16:45:11,248 - INFO - AGENT:agent_airsoft_0faa9616 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-30 16:45:11,248 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-30 16:45:11,305 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:45:11,305 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:45:11,330 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:45:11,334 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:45:12,210 - INFO - aiogram.event - Update id=804756343 is handled. Duration 1066 ms by bot id=1750613938
2025-05-30 16:45:12,815 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:45:12,872 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 16:45:12,872 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 16:45:12,872 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1060, 'output_tokens': 16, 'total_tokens': 1076, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:45:12,872 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1060 C:16 T:1076
2025-05-30 16:45:12,872 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1076 tokens recorded.
2025-05-30 16:45:12,873 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:45:12,873 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748589354598
2025-05-30 16:45:12,873 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748589354598)---
2025-05-30 16:45:12,874 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹'
2025-05-30 16:45:12,874 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:45:12,874 - INFO - app.agent_runner.common.tools_registry - Attempting Cloudflare bypass with cloudscraper for https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:45:13,371 - INFO - app.agent_runner.common.tools_registry - Decoded content: ï¿½574... (truncated for preview)
2025-05-30 16:45:13,371 - WARNING - app.agent_runner.common.tools_registry - Failed to parse JSON response: Expecting value: line 1 column 1 (char 0)
2025-05-30 16:45:13,373 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:45:13,373 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:45:13,397 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:45:13,400 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:45:14,278 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:45:14,740 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ¢Ğ²Ğ¾Ğ¹ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² â€” 574 Ğ±Ğ±. Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ´ÑĞºĞ°Ğ·Ğ°Ñ‚ÑŒ, ĞºĞ°Ğº Ğ¸Ñ… Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ğ»Ğ¸ 
2025-05-30 16:45:14,740 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_38647f5e19'}
2025-05-30 16:45:14,740 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1095, 'output_tokens': 33, 'total_tokens': 1128, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:45:14,740 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1095 C:33 T:1128
2025-05-30 16:45:14,740 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1128 tokens recorded.
2025-05-30 16:45:14,741 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:45:14,741 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 16:45:14,742 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ¢Ğ²Ğ¾Ğ¹ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² â€” 574 Ğ±Ğ±. Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ´ÑĞºĞ°Ğ·Ğ°Ñ‚ÑŒ, ĞºĞ°Ğº Ğ¸Ñ… Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ğ»Ğ¸ ...
2025-05-30 16:45:14,744 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: aabee661-f032-4161-8a2d-52c10befed51)
2025-05-30 16:45:14,744 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: aabee661-f032-4161-8a2d-52c10befed51.
2025-05-30 16:45:14,746 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Ğ¢Ğ²Ğ¾Ğ¹ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² â€” 574 Ğ±Ğ±. Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ´ÑĞºĞ°Ğ·Ğ°Ñ‚ÑŒ, ĞºĞ°Ğº Ğ¸Ñ… Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ğ»Ğ¸ ...
2025-05-30 16:45:14,746 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Ğ¢Ğ²Ğ¾Ğ¹ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² â€” 574 Ğ±Ğ±. Ğ•ÑĞ»Ğ¸...'
2025-05-30 16:45:14,747 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'aabee661-f032-4161-8a2d-52c10befed51', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1060, 'completion_tokens': 16, 'total_tokens': 1076, 'timestamp': '2025-05-30T11:45:12.872133+00:00'}
2025-05-30 16:45:14,747 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: aabee661-f032-4161-8a2d-52c10befed51
2025-05-30 16:45:14,751 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: aabee661-f032-4161-8a2d-52c10befed51, db_id: 1000
2025-05-30 16:45:14,781 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1000 for interaction_id: aabee661-f032-4161-8a2d-52c10befed51 on attempt 1
2025-05-30 16:45:14,788 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: aabee661-f032-4161-8a2d-52c10befed51, db_id: 469
2025-05-30 16:45:14,791 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'aabee661-f032-4161-8a2d-52c10befed51', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1095, 'completion_tokens': 33, 'total_tokens': 1128, 'timestamp': '2025-05-30T11:45:14.740566+00:00'}
2025-05-30 16:45:14,791 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: aabee661-f032-4161-8a2d-52c10befed51
2025-05-30 16:45:14,793 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1000 for interaction_id: aabee661-f032-4161-8a2d-52c10befed51 on attempt 1
2025-05-30 16:45:14,797 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: aabee661-f032-4161-8a2d-52c10befed51, db_id: 470
2025-05-30 16:46:38,310 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 16:46:38,310 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 16:46:38,310 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 16:46:38,310 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4405560144) was cancelled.
2025-05-30 16:46:38,311 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4405560144) stopping. Performing cleanup...
2025-05-30 16:46:38,311 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:46:38,315 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 16:46:38,316 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 16:46:38,316 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:46:38,316 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 16:46:38,316 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:46:38,316 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4405560144) cleanup complete.
2025-05-30 16:46:38,316 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 16:46:38,316 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 16:46:38,316 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4405559952) was cancelled.
2025-05-30 16:46:38,317 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4405559952) stopping. Performing cleanup...
2025-05-30 16:46:38,317 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:46:38,320 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 16:46:38,320 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 16:46:38,320 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:46:38,321 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 16:46:38,321 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:46:38,321 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4405559952) cleanup complete.
2025-05-30 16:46:38,321 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 16:46:38,321 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 16:46:38,321 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4405560096) was cancelled.
2025-05-30 16:46:38,321 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4405560096) stopping. Performing cleanup...
2025-05-30 16:46:38,321 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 16:46:38,321 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:46:38,321 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:46:38,321 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 16:46:38,321 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:46:38,323 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 16:46:38,324 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 16:46:38,324 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:46:38,324 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 16:46:38,324 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:46:38,324 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 16:46:38,324 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4405560096) cleanup complete.
2025-05-30 16:46:38,324 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 16:46:38,324 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 16:46:38,324 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 16:46:38,329 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:46:38,329 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 16:46:38,745 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:46:38,745 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:46:38,750 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:46:38,750 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:46:38,750 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:46:38,750 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:46:38,750 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:46:38,750 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:46:38,750 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:46:38,750 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:46:38,750 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:46:38,750 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:46:38,751 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:46:38,753 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:46:38,768 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:46:38,768 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:46:38,768 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:46:38,768 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:46:38,768 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:46:38,768 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:46:38,771 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:46:38,771 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4440686560) setup complete. Starting run loop.
2025-05-30 16:46:38,771 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:46:38,771 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:46:38,772 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:46:38,772 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4440785024) setup complete. Starting run loop.
2025-05-30 16:46:38,772 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:46:38,773 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:46:38,773 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:46:38,800 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:46:38,800 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:46:38,801 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:46:38,801 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:46:38,802 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:46:38,803 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:46:38,803 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:46:38,803 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:46:38,803 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:46:38,803 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:46:48,774 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 16:46:48,778 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 16:46:48,778 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4440785120) setup complete. Starting run loop.
2025-05-30 16:46:48,778 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 16:47:01,239 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 16:47:01,239 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 16:47:01,239 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4499404032) received shutdown request. Initiating graceful shutdown...
2025-05-30 16:47:01,239 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4499404032)...
2025-05-30 16:47:01,239 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 16:47:01,239 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 16:47:01,240 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4499404032) was cancelled.
2025-05-30 16:47:01,240 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4499404032) stopping. Performing cleanup...
2025-05-30 16:47:01,240 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 16:47:01,240 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 16:47:01,240 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 16:47:01,241 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-30 16:47:01,241 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 16:47:01,241 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 16:47:01,241 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 16:47:01,241 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:47:01,242 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 16:47:01,242 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 16:47:01,242 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 16:47:01,245 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 16:47:01,246 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 16:47:01,246 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:47:01,246 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 16:47:01,246 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 16:47:01,246 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 16:47:01,246 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4499404032) cleanup complete.
2025-05-30 16:47:01,246 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 16:47:01,246 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 16:47:01,249 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:47:01,249 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 16:47:01,249 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 16:47:01,250 - INFO - __main__ - Agent runner main finished.
2025-05-30 16:47:01,350 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 16:47:01,350 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 16:47:01,350 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 16:47:01,350 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4440686560) was cancelled.
2025-05-30 16:47:01,350 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4440686560) stopping. Performing cleanup...
2025-05-30 16:47:01,350 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:47:01,354 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 16:47:01,355 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 16:47:01,355 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:47:01,355 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 16:47:01,355 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:47:01,355 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4440686560) cleanup complete.
2025-05-30 16:47:01,355 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 16:47:01,355 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 16:47:01,355 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4440785024) was cancelled.
2025-05-30 16:47:01,355 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4440785024) stopping. Performing cleanup...
2025-05-30 16:47:01,355 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:47:01,358 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 16:47:01,359 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 16:47:01,359 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:47:01,359 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 16:47:01,359 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:47:01,359 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4440785024) cleanup complete.
2025-05-30 16:47:01,359 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 16:47:01,359 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 16:47:01,359 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4440785120) was cancelled.
2025-05-30 16:47:01,359 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4440785120) stopping. Performing cleanup...
2025-05-30 16:47:01,359 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 16:47:01,359 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:47:01,359 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:47:01,359 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 16:47:01,359 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:47:01,361 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 16:47:01,362 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 16:47:01,362 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:47:01,362 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 16:47:01,362 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:47:01,362 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 16:47:01,362 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4440785120) cleanup complete.
2025-05-30 16:47:01,362 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 16:47:01,362 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 16:47:01,362 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 16:47:01,365 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:47:01,365 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 16:47:01,491 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 16:47:01,491 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 16:47:01,491 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 16:47:01,491 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4389349536) received shutdown request. Initiating graceful shutdown...
2025-05-30 16:47:01,491 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4389349536)...
2025-05-30 16:47:01,491 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 16:47:01,491 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 16:47:01,491 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4389349536) was cancelled.
2025-05-30 16:47:01,491 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4389349536) stopping. Performing cleanup...
2025-05-30 16:47:01,491 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 16:47:01,491 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 16:47:01,491 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 16:47:01,491 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 16:47:01,491 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 16:47:01,491 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 16:47:01,491 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:47:01,492 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 16:47:01,492 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 16:47:01,492 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 16:47:01,496 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 16:47:01,497 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 16:47:01,497 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:47:01,497 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 16:47:01,497 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 16:47:01,497 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 16:47:01,497 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4389349536) cleanup complete.
2025-05-30 16:47:01,497 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 16:47:01,497 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 16:47:01,499 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:47:01,499 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 16:47:01,499 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 16:47:01,500 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 16:47:05,359 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:47:05,359 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:47:05,363 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:47:05,363 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:47:05,363 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:47:05,363 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:47:05,363 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:47:05,364 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:47:05,364 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:47:05,364 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:47:05,364 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:47:05,364 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:47:05,364 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:47:05,366 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:47:05,366 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:47:05,366 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:47:05,366 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:47:05,366 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:47:05,380 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:47:05,380 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:47:05,382 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:47:05,382 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4442817504) setup complete. Starting run loop.
2025-05-30 16:47:05,382 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:47:05,383 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:47:05,385 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:47:05,385 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4442831136) setup complete. Starting run loop.
2025-05-30 16:47:05,385 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:47:05,396 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:47:05,396 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:47:05,414 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:47:05,414 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:47:05,416 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 16:47:05,417 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 82558
2025-05-30 16:47:05,417 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 82558
2025-05-30 16:47:05,418 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 16:47:05,418 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:47:05,418 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:47:05,419 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 16:47:05,420 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 82559
2025-05-30 16:47:05,420 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 82559
2025-05-30 16:47:05,420 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 16:47:05,421 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:47:05,421 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:47:05,421 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:47:05,421 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:47:06,268 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:47:06,268 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 16:47:06,268 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 16:47:06,268 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 16:47:06,268 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 82559
2025-05-30 16:47:06,268 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 16:47:06,268 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 16:47:06,268 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 16:47:06,274 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 16:47:06,287 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 16:47:06,287 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 16:47:06,287 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 16:47:06,287 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4611092032) setup complete. Starting run loop.
2025-05-30 16:47:06,287 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 16:47:06,287 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 16:47:06,287 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 16:47:06,287 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 16:47:06,287 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:47:06,288 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 16:47:06,288 - INFO - aiogram.dispatcher - Start polling
2025-05-30 16:47:06,290 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:47:06,528 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 16:47:06,620 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:47:06,621 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 16:47:06,621 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 16:47:06,621 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 16:47:06,621 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 82558
2025-05-30 16:47:06,621 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 16:47:06,621 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 16:47:06,621 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 16:47:06,663 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 16:47:06,663 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 16:47:06,705 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 16:47:06,706 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 16:47:06,706 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 16:47:06,706 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 16:47:06,706 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 16:47:06,706 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:47:06,731 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 16:47:06,731 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 16:47:06,731 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 16:47:06,732 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 16:47:06,733 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET)
2025-05-30 16:47:06,733 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 16:47:06,733 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 16:47:06,788 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 16:47:06,792 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 16:47:07,400 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 16:47:07,405 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 16:47:07,405 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 16:47:07,405 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 16:47:07,405 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 16:47:07,405 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 16:47:07,405 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 16:47:07,405 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 16:47:07,405 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 16:47:07,406 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 16:47:07,406 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 16:47:07,407 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 16:47:07,407 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 16:47:07,407 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 16:47:07,407 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 16:47:07,407 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 16:47:07,418 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 16:47:07,418 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 16:47:07,418 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 16:47:07,418 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4639782432) setup complete. Starting run loop.
2025-05-30 16:47:07,418 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 16:47:07,418 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 16:47:07,418 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 16:47:07,418 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:47:07,421 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:47:15,398 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 16:47:15,403 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 16:47:15,403 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4442831184) setup complete. Starting run loop.
2025-05-30 16:47:15,403 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 16:47:30,544 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñƒ Ğ¼ĞµĞ½Ñ Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ?...'
2025-05-30 16:47:30,545 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 16:47:30,615 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 16:47:30,615 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 16:47:30,615 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:47:30,615 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: fff05602-6bec-471f-9f8d-e1a215c9b1f7)
2025-05-30 16:47:30,615 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 16:47:30,616 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-30 16:47:30,636 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: fff05602-6bec-471f-9f8d-e1a215c9b1f7, db_id: 1001
2025-05-30 16:47:30,651 - INFO - AGENT:agent_airsoft_0faa9616 - Loaded 20 messages from DB for thread '144641834'.
2025-05-30 16:47:30,651 - INFO - AGENT:agent_airsoft_0faa9616 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-30 16:47:30,651 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-30 16:47:30,720 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:47:30,720 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:47:30,745 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:47:30,748 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:47:31,615 - INFO - aiogram.event - Update id=804756344 is handled. Duration 1072 ms by bot id=1750613938
2025-05-30 16:47:31,877 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:47:31,883 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 16:47:31,883 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 16:47:31,883 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1043, 'output_tokens': 16, 'total_tokens': 1059, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:47:31,883 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1043 C:16 T:1059
2025-05-30 16:47:31,883 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1059 tokens recorded.
2025-05-30 16:47:31,884 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:47:31,884 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748589354598
2025-05-30 16:47:31,884 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748589354598)---
2025-05-30 16:47:31,886 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹'
2025-05-30 16:47:31,886 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:47:31,886 - INFO - app.agent_runner.common.tools_registry - Attempting Cloudflare bypass with cloudscraper for https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:47:32,404 - INFO - app.agent_runner.common.tools_registry - API Response Content Preview (first 1000 chars): ï¿½574
2025-05-30 16:47:32,404 - WARNING - app.agent_runner.common.tools_registry - Failed to parse JSON response: Expecting value: line 1 column 1 (char 0)
2025-05-30 16:47:32,405 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:47:32,406 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:47:32,430 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:47:32,432 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:47:33,230 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:47:33,719 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ£ Ñ‚ĞµĞ±Ñ Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ 574 Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°! Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ Ñ Ğ¸Ğ´ĞµÑĞ¼Ğ¸, ĞºĞ°Ğº Ğ¸Ñ… Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°
2025-05-30 16:47:33,719 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_38647f5e19'}
2025-05-30 16:47:33,719 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1078, 'output_tokens': 32, 'total_tokens': 1110, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:47:33,719 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1078 C:32 T:1110
2025-05-30 16:47:33,719 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1110 tokens recorded.
2025-05-30 16:47:33,720 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:47:33,720 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 16:47:33,721 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ£ Ñ‚ĞµĞ±Ñ Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ 574 Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°! Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ Ñ Ğ¸Ğ´ĞµÑĞ¼Ğ¸, ĞºĞ°Ğº Ğ¸Ñ… Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°...
2025-05-30 16:47:33,722 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: fff05602-6bec-471f-9f8d-e1a215c9b1f7)
2025-05-30 16:47:33,722 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: fff05602-6bec-471f-9f8d-e1a215c9b1f7.
2025-05-30 16:47:33,725 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Ğ£ Ñ‚ĞµĞ±Ñ Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ 574 Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°! Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ Ñ Ğ¸Ğ´ĞµÑĞ¼Ğ¸, ĞºĞ°Ğº Ğ¸Ñ… Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°...
2025-05-30 16:47:33,725 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Ğ£ Ñ‚ĞµĞ±Ñ Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ 574 Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°! Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ğ¼...'
2025-05-30 16:47:33,727 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'fff05602-6bec-471f-9f8d-e1a215c9b1f7', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1043, 'completion_tokens': 16, 'total_tokens': 1059, 'timestamp': '2025-05-30T11:47:31.883419+00:00'}
2025-05-30 16:47:33,727 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: fff05602-6bec-471f-9f8d-e1a215c9b1f7
2025-05-30 16:47:33,731 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: fff05602-6bec-471f-9f8d-e1a215c9b1f7, db_id: 1002
2025-05-30 16:47:33,760 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1002 for interaction_id: fff05602-6bec-471f-9f8d-e1a215c9b1f7 on attempt 1
2025-05-30 16:47:33,766 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: fff05602-6bec-471f-9f8d-e1a215c9b1f7, db_id: 471
2025-05-30 16:47:33,769 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'fff05602-6bec-471f-9f8d-e1a215c9b1f7', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1078, 'completion_tokens': 32, 'total_tokens': 1110, 'timestamp': '2025-05-30T11:47:33.719719+00:00'}
2025-05-30 16:47:33,769 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: fff05602-6bec-471f-9f8d-e1a215c9b1f7
2025-05-30 16:47:33,770 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1002 for interaction_id: fff05602-6bec-471f-9f8d-e1a215c9b1f7 on attempt 1
2025-05-30 16:47:33,773 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: fff05602-6bec-471f-9f8d-e1a215c9b1f7, db_id: 472
2025-05-30 16:48:13,547 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 16:48:13,548 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 16:48:13,548 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 16:48:13,548 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4442817504) was cancelled.
2025-05-30 16:48:13,548 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4442817504) stopping. Performing cleanup...
2025-05-30 16:48:13,548 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:48:13,554 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 16:48:13,555 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 16:48:13,555 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:48:13,555 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 16:48:13,555 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:48:13,555 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4442817504) cleanup complete.
2025-05-30 16:48:13,555 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 16:48:13,555 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 16:48:13,555 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4442831136) was cancelled.
2025-05-30 16:48:13,555 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4442831136) stopping. Performing cleanup...
2025-05-30 16:48:13,555 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:48:13,558 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 16:48:13,559 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 16:48:13,559 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:48:13,564 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 16:48:13,565 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:48:13,565 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4442831136) cleanup complete.
2025-05-30 16:48:13,566 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 16:48:13,566 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 16:48:13,567 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4442831184) was cancelled.
2025-05-30 16:48:13,568 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4442831184) stopping. Performing cleanup...
2025-05-30 16:48:13,568 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 16:48:13,568 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:48:13,570 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:48:13,570 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 16:48:13,571 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:48:13,576 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 16:48:13,577 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 16:48:13,577 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:48:13,577 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 16:48:13,577 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:48:13,577 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 16:48:13,577 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4442831184) cleanup complete.
2025-05-30 16:48:13,578 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 16:48:13,578 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 16:48:13,578 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 16:48:13,585 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:48:13,585 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 16:48:14,039 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:48:14,039 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:48:14,042 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:48:14,042 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:48:14,042 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:48:14,042 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:48:14,042 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:48:14,042 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:48:14,042 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:48:14,042 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:48:14,042 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:48:14,043 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:48:14,043 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:48:14,044 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:48:14,058 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:48:14,058 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:48:14,059 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:48:14,059 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:48:14,059 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:48:14,059 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:48:14,060 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:48:14,060 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4361707808) setup complete. Starting run loop.
2025-05-30 16:48:14,060 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:48:14,061 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:48:14,061 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:48:14,061 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4368651456) setup complete. Starting run loop.
2025-05-30 16:48:14,061 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:48:14,072 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:48:14,072 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:48:14,087 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:48:14,088 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:48:14,089 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:48:14,089 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:48:14,089 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:48:14,089 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:48:14,090 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:48:14,090 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:48:14,090 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:48:14,090 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:48:24,073 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 16:48:24,079 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 16:48:24,079 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4369300224) setup complete. Starting run loop.
2025-05-30 16:48:24,079 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 16:48:48,426 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-30 16:48:48,434 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-30 16:48:48,435 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-30 16:48:48,435 - INFO - app.db.crud.agent_crud - Updating agent config in DB for agent_id: agent_airsoft_0faa9616
2025-05-30 16:48:48,447 - INFO - app.db.crud.agent_crud - Agent config updated successfully for agent_id: agent_airsoft_0faa9616
2025-05-30 16:48:48,447 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616 was running. Attempting to restart it after config update.
2025-05-30 16:48:48,447 - INFO - app.services.process_manager - Restarting agent process for agent_airsoft_0faa9616...
2025-05-30 16:48:48,449 - INFO - app.services.process_manager - Stopping agent process agent_airsoft_0faa9616 (PID: 82558). Force: True
2025-05-30 16:48:48,449 - INFO - app.services.process_manager - SIGTERM sent to agent agent_airsoft_0faa9616 (PID: 82558)
2025-05-30 16:48:48,549 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 (PID: 82558) terminated gracefully after SIGTERM.
2025-05-30 16:48:48,551 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 marked as stopped in Redis.
2025-05-30 16:48:48,551 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 stopped (or stop attempted and assumed successful for restart). Pausing briefly...
2025-05-30 16:48:53,551 - INFO - app.services.process_manager - Proceeding to start agent agent_airsoft_0faa9616 after delay...
2025-05-30 16:48:53,554 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 16:48:53,555 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 82632
2025-05-30 16:48:53,555 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 82632
2025-05-30 16:48:53,556 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 successfully started as part of restart sequence.
2025-05-30 16:48:53,556 - INFO - app.api.routers.agent_api - Restart command issued for agent agent_airsoft_0faa9616 after config update.
2025-05-30 16:48:53,556 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:48:53,557 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:48:54,857 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:48:54,858 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 16:48:54,858 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 16:48:54,858 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 16:48:54,858 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 82632
2025-05-30 16:48:54,858 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 16:48:54,858 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 16:48:54,858 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 16:48:54,903 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 16:48:54,903 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 16:48:54,935 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 16:48:54,935 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 16:48:54,935 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 16:48:54,935 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 16:48:54,935 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 16:48:54,935 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:48:54,962 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 16:48:54,962 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 16:48:54,962 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 16:48:54,963 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 16:48:54,964 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET)
2025-05-30 16:48:54,964 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 16:48:54,964 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 16:48:55,016 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 16:48:55,019 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 16:48:55,667 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 16:48:55,670 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 16:48:55,670 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 16:48:55,670 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 16:48:55,670 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 16:48:55,670 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 16:48:55,670 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 16:48:55,670 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 16:48:55,670 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 16:48:55,671 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 16:48:55,671 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 16:48:55,671 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 16:48:55,671 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 16:48:55,671 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 16:48:55,671 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 16:48:55,671 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 16:48:55,681 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 16:48:55,681 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 16:48:55,681 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 16:48:55,681 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4540543776) setup complete. Starting run loop.
2025-05-30 16:48:55,681 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 16:48:55,681 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 16:48:55,681 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 16:48:55,681 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:48:55,685 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:49:30,980 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ ĞµÑ‰Ğµ Ñ€Ğ°Ğ·, ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñƒ Ğ¼ĞµĞ½Ñ Ğ±Ğ± Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ?...'
2025-05-30 16:49:30,981 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 16:49:30,985 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 16:49:30,985 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:49:30,985 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 16:49:30,986 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 0de2db75-1a8a-4f00-a20c-d172ad6ce480)
2025-05-30 16:49:30,986 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 16:49:30,986 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 16:49:30,987 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 16:49:31,032 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 0de2db75-1a8a-4f00-a20c-d172ad6ce480, db_id: 1003
2025-05-30 16:49:31,067 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:49:31,068 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:49:31,093 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:49:31,097 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:49:31,878 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:49:31,911 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 16:49:31,911 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 16:49:31,911 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 370, 'output_tokens': 16, 'total_tokens': 386, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:49:31,911 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:370 C:16 T:386
2025-05-30 16:49:31,911 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 386 tokens recorded.
2025-05-30 16:49:31,912 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:49:31,912 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748589354598
2025-05-30 16:49:31,912 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748589354598)---
2025-05-30 16:49:31,913 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹'
2025-05-30 16:49:31,913 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:49:31,913 - INFO - app.agent_runner.common.tools_registry - Attempting Cloudflare bypass with cloudscraper for https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:49:31,985 - INFO - aiogram.event - Update id=804756345 is handled. Duration 1005 ms by bot id=1750613938
2025-05-30 16:49:32,387 - ERROR - app.agent_runner.common.tools_registry - Unexpected error in API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹': object of type 'int' has no len()
Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/agent_runner/common/tools_registry.py", line 353, in make_api_request
    effective_logger.debug(f"Successfully parsed JSON response with {len(json_response)} top-level items")
                                                                     ^^^^^^^^^^^^^^^^^^
TypeError: object of type 'int' has no len()
2025-05-30 16:49:32,391 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:49:32,391 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:49:32,414 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:49:32,417 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:49:33,056 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:49:33,567 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğµ, Ğ²Ğ¾Ğ·Ğ½Ğ¸ĞºĞ»Ğ° Ğ½ĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ°Ñ Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞµ ÑƒĞ·Ğ½Ğ°Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ². Ğ”Ğ°Ğ²Ğ°Ğ¹ Ğ¿Ğ¾Ğ¿Ñ€Ğ¾
2025-05-30 16:49:33,568 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 16:49:33,568 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 428, 'output_tokens': 44, 'total_tokens': 472, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:49:33,568 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:428 C:44 T:472
2025-05-30 16:49:33,568 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 472 tokens recorded.
2025-05-30 16:49:33,569 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:49:33,569 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 16:49:33,569 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğµ, Ğ²Ğ¾Ğ·Ğ½Ğ¸ĞºĞ»Ğ° Ğ½ĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ°Ñ Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞµ ÑƒĞ·Ğ½Ğ°Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ². Ğ”Ğ°Ğ²Ğ°Ğ¹ Ğ¿Ğ¾Ğ¿Ñ€Ğ¾...
2025-05-30 16:49:33,571 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 0de2db75-1a8a-4f00-a20c-d172ad6ce480)
2025-05-30 16:49:33,571 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: 0de2db75-1a8a-4f00-a20c-d172ad6ce480.
2025-05-30 16:49:33,573 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğµ, Ğ²Ğ¾Ğ·Ğ½Ğ¸ĞºĞ»Ğ° Ğ½ĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ°Ñ Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞµ ÑƒĞ·Ğ½Ğ°Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ². Ğ”Ğ°Ğ²Ğ°Ğ¹ Ğ¿Ğ¾Ğ¿Ñ€Ğ¾...
2025-05-30 16:49:33,573 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğµ, Ğ²Ğ¾Ğ·Ğ½Ğ¸ĞºĞ»Ğ° Ğ½ĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ°Ñ Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ...'
2025-05-30 16:49:33,574 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '0de2db75-1a8a-4f00-a20c-d172ad6ce480', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 370, 'completion_tokens': 16, 'total_tokens': 386, 'timestamp': '2025-05-30T11:49:31.911333+00:00'}
2025-05-30 16:49:33,574 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 0de2db75-1a8a-4f00-a20c-d172ad6ce480
2025-05-30 16:49:33,578 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 0de2db75-1a8a-4f00-a20c-d172ad6ce480, db_id: 1004
2025-05-30 16:49:33,608 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1004 for interaction_id: 0de2db75-1a8a-4f00-a20c-d172ad6ce480 on attempt 1
2025-05-30 16:49:33,613 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 0de2db75-1a8a-4f00-a20c-d172ad6ce480, db_id: 473
2025-05-30 16:49:33,615 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '0de2db75-1a8a-4f00-a20c-d172ad6ce480', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 428, 'completion_tokens': 44, 'total_tokens': 472, 'timestamp': '2025-05-30T11:49:33.568147+00:00'}
2025-05-30 16:49:33,615 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 0de2db75-1a8a-4f00-a20c-d172ad6ce480
2025-05-30 16:49:33,616 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1004 for interaction_id: 0de2db75-1a8a-4f00-a20c-d172ad6ce480 on attempt 1
2025-05-30 16:49:33,619 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 0de2db75-1a8a-4f00-a20c-d172ad6ce480, db_id: 474
2025-05-30 16:51:30,701 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 16:51:30,701 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 16:51:30,701 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 16:51:30,701 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4361707808) was cancelled.
2025-05-30 16:51:30,701 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4361707808) stopping. Performing cleanup...
2025-05-30 16:51:30,701 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:51:30,706 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 16:51:30,707 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 16:51:30,707 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:51:30,708 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 16:51:30,708 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:51:30,708 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4361707808) cleanup complete.
2025-05-30 16:51:30,708 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 16:51:30,708 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 16:51:30,708 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4368651456) was cancelled.
2025-05-30 16:51:30,708 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4368651456) stopping. Performing cleanup...
2025-05-30 16:51:30,708 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:51:30,711 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 16:51:30,711 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 16:51:30,712 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:51:30,712 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 16:51:30,712 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:51:30,712 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4368651456) cleanup complete.
2025-05-30 16:51:30,712 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 16:51:30,712 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 16:51:30,712 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4369300224) was cancelled.
2025-05-30 16:51:30,712 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4369300224) stopping. Performing cleanup...
2025-05-30 16:51:30,712 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 16:51:30,712 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:51:30,712 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:51:30,712 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 16:51:30,712 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:51:30,715 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 16:51:30,716 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 16:51:30,716 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:51:30,716 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 16:51:30,716 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:51:30,716 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 16:51:30,716 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4369300224) cleanup complete.
2025-05-30 16:51:30,716 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 16:51:30,716 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 16:51:30,716 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 16:51:30,727 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:51:30,728 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 16:51:31,189 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:51:31,189 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:51:31,194 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:51:31,194 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:51:31,194 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:51:31,194 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:51:31,194 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:51:31,194 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:51:31,194 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:51:31,194 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:51:31,194 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:51:31,195 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:51:31,195 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:51:31,197 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:51:31,211 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:51:31,211 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:51:31,211 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:51:31,211 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:51:31,211 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:51:31,211 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:51:31,214 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:51:31,214 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4405601744) setup complete. Starting run loop.
2025-05-30 16:51:31,214 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:51:31,214 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:51:31,214 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:51:31,214 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4405412400) setup complete. Starting run loop.
2025-05-30 16:51:31,214 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:51:31,216 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:51:31,216 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:51:31,245 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:51:31,245 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:51:31,246 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:51:31,246 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:51:31,246 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:51:31,247 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:51:31,247 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:51:31,248 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:51:31,248 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:51:31,248 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:51:34,895 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 16:51:34,896 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4540543776) received shutdown request. Initiating graceful shutdown...
2025-05-30 16:51:34,896 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4540543776)...
2025-05-30 16:51:34,896 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 16:51:34,896 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 16:51:34,896 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4540543776) was cancelled.
2025-05-30 16:51:34,896 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4540543776) stopping. Performing cleanup...
2025-05-30 16:51:34,896 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 16:51:34,896 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 16:51:34,897 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 16:51:34,897 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 16:51:34,897 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-30 16:51:34,897 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 16:51:34,897 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 16:51:34,897 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 16:51:34,897 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:51:34,898 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 16:51:34,898 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 16:51:34,898 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 16:51:34,902 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 16:51:34,903 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 16:51:34,903 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:51:34,903 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 16:51:34,903 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 16:51:34,903 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 16:51:34,903 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4540543776) cleanup complete.
2025-05-30 16:51:34,903 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 16:51:34,903 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 16:51:34,904 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:51:34,904 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 16:51:34,904 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 16:51:34,905 - INFO - __main__ - Agent runner main finished.
2025-05-30 16:51:35,068 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 16:51:35,068 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 16:51:35,068 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 16:51:35,068 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4405601744) was cancelled.
2025-05-30 16:51:35,068 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4405601744) stopping. Performing cleanup...
2025-05-30 16:51:35,068 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:51:35,073 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 16:51:35,074 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 16:51:35,074 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:51:35,074 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 16:51:35,074 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:51:35,074 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4405601744) cleanup complete.
2025-05-30 16:51:35,074 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 16:51:35,074 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 16:51:35,074 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4405412400) was cancelled.
2025-05-30 16:51:35,074 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4405412400) stopping. Performing cleanup...
2025-05-30 16:51:35,074 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:51:35,077 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 16:51:35,078 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 16:51:35,078 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:51:35,078 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 16:51:35,078 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:51:35,078 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4405412400) cleanup complete.
2025-05-30 16:51:35,078 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 16:51:35,078 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 16:51:35,078 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4405412208) was cancelled.
2025-05-30 16:51:35,078 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4405412208) stopping. Performing cleanup...
2025-05-30 16:51:35,078 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 16:51:35,078 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:51:35,078 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:51:35,078 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 16:51:35,078 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:51:35,081 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 16:51:35,082 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 16:51:35,082 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:51:35,082 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 16:51:35,082 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:51:35,082 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 16:51:35,082 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4405412208) cleanup complete.
2025-05-30 16:51:35,082 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 16:51:35,082 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 16:51:35,082 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 16:51:35,085 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:51:35,085 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 16:51:35,148 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 16:51:35,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 16:51:35,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 16:51:35,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4611092032) received shutdown request. Initiating graceful shutdown...
2025-05-30 16:51:35,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4611092032)...
2025-05-30 16:51:35,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 16:51:35,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 16:51:35,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4611092032) was cancelled.
2025-05-30 16:51:35,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4611092032) stopping. Performing cleanup...
2025-05-30 16:51:35,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 16:51:35,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 16:51:35,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 16:51:35,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 16:51:35,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 16:51:35,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 16:51:35,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:51:35,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 16:51:35,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 16:51:35,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 16:51:35,153 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 16:51:35,154 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 16:51:35,154 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:51:35,154 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 16:51:35,154 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 16:51:35,154 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 16:51:35,154 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4611092032) cleanup complete.
2025-05-30 16:51:35,154 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 16:51:35,154 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 16:51:35,159 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:51:35,159 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 16:51:35,159 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 16:51:35,160 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 16:51:37,846 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:51:37,847 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:51:37,851 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:51:37,851 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:51:37,851 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:51:37,851 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:51:37,851 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:51:37,851 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:51:37,851 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:51:37,851 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:51:37,852 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:51:37,852 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:51:37,852 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:51:37,855 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:51:37,855 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:51:37,855 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:51:37,855 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:51:37,855 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:51:37,855 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:51:37,855 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:51:37,869 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:51:37,870 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:51:37,870 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4403781920) setup complete. Starting run loop.
2025-05-30 16:51:37,870 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:51:37,870 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4405229712) setup complete. Starting run loop.
2025-05-30 16:51:37,870 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:51:37,870 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:51:37,871 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:51:37,871 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:51:37,900 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:51:37,900 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:51:37,902 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 16:51:37,903 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 82829
2025-05-30 16:51:37,903 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 82829
2025-05-30 16:51:37,903 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 16:51:37,903 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:51:37,903 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:51:37,905 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 16:51:37,905 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 82830
2025-05-30 16:51:37,905 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 82830
2025-05-30 16:51:37,906 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 16:51:37,906 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:51:37,907 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:51:37,907 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:51:37,907 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:51:38,785 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:51:38,786 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 16:51:38,786 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 16:51:38,786 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 16:51:38,786 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 82830
2025-05-30 16:51:38,786 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 16:51:38,786 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 16:51:38,786 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 16:51:38,791 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 16:51:38,804 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 16:51:38,805 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 16:51:38,805 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 16:51:38,805 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4620937616) setup complete. Starting run loop.
2025-05-30 16:51:38,805 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 16:51:38,805 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 16:51:38,805 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 16:51:38,805 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 16:51:38,805 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:51:38,805 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 16:51:38,805 - INFO - aiogram.dispatcher - Start polling
2025-05-30 16:51:38,808 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:51:39,058 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 16:51:39,144 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:51:39,145 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 16:51:39,145 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 16:51:39,145 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 16:51:39,145 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 82829
2025-05-30 16:51:39,145 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 16:51:39,145 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 16:51:39,145 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 16:51:39,194 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 16:51:39,194 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 16:51:39,242 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 16:51:39,242 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 16:51:39,242 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 16:51:39,242 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 16:51:39,242 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 16:51:39,242 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:51:39,268 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 16:51:39,268 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 16:51:39,268 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 16:51:39,269 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 16:51:39,270 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET)
2025-05-30 16:51:39,270 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 16:51:39,270 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 16:51:39,325 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 16:51:39,329 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 16:51:40,003 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 16:51:40,006 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 16:51:40,006 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 16:51:40,006 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 16:51:40,006 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 16:51:40,006 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 16:51:40,006 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 16:51:40,006 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 16:51:40,006 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 16:51:40,007 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 16:51:40,007 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 16:51:40,007 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 16:51:40,007 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 16:51:40,007 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 16:51:40,007 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 16:51:40,007 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 16:51:40,018 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 16:51:40,018 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 16:51:40,018 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 16:51:40,018 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4657214192) setup complete. Starting run loop.
2025-05-30 16:51:40,018 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 16:51:40,018 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 16:51:40,018 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 16:51:40,018 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:51:40,021 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:51:47,872 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 16:51:47,877 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 16:51:47,877 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4405230096) setup complete. Starting run loop.
2025-05-30 16:51:47,877 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 16:51:54,784 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ¼Ğ¾Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ...'
2025-05-30 16:51:54,785 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache miss for user 144641834, agent agent_airsoft_0faa9616. Checking DB.
2025-05-30 16:51:54,853 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - User 144641834 (DBID: 1) IS authorized for agent agent_airsoft_0faa9616 via DB.
2025-05-30 16:51:54,857 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 16:51:54,857 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:51:54,857 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 16:51:54,858 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 0c91858e-8268-4c65-bf0b-073489c5bbb8)
2025-05-30 16:51:54,858 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 16:51:54,859 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-30 16:51:54,881 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 0c91858e-8268-4c65-bf0b-073489c5bbb8, db_id: 1005
2025-05-30 16:51:54,896 - INFO - AGENT:agent_airsoft_0faa9616 - Loaded 20 messages from DB for thread '144641834'.
2025-05-30 16:51:54,896 - INFO - AGENT:agent_airsoft_0faa9616 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-30 16:51:54,897 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-30 16:51:54,946 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:51:54,947 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:51:54,972 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:51:54,975 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:51:55,858 - INFO - aiogram.event - Update id=804756346 is handled. Duration 1074 ms by bot id=1750613938
2025-05-30 16:51:56,481 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:51:56,487 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 16:51:56,487 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 16:51:56,487 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1006, 'output_tokens': 16, 'total_tokens': 1022, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:51:56,487 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1006 C:16 T:1022
2025-05-30 16:51:56,487 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1022 tokens recorded.
2025-05-30 16:51:56,488 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:51:56,488 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748589354598
2025-05-30 16:51:56,488 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748589354598)---
2025-05-30 16:51:56,490 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹'
2025-05-30 16:51:56,490 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:51:56,490 - INFO - app.agent_runner.common.tools_registry - Attempting Cloudflare bypass with cloudscraper for https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:51:56,995 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:51:56,995 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:51:57,020 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:51:57,023 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:51:57,911 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:51:58,404 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ¢Ğ²Ğ¾Ğ¹ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² â€” 574 Ğ±Ğ±. Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ´ÑĞºĞ°Ğ·Ğ°Ñ‚ÑŒ, ĞºĞ°Ğº Ğ¸Ñ… Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ Ğ¼Ğ°
2025-05-30 16:51:58,404 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 16:51:58,404 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1037, 'output_tokens': 34, 'total_tokens': 1071, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:51:58,404 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1037 C:34 T:1071
2025-05-30 16:51:58,404 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1071 tokens recorded.
2025-05-30 16:51:58,405 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:51:58,405 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 16:51:58,406 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ¢Ğ²Ğ¾Ğ¹ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² â€” 574 Ğ±Ğ±. Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ´ÑĞºĞ°Ğ·Ğ°Ñ‚ÑŒ, ĞºĞ°Ğº Ğ¸Ñ… Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ Ğ¼Ğ°...
2025-05-30 16:51:58,408 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 0c91858e-8268-4c65-bf0b-073489c5bbb8)
2025-05-30 16:51:58,408 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: 0c91858e-8268-4c65-bf0b-073489c5bbb8.
2025-05-30 16:51:58,410 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Ğ¢Ğ²Ğ¾Ğ¹ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² â€” 574 Ğ±Ğ±. Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ´ÑĞºĞ°Ğ·Ğ°Ñ‚ÑŒ, ĞºĞ°Ğº Ğ¸Ñ… Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ Ğ¼Ğ°...
2025-05-30 16:51:58,410 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Ğ¢Ğ²Ğ¾Ğ¹ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² â€” 574 Ğ±Ğ±. Ğ•ÑĞ»Ğ¸...'
2025-05-30 16:51:58,411 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '0c91858e-8268-4c65-bf0b-073489c5bbb8', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1006, 'completion_tokens': 16, 'total_tokens': 1022, 'timestamp': '2025-05-30T11:51:56.487322+00:00'}
2025-05-30 16:51:58,411 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 0c91858e-8268-4c65-bf0b-073489c5bbb8
2025-05-30 16:51:58,416 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 0c91858e-8268-4c65-bf0b-073489c5bbb8, db_id: 1006
2025-05-30 16:51:58,445 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1006 for interaction_id: 0c91858e-8268-4c65-bf0b-073489c5bbb8 on attempt 1
2025-05-30 16:51:58,451 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 0c91858e-8268-4c65-bf0b-073489c5bbb8, db_id: 475
2025-05-30 16:51:58,454 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '0c91858e-8268-4c65-bf0b-073489c5bbb8', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1037, 'completion_tokens': 34, 'total_tokens': 1071, 'timestamp': '2025-05-30T11:51:58.404863+00:00'}
2025-05-30 16:51:58,454 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 0c91858e-8268-4c65-bf0b-073489c5bbb8
2025-05-30 16:51:58,455 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1006 for interaction_id: 0c91858e-8268-4c65-bf0b-073489c5bbb8 on attempt 1
2025-05-30 16:51:58,458 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 0c91858e-8268-4c65-bf0b-073489c5bbb8, db_id: 476
2025-05-30 16:53:12,592 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 16:53:12,593 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 16:53:12,593 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 16:53:12,593 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4403781920) was cancelled.
2025-05-30 16:53:12,593 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4403781920) stopping. Performing cleanup...
2025-05-30 16:53:12,593 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:53:12,598 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 16:53:12,599 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 16:53:12,599 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:53:12,599 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 16:53:12,599 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:53:12,599 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4403781920) cleanup complete.
2025-05-30 16:53:12,599 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 16:53:12,599 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 16:53:12,599 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4405229712) was cancelled.
2025-05-30 16:53:12,599 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4405229712) stopping. Performing cleanup...
2025-05-30 16:53:12,599 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:53:12,603 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 16:53:12,604 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 16:53:12,604 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:53:12,604 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 16:53:12,604 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:53:12,604 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4405229712) cleanup complete.
2025-05-30 16:53:12,604 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 16:53:12,604 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 16:53:12,604 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4405230096) was cancelled.
2025-05-30 16:53:12,604 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4405230096) stopping. Performing cleanup...
2025-05-30 16:53:12,604 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 16:53:12,604 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:53:12,604 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:53:12,604 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 16:53:12,604 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:53:12,606 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 16:53:12,607 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 16:53:12,607 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:53:12,607 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 16:53:12,607 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:53:12,607 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 16:53:12,607 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4405230096) cleanup complete.
2025-05-30 16:53:12,608 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 16:53:12,608 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 16:53:12,608 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 16:53:12,614 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:53:12,614 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 16:53:13,082 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:53:13,082 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:53:13,086 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:53:13,086 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:53:13,086 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:53:13,086 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:53:13,086 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:53:13,087 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:53:13,087 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:53:13,087 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:53:13,087 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:53:13,087 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:53:13,087 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:53:13,089 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:53:13,103 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:53:13,103 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:53:13,105 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:53:13,105 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:53:13,105 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:53:13,105 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:53:13,106 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:53:13,106 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4451631952) setup complete. Starting run loop.
2025-05-30 16:53:13,106 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:53:13,107 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:53:13,108 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:53:13,108 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4451631712) setup complete. Starting run loop.
2025-05-30 16:53:13,108 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:53:13,119 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:53:13,119 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:53:13,136 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:53:13,136 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:53:13,137 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:53:13,137 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:53:13,137 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:53:13,138 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:53:13,139 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:53:13,139 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:53:13,139 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:53:13,139 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:53:14,406 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 16:53:14,406 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 16:53:14,406 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4657214192) received shutdown request. Initiating graceful shutdown...
2025-05-30 16:53:14,406 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4657214192)...
2025-05-30 16:53:14,406 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 16:53:14,406 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 16:53:14,406 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4657214192) was cancelled.
2025-05-30 16:53:14,406 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4657214192) stopping. Performing cleanup...
2025-05-30 16:53:14,406 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 16:53:14,406 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 16:53:14,407 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 16:53:14,407 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-30 16:53:14,407 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 16:53:14,407 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 16:53:14,407 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 16:53:14,407 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:53:14,407 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 16:53:14,408 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 16:53:14,408 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 16:53:14,411 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 16:53:14,412 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 16:53:14,412 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:53:14,412 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 16:53:14,412 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 16:53:14,412 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 16:53:14,412 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4657214192) cleanup complete.
2025-05-30 16:53:14,412 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 16:53:14,412 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 16:53:14,415 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:53:14,415 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 16:53:14,415 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 16:53:14,416 - INFO - __main__ - Agent runner main finished.
2025-05-30 16:53:14,548 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 16:53:14,548 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 16:53:14,548 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 16:53:14,548 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4451631952) was cancelled.
2025-05-30 16:53:14,549 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4451631952) stopping. Performing cleanup...
2025-05-30 16:53:14,549 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:53:14,553 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 16:53:14,554 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 16:53:14,554 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:53:14,554 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 16:53:14,554 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:53:14,554 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4451631952) cleanup complete.
2025-05-30 16:53:14,554 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 16:53:14,554 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 16:53:14,554 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4451631712) was cancelled.
2025-05-30 16:53:14,554 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4451631712) stopping. Performing cleanup...
2025-05-30 16:53:14,554 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:53:14,557 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 16:53:14,558 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 16:53:14,558 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:53:14,558 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 16:53:14,558 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:53:14,558 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4451631712) cleanup complete.
2025-05-30 16:53:14,558 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 16:53:14,558 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 16:53:14,558 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4451631520) was cancelled.
2025-05-30 16:53:14,558 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4451631520) stopping. Performing cleanup...
2025-05-30 16:53:14,558 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 16:53:14,558 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:53:14,558 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:53:14,558 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 16:53:14,558 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:53:14,560 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 16:53:14,561 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 16:53:14,561 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:53:14,561 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 16:53:14,561 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:53:14,561 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 16:53:14,561 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4451631520) cleanup complete.
2025-05-30 16:53:14,561 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 16:53:14,561 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 16:53:14,561 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 16:53:14,564 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:53:14,564 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 16:53:14,658 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 16:53:14,659 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 16:53:14,659 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 16:53:14,659 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4620937616) received shutdown request. Initiating graceful shutdown...
2025-05-30 16:53:14,659 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4620937616)...
2025-05-30 16:53:14,659 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 16:53:14,659 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 16:53:14,659 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4620937616) was cancelled.
2025-05-30 16:53:14,659 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4620937616) stopping. Performing cleanup...
2025-05-30 16:53:14,659 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 16:53:14,659 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 16:53:14,659 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 16:53:14,659 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 16:53:14,659 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 16:53:14,659 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 16:53:14,659 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:53:14,659 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 16:53:14,659 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 16:53:14,659 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 16:53:14,663 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 16:53:14,664 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 16:53:14,664 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:53:14,664 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 16:53:14,664 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 16:53:14,664 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 16:53:14,664 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4620937616) cleanup complete.
2025-05-30 16:53:14,664 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 16:53:14,664 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 16:53:14,668 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:53:14,668 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 16:53:14,668 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 16:53:14,668 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 16:53:16,011 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:53:16,011 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:53:16,015 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:53:16,015 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:53:16,015 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:53:16,016 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:53:16,016 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:53:16,016 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:53:16,016 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:53:16,016 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:53:16,016 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:53:16,016 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:53:16,016 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:53:16,018 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:53:16,018 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:53:16,019 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:53:16,019 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:53:16,019 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:53:16,019 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:53:16,019 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:53:16,035 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:53:16,036 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:53:16,036 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4442315936) setup complete. Starting run loop.
2025-05-30 16:53:16,036 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:53:16,037 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:53:16,037 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4452467872) setup complete. Starting run loop.
2025-05-30 16:53:16,037 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:53:16,038 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:53:16,038 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:53:16,065 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:53:16,066 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:53:16,068 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 16:53:16,068 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 82953
2025-05-30 16:53:16,068 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 82953
2025-05-30 16:53:16,069 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 16:53:16,069 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:53:16,069 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:53:16,070 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 16:53:16,071 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 82954
2025-05-30 16:53:16,071 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 82954
2025-05-30 16:53:16,071 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 16:53:16,072 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:53:16,072 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:53:16,072 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:53:16,072 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:53:16,932 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:53:16,933 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 16:53:16,933 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 16:53:16,933 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 16:53:16,933 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 82954
2025-05-30 16:53:16,933 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 16:53:16,933 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 16:53:16,933 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 16:53:16,938 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 16:53:16,951 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 16:53:16,952 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 16:53:16,952 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 16:53:16,952 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4435716352) setup complete. Starting run loop.
2025-05-30 16:53:16,952 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 16:53:16,952 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 16:53:16,952 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 16:53:16,952 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 16:53:16,952 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:53:16,952 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 16:53:16,952 - INFO - aiogram.dispatcher - Start polling
2025-05-30 16:53:16,954 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 16:53:17,196 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 16:53:17,286 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:53:17,287 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 16:53:17,287 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 16:53:17,287 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 16:53:17,287 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 82953
2025-05-30 16:53:17,287 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 16:53:17,287 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 16:53:17,287 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 16:53:17,333 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 16:53:17,333 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 16:53:17,375 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 16:53:17,375 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 16:53:17,376 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 16:53:17,376 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 16:53:17,376 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 16:53:17,376 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:53:17,401 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 16:53:17,401 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 16:53:17,401 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 16:53:17,402 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 16:53:17,403 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹) (method: GET)
2025-05-30 16:53:17,403 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 16:53:17,403 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 16:53:17,457 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 16:53:17,461 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 16:53:18,131 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 16:53:18,137 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 16:53:18,138 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 16:53:18,138 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 16:53:18,138 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 16:53:18,138 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 16:53:18,138 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 16:53:18,138 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 16:53:18,138 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 16:53:18,139 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 16:53:18,139 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 16:53:18,139 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 16:53:18,139 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 16:53:18,139 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 16:53:18,139 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 16:53:18,139 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 16:53:18,149 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 16:53:18,149 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 16:53:18,149 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 16:53:18,149 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4407767984) setup complete. Starting run loop.
2025-05-30 16:53:18,149 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 16:53:18,149 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 16:53:18,149 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 16:53:18,149 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:53:18,153 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 16:53:26,038 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 16:53:26,043 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 16:53:26,043 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4452467920) setup complete. Starting run loop.
2025-05-30 16:53:26,043 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 16:53:32,027 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñƒ Ğ¼ĞµĞ½Ñ Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ?...'
2025-05-30 16:53:32,029 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 16:53:32,099 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 16:53:32,099 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:53:32,099 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 16:53:32,100 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 8b6b3c2a-1fb2-459d-b1d5-0a923db57db9)
2025-05-30 16:53:32,100 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 16:53:32,100 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-30 16:53:32,121 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 8b6b3c2a-1fb2-459d-b1d5-0a923db57db9, db_id: 1007
2025-05-30 16:53:32,137 - INFO - AGENT:agent_airsoft_0faa9616 - Loaded 20 messages from DB for thread '144641834'.
2025-05-30 16:53:32,137 - INFO - AGENT:agent_airsoft_0faa9616 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-30 16:53:32,137 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-30 16:53:32,206 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:53:32,206 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:53:32,231 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:53:32,235 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:53:33,100 - INFO - aiogram.event - Update id=804756347 is handled. Duration 1073 ms by bot id=1750613938
2025-05-30 16:53:33,252 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:53:33,257 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 16:53:33,257 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_38647f5e19'}
2025-05-30 16:53:33,257 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 989, 'output_tokens': 16, 'total_tokens': 1005, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:53:33,257 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:989 C:16 T:1005
2025-05-30 16:53:33,257 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1005 tokens recorded.
2025-05-30 16:53:33,258 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:53:33,258 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748589354598
2025-05-30 16:53:33,258 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748589354598)---
2025-05-30 16:53:33,260 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ‘Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ğµ Ğ±Ğ°Ğ»Ğ»Ñ‹'
2025-05-30 16:53:33,260 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:53:33,260 - INFO - app.agent_runner.common.tools_registry - Attempting Cloudflare bypass with cloudscraper for https://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 16:53:33,699 - INFO - app.agent_runner.common.tools_registry - API Response Content Preview (first 1000 chars): 574
2025-05-30 16:53:33,702 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:53:33,702 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:53:33,726 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:53:33,729 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:53:34,642 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:53:34,972 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ£ Ñ‚ĞµĞ±Ñ Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ 574 Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°! Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ Ñ Ğ¸Ğ´ĞµÑĞ¼Ğ¸, ĞºĞ°Ğº Ğ¸Ñ… Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°
2025-05-30 16:53:34,972 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_38647f5e19'}
2025-05-30 16:53:34,972 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1020, 'output_tokens': 32, 'total_tokens': 1052, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:53:34,972 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1020 C:32 T:1052
2025-05-30 16:53:34,972 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1052 tokens recorded.
2025-05-30 16:53:34,973 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:53:34,973 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 16:53:34,974 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ£ Ñ‚ĞµĞ±Ñ Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ 574 Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°! Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ Ñ Ğ¸Ğ´ĞµÑĞ¼Ğ¸, ĞºĞ°Ğº Ğ¸Ñ… Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°...
2025-05-30 16:53:34,976 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 8b6b3c2a-1fb2-459d-b1d5-0a923db57db9)
2025-05-30 16:53:34,976 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: 8b6b3c2a-1fb2-459d-b1d5-0a923db57db9.
2025-05-30 16:53:34,978 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Ğ£ Ñ‚ĞµĞ±Ñ Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ 574 Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°! Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ Ñ Ğ¸Ğ´ĞµÑĞ¼Ğ¸, ĞºĞ°Ğº Ğ¸Ñ… Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°...
2025-05-30 16:53:34,979 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Ğ£ Ñ‚ĞµĞ±Ñ Ğ½Ğ° ÑÑ‡ĞµÑ‚Ñƒ 574 Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ°! Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ, Ğ¼...'
2025-05-30 16:53:34,980 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '8b6b3c2a-1fb2-459d-b1d5-0a923db57db9', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 989, 'completion_tokens': 16, 'total_tokens': 1005, 'timestamp': '2025-05-30T11:53:33.257271+00:00'}
2025-05-30 16:53:34,980 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 8b6b3c2a-1fb2-459d-b1d5-0a923db57db9
2025-05-30 16:53:34,983 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 8b6b3c2a-1fb2-459d-b1d5-0a923db57db9, db_id: 1008
2025-05-30 16:53:35,010 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1008 for interaction_id: 8b6b3c2a-1fb2-459d-b1d5-0a923db57db9 on attempt 1
2025-05-30 16:53:35,016 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 8b6b3c2a-1fb2-459d-b1d5-0a923db57db9, db_id: 477
2025-05-30 16:53:35,019 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '8b6b3c2a-1fb2-459d-b1d5-0a923db57db9', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1020, 'completion_tokens': 32, 'total_tokens': 1052, 'timestamp': '2025-05-30T11:53:34.972450+00:00'}
2025-05-30 16:53:35,019 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 8b6b3c2a-1fb2-459d-b1d5-0a923db57db9
2025-05-30 16:53:35,020 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1008 for interaction_id: 8b6b3c2a-1fb2-459d-b1d5-0a923db57db9 on attempt 1
2025-05-30 16:53:35,023 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 8b6b3c2a-1fb2-459d-b1d5-0a923db57db9, db_id: 478
2025-05-30 16:54:27,816 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Gjcvjnhb pfgbcm d ,kjut...'
2025-05-30 16:54:27,818 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 16:54:27,823 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 16:54:27,823 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:54:27,823 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 16:54:27,824 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 2b2aee88-81f7-4426-811a-aecdf7d08d07)
2025-05-30 16:54:27,824 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 16:54:27,825 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 16:54:27,825 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 16:54:27,830 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:54:27,831 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:54:27,833 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 2b2aee88-81f7-4426-811a-aecdf7d08d07, db_id: 1009
2025-05-30 16:54:27,857 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:54:27,860 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:54:28,698 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:54:28,823 - INFO - aiogram.event - Update id=804756348 is handled. Duration 1006 ms by bot id=1750613938
2025-05-30 16:54:29,170 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğµ, Ñ‡Ñ‚Ğ¾ Ğ² Ğ²Ğ°ÑˆĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¸ Ğ¾Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ°. ĞœĞ¾Ğ¶ĞµÑ‚Ğµ, Ğ¿Ğ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ Ğ¸Ğ»Ğ¸ ÑƒÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ñ‚ÑŒ, Ñ‡Ñ‚Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ½Ğ¾ Ğ²Ñ‹ Ñ…Ğ¾
2025-05-30 16:54:29,170 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 16:54:29,170 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1072, 'output_tokens': 41, 'total_tokens': 1113, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:54:29,170 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1072 C:41 T:1113
2025-05-30 16:54:29,170 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1113 tokens recorded.
2025-05-30 16:54:29,171 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:54:29,171 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 16:54:29,172 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğµ, Ñ‡Ñ‚Ğ¾ Ğ² Ğ²Ğ°ÑˆĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¸ Ğ¾Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ°. ĞœĞ¾Ğ¶ĞµÑ‚Ğµ, Ğ¿Ğ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ Ğ¸Ğ»Ğ¸ ÑƒÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ñ‚ÑŒ, Ñ‡Ñ‚Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ½Ğ¾ Ğ²Ñ‹ Ñ…Ğ¾...
2025-05-30 16:54:29,174 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 2b2aee88-81f7-4426-811a-aecdf7d08d07)
2025-05-30 16:54:29,174 - INFO - AGENT:agent_airsoft_0faa9616 - Found 1 token usage events for InteractionID: 2b2aee88-81f7-4426-811a-aecdf7d08d07.
2025-05-30 16:54:29,176 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğµ, Ñ‡Ñ‚Ğ¾ Ğ² Ğ²Ğ°ÑˆĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¸ Ğ¾Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ°. ĞœĞ¾Ğ¶ĞµÑ‚Ğµ, Ğ¿Ğ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ Ğ¸Ğ»Ğ¸ ÑƒÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ñ‚ÑŒ, Ñ‡Ñ‚Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ½Ğ¾ Ğ²Ñ‹ Ñ…Ğ¾...
2025-05-30 16:54:29,176 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğµ, Ñ‡Ñ‚Ğ¾ Ğ² Ğ²Ğ°ÑˆĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¸ Ğ¾Ğ¿ĞµÑ‡Ğ°Ñ‚ĞºĞ°. ĞœĞ¾Ğ¶ĞµÑ‚Ğµ, Ğ¿Ğ¾...'
2025-05-30 16:54:29,178 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '2b2aee88-81f7-4426-811a-aecdf7d08d07', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1072, 'completion_tokens': 41, 'total_tokens': 1113, 'timestamp': '2025-05-30T11:54:29.170526+00:00'}
2025-05-30 16:54:29,178 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 2b2aee88-81f7-4426-811a-aecdf7d08d07
2025-05-30 16:54:29,181 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1010 for interaction_id: 2b2aee88-81f7-4426-811a-aecdf7d08d07 on attempt 1
2025-05-30 16:54:29,181 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 2b2aee88-81f7-4426-811a-aecdf7d08d07, db_id: 1010
2025-05-30 16:54:29,185 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 2b2aee88-81f7-4426-811a-aecdf7d08d07, db_id: 479
2025-05-30 16:54:43,873 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² Ğ±Ğ»Ğ¾Ğ³Ğµ...'
2025-05-30 16:54:43,875 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 16:54:43,879 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 16:54:43,879 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 16:54:43,879 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 16:54:43,881 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 8571b47a-d0fd-4240-af83-108cdbdc68e7)
2025-05-30 16:54:43,881 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 16:54:43,882 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 16:54:43,882 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 16:54:43,885 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:54:43,885 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:54:43,889 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 8571b47a-d0fd-4240-af83-108cdbdc68e7, db_id: 1011
2025-05-30 16:54:43,911 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:54:43,914 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:54:44,880 - INFO - aiogram.event - Update id=804756349 is handled. Duration 1006 ms by bot id=1750613938
2025-05-30 16:54:45,033 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:54:45,035 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 16:54:45,035 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 16:54:45,035 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1127, 'output_tokens': 16, 'total_tokens': 1143, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:54:45,035 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1127 C:16 T:1143
2025-05-30 16:54:45,035 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1143 tokens recorded.
2025-05-30 16:54:45,036 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:54:45,036 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748460000001
2025-05-30 16:54:45,036 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748460000001)---
2025-05-30 16:54:45,038 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'JSONPlaceholder POST'
2025-05-30 16:54:45,038 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://jsonplaceholder.typicode.com/posts
2025-05-30 16:54:45,038 - INFO - app.agent_runner.common.tools_registry - Attempting Cloudflare bypass with cloudscraper for https://jsonplaceholder.typicode.com/posts
2025-05-30 16:54:45,430 - INFO - app.agent_runner.common.tools_registry - API Response Content Preview (first 1000 chars): [
  {
    "userId": 1,
    "id": 1,
    "title": "sunt aut facere repellat provident occaecati excepturi optio reprehenderit",
    "body": "quia et suscipit\nsuscipit recusandae consequuntur expedita et cum\nreprehenderit molestiae ut ut quas totam\nnostrum rerum est autem sunt rem eveniet architecto"
  },
  {
    "userId": 1,
    "id": 2,
    "title": "qui est esse",
    "body": "est rerum tempore vitae\nsequi sint nihil reprehenderit dolor beatae ea dolores neque\nfugiat blanditiis voluptate porro vel nihil molestiae ut reiciendis\nqui aperiam non debitis possimus qui neque nisi nulla"
  },
  {
    "userId": 1,
    "id": 3,
    "title": "ea molestias quasi exercitationem repellat qui ipsa sit aut",
    "body": "et iusto sed quo iure\nvoluptatem occaecati omnis eligendi aut ad\nvoluptatem doloribus vel accusantium quis pariatur\nmolestiae porro eius odio et labore et velit aut"
  },
  {
    "userId": 1,
    "id": 4,
    "title": "eum et est occaecati",
    "body": "ullam et saepe reic
2025-05-30 16:54:45,432 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 16:54:45,432 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 16:54:45,456 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 16:54:45,459 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 16:54:47,229 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 16:54:48,433 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Ğ’Ğ¾Ñ‚ Ğ¾Ğ´Ğ½Ğ° Ğ¸Ğ· Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¸Ğ· Ğ±Ğ»Ğ¾Ğ³Ğ°:

**Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº:** sunt aut facere repellat provident occaecati excepturi
2025-05-30 16:54:48,433 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 16:54:48,433 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 8847, 'output_tokens': 84, 'total_tokens': 8931, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 16:54:48,433 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:8847 C:84 T:8931
2025-05-30 16:54:48,433 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 8931 tokens recorded.
2025-05-30 16:54:48,434 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 16:54:48,434 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 16:54:48,435 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Ğ’Ğ¾Ñ‚ Ğ¾Ğ´Ğ½Ğ° Ğ¸Ğ· Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¸Ğ· Ğ±Ğ»Ğ¾Ğ³Ğ°:

**Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº:** sunt aut facere repellat provident occaecati excepturi...
2025-05-30 16:54:48,437 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 8571b47a-d0fd-4240-af83-108cdbdc68e7)
2025-05-30 16:54:48,438 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: 8571b47a-d0fd-4240-af83-108cdbdc68e7.
2025-05-30 16:54:48,439 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Ğ’Ğ¾Ñ‚ Ğ¾Ğ´Ğ½Ğ° Ğ¸Ğ· Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¸Ğ· Ğ±Ğ»Ğ¾Ğ³Ğ°:

**Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº:** sunt aut facere repellat provident occaecati excepturi...
2025-05-30 16:54:48,439 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Ğ’Ğ¾Ñ‚ Ğ¾Ğ´Ğ½Ğ° Ğ¸Ğ· Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¸Ğ· Ğ±Ğ»Ğ¾Ğ³Ğ°:

**Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº:** sunt...'
2025-05-30 16:54:48,440 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '8571b47a-d0fd-4240-af83-108cdbdc68e7', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1127, 'completion_tokens': 16, 'total_tokens': 1143, 'timestamp': '2025-05-30T11:54:45.035607+00:00'}
2025-05-30 16:54:48,440 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 8571b47a-d0fd-4240-af83-108cdbdc68e7
2025-05-30 16:54:48,443 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1012 for interaction_id: 8571b47a-d0fd-4240-af83-108cdbdc68e7 on attempt 1
2025-05-30 16:54:48,443 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 8571b47a-d0fd-4240-af83-108cdbdc68e7, db_id: 1012
2025-05-30 16:54:48,447 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 8571b47a-d0fd-4240-af83-108cdbdc68e7, db_id: 480
2025-05-30 16:54:48,451 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '8571b47a-d0fd-4240-af83-108cdbdc68e7', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 8847, 'completion_tokens': 84, 'total_tokens': 8931, 'timestamp': '2025-05-30T11:54:48.433225+00:00'}
2025-05-30 16:54:48,451 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 8571b47a-d0fd-4240-af83-108cdbdc68e7
2025-05-30 16:54:48,452 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 1012 for interaction_id: 8571b47a-d0fd-4240-af83-108cdbdc68e7 on attempt 1
2025-05-30 16:54:48,455 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 8571b47a-d0fd-4240-af83-108cdbdc68e7, db_id: 481
2025-05-30 16:55:25,796 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 16:55:25,796 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 16:55:25,796 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 16:55:25,797 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4442315936) was cancelled.
2025-05-30 16:55:25,797 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4442315936) stopping. Performing cleanup...
2025-05-30 16:55:25,797 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:55:25,801 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 16:55:25,802 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 16:55:25,802 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:55:25,802 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 16:55:25,802 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:55:25,802 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4442315936) cleanup complete.
2025-05-30 16:55:25,802 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 16:55:25,802 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 16:55:25,802 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4452467872) was cancelled.
2025-05-30 16:55:25,802 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4452467872) stopping. Performing cleanup...
2025-05-30 16:55:25,802 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:55:25,806 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 16:55:25,807 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 16:55:25,807 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:55:25,807 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 16:55:25,807 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:55:25,807 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4452467872) cleanup complete.
2025-05-30 16:55:25,807 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 16:55:25,807 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 16:55:25,807 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4452467920) was cancelled.
2025-05-30 16:55:25,807 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4452467920) stopping. Performing cleanup...
2025-05-30 16:55:25,807 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 16:55:25,807 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:55:25,807 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:55:25,807 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 16:55:25,807 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 16:55:25,809 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 16:55:25,810 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 16:55:25,810 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:55:25,810 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 16:55:25,810 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 16:55:25,810 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 16:55:25,810 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4452467920) cleanup complete.
2025-05-30 16:55:25,810 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 16:55:25,810 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 16:55:25,810 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 16:55:25,816 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 16:55:25,816 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 16:55:26,277 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 16:55:26,277 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 16:55:26,282 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 16:55:26,282 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 16:55:26,282 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 16:55:26,282 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 16:55:26,282 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 16:55:26,282 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 16:55:26,282 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 16:55:26,282 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 16:55:26,282 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 16:55:26,283 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 16:55:26,283 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 16:55:26,284 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 16:55:26,284 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 16:55:26,285 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 16:55:26,285 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 16:55:26,285 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 16:55:26,285 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 16:55:26,285 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 16:55:26,303 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 16:55:26,304 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 16:55:26,304 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4415027776) setup complete. Starting run loop.
2025-05-30 16:55:26,304 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 16:55:26,304 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4414651856) setup complete. Starting run loop.
2025-05-30 16:55:26,304 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 16:55:26,304 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 16:55:26,306 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 16:55:26,306 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 16:55:26,336 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 16:55:26,336 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 16:55:26,337 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:55:26,337 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 16:55:26,337 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 16:55:26,338 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 16:55:26,339 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 16:55:26,339 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 16:55:26,339 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 16:55:26,339 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 16:55:36,306 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 16:55:36,310 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 16:55:36,310 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4415027584) setup complete. Starting run loop.
2025-05-30 16:55:36,310 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
