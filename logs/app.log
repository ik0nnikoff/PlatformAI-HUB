2025-05-28 16:58:51,275 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 16:58:51,275 - INFO - app.core.lifespan - lifespan - lifespan - 277 - Application startup sequence initiated.
2025-05-28 16:58:51,280 - INFO - app.services.redis_service - redis_service - init_redis_pool - 24 - Redis connection pool initialized successfully.
2025-05-28 16:58:51,280 - INFO - app.core.lifespan - lifespan - start_background_tasks - 172 - Starting background tasks...
2025-05-28 16:58:51,280 - INFO - app.core.lifespan - lifespan - start_background_tasks - 182 - History saver worker started, listening to queue: chat_history_queue
2025-05-28 16:58:51,280 - INFO - TokenUsageWorker - token_usage_worker - __init__ - 45 - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-28 16:58:51,280 - INFO - app.core.lifespan - lifespan - start_background_tasks - 194 - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-28 16:58:51,281 - INFO - app.core.lifespan - lifespan - start_background_tasks - 206 - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-28 16:58:51,281 - INFO - app.core.lifespan - lifespan - start_background_tasks - 210 - 3 background tasks initiated.
2025-05-28 16:58:51,281 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 51 - Attempting to start existing agents and their integrations...
2025-05-28 16:58:51,281 - INFO - HistorySaverWorker - base_worker - setup - 48 - [history_saver_worker] Worker setup started.
2025-05-28 16:58:51,281 - INFO - TokenUsageWorker - base_worker - setup - 48 - [token_usage_worker] Worker setup started.
2025-05-28 16:58:51,281 - INFO - InactivityMonitorWorker - base_worker - setup - 48 - [inactivity_monitor_worker] Worker setup started.
2025-05-28 16:58:51,284 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 61 - ProcessManager setup complete for startup.
2025-05-28 16:58:51,285 - INFO - InactivityMonitorWorker - base_worker - setup - 52 - [inactivity_monitor_worker] Worker setup completed.
2025-05-28 16:58:51,285 - INFO - InactivityMonitorWorker - base_worker - setup - 243 - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-28 16:58:51,286 - INFO - HistorySaverWorker - base_worker - setup - 52 - [history_saver_worker] Worker setup completed.
2025-05-28 16:58:51,286 - INFO - HistorySaverWorker - base_worker - setup - 114 - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-28 16:58:51,286 - INFO - TokenUsageWorker - base_worker - setup - 52 - [token_usage_worker] Worker setup completed.
2025-05-28 16:58:51,286 - INFO - TokenUsageWorker - base_worker - setup - 114 - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-28 16:58:51,287 - INFO - TokenUsageWorker - token_usage_worker - setup - 57 - [token_usage_worker] Database session factory initialized.
2025-05-28 16:58:51,287 - INFO - HistorySaverWorker - history_saver_worker - setup - 49 - [history_saver_worker] Database session factory initialized.
2025-05-28 16:58:51,287 - INFO - HistorySaverWorker - runnable_component - run - 111 - Component HistorySaverWorker (instance: 4375362592) setup complete. Starting run loop.
2025-05-28 16:58:51,287 - INFO - HistorySaverWorker - base_worker - run_loop - 131 - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-28 16:58:51,287 - INFO - TokenUsageWorker - token_usage_worker - setup - 64 - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-28 16:58:51,287 - INFO - TokenUsageWorker - runnable_component - run - 111 - Component TokenUsageWorker (instance: 4375362160) setup complete. Starting run loop.
2025-05-28 16:58:51,287 - INFO - TokenUsageWorker - base_worker - run_loop - 131 - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-28 16:58:51,288 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 86 - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-28 16:58:51,288 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 94 - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-28 16:58:51,334 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 66 - Found 1 agents to potentially start.
2025-05-28 16:58:51,334 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 69 - Attempting to start agent: agent_airsoft_0faa9616
2025-05-28 16:58:51,335 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 73 - Agent agent_airsoft_0faa9616 is already running.
2025-05-28 16:58:51,335 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 93 - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-28 16:58:51,335 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 109 - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-28 16:58:51,336 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 115 - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-28 16:58:51,337 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 16:58:51,337 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 16:58:51,337 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 153 - ProcessManager cleanup complete for startup function.
2025-05-28 16:58:51,337 - INFO - app.core.lifespan - lifespan - lifespan - 284 - Application startup sequence completed.
2025-05-28 16:59:01,288 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 96 - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-28 16:59:01,294 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 98 - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-28 16:59:01,294 - INFO - InactivityMonitorWorker - runnable_component - run - 111 - Component InactivityMonitorWorker (instance: 4375362304) setup complete. Starting run loop.
2025-05-28 16:59:01,294 - INFO - InactivityMonitorWorker - base_worker - run_loop - 258 - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-28 16:59:14,388 - INFO - app.core.lifespan - lifespan - lifespan - 287 - Application shutdown sequence initiated.
2025-05-28 16:59:14,389 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 230 - Stopping 3 background tasks...
2025-05-28 16:59:14,389 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task HistorySaverWorker...
2025-05-28 16:59:14,389 - INFO - HistorySaverWorker - runnable_component - run - 116 - Run_loop for HistorySaverWorker (instance: 4375362592) was cancelled.
2025-05-28 16:59:14,389 - INFO - HistorySaverWorker - runnable_component - run - 123 - Component HistorySaverWorker (instance: 4375362592) stopping. Performing cleanup...
2025-05-28 16:59:14,389 - INFO - HistorySaverWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 16:59:14,393 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for history_saver_worker as part of cleanup.
2025-05-28 16:59:14,394 - INFO - HistorySaverWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-28 16:59:14,394 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 16:59:14,394 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-28 16:59:14,394 - INFO - HistorySaverWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 16:59:14,394 - INFO - HistorySaverWorker - runnable_component - run - 128 - Component HistorySaverWorker (instance: 4375362592) cleanup complete.
2025-05-28 16:59:14,394 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task HistorySaverWorker finished after cancellation signal.
2025-05-28 16:59:14,394 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task TokenUsageWorker...
2025-05-28 16:59:14,395 - INFO - TokenUsageWorker - runnable_component - run - 116 - Run_loop for TokenUsageWorker (instance: 4375362160) was cancelled.
2025-05-28 16:59:14,395 - INFO - TokenUsageWorker - runnable_component - run - 123 - Component TokenUsageWorker (instance: 4375362160) stopping. Performing cleanup...
2025-05-28 16:59:14,395 - INFO - TokenUsageWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 16:59:14,397 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for token_usage_worker as part of cleanup.
2025-05-28 16:59:14,398 - INFO - TokenUsageWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-28 16:59:14,398 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 16:59:14,398 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-28 16:59:14,398 - INFO - TokenUsageWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 16:59:14,398 - INFO - TokenUsageWorker - runnable_component - run - 128 - Component TokenUsageWorker (instance: 4375362160) cleanup complete.
2025-05-28 16:59:14,398 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task TokenUsageWorker finished after cancellation signal.
2025-05-28 16:59:14,398 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task InactivityMonitorWorker...
2025-05-28 16:59:14,398 - INFO - InactivityMonitorWorker - runnable_component - run - 116 - Run_loop for InactivityMonitorWorker (instance: 4375362304) was cancelled.
2025-05-28 16:59:14,398 - INFO - InactivityMonitorWorker - runnable_component - run - 123 - Component InactivityMonitorWorker (instance: 4375362304) stopping. Performing cleanup...
2025-05-28 16:59:14,398 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 437 - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-28 16:59:14,398 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 16:59:14,398 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 16:59:14,398 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 441 - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-28 16:59:14,398 - INFO - InactivityMonitorWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 16:59:14,401 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-28 16:59:14,402 - INFO - InactivityMonitorWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-28 16:59:14,402 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 16:59:14,402 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-28 16:59:14,402 - INFO - InactivityMonitorWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 16:59:14,402 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 445 - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-28 16:59:14,402 - INFO - InactivityMonitorWorker - runnable_component - run - 128 - Component InactivityMonitorWorker (instance: 4375362304) cleanup complete.
2025-05-28 16:59:14,402 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-28 16:59:14,402 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 249 - All background tasks signaled to stop.
2025-05-28 16:59:14,402 - INFO - app.services.redis_service - redis_service - close_redis_pool - 43 - Redis connection pool closed successfully.
2025-05-28 16:59:14,405 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 16:59:14,405 - INFO - app.core.lifespan - lifespan - lifespan - 293 - Application shutdown sequence completed.
2025-05-28 16:59:14,814 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 16:59:14,814 - INFO - app.core.lifespan - lifespan - lifespan - 277 - Application startup sequence initiated.
2025-05-28 16:59:14,819 - INFO - app.services.redis_service - redis_service - init_redis_pool - 24 - Redis connection pool initialized successfully.
2025-05-28 16:59:14,819 - INFO - app.core.lifespan - lifespan - start_background_tasks - 172 - Starting background tasks...
2025-05-28 16:59:14,819 - INFO - app.core.lifespan - lifespan - start_background_tasks - 182 - History saver worker started, listening to queue: chat_history_queue
2025-05-28 16:59:14,819 - INFO - TokenUsageWorker - token_usage_worker - __init__ - 45 - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-28 16:59:14,819 - INFO - app.core.lifespan - lifespan - start_background_tasks - 194 - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-28 16:59:14,819 - INFO - app.core.lifespan - lifespan - start_background_tasks - 206 - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-28 16:59:14,819 - INFO - app.core.lifespan - lifespan - start_background_tasks - 210 - 3 background tasks initiated.
2025-05-28 16:59:14,819 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 51 - Attempting to start existing agents and their integrations...
2025-05-28 16:59:14,819 - INFO - HistorySaverWorker - base_worker - setup - 48 - [history_saver_worker] Worker setup started.
2025-05-28 16:59:14,820 - INFO - TokenUsageWorker - base_worker - setup - 48 - [token_usage_worker] Worker setup started.
2025-05-28 16:59:14,820 - INFO - InactivityMonitorWorker - base_worker - setup - 48 - [inactivity_monitor_worker] Worker setup started.
2025-05-28 16:59:14,821 - INFO - TokenUsageWorker - base_worker - setup - 52 - [token_usage_worker] Worker setup completed.
2025-05-28 16:59:14,821 - INFO - TokenUsageWorker - base_worker - setup - 114 - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-28 16:59:14,821 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 61 - ProcessManager setup complete for startup.
2025-05-28 16:59:14,823 - INFO - InactivityMonitorWorker - base_worker - setup - 52 - [inactivity_monitor_worker] Worker setup completed.
2025-05-28 16:59:14,823 - INFO - InactivityMonitorWorker - base_worker - setup - 243 - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-28 16:59:14,823 - INFO - HistorySaverWorker - base_worker - setup - 52 - [history_saver_worker] Worker setup completed.
2025-05-28 16:59:14,823 - INFO - HistorySaverWorker - base_worker - setup - 114 - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-28 16:59:14,824 - INFO - TokenUsageWorker - token_usage_worker - setup - 57 - [token_usage_worker] Database session factory initialized.
2025-05-28 16:59:14,824 - INFO - HistorySaverWorker - history_saver_worker - setup - 49 - [history_saver_worker] Database session factory initialized.
2025-05-28 16:59:14,824 - INFO - HistorySaverWorker - runnable_component - run - 111 - Component HistorySaverWorker (instance: 4381794640) setup complete. Starting run loop.
2025-05-28 16:59:14,824 - INFO - HistorySaverWorker - base_worker - run_loop - 131 - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-28 16:59:14,825 - INFO - TokenUsageWorker - token_usage_worker - setup - 64 - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-28 16:59:14,825 - INFO - TokenUsageWorker - runnable_component - run - 111 - Component TokenUsageWorker (instance: 4382303168) setup complete. Starting run loop.
2025-05-28 16:59:14,825 - INFO - TokenUsageWorker - base_worker - run_loop - 131 - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-28 16:59:14,826 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 86 - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-28 16:59:14,826 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 94 - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-28 16:59:14,869 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 66 - Found 1 agents to potentially start.
2025-05-28 16:59:14,869 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 69 - Attempting to start agent: agent_airsoft_0faa9616
2025-05-28 16:59:14,870 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 73 - Agent agent_airsoft_0faa9616 is already running.
2025-05-28 16:59:14,870 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 93 - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-28 16:59:14,870 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 109 - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-28 16:59:14,871 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 115 - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-28 16:59:14,871 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 16:59:14,872 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 16:59:14,872 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 153 - ProcessManager cleanup complete for startup function.
2025-05-28 16:59:14,872 - INFO - app.core.lifespan - lifespan - lifespan - 284 - Application startup sequence completed.
2025-05-28 16:59:24,826 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 96 - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-28 16:59:24,832 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 98 - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-28 16:59:24,832 - INFO - InactivityMonitorWorker - runnable_component - run - 111 - Component InactivityMonitorWorker (instance: 4382603792) setup complete. Starting run loop.
2025-05-28 16:59:24,832 - INFO - InactivityMonitorWorker - base_worker - run_loop - 258 - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-28 16:59:32,296 - INFO - app.core.lifespan - lifespan - lifespan - 287 - Application shutdown sequence initiated.
2025-05-28 16:59:32,297 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 230 - Stopping 3 background tasks...
2025-05-28 16:59:32,297 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task HistorySaverWorker...
2025-05-28 16:59:32,297 - INFO - HistorySaverWorker - runnable_component - run - 116 - Run_loop for HistorySaverWorker (instance: 4381794640) was cancelled.
2025-05-28 16:59:32,297 - INFO - HistorySaverWorker - runnable_component - run - 123 - Component HistorySaverWorker (instance: 4381794640) stopping. Performing cleanup...
2025-05-28 16:59:32,297 - INFO - HistorySaverWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 16:59:32,307 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for history_saver_worker as part of cleanup.
2025-05-28 16:59:32,308 - INFO - HistorySaverWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-28 16:59:32,308 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 16:59:32,308 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-28 16:59:32,308 - INFO - HistorySaverWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 16:59:32,308 - INFO - HistorySaverWorker - runnable_component - run - 128 - Component HistorySaverWorker (instance: 4381794640) cleanup complete.
2025-05-28 16:59:32,308 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task HistorySaverWorker finished after cancellation signal.
2025-05-28 16:59:32,308 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task TokenUsageWorker...
2025-05-28 16:59:32,308 - INFO - TokenUsageWorker - runnable_component - run - 116 - Run_loop for TokenUsageWorker (instance: 4382303168) was cancelled.
2025-05-28 16:59:32,308 - INFO - TokenUsageWorker - runnable_component - run - 123 - Component TokenUsageWorker (instance: 4382303168) stopping. Performing cleanup...
2025-05-28 16:59:32,309 - INFO - TokenUsageWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 16:59:32,312 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for token_usage_worker as part of cleanup.
2025-05-28 16:59:32,314 - INFO - TokenUsageWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-28 16:59:32,314 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 16:59:32,314 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-28 16:59:32,314 - INFO - TokenUsageWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 16:59:32,314 - INFO - TokenUsageWorker - runnable_component - run - 128 - Component TokenUsageWorker (instance: 4382303168) cleanup complete.
2025-05-28 16:59:32,314 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task TokenUsageWorker finished after cancellation signal.
2025-05-28 16:59:32,314 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task InactivityMonitorWorker...
2025-05-28 16:59:32,314 - INFO - InactivityMonitorWorker - runnable_component - run - 116 - Run_loop for InactivityMonitorWorker (instance: 4382603792) was cancelled.
2025-05-28 16:59:32,314 - INFO - InactivityMonitorWorker - runnable_component - run - 123 - Component InactivityMonitorWorker (instance: 4382603792) stopping. Performing cleanup...
2025-05-28 16:59:32,315 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 437 - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-28 16:59:32,315 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 16:59:32,315 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 16:59:32,315 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 441 - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-28 16:59:32,315 - INFO - InactivityMonitorWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 16:59:32,319 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-28 16:59:32,321 - INFO - InactivityMonitorWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-28 16:59:32,322 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 16:59:32,322 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-28 16:59:32,322 - INFO - InactivityMonitorWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 16:59:32,322 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 445 - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-28 16:59:32,322 - INFO - InactivityMonitorWorker - runnable_component - run - 128 - Component InactivityMonitorWorker (instance: 4382603792) cleanup complete.
2025-05-28 16:59:32,322 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-28 16:59:32,322 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 249 - All background tasks signaled to stop.
2025-05-28 16:59:32,323 - INFO - app.services.redis_service - redis_service - close_redis_pool - 43 - Redis connection pool closed successfully.
2025-05-28 16:59:32,337 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 16:59:32,337 - INFO - app.core.lifespan - lifespan - lifespan - 293 - Application shutdown sequence completed.
2025-05-28 16:59:59,416 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 16:59:59,416 - INFO - app.core.lifespan - lifespan - lifespan - 277 - Application startup sequence initiated.
2025-05-28 16:59:59,421 - INFO - app.services.redis_service - redis_service - init_redis_pool - 24 - Redis connection pool initialized successfully.
2025-05-28 16:59:59,421 - INFO - app.core.lifespan - lifespan - start_background_tasks - 172 - Starting background tasks...
2025-05-28 16:59:59,421 - INFO - app.core.lifespan - lifespan - start_background_tasks - 182 - History saver worker started, listening to queue: chat_history_queue
2025-05-28 16:59:59,421 - INFO - TokenUsageWorker - token_usage_worker - __init__ - 45 - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-28 16:59:59,422 - INFO - app.core.lifespan - lifespan - start_background_tasks - 194 - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-28 16:59:59,422 - INFO - app.core.lifespan - lifespan - start_background_tasks - 206 - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-28 16:59:59,422 - INFO - app.core.lifespan - lifespan - start_background_tasks - 210 - 3 background tasks initiated.
2025-05-28 16:59:59,422 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 51 - Attempting to start existing agents and their integrations...
2025-05-28 16:59:59,422 - INFO - HistorySaverWorker - base_worker - setup - 48 - [history_saver_worker] Worker setup started.
2025-05-28 16:59:59,422 - INFO - TokenUsageWorker - base_worker - setup - 48 - [token_usage_worker] Worker setup started.
2025-05-28 16:59:59,422 - INFO - InactivityMonitorWorker - base_worker - setup - 48 - [inactivity_monitor_worker] Worker setup started.
2025-05-28 16:59:59,424 - INFO - InactivityMonitorWorker - base_worker - setup - 52 - [inactivity_monitor_worker] Worker setup completed.
2025-05-28 16:59:59,424 - INFO - InactivityMonitorWorker - base_worker - setup - 243 - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-28 16:59:59,424 - INFO - HistorySaverWorker - base_worker - setup - 52 - [history_saver_worker] Worker setup completed.
2025-05-28 16:59:59,424 - INFO - HistorySaverWorker - base_worker - setup - 114 - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-28 16:59:59,425 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 61 - ProcessManager setup complete for startup.
2025-05-28 16:59:59,426 - INFO - TokenUsageWorker - base_worker - setup - 52 - [token_usage_worker] Worker setup completed.
2025-05-28 16:59:59,426 - INFO - TokenUsageWorker - base_worker - setup - 114 - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-28 16:59:59,428 - INFO - HistorySaverWorker - history_saver_worker - setup - 49 - [history_saver_worker] Database session factory initialized.
2025-05-28 16:59:59,428 - INFO - HistorySaverWorker - runnable_component - run - 111 - Component HistorySaverWorker (instance: 4639351408) setup complete. Starting run loop.
2025-05-28 16:59:59,428 - INFO - HistorySaverWorker - base_worker - run_loop - 131 - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-28 16:59:59,428 - INFO - TokenUsageWorker - token_usage_worker - setup - 57 - [token_usage_worker] Database session factory initialized.
2025-05-28 16:59:59,429 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 86 - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-28 16:59:59,429 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 94 - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-28 16:59:59,429 - INFO - TokenUsageWorker - token_usage_worker - setup - 64 - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-28 16:59:59,429 - INFO - TokenUsageWorker - runnable_component - run - 111 - Component TokenUsageWorker (instance: 4639226480) setup complete. Starting run loop.
2025-05-28 16:59:59,429 - INFO - TokenUsageWorker - base_worker - run_loop - 131 - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-28 16:59:59,476 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 66 - Found 1 agents to potentially start.
2025-05-28 16:59:59,476 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 69 - Attempting to start agent: agent_airsoft_0faa9616
2025-05-28 16:59:59,479 - INFO - app.services.process_manager - process_manager - start_agent_process - 880 - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-28 16:59:59,480 - INFO - app.core.base.process_launcher - process_launcher - launch_process - 160 - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 89654
2025-05-28 16:59:59,480 - INFO - app.services.process_manager - process_manager - start_agent_process - 913 - Agent process agent_airsoft_0faa9616 initiated start with PID 89654
2025-05-28 16:59:59,480 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 79 - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-28 16:59:59,480 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 93 - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-28 16:59:59,480 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 109 - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-28 16:59:59,482 - INFO - app.services.process_manager - process_manager - start_integration_process - 554 - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-28 16:59:59,483 - INFO - app.core.base.process_launcher - process_launcher - launch_process - 160 - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 89655
2025-05-28 16:59:59,483 - INFO - app.services.process_manager - process_manager - start_integration_process - 600 - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 89655
2025-05-28 16:59:59,483 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 123 - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-28 16:59:59,484 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 16:59:59,484 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 16:59:59,484 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 153 - ProcessManager cleanup complete for startup function.
2025-05-28 16:59:59,484 - INFO - app.core.lifespan - lifespan - lifespan - 284 - Application startup sequence completed.
2025-05-28 17:00:00,418 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 17:00:00,419 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot_main - main_async_runner - 50 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-28 17:00:00,419 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot_main - main_async_runner - 57 - Database session factory configured for Telegram bot.
2025-05-28 17:00:00,419 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - __init__ - 44 - ServiceComponentBase initialized.
2025-05-28 17:00:00,419 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - __init__ - 56 - TelegramIntegrationBot initialized. PID: 89655
2025-05-28 17:00:00,419 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot_main - main_async_runner - 74 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-28 17:00:00,419 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - setup - 441 - TelegramIntegrationBot setup started.
2025-05-28 17:00:00,419 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - setup - 84 - ServiceComponent setup started.
2025-05-28 17:00:00,425 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - setup - 95 - ServiceComponent setup completed.
2025-05-28 17:00:00,438 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - setup - 452 - Aiogram Bot and Dispatcher initialized.
2025-05-28 17:00:00,439 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _register_handlers - 341 - Aiogram handlers registered.
2025-05-28 17:00:00,439 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - setup - 456 - TelegramIntegrationBot setup complete.
2025-05-28 17:00:00,439 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - runnable_component - run - 111 - Component TelegramIntegrationBot (instance: 4873739712) setup complete. Starting run loop.
2025-05-28 17:00:00,439 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - run_loop - 464 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-28 17:00:00,439 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - _register_main_task - 62 - Registered main task: RedisOutputListener
2025-05-28 17:00:00,439 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - _register_main_task - 62 - Registered main task: AiogramPolling
2025-05-28 17:00:00,439 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - run_loop - 122 - Starting run_loop with 2 registered main tasks.
2025-05-28 17:00:00,439 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 236 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-28 17:00:00,439 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - polling_wrapper - 473 - Starting aiogram polling...
2025-05-28 17:00:00,439 - INFO - aiogram.dispatcher - dispatcher - start_polling - 527 - Start polling
2025-05-28 17:00:00,442 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 254 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-28 17:00:00,688 - INFO - aiogram.dispatcher - dispatcher - _polling - 341 - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-28 17:00:00,891 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 17:00:00,892 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 21 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-28 17:00:00,892 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 28 - Database session factory configured for Agent.
2025-05-28 17:00:00,892 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - __init__ - 44 - ServiceComponentBase initialized.
2025-05-28 17:00:00,892 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - __init__ - 120 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 89654
2025-05-28 17:00:00,892 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 42 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-28 17:00:00,892 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - setup - 494 - AgentRunner setup started.
2025-05-28 17:00:00,892 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - setup - 84 - ServiceComponent setup started.
2025-05-28 17:00:00,898 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - setup - 95 - ServiceComponent setup completed.
2025-05-28 17:00:00,898 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - fetch_config - 27 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-28 17:00:00,980 - INFO - httpx - _client - _send_single_request - 1740 - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-28 17:00:00,980 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - fetch_config - 33 - Configuration fetched successfully.
2025-05-28 17:00:00,980 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _load_config - 138 - Agent configuration loaded and prepared successfully.
2025-05-28 17:00:00,980 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _setup_app - 149 - Creating LangGraph application...
2025-05-28 17:00:00,980 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_agent_app - 908 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-28 17:00:00,980 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_llm_instance - 80 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-28 17:00:01,006 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _configure_main_llm - 63 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-28 17:00:01,006 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 813 - Creating agent graph in GraphFactory...
2025-05-28 17:00:01,006 - INFO - app.agent_runner.common.tools_registry - tools_registry - configure_tools_centralized - 364 - Configured 3 predefined tools from centralized registry
2025-05-28 17:00:01,006 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 94 - Added 3 tools from centralized registry
2025-05-28 17:00:01,006 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 114 - Configuring 1 Knowledge Base tool(s)...
2025-05-28 17:00:01,061 - INFO - httpx - _client - _send_single_request - 1025 - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-28 17:00:01,068 - INFO - httpx - _client - _send_single_request - 1025 - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-28 17:00:02,267 - INFO - httpx - _client - _send_single_request - 1025 - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-28 17:00:02,332 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 132 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-28 17:00:02,333 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 166 - Must conditions for KB tool 'knowledgeBase-1745316404538': [FieldCondition(key='metadata.client_id', match=MatchValue(value='2'), range=None, geo_bounding_box=None, geo_radius=None, geo_polygon=None, values_count=None), FieldCondition(key='metadata.datasource_id', match=MatchAny(any=['5', '6', '7']), range=None, geo_bounding_box=None, geo_radius=None, geo_polygon=None, values_count=None)]
2025-05-28 17:00:02,333 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 182 - Configured Knowledge Base tool 'База знаний' (ID: knowledgeBase-1745316404538) for datasources: ['5', '6', '7']
2025-05-28 17:00:02,333 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 190 - Using max_rewrites: 4
2025-05-28 17:00:02,333 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 217 - Configured Web Search tool 'Поиск в Интернете' (ID: webSearch-1746879979658)
2025-05-28 17:00:02,334 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 244 - Total tools configured: 5 (4 safe, 1 datastore).
2025-05-28 17:00:02,334 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _configure_tools - 153 - Tools configured: 5 total, 4 safe, 1 datastore tools. Max rewrites: 4.
2025-05-28 17:00:02,334 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 821 - Context memory enabled: True
2025-05-28 17:00:02,335 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 829 - Added node: agent
2025-05-28 17:00:02,337 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 838 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-28 17:00:02,338 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 848 - Added node: safe_tools
2025-05-28 17:00:02,338 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 859 - Added edge: safe_tools -> agent
2025-05-28 17:00:02,338 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 865 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-28 17:00:02,339 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 872 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-28 17:00:02,339 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 888 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-28 17:00:02,368 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 900 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-28 17:00:02,368 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_agent_app - 917 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-28 17:00:02,368 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _setup_app - 157 - LangGraph application created successfully.
2025-05-28 17:00:02,368 - INFO - AGENT:agent_airsoft_0faa9616 - runnable_component - run - 111 - Component AgentRunner (instance: 4827235824) setup complete. Starting run loop.
2025-05-28 17:00:02,368 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - run_loop - 522 - AgentRunner run_loop starting...
2025-05-28 17:00:02,368 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - _register_main_task - 62 - Registered main task: AgentPubSubListener
2025-05-28 17:00:02,368 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - run_loop - 122 - Starting run_loop with 1 registered main tasks.
2025-05-28 17:00:02,368 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 236 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-28 17:00:02,371 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 254 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-28 17:00:09,431 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 96 - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-28 17:00:09,436 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 98 - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-28 17:00:09,436 - INFO - InactivityMonitorWorker - runnable_component - run - 111 - Component InactivityMonitorWorker (instance: 4639755488) setup complete. Starting run loop.
2025-05-28 17:00:09,436 - INFO - InactivityMonitorWorker - base_worker - run_loop - 258 - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-28 17:00:41,889 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - run_loop - 160 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-28 17:00:41,889 - INFO - AGENT:agent_airsoft_0faa9616 - runnable_component - initiate_shutdown - 74 - Component AgentRunner (instance: 4827235824) received shutdown request. Initiating graceful shutdown...
2025-05-28 17:00:41,889 - WARNING - aiogram.dispatcher - dispatcher - _signal_stop_polling - 455 - Received SIGINT signal
2025-05-28 17:00:41,889 - INFO - AGENT:agent_airsoft_0faa9616 - runnable_component - initiate_shutdown - 79 - Cancelling main task (_run_loop) for AgentRunner (instance: 4827235824)...
2025-05-28 17:00:41,889 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - run_loop - 172 - ServiceComponentBase run_loop finished.
2025-05-28 17:00:41,889 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - run_loop - 536 - AgentRunner run_loop finished.
2025-05-28 17:00:41,889 - INFO - AGENT:agent_airsoft_0faa9616 - runnable_component - run - 116 - Run_loop for AgentRunner (instance: 4827235824) was cancelled.
2025-05-28 17:00:41,889 - INFO - AGENT:agent_airsoft_0faa9616 - runnable_component - run - 123 - Component AgentRunner (instance: 4827235824) stopping. Performing cleanup...
2025-05-28 17:00:41,889 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - cleanup - 546 - AgentRunner cleanup started.
2025-05-28 17:00:41,889 - INFO - aiogram.dispatcher - dispatcher - _polling - 359 - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-28 17:00:41,889 - INFO - aiogram.dispatcher - dispatcher - start_polling - 554 - Polling stopped
2025-05-28 17:00:41,890 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - cleanup - 552 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 0) on start/restart.
2025-05-28 17:00:41,890 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - cleanup - 181 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-28 17:00:41,890 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - cleanup - 191 - Waiting for 1 tasks to process cancellation...
2025-05-28 17:00:41,890 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 270 - Pub/Sub listener task cancelled.
2025-05-28 17:00:41,890 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 294 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-28 17:00:41,890 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 298 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-28 17:00:41,890 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - cleanup - 202 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-28 17:00:41,890 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - cleanup - 207 - All main tasks processed and list cleared.
2025-05-28 17:00:41,896 - INFO - AGENT:agent_airsoft_0faa9616 - status_updater - cleanup_status_updater - 316 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-28 17:00:41,897 - INFO - AGENT:agent_airsoft_0faa9616 - status_updater - delete_status_key_from_redis - 196 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-28 17:00:41,897 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:00:41,897 - INFO - AGENT:agent_airsoft_0faa9616 - status_updater - cleanup_status_updater - 320 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-28 17:00:41,897 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - cleanup - 211 - ServiceComponent cleanup completed.
2025-05-28 17:00:41,897 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - cleanup - 581 - AgentRunner cleanup finished.
2025-05-28 17:00:41,897 - INFO - AGENT:agent_airsoft_0faa9616 - runnable_component - run - 128 - Component AgentRunner (instance: 4827235824) cleanup complete.
2025-05-28 17:00:41,897 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 51 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-28 17:00:41,897 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 60 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-28 17:00:41,898 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 17:00:41,898 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 63 - Database engine closed.
2025-05-28 17:00:41,898 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 66 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-28 17:00:41,898 - INFO - __main__ - runner_main - <module> - 86 - Agent runner main finished.
2025-05-28 17:00:42,060 - INFO - app.core.lifespan - lifespan - lifespan - 287 - Application shutdown sequence initiated.
2025-05-28 17:00:42,060 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 230 - Stopping 3 background tasks...
2025-05-28 17:00:42,060 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task HistorySaverWorker...
2025-05-28 17:00:42,060 - INFO - HistorySaverWorker - runnable_component - run - 116 - Run_loop for HistorySaverWorker (instance: 4639351408) was cancelled.
2025-05-28 17:00:42,060 - INFO - HistorySaverWorker - runnable_component - run - 123 - Component HistorySaverWorker (instance: 4639351408) stopping. Performing cleanup...
2025-05-28 17:00:42,060 - INFO - HistorySaverWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:00:42,065 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for history_saver_worker as part of cleanup.
2025-05-28 17:00:42,066 - INFO - HistorySaverWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-28 17:00:42,066 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:00:42,066 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-28 17:00:42,066 - INFO - HistorySaverWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:00:42,066 - INFO - HistorySaverWorker - runnable_component - run - 128 - Component HistorySaverWorker (instance: 4639351408) cleanup complete.
2025-05-28 17:00:42,066 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task HistorySaverWorker finished after cancellation signal.
2025-05-28 17:00:42,066 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task TokenUsageWorker...
2025-05-28 17:00:42,066 - INFO - TokenUsageWorker - runnable_component - run - 116 - Run_loop for TokenUsageWorker (instance: 4639226480) was cancelled.
2025-05-28 17:00:42,066 - INFO - TokenUsageWorker - runnable_component - run - 123 - Component TokenUsageWorker (instance: 4639226480) stopping. Performing cleanup...
2025-05-28 17:00:42,067 - INFO - TokenUsageWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:00:42,069 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for token_usage_worker as part of cleanup.
2025-05-28 17:00:42,070 - INFO - TokenUsageWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-28 17:00:42,070 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:00:42,071 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-28 17:00:42,071 - INFO - TokenUsageWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:00:42,071 - INFO - TokenUsageWorker - runnable_component - run - 128 - Component TokenUsageWorker (instance: 4639226480) cleanup complete.
2025-05-28 17:00:42,071 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task TokenUsageWorker finished after cancellation signal.
2025-05-28 17:00:42,071 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task InactivityMonitorWorker...
2025-05-28 17:00:42,071 - INFO - InactivityMonitorWorker - runnable_component - run - 116 - Run_loop for InactivityMonitorWorker (instance: 4639755488) was cancelled.
2025-05-28 17:00:42,071 - INFO - InactivityMonitorWorker - runnable_component - run - 123 - Component InactivityMonitorWorker (instance: 4639755488) stopping. Performing cleanup...
2025-05-28 17:00:42,071 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 437 - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-28 17:00:42,071 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:00:42,071 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:00:42,071 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 441 - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-28 17:00:42,071 - INFO - InactivityMonitorWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:00:42,073 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-28 17:00:42,074 - INFO - InactivityMonitorWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-28 17:00:42,074 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:00:42,075 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-28 17:00:42,075 - INFO - InactivityMonitorWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:00:42,075 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 445 - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-28 17:00:42,075 - INFO - InactivityMonitorWorker - runnable_component - run - 128 - Component InactivityMonitorWorker (instance: 4639755488) cleanup complete.
2025-05-28 17:00:42,075 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-28 17:00:42,075 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 249 - All background tasks signaled to stop.
2025-05-28 17:00:42,075 - INFO - app.services.redis_service - redis_service - close_redis_pool - 43 - Redis connection pool closed successfully.
2025-05-28 17:00:42,079 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 17:00:42,079 - INFO - app.core.lifespan - lifespan - lifespan - 293 - Application shutdown sequence completed.
2025-05-28 17:00:42,141 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - polling_wrapper - 482 - Aiogram polling has stopped.
2025-05-28 17:00:42,141 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - run_loop - 137 - Main task 'AiogramPolling' completed. Result: None
2025-05-28 17:00:42,141 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - run_loop - 156 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-28 17:00:42,141 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - runnable_component - initiate_shutdown - 74 - Component TelegramIntegrationBot (instance: 4873739712) received shutdown request. Initiating graceful shutdown...
2025-05-28 17:00:42,141 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - runnable_component - initiate_shutdown - 79 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4873739712)...
2025-05-28 17:00:42,141 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - run_loop - 172 - ServiceComponentBase run_loop finished.
2025-05-28 17:00:42,142 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - run_loop - 494 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-28 17:00:42,142 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - runnable_component - run - 116 - Run_loop for TelegramIntegrationBot (instance: 4873739712) was cancelled.
2025-05-28 17:00:42,142 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - runnable_component - run - 123 - Component TelegramIntegrationBot (instance: 4873739712) stopping. Performing cleanup...
2025-05-28 17:00:42,142 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - cleanup - 503 - TelegramIntegrationBot cleanup started.
2025-05-28 17:00:42,142 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - cleanup - 516 - Closing Aiogram bot session.
2025-05-28 17:00:42,142 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - cleanup - 518 - Aiogram bot session closed.
2025-05-28 17:00:42,142 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - cleanup - 181 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-28 17:00:42,142 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - cleanup - 191 - Waiting for 1 tasks to process cancellation...
2025-05-28 17:00:42,142 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 270 - Pub/Sub listener task cancelled.
2025-05-28 17:00:42,142 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 294 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-28 17:00:42,143 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 298 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-28 17:00:42,143 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - cleanup - 202 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-28 17:00:42,143 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - cleanup - 207 - All main tasks processed and list cleared.
2025-05-28 17:00:42,147 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - status_updater - cleanup_status_updater - 316 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-28 17:00:42,148 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - status_updater - delete_status_key_from_redis - 196 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-28 17:00:42,148 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:00:42,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - status_updater - cleanup_status_updater - 320 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-28 17:00:42,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - cleanup - 211 - ServiceComponent cleanup completed.
2025-05-28 17:00:42,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - cleanup - 524 - TelegramIntegrationBot cleanup finished.
2025-05-28 17:00:42,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - runnable_component - run - 128 - Component TelegramIntegrationBot (instance: 4873739712) cleanup complete.
2025-05-28 17:00:42,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot_main - main_async_runner - 86 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-28 17:00:42,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot_main - main_async_runner - 95 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-28 17:00:42,149 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 17:00:42,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot_main - main_async_runner - 98 - Database engine closed.
2025-05-28 17:00:42,149 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot_main - main_async_runner - 101 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-28 17:00:42,151 - INFO - __main__ - telegram_bot_main - <module> - 124 - Telegram bot runner main finished.
2025-05-28 17:01:44,791 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 17:01:44,791 - INFO - app.core.lifespan - lifespan - lifespan - 277 - Application startup sequence initiated.
2025-05-28 17:01:44,797 - INFO - app.services.redis_service - redis_service - init_redis_pool - 24 - Redis connection pool initialized successfully.
2025-05-28 17:01:44,797 - INFO - app.core.lifespan - lifespan - start_background_tasks - 172 - Starting background tasks...
2025-05-28 17:01:44,797 - INFO - app.core.lifespan - lifespan - start_background_tasks - 182 - History saver worker started, listening to queue: chat_history_queue
2025-05-28 17:01:44,797 - INFO - TokenUsageWorker - token_usage_worker - __init__ - 45 - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-28 17:01:44,797 - INFO - app.core.lifespan - lifespan - start_background_tasks - 194 - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-28 17:01:44,797 - INFO - app.core.lifespan - lifespan - start_background_tasks - 206 - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-28 17:01:44,797 - INFO - app.core.lifespan - lifespan - start_background_tasks - 210 - 3 background tasks initiated.
2025-05-28 17:01:44,797 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 51 - Attempting to start existing agents and their integrations...
2025-05-28 17:01:44,797 - INFO - HistorySaverWorker - base_worker - setup - 48 - [history_saver_worker] Worker setup started.
2025-05-28 17:01:44,797 - INFO - TokenUsageWorker - base_worker - setup - 48 - [token_usage_worker] Worker setup started.
2025-05-28 17:01:44,797 - INFO - InactivityMonitorWorker - base_worker - setup - 48 - [inactivity_monitor_worker] Worker setup started.
2025-05-28 17:01:44,799 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 61 - ProcessManager setup complete for startup.
2025-05-28 17:01:44,801 - INFO - HistorySaverWorker - base_worker - setup - 52 - [history_saver_worker] Worker setup completed.
2025-05-28 17:01:44,801 - INFO - HistorySaverWorker - base_worker - setup - 114 - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-28 17:01:44,801 - INFO - InactivityMonitorWorker - base_worker - setup - 52 - [inactivity_monitor_worker] Worker setup completed.
2025-05-28 17:01:44,801 - INFO - InactivityMonitorWorker - base_worker - setup - 243 - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-28 17:01:44,801 - INFO - TokenUsageWorker - base_worker - setup - 52 - [token_usage_worker] Worker setup completed.
2025-05-28 17:01:44,801 - INFO - TokenUsageWorker - base_worker - setup - 114 - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-28 17:01:44,803 - INFO - TokenUsageWorker - token_usage_worker - setup - 57 - [token_usage_worker] Database session factory initialized.
2025-05-28 17:01:44,803 - INFO - HistorySaverWorker - history_saver_worker - setup - 49 - [history_saver_worker] Database session factory initialized.
2025-05-28 17:01:44,803 - INFO - HistorySaverWorker - runnable_component - run - 111 - Component HistorySaverWorker (instance: 4380465568) setup complete. Starting run loop.
2025-05-28 17:01:44,804 - INFO - HistorySaverWorker - base_worker - run_loop - 131 - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-28 17:01:44,804 - INFO - TokenUsageWorker - token_usage_worker - setup - 64 - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-28 17:01:44,804 - INFO - TokenUsageWorker - runnable_component - run - 111 - Component TokenUsageWorker (instance: 4380605472) setup complete. Starting run loop.
2025-05-28 17:01:44,804 - INFO - TokenUsageWorker - base_worker - run_loop - 131 - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-28 17:01:44,806 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 86 - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-28 17:01:44,806 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 94 - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-28 17:01:44,853 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 66 - Found 1 agents to potentially start.
2025-05-28 17:01:44,853 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 69 - Attempting to start agent: agent_airsoft_0faa9616
2025-05-28 17:01:44,855 - INFO - app.services.process_manager - process_manager - start_agent_process - 880 - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-28 17:01:44,856 - INFO - app.core.base.process_launcher - process_launcher - launch_process - 160 - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 90507
2025-05-28 17:01:44,856 - INFO - app.services.process_manager - process_manager - start_agent_process - 913 - Agent process agent_airsoft_0faa9616 initiated start with PID 90507
2025-05-28 17:01:44,857 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 79 - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-28 17:01:44,857 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 93 - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-28 17:01:44,857 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 109 - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-28 17:01:44,858 - INFO - app.services.process_manager - process_manager - start_integration_process - 554 - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-28 17:01:44,859 - INFO - app.core.base.process_launcher - process_launcher - launch_process - 160 - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 90508
2025-05-28 17:01:44,859 - INFO - app.services.process_manager - process_manager - start_integration_process - 600 - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 90508
2025-05-28 17:01:44,860 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 123 - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-28 17:01:44,860 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:01:44,860 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:01:44,860 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 153 - ProcessManager cleanup complete for startup function.
2025-05-28 17:01:44,860 - INFO - app.core.lifespan - lifespan - lifespan - 284 - Application startup sequence completed.
2025-05-28 17:01:45,786 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 17:01:45,786 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot_main - main_async_runner - 50 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-28 17:01:45,786 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot_main - main_async_runner - 57 - Database session factory configured for Telegram bot.
2025-05-28 17:01:45,786 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - __init__ - 44 - ServiceComponentBase initialized.
2025-05-28 17:01:45,786 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - __init__ - 56 - TelegramIntegrationBot initialized. PID: 90508
2025-05-28 17:01:45,786 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot_main - main_async_runner - 74 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-28 17:01:45,786 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - setup - 441 - TelegramIntegrationBot setup started.
2025-05-28 17:01:45,786 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - setup - 84 - ServiceComponent setup started.
2025-05-28 17:01:45,793 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - setup - 95 - ServiceComponent setup completed.
2025-05-28 17:01:45,806 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - setup - 452 - Aiogram Bot and Dispatcher initialized.
2025-05-28 17:01:45,807 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _register_handlers - 341 - Aiogram handlers registered.
2025-05-28 17:01:45,807 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - setup - 456 - TelegramIntegrationBot setup complete.
2025-05-28 17:01:45,807 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - runnable_component - run - 111 - Component TelegramIntegrationBot (instance: 4777909840) setup complete. Starting run loop.
2025-05-28 17:01:45,807 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - run_loop - 464 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-28 17:01:45,807 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - _register_main_task - 62 - Registered main task: RedisOutputListener
2025-05-28 17:01:45,807 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - _register_main_task - 62 - Registered main task: AiogramPolling
2025-05-28 17:01:45,807 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - run_loop - 122 - Starting run_loop with 2 registered main tasks.
2025-05-28 17:01:45,807 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 236 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-28 17:01:45,807 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - polling_wrapper - 473 - Starting aiogram polling...
2025-05-28 17:01:45,807 - INFO - aiogram.dispatcher - dispatcher - start_polling - 527 - Start polling
2025-05-28 17:01:45,809 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 254 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-28 17:01:46,059 - INFO - aiogram.dispatcher - dispatcher - _polling - 341 - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-28 17:01:46,217 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 17:01:46,217 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 21 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-28 17:01:46,217 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 28 - Database session factory configured for Agent.
2025-05-28 17:01:46,217 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - __init__ - 44 - ServiceComponentBase initialized.
2025-05-28 17:01:46,217 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - __init__ - 120 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 90507
2025-05-28 17:01:46,217 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 42 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-28 17:01:46,217 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - setup - 494 - AgentRunner setup started.
2025-05-28 17:01:46,217 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - setup - 84 - ServiceComponent setup started.
2025-05-28 17:01:46,223 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - setup - 95 - ServiceComponent setup completed.
2025-05-28 17:01:46,223 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - fetch_config - 27 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-28 17:01:46,303 - INFO - httpx - _client - _send_single_request - 1740 - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-28 17:01:46,303 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - fetch_config - 33 - Configuration fetched successfully.
2025-05-28 17:01:46,303 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _load_config - 138 - Agent configuration loaded and prepared successfully.
2025-05-28 17:01:46,303 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _setup_app - 149 - Creating LangGraph application...
2025-05-28 17:01:46,303 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_agent_app - 908 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-28 17:01:46,303 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_llm_instance - 80 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-28 17:01:46,329 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _configure_main_llm - 63 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-28 17:01:46,329 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 813 - Creating agent graph in GraphFactory...
2025-05-28 17:01:46,329 - INFO - app.agent_runner.common.tools_registry - tools_registry - configure_tools_centralized - 364 - Configured 3 predefined tools from centralized registry
2025-05-28 17:01:46,329 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 94 - Added 3 tools from centralized registry
2025-05-28 17:01:46,329 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 114 - Configuring 1 Knowledge Base tool(s)...
2025-05-28 17:01:46,387 - INFO - httpx - _client - _send_single_request - 1025 - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-28 17:01:46,399 - INFO - httpx - _client - _send_single_request - 1025 - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-28 17:01:47,491 - INFO - httpx - _client - _send_single_request - 1025 - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-28 17:01:47,493 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 132 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-28 17:01:47,493 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 166 - Must conditions for KB tool 'knowledgeBase-1745316404538': [FieldCondition(key='metadata.client_id', match=MatchValue(value='2'), range=None, geo_bounding_box=None, geo_radius=None, geo_polygon=None, values_count=None), FieldCondition(key='metadata.datasource_id', match=MatchAny(any=['5', '6', '7']), range=None, geo_bounding_box=None, geo_radius=None, geo_polygon=None, values_count=None)]
2025-05-28 17:01:47,493 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 182 - Configured Knowledge Base tool 'База знаний' (ID: knowledgeBase-1745316404538) for datasources: ['5', '6', '7']
2025-05-28 17:01:47,493 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 190 - Using max_rewrites: 4
2025-05-28 17:01:47,493 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 217 - Configured Web Search tool 'Поиск в Интернете' (ID: webSearch-1746879979658)
2025-05-28 17:01:47,493 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 244 - Total tools configured: 5 (4 safe, 1 datastore).
2025-05-28 17:01:47,493 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _configure_tools - 153 - Tools configured: 5 total, 4 safe, 1 datastore tools. Max rewrites: 4.
2025-05-28 17:01:47,493 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 821 - Context memory enabled: True
2025-05-28 17:01:47,494 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 829 - Added node: agent
2025-05-28 17:01:47,494 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 838 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-28 17:01:47,494 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 848 - Added node: safe_tools
2025-05-28 17:01:47,494 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 859 - Added edge: safe_tools -> agent
2025-05-28 17:01:47,494 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 865 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-28 17:01:47,494 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 872 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-28 17:01:47,495 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 888 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-28 17:01:47,506 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 900 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-28 17:01:47,506 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_agent_app - 917 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-28 17:01:47,506 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _setup_app - 157 - LangGraph application created successfully.
2025-05-28 17:01:47,506 - INFO - AGENT:agent_airsoft_0faa9616 - runnable_component - run - 111 - Component AgentRunner (instance: 4505191776) setup complete. Starting run loop.
2025-05-28 17:01:47,506 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - run_loop - 522 - AgentRunner run_loop starting...
2025-05-28 17:01:47,506 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - _register_main_task - 62 - Registered main task: AgentPubSubListener
2025-05-28 17:01:47,506 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - run_loop - 122 - Starting run_loop with 1 registered main tasks.
2025-05-28 17:01:47,506 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 236 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-28 17:01:47,510 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 254 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-28 17:01:54,807 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 96 - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-28 17:01:54,814 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 98 - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-28 17:01:54,814 - INFO - InactivityMonitorWorker - runnable_component - run - 111 - Component InactivityMonitorWorker (instance: 4380605376) setup complete. Starting run loop.
2025-05-28 17:01:54,814 - INFO - InactivityMonitorWorker - base_worker - run_loop - 258 - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-28 17:02:26,585 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _handle_text_message - 287 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'сколько нужно программистов для перехода на ут11?...'
2025-05-28 17:02:26,587 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _check_user_authorization - 124 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-28 17:02:26,671 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _publish_to_agent - 101 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-28 17:02:26,672 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _handle_text_message - 313 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-28 17:02:26,672 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _handle_pubsub_message - 202 - Processing message for chat_id: 144641834
2025-05-28 17:02:26,673 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _save_history - 481 - Queued user message for history (Thread: 144641834, InteractionID: a0f496a3-e410-4b62-a956-d6e41a175aa8)
2025-05-28 17:02:26,673 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _get_history - 417 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-28 17:02:26,674 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _get_history - 423 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-28 17:02:26,710 - INFO - HistorySaverWorker - history_saver_worker - process_message - 123 - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: a0f496a3-e410-4b62-a956-d6e41a175aa8, db_id: 890
2025-05-28 17:02:26,724 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _get_history - 433 - Loaded 20 messages from DB for thread '144641834'.
2025-05-28 17:02:26,725 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _get_history - 436 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-28 17:02:26,725 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _invoke_agent - 366 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-28 17:02:26,791 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 255 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-28 17:02:26,791 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_llm_instance - 80 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-28 17:02:26,817 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_node_llm - 708 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-28 17:02:26,821 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _bind_tools_to_model - 799 - Model bound to 5 tools.
2025-05-28 17:02:27,673 - INFO - aiogram.event - dispatcher - feed_update - 172 - Update id=804756292 is handled. Duration 1089 ms by bot id=1750613938
2025-05-28 17:02:30,232 - INFO - httpx - _client - _send_single_request - 1740 - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-28 17:02:30,935 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 285 - Agent node response content preview: N/A
2025-05-28 17:02:30,935 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 287 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-28 17:02:30,935 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 289 - Agent node usage_metadata: {'input_tokens': 1548, 'output_tokens': 36, 'total_tokens': 1584, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-28 17:02:30,935 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _extract_token_data - 218 - Token usage from usage_metadata: P:1548 C:36 T:1584
2025-05-28 17:02:30,935 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _get_tokens - 250 - Token usage for agent_llm: 1584 tokens recorded.
2025-05-28 17:02:30,936 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _route_tools_edge - 600 - ---ROUTE TOOLS---
2025-05-28 17:02:30,936 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _route_tools_edge - 630 - Tool call detected: knowledgeBase-1745316404538
2025-05-28 17:02:30,936 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _route_tools_edge - 633 - ---DECISION: ROUTE TO RETRIEVE (knowledgeBase-1745316404538)---
2025-05-28 17:02:31,831 - INFO - httpx - _client - _send_single_request - 1025 - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-28 17:02:31,848 - INFO - httpx - _client - _send_single_request - 1025 - HTTP Request: POST http://127.0.0.1:6333/collections/platformai/points/query "HTTP/1.1 200 OK"
2025-05-28 17:02:31,851 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _grade_docs_node - 360 - ---CHECK RELEVANCE (Agent ID: agent_airsoft_0faa9616)---
2025-05-28 17:02:31,851 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _grade_docs_node - 371 - Grading documents for question: 'сколько нужно программистов для перехода на ут11?'
2025-05-28 17:02:31,851 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_llm_instance - 80 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.0, streaming: False
2025-05-28 17:02:31,876 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_node_llm - 708 - Created grading LLM: gpt-4.1-mini via OpenAI
2025-05-28 17:02:33,144 - INFO - httpx - _client - _send_single_request - 1740 - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-28 17:02:33,162 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _extract_token_data - 218 - Token usage from usage_metadata: P:191 C:6 T:197
2025-05-28 17:02:33,162 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _get_tokens - 250 - Token usage for grading_llm: 197 tokens recorded.
2025-05-28 17:02:33,162 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _grade_docs_node - 456 - Total token usage for grading_llm batch: 197 tokens.
2025-05-28 17:02:33,162 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _grade_docs_node - 461 - Found 0 relevant documents out of 1 initial (after split).
2025-05-28 17:02:33,163 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _decide_to_generate_edge - 580 - ---ASSESS GRADED DOCUMENTS---
2025-05-28 17:02:33,163 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _decide_to_generate_edge - 589 - ---DECISION: NO RELEVANT DOCUMENTS, REWRITE---
2025-05-28 17:02:33,164 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _rewrite_node - 466 - ---TRANSFORM QUERY (Agent ID: agent_airsoft_0faa9616)---
2025-05-28 17:02:33,164 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _rewrite_node - 477 - Rewrite attempt 1/4 for question: 'сколько нужно программистов для перехода на ут11?'
2025-05-28 17:02:33,164 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _rewrite_node - 480 - Rewriting original question: сколько нужно программистов для перехода на ут11?
2025-05-28 17:02:33,164 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_llm_instance - 80 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: False
2025-05-28 17:02:33,190 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_node_llm - 708 - Created rewrite LLM: gpt-4.1-mini via OpenAI
2025-05-28 17:02:35,253 - INFO - httpx - _client - _send_single_request - 1740 - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-28 17:02:35,255 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _rewrite_node - 498 - Rewritten question: Сколько программистов требуется для миграции на 1С:Управление торговлей 11 с учетом объема данных, количества кастомных доработок и сроков реализации проекта?
2025-05-28 17:02:35,255 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _extract_token_data - 218 - Token usage from usage_metadata: P:2420 C:42 T:2462
2025-05-28 17:02:35,255 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _get_tokens - 250 - Token usage for rewrite_llm: 2462 tokens recorded.
2025-05-28 17:02:35,257 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 255 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-28 17:02:35,257 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_llm_instance - 80 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-28 17:02:35,283 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_node_llm - 708 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-28 17:02:35,287 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _bind_tools_to_model - 799 - Model bound to 5 tools.
2025-05-28 17:02:36,718 - INFO - httpx - _client - _send_single_request - 1740 - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-28 17:02:38,058 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 285 - Agent node response content preview: Конечно! Вот переформулированный запрос:

**"Сколько программистов требуется для миграции на 1С:Упра
2025-05-28 17:02:38,058 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 287 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-28 17:02:38,058 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 289 - Agent node usage_metadata: {'input_tokens': 1675, 'output_tokens': 81, 'total_tokens': 1756, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-28 17:02:38,058 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _extract_token_data - 218 - Token usage from usage_metadata: P:1675 C:81 T:1756
2025-05-28 17:02:38,058 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _get_tokens - 250 - Token usage for agent_llm: 1756 tokens recorded.
2025-05-28 17:02:38,059 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _route_tools_edge - 600 - ---ROUTE TOOLS---
2025-05-28 17:02:38,059 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _route_tools_edge - 608 - ---DECISION: NO TOOLS CALLED, END---
2025-05-28 17:02:38,060 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _invoke_agent - 384 - Graph execution finished. Final response: Конечно! Вот переформулированный запрос:

**"Сколько программистов требуется для миграции на 1С:Упра...
2025-05-28 17:02:38,062 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _save_history - 481 - Queued agent message for history (Thread: 144641834, InteractionID: a0f496a3-e410-4b62-a956-d6e41a175aa8)
2025-05-28 17:02:38,062 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _save_tokens - 315 - Found 4 token usage events for InteractionID: a0f496a3-e410-4b62-a956-d6e41a175aa8.
2025-05-28 17:02:38,066 - INFO - TokenUsageWorker - token_usage_worker - process_message - 117 - [token_usage_worker] RAW token usage data: {'interaction_id': 'a0f496a3-e410-4b62-a956-d6e41a175aa8', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1548, 'completion_tokens': 36, 'total_tokens': 1584, 'timestamp': '2025-05-28T12:02:30.935677+00:00'}
2025-05-28 17:02:38,066 - INFO - TokenUsageWorker - token_usage_worker - process_message - 129 - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: a0f496a3-e410-4b62-a956-d6e41a175aa8
2025-05-28 17:02:38,066 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _handle_pubsub_message - 385 - Received response from agent for chat 144641834: Конечно! Вот переформулированный запрос:

**"Сколько программистов требуется для миграции на 1С:Упра...
2025-05-28 17:02:38,066 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _handle_pubsub_message - 414 - Sending message from agent to chat 144641834: 'Конечно! Вот переформулированный запрос:

**"Сколь...'
2025-05-28 17:02:38,070 - INFO - HistorySaverWorker - history_saver_worker - process_message - 123 - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: a0f496a3-e410-4b62-a956-d6e41a175aa8, db_id: 891
2025-05-28 17:02:38,097 - INFO - TokenUsageWorker - token_usage_worker - process_message - 148 - [token_usage_worker] Found message_id: 891 for interaction_id: a0f496a3-e410-4b62-a956-d6e41a175aa8 on attempt 1
2025-05-28 17:02:38,103 - INFO - TokenUsageWorker - token_usage_worker - _save_token_usage_to_db - 92 - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: a0f496a3-e410-4b62-a956-d6e41a175aa8, db_id: 353
2025-05-28 17:02:38,105 - INFO - TokenUsageWorker - token_usage_worker - process_message - 117 - [token_usage_worker] RAW token usage data: {'interaction_id': 'a0f496a3-e410-4b62-a956-d6e41a175aa8', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1675, 'completion_tokens': 81, 'total_tokens': 1756, 'timestamp': '2025-05-28T12:02:38.058618+00:00'}
2025-05-28 17:02:38,105 - INFO - TokenUsageWorker - token_usage_worker - process_message - 129 - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: a0f496a3-e410-4b62-a956-d6e41a175aa8
2025-05-28 17:02:38,107 - INFO - TokenUsageWorker - token_usage_worker - process_message - 148 - [token_usage_worker] Found message_id: 891 for interaction_id: a0f496a3-e410-4b62-a956-d6e41a175aa8 on attempt 1
2025-05-28 17:02:38,110 - INFO - TokenUsageWorker - token_usage_worker - _save_token_usage_to_db - 92 - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: a0f496a3-e410-4b62-a956-d6e41a175aa8, db_id: 354
2025-05-28 17:02:38,112 - INFO - TokenUsageWorker - token_usage_worker - process_message - 117 - [token_usage_worker] RAW token usage data: {'interaction_id': 'a0f496a3-e410-4b62-a956-d6e41a175aa8', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'rewrite_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 2420, 'completion_tokens': 42, 'total_tokens': 2462, 'timestamp': '2025-05-28T12:02:35.255903+00:00'}
2025-05-28 17:02:38,112 - INFO - TokenUsageWorker - token_usage_worker - process_message - 129 - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: a0f496a3-e410-4b62-a956-d6e41a175aa8
2025-05-28 17:02:38,113 - INFO - TokenUsageWorker - token_usage_worker - process_message - 148 - [token_usage_worker] Found message_id: 891 for interaction_id: a0f496a3-e410-4b62-a956-d6e41a175aa8 on attempt 1
2025-05-28 17:02:38,115 - INFO - TokenUsageWorker - token_usage_worker - _save_token_usage_to_db - 92 - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: a0f496a3-e410-4b62-a956-d6e41a175aa8, db_id: 355
2025-05-28 17:02:38,117 - INFO - TokenUsageWorker - token_usage_worker - process_message - 117 - [token_usage_worker] RAW token usage data: {'interaction_id': 'a0f496a3-e410-4b62-a956-d6e41a175aa8', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'grading_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 191, 'completion_tokens': 6, 'total_tokens': 197, 'timestamp': '2025-05-28T12:02:33.162641+00:00'}
2025-05-28 17:02:38,117 - INFO - TokenUsageWorker - token_usage_worker - process_message - 129 - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: a0f496a3-e410-4b62-a956-d6e41a175aa8
2025-05-28 17:02:38,118 - INFO - TokenUsageWorker - token_usage_worker - process_message - 148 - [token_usage_worker] Found message_id: 891 for interaction_id: a0f496a3-e410-4b62-a956-d6e41a175aa8 on attempt 1
2025-05-28 17:02:38,120 - INFO - TokenUsageWorker - token_usage_worker - _save_token_usage_to_db - 92 - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: a0f496a3-e410-4b62-a956-d6e41a175aa8, db_id: 356
2025-05-28 17:04:07,147 - INFO - app.core.lifespan - lifespan - lifespan - 287 - Application shutdown sequence initiated.
2025-05-28 17:04:07,147 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 230 - Stopping 3 background tasks...
2025-05-28 17:04:07,147 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task HistorySaverWorker...
2025-05-28 17:04:07,148 - INFO - HistorySaverWorker - runnable_component - run - 116 - Run_loop for HistorySaverWorker (instance: 4380465568) was cancelled.
2025-05-28 17:04:07,148 - INFO - HistorySaverWorker - runnable_component - run - 123 - Component HistorySaverWorker (instance: 4380465568) stopping. Performing cleanup...
2025-05-28 17:04:07,148 - INFO - HistorySaverWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:04:07,153 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for history_saver_worker as part of cleanup.
2025-05-28 17:04:07,155 - INFO - HistorySaverWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-28 17:04:07,155 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:04:07,155 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-28 17:04:07,155 - INFO - HistorySaverWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:04:07,155 - INFO - HistorySaverWorker - runnable_component - run - 128 - Component HistorySaverWorker (instance: 4380465568) cleanup complete.
2025-05-28 17:04:07,155 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task HistorySaverWorker finished after cancellation signal.
2025-05-28 17:04:07,155 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task TokenUsageWorker...
2025-05-28 17:04:07,155 - INFO - TokenUsageWorker - runnable_component - run - 116 - Run_loop for TokenUsageWorker (instance: 4380605472) was cancelled.
2025-05-28 17:04:07,155 - INFO - TokenUsageWorker - runnable_component - run - 123 - Component TokenUsageWorker (instance: 4380605472) stopping. Performing cleanup...
2025-05-28 17:04:07,155 - INFO - TokenUsageWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:04:07,159 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for token_usage_worker as part of cleanup.
2025-05-28 17:04:07,160 - INFO - TokenUsageWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-28 17:04:07,160 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:04:07,160 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-28 17:04:07,160 - INFO - TokenUsageWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:04:07,160 - INFO - TokenUsageWorker - runnable_component - run - 128 - Component TokenUsageWorker (instance: 4380605472) cleanup complete.
2025-05-28 17:04:07,160 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task TokenUsageWorker finished after cancellation signal.
2025-05-28 17:04:07,160 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task InactivityMonitorWorker...
2025-05-28 17:04:07,160 - INFO - InactivityMonitorWorker - runnable_component - run - 116 - Run_loop for InactivityMonitorWorker (instance: 4380605376) was cancelled.
2025-05-28 17:04:07,160 - INFO - InactivityMonitorWorker - runnable_component - run - 123 - Component InactivityMonitorWorker (instance: 4380605376) stopping. Performing cleanup...
2025-05-28 17:04:07,161 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 437 - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-28 17:04:07,161 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:04:07,161 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:04:07,161 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 441 - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-28 17:04:07,161 - INFO - InactivityMonitorWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:04:07,163 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-28 17:04:07,164 - INFO - InactivityMonitorWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-28 17:04:07,164 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:04:07,164 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-28 17:04:07,164 - INFO - InactivityMonitorWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:04:07,164 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 445 - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-28 17:04:07,164 - INFO - InactivityMonitorWorker - runnable_component - run - 128 - Component InactivityMonitorWorker (instance: 4380605376) cleanup complete.
2025-05-28 17:04:07,164 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-28 17:04:07,164 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 249 - All background tasks signaled to stop.
2025-05-28 17:04:07,165 - INFO - app.services.redis_service - redis_service - close_redis_pool - 43 - Redis connection pool closed successfully.
2025-05-28 17:04:07,183 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 17:04:07,183 - INFO - app.core.lifespan - lifespan - lifespan - 293 - Application shutdown sequence completed.
2025-05-28 17:04:07,689 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 17:04:07,689 - INFO - app.core.lifespan - lifespan - lifespan - 277 - Application startup sequence initiated.
2025-05-28 17:04:07,694 - INFO - app.services.redis_service - redis_service - init_redis_pool - 24 - Redis connection pool initialized successfully.
2025-05-28 17:04:07,694 - INFO - app.core.lifespan - lifespan - start_background_tasks - 172 - Starting background tasks...
2025-05-28 17:04:07,694 - INFO - app.core.lifespan - lifespan - start_background_tasks - 182 - History saver worker started, listening to queue: chat_history_queue
2025-05-28 17:04:07,694 - INFO - TokenUsageWorker - token_usage_worker - __init__ - 45 - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-28 17:04:07,694 - INFO - app.core.lifespan - lifespan - start_background_tasks - 194 - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-28 17:04:07,694 - INFO - app.core.lifespan - lifespan - start_background_tasks - 206 - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-28 17:04:07,694 - INFO - app.core.lifespan - lifespan - start_background_tasks - 210 - 3 background tasks initiated.
2025-05-28 17:04:07,694 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 51 - Attempting to start existing agents and their integrations...
2025-05-28 17:04:07,695 - INFO - HistorySaverWorker - base_worker - setup - 48 - [history_saver_worker] Worker setup started.
2025-05-28 17:04:07,695 - INFO - TokenUsageWorker - base_worker - setup - 48 - [token_usage_worker] Worker setup started.
2025-05-28 17:04:07,695 - INFO - InactivityMonitorWorker - base_worker - setup - 48 - [inactivity_monitor_worker] Worker setup started.
2025-05-28 17:04:07,697 - INFO - HistorySaverWorker - base_worker - setup - 52 - [history_saver_worker] Worker setup completed.
2025-05-28 17:04:07,697 - INFO - HistorySaverWorker - base_worker - setup - 114 - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-28 17:04:07,697 - INFO - TokenUsageWorker - base_worker - setup - 52 - [token_usage_worker] Worker setup completed.
2025-05-28 17:04:07,697 - INFO - TokenUsageWorker - base_worker - setup - 114 - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-28 17:04:07,697 - INFO - InactivityMonitorWorker - base_worker - setup - 52 - [inactivity_monitor_worker] Worker setup completed.
2025-05-28 17:04:07,697 - INFO - InactivityMonitorWorker - base_worker - setup - 243 - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-28 17:04:07,697 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 61 - ProcessManager setup complete for startup.
2025-05-28 17:04:07,699 - INFO - HistorySaverWorker - history_saver_worker - setup - 49 - [history_saver_worker] Database session factory initialized.
2025-05-28 17:04:07,699 - INFO - HistorySaverWorker - runnable_component - run - 111 - Component HistorySaverWorker (instance: 4416281664) setup complete. Starting run loop.
2025-05-28 17:04:07,699 - INFO - HistorySaverWorker - base_worker - run_loop - 131 - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-28 17:04:07,700 - INFO - TokenUsageWorker - token_usage_worker - setup - 57 - [token_usage_worker] Database session factory initialized.
2025-05-28 17:04:07,700 - INFO - TokenUsageWorker - token_usage_worker - setup - 64 - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-28 17:04:07,700 - INFO - TokenUsageWorker - runnable_component - run - 111 - Component TokenUsageWorker (instance: 4418485040) setup complete. Starting run loop.
2025-05-28 17:04:07,700 - INFO - TokenUsageWorker - base_worker - run_loop - 131 - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-28 17:04:07,703 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 86 - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-28 17:04:07,703 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 94 - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-28 17:04:07,749 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 66 - Found 1 agents to potentially start.
2025-05-28 17:04:07,749 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 69 - Attempting to start agent: agent_airsoft_0faa9616
2025-05-28 17:04:07,750 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 73 - Agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:04:07,750 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 93 - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-28 17:04:07,750 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 109 - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-28 17:04:07,752 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 115 - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:04:07,753 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:04:07,753 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:04:07,753 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 153 - ProcessManager cleanup complete for startup function.
2025-05-28 17:04:07,753 - INFO - app.core.lifespan - lifespan - lifespan - 284 - Application startup sequence completed.
2025-05-28 17:04:17,704 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 96 - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-28 17:04:17,707 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 98 - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-28 17:04:17,707 - INFO - InactivityMonitorWorker - runnable_component - run - 111 - Component InactivityMonitorWorker (instance: 4418475632) setup complete. Starting run loop.
2025-05-28 17:04:17,708 - INFO - InactivityMonitorWorker - base_worker - run_loop - 258 - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-28 17:05:02,956 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - run_loop - 160 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-28 17:05:02,956 - WARNING - aiogram.dispatcher - dispatcher - _signal_stop_polling - 455 - Received SIGINT signal
2025-05-28 17:05:02,958 - INFO - AGENT:agent_airsoft_0faa9616 - runnable_component - initiate_shutdown - 74 - Component AgentRunner (instance: 4505191776) received shutdown request. Initiating graceful shutdown...
2025-05-28 17:05:02,959 - INFO - AGENT:agent_airsoft_0faa9616 - runnable_component - initiate_shutdown - 79 - Cancelling main task (_run_loop) for AgentRunner (instance: 4505191776)...
2025-05-28 17:05:02,959 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - run_loop - 172 - ServiceComponentBase run_loop finished.
2025-05-28 17:05:02,959 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - run_loop - 536 - AgentRunner run_loop finished.
2025-05-28 17:05:02,959 - INFO - aiogram.dispatcher - dispatcher - _polling - 359 - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-28 17:05:02,959 - INFO - AGENT:agent_airsoft_0faa9616 - runnable_component - run - 116 - Run_loop for AgentRunner (instance: 4505191776) was cancelled.
2025-05-28 17:05:02,959 - INFO - AGENT:agent_airsoft_0faa9616 - runnable_component - run - 123 - Component AgentRunner (instance: 4505191776) stopping. Performing cleanup...
2025-05-28 17:05:02,959 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - cleanup - 546 - AgentRunner cleanup started.
2025-05-28 17:05:02,959 - INFO - aiogram.dispatcher - dispatcher - start_polling - 554 - Polling stopped
2025-05-28 17:05:02,960 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - cleanup - 552 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-28 17:05:02,960 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - cleanup - 181 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-28 17:05:02,960 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - cleanup - 191 - Waiting for 1 tasks to process cancellation...
2025-05-28 17:05:02,961 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 270 - Pub/Sub listener task cancelled.
2025-05-28 17:05:02,961 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 294 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-28 17:05:02,961 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 298 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-28 17:05:02,961 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - cleanup - 202 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-28 17:05:02,961 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - cleanup - 207 - All main tasks processed and list cleared.
2025-05-28 17:05:02,965 - INFO - AGENT:agent_airsoft_0faa9616 - status_updater - cleanup_status_updater - 316 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-28 17:05:02,966 - INFO - AGENT:agent_airsoft_0faa9616 - status_updater - delete_status_key_from_redis - 196 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-28 17:05:02,966 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:05:02,966 - INFO - AGENT:agent_airsoft_0faa9616 - status_updater - cleanup_status_updater - 320 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-28 17:05:02,967 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - cleanup - 211 - ServiceComponent cleanup completed.
2025-05-28 17:05:02,967 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - cleanup - 581 - AgentRunner cleanup finished.
2025-05-28 17:05:02,967 - INFO - AGENT:agent_airsoft_0faa9616 - runnable_component - run - 128 - Component AgentRunner (instance: 4505191776) cleanup complete.
2025-05-28 17:05:02,967 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 51 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-28 17:05:02,967 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 60 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-28 17:05:02,972 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 17:05:02,972 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 63 - Database engine closed.
2025-05-28 17:05:02,972 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 66 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-28 17:05:02,973 - INFO - __main__ - runner_main - <module> - 86 - Agent runner main finished.
2025-05-28 17:05:03,120 - INFO - app.core.lifespan - lifespan - lifespan - 287 - Application shutdown sequence initiated.
2025-05-28 17:05:03,120 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 230 - Stopping 3 background tasks...
2025-05-28 17:05:03,120 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task HistorySaverWorker...
2025-05-28 17:05:03,120 - INFO - HistorySaverWorker - runnable_component - run - 116 - Run_loop for HistorySaverWorker (instance: 4416281664) was cancelled.
2025-05-28 17:05:03,120 - INFO - HistorySaverWorker - runnable_component - run - 123 - Component HistorySaverWorker (instance: 4416281664) stopping. Performing cleanup...
2025-05-28 17:05:03,120 - INFO - HistorySaverWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:05:03,125 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for history_saver_worker as part of cleanup.
2025-05-28 17:05:03,125 - INFO - HistorySaverWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-28 17:05:03,126 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:05:03,126 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-28 17:05:03,126 - INFO - HistorySaverWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:05:03,126 - INFO - HistorySaverWorker - runnable_component - run - 128 - Component HistorySaverWorker (instance: 4416281664) cleanup complete.
2025-05-28 17:05:03,126 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task HistorySaverWorker finished after cancellation signal.
2025-05-28 17:05:03,126 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task TokenUsageWorker...
2025-05-28 17:05:03,126 - INFO - TokenUsageWorker - runnable_component - run - 116 - Run_loop for TokenUsageWorker (instance: 4418485040) was cancelled.
2025-05-28 17:05:03,126 - INFO - TokenUsageWorker - runnable_component - run - 123 - Component TokenUsageWorker (instance: 4418485040) stopping. Performing cleanup...
2025-05-28 17:05:03,126 - INFO - TokenUsageWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:05:03,129 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for token_usage_worker as part of cleanup.
2025-05-28 17:05:03,130 - INFO - TokenUsageWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-28 17:05:03,130 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:05:03,130 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-28 17:05:03,130 - INFO - TokenUsageWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:05:03,130 - INFO - TokenUsageWorker - runnable_component - run - 128 - Component TokenUsageWorker (instance: 4418485040) cleanup complete.
2025-05-28 17:05:03,130 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task TokenUsageWorker finished after cancellation signal.
2025-05-28 17:05:03,130 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task InactivityMonitorWorker...
2025-05-28 17:05:03,130 - INFO - InactivityMonitorWorker - runnable_component - run - 116 - Run_loop for InactivityMonitorWorker (instance: 4418475632) was cancelled.
2025-05-28 17:05:03,130 - INFO - InactivityMonitorWorker - runnable_component - run - 123 - Component InactivityMonitorWorker (instance: 4418475632) stopping. Performing cleanup...
2025-05-28 17:05:03,130 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 437 - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-28 17:05:03,130 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:05:03,130 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:05:03,130 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 441 - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-28 17:05:03,130 - INFO - InactivityMonitorWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:05:03,132 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-28 17:05:03,133 - INFO - InactivityMonitorWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-28 17:05:03,133 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:05:03,133 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-28 17:05:03,133 - INFO - InactivityMonitorWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:05:03,133 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 445 - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-28 17:05:03,133 - INFO - InactivityMonitorWorker - runnable_component - run - 128 - Component InactivityMonitorWorker (instance: 4418475632) cleanup complete.
2025-05-28 17:05:03,133 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-28 17:05:03,133 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 249 - All background tasks signaled to stop.
2025-05-28 17:05:03,133 - INFO - app.services.redis_service - redis_service - close_redis_pool - 43 - Redis connection pool closed successfully.
2025-05-28 17:05:03,137 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 17:05:03,137 - INFO - app.core.lifespan - lifespan - lifespan - 293 - Application shutdown sequence completed.
2025-05-28 17:05:03,211 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - polling_wrapper - 482 - Aiogram polling has stopped.
2025-05-28 17:05:03,211 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - run_loop - 137 - Main task 'AiogramPolling' completed. Result: None
2025-05-28 17:05:03,211 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - run_loop - 156 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-28 17:05:03,211 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - runnable_component - initiate_shutdown - 74 - Component TelegramIntegrationBot (instance: 4777909840) received shutdown request. Initiating graceful shutdown...
2025-05-28 17:05:03,211 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - runnable_component - initiate_shutdown - 79 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4777909840)...
2025-05-28 17:05:03,211 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - run_loop - 172 - ServiceComponentBase run_loop finished.
2025-05-28 17:05:03,211 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - run_loop - 494 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-28 17:05:03,211 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - runnable_component - run - 116 - Run_loop for TelegramIntegrationBot (instance: 4777909840) was cancelled.
2025-05-28 17:05:03,211 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - runnable_component - run - 123 - Component TelegramIntegrationBot (instance: 4777909840) stopping. Performing cleanup...
2025-05-28 17:05:03,211 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - cleanup - 503 - TelegramIntegrationBot cleanup started.
2025-05-28 17:05:03,211 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - cleanup - 516 - Closing Aiogram bot session.
2025-05-28 17:05:03,211 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - cleanup - 518 - Aiogram bot session closed.
2025-05-28 17:05:03,211 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - cleanup - 181 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-28 17:05:03,212 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - cleanup - 191 - Waiting for 1 tasks to process cancellation...
2025-05-28 17:05:03,212 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 270 - Pub/Sub listener task cancelled.
2025-05-28 17:05:03,212 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 294 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-28 17:05:03,212 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 298 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-28 17:05:03,212 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - cleanup - 202 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-28 17:05:03,212 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - cleanup - 207 - All main tasks processed and list cleared.
2025-05-28 17:05:03,217 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - status_updater - cleanup_status_updater - 316 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-28 17:05:03,218 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - status_updater - delete_status_key_from_redis - 196 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-28 17:05:03,218 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:05:03,218 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - status_updater - cleanup_status_updater - 320 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-28 17:05:03,218 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - cleanup - 211 - ServiceComponent cleanup completed.
2025-05-28 17:05:03,218 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - cleanup - 524 - TelegramIntegrationBot cleanup finished.
2025-05-28 17:05:03,218 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - runnable_component - run - 128 - Component TelegramIntegrationBot (instance: 4777909840) cleanup complete.
2025-05-28 17:05:03,218 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot_main - main_async_runner - 86 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-28 17:05:03,218 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot_main - main_async_runner - 95 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-28 17:05:03,223 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 17:05:03,223 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot_main - main_async_runner - 98 - Database engine closed.
2025-05-28 17:05:03,223 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot_main - main_async_runner - 101 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-28 17:05:03,225 - INFO - __main__ - telegram_bot_main - <module> - 124 - Telegram bot runner main finished.
2025-05-28 17:05:13,372 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 17:05:13,372 - INFO - app.core.lifespan - lifespan - lifespan - 277 - Application startup sequence initiated.
2025-05-28 17:05:13,376 - INFO - app.services.redis_service - redis_service - init_redis_pool - 24 - Redis connection pool initialized successfully.
2025-05-28 17:05:13,376 - INFO - app.core.lifespan - lifespan - start_background_tasks - 172 - Starting background tasks...
2025-05-28 17:05:13,376 - INFO - app.core.lifespan - lifespan - start_background_tasks - 182 - History saver worker started, listening to queue: chat_history_queue
2025-05-28 17:05:13,376 - INFO - TokenUsageWorker - token_usage_worker - __init__ - 45 - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-28 17:05:13,377 - INFO - app.core.lifespan - lifespan - start_background_tasks - 194 - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-28 17:05:13,377 - INFO - app.core.lifespan - lifespan - start_background_tasks - 206 - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-28 17:05:13,377 - INFO - app.core.lifespan - lifespan - start_background_tasks - 210 - 3 background tasks initiated.
2025-05-28 17:05:13,377 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 51 - Attempting to start existing agents and their integrations...
2025-05-28 17:05:13,377 - INFO - HistorySaverWorker - base_worker - setup - 48 - [history_saver_worker] Worker setup started.
2025-05-28 17:05:13,377 - INFO - TokenUsageWorker - base_worker - setup - 48 - [token_usage_worker] Worker setup started.
2025-05-28 17:05:13,377 - INFO - InactivityMonitorWorker - base_worker - setup - 48 - [inactivity_monitor_worker] Worker setup started.
2025-05-28 17:05:13,382 - INFO - TokenUsageWorker - base_worker - setup - 52 - [token_usage_worker] Worker setup completed.
2025-05-28 17:05:13,382 - INFO - TokenUsageWorker - base_worker - setup - 114 - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-28 17:05:13,382 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 61 - ProcessManager setup complete for startup.
2025-05-28 17:05:13,383 - INFO - HistorySaverWorker - base_worker - setup - 52 - [history_saver_worker] Worker setup completed.
2025-05-28 17:05:13,383 - INFO - HistorySaverWorker - base_worker - setup - 114 - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-28 17:05:13,383 - INFO - InactivityMonitorWorker - base_worker - setup - 52 - [inactivity_monitor_worker] Worker setup completed.
2025-05-28 17:05:13,383 - INFO - InactivityMonitorWorker - base_worker - setup - 243 - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-28 17:05:13,384 - INFO - TokenUsageWorker - token_usage_worker - setup - 57 - [token_usage_worker] Database session factory initialized.
2025-05-28 17:05:13,384 - INFO - HistorySaverWorker - history_saver_worker - setup - 49 - [history_saver_worker] Database session factory initialized.
2025-05-28 17:05:13,384 - INFO - HistorySaverWorker - runnable_component - run - 111 - Component HistorySaverWorker (instance: 4455495056) setup complete. Starting run loop.
2025-05-28 17:05:13,384 - INFO - TokenUsageWorker - token_usage_worker - setup - 64 - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-28 17:05:13,384 - INFO - TokenUsageWorker - runnable_component - run - 111 - Component TokenUsageWorker (instance: 4456151760) setup complete. Starting run loop.
2025-05-28 17:05:13,384 - INFO - HistorySaverWorker - base_worker - run_loop - 131 - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-28 17:05:13,384 - INFO - TokenUsageWorker - base_worker - run_loop - 131 - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-28 17:05:13,386 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 86 - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-28 17:05:13,386 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 94 - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-28 17:05:13,430 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 66 - Found 1 agents to potentially start.
2025-05-28 17:05:13,431 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 69 - Attempting to start agent: agent_airsoft_0faa9616
2025-05-28 17:05:13,433 - INFO - app.services.process_manager - process_manager - start_agent_process - 880 - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-28 17:05:13,434 - INFO - app.core.base.process_launcher - process_launcher - launch_process - 160 - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 92550
2025-05-28 17:05:13,434 - INFO - app.services.process_manager - process_manager - start_agent_process - 913 - Agent process agent_airsoft_0faa9616 initiated start with PID 92550
2025-05-28 17:05:13,435 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 79 - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-28 17:05:13,435 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 93 - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-28 17:05:13,435 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 109 - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-28 17:05:13,436 - INFO - app.services.process_manager - process_manager - start_integration_process - 554 - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-28 17:05:13,437 - INFO - app.core.base.process_launcher - process_launcher - launch_process - 160 - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 92551
2025-05-28 17:05:13,437 - INFO - app.services.process_manager - process_manager - start_integration_process - 600 - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 92551
2025-05-28 17:05:13,437 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 123 - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-28 17:05:13,438 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:05:13,438 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:05:13,438 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 153 - ProcessManager cleanup complete for startup function.
2025-05-28 17:05:13,438 - INFO - app.core.lifespan - lifespan - lifespan - 284 - Application startup sequence completed.
2025-05-28 17:05:14,348 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 17:05:14,349 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot_main - main_async_runner - 50 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-28 17:05:14,349 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot_main - main_async_runner - 57 - Database session factory configured for Telegram bot.
2025-05-28 17:05:14,349 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - __init__ - 44 - ServiceComponentBase initialized.
2025-05-28 17:05:14,349 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - __init__ - 56 - TelegramIntegrationBot initialized. PID: 92551
2025-05-28 17:05:14,349 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot_main - main_async_runner - 74 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-28 17:05:14,349 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - setup - 441 - TelegramIntegrationBot setup started.
2025-05-28 17:05:14,349 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - setup - 84 - ServiceComponent setup started.
2025-05-28 17:05:14,356 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - setup - 95 - ServiceComponent setup completed.
2025-05-28 17:05:14,369 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - setup - 452 - Aiogram Bot and Dispatcher initialized.
2025-05-28 17:05:14,369 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _register_handlers - 341 - Aiogram handlers registered.
2025-05-28 17:05:14,369 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - setup - 456 - TelegramIntegrationBot setup complete.
2025-05-28 17:05:14,369 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - runnable_component - run - 111 - Component TelegramIntegrationBot (instance: 4402044256) setup complete. Starting run loop.
2025-05-28 17:05:14,369 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - run_loop - 464 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-28 17:05:14,369 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - _register_main_task - 62 - Registered main task: RedisOutputListener
2025-05-28 17:05:14,369 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - _register_main_task - 62 - Registered main task: AiogramPolling
2025-05-28 17:05:14,369 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - run_loop - 122 - Starting run_loop with 2 registered main tasks.
2025-05-28 17:05:14,370 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 236 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-28 17:05:14,370 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - polling_wrapper - 473 - Starting aiogram polling...
2025-05-28 17:05:14,370 - INFO - aiogram.dispatcher - dispatcher - start_polling - 527 - Start polling
2025-05-28 17:05:14,372 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 254 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-28 17:05:14,623 - INFO - aiogram.dispatcher - dispatcher - _polling - 341 - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-28 17:05:14,784 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 17:05:14,784 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 21 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-28 17:05:14,784 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 28 - Database session factory configured for Agent.
2025-05-28 17:05:14,784 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - __init__ - 44 - ServiceComponentBase initialized.
2025-05-28 17:05:14,784 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - __init__ - 120 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 92550
2025-05-28 17:05:14,784 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 42 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-28 17:05:14,784 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - setup - 494 - AgentRunner setup started.
2025-05-28 17:05:14,784 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - setup - 84 - ServiceComponent setup started.
2025-05-28 17:05:14,789 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - setup - 95 - ServiceComponent setup completed.
2025-05-28 17:05:14,789 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - fetch_config - 27 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-28 17:05:14,886 - INFO - httpx - _client - _send_single_request - 1740 - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-28 17:05:14,886 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - fetch_config - 33 - Configuration fetched successfully.
2025-05-28 17:05:14,886 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _load_config - 138 - Agent configuration loaded and prepared successfully.
2025-05-28 17:05:14,886 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _setup_app - 149 - Creating LangGraph application...
2025-05-28 17:05:14,886 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_agent_app - 913 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-28 17:05:14,886 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_llm_instance - 80 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-28 17:05:14,919 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _configure_main_llm - 63 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-28 17:05:14,919 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 818 - Creating agent graph in GraphFactory...
2025-05-28 17:05:14,919 - INFO - app.agent_runner.common.tools_registry - tools_registry - configure_tools_centralized - 364 - Configured 3 predefined tools from centralized registry
2025-05-28 17:05:14,919 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 94 - Added 3 tools from centralized registry
2025-05-28 17:05:14,919 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 114 - Configuring 1 Knowledge Base tool(s)...
2025-05-28 17:05:14,975 - INFO - httpx - _client - _send_single_request - 1025 - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-28 17:05:14,985 - INFO - httpx - _client - _send_single_request - 1025 - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-28 17:05:15,806 - INFO - httpx - _client - _send_single_request - 1025 - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-28 17:05:15,808 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 132 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-28 17:05:15,808 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 166 - Must conditions for KB tool 'knowledgeBase-1745316404538': [FieldCondition(key='metadata.client_id', match=MatchValue(value='2'), range=None, geo_bounding_box=None, geo_radius=None, geo_polygon=None, values_count=None), FieldCondition(key='metadata.datasource_id', match=MatchAny(any=['5', '6', '7']), range=None, geo_bounding_box=None, geo_radius=None, geo_polygon=None, values_count=None)]
2025-05-28 17:05:15,809 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 182 - Configured Knowledge Base tool 'База знаний' (ID: knowledgeBase-1745316404538) for datasources: ['5', '6', '7']
2025-05-28 17:05:15,809 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 190 - Using max_rewrites: 4
2025-05-28 17:05:15,809 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 217 - Configured Web Search tool 'Поиск в Интернете' (ID: webSearch-1746879979658)
2025-05-28 17:05:15,809 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 244 - Total tools configured: 5 (4 safe, 1 datastore).
2025-05-28 17:05:15,809 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _configure_tools - 153 - Tools configured: 5 total, 4 safe, 1 datastore tools. Max rewrites: 4.
2025-05-28 17:05:15,809 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 826 - Context memory enabled: True
2025-05-28 17:05:15,809 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 834 - Added node: agent
2025-05-28 17:05:15,809 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 843 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-28 17:05:15,810 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 853 - Added node: safe_tools
2025-05-28 17:05:15,810 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 864 - Added edge: safe_tools -> agent
2025-05-28 17:05:15,810 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 870 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-28 17:05:15,810 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 877 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-28 17:05:15,810 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 893 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-28 17:05:15,820 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 905 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-28 17:05:15,820 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_agent_app - 922 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-28 17:05:15,820 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _setup_app - 157 - LangGraph application created successfully.
2025-05-28 17:05:15,820 - INFO - AGENT:agent_airsoft_0faa9616 - runnable_component - run - 111 - Component AgentRunner (instance: 4679402944) setup complete. Starting run loop.
2025-05-28 17:05:15,820 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - run_loop - 522 - AgentRunner run_loop starting...
2025-05-28 17:05:15,820 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - _register_main_task - 62 - Registered main task: AgentPubSubListener
2025-05-28 17:05:15,820 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - run_loop - 122 - Starting run_loop with 1 registered main tasks.
2025-05-28 17:05:15,820 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 236 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-28 17:05:15,823 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 254 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-28 17:05:23,388 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 96 - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-28 17:05:23,392 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 98 - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-28 17:05:23,392 - INFO - InactivityMonitorWorker - runnable_component - run - 111 - Component InactivityMonitorWorker (instance: 4456151904) setup complete. Starting run loop.
2025-05-28 17:05:23,392 - INFO - InactivityMonitorWorker - base_worker - run_loop - 258 - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-28 17:05:48,796 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _handle_text_message - 287 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'сколько нужно программистов для перехода на ут11?...'
2025-05-28 17:05:48,799 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _check_user_authorization - 124 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-28 17:05:48,884 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _publish_to_agent - 101 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-28 17:05:48,884 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _handle_text_message - 313 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-28 17:05:48,884 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _handle_pubsub_message - 202 - Processing message for chat_id: 144641834
2025-05-28 17:05:48,885 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _save_history - 481 - Queued user message for history (Thread: 144641834, InteractionID: c4470821-3b16-4cd8-a1e5-aa13826ee859)
2025-05-28 17:05:48,885 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _get_history - 417 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-28 17:05:48,886 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _get_history - 423 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-28 17:05:48,925 - INFO - HistorySaverWorker - history_saver_worker - process_message - 123 - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: c4470821-3b16-4cd8-a1e5-aa13826ee859, db_id: 892
2025-05-28 17:05:48,936 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _get_history - 433 - Loaded 20 messages from DB for thread '144641834'.
2025-05-28 17:05:48,936 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _get_history - 436 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-28 17:05:48,937 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _invoke_agent - 366 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-28 17:05:48,987 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 255 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-28 17:05:48,987 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_llm_instance - 80 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-28 17:05:49,013 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_node_llm - 713 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-28 17:05:49,018 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _bind_tools_to_model - 804 - Model bound to 5 tools.
2025-05-28 17:05:49,884 - INFO - aiogram.event - dispatcher - feed_update - 172 - Update id=804756293 is handled. Duration 1089 ms by bot id=1750613938
2025-05-28 17:05:50,226 - INFO - httpx - _client - _send_single_request - 1740 - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-28 17:05:50,805 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 285 - Agent node response content preview: N/A
2025-05-28 17:05:50,805 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 287 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-28 17:05:50,805 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 289 - Agent node usage_metadata: {'input_tokens': 1629, 'output_tokens': 36, 'total_tokens': 1665, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-28 17:05:50,805 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _extract_token_data - 218 - Token usage from usage_metadata: P:1629 C:36 T:1665
2025-05-28 17:05:50,805 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _get_tokens - 250 - Token usage for agent_llm: 1665 tokens recorded.
2025-05-28 17:05:50,806 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _route_tools_edge - 605 - ---ROUTE TOOLS---
2025-05-28 17:05:50,806 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _route_tools_edge - 635 - Tool call detected: knowledgeBase-1745316404538
2025-05-28 17:05:50,806 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _route_tools_edge - 638 - ---DECISION: ROUTE TO RETRIEVE (knowledgeBase-1745316404538)---
2025-05-28 17:05:51,395 - INFO - httpx - _client - _send_single_request - 1025 - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-28 17:05:51,417 - INFO - httpx - _client - _send_single_request - 1025 - HTTP Request: POST http://127.0.0.1:6333/collections/platformai/points/query "HTTP/1.1 200 OK"
2025-05-28 17:05:51,421 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _grade_docs_node - 360 - ---CHECK RELEVANCE (Agent ID: agent_airsoft_0faa9616)---
2025-05-28 17:05:51,421 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _grade_docs_node - 371 - Grading documents for question: 'сколько нужно программистов для перехода на ут11?'
2025-05-28 17:05:51,421 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_llm_instance - 80 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.0, streaming: False
2025-05-28 17:05:51,446 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_node_llm - 713 - Created grading LLM: gpt-4.1-mini via OpenAI
2025-05-28 17:05:51,447 - INFO - AGENT:agent_airsoft_0faa9616 - factory - process_doc - 413 - Grading document content (first 300 chars): 
---RETRIEVER_DOC---

---RETRIEVER_DOC---

---RETRIEVER_DOC---

2025-05-28 17:05:51,447 - INFO - AGENT:agent_airsoft_0faa9616 - factory - process_doc - 414 - Question for grading: сколько нужно программистов для перехода на ут11?
2025-05-28 17:05:52,443 - INFO - httpx - _client - _send_single_request - 1740 - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-28 17:05:52,456 - INFO - AGENT:agent_airsoft_0faa9616 - factory - process_doc - 424 - Grading result: no for document starting with: 
---RETRIEVER_DOC---

---RETRIEVER_DOC---

---RETRIEVER_DOC---
...
2025-05-28 17:05:52,456 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _extract_token_data - 218 - Token usage from usage_metadata: P:191 C:6 T:197
2025-05-28 17:05:52,456 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _get_tokens - 250 - Token usage for grading_llm: 197 tokens recorded.
2025-05-28 17:05:52,456 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _grade_docs_node - 461 - Total token usage for grading_llm batch: 197 tokens.
2025-05-28 17:05:52,456 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _grade_docs_node - 466 - Found 0 relevant documents out of 1 initial (after split).
2025-05-28 17:05:52,457 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _decide_to_generate_edge - 585 - ---ASSESS GRADED DOCUMENTS---
2025-05-28 17:05:52,457 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _decide_to_generate_edge - 594 - ---DECISION: NO RELEVANT DOCUMENTS, REWRITE---
2025-05-28 17:05:52,458 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _rewrite_node - 471 - ---TRANSFORM QUERY (Agent ID: agent_airsoft_0faa9616)---
2025-05-28 17:05:52,458 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _rewrite_node - 482 - Rewrite attempt 1/4 for question: 'сколько нужно программистов для перехода на ут11?'
2025-05-28 17:05:52,458 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _rewrite_node - 485 - Rewriting original question: сколько нужно программистов для перехода на ут11?
2025-05-28 17:05:52,458 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_llm_instance - 80 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: False
2025-05-28 17:05:52,483 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_node_llm - 713 - Created rewrite LLM: gpt-4.1-mini via OpenAI
2025-05-28 17:05:54,241 - INFO - httpx - _client - _send_single_request - 1740 - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-28 17:05:54,245 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _rewrite_node - 503 - Rewritten question: Сколько программистов требуется для миграции и адаптации системы на 1С:Управление торговлей 11 с учетом объема данных, количества кастомных доработок и сроков реализации проекта?
2025-05-28 17:05:54,245 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _extract_token_data - 218 - Token usage from usage_metadata: P:2538 C:46 T:2584
2025-05-28 17:05:54,245 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _get_tokens - 250 - Token usage for rewrite_llm: 2584 tokens recorded.
2025-05-28 17:05:54,246 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 255 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-28 17:05:54,246 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_llm_instance - 80 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-28 17:05:54,271 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_node_llm - 713 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-28 17:05:54,274 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _bind_tools_to_model - 804 - Model bound to 5 tools.
2025-05-28 17:05:55,201 - INFO - httpx - _client - _send_single_request - 1740 - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-28 17:05:56,890 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 285 - Agent node response content preview: Конечно! Вот переформулированный запрос:

**"Сколько программистов требуется для миграции и адаптаци
2025-05-28 17:05:56,890 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 287 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_71b9d4b387'}
2025-05-28 17:05:56,890 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 289 - Agent node usage_metadata: {'input_tokens': 1760, 'output_tokens': 85, 'total_tokens': 1845, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-28 17:05:56,890 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _extract_token_data - 218 - Token usage from usage_metadata: P:1760 C:85 T:1845
2025-05-28 17:05:56,890 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _get_tokens - 250 - Token usage for agent_llm: 1845 tokens recorded.
2025-05-28 17:05:56,891 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _route_tools_edge - 605 - ---ROUTE TOOLS---
2025-05-28 17:05:56,891 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _route_tools_edge - 613 - ---DECISION: NO TOOLS CALLED, END---
2025-05-28 17:05:56,892 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _invoke_agent - 384 - Graph execution finished. Final response: Конечно! Вот переформулированный запрос:

**"Сколько программистов требуется для миграции и адаптаци...
2025-05-28 17:05:56,894 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _save_history - 481 - Queued agent message for history (Thread: 144641834, InteractionID: c4470821-3b16-4cd8-a1e5-aa13826ee859)
2025-05-28 17:05:56,894 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _save_tokens - 315 - Found 4 token usage events for InteractionID: c4470821-3b16-4cd8-a1e5-aa13826ee859.
2025-05-28 17:05:56,898 - INFO - TokenUsageWorker - token_usage_worker - process_message - 117 - [token_usage_worker] RAW token usage data: {'interaction_id': 'c4470821-3b16-4cd8-a1e5-aa13826ee859', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1629, 'completion_tokens': 36, 'total_tokens': 1665, 'timestamp': '2025-05-28T12:05:50.805681+00:00'}
2025-05-28 17:05:56,898 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _handle_pubsub_message - 385 - Received response from agent for chat 144641834: Конечно! Вот переформулированный запрос:

**"Сколько программистов требуется для миграции и адаптаци...
2025-05-28 17:05:56,898 - INFO - TokenUsageWorker - token_usage_worker - process_message - 129 - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: c4470821-3b16-4cd8-a1e5-aa13826ee859
2025-05-28 17:05:56,898 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _handle_pubsub_message - 414 - Sending message from agent to chat 144641834: 'Конечно! Вот переформулированный запрос:

**"Сколь...'
2025-05-28 17:05:56,903 - INFO - HistorySaverWorker - history_saver_worker - process_message - 123 - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: c4470821-3b16-4cd8-a1e5-aa13826ee859, db_id: 893
2025-05-28 17:05:56,938 - INFO - TokenUsageWorker - token_usage_worker - process_message - 148 - [token_usage_worker] Found message_id: 893 for interaction_id: c4470821-3b16-4cd8-a1e5-aa13826ee859 on attempt 1
2025-05-28 17:05:56,943 - INFO - TokenUsageWorker - token_usage_worker - _save_token_usage_to_db - 92 - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: c4470821-3b16-4cd8-a1e5-aa13826ee859, db_id: 357
2025-05-28 17:05:56,945 - INFO - TokenUsageWorker - token_usage_worker - process_message - 117 - [token_usage_worker] RAW token usage data: {'interaction_id': 'c4470821-3b16-4cd8-a1e5-aa13826ee859', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1760, 'completion_tokens': 85, 'total_tokens': 1845, 'timestamp': '2025-05-28T12:05:56.890708+00:00'}
2025-05-28 17:05:56,945 - INFO - TokenUsageWorker - token_usage_worker - process_message - 129 - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: c4470821-3b16-4cd8-a1e5-aa13826ee859
2025-05-28 17:05:56,947 - INFO - TokenUsageWorker - token_usage_worker - process_message - 148 - [token_usage_worker] Found message_id: 893 for interaction_id: c4470821-3b16-4cd8-a1e5-aa13826ee859 on attempt 1
2025-05-28 17:05:56,950 - INFO - TokenUsageWorker - token_usage_worker - _save_token_usage_to_db - 92 - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: c4470821-3b16-4cd8-a1e5-aa13826ee859, db_id: 358
2025-05-28 17:05:56,952 - INFO - TokenUsageWorker - token_usage_worker - process_message - 117 - [token_usage_worker] RAW token usage data: {'interaction_id': 'c4470821-3b16-4cd8-a1e5-aa13826ee859', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'rewrite_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 2538, 'completion_tokens': 46, 'total_tokens': 2584, 'timestamp': '2025-05-28T12:05:54.245404+00:00'}
2025-05-28 17:05:56,952 - INFO - TokenUsageWorker - token_usage_worker - process_message - 129 - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: c4470821-3b16-4cd8-a1e5-aa13826ee859
2025-05-28 17:05:56,953 - INFO - TokenUsageWorker - token_usage_worker - process_message - 148 - [token_usage_worker] Found message_id: 893 for interaction_id: c4470821-3b16-4cd8-a1e5-aa13826ee859 on attempt 1
2025-05-28 17:05:56,955 - INFO - TokenUsageWorker - token_usage_worker - _save_token_usage_to_db - 92 - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: c4470821-3b16-4cd8-a1e5-aa13826ee859, db_id: 359
2025-05-28 17:05:56,958 - INFO - TokenUsageWorker - token_usage_worker - process_message - 117 - [token_usage_worker] RAW token usage data: {'interaction_id': 'c4470821-3b16-4cd8-a1e5-aa13826ee859', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'grading_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 191, 'completion_tokens': 6, 'total_tokens': 197, 'timestamp': '2025-05-28T12:05:52.456390+00:00'}
2025-05-28 17:05:56,958 - INFO - TokenUsageWorker - token_usage_worker - process_message - 129 - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: c4470821-3b16-4cd8-a1e5-aa13826ee859
2025-05-28 17:05:56,958 - INFO - TokenUsageWorker - token_usage_worker - process_message - 148 - [token_usage_worker] Found message_id: 893 for interaction_id: c4470821-3b16-4cd8-a1e5-aa13826ee859 on attempt 1
2025-05-28 17:05:56,961 - INFO - TokenUsageWorker - token_usage_worker - _save_token_usage_to_db - 92 - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: c4470821-3b16-4cd8-a1e5-aa13826ee859, db_id: 360
2025-05-28 17:08:33,841 - INFO - app.api.routers.sse_api - sse_api - send_message_to_agent - 156 - Message published to agent:agent_airsoft_0faa9616:input for agent agent_airsoft_0faa9616, thread debug_test_thread_001
2025-05-28 17:08:33,841 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _handle_pubsub_message - 202 - Processing message for chat_id: debug_test_thread_001
2025-05-28 17:08:33,842 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _save_history - 481 - Queued user message for history (Thread: debug_test_thread_001, InteractionID: ac39eabd-2812-40ee-8978-4dec0a341a08)
2025-05-28 17:08:33,843 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _get_history - 417 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-28 17:08:33,843 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _get_history - 423 - Thread 'debug_test_thread_001' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-28 17:08:33,853 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _get_history - 433 - Loaded 1 messages from DB for thread 'debug_test_thread_001'.
2025-05-28 17:08:33,853 - INFO - HistorySaverWorker - history_saver_worker - process_message - 123 - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: ac39eabd-2812-40ee-8978-4dec0a341a08, db_id: 894
2025-05-28 17:08:33,854 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _get_history - 436 - Added thread 'debug_test_thread_001' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-28 17:08:33,854 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _invoke_agent - 366 - Invoking graph for thread_id: debug_test_thread_001 (Initial history messages: 1)
2025-05-28 17:08:33,862 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 255 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-28 17:08:33,863 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_llm_instance - 80 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-28 17:08:33,893 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_node_llm - 713 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-28 17:08:33,897 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _bind_tools_to_model - 804 - Model bound to 5 tools.
2025-05-28 17:08:35,072 - INFO - httpx - _client - _send_single_request - 1740 - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-28 17:08:39,165 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 285 - Agent node response content preview: Для миграции на Управление Торговлей 11 (УТ11) обычно используется специальный инструмент миграции, 
2025-05-28 17:08:39,165 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 287 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-28 17:08:39,165 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 289 - Agent node usage_metadata: {'input_tokens': 383, 'output_tokens': 252, 'total_tokens': 635, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-28 17:08:39,165 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _extract_token_data - 218 - Token usage from usage_metadata: P:383 C:252 T:635
2025-05-28 17:08:39,165 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _get_tokens - 250 - Token usage for agent_llm: 635 tokens recorded.
2025-05-28 17:08:39,166 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _route_tools_edge - 605 - ---ROUTE TOOLS---
2025-05-28 17:08:39,166 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _route_tools_edge - 613 - ---DECISION: NO TOOLS CALLED, END---
2025-05-28 17:08:39,167 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _invoke_agent - 384 - Graph execution finished. Final response: Для миграции на Управление Торговлей 11 (УТ11) обычно используется специальный инструмент миграции, ...
2025-05-28 17:08:39,168 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _save_history - 481 - Queued agent message for history (Thread: debug_test_thread_001, InteractionID: ac39eabd-2812-40ee-8978-4dec0a341a08)
2025-05-28 17:08:39,169 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _save_tokens - 315 - Found 1 token usage events for InteractionID: ac39eabd-2812-40ee-8978-4dec0a341a08.
2025-05-28 17:08:39,173 - INFO - TokenUsageWorker - token_usage_worker - process_message - 117 - [token_usage_worker] RAW token usage data: {'interaction_id': 'ac39eabd-2812-40ee-8978-4dec0a341a08', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': 'debug_test_thread_001', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 383, 'completion_tokens': 252, 'total_tokens': 635, 'timestamp': '2025-05-28T12:08:39.165286+00:00'}
2025-05-28 17:08:39,173 - INFO - TokenUsageWorker - token_usage_worker - process_message - 129 - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: ac39eabd-2812-40ee-8978-4dec0a341a08
2025-05-28 17:08:39,176 - INFO - HistorySaverWorker - history_saver_worker - process_message - 123 - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: ac39eabd-2812-40ee-8978-4dec0a341a08, db_id: 895
2025-05-28 17:08:39,177 - INFO - TokenUsageWorker - token_usage_worker - process_message - 148 - [token_usage_worker] Found message_id: 895 for interaction_id: ac39eabd-2812-40ee-8978-4dec0a341a08 on attempt 1
2025-05-28 17:08:39,183 - INFO - TokenUsageWorker - token_usage_worker - _save_token_usage_to_db - 92 - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: ac39eabd-2812-40ee-8978-4dec0a341a08, db_id: 361
2025-05-28 17:10:23,574 - INFO - InactivityMonitorWorker - base_worker - run_loop - 275 - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 17:10:23,584 - INFO - InactivityMonitorWorker - base_worker - run_loop - 281 - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 17:13:13,429 - INFO - app.core.lifespan - lifespan - lifespan - 287 - Application shutdown sequence initiated.
2025-05-28 17:13:13,430 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 230 - Stopping 3 background tasks...
2025-05-28 17:13:13,430 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task HistorySaverWorker...
2025-05-28 17:13:13,432 - INFO - HistorySaverWorker - runnable_component - run - 116 - Run_loop for HistorySaverWorker (instance: 4455495056) was cancelled.
2025-05-28 17:13:13,432 - INFO - HistorySaverWorker - runnable_component - run - 123 - Component HistorySaverWorker (instance: 4455495056) stopping. Performing cleanup...
2025-05-28 17:13:13,432 - INFO - HistorySaverWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:13:13,437 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for history_saver_worker as part of cleanup.
2025-05-28 17:13:13,438 - INFO - HistorySaverWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-28 17:13:13,438 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:13:13,438 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-28 17:13:13,438 - INFO - HistorySaverWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:13:13,438 - INFO - HistorySaverWorker - runnable_component - run - 128 - Component HistorySaverWorker (instance: 4455495056) cleanup complete.
2025-05-28 17:13:13,438 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task HistorySaverWorker finished after cancellation signal.
2025-05-28 17:13:13,438 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task TokenUsageWorker...
2025-05-28 17:13:13,438 - INFO - TokenUsageWorker - runnable_component - run - 116 - Run_loop for TokenUsageWorker (instance: 4456151760) was cancelled.
2025-05-28 17:13:13,438 - INFO - TokenUsageWorker - runnable_component - run - 123 - Component TokenUsageWorker (instance: 4456151760) stopping. Performing cleanup...
2025-05-28 17:13:13,438 - INFO - TokenUsageWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:13:13,443 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for token_usage_worker as part of cleanup.
2025-05-28 17:13:13,444 - INFO - TokenUsageWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-28 17:13:13,444 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:13:13,444 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-28 17:13:13,444 - INFO - TokenUsageWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:13:13,444 - INFO - TokenUsageWorker - runnable_component - run - 128 - Component TokenUsageWorker (instance: 4456151760) cleanup complete.
2025-05-28 17:13:13,444 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task TokenUsageWorker finished after cancellation signal.
2025-05-28 17:13:13,444 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task InactivityMonitorWorker...
2025-05-28 17:13:13,445 - INFO - InactivityMonitorWorker - runnable_component - run - 116 - Run_loop for InactivityMonitorWorker (instance: 4456151904) was cancelled.
2025-05-28 17:13:13,445 - INFO - InactivityMonitorWorker - runnable_component - run - 123 - Component InactivityMonitorWorker (instance: 4456151904) stopping. Performing cleanup...
2025-05-28 17:13:13,445 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 437 - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-28 17:13:13,445 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:13:13,445 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:13:13,445 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 441 - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-28 17:13:13,445 - INFO - InactivityMonitorWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:13:13,447 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-28 17:13:13,448 - INFO - InactivityMonitorWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-28 17:13:13,448 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:13:13,448 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-28 17:13:13,449 - INFO - InactivityMonitorWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:13:13,449 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 445 - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-28 17:13:13,449 - INFO - InactivityMonitorWorker - runnable_component - run - 128 - Component InactivityMonitorWorker (instance: 4456151904) cleanup complete.
2025-05-28 17:13:13,449 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-28 17:13:13,449 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 249 - All background tasks signaled to stop.
2025-05-28 17:13:13,449 - INFO - app.services.redis_service - redis_service - close_redis_pool - 43 - Redis connection pool closed successfully.
2025-05-28 17:13:13,468 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 17:13:13,469 - INFO - app.core.lifespan - lifespan - lifespan - 293 - Application shutdown sequence completed.
2025-05-28 17:13:14,006 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 17:13:14,007 - INFO - app.core.lifespan - lifespan - lifespan - 277 - Application startup sequence initiated.
2025-05-28 17:13:14,012 - INFO - app.services.redis_service - redis_service - init_redis_pool - 24 - Redis connection pool initialized successfully.
2025-05-28 17:13:14,012 - INFO - app.core.lifespan - lifespan - start_background_tasks - 172 - Starting background tasks...
2025-05-28 17:13:14,012 - INFO - app.core.lifespan - lifespan - start_background_tasks - 182 - History saver worker started, listening to queue: chat_history_queue
2025-05-28 17:13:14,012 - INFO - TokenUsageWorker - token_usage_worker - __init__ - 45 - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-28 17:13:14,012 - INFO - app.core.lifespan - lifespan - start_background_tasks - 194 - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-28 17:13:14,012 - INFO - app.core.lifespan - lifespan - start_background_tasks - 206 - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-28 17:13:14,012 - INFO - app.core.lifespan - lifespan - start_background_tasks - 210 - 3 background tasks initiated.
2025-05-28 17:13:14,012 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 51 - Attempting to start existing agents and their integrations...
2025-05-28 17:13:14,012 - INFO - HistorySaverWorker - base_worker - setup - 48 - [history_saver_worker] Worker setup started.
2025-05-28 17:13:14,013 - INFO - TokenUsageWorker - base_worker - setup - 48 - [token_usage_worker] Worker setup started.
2025-05-28 17:13:14,013 - INFO - InactivityMonitorWorker - base_worker - setup - 48 - [inactivity_monitor_worker] Worker setup started.
2025-05-28 17:13:14,015 - INFO - TokenUsageWorker - base_worker - setup - 52 - [token_usage_worker] Worker setup completed.
2025-05-28 17:13:14,015 - INFO - TokenUsageWorker - base_worker - setup - 114 - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-28 17:13:14,015 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 61 - ProcessManager setup complete for startup.
2025-05-28 17:13:14,016 - INFO - InactivityMonitorWorker - base_worker - setup - 52 - [inactivity_monitor_worker] Worker setup completed.
2025-05-28 17:13:14,016 - INFO - InactivityMonitorWorker - base_worker - setup - 243 - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-28 17:13:14,016 - INFO - HistorySaverWorker - base_worker - setup - 52 - [history_saver_worker] Worker setup completed.
2025-05-28 17:13:14,016 - INFO - HistorySaverWorker - base_worker - setup - 114 - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-28 17:13:14,017 - INFO - TokenUsageWorker - token_usage_worker - setup - 57 - [token_usage_worker] Database session factory initialized.
2025-05-28 17:13:14,018 - INFO - HistorySaverWorker - history_saver_worker - setup - 49 - [history_saver_worker] Database session factory initialized.
2025-05-28 17:13:14,018 - INFO - HistorySaverWorker - runnable_component - run - 111 - Component HistorySaverWorker (instance: 4415219296) setup complete. Starting run loop.
2025-05-28 17:13:14,018 - INFO - HistorySaverWorker - base_worker - run_loop - 131 - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-28 17:13:14,018 - INFO - TokenUsageWorker - token_usage_worker - setup - 64 - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-28 17:13:14,018 - INFO - TokenUsageWorker - runnable_component - run - 111 - Component TokenUsageWorker (instance: 4416305536) setup complete. Starting run loop.
2025-05-28 17:13:14,018 - INFO - TokenUsageWorker - base_worker - run_loop - 131 - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-28 17:13:14,020 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 86 - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-28 17:13:14,020 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 94 - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-28 17:13:14,065 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 66 - Found 1 agents to potentially start.
2025-05-28 17:13:14,066 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 69 - Attempting to start agent: agent_airsoft_0faa9616
2025-05-28 17:13:14,066 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 73 - Agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:13:14,067 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 93 - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-28 17:13:14,067 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 109 - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-28 17:13:14,067 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 115 - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:13:14,068 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:13:14,068 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:13:14,068 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 153 - ProcessManager cleanup complete for startup function.
2025-05-28 17:13:14,068 - INFO - app.core.lifespan - lifespan - lifespan - 284 - Application startup sequence completed.
2025-05-28 17:13:24,021 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 96 - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-28 17:13:24,026 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 98 - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-28 17:13:24,026 - INFO - InactivityMonitorWorker - runnable_component - run - 111 - Component InactivityMonitorWorker (instance: 4416306496) setup complete. Starting run loop.
2025-05-28 17:13:24,026 - INFO - InactivityMonitorWorker - base_worker - run_loop - 258 - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-28 17:18:24,208 - INFO - InactivityMonitorWorker - base_worker - run_loop - 275 - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 17:18:24,218 - INFO - InactivityMonitorWorker - base_worker - run_loop - 281 - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 17:21:36,854 - INFO - app.core.lifespan - lifespan - lifespan - 287 - Application shutdown sequence initiated.
2025-05-28 17:21:36,855 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 230 - Stopping 3 background tasks...
2025-05-28 17:21:36,855 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task HistorySaverWorker...
2025-05-28 17:21:36,855 - INFO - HistorySaverWorker - runnable_component - run - 116 - Run_loop for HistorySaverWorker (instance: 4415219296) was cancelled.
2025-05-28 17:21:36,855 - INFO - HistorySaverWorker - runnable_component - run - 123 - Component HistorySaverWorker (instance: 4415219296) stopping. Performing cleanup...
2025-05-28 17:21:36,855 - INFO - HistorySaverWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:21:36,860 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for history_saver_worker as part of cleanup.
2025-05-28 17:21:36,861 - INFO - HistorySaverWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-28 17:21:36,861 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:21:36,862 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-28 17:21:36,862 - INFO - HistorySaverWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:21:36,862 - INFO - HistorySaverWorker - runnable_component - run - 128 - Component HistorySaverWorker (instance: 4415219296) cleanup complete.
2025-05-28 17:21:36,862 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task HistorySaverWorker finished after cancellation signal.
2025-05-28 17:21:36,862 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task TokenUsageWorker...
2025-05-28 17:21:36,862 - INFO - TokenUsageWorker - runnable_component - run - 116 - Run_loop for TokenUsageWorker (instance: 4416305536) was cancelled.
2025-05-28 17:21:36,862 - INFO - TokenUsageWorker - runnable_component - run - 123 - Component TokenUsageWorker (instance: 4416305536) stopping. Performing cleanup...
2025-05-28 17:21:36,862 - INFO - TokenUsageWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:21:36,866 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for token_usage_worker as part of cleanup.
2025-05-28 17:21:36,867 - INFO - TokenUsageWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-28 17:21:36,867 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:21:36,867 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-28 17:21:36,867 - INFO - TokenUsageWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:21:36,867 - INFO - TokenUsageWorker - runnable_component - run - 128 - Component TokenUsageWorker (instance: 4416305536) cleanup complete.
2025-05-28 17:21:36,867 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task TokenUsageWorker finished after cancellation signal.
2025-05-28 17:21:36,867 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task InactivityMonitorWorker...
2025-05-28 17:21:36,867 - INFO - InactivityMonitorWorker - runnable_component - run - 116 - Run_loop for InactivityMonitorWorker (instance: 4416306496) was cancelled.
2025-05-28 17:21:36,867 - INFO - InactivityMonitorWorker - runnable_component - run - 123 - Component InactivityMonitorWorker (instance: 4416306496) stopping. Performing cleanup...
2025-05-28 17:21:36,867 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 437 - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-28 17:21:36,867 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:21:36,868 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:21:36,868 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 441 - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-28 17:21:36,868 - INFO - InactivityMonitorWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:21:36,869 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-28 17:21:36,870 - INFO - InactivityMonitorWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-28 17:21:36,870 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:21:36,871 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-28 17:21:36,871 - INFO - InactivityMonitorWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:21:36,871 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 445 - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-28 17:21:36,871 - INFO - InactivityMonitorWorker - runnable_component - run - 128 - Component InactivityMonitorWorker (instance: 4416306496) cleanup complete.
2025-05-28 17:21:36,871 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-28 17:21:36,871 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 249 - All background tasks signaled to stop.
2025-05-28 17:21:36,871 - INFO - app.services.redis_service - redis_service - close_redis_pool - 43 - Redis connection pool closed successfully.
2025-05-28 17:21:36,877 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 17:21:36,877 - INFO - app.core.lifespan - lifespan - lifespan - 293 - Application shutdown sequence completed.
2025-05-28 17:21:37,514 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 17:21:37,514 - INFO - app.core.lifespan - lifespan - lifespan - 277 - Application startup sequence initiated.
2025-05-28 17:21:37,521 - INFO - app.services.redis_service - redis_service - init_redis_pool - 24 - Redis connection pool initialized successfully.
2025-05-28 17:21:37,521 - INFO - app.core.lifespan - lifespan - start_background_tasks - 172 - Starting background tasks...
2025-05-28 17:21:37,521 - INFO - app.core.lifespan - lifespan - start_background_tasks - 182 - History saver worker started, listening to queue: chat_history_queue
2025-05-28 17:21:37,521 - INFO - TokenUsageWorker - token_usage_worker - __init__ - 45 - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-28 17:21:37,521 - INFO - app.core.lifespan - lifespan - start_background_tasks - 194 - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-28 17:21:37,521 - INFO - app.core.lifespan - lifespan - start_background_tasks - 206 - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-28 17:21:37,521 - INFO - app.core.lifespan - lifespan - start_background_tasks - 210 - 3 background tasks initiated.
2025-05-28 17:21:37,521 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 51 - Attempting to start existing agents and their integrations...
2025-05-28 17:21:37,522 - INFO - HistorySaverWorker - base_worker - setup - 48 - [history_saver_worker] Worker setup started.
2025-05-28 17:21:37,522 - INFO - TokenUsageWorker - base_worker - setup - 48 - [token_usage_worker] Worker setup started.
2025-05-28 17:21:37,522 - INFO - InactivityMonitorWorker - base_worker - setup - 48 - [inactivity_monitor_worker] Worker setup started.
2025-05-28 17:21:37,527 - INFO - InactivityMonitorWorker - base_worker - setup - 52 - [inactivity_monitor_worker] Worker setup completed.
2025-05-28 17:21:37,527 - INFO - InactivityMonitorWorker - base_worker - setup - 243 - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-28 17:21:37,527 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 61 - ProcessManager setup complete for startup.
2025-05-28 17:21:37,528 - INFO - HistorySaverWorker - base_worker - setup - 52 - [history_saver_worker] Worker setup completed.
2025-05-28 17:21:37,528 - INFO - HistorySaverWorker - base_worker - setup - 114 - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-28 17:21:37,529 - INFO - TokenUsageWorker - base_worker - setup - 52 - [token_usage_worker] Worker setup completed.
2025-05-28 17:21:37,529 - INFO - TokenUsageWorker - base_worker - setup - 114 - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-28 17:21:37,531 - INFO - TokenUsageWorker - token_usage_worker - setup - 57 - [token_usage_worker] Database session factory initialized.
2025-05-28 17:21:37,532 - INFO - HistorySaverWorker - history_saver_worker - setup - 49 - [history_saver_worker] Database session factory initialized.
2025-05-28 17:21:37,533 - INFO - HistorySaverWorker - runnable_component - run - 111 - Component HistorySaverWorker (instance: 4619973552) setup complete. Starting run loop.
2025-05-28 17:21:37,534 - INFO - HistorySaverWorker - base_worker - run_loop - 131 - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-28 17:21:37,534 - INFO - TokenUsageWorker - token_usage_worker - setup - 64 - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-28 17:21:37,534 - INFO - TokenUsageWorker - runnable_component - run - 111 - Component TokenUsageWorker (instance: 4629924656) setup complete. Starting run loop.
2025-05-28 17:21:37,534 - INFO - TokenUsageWorker - base_worker - run_loop - 131 - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-28 17:21:37,535 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 86 - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-28 17:21:37,535 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 94 - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-28 17:21:37,594 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 66 - Found 1 agents to potentially start.
2025-05-28 17:21:37,594 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 69 - Attempting to start agent: agent_airsoft_0faa9616
2025-05-28 17:21:37,595 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 73 - Agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:21:37,595 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 93 - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-28 17:21:37,595 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 109 - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-28 17:21:37,596 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 115 - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:21:37,597 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:21:37,597 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:21:37,597 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 153 - ProcessManager cleanup complete for startup function.
2025-05-28 17:21:37,597 - INFO - app.core.lifespan - lifespan - lifespan - 284 - Application startup sequence completed.
2025-05-28 17:21:47,535 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 96 - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-28 17:21:47,540 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 98 - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-28 17:21:47,540 - INFO - InactivityMonitorWorker - runnable_component - run - 111 - Component InactivityMonitorWorker (instance: 4629735056) setup complete. Starting run loop.
2025-05-28 17:21:47,541 - INFO - InactivityMonitorWorker - base_worker - run_loop - 258 - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-28 17:26:47,780 - INFO - InactivityMonitorWorker - base_worker - run_loop - 275 - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 17:26:47,793 - INFO - InactivityMonitorWorker - base_worker - run_loop - 281 - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 17:31:48,010 - INFO - InactivityMonitorWorker - base_worker - run_loop - 275 - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 17:31:48,019 - INFO - InactivityMonitorWorker - base_worker - run_loop - 281 - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 17:36:48,391 - INFO - InactivityMonitorWorker - base_worker - run_loop - 275 - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 17:36:48,402 - INFO - InactivityMonitorWorker - base_worker - run_loop - 281 - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 17:40:18,826 - INFO - app.core.lifespan - lifespan - lifespan - 287 - Application shutdown sequence initiated.
2025-05-28 17:40:18,827 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 230 - Stopping 3 background tasks...
2025-05-28 17:40:18,827 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task HistorySaverWorker...
2025-05-28 17:40:18,827 - INFO - HistorySaverWorker - runnable_component - run - 116 - Run_loop for HistorySaverWorker (instance: 4619973552) was cancelled.
2025-05-28 17:40:18,827 - INFO - HistorySaverWorker - runnable_component - run - 123 - Component HistorySaverWorker (instance: 4619973552) stopping. Performing cleanup...
2025-05-28 17:40:18,827 - INFO - HistorySaverWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:40:18,832 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for history_saver_worker as part of cleanup.
2025-05-28 17:40:18,833 - INFO - HistorySaverWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-28 17:40:18,833 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:40:18,833 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-28 17:40:18,833 - INFO - HistorySaverWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:40:18,834 - INFO - HistorySaverWorker - runnable_component - run - 128 - Component HistorySaverWorker (instance: 4619973552) cleanup complete.
2025-05-28 17:40:18,834 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task HistorySaverWorker finished after cancellation signal.
2025-05-28 17:40:18,834 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task TokenUsageWorker...
2025-05-28 17:40:18,834 - INFO - TokenUsageWorker - runnable_component - run - 116 - Run_loop for TokenUsageWorker (instance: 4629924656) was cancelled.
2025-05-28 17:40:18,834 - INFO - TokenUsageWorker - runnable_component - run - 123 - Component TokenUsageWorker (instance: 4629924656) stopping. Performing cleanup...
2025-05-28 17:40:18,834 - INFO - TokenUsageWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:40:18,837 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for token_usage_worker as part of cleanup.
2025-05-28 17:40:18,838 - INFO - TokenUsageWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-28 17:40:18,838 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:40:18,838 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-28 17:40:18,838 - INFO - TokenUsageWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:40:18,838 - INFO - TokenUsageWorker - runnable_component - run - 128 - Component TokenUsageWorker (instance: 4629924656) cleanup complete.
2025-05-28 17:40:18,838 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task TokenUsageWorker finished after cancellation signal.
2025-05-28 17:40:18,838 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task InactivityMonitorWorker...
2025-05-28 17:40:18,838 - INFO - InactivityMonitorWorker - runnable_component - run - 116 - Run_loop for InactivityMonitorWorker (instance: 4629735056) was cancelled.
2025-05-28 17:40:18,838 - INFO - InactivityMonitorWorker - runnable_component - run - 123 - Component InactivityMonitorWorker (instance: 4629735056) stopping. Performing cleanup...
2025-05-28 17:40:18,838 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 437 - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-28 17:40:18,838 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:40:18,838 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:40:18,838 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 441 - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-28 17:40:18,838 - INFO - InactivityMonitorWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:40:18,842 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-28 17:40:18,842 - INFO - InactivityMonitorWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-28 17:40:18,842 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:40:18,843 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-28 17:40:18,843 - INFO - InactivityMonitorWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:40:18,843 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 445 - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-28 17:40:18,843 - INFO - InactivityMonitorWorker - runnable_component - run - 128 - Component InactivityMonitorWorker (instance: 4629735056) cleanup complete.
2025-05-28 17:40:18,843 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-28 17:40:18,843 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 249 - All background tasks signaled to stop.
2025-05-28 17:40:18,843 - INFO - app.services.redis_service - redis_service - close_redis_pool - 43 - Redis connection pool closed successfully.
2025-05-28 17:40:18,851 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 17:40:18,851 - INFO - app.core.lifespan - lifespan - lifespan - 293 - Application shutdown sequence completed.
2025-05-28 17:40:19,331 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 17:40:19,331 - INFO - app.core.lifespan - lifespan - lifespan - 277 - Application startup sequence initiated.
2025-05-28 17:40:19,337 - INFO - app.services.redis_service - redis_service - init_redis_pool - 24 - Redis connection pool initialized successfully.
2025-05-28 17:40:19,337 - INFO - app.core.lifespan - lifespan - start_background_tasks - 172 - Starting background tasks...
2025-05-28 17:40:19,337 - INFO - app.core.lifespan - lifespan - start_background_tasks - 182 - History saver worker started, listening to queue: chat_history_queue
2025-05-28 17:40:19,337 - INFO - TokenUsageWorker - token_usage_worker - __init__ - 45 - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-28 17:40:19,337 - INFO - app.core.lifespan - lifespan - start_background_tasks - 194 - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-28 17:40:19,337 - INFO - app.core.lifespan - lifespan - start_background_tasks - 206 - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-28 17:40:19,337 - INFO - app.core.lifespan - lifespan - start_background_tasks - 210 - 3 background tasks initiated.
2025-05-28 17:40:19,337 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 51 - Attempting to start existing agents and their integrations...
2025-05-28 17:40:19,338 - INFO - HistorySaverWorker - base_worker - setup - 48 - [history_saver_worker] Worker setup started.
2025-05-28 17:40:19,338 - INFO - TokenUsageWorker - base_worker - setup - 48 - [token_usage_worker] Worker setup started.
2025-05-28 17:40:19,338 - INFO - InactivityMonitorWorker - base_worker - setup - 48 - [inactivity_monitor_worker] Worker setup started.
2025-05-28 17:40:19,340 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 61 - ProcessManager setup complete for startup.
2025-05-28 17:40:19,341 - INFO - HistorySaverWorker - base_worker - setup - 52 - [history_saver_worker] Worker setup completed.
2025-05-28 17:40:19,341 - INFO - HistorySaverWorker - base_worker - setup - 114 - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-28 17:40:19,341 - INFO - TokenUsageWorker - base_worker - setup - 52 - [token_usage_worker] Worker setup completed.
2025-05-28 17:40:19,341 - INFO - TokenUsageWorker - base_worker - setup - 114 - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-28 17:40:19,341 - INFO - InactivityMonitorWorker - base_worker - setup - 52 - [inactivity_monitor_worker] Worker setup completed.
2025-05-28 17:40:19,341 - INFO - InactivityMonitorWorker - base_worker - setup - 243 - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-28 17:40:19,343 - INFO - TokenUsageWorker - token_usage_worker - setup - 57 - [token_usage_worker] Database session factory initialized.
2025-05-28 17:40:19,344 - INFO - HistorySaverWorker - history_saver_worker - setup - 49 - [history_saver_worker] Database session factory initialized.
2025-05-28 17:40:19,344 - INFO - HistorySaverWorker - runnable_component - run - 111 - Component HistorySaverWorker (instance: 4381161568) setup complete. Starting run loop.
2025-05-28 17:40:19,344 - INFO - HistorySaverWorker - base_worker - run_loop - 131 - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-28 17:40:19,345 - INFO - TokenUsageWorker - token_usage_worker - setup - 64 - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-28 17:40:19,345 - INFO - TokenUsageWorker - runnable_component - run - 111 - Component TokenUsageWorker (instance: 4381293360) setup complete. Starting run loop.
2025-05-28 17:40:19,346 - INFO - TokenUsageWorker - base_worker - run_loop - 131 - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-28 17:40:19,347 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 86 - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-28 17:40:19,347 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 94 - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-28 17:40:19,393 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 66 - Found 1 agents to potentially start.
2025-05-28 17:40:19,393 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 69 - Attempting to start agent: agent_airsoft_0faa9616
2025-05-28 17:40:19,394 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 73 - Agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:40:19,394 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 93 - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-28 17:40:19,394 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 109 - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-28 17:40:19,395 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 115 - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:40:19,396 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:40:19,396 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:40:19,397 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 153 - ProcessManager cleanup complete for startup function.
2025-05-28 17:40:19,397 - INFO - app.core.lifespan - lifespan - lifespan - 284 - Application startup sequence completed.
2025-05-28 17:40:29,348 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 96 - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-28 17:40:29,353 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 98 - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-28 17:40:29,353 - INFO - InactivityMonitorWorker - runnable_component - run - 111 - Component InactivityMonitorWorker (instance: 4381282416) setup complete. Starting run loop.
2025-05-28 17:40:29,353 - INFO - InactivityMonitorWorker - base_worker - run_loop - 258 - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-28 17:41:11,461 - INFO - app.core.lifespan - lifespan - lifespan - 287 - Application shutdown sequence initiated.
2025-05-28 17:41:11,461 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 230 - Stopping 3 background tasks...
2025-05-28 17:41:11,461 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task HistorySaverWorker...
2025-05-28 17:41:11,462 - INFO - HistorySaverWorker - runnable_component - run - 116 - Run_loop for HistorySaverWorker (instance: 4381161568) was cancelled.
2025-05-28 17:41:11,462 - INFO - HistorySaverWorker - runnable_component - run - 123 - Component HistorySaverWorker (instance: 4381161568) stopping. Performing cleanup...
2025-05-28 17:41:11,462 - INFO - HistorySaverWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:41:11,466 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for history_saver_worker as part of cleanup.
2025-05-28 17:41:11,467 - INFO - HistorySaverWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-28 17:41:11,467 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:41:11,467 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-28 17:41:11,467 - INFO - HistorySaverWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:41:11,467 - INFO - HistorySaverWorker - runnable_component - run - 128 - Component HistorySaverWorker (instance: 4381161568) cleanup complete.
2025-05-28 17:41:11,467 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task HistorySaverWorker finished after cancellation signal.
2025-05-28 17:41:11,468 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task TokenUsageWorker...
2025-05-28 17:41:11,468 - INFO - TokenUsageWorker - runnable_component - run - 116 - Run_loop for TokenUsageWorker (instance: 4381293360) was cancelled.
2025-05-28 17:41:11,468 - INFO - TokenUsageWorker - runnable_component - run - 123 - Component TokenUsageWorker (instance: 4381293360) stopping. Performing cleanup...
2025-05-28 17:41:11,468 - INFO - TokenUsageWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:41:11,471 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for token_usage_worker as part of cleanup.
2025-05-28 17:41:11,472 - INFO - TokenUsageWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-28 17:41:11,472 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:41:11,472 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-28 17:41:11,472 - INFO - TokenUsageWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:41:11,472 - INFO - TokenUsageWorker - runnable_component - run - 128 - Component TokenUsageWorker (instance: 4381293360) cleanup complete.
2025-05-28 17:41:11,472 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task TokenUsageWorker finished after cancellation signal.
2025-05-28 17:41:11,472 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task InactivityMonitorWorker...
2025-05-28 17:41:11,472 - INFO - InactivityMonitorWorker - runnable_component - run - 116 - Run_loop for InactivityMonitorWorker (instance: 4381282416) was cancelled.
2025-05-28 17:41:11,472 - INFO - InactivityMonitorWorker - runnable_component - run - 123 - Component InactivityMonitorWorker (instance: 4381282416) stopping. Performing cleanup...
2025-05-28 17:41:11,472 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 437 - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-28 17:41:11,472 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:41:11,472 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:41:11,472 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 441 - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-28 17:41:11,472 - INFO - InactivityMonitorWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:41:11,474 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-28 17:41:11,475 - INFO - InactivityMonitorWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-28 17:41:11,475 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:41:11,475 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-28 17:41:11,475 - INFO - InactivityMonitorWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:41:11,475 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 445 - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-28 17:41:11,475 - INFO - InactivityMonitorWorker - runnable_component - run - 128 - Component InactivityMonitorWorker (instance: 4381282416) cleanup complete.
2025-05-28 17:41:11,475 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-28 17:41:11,475 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 249 - All background tasks signaled to stop.
2025-05-28 17:41:11,475 - INFO - app.services.redis_service - redis_service - close_redis_pool - 43 - Redis connection pool closed successfully.
2025-05-28 17:41:11,481 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 17:41:11,481 - INFO - app.core.lifespan - lifespan - lifespan - 293 - Application shutdown sequence completed.
2025-05-28 17:41:11,980 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 17:41:11,980 - INFO - app.core.lifespan - lifespan - lifespan - 277 - Application startup sequence initiated.
2025-05-28 17:41:11,985 - INFO - app.services.redis_service - redis_service - init_redis_pool - 24 - Redis connection pool initialized successfully.
2025-05-28 17:41:11,985 - INFO - app.core.lifespan - lifespan - start_background_tasks - 172 - Starting background tasks...
2025-05-28 17:41:11,985 - INFO - app.core.lifespan - lifespan - start_background_tasks - 182 - History saver worker started, listening to queue: chat_history_queue
2025-05-28 17:41:11,985 - INFO - TokenUsageWorker - token_usage_worker - __init__ - 45 - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-28 17:41:11,985 - INFO - app.core.lifespan - lifespan - start_background_tasks - 194 - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-28 17:41:11,985 - INFO - app.core.lifespan - lifespan - start_background_tasks - 206 - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-28 17:41:11,985 - INFO - app.core.lifespan - lifespan - start_background_tasks - 210 - 3 background tasks initiated.
2025-05-28 17:41:11,986 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 51 - Attempting to start existing agents and their integrations...
2025-05-28 17:41:11,986 - INFO - HistorySaverWorker - base_worker - setup - 48 - [history_saver_worker] Worker setup started.
2025-05-28 17:41:11,986 - INFO - TokenUsageWorker - base_worker - setup - 48 - [token_usage_worker] Worker setup started.
2025-05-28 17:41:11,986 - INFO - InactivityMonitorWorker - base_worker - setup - 48 - [inactivity_monitor_worker] Worker setup started.
2025-05-28 17:41:11,988 - INFO - InactivityMonitorWorker - base_worker - setup - 52 - [inactivity_monitor_worker] Worker setup completed.
2025-05-28 17:41:11,988 - INFO - InactivityMonitorWorker - base_worker - setup - 243 - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-28 17:41:11,988 - INFO - HistorySaverWorker - base_worker - setup - 52 - [history_saver_worker] Worker setup completed.
2025-05-28 17:41:11,988 - INFO - HistorySaverWorker - base_worker - setup - 114 - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-28 17:41:11,988 - INFO - TokenUsageWorker - base_worker - setup - 52 - [token_usage_worker] Worker setup completed.
2025-05-28 17:41:11,988 - INFO - TokenUsageWorker - base_worker - setup - 114 - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-28 17:41:11,988 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 61 - ProcessManager setup complete for startup.
2025-05-28 17:41:11,990 - INFO - HistorySaverWorker - history_saver_worker - setup - 49 - [history_saver_worker] Database session factory initialized.
2025-05-28 17:41:11,990 - INFO - HistorySaverWorker - runnable_component - run - 111 - Component HistorySaverWorker (instance: 4436255968) setup complete. Starting run loop.
2025-05-28 17:41:11,990 - INFO - HistorySaverWorker - base_worker - run_loop - 131 - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-28 17:41:11,990 - INFO - TokenUsageWorker - token_usage_worker - setup - 57 - [token_usage_worker] Database session factory initialized.
2025-05-28 17:41:11,992 - INFO - TokenUsageWorker - token_usage_worker - setup - 64 - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-28 17:41:11,993 - INFO - TokenUsageWorker - runnable_component - run - 111 - Component TokenUsageWorker (instance: 4432449840) setup complete. Starting run loop.
2025-05-28 17:41:11,993 - INFO - TokenUsageWorker - base_worker - run_loop - 131 - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-28 17:41:11,994 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 86 - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-28 17:41:11,994 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 94 - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-28 17:41:12,060 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 66 - Found 1 agents to potentially start.
2025-05-28 17:41:12,060 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 69 - Attempting to start agent: agent_airsoft_0faa9616
2025-05-28 17:41:12,062 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 73 - Agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:41:12,062 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 93 - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-28 17:41:12,062 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 109 - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-28 17:41:12,063 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 115 - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:41:12,064 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:41:12,064 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:41:12,064 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 153 - ProcessManager cleanup complete for startup function.
2025-05-28 17:41:12,064 - INFO - app.core.lifespan - lifespan - lifespan - 284 - Application startup sequence completed.
2025-05-28 17:41:21,996 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 96 - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-28 17:41:22,000 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 98 - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-28 17:41:22,000 - INFO - InactivityMonitorWorker - runnable_component - run - 111 - Component InactivityMonitorWorker (instance: 4437605072) setup complete. Starting run loop.
2025-05-28 17:41:22,000 - INFO - InactivityMonitorWorker - base_worker - run_loop - 258 - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-28 17:42:06,202 - INFO - app.core.lifespan - lifespan - lifespan - 287 - Application shutdown sequence initiated.
2025-05-28 17:42:06,203 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 230 - Stopping 3 background tasks...
2025-05-28 17:42:06,203 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task HistorySaverWorker...
2025-05-28 17:42:06,204 - INFO - HistorySaverWorker - runnable_component - run - 116 - Run_loop for HistorySaverWorker (instance: 4436255968) was cancelled.
2025-05-28 17:42:06,204 - INFO - HistorySaverWorker - runnable_component - run - 123 - Component HistorySaverWorker (instance: 4436255968) stopping. Performing cleanup...
2025-05-28 17:42:06,204 - INFO - HistorySaverWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:42:06,209 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for history_saver_worker as part of cleanup.
2025-05-28 17:42:06,210 - INFO - HistorySaverWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-28 17:42:06,210 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:42:06,210 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-28 17:42:06,210 - INFO - HistorySaverWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:42:06,210 - INFO - HistorySaverWorker - runnable_component - run - 128 - Component HistorySaverWorker (instance: 4436255968) cleanup complete.
2025-05-28 17:42:06,211 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task HistorySaverWorker finished after cancellation signal.
2025-05-28 17:42:06,211 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task TokenUsageWorker...
2025-05-28 17:42:06,211 - INFO - TokenUsageWorker - runnable_component - run - 116 - Run_loop for TokenUsageWorker (instance: 4432449840) was cancelled.
2025-05-28 17:42:06,211 - INFO - TokenUsageWorker - runnable_component - run - 123 - Component TokenUsageWorker (instance: 4432449840) stopping. Performing cleanup...
2025-05-28 17:42:06,211 - INFO - TokenUsageWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:42:06,215 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for token_usage_worker as part of cleanup.
2025-05-28 17:42:06,215 - INFO - TokenUsageWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-28 17:42:06,215 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:42:06,216 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-28 17:42:06,216 - INFO - TokenUsageWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:42:06,216 - INFO - TokenUsageWorker - runnable_component - run - 128 - Component TokenUsageWorker (instance: 4432449840) cleanup complete.
2025-05-28 17:42:06,216 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task TokenUsageWorker finished after cancellation signal.
2025-05-28 17:42:06,216 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task InactivityMonitorWorker...
2025-05-28 17:42:06,216 - INFO - InactivityMonitorWorker - runnable_component - run - 116 - Run_loop for InactivityMonitorWorker (instance: 4437605072) was cancelled.
2025-05-28 17:42:06,216 - INFO - InactivityMonitorWorker - runnable_component - run - 123 - Component InactivityMonitorWorker (instance: 4437605072) stopping. Performing cleanup...
2025-05-28 17:42:06,216 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 437 - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-28 17:42:06,216 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:42:06,216 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:42:06,216 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 441 - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-28 17:42:06,216 - INFO - InactivityMonitorWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:42:06,219 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-28 17:42:06,220 - INFO - InactivityMonitorWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-28 17:42:06,220 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:42:06,220 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-28 17:42:06,220 - INFO - InactivityMonitorWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:42:06,220 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 445 - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-28 17:42:06,220 - INFO - InactivityMonitorWorker - runnable_component - run - 128 - Component InactivityMonitorWorker (instance: 4437605072) cleanup complete.
2025-05-28 17:42:06,220 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-28 17:42:06,220 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 249 - All background tasks signaled to stop.
2025-05-28 17:42:06,220 - INFO - app.services.redis_service - redis_service - close_redis_pool - 43 - Redis connection pool closed successfully.
2025-05-28 17:42:06,231 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 17:42:06,231 - INFO - app.core.lifespan - lifespan - lifespan - 293 - Application shutdown sequence completed.
2025-05-28 17:42:06,722 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 17:42:06,722 - INFO - app.core.lifespan - lifespan - lifespan - 277 - Application startup sequence initiated.
2025-05-28 17:42:06,728 - INFO - app.services.redis_service - redis_service - init_redis_pool - 24 - Redis connection pool initialized successfully.
2025-05-28 17:42:06,728 - INFO - app.core.lifespan - lifespan - start_background_tasks - 172 - Starting background tasks...
2025-05-28 17:42:06,728 - INFO - app.core.lifespan - lifespan - start_background_tasks - 182 - History saver worker started, listening to queue: chat_history_queue
2025-05-28 17:42:06,728 - INFO - TokenUsageWorker - token_usage_worker - __init__ - 45 - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-28 17:42:06,728 - INFO - app.core.lifespan - lifespan - start_background_tasks - 194 - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-28 17:42:06,728 - INFO - app.core.lifespan - lifespan - start_background_tasks - 206 - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-28 17:42:06,728 - INFO - app.core.lifespan - lifespan - start_background_tasks - 210 - 3 background tasks initiated.
2025-05-28 17:42:06,728 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 51 - Attempting to start existing agents and their integrations...
2025-05-28 17:42:06,729 - INFO - HistorySaverWorker - base_worker - setup - 48 - [history_saver_worker] Worker setup started.
2025-05-28 17:42:06,729 - INFO - TokenUsageWorker - base_worker - setup - 48 - [token_usage_worker] Worker setup started.
2025-05-28 17:42:06,729 - INFO - InactivityMonitorWorker - base_worker - setup - 48 - [inactivity_monitor_worker] Worker setup started.
2025-05-28 17:42:06,730 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 61 - ProcessManager setup complete for startup.
2025-05-28 17:42:06,732 - INFO - HistorySaverWorker - base_worker - setup - 52 - [history_saver_worker] Worker setup completed.
2025-05-28 17:42:06,732 - INFO - HistorySaverWorker - base_worker - setup - 114 - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-28 17:42:06,732 - INFO - InactivityMonitorWorker - base_worker - setup - 52 - [inactivity_monitor_worker] Worker setup completed.
2025-05-28 17:42:06,732 - INFO - InactivityMonitorWorker - base_worker - setup - 243 - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-28 17:42:06,732 - INFO - TokenUsageWorker - base_worker - setup - 52 - [token_usage_worker] Worker setup completed.
2025-05-28 17:42:06,732 - INFO - TokenUsageWorker - base_worker - setup - 114 - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-28 17:42:06,733 - INFO - HistorySaverWorker - history_saver_worker - setup - 49 - [history_saver_worker] Database session factory initialized.
2025-05-28 17:42:06,733 - INFO - HistorySaverWorker - runnable_component - run - 111 - Component HistorySaverWorker (instance: 4421548848) setup complete. Starting run loop.
2025-05-28 17:42:06,733 - INFO - HistorySaverWorker - base_worker - run_loop - 131 - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-28 17:42:06,734 - INFO - TokenUsageWorker - token_usage_worker - setup - 57 - [token_usage_worker] Database session factory initialized.
2025-05-28 17:42:06,734 - INFO - TokenUsageWorker - token_usage_worker - setup - 64 - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-28 17:42:06,734 - INFO - TokenUsageWorker - runnable_component - run - 111 - Component TokenUsageWorker (instance: 4421539248) setup complete. Starting run loop.
2025-05-28 17:42:06,735 - INFO - TokenUsageWorker - base_worker - run_loop - 131 - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-28 17:42:06,736 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 86 - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-28 17:42:06,736 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 94 - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-28 17:42:06,785 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 66 - Found 1 agents to potentially start.
2025-05-28 17:42:06,785 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 69 - Attempting to start agent: agent_airsoft_0faa9616
2025-05-28 17:42:06,786 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 73 - Agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:42:06,786 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 93 - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-28 17:42:06,786 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 109 - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-28 17:42:06,787 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 115 - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:42:06,788 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:42:06,788 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:42:06,788 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 153 - ProcessManager cleanup complete for startup function.
2025-05-28 17:42:06,788 - INFO - app.core.lifespan - lifespan - lifespan - 284 - Application startup sequence completed.
2025-05-28 17:42:16,736 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 96 - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-28 17:42:16,742 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 98 - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-28 17:42:16,743 - INFO - InactivityMonitorWorker - runnable_component - run - 111 - Component InactivityMonitorWorker (instance: 4309332480) setup complete. Starting run loop.
2025-05-28 17:42:16,743 - INFO - InactivityMonitorWorker - base_worker - run_loop - 258 - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-28 17:42:19,674 - INFO - app.core.lifespan - lifespan - lifespan - 287 - Application shutdown sequence initiated.
2025-05-28 17:42:19,674 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 230 - Stopping 3 background tasks...
2025-05-28 17:42:19,674 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task HistorySaverWorker...
2025-05-28 17:42:19,674 - INFO - HistorySaverWorker - runnable_component - run - 116 - Run_loop for HistorySaverWorker (instance: 4421548848) was cancelled.
2025-05-28 17:42:19,674 - INFO - HistorySaverWorker - runnable_component - run - 123 - Component HistorySaverWorker (instance: 4421548848) stopping. Performing cleanup...
2025-05-28 17:42:19,674 - INFO - HistorySaverWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:42:19,680 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for history_saver_worker as part of cleanup.
2025-05-28 17:42:19,681 - INFO - HistorySaverWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-28 17:42:19,681 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:42:19,681 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-28 17:42:19,681 - INFO - HistorySaverWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:42:19,681 - INFO - HistorySaverWorker - runnable_component - run - 128 - Component HistorySaverWorker (instance: 4421548848) cleanup complete.
2025-05-28 17:42:19,681 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task HistorySaverWorker finished after cancellation signal.
2025-05-28 17:42:19,681 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task TokenUsageWorker...
2025-05-28 17:42:19,681 - INFO - TokenUsageWorker - runnable_component - run - 116 - Run_loop for TokenUsageWorker (instance: 4421539248) was cancelled.
2025-05-28 17:42:19,681 - INFO - TokenUsageWorker - runnable_component - run - 123 - Component TokenUsageWorker (instance: 4421539248) stopping. Performing cleanup...
2025-05-28 17:42:19,681 - INFO - TokenUsageWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:42:19,684 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for token_usage_worker as part of cleanup.
2025-05-28 17:42:19,685 - INFO - TokenUsageWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-28 17:42:19,685 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:42:19,685 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-28 17:42:19,685 - INFO - TokenUsageWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:42:19,685 - INFO - TokenUsageWorker - runnable_component - run - 128 - Component TokenUsageWorker (instance: 4421539248) cleanup complete.
2025-05-28 17:42:19,685 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task TokenUsageWorker finished after cancellation signal.
2025-05-28 17:42:19,685 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task InactivityMonitorWorker...
2025-05-28 17:42:19,685 - INFO - InactivityMonitorWorker - runnable_component - run - 116 - Run_loop for InactivityMonitorWorker (instance: 4309332480) was cancelled.
2025-05-28 17:42:19,685 - INFO - InactivityMonitorWorker - runnable_component - run - 123 - Component InactivityMonitorWorker (instance: 4309332480) stopping. Performing cleanup...
2025-05-28 17:42:19,685 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 437 - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-28 17:42:19,685 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:42:19,685 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:42:19,686 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 441 - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-28 17:42:19,686 - INFO - InactivityMonitorWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:42:19,688 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-28 17:42:19,689 - INFO - InactivityMonitorWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-28 17:42:19,689 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:42:19,689 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-28 17:42:19,689 - INFO - InactivityMonitorWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:42:19,689 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 445 - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-28 17:42:19,689 - INFO - InactivityMonitorWorker - runnable_component - run - 128 - Component InactivityMonitorWorker (instance: 4309332480) cleanup complete.
2025-05-28 17:42:19,689 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-28 17:42:19,689 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 249 - All background tasks signaled to stop.
2025-05-28 17:42:19,689 - INFO - app.services.redis_service - redis_service - close_redis_pool - 43 - Redis connection pool closed successfully.
2025-05-28 17:42:19,695 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 17:42:19,695 - INFO - app.core.lifespan - lifespan - lifespan - 293 - Application shutdown sequence completed.
2025-05-28 17:42:20,187 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 17:42:20,187 - INFO - app.core.lifespan - lifespan - lifespan - 277 - Application startup sequence initiated.
2025-05-28 17:42:20,191 - INFO - app.services.redis_service - redis_service - init_redis_pool - 24 - Redis connection pool initialized successfully.
2025-05-28 17:42:20,191 - INFO - app.core.lifespan - lifespan - start_background_tasks - 172 - Starting background tasks...
2025-05-28 17:42:20,191 - INFO - app.core.lifespan - lifespan - start_background_tasks - 182 - History saver worker started, listening to queue: chat_history_queue
2025-05-28 17:42:20,191 - INFO - TokenUsageWorker - token_usage_worker - __init__ - 45 - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-28 17:42:20,191 - INFO - app.core.lifespan - lifespan - start_background_tasks - 194 - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-28 17:42:20,191 - INFO - app.core.lifespan - lifespan - start_background_tasks - 206 - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-28 17:42:20,191 - INFO - app.core.lifespan - lifespan - start_background_tasks - 210 - 3 background tasks initiated.
2025-05-28 17:42:20,191 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 51 - Attempting to start existing agents and their integrations...
2025-05-28 17:42:20,192 - INFO - HistorySaverWorker - base_worker - setup - 48 - [history_saver_worker] Worker setup started.
2025-05-28 17:42:20,192 - INFO - TokenUsageWorker - base_worker - setup - 48 - [token_usage_worker] Worker setup started.
2025-05-28 17:42:20,192 - INFO - InactivityMonitorWorker - base_worker - setup - 48 - [inactivity_monitor_worker] Worker setup started.
2025-05-28 17:42:20,197 - INFO - TokenUsageWorker - base_worker - setup - 52 - [token_usage_worker] Worker setup completed.
2025-05-28 17:42:20,197 - INFO - TokenUsageWorker - base_worker - setup - 114 - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-28 17:42:20,197 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 61 - ProcessManager setup complete for startup.
2025-05-28 17:42:20,199 - INFO - HistorySaverWorker - base_worker - setup - 52 - [history_saver_worker] Worker setup completed.
2025-05-28 17:42:20,199 - INFO - HistorySaverWorker - base_worker - setup - 114 - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-28 17:42:20,199 - INFO - InactivityMonitorWorker - base_worker - setup - 52 - [inactivity_monitor_worker] Worker setup completed.
2025-05-28 17:42:20,199 - INFO - InactivityMonitorWorker - base_worker - setup - 243 - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-28 17:42:20,202 - INFO - HistorySaverWorker - history_saver_worker - setup - 49 - [history_saver_worker] Database session factory initialized.
2025-05-28 17:42:20,202 - INFO - HistorySaverWorker - runnable_component - run - 111 - Component HistorySaverWorker (instance: 4581313952) setup complete. Starting run loop.
2025-05-28 17:42:20,202 - INFO - HistorySaverWorker - base_worker - run_loop - 131 - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-28 17:42:20,202 - INFO - TokenUsageWorker - token_usage_worker - setup - 57 - [token_usage_worker] Database session factory initialized.
2025-05-28 17:42:20,203 - INFO - TokenUsageWorker - token_usage_worker - setup - 64 - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-28 17:42:20,203 - INFO - TokenUsageWorker - runnable_component - run - 111 - Component TokenUsageWorker (instance: 4405370352) setup complete. Starting run loop.
2025-05-28 17:42:20,203 - INFO - TokenUsageWorker - base_worker - run_loop - 131 - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-28 17:42:20,205 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 86 - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-28 17:42:20,205 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 94 - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-28 17:42:20,256 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 66 - Found 1 agents to potentially start.
2025-05-28 17:42:20,256 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 69 - Attempting to start agent: agent_airsoft_0faa9616
2025-05-28 17:42:20,257 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 73 - Agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:42:20,258 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 93 - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-28 17:42:20,258 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 109 - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-28 17:42:20,258 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 115 - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:42:20,259 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:42:20,259 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:42:20,259 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 153 - ProcessManager cleanup complete for startup function.
2025-05-28 17:42:20,259 - INFO - app.core.lifespan - lifespan - lifespan - 284 - Application startup sequence completed.
2025-05-28 17:42:30,206 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 96 - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-28 17:42:30,210 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 98 - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-28 17:42:30,210 - INFO - InactivityMonitorWorker - runnable_component - run - 111 - Component InactivityMonitorWorker (instance: 4581980400) setup complete. Starting run loop.
2025-05-28 17:42:30,210 - INFO - InactivityMonitorWorker - base_worker - run_loop - 258 - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-28 17:42:33,439 - INFO - app.core.lifespan - lifespan - lifespan - 287 - Application shutdown sequence initiated.
2025-05-28 17:42:33,439 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 230 - Stopping 3 background tasks...
2025-05-28 17:42:33,439 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task HistorySaverWorker...
2025-05-28 17:42:33,439 - INFO - HistorySaverWorker - runnable_component - run - 116 - Run_loop for HistorySaverWorker (instance: 4581313952) was cancelled.
2025-05-28 17:42:33,439 - INFO - HistorySaverWorker - runnable_component - run - 123 - Component HistorySaverWorker (instance: 4581313952) stopping. Performing cleanup...
2025-05-28 17:42:33,439 - INFO - HistorySaverWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:42:33,445 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for history_saver_worker as part of cleanup.
2025-05-28 17:42:33,446 - INFO - HistorySaverWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-28 17:42:33,446 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:42:33,446 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-28 17:42:33,446 - INFO - HistorySaverWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:42:33,446 - INFO - HistorySaverWorker - runnable_component - run - 128 - Component HistorySaverWorker (instance: 4581313952) cleanup complete.
2025-05-28 17:42:33,446 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task HistorySaverWorker finished after cancellation signal.
2025-05-28 17:42:33,446 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task TokenUsageWorker...
2025-05-28 17:42:33,446 - INFO - TokenUsageWorker - runnable_component - run - 116 - Run_loop for TokenUsageWorker (instance: 4405370352) was cancelled.
2025-05-28 17:42:33,446 - INFO - TokenUsageWorker - runnable_component - run - 123 - Component TokenUsageWorker (instance: 4405370352) stopping. Performing cleanup...
2025-05-28 17:42:33,446 - INFO - TokenUsageWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:42:33,449 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for token_usage_worker as part of cleanup.
2025-05-28 17:42:33,450 - INFO - TokenUsageWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-28 17:42:33,450 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:42:33,450 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-28 17:42:33,450 - INFO - TokenUsageWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:42:33,450 - INFO - TokenUsageWorker - runnable_component - run - 128 - Component TokenUsageWorker (instance: 4405370352) cleanup complete.
2025-05-28 17:42:33,450 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task TokenUsageWorker finished after cancellation signal.
2025-05-28 17:42:33,450 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task InactivityMonitorWorker...
2025-05-28 17:42:33,450 - INFO - InactivityMonitorWorker - runnable_component - run - 116 - Run_loop for InactivityMonitorWorker (instance: 4581980400) was cancelled.
2025-05-28 17:42:33,451 - INFO - InactivityMonitorWorker - runnable_component - run - 123 - Component InactivityMonitorWorker (instance: 4581980400) stopping. Performing cleanup...
2025-05-28 17:42:33,451 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 437 - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-28 17:42:33,451 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:42:33,451 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:42:33,451 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 441 - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-28 17:42:33,451 - INFO - InactivityMonitorWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:42:33,452 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-28 17:42:33,453 - INFO - InactivityMonitorWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-28 17:42:33,453 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:42:33,453 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-28 17:42:33,453 - INFO - InactivityMonitorWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:42:33,453 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 445 - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-28 17:42:33,453 - INFO - InactivityMonitorWorker - runnable_component - run - 128 - Component InactivityMonitorWorker (instance: 4581980400) cleanup complete.
2025-05-28 17:42:33,453 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-28 17:42:33,453 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 249 - All background tasks signaled to stop.
2025-05-28 17:42:33,454 - INFO - app.services.redis_service - redis_service - close_redis_pool - 43 - Redis connection pool closed successfully.
2025-05-28 17:42:33,460 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 17:42:33,460 - INFO - app.core.lifespan - lifespan - lifespan - 293 - Application shutdown sequence completed.
2025-05-28 17:42:33,886 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 17:42:33,886 - INFO - app.core.lifespan - lifespan - lifespan - 277 - Application startup sequence initiated.
2025-05-28 17:42:33,891 - INFO - app.services.redis_service - redis_service - init_redis_pool - 24 - Redis connection pool initialized successfully.
2025-05-28 17:42:33,891 - INFO - app.core.lifespan - lifespan - start_background_tasks - 172 - Starting background tasks...
2025-05-28 17:42:33,891 - INFO - app.core.lifespan - lifespan - start_background_tasks - 182 - History saver worker started, listening to queue: chat_history_queue
2025-05-28 17:42:33,891 - INFO - TokenUsageWorker - token_usage_worker - __init__ - 45 - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-28 17:42:33,891 - INFO - app.core.lifespan - lifespan - start_background_tasks - 194 - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-28 17:42:33,891 - INFO - app.core.lifespan - lifespan - start_background_tasks - 206 - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-28 17:42:33,891 - INFO - app.core.lifespan - lifespan - start_background_tasks - 210 - 3 background tasks initiated.
2025-05-28 17:42:33,891 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 51 - Attempting to start existing agents and their integrations...
2025-05-28 17:42:33,892 - INFO - HistorySaverWorker - base_worker - setup - 48 - [history_saver_worker] Worker setup started.
2025-05-28 17:42:33,892 - INFO - TokenUsageWorker - base_worker - setup - 48 - [token_usage_worker] Worker setup started.
2025-05-28 17:42:33,892 - INFO - InactivityMonitorWorker - base_worker - setup - 48 - [inactivity_monitor_worker] Worker setup started.
2025-05-28 17:42:33,894 - INFO - TokenUsageWorker - base_worker - setup - 52 - [token_usage_worker] Worker setup completed.
2025-05-28 17:42:33,894 - INFO - TokenUsageWorker - base_worker - setup - 114 - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-28 17:42:33,894 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 61 - ProcessManager setup complete for startup.
2025-05-28 17:42:33,895 - INFO - HistorySaverWorker - base_worker - setup - 52 - [history_saver_worker] Worker setup completed.
2025-05-28 17:42:33,895 - INFO - HistorySaverWorker - base_worker - setup - 114 - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-28 17:42:33,895 - INFO - InactivityMonitorWorker - base_worker - setup - 52 - [inactivity_monitor_worker] Worker setup completed.
2025-05-28 17:42:33,896 - INFO - InactivityMonitorWorker - base_worker - setup - 243 - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-28 17:42:33,896 - INFO - TokenUsageWorker - token_usage_worker - setup - 57 - [token_usage_worker] Database session factory initialized.
2025-05-28 17:42:33,897 - INFO - TokenUsageWorker - token_usage_worker - setup - 64 - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-28 17:42:33,897 - INFO - TokenUsageWorker - runnable_component - run - 111 - Component TokenUsageWorker (instance: 4436998768) setup complete. Starting run loop.
2025-05-28 17:42:33,897 - INFO - TokenUsageWorker - base_worker - run_loop - 131 - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-28 17:42:33,897 - INFO - HistorySaverWorker - history_saver_worker - setup - 49 - [history_saver_worker] Database session factory initialized.
2025-05-28 17:42:33,897 - INFO - HistorySaverWorker - runnable_component - run - 111 - Component HistorySaverWorker (instance: 4436999344) setup complete. Starting run loop.
2025-05-28 17:42:33,897 - INFO - HistorySaverWorker - base_worker - run_loop - 131 - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-28 17:42:33,899 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 86 - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-28 17:42:33,899 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 94 - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-28 17:42:33,941 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 66 - Found 1 agents to potentially start.
2025-05-28 17:42:33,941 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 69 - Attempting to start agent: agent_airsoft_0faa9616
2025-05-28 17:42:33,941 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 73 - Agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:42:33,942 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 93 - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-28 17:42:33,942 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 109 - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-28 17:42:33,942 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 115 - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:42:33,943 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:42:33,943 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:42:33,943 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 153 - ProcessManager cleanup complete for startup function.
2025-05-28 17:42:33,943 - INFO - app.core.lifespan - lifespan - lifespan - 284 - Application startup sequence completed.
2025-05-28 17:42:35,350 - INFO - app.core.lifespan - lifespan - lifespan - 287 - Application shutdown sequence initiated.
2025-05-28 17:42:35,350 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 230 - Stopping 3 background tasks...
2025-05-28 17:42:35,350 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task HistorySaverWorker...
2025-05-28 17:42:35,351 - INFO - HistorySaverWorker - runnable_component - run - 116 - Run_loop for HistorySaverWorker (instance: 4436999344) was cancelled.
2025-05-28 17:42:35,351 - INFO - HistorySaverWorker - runnable_component - run - 123 - Component HistorySaverWorker (instance: 4436999344) stopping. Performing cleanup...
2025-05-28 17:42:35,351 - INFO - HistorySaverWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:42:35,355 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for history_saver_worker as part of cleanup.
2025-05-28 17:42:35,356 - INFO - HistorySaverWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-28 17:42:35,356 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:42:35,357 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-28 17:42:35,357 - INFO - HistorySaverWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:42:35,357 - INFO - HistorySaverWorker - runnable_component - run - 128 - Component HistorySaverWorker (instance: 4436999344) cleanup complete.
2025-05-28 17:42:35,357 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task HistorySaverWorker finished after cancellation signal.
2025-05-28 17:42:35,357 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task TokenUsageWorker...
2025-05-28 17:42:35,357 - INFO - TokenUsageWorker - runnable_component - run - 116 - Run_loop for TokenUsageWorker (instance: 4436998768) was cancelled.
2025-05-28 17:42:35,357 - INFO - TokenUsageWorker - runnable_component - run - 123 - Component TokenUsageWorker (instance: 4436998768) stopping. Performing cleanup...
2025-05-28 17:42:35,357 - INFO - TokenUsageWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:42:35,361 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for token_usage_worker as part of cleanup.
2025-05-28 17:42:35,361 - INFO - TokenUsageWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-28 17:42:35,361 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:42:35,362 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-28 17:42:35,362 - INFO - TokenUsageWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:42:35,362 - INFO - TokenUsageWorker - runnable_component - run - 128 - Component TokenUsageWorker (instance: 4436998768) cleanup complete.
2025-05-28 17:42:35,362 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task TokenUsageWorker finished after cancellation signal.
2025-05-28 17:42:35,362 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task InactivityMonitorWorker...
2025-05-28 17:42:35,362 - INFO - InactivityMonitorWorker - runnable_component - run - 116 - Run_loop for InactivityMonitorWorker (instance: 4436999104) was cancelled.
2025-05-28 17:42:35,362 - INFO - InactivityMonitorWorker - runnable_component - run - 123 - Component InactivityMonitorWorker (instance: 4436999104) stopping. Performing cleanup...
2025-05-28 17:42:35,363 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 437 - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-28 17:42:35,363 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:42:35,363 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:42:35,363 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 441 - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-28 17:42:35,363 - INFO - InactivityMonitorWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:42:35,365 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-28 17:42:35,365 - INFO - InactivityMonitorWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-28 17:42:35,365 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:42:35,366 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-28 17:42:35,366 - INFO - InactivityMonitorWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:42:35,366 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 445 - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-28 17:42:35,366 - INFO - InactivityMonitorWorker - runnable_component - run - 128 - Component InactivityMonitorWorker (instance: 4436999104) cleanup complete.
2025-05-28 17:42:35,366 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-28 17:42:35,366 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 249 - All background tasks signaled to stop.
2025-05-28 17:42:35,366 - INFO - app.services.redis_service - redis_service - close_redis_pool - 43 - Redis connection pool closed successfully.
2025-05-28 17:42:35,369 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 17:42:35,369 - INFO - app.core.lifespan - lifespan - lifespan - 293 - Application shutdown sequence completed.
2025-05-28 17:42:35,726 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 17:42:35,726 - INFO - app.core.lifespan - lifespan - lifespan - 277 - Application startup sequence initiated.
2025-05-28 17:42:35,730 - INFO - app.services.redis_service - redis_service - init_redis_pool - 24 - Redis connection pool initialized successfully.
2025-05-28 17:42:35,730 - INFO - app.core.lifespan - lifespan - start_background_tasks - 172 - Starting background tasks...
2025-05-28 17:42:35,730 - INFO - app.core.lifespan - lifespan - start_background_tasks - 182 - History saver worker started, listening to queue: chat_history_queue
2025-05-28 17:42:35,731 - INFO - TokenUsageWorker - token_usage_worker - __init__ - 45 - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-28 17:42:35,731 - INFO - app.core.lifespan - lifespan - start_background_tasks - 194 - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-28 17:42:35,731 - INFO - app.core.lifespan - lifespan - start_background_tasks - 206 - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-28 17:42:35,731 - INFO - app.core.lifespan - lifespan - start_background_tasks - 210 - 3 background tasks initiated.
2025-05-28 17:42:35,731 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 51 - Attempting to start existing agents and their integrations...
2025-05-28 17:42:35,731 - INFO - HistorySaverWorker - base_worker - setup - 48 - [history_saver_worker] Worker setup started.
2025-05-28 17:42:35,731 - INFO - TokenUsageWorker - base_worker - setup - 48 - [token_usage_worker] Worker setup started.
2025-05-28 17:42:35,732 - INFO - InactivityMonitorWorker - base_worker - setup - 48 - [inactivity_monitor_worker] Worker setup started.
2025-05-28 17:42:35,734 - INFO - TokenUsageWorker - base_worker - setup - 52 - [token_usage_worker] Worker setup completed.
2025-05-28 17:42:35,734 - INFO - TokenUsageWorker - base_worker - setup - 114 - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-28 17:42:35,735 - INFO - InactivityMonitorWorker - base_worker - setup - 52 - [inactivity_monitor_worker] Worker setup completed.
2025-05-28 17:42:35,735 - INFO - InactivityMonitorWorker - base_worker - setup - 243 - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-28 17:42:35,735 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 61 - ProcessManager setup complete for startup.
2025-05-28 17:42:35,736 - INFO - HistorySaverWorker - base_worker - setup - 52 - [history_saver_worker] Worker setup completed.
2025-05-28 17:42:35,736 - INFO - HistorySaverWorker - base_worker - setup - 114 - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-28 17:42:35,737 - INFO - TokenUsageWorker - token_usage_worker - setup - 57 - [token_usage_worker] Database session factory initialized.
2025-05-28 17:42:35,737 - INFO - HistorySaverWorker - history_saver_worker - setup - 49 - [history_saver_worker] Database session factory initialized.
2025-05-28 17:42:35,737 - INFO - HistorySaverWorker - runnable_component - run - 111 - Component HistorySaverWorker (instance: 4329823728) setup complete. Starting run loop.
2025-05-28 17:42:35,738 - INFO - HistorySaverWorker - base_worker - run_loop - 131 - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-28 17:42:35,738 - INFO - TokenUsageWorker - token_usage_worker - setup - 64 - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-28 17:42:35,738 - INFO - TokenUsageWorker - runnable_component - run - 111 - Component TokenUsageWorker (instance: 4386945696) setup complete. Starting run loop.
2025-05-28 17:42:35,738 - INFO - TokenUsageWorker - base_worker - run_loop - 131 - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-28 17:42:35,739 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 86 - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-28 17:42:35,739 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 94 - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-28 17:42:35,782 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 66 - Found 1 agents to potentially start.
2025-05-28 17:42:35,782 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 69 - Attempting to start agent: agent_airsoft_0faa9616
2025-05-28 17:42:35,784 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 73 - Agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:42:35,784 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 93 - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-28 17:42:35,784 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 109 - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-28 17:42:35,785 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 115 - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:42:35,786 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:42:35,786 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:42:35,786 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 153 - ProcessManager cleanup complete for startup function.
2025-05-28 17:42:35,787 - INFO - app.core.lifespan - lifespan - lifespan - 284 - Application startup sequence completed.
2025-05-28 17:42:44,547 - INFO - app.core.lifespan - lifespan - lifespan - 287 - Application shutdown sequence initiated.
2025-05-28 17:42:44,547 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 230 - Stopping 3 background tasks...
2025-05-28 17:42:44,547 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task HistorySaverWorker...
2025-05-28 17:42:44,547 - INFO - HistorySaverWorker - runnable_component - run - 116 - Run_loop for HistorySaverWorker (instance: 4329823728) was cancelled.
2025-05-28 17:42:44,547 - INFO - HistorySaverWorker - runnable_component - run - 123 - Component HistorySaverWorker (instance: 4329823728) stopping. Performing cleanup...
2025-05-28 17:42:44,547 - INFO - HistorySaverWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:42:44,555 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for history_saver_worker as part of cleanup.
2025-05-28 17:42:44,556 - INFO - HistorySaverWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-28 17:42:44,556 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:42:44,556 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-28 17:42:44,556 - INFO - HistorySaverWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:42:44,556 - INFO - HistorySaverWorker - runnable_component - run - 128 - Component HistorySaverWorker (instance: 4329823728) cleanup complete.
2025-05-28 17:42:44,556 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task HistorySaverWorker finished after cancellation signal.
2025-05-28 17:42:44,556 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task TokenUsageWorker...
2025-05-28 17:42:44,556 - INFO - TokenUsageWorker - runnable_component - run - 116 - Run_loop for TokenUsageWorker (instance: 4386945696) was cancelled.
2025-05-28 17:42:44,556 - INFO - TokenUsageWorker - runnable_component - run - 123 - Component TokenUsageWorker (instance: 4386945696) stopping. Performing cleanup...
2025-05-28 17:42:44,556 - INFO - TokenUsageWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:42:44,559 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for token_usage_worker as part of cleanup.
2025-05-28 17:42:44,560 - INFO - TokenUsageWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-28 17:42:44,560 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:42:44,560 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-28 17:42:44,560 - INFO - TokenUsageWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:42:44,561 - INFO - TokenUsageWorker - runnable_component - run - 128 - Component TokenUsageWorker (instance: 4386945696) cleanup complete.
2025-05-28 17:42:44,561 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task TokenUsageWorker finished after cancellation signal.
2025-05-28 17:42:44,561 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task InactivityMonitorWorker...
2025-05-28 17:42:44,561 - INFO - InactivityMonitorWorker - runnable_component - run - 116 - Run_loop for InactivityMonitorWorker (instance: 4386945600) was cancelled.
2025-05-28 17:42:44,561 - INFO - InactivityMonitorWorker - runnable_component - run - 123 - Component InactivityMonitorWorker (instance: 4386945600) stopping. Performing cleanup...
2025-05-28 17:42:44,561 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 437 - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-28 17:42:44,561 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:42:44,561 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:42:44,561 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 441 - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-28 17:42:44,561 - INFO - InactivityMonitorWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:42:44,564 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-28 17:42:44,565 - INFO - InactivityMonitorWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-28 17:42:44,565 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:42:44,565 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-28 17:42:44,565 - INFO - InactivityMonitorWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:42:44,565 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 445 - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-28 17:42:44,565 - INFO - InactivityMonitorWorker - runnable_component - run - 128 - Component InactivityMonitorWorker (instance: 4386945600) cleanup complete.
2025-05-28 17:42:44,565 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-28 17:42:44,565 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 249 - All background tasks signaled to stop.
2025-05-28 17:42:44,565 - INFO - app.services.redis_service - redis_service - close_redis_pool - 43 - Redis connection pool closed successfully.
2025-05-28 17:42:44,568 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 17:42:44,568 - INFO - app.core.lifespan - lifespan - lifespan - 293 - Application shutdown sequence completed.
2025-05-28 17:42:44,937 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 17:42:44,937 - INFO - app.core.lifespan - lifespan - lifespan - 277 - Application startup sequence initiated.
2025-05-28 17:42:44,942 - INFO - app.services.redis_service - redis_service - init_redis_pool - 24 - Redis connection pool initialized successfully.
2025-05-28 17:42:44,942 - INFO - app.core.lifespan - lifespan - start_background_tasks - 172 - Starting background tasks...
2025-05-28 17:42:44,942 - INFO - app.core.lifespan - lifespan - start_background_tasks - 182 - History saver worker started, listening to queue: chat_history_queue
2025-05-28 17:42:44,942 - INFO - TokenUsageWorker - token_usage_worker - __init__ - 45 - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-28 17:42:44,942 - INFO - app.core.lifespan - lifespan - start_background_tasks - 194 - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-28 17:42:44,942 - INFO - app.core.lifespan - lifespan - start_background_tasks - 206 - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-28 17:42:44,942 - INFO - app.core.lifespan - lifespan - start_background_tasks - 210 - 3 background tasks initiated.
2025-05-28 17:42:44,942 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 51 - Attempting to start existing agents and their integrations...
2025-05-28 17:42:44,943 - INFO - HistorySaverWorker - base_worker - setup - 48 - [history_saver_worker] Worker setup started.
2025-05-28 17:42:44,943 - INFO - TokenUsageWorker - base_worker - setup - 48 - [token_usage_worker] Worker setup started.
2025-05-28 17:42:44,943 - INFO - InactivityMonitorWorker - base_worker - setup - 48 - [inactivity_monitor_worker] Worker setup started.
2025-05-28 17:42:44,945 - INFO - TokenUsageWorker - base_worker - setup - 52 - [token_usage_worker] Worker setup completed.
2025-05-28 17:42:44,945 - INFO - TokenUsageWorker - base_worker - setup - 114 - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-28 17:42:44,945 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 61 - ProcessManager setup complete for startup.
2025-05-28 17:42:44,947 - INFO - HistorySaverWorker - base_worker - setup - 52 - [history_saver_worker] Worker setup completed.
2025-05-28 17:42:44,947 - INFO - HistorySaverWorker - base_worker - setup - 114 - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-28 17:42:44,948 - INFO - InactivityMonitorWorker - base_worker - setup - 52 - [inactivity_monitor_worker] Worker setup completed.
2025-05-28 17:42:44,948 - INFO - InactivityMonitorWorker - base_worker - setup - 243 - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-28 17:42:44,949 - INFO - TokenUsageWorker - token_usage_worker - setup - 57 - [token_usage_worker] Database session factory initialized.
2025-05-28 17:42:44,949 - INFO - HistorySaverWorker - history_saver_worker - setup - 49 - [history_saver_worker] Database session factory initialized.
2025-05-28 17:42:44,949 - INFO - HistorySaverWorker - runnable_component - run - 111 - Component HistorySaverWorker (instance: 4456152240) setup complete. Starting run loop.
2025-05-28 17:42:44,949 - INFO - HistorySaverWorker - base_worker - run_loop - 131 - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-28 17:42:44,949 - INFO - TokenUsageWorker - token_usage_worker - setup - 64 - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-28 17:42:44,949 - INFO - TokenUsageWorker - runnable_component - run - 111 - Component TokenUsageWorker (instance: 4456151664) setup complete. Starting run loop.
2025-05-28 17:42:44,949 - INFO - TokenUsageWorker - base_worker - run_loop - 131 - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-28 17:42:44,951 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 86 - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-28 17:42:44,951 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 94 - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-28 17:42:45,000 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 66 - Found 1 agents to potentially start.
2025-05-28 17:42:45,000 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 69 - Attempting to start agent: agent_airsoft_0faa9616
2025-05-28 17:42:45,001 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 73 - Agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:42:45,001 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 93 - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-28 17:42:45,001 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 109 - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-28 17:42:45,002 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 115 - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:42:45,003 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:42:45,003 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:42:45,004 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 153 - ProcessManager cleanup complete for startup function.
2025-05-28 17:42:45,004 - INFO - app.core.lifespan - lifespan - lifespan - 284 - Application startup sequence completed.
2025-05-28 17:42:54,952 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 96 - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-28 17:42:54,957 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 98 - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-28 17:42:54,957 - INFO - InactivityMonitorWorker - runnable_component - run - 111 - Component InactivityMonitorWorker (instance: 4456152000) setup complete. Starting run loop.
2025-05-28 17:42:54,957 - INFO - InactivityMonitorWorker - base_worker - run_loop - 258 - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-28 17:43:10,869 - INFO - app.core.lifespan - lifespan - lifespan - 287 - Application shutdown sequence initiated.
2025-05-28 17:43:10,870 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 230 - Stopping 3 background tasks...
2025-05-28 17:43:10,870 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task HistorySaverWorker...
2025-05-28 17:43:10,870 - INFO - HistorySaverWorker - runnable_component - run - 116 - Run_loop for HistorySaverWorker (instance: 4456152240) was cancelled.
2025-05-28 17:43:10,870 - INFO - HistorySaverWorker - runnable_component - run - 123 - Component HistorySaverWorker (instance: 4456152240) stopping. Performing cleanup...
2025-05-28 17:43:10,870 - INFO - HistorySaverWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:43:10,876 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for history_saver_worker as part of cleanup.
2025-05-28 17:43:10,877 - INFO - HistorySaverWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-28 17:43:10,877 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:43:10,877 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-28 17:43:10,877 - INFO - HistorySaverWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:43:10,878 - INFO - HistorySaverWorker - runnable_component - run - 128 - Component HistorySaverWorker (instance: 4456152240) cleanup complete.
2025-05-28 17:43:10,878 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task HistorySaverWorker finished after cancellation signal.
2025-05-28 17:43:10,878 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task TokenUsageWorker...
2025-05-28 17:43:10,878 - INFO - TokenUsageWorker - runnable_component - run - 116 - Run_loop for TokenUsageWorker (instance: 4456151664) was cancelled.
2025-05-28 17:43:10,878 - INFO - TokenUsageWorker - runnable_component - run - 123 - Component TokenUsageWorker (instance: 4456151664) stopping. Performing cleanup...
2025-05-28 17:43:10,878 - INFO - TokenUsageWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:43:10,883 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for token_usage_worker as part of cleanup.
2025-05-28 17:43:10,884 - INFO - TokenUsageWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-28 17:43:10,885 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:43:10,885 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-28 17:43:10,885 - INFO - TokenUsageWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:43:10,885 - INFO - TokenUsageWorker - runnable_component - run - 128 - Component TokenUsageWorker (instance: 4456151664) cleanup complete.
2025-05-28 17:43:10,885 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task TokenUsageWorker finished after cancellation signal.
2025-05-28 17:43:10,885 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task InactivityMonitorWorker...
2025-05-28 17:43:10,886 - INFO - InactivityMonitorWorker - runnable_component - run - 116 - Run_loop for InactivityMonitorWorker (instance: 4456152000) was cancelled.
2025-05-28 17:43:10,886 - INFO - InactivityMonitorWorker - runnable_component - run - 123 - Component InactivityMonitorWorker (instance: 4456152000) stopping. Performing cleanup...
2025-05-28 17:43:10,886 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 437 - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-28 17:43:10,886 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:43:10,886 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:43:10,886 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 441 - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-28 17:43:10,886 - INFO - InactivityMonitorWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:43:10,889 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-28 17:43:10,890 - INFO - InactivityMonitorWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-28 17:43:10,890 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:43:10,890 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-28 17:43:10,890 - INFO - InactivityMonitorWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:43:10,890 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 445 - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-28 17:43:10,890 - INFO - InactivityMonitorWorker - runnable_component - run - 128 - Component InactivityMonitorWorker (instance: 4456152000) cleanup complete.
2025-05-28 17:43:10,891 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-28 17:43:10,891 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 249 - All background tasks signaled to stop.
2025-05-28 17:43:10,891 - INFO - app.services.redis_service - redis_service - close_redis_pool - 43 - Redis connection pool closed successfully.
2025-05-28 17:43:10,897 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 17:43:10,897 - INFO - app.core.lifespan - lifespan - lifespan - 293 - Application shutdown sequence completed.
2025-05-28 17:43:11,343 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 17:43:11,343 - INFO - app.core.lifespan - lifespan - lifespan - 277 - Application startup sequence initiated.
2025-05-28 17:43:11,348 - INFO - app.services.redis_service - redis_service - init_redis_pool - 24 - Redis connection pool initialized successfully.
2025-05-28 17:43:11,348 - INFO - app.core.lifespan - lifespan - start_background_tasks - 172 - Starting background tasks...
2025-05-28 17:43:11,348 - INFO - app.core.lifespan - lifespan - start_background_tasks - 182 - History saver worker started, listening to queue: chat_history_queue
2025-05-28 17:43:11,348 - INFO - TokenUsageWorker - token_usage_worker - __init__ - 45 - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-28 17:43:11,348 - INFO - app.core.lifespan - lifespan - start_background_tasks - 194 - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-28 17:43:11,348 - INFO - app.core.lifespan - lifespan - start_background_tasks - 206 - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-28 17:43:11,348 - INFO - app.core.lifespan - lifespan - start_background_tasks - 210 - 3 background tasks initiated.
2025-05-28 17:43:11,348 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 51 - Attempting to start existing agents and their integrations...
2025-05-28 17:43:11,349 - INFO - HistorySaverWorker - base_worker - setup - 48 - [history_saver_worker] Worker setup started.
2025-05-28 17:43:11,349 - INFO - TokenUsageWorker - base_worker - setup - 48 - [token_usage_worker] Worker setup started.
2025-05-28 17:43:11,349 - INFO - InactivityMonitorWorker - base_worker - setup - 48 - [inactivity_monitor_worker] Worker setup started.
2025-05-28 17:43:11,353 - INFO - TokenUsageWorker - base_worker - setup - 52 - [token_usage_worker] Worker setup completed.
2025-05-28 17:43:11,353 - INFO - TokenUsageWorker - base_worker - setup - 114 - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-28 17:43:11,353 - INFO - InactivityMonitorWorker - base_worker - setup - 52 - [inactivity_monitor_worker] Worker setup completed.
2025-05-28 17:43:11,353 - INFO - InactivityMonitorWorker - base_worker - setup - 243 - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-28 17:43:11,353 - INFO - HistorySaverWorker - base_worker - setup - 52 - [history_saver_worker] Worker setup completed.
2025-05-28 17:43:11,353 - INFO - HistorySaverWorker - base_worker - setup - 114 - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-28 17:43:11,353 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 61 - ProcessManager setup complete for startup.
2025-05-28 17:43:11,355 - INFO - TokenUsageWorker - token_usage_worker - setup - 57 - [token_usage_worker] Database session factory initialized.
2025-05-28 17:43:11,355 - INFO - TokenUsageWorker - token_usage_worker - setup - 64 - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-28 17:43:11,355 - INFO - TokenUsageWorker - runnable_component - run - 111 - Component TokenUsageWorker (instance: 4605455312) setup complete. Starting run loop.
2025-05-28 17:43:11,355 - INFO - TokenUsageWorker - base_worker - run_loop - 131 - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-28 17:43:11,355 - INFO - HistorySaverWorker - history_saver_worker - setup - 49 - [history_saver_worker] Database session factory initialized.
2025-05-28 17:43:11,355 - INFO - HistorySaverWorker - runnable_component - run - 111 - Component HistorySaverWorker (instance: 4351644816) setup complete. Starting run loop.
2025-05-28 17:43:11,356 - INFO - HistorySaverWorker - base_worker - run_loop - 131 - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-28 17:43:11,357 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 86 - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-28 17:43:11,357 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 94 - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-28 17:43:11,403 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 66 - Found 1 agents to potentially start.
2025-05-28 17:43:11,403 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 69 - Attempting to start agent: agent_airsoft_0faa9616
2025-05-28 17:43:11,404 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 73 - Agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:43:11,404 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 93 - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-28 17:43:11,404 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 109 - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-28 17:43:11,405 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 115 - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:43:11,406 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:43:11,406 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:43:11,406 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 153 - ProcessManager cleanup complete for startup function.
2025-05-28 17:43:11,406 - INFO - app.core.lifespan - lifespan - lifespan - 284 - Application startup sequence completed.
2025-05-28 17:43:21,358 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 96 - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-28 17:43:21,362 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 98 - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-28 17:43:21,362 - INFO - InactivityMonitorWorker - runnable_component - run - 111 - Component InactivityMonitorWorker (instance: 4611325152) setup complete. Starting run loop.
2025-05-28 17:43:21,362 - INFO - InactivityMonitorWorker - base_worker - run_loop - 258 - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-28 17:43:21,866 - INFO - app.core.lifespan - lifespan - lifespan - 287 - Application shutdown sequence initiated.
2025-05-28 17:43:21,866 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 230 - Stopping 3 background tasks...
2025-05-28 17:43:21,866 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task HistorySaverWorker...
2025-05-28 17:43:21,866 - INFO - HistorySaverWorker - runnable_component - run - 116 - Run_loop for HistorySaverWorker (instance: 4351644816) was cancelled.
2025-05-28 17:43:21,866 - INFO - HistorySaverWorker - runnable_component - run - 123 - Component HistorySaverWorker (instance: 4351644816) stopping. Performing cleanup...
2025-05-28 17:43:21,866 - INFO - HistorySaverWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:43:21,872 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for history_saver_worker as part of cleanup.
2025-05-28 17:43:21,875 - INFO - HistorySaverWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-28 17:43:21,875 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:43:21,875 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-28 17:43:21,875 - INFO - HistorySaverWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:43:21,875 - INFO - HistorySaverWorker - runnable_component - run - 128 - Component HistorySaverWorker (instance: 4351644816) cleanup complete.
2025-05-28 17:43:21,875 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task HistorySaverWorker finished after cancellation signal.
2025-05-28 17:43:21,875 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task TokenUsageWorker...
2025-05-28 17:43:21,875 - INFO - TokenUsageWorker - runnable_component - run - 116 - Run_loop for TokenUsageWorker (instance: 4605455312) was cancelled.
2025-05-28 17:43:21,875 - INFO - TokenUsageWorker - runnable_component - run - 123 - Component TokenUsageWorker (instance: 4605455312) stopping. Performing cleanup...
2025-05-28 17:43:21,875 - INFO - TokenUsageWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:43:21,882 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for token_usage_worker as part of cleanup.
2025-05-28 17:43:21,882 - INFO - TokenUsageWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-28 17:43:21,883 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:43:21,883 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-28 17:43:21,883 - INFO - TokenUsageWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:43:21,883 - INFO - TokenUsageWorker - runnable_component - run - 128 - Component TokenUsageWorker (instance: 4605455312) cleanup complete.
2025-05-28 17:43:21,883 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task TokenUsageWorker finished after cancellation signal.
2025-05-28 17:43:21,883 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task InactivityMonitorWorker...
2025-05-28 17:43:21,883 - INFO - InactivityMonitorWorker - runnable_component - run - 116 - Run_loop for InactivityMonitorWorker (instance: 4611325152) was cancelled.
2025-05-28 17:43:21,883 - INFO - InactivityMonitorWorker - runnable_component - run - 123 - Component InactivityMonitorWorker (instance: 4611325152) stopping. Performing cleanup...
2025-05-28 17:43:21,883 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 437 - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-28 17:43:21,883 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:43:21,883 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:43:21,883 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 441 - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-28 17:43:21,883 - INFO - InactivityMonitorWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:43:21,885 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-28 17:43:21,886 - INFO - InactivityMonitorWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-28 17:43:21,886 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:43:21,886 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-28 17:43:21,887 - INFO - InactivityMonitorWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:43:21,887 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 445 - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-28 17:43:21,887 - INFO - InactivityMonitorWorker - runnable_component - run - 128 - Component InactivityMonitorWorker (instance: 4611325152) cleanup complete.
2025-05-28 17:43:21,887 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-28 17:43:21,887 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 249 - All background tasks signaled to stop.
2025-05-28 17:43:21,887 - INFO - app.services.redis_service - redis_service - close_redis_pool - 43 - Redis connection pool closed successfully.
2025-05-28 17:43:21,897 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 17:43:21,897 - INFO - app.core.lifespan - lifespan - lifespan - 293 - Application shutdown sequence completed.
2025-05-28 17:43:22,318 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 17:43:22,318 - INFO - app.core.lifespan - lifespan - lifespan - 277 - Application startup sequence initiated.
2025-05-28 17:43:22,323 - INFO - app.services.redis_service - redis_service - init_redis_pool - 24 - Redis connection pool initialized successfully.
2025-05-28 17:43:22,323 - INFO - app.core.lifespan - lifespan - start_background_tasks - 172 - Starting background tasks...
2025-05-28 17:43:22,323 - INFO - app.core.lifespan - lifespan - start_background_tasks - 182 - History saver worker started, listening to queue: chat_history_queue
2025-05-28 17:43:22,323 - INFO - TokenUsageWorker - token_usage_worker - __init__ - 45 - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-28 17:43:22,323 - INFO - app.core.lifespan - lifespan - start_background_tasks - 194 - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-28 17:43:22,323 - INFO - app.core.lifespan - lifespan - start_background_tasks - 206 - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-28 17:43:22,323 - INFO - app.core.lifespan - lifespan - start_background_tasks - 210 - 3 background tasks initiated.
2025-05-28 17:43:22,323 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 51 - Attempting to start existing agents and their integrations...
2025-05-28 17:43:22,324 - INFO - HistorySaverWorker - base_worker - setup - 48 - [history_saver_worker] Worker setup started.
2025-05-28 17:43:22,324 - INFO - TokenUsageWorker - base_worker - setup - 48 - [token_usage_worker] Worker setup started.
2025-05-28 17:43:22,324 - INFO - InactivityMonitorWorker - base_worker - setup - 48 - [inactivity_monitor_worker] Worker setup started.
2025-05-28 17:43:22,334 - INFO - InactivityMonitorWorker - base_worker - setup - 52 - [inactivity_monitor_worker] Worker setup completed.
2025-05-28 17:43:22,334 - INFO - InactivityMonitorWorker - base_worker - setup - 243 - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-28 17:43:22,334 - INFO - HistorySaverWorker - base_worker - setup - 52 - [history_saver_worker] Worker setup completed.
2025-05-28 17:43:22,334 - INFO - HistorySaverWorker - base_worker - setup - 114 - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-28 17:43:22,334 - INFO - TokenUsageWorker - base_worker - setup - 52 - [token_usage_worker] Worker setup completed.
2025-05-28 17:43:22,334 - INFO - TokenUsageWorker - base_worker - setup - 114 - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-28 17:43:22,334 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 61 - ProcessManager setup complete for startup.
2025-05-28 17:43:22,336 - INFO - TokenUsageWorker - token_usage_worker - setup - 57 - [token_usage_worker] Database session factory initialized.
2025-05-28 17:43:22,337 - INFO - HistorySaverWorker - history_saver_worker - setup - 49 - [history_saver_worker] Database session factory initialized.
2025-05-28 17:43:22,337 - INFO - HistorySaverWorker - runnable_component - run - 111 - Component HistorySaverWorker (instance: 4579884304) setup complete. Starting run loop.
2025-05-28 17:43:22,337 - INFO - HistorySaverWorker - base_worker - run_loop - 131 - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-28 17:43:22,337 - INFO - TokenUsageWorker - token_usage_worker - setup - 64 - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-28 17:43:22,337 - INFO - TokenUsageWorker - runnable_component - run - 111 - Component TokenUsageWorker (instance: 4579883824) setup complete. Starting run loop.
2025-05-28 17:43:22,337 - INFO - TokenUsageWorker - base_worker - run_loop - 131 - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-28 17:43:22,338 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 86 - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-28 17:43:22,338 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 94 - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-28 17:43:22,388 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 66 - Found 1 agents to potentially start.
2025-05-28 17:43:22,388 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 69 - Attempting to start agent: agent_airsoft_0faa9616
2025-05-28 17:43:22,389 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 73 - Agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:43:22,389 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 93 - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-28 17:43:22,389 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 109 - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-28 17:43:22,390 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 115 - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:43:22,391 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:43:22,391 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:43:22,391 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 153 - ProcessManager cleanup complete for startup function.
2025-05-28 17:43:22,391 - INFO - app.core.lifespan - lifespan - lifespan - 284 - Application startup sequence completed.
2025-05-28 17:43:30,742 - INFO - app.core.lifespan - lifespan - lifespan - 287 - Application shutdown sequence initiated.
2025-05-28 17:43:30,742 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 230 - Stopping 3 background tasks...
2025-05-28 17:43:30,742 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task HistorySaverWorker...
2025-05-28 17:43:30,743 - INFO - HistorySaverWorker - runnable_component - run - 116 - Run_loop for HistorySaverWorker (instance: 4579884304) was cancelled.
2025-05-28 17:43:30,743 - INFO - HistorySaverWorker - runnable_component - run - 123 - Component HistorySaverWorker (instance: 4579884304) stopping. Performing cleanup...
2025-05-28 17:43:30,743 - INFO - HistorySaverWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:43:30,746 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for history_saver_worker as part of cleanup.
2025-05-28 17:43:30,747 - INFO - HistorySaverWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-28 17:43:30,747 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:43:30,748 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-28 17:43:30,748 - INFO - HistorySaverWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:43:30,748 - INFO - HistorySaverWorker - runnable_component - run - 128 - Component HistorySaverWorker (instance: 4579884304) cleanup complete.
2025-05-28 17:43:30,748 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task HistorySaverWorker finished after cancellation signal.
2025-05-28 17:43:30,748 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task TokenUsageWorker...
2025-05-28 17:43:30,748 - INFO - TokenUsageWorker - runnable_component - run - 116 - Run_loop for TokenUsageWorker (instance: 4579883824) was cancelled.
2025-05-28 17:43:30,748 - INFO - TokenUsageWorker - runnable_component - run - 123 - Component TokenUsageWorker (instance: 4579883824) stopping. Performing cleanup...
2025-05-28 17:43:30,748 - INFO - TokenUsageWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:43:30,751 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for token_usage_worker as part of cleanup.
2025-05-28 17:43:30,751 - INFO - TokenUsageWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-28 17:43:30,751 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:43:30,752 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-28 17:43:30,752 - INFO - TokenUsageWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:43:30,752 - INFO - TokenUsageWorker - runnable_component - run - 128 - Component TokenUsageWorker (instance: 4579883824) cleanup complete.
2025-05-28 17:43:30,752 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task TokenUsageWorker finished after cancellation signal.
2025-05-28 17:43:30,752 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task InactivityMonitorWorker...
2025-05-28 17:43:30,752 - INFO - InactivityMonitorWorker - runnable_component - run - 116 - Run_loop for InactivityMonitorWorker (instance: 4579404464) was cancelled.
2025-05-28 17:43:30,752 - INFO - InactivityMonitorWorker - runnable_component - run - 123 - Component InactivityMonitorWorker (instance: 4579404464) stopping. Performing cleanup...
2025-05-28 17:43:30,752 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 437 - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-28 17:43:30,752 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:43:30,752 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:43:30,752 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 441 - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-28 17:43:30,752 - INFO - InactivityMonitorWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:43:30,754 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-28 17:43:30,754 - INFO - InactivityMonitorWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-28 17:43:30,754 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:43:30,755 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-28 17:43:30,755 - INFO - InactivityMonitorWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:43:30,755 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 445 - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-28 17:43:30,755 - INFO - InactivityMonitorWorker - runnable_component - run - 128 - Component InactivityMonitorWorker (instance: 4579404464) cleanup complete.
2025-05-28 17:43:30,755 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-28 17:43:30,755 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 249 - All background tasks signaled to stop.
2025-05-28 17:43:30,755 - INFO - app.services.redis_service - redis_service - close_redis_pool - 43 - Redis connection pool closed successfully.
2025-05-28 17:43:30,758 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 17:43:30,758 - INFO - app.core.lifespan - lifespan - lifespan - 293 - Application shutdown sequence completed.
2025-05-28 17:43:31,172 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 17:43:31,173 - INFO - app.core.lifespan - lifespan - lifespan - 277 - Application startup sequence initiated.
2025-05-28 17:43:31,177 - INFO - app.services.redis_service - redis_service - init_redis_pool - 24 - Redis connection pool initialized successfully.
2025-05-28 17:43:31,177 - INFO - app.core.lifespan - lifespan - start_background_tasks - 172 - Starting background tasks...
2025-05-28 17:43:31,177 - INFO - app.core.lifespan - lifespan - start_background_tasks - 182 - History saver worker started, listening to queue: chat_history_queue
2025-05-28 17:43:31,177 - INFO - TokenUsageWorker - token_usage_worker - __init__ - 45 - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-28 17:43:31,177 - INFO - app.core.lifespan - lifespan - start_background_tasks - 194 - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-28 17:43:31,178 - INFO - app.core.lifespan - lifespan - start_background_tasks - 206 - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-28 17:43:31,178 - INFO - app.core.lifespan - lifespan - start_background_tasks - 210 - 3 background tasks initiated.
2025-05-28 17:43:31,178 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 51 - Attempting to start existing agents and their integrations...
2025-05-28 17:43:31,178 - INFO - HistorySaverWorker - base_worker - setup - 48 - [history_saver_worker] Worker setup started.
2025-05-28 17:43:31,178 - INFO - TokenUsageWorker - base_worker - setup - 48 - [token_usage_worker] Worker setup started.
2025-05-28 17:43:31,178 - INFO - InactivityMonitorWorker - base_worker - setup - 48 - [inactivity_monitor_worker] Worker setup started.
2025-05-28 17:43:31,180 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 61 - ProcessManager setup complete for startup.
2025-05-28 17:43:31,182 - INFO - TokenUsageWorker - base_worker - setup - 52 - [token_usage_worker] Worker setup completed.
2025-05-28 17:43:31,182 - INFO - TokenUsageWorker - base_worker - setup - 114 - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-28 17:43:31,182 - INFO - InactivityMonitorWorker - base_worker - setup - 52 - [inactivity_monitor_worker] Worker setup completed.
2025-05-28 17:43:31,182 - INFO - InactivityMonitorWorker - base_worker - setup - 243 - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-28 17:43:31,182 - INFO - HistorySaverWorker - base_worker - setup - 52 - [history_saver_worker] Worker setup completed.
2025-05-28 17:43:31,182 - INFO - HistorySaverWorker - base_worker - setup - 114 - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-28 17:43:31,183 - INFO - TokenUsageWorker - token_usage_worker - setup - 57 - [token_usage_worker] Database session factory initialized.
2025-05-28 17:43:31,184 - INFO - HistorySaverWorker - history_saver_worker - setup - 49 - [history_saver_worker] Database session factory initialized.
2025-05-28 17:43:31,184 - INFO - HistorySaverWorker - runnable_component - run - 111 - Component HistorySaverWorker (instance: 4727723584) setup complete. Starting run loop.
2025-05-28 17:43:31,184 - INFO - HistorySaverWorker - base_worker - run_loop - 131 - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-28 17:43:31,184 - INFO - TokenUsageWorker - token_usage_worker - setup - 64 - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-28 17:43:31,184 - INFO - TokenUsageWorker - runnable_component - run - 111 - Component TokenUsageWorker (instance: 4727733136) setup complete. Starting run loop.
2025-05-28 17:43:31,184 - INFO - TokenUsageWorker - base_worker - run_loop - 131 - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-28 17:43:31,194 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 86 - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-28 17:43:31,195 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 94 - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-28 17:43:31,228 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 66 - Found 1 agents to potentially start.
2025-05-28 17:43:31,228 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 69 - Attempting to start agent: agent_airsoft_0faa9616
2025-05-28 17:43:31,229 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 73 - Agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:43:31,229 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 93 - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-28 17:43:31,229 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 109 - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-28 17:43:31,229 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 115 - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:43:31,230 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:43:31,230 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:43:31,230 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 153 - ProcessManager cleanup complete for startup function.
2025-05-28 17:43:31,230 - INFO - app.core.lifespan - lifespan - lifespan - 284 - Application startup sequence completed.
2025-05-28 17:43:41,195 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 96 - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-28 17:43:41,199 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 98 - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-28 17:43:41,199 - INFO - InactivityMonitorWorker - runnable_component - run - 111 - Component InactivityMonitorWorker (instance: 4727733280) setup complete. Starting run loop.
2025-05-28 17:43:41,199 - INFO - InactivityMonitorWorker - base_worker - run_loop - 258 - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-28 17:48:04,894 - INFO - app.core.lifespan - lifespan - lifespan - 287 - Application shutdown sequence initiated.
2025-05-28 17:48:04,894 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 230 - Stopping 3 background tasks...
2025-05-28 17:48:04,894 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task HistorySaverWorker...
2025-05-28 17:48:04,895 - INFO - HistorySaverWorker - runnable_component - run - 116 - Run_loop for HistorySaverWorker (instance: 4727723584) was cancelled.
2025-05-28 17:48:04,895 - INFO - HistorySaverWorker - runnable_component - run - 123 - Component HistorySaverWorker (instance: 4727723584) stopping. Performing cleanup...
2025-05-28 17:48:04,895 - INFO - HistorySaverWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:48:04,900 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for history_saver_worker as part of cleanup.
2025-05-28 17:48:04,901 - INFO - HistorySaverWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-28 17:48:04,901 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:48:04,901 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-28 17:48:04,901 - INFO - HistorySaverWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:48:04,901 - INFO - HistorySaverWorker - runnable_component - run - 128 - Component HistorySaverWorker (instance: 4727723584) cleanup complete.
2025-05-28 17:48:04,901 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task HistorySaverWorker finished after cancellation signal.
2025-05-28 17:48:04,901 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task TokenUsageWorker...
2025-05-28 17:48:04,902 - INFO - TokenUsageWorker - runnable_component - run - 116 - Run_loop for TokenUsageWorker (instance: 4727733136) was cancelled.
2025-05-28 17:48:04,902 - INFO - TokenUsageWorker - runnable_component - run - 123 - Component TokenUsageWorker (instance: 4727733136) stopping. Performing cleanup...
2025-05-28 17:48:04,902 - INFO - TokenUsageWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:48:04,905 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for token_usage_worker as part of cleanup.
2025-05-28 17:48:04,906 - INFO - TokenUsageWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-28 17:48:04,906 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:48:04,906 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-28 17:48:04,906 - INFO - TokenUsageWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:48:04,906 - INFO - TokenUsageWorker - runnable_component - run - 128 - Component TokenUsageWorker (instance: 4727733136) cleanup complete.
2025-05-28 17:48:04,906 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task TokenUsageWorker finished after cancellation signal.
2025-05-28 17:48:04,906 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task InactivityMonitorWorker...
2025-05-28 17:48:04,907 - INFO - InactivityMonitorWorker - runnable_component - run - 116 - Run_loop for InactivityMonitorWorker (instance: 4727733280) was cancelled.
2025-05-28 17:48:04,907 - INFO - InactivityMonitorWorker - runnable_component - run - 123 - Component InactivityMonitorWorker (instance: 4727733280) stopping. Performing cleanup...
2025-05-28 17:48:04,907 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 437 - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-28 17:48:04,907 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:48:04,907 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:48:04,907 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 441 - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-28 17:48:04,907 - INFO - InactivityMonitorWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:48:04,910 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-28 17:48:04,911 - INFO - InactivityMonitorWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-28 17:48:04,911 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:48:04,912 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-28 17:48:04,913 - INFO - InactivityMonitorWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:48:04,913 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 445 - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-28 17:48:04,913 - INFO - InactivityMonitorWorker - runnable_component - run - 128 - Component InactivityMonitorWorker (instance: 4727733280) cleanup complete.
2025-05-28 17:48:04,913 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-28 17:48:04,913 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 249 - All background tasks signaled to stop.
2025-05-28 17:48:04,913 - INFO - app.services.redis_service - redis_service - close_redis_pool - 43 - Redis connection pool closed successfully.
2025-05-28 17:48:04,924 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 17:48:04,924 - INFO - app.core.lifespan - lifespan - lifespan - 293 - Application shutdown sequence completed.
2025-05-28 17:48:05,417 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 17:48:05,417 - INFO - app.core.lifespan - lifespan - lifespan - 277 - Application startup sequence initiated.
2025-05-28 17:48:05,423 - INFO - app.services.redis_service - redis_service - init_redis_pool - 24 - Redis connection pool initialized successfully.
2025-05-28 17:48:05,423 - INFO - app.core.lifespan - lifespan - start_background_tasks - 172 - Starting background tasks...
2025-05-28 17:48:05,423 - INFO - app.core.lifespan - lifespan - start_background_tasks - 182 - History saver worker started, listening to queue: chat_history_queue
2025-05-28 17:48:05,423 - INFO - TokenUsageWorker - token_usage_worker - __init__ - 45 - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-28 17:48:05,423 - INFO - app.core.lifespan - lifespan - start_background_tasks - 194 - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-28 17:48:05,423 - INFO - app.core.lifespan - lifespan - start_background_tasks - 206 - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-28 17:48:05,423 - INFO - app.core.lifespan - lifespan - start_background_tasks - 210 - 3 background tasks initiated.
2025-05-28 17:48:05,423 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 51 - Attempting to start existing agents and their integrations...
2025-05-28 17:48:05,424 - INFO - HistorySaverWorker - base_worker - setup - 48 - [history_saver_worker] Worker setup started.
2025-05-28 17:48:05,424 - INFO - TokenUsageWorker - base_worker - setup - 48 - [token_usage_worker] Worker setup started.
2025-05-28 17:48:05,424 - INFO - InactivityMonitorWorker - base_worker - setup - 48 - [inactivity_monitor_worker] Worker setup started.
2025-05-28 17:48:05,426 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 61 - ProcessManager setup complete for startup.
2025-05-28 17:48:05,427 - INFO - HistorySaverWorker - base_worker - setup - 52 - [history_saver_worker] Worker setup completed.
2025-05-28 17:48:05,427 - INFO - HistorySaverWorker - base_worker - setup - 114 - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-28 17:48:05,427 - INFO - InactivityMonitorWorker - base_worker - setup - 52 - [inactivity_monitor_worker] Worker setup completed.
2025-05-28 17:48:05,427 - INFO - InactivityMonitorWorker - base_worker - setup - 243 - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-28 17:48:05,427 - INFO - TokenUsageWorker - base_worker - setup - 52 - [token_usage_worker] Worker setup completed.
2025-05-28 17:48:05,427 - INFO - TokenUsageWorker - base_worker - setup - 114 - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-28 17:48:05,428 - INFO - TokenUsageWorker - token_usage_worker - setup - 57 - [token_usage_worker] Database session factory initialized.
2025-05-28 17:48:05,429 - INFO - HistorySaverWorker - history_saver_worker - setup - 49 - [history_saver_worker] Database session factory initialized.
2025-05-28 17:48:05,429 - INFO - HistorySaverWorker - runnable_component - run - 111 - Component HistorySaverWorker (instance: 4423759248) setup complete. Starting run loop.
2025-05-28 17:48:05,429 - INFO - HistorySaverWorker - base_worker - run_loop - 131 - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-28 17:48:05,430 - INFO - TokenUsageWorker - token_usage_worker - setup - 64 - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-28 17:48:05,430 - INFO - TokenUsageWorker - runnable_component - run - 111 - Component TokenUsageWorker (instance: 4424415760) setup complete. Starting run loop.
2025-05-28 17:48:05,430 - INFO - TokenUsageWorker - base_worker - run_loop - 131 - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-28 17:48:05,432 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 86 - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-28 17:48:05,432 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 94 - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-28 17:48:05,479 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 66 - Found 1 agents to potentially start.
2025-05-28 17:48:05,479 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 69 - Attempting to start agent: agent_airsoft_0faa9616
2025-05-28 17:48:05,480 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 73 - Agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:48:05,480 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 93 - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-28 17:48:05,480 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 109 - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-28 17:48:05,481 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 115 - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:48:05,481 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:48:05,481 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:48:05,481 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 153 - ProcessManager cleanup complete for startup function.
2025-05-28 17:48:05,481 - INFO - app.core.lifespan - lifespan - lifespan - 284 - Application startup sequence completed.
2025-05-28 17:48:15,432 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 96 - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-28 17:48:15,436 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 98 - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-28 17:48:15,436 - INFO - InactivityMonitorWorker - runnable_component - run - 111 - Component InactivityMonitorWorker (instance: 4424415904) setup complete. Starting run loop.
2025-05-28 17:48:15,436 - INFO - InactivityMonitorWorker - base_worker - run_loop - 258 - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-28 17:49:16,839 - INFO - app.core.lifespan - lifespan - lifespan - 287 - Application shutdown sequence initiated.
2025-05-28 17:49:16,840 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 230 - Stopping 3 background tasks...
2025-05-28 17:49:16,840 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task HistorySaverWorker...
2025-05-28 17:49:16,840 - INFO - HistorySaverWorker - runnable_component - run - 116 - Run_loop for HistorySaverWorker (instance: 4423759248) was cancelled.
2025-05-28 17:49:16,840 - INFO - HistorySaverWorker - runnable_component - run - 123 - Component HistorySaverWorker (instance: 4423759248) stopping. Performing cleanup...
2025-05-28 17:49:16,840 - INFO - HistorySaverWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:49:16,845 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for history_saver_worker as part of cleanup.
2025-05-28 17:49:16,846 - INFO - HistorySaverWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-28 17:49:16,846 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:49:16,846 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-28 17:49:16,846 - INFO - HistorySaverWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:49:16,846 - INFO - HistorySaverWorker - runnable_component - run - 128 - Component HistorySaverWorker (instance: 4423759248) cleanup complete.
2025-05-28 17:49:16,846 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task HistorySaverWorker finished after cancellation signal.
2025-05-28 17:49:16,846 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task TokenUsageWorker...
2025-05-28 17:49:16,847 - INFO - TokenUsageWorker - runnable_component - run - 116 - Run_loop for TokenUsageWorker (instance: 4424415760) was cancelled.
2025-05-28 17:49:16,847 - INFO - TokenUsageWorker - runnable_component - run - 123 - Component TokenUsageWorker (instance: 4424415760) stopping. Performing cleanup...
2025-05-28 17:49:16,847 - INFO - TokenUsageWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:49:16,850 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for token_usage_worker as part of cleanup.
2025-05-28 17:49:16,850 - INFO - TokenUsageWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-28 17:49:16,850 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:49:16,851 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-28 17:49:16,851 - INFO - TokenUsageWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:49:16,851 - INFO - TokenUsageWorker - runnable_component - run - 128 - Component TokenUsageWorker (instance: 4424415760) cleanup complete.
2025-05-28 17:49:16,851 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task TokenUsageWorker finished after cancellation signal.
2025-05-28 17:49:16,851 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task InactivityMonitorWorker...
2025-05-28 17:49:16,851 - INFO - InactivityMonitorWorker - runnable_component - run - 116 - Run_loop for InactivityMonitorWorker (instance: 4424415904) was cancelled.
2025-05-28 17:49:16,851 - INFO - InactivityMonitorWorker - runnable_component - run - 123 - Component InactivityMonitorWorker (instance: 4424415904) stopping. Performing cleanup...
2025-05-28 17:49:16,851 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 437 - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-28 17:49:16,851 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:49:16,851 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:49:16,851 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 441 - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-28 17:49:16,851 - INFO - InactivityMonitorWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:49:16,853 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-28 17:49:16,854 - INFO - InactivityMonitorWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-28 17:49:16,854 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:49:16,854 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-28 17:49:16,854 - INFO - InactivityMonitorWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:49:16,854 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 445 - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-28 17:49:16,854 - INFO - InactivityMonitorWorker - runnable_component - run - 128 - Component InactivityMonitorWorker (instance: 4424415904) cleanup complete.
2025-05-28 17:49:16,854 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-28 17:49:16,854 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 249 - All background tasks signaled to stop.
2025-05-28 17:49:16,854 - INFO - app.services.redis_service - redis_service - close_redis_pool - 43 - Redis connection pool closed successfully.
2025-05-28 17:49:16,859 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 17:49:16,859 - INFO - app.core.lifespan - lifespan - lifespan - 293 - Application shutdown sequence completed.
2025-05-28 17:49:17,354 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 17:49:17,355 - INFO - app.core.lifespan - lifespan - lifespan - 277 - Application startup sequence initiated.
2025-05-28 17:49:17,360 - INFO - app.services.redis_service - redis_service - init_redis_pool - 24 - Redis connection pool initialized successfully.
2025-05-28 17:49:17,360 - INFO - app.core.lifespan - lifespan - start_background_tasks - 172 - Starting background tasks...
2025-05-28 17:49:17,360 - INFO - app.core.lifespan - lifespan - start_background_tasks - 182 - History saver worker started, listening to queue: chat_history_queue
2025-05-28 17:49:17,360 - INFO - TokenUsageWorker - token_usage_worker - __init__ - 45 - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-28 17:49:17,360 - INFO - app.core.lifespan - lifespan - start_background_tasks - 194 - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-28 17:49:17,361 - INFO - app.core.lifespan - lifespan - start_background_tasks - 206 - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-28 17:49:17,361 - INFO - app.core.lifespan - lifespan - start_background_tasks - 210 - 3 background tasks initiated.
2025-05-28 17:49:17,361 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 51 - Attempting to start existing agents and their integrations...
2025-05-28 17:49:17,361 - INFO - HistorySaverWorker - base_worker - setup - 48 - [history_saver_worker] Worker setup started.
2025-05-28 17:49:17,361 - INFO - TokenUsageWorker - base_worker - setup - 48 - [token_usage_worker] Worker setup started.
2025-05-28 17:49:17,361 - INFO - InactivityMonitorWorker - base_worker - setup - 48 - [inactivity_monitor_worker] Worker setup started.
2025-05-28 17:49:17,363 - INFO - HistorySaverWorker - base_worker - setup - 52 - [history_saver_worker] Worker setup completed.
2025-05-28 17:49:17,363 - INFO - HistorySaverWorker - base_worker - setup - 114 - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-28 17:49:17,363 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 61 - ProcessManager setup complete for startup.
2025-05-28 17:49:17,364 - INFO - TokenUsageWorker - base_worker - setup - 52 - [token_usage_worker] Worker setup completed.
2025-05-28 17:49:17,364 - INFO - TokenUsageWorker - base_worker - setup - 114 - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-28 17:49:17,365 - INFO - InactivityMonitorWorker - base_worker - setup - 52 - [inactivity_monitor_worker] Worker setup completed.
2025-05-28 17:49:17,365 - INFO - InactivityMonitorWorker - base_worker - setup - 243 - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-28 17:49:17,365 - INFO - HistorySaverWorker - history_saver_worker - setup - 49 - [history_saver_worker] Database session factory initialized.
2025-05-28 17:49:17,365 - INFO - HistorySaverWorker - runnable_component - run - 111 - Component HistorySaverWorker (instance: 4368519040) setup complete. Starting run loop.
2025-05-28 17:49:17,365 - INFO - HistorySaverWorker - base_worker - run_loop - 131 - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-28 17:49:17,365 - INFO - TokenUsageWorker - token_usage_worker - setup - 57 - [token_usage_worker] Database session factory initialized.
2025-05-28 17:49:17,366 - INFO - TokenUsageWorker - token_usage_worker - setup - 64 - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-28 17:49:17,366 - INFO - TokenUsageWorker - runnable_component - run - 111 - Component TokenUsageWorker (instance: 4370380800) setup complete. Starting run loop.
2025-05-28 17:49:17,366 - INFO - TokenUsageWorker - base_worker - run_loop - 131 - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-28 17:49:17,369 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 86 - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-28 17:49:17,369 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 94 - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-28 17:49:17,415 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 66 - Found 1 agents to potentially start.
2025-05-28 17:49:17,415 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 69 - Attempting to start agent: agent_airsoft_0faa9616
2025-05-28 17:49:17,416 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 73 - Agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:49:17,416 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 93 - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-28 17:49:17,416 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 109 - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-28 17:49:17,417 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 115 - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:49:17,418 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:49:17,418 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:49:17,418 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 153 - ProcessManager cleanup complete for startup function.
2025-05-28 17:49:17,418 - INFO - app.core.lifespan - lifespan - lifespan - 284 - Application startup sequence completed.
2025-05-28 17:49:27,368 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 96 - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-28 17:49:27,373 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 98 - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-28 17:49:27,373 - INFO - InactivityMonitorWorker - runnable_component - run - 111 - Component InactivityMonitorWorker (instance: 4371036352) setup complete. Starting run loop.
2025-05-28 17:49:27,373 - INFO - InactivityMonitorWorker - base_worker - run_loop - 258 - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-28 17:50:21,420 - INFO - app.core.lifespan - lifespan - lifespan - 287 - Application shutdown sequence initiated.
2025-05-28 17:50:21,420 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 230 - Stopping 3 background tasks...
2025-05-28 17:50:21,420 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task HistorySaverWorker...
2025-05-28 17:50:21,420 - INFO - HistorySaverWorker - runnable_component - run - 116 - Run_loop for HistorySaverWorker (instance: 4368519040) was cancelled.
2025-05-28 17:50:21,420 - INFO - HistorySaverWorker - runnable_component - run - 123 - Component HistorySaverWorker (instance: 4368519040) stopping. Performing cleanup...
2025-05-28 17:50:21,420 - INFO - HistorySaverWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:50:21,425 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for history_saver_worker as part of cleanup.
2025-05-28 17:50:21,426 - INFO - HistorySaverWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-28 17:50:21,426 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:50:21,426 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-28 17:50:21,426 - INFO - HistorySaverWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:50:21,426 - INFO - HistorySaverWorker - runnable_component - run - 128 - Component HistorySaverWorker (instance: 4368519040) cleanup complete.
2025-05-28 17:50:21,426 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task HistorySaverWorker finished after cancellation signal.
2025-05-28 17:50:21,426 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task TokenUsageWorker...
2025-05-28 17:50:21,426 - INFO - TokenUsageWorker - runnable_component - run - 116 - Run_loop for TokenUsageWorker (instance: 4370380800) was cancelled.
2025-05-28 17:50:21,426 - INFO - TokenUsageWorker - runnable_component - run - 123 - Component TokenUsageWorker (instance: 4370380800) stopping. Performing cleanup...
2025-05-28 17:50:21,427 - INFO - TokenUsageWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:50:21,430 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for token_usage_worker as part of cleanup.
2025-05-28 17:50:21,431 - INFO - TokenUsageWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-28 17:50:21,431 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:50:21,431 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-28 17:50:21,431 - INFO - TokenUsageWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:50:21,431 - INFO - TokenUsageWorker - runnable_component - run - 128 - Component TokenUsageWorker (instance: 4370380800) cleanup complete.
2025-05-28 17:50:21,431 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task TokenUsageWorker finished after cancellation signal.
2025-05-28 17:50:21,431 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task InactivityMonitorWorker...
2025-05-28 17:50:21,432 - INFO - InactivityMonitorWorker - runnable_component - run - 116 - Run_loop for InactivityMonitorWorker (instance: 4371036352) was cancelled.
2025-05-28 17:50:21,432 - INFO - InactivityMonitorWorker - runnable_component - run - 123 - Component InactivityMonitorWorker (instance: 4371036352) stopping. Performing cleanup...
2025-05-28 17:50:21,432 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 437 - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-28 17:50:21,432 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:50:21,432 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:50:21,432 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 441 - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-28 17:50:21,432 - INFO - InactivityMonitorWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:50:21,434 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-28 17:50:21,435 - INFO - InactivityMonitorWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-28 17:50:21,435 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:50:21,435 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-28 17:50:21,435 - INFO - InactivityMonitorWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:50:21,435 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 445 - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-28 17:50:21,435 - INFO - InactivityMonitorWorker - runnable_component - run - 128 - Component InactivityMonitorWorker (instance: 4371036352) cleanup complete.
2025-05-28 17:50:21,435 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-28 17:50:21,435 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 249 - All background tasks signaled to stop.
2025-05-28 17:50:21,435 - INFO - app.services.redis_service - redis_service - close_redis_pool - 43 - Redis connection pool closed successfully.
2025-05-28 17:50:21,439 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 17:50:21,439 - INFO - app.core.lifespan - lifespan - lifespan - 293 - Application shutdown sequence completed.
2025-05-28 17:50:21,918 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 17:50:21,918 - INFO - app.core.lifespan - lifespan - lifespan - 277 - Application startup sequence initiated.
2025-05-28 17:50:21,924 - INFO - app.services.redis_service - redis_service - init_redis_pool - 24 - Redis connection pool initialized successfully.
2025-05-28 17:50:21,924 - INFO - app.core.lifespan - lifespan - start_background_tasks - 172 - Starting background tasks...
2025-05-28 17:50:21,924 - INFO - app.core.lifespan - lifespan - start_background_tasks - 182 - History saver worker started, listening to queue: chat_history_queue
2025-05-28 17:50:21,924 - INFO - TokenUsageWorker - token_usage_worker - __init__ - 45 - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-28 17:50:21,924 - INFO - app.core.lifespan - lifespan - start_background_tasks - 194 - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-28 17:50:21,924 - INFO - app.core.lifespan - lifespan - start_background_tasks - 206 - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-28 17:50:21,924 - INFO - app.core.lifespan - lifespan - start_background_tasks - 210 - 3 background tasks initiated.
2025-05-28 17:50:21,924 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 51 - Attempting to start existing agents and their integrations...
2025-05-28 17:50:21,924 - INFO - HistorySaverWorker - base_worker - setup - 48 - [history_saver_worker] Worker setup started.
2025-05-28 17:50:21,925 - INFO - TokenUsageWorker - base_worker - setup - 48 - [token_usage_worker] Worker setup started.
2025-05-28 17:50:21,925 - INFO - InactivityMonitorWorker - base_worker - setup - 48 - [inactivity_monitor_worker] Worker setup started.
2025-05-28 17:50:21,926 - INFO - HistorySaverWorker - base_worker - setup - 52 - [history_saver_worker] Worker setup completed.
2025-05-28 17:50:21,926 - INFO - HistorySaverWorker - base_worker - setup - 114 - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-28 17:50:21,926 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 61 - ProcessManager setup complete for startup.
2025-05-28 17:50:21,927 - INFO - InactivityMonitorWorker - base_worker - setup - 52 - [inactivity_monitor_worker] Worker setup completed.
2025-05-28 17:50:21,927 - INFO - InactivityMonitorWorker - base_worker - setup - 243 - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-28 17:50:21,928 - INFO - TokenUsageWorker - base_worker - setup - 52 - [token_usage_worker] Worker setup completed.
2025-05-28 17:50:21,928 - INFO - TokenUsageWorker - base_worker - setup - 114 - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-28 17:50:21,928 - INFO - HistorySaverWorker - history_saver_worker - setup - 49 - [history_saver_worker] Database session factory initialized.
2025-05-28 17:50:21,928 - INFO - HistorySaverWorker - runnable_component - run - 111 - Component HistorySaverWorker (instance: 4404159136) setup complete. Starting run loop.
2025-05-28 17:50:21,928 - INFO - HistorySaverWorker - base_worker - run_loop - 131 - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-28 17:50:21,929 - INFO - TokenUsageWorker - token_usage_worker - setup - 57 - [token_usage_worker] Database session factory initialized.
2025-05-28 17:50:21,930 - INFO - TokenUsageWorker - token_usage_worker - setup - 64 - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-28 17:50:21,930 - INFO - TokenUsageWorker - runnable_component - run - 111 - Component TokenUsageWorker (instance: 4417911888) setup complete. Starting run loop.
2025-05-28 17:50:21,930 - INFO - TokenUsageWorker - base_worker - run_loop - 131 - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-28 17:50:21,930 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 86 - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-28 17:50:21,930 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 94 - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-28 17:50:21,973 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 66 - Found 1 agents to potentially start.
2025-05-28 17:50:21,973 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 69 - Attempting to start agent: agent_airsoft_0faa9616
2025-05-28 17:50:21,974 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 73 - Agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:50:21,974 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 93 - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-28 17:50:21,974 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 109 - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-28 17:50:21,975 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 115 - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:50:21,976 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:50:21,976 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:50:21,976 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 153 - ProcessManager cleanup complete for startup function.
2025-05-28 17:50:21,976 - INFO - app.core.lifespan - lifespan - lifespan - 284 - Application startup sequence completed.
2025-05-28 17:50:31,931 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 96 - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-28 17:50:31,936 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 98 - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-28 17:50:31,936 - INFO - InactivityMonitorWorker - runnable_component - run - 111 - Component InactivityMonitorWorker (instance: 4417900752) setup complete. Starting run loop.
2025-05-28 17:50:31,936 - INFO - InactivityMonitorWorker - base_worker - run_loop - 258 - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-28 17:50:51,669 - INFO - app.core.lifespan - lifespan - lifespan - 287 - Application shutdown sequence initiated.
2025-05-28 17:50:51,669 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 230 - Stopping 3 background tasks...
2025-05-28 17:50:51,669 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task HistorySaverWorker...
2025-05-28 17:50:51,669 - INFO - HistorySaverWorker - runnable_component - run - 116 - Run_loop for HistorySaverWorker (instance: 4404159136) was cancelled.
2025-05-28 17:50:51,669 - INFO - HistorySaverWorker - runnable_component - run - 123 - Component HistorySaverWorker (instance: 4404159136) stopping. Performing cleanup...
2025-05-28 17:50:51,669 - INFO - HistorySaverWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:50:51,673 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for history_saver_worker as part of cleanup.
2025-05-28 17:50:51,674 - INFO - HistorySaverWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-28 17:50:51,674 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:50:51,674 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-28 17:50:51,674 - INFO - HistorySaverWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:50:51,674 - INFO - HistorySaverWorker - runnable_component - run - 128 - Component HistorySaverWorker (instance: 4404159136) cleanup complete.
2025-05-28 17:50:51,674 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task HistorySaverWorker finished after cancellation signal.
2025-05-28 17:50:51,674 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task TokenUsageWorker...
2025-05-28 17:50:51,674 - INFO - TokenUsageWorker - runnable_component - run - 116 - Run_loop for TokenUsageWorker (instance: 4417911888) was cancelled.
2025-05-28 17:50:51,674 - INFO - TokenUsageWorker - runnable_component - run - 123 - Component TokenUsageWorker (instance: 4417911888) stopping. Performing cleanup...
2025-05-28 17:50:51,674 - INFO - TokenUsageWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:50:51,678 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for token_usage_worker as part of cleanup.
2025-05-28 17:50:51,681 - INFO - TokenUsageWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-28 17:50:51,681 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:50:51,681 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-28 17:50:51,681 - INFO - TokenUsageWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:50:51,681 - INFO - TokenUsageWorker - runnable_component - run - 128 - Component TokenUsageWorker (instance: 4417911888) cleanup complete.
2025-05-28 17:50:51,681 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task TokenUsageWorker finished after cancellation signal.
2025-05-28 17:50:51,681 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task InactivityMonitorWorker...
2025-05-28 17:50:51,681 - INFO - InactivityMonitorWorker - runnable_component - run - 116 - Run_loop for InactivityMonitorWorker (instance: 4417900752) was cancelled.
2025-05-28 17:50:51,682 - INFO - InactivityMonitorWorker - runnable_component - run - 123 - Component InactivityMonitorWorker (instance: 4417900752) stopping. Performing cleanup...
2025-05-28 17:50:51,682 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 437 - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-28 17:50:51,682 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:50:51,682 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:50:51,682 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 441 - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-28 17:50:51,683 - INFO - InactivityMonitorWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:50:51,686 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-28 17:50:51,687 - INFO - InactivityMonitorWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-28 17:50:51,687 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:50:51,687 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-28 17:50:51,687 - INFO - InactivityMonitorWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:50:51,687 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 445 - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-28 17:50:51,687 - INFO - InactivityMonitorWorker - runnable_component - run - 128 - Component InactivityMonitorWorker (instance: 4417900752) cleanup complete.
2025-05-28 17:50:51,687 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-28 17:50:51,687 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 249 - All background tasks signaled to stop.
2025-05-28 17:50:51,687 - INFO - app.services.redis_service - redis_service - close_redis_pool - 43 - Redis connection pool closed successfully.
2025-05-28 17:50:51,692 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 17:50:51,692 - INFO - app.core.lifespan - lifespan - lifespan - 293 - Application shutdown sequence completed.
2025-05-28 17:50:52,173 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 17:50:52,173 - INFO - app.core.lifespan - lifespan - lifespan - 277 - Application startup sequence initiated.
2025-05-28 17:50:52,179 - INFO - app.services.redis_service - redis_service - init_redis_pool - 24 - Redis connection pool initialized successfully.
2025-05-28 17:50:52,179 - INFO - app.core.lifespan - lifespan - start_background_tasks - 172 - Starting background tasks...
2025-05-28 17:50:52,179 - INFO - app.core.lifespan - lifespan - start_background_tasks - 182 - History saver worker started, listening to queue: chat_history_queue
2025-05-28 17:50:52,179 - INFO - TokenUsageWorker - token_usage_worker - __init__ - 45 - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-28 17:50:52,179 - INFO - app.core.lifespan - lifespan - start_background_tasks - 194 - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-28 17:50:52,180 - INFO - app.core.lifespan - lifespan - start_background_tasks - 206 - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-28 17:50:52,180 - INFO - app.core.lifespan - lifespan - start_background_tasks - 210 - 3 background tasks initiated.
2025-05-28 17:50:52,180 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 51 - Attempting to start existing agents and their integrations...
2025-05-28 17:50:52,180 - INFO - HistorySaverWorker - base_worker - setup - 48 - [history_saver_worker] Worker setup started.
2025-05-28 17:50:52,180 - INFO - TokenUsageWorker - base_worker - setup - 48 - [token_usage_worker] Worker setup started.
2025-05-28 17:50:52,180 - INFO - InactivityMonitorWorker - base_worker - setup - 48 - [inactivity_monitor_worker] Worker setup started.
2025-05-28 17:50:52,183 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 61 - ProcessManager setup complete for startup.
2025-05-28 17:50:52,185 - INFO - HistorySaverWorker - base_worker - setup - 52 - [history_saver_worker] Worker setup completed.
2025-05-28 17:50:52,185 - INFO - HistorySaverWorker - base_worker - setup - 114 - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-28 17:50:52,185 - INFO - TokenUsageWorker - base_worker - setup - 52 - [token_usage_worker] Worker setup completed.
2025-05-28 17:50:52,185 - INFO - TokenUsageWorker - base_worker - setup - 114 - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-28 17:50:52,185 - INFO - InactivityMonitorWorker - base_worker - setup - 52 - [inactivity_monitor_worker] Worker setup completed.
2025-05-28 17:50:52,185 - INFO - InactivityMonitorWorker - base_worker - setup - 243 - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-28 17:50:52,186 - INFO - HistorySaverWorker - history_saver_worker - setup - 49 - [history_saver_worker] Database session factory initialized.
2025-05-28 17:50:52,186 - INFO - HistorySaverWorker - runnable_component - run - 111 - Component HistorySaverWorker (instance: 4414294928) setup complete. Starting run loop.
2025-05-28 17:50:52,186 - INFO - HistorySaverWorker - base_worker - run_loop - 131 - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-28 17:50:52,186 - INFO - TokenUsageWorker - token_usage_worker - setup - 57 - [token_usage_worker] Database session factory initialized.
2025-05-28 17:50:52,187 - INFO - TokenUsageWorker - token_usage_worker - setup - 64 - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-28 17:50:52,187 - INFO - TokenUsageWorker - runnable_component - run - 111 - Component TokenUsageWorker (instance: 4414004288) setup complete. Starting run loop.
2025-05-28 17:50:52,187 - INFO - TokenUsageWorker - base_worker - run_loop - 131 - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-28 17:50:52,188 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 86 - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-28 17:50:52,188 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 94 - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-28 17:50:52,234 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 66 - Found 1 agents to potentially start.
2025-05-28 17:50:52,234 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 69 - Attempting to start agent: agent_airsoft_0faa9616
2025-05-28 17:50:52,235 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 73 - Agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:50:52,235 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 93 - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-28 17:50:52,235 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 109 - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-28 17:50:52,237 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 115 - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:50:52,237 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:50:52,237 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:50:52,237 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 153 - ProcessManager cleanup complete for startup function.
2025-05-28 17:50:52,237 - INFO - app.core.lifespan - lifespan - lifespan - 284 - Application startup sequence completed.
2025-05-28 17:50:59,982 - INFO - app.core.lifespan - lifespan - lifespan - 287 - Application shutdown sequence initiated.
2025-05-28 17:50:59,982 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 230 - Stopping 3 background tasks...
2025-05-28 17:50:59,982 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task HistorySaverWorker...
2025-05-28 17:50:59,982 - INFO - HistorySaverWorker - runnable_component - run - 116 - Run_loop for HistorySaverWorker (instance: 4414294928) was cancelled.
2025-05-28 17:50:59,982 - INFO - HistorySaverWorker - runnable_component - run - 123 - Component HistorySaverWorker (instance: 4414294928) stopping. Performing cleanup...
2025-05-28 17:50:59,982 - INFO - HistorySaverWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:50:59,987 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for history_saver_worker as part of cleanup.
2025-05-28 17:50:59,988 - INFO - HistorySaverWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-28 17:50:59,988 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:50:59,988 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-28 17:50:59,988 - INFO - HistorySaverWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:50:59,988 - INFO - HistorySaverWorker - runnable_component - run - 128 - Component HistorySaverWorker (instance: 4414294928) cleanup complete.
2025-05-28 17:50:59,988 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task HistorySaverWorker finished after cancellation signal.
2025-05-28 17:50:59,988 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task TokenUsageWorker...
2025-05-28 17:50:59,988 - INFO - TokenUsageWorker - runnable_component - run - 116 - Run_loop for TokenUsageWorker (instance: 4414004288) was cancelled.
2025-05-28 17:50:59,988 - INFO - TokenUsageWorker - runnable_component - run - 123 - Component TokenUsageWorker (instance: 4414004288) stopping. Performing cleanup...
2025-05-28 17:50:59,988 - INFO - TokenUsageWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:50:59,991 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for token_usage_worker as part of cleanup.
2025-05-28 17:50:59,992 - INFO - TokenUsageWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-28 17:50:59,992 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:50:59,992 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-28 17:50:59,992 - INFO - TokenUsageWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:50:59,992 - INFO - TokenUsageWorker - runnable_component - run - 128 - Component TokenUsageWorker (instance: 4414004288) cleanup complete.
2025-05-28 17:50:59,992 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task TokenUsageWorker finished after cancellation signal.
2025-05-28 17:50:59,993 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task InactivityMonitorWorker...
2025-05-28 17:50:59,993 - INFO - InactivityMonitorWorker - runnable_component - run - 116 - Run_loop for InactivityMonitorWorker (instance: 4577358912) was cancelled.
2025-05-28 17:50:59,993 - INFO - InactivityMonitorWorker - runnable_component - run - 123 - Component InactivityMonitorWorker (instance: 4577358912) stopping. Performing cleanup...
2025-05-28 17:50:59,993 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 437 - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-28 17:50:59,993 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:50:59,993 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:50:59,993 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 441 - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-28 17:50:59,993 - INFO - InactivityMonitorWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:50:59,994 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-28 17:50:59,995 - INFO - InactivityMonitorWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-28 17:50:59,995 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:50:59,995 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-28 17:50:59,995 - INFO - InactivityMonitorWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:50:59,995 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 445 - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-28 17:50:59,995 - INFO - InactivityMonitorWorker - runnable_component - run - 128 - Component InactivityMonitorWorker (instance: 4577358912) cleanup complete.
2025-05-28 17:50:59,995 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-28 17:50:59,995 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 249 - All background tasks signaled to stop.
2025-05-28 17:50:59,996 - INFO - app.services.redis_service - redis_service - close_redis_pool - 43 - Redis connection pool closed successfully.
2025-05-28 17:51:00,000 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 17:51:00,000 - INFO - app.core.lifespan - lifespan - lifespan - 293 - Application shutdown sequence completed.
2025-05-28 17:51:00,409 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 17:51:00,409 - INFO - app.core.lifespan - lifespan - lifespan - 277 - Application startup sequence initiated.
2025-05-28 17:51:00,414 - INFO - app.services.redis_service - redis_service - init_redis_pool - 24 - Redis connection pool initialized successfully.
2025-05-28 17:51:00,414 - INFO - app.core.lifespan - lifespan - start_background_tasks - 172 - Starting background tasks...
2025-05-28 17:51:00,414 - INFO - app.core.lifespan - lifespan - start_background_tasks - 182 - History saver worker started, listening to queue: chat_history_queue
2025-05-28 17:51:00,414 - INFO - TokenUsageWorker - token_usage_worker - __init__ - 45 - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-28 17:51:00,414 - INFO - app.core.lifespan - lifespan - start_background_tasks - 194 - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-28 17:51:00,414 - INFO - app.core.lifespan - lifespan - start_background_tasks - 206 - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-28 17:51:00,414 - INFO - app.core.lifespan - lifespan - start_background_tasks - 210 - 3 background tasks initiated.
2025-05-28 17:51:00,414 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 51 - Attempting to start existing agents and their integrations...
2025-05-28 17:51:00,415 - INFO - HistorySaverWorker - base_worker - setup - 48 - [history_saver_worker] Worker setup started.
2025-05-28 17:51:00,415 - INFO - TokenUsageWorker - base_worker - setup - 48 - [token_usage_worker] Worker setup started.
2025-05-28 17:51:00,415 - INFO - InactivityMonitorWorker - base_worker - setup - 48 - [inactivity_monitor_worker] Worker setup started.
2025-05-28 17:51:00,417 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 61 - ProcessManager setup complete for startup.
2025-05-28 17:51:00,418 - INFO - TokenUsageWorker - base_worker - setup - 52 - [token_usage_worker] Worker setup completed.
2025-05-28 17:51:00,418 - INFO - TokenUsageWorker - base_worker - setup - 114 - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-28 17:51:00,418 - INFO - InactivityMonitorWorker - base_worker - setup - 52 - [inactivity_monitor_worker] Worker setup completed.
2025-05-28 17:51:00,418 - INFO - InactivityMonitorWorker - base_worker - setup - 243 - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-28 17:51:00,419 - INFO - HistorySaverWorker - base_worker - setup - 52 - [history_saver_worker] Worker setup completed.
2025-05-28 17:51:00,419 - INFO - HistorySaverWorker - base_worker - setup - 114 - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-28 17:51:00,420 - INFO - TokenUsageWorker - token_usage_worker - setup - 57 - [token_usage_worker] Database session factory initialized.
2025-05-28 17:51:00,420 - INFO - HistorySaverWorker - history_saver_worker - setup - 49 - [history_saver_worker] Database session factory initialized.
2025-05-28 17:51:00,420 - INFO - HistorySaverWorker - runnable_component - run - 111 - Component HistorySaverWorker (instance: 4450132304) setup complete. Starting run loop.
2025-05-28 17:51:00,420 - INFO - HistorySaverWorker - base_worker - run_loop - 131 - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-28 17:51:00,421 - INFO - TokenUsageWorker - token_usage_worker - setup - 64 - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-28 17:51:00,421 - INFO - TokenUsageWorker - runnable_component - run - 111 - Component TokenUsageWorker (instance: 4449826480) setup complete. Starting run loop.
2025-05-28 17:51:00,421 - INFO - TokenUsageWorker - base_worker - run_loop - 131 - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-28 17:51:00,431 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 86 - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-28 17:51:00,431 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 94 - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-28 17:51:00,467 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 66 - Found 1 agents to potentially start.
2025-05-28 17:51:00,467 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 69 - Attempting to start agent: agent_airsoft_0faa9616
2025-05-28 17:51:00,468 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 73 - Agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:51:00,468 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 93 - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-28 17:51:00,468 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 109 - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-28 17:51:00,468 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 115 - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:51:00,469 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:51:00,469 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:51:00,469 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 153 - ProcessManager cleanup complete for startup function.
2025-05-28 17:51:00,469 - INFO - app.core.lifespan - lifespan - lifespan - 284 - Application startup sequence completed.
2025-05-28 17:51:10,433 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 96 - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-28 17:51:10,438 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 98 - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-28 17:51:10,438 - INFO - InactivityMonitorWorker - runnable_component - run - 111 - Component InactivityMonitorWorker (instance: 4450253184) setup complete. Starting run loop.
2025-05-28 17:51:10,438 - INFO - InactivityMonitorWorker - base_worker - run_loop - 258 - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-28 17:51:26,035 - INFO - app.core.lifespan - lifespan - lifespan - 287 - Application shutdown sequence initiated.
2025-05-28 17:51:26,035 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 230 - Stopping 3 background tasks...
2025-05-28 17:51:26,035 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task HistorySaverWorker...
2025-05-28 17:51:26,035 - INFO - HistorySaverWorker - runnable_component - run - 116 - Run_loop for HistorySaverWorker (instance: 4450132304) was cancelled.
2025-05-28 17:51:26,035 - INFO - HistorySaverWorker - runnable_component - run - 123 - Component HistorySaverWorker (instance: 4450132304) stopping. Performing cleanup...
2025-05-28 17:51:26,035 - INFO - HistorySaverWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:51:26,040 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for history_saver_worker as part of cleanup.
2025-05-28 17:51:26,041 - INFO - HistorySaverWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-28 17:51:26,041 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:51:26,041 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-28 17:51:26,041 - INFO - HistorySaverWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:51:26,041 - INFO - HistorySaverWorker - runnable_component - run - 128 - Component HistorySaverWorker (instance: 4450132304) cleanup complete.
2025-05-28 17:51:26,041 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task HistorySaverWorker finished after cancellation signal.
2025-05-28 17:51:26,041 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task TokenUsageWorker...
2025-05-28 17:51:26,042 - INFO - TokenUsageWorker - runnable_component - run - 116 - Run_loop for TokenUsageWorker (instance: 4449826480) was cancelled.
2025-05-28 17:51:26,042 - INFO - TokenUsageWorker - runnable_component - run - 123 - Component TokenUsageWorker (instance: 4449826480) stopping. Performing cleanup...
2025-05-28 17:51:26,042 - INFO - TokenUsageWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:51:26,045 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for token_usage_worker as part of cleanup.
2025-05-28 17:51:26,046 - INFO - TokenUsageWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-28 17:51:26,046 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:51:26,046 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-28 17:51:26,046 - INFO - TokenUsageWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:51:26,046 - INFO - TokenUsageWorker - runnable_component - run - 128 - Component TokenUsageWorker (instance: 4449826480) cleanup complete.
2025-05-28 17:51:26,046 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task TokenUsageWorker finished after cancellation signal.
2025-05-28 17:51:26,046 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task InactivityMonitorWorker...
2025-05-28 17:51:26,047 - INFO - InactivityMonitorWorker - runnable_component - run - 116 - Run_loop for InactivityMonitorWorker (instance: 4450253184) was cancelled.
2025-05-28 17:51:26,047 - INFO - InactivityMonitorWorker - runnable_component - run - 123 - Component InactivityMonitorWorker (instance: 4450253184) stopping. Performing cleanup...
2025-05-28 17:51:26,047 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 437 - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-28 17:51:26,047 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:51:26,047 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:51:26,047 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 441 - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-28 17:51:26,047 - INFO - InactivityMonitorWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 17:51:26,049 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-28 17:51:26,049 - INFO - InactivityMonitorWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-28 17:51:26,049 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:51:26,050 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-28 17:51:26,050 - INFO - InactivityMonitorWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 17:51:26,050 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 445 - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-28 17:51:26,050 - INFO - InactivityMonitorWorker - runnable_component - run - 128 - Component InactivityMonitorWorker (instance: 4450253184) cleanup complete.
2025-05-28 17:51:26,050 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-28 17:51:26,050 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 249 - All background tasks signaled to stop.
2025-05-28 17:51:26,050 - INFO - app.services.redis_service - redis_service - close_redis_pool - 43 - Redis connection pool closed successfully.
2025-05-28 17:51:26,055 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 17:51:26,055 - INFO - app.core.lifespan - lifespan - lifespan - 293 - Application shutdown sequence completed.
2025-05-28 17:51:26,473 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 17:51:26,473 - INFO - app.core.lifespan - lifespan - lifespan - 277 - Application startup sequence initiated.
2025-05-28 17:51:26,478 - INFO - app.services.redis_service - redis_service - init_redis_pool - 24 - Redis connection pool initialized successfully.
2025-05-28 17:51:26,478 - INFO - app.core.lifespan - lifespan - start_background_tasks - 172 - Starting background tasks...
2025-05-28 17:51:26,478 - INFO - app.core.lifespan - lifespan - start_background_tasks - 182 - History saver worker started, listening to queue: chat_history_queue
2025-05-28 17:51:26,478 - INFO - TokenUsageWorker - token_usage_worker - __init__ - 45 - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-28 17:51:26,478 - INFO - app.core.lifespan - lifespan - start_background_tasks - 194 - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-28 17:51:26,478 - INFO - app.core.lifespan - lifespan - start_background_tasks - 206 - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-28 17:51:26,478 - INFO - app.core.lifespan - lifespan - start_background_tasks - 210 - 3 background tasks initiated.
2025-05-28 17:51:26,478 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 51 - Attempting to start existing agents and their integrations...
2025-05-28 17:51:26,478 - INFO - HistorySaverWorker - base_worker - setup - 48 - [history_saver_worker] Worker setup started.
2025-05-28 17:51:26,479 - INFO - TokenUsageWorker - base_worker - setup - 48 - [token_usage_worker] Worker setup started.
2025-05-28 17:51:26,479 - INFO - InactivityMonitorWorker - base_worker - setup - 48 - [inactivity_monitor_worker] Worker setup started.
2025-05-28 17:51:26,480 - INFO - InactivityMonitorWorker - base_worker - setup - 52 - [inactivity_monitor_worker] Worker setup completed.
2025-05-28 17:51:26,481 - INFO - InactivityMonitorWorker - base_worker - setup - 243 - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-28 17:51:26,481 - INFO - TokenUsageWorker - base_worker - setup - 52 - [token_usage_worker] Worker setup completed.
2025-05-28 17:51:26,481 - INFO - TokenUsageWorker - base_worker - setup - 114 - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-28 17:51:26,481 - INFO - HistorySaverWorker - base_worker - setup - 52 - [history_saver_worker] Worker setup completed.
2025-05-28 17:51:26,481 - INFO - HistorySaverWorker - base_worker - setup - 114 - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-28 17:51:26,481 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 61 - ProcessManager setup complete for startup.
2025-05-28 17:51:26,485 - INFO - TokenUsageWorker - token_usage_worker - setup - 57 - [token_usage_worker] Database session factory initialized.
2025-05-28 17:51:26,485 - INFO - HistorySaverWorker - history_saver_worker - setup - 49 - [history_saver_worker] Database session factory initialized.
2025-05-28 17:51:26,485 - INFO - HistorySaverWorker - runnable_component - run - 111 - Component HistorySaverWorker (instance: 4590062048) setup complete. Starting run loop.
2025-05-28 17:51:26,485 - INFO - HistorySaverWorker - base_worker - run_loop - 131 - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-28 17:51:26,485 - INFO - TokenUsageWorker - token_usage_worker - setup - 64 - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-28 17:51:26,485 - INFO - TokenUsageWorker - runnable_component - run - 111 - Component TokenUsageWorker (instance: 4590369680) setup complete. Starting run loop.
2025-05-28 17:51:26,485 - INFO - TokenUsageWorker - base_worker - run_loop - 131 - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-28 17:51:26,485 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 86 - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-28 17:51:26,485 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 94 - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-28 17:51:26,535 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 66 - Found 1 agents to potentially start.
2025-05-28 17:51:26,536 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 69 - Attempting to start agent: agent_airsoft_0faa9616
2025-05-28 17:51:26,536 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 73 - Agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:51:26,536 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 93 - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-28 17:51:26,536 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 109 - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-28 17:51:26,537 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 115 - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-28 17:51:26,538 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 17:51:26,538 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 17:51:26,538 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 153 - ProcessManager cleanup complete for startup function.
2025-05-28 17:51:26,538 - INFO - app.core.lifespan - lifespan - lifespan - 284 - Application startup sequence completed.
2025-05-28 17:51:36,486 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 96 - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-28 17:51:36,491 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 98 - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-28 17:51:36,491 - INFO - InactivityMonitorWorker - runnable_component - run - 111 - Component InactivityMonitorWorker (instance: 4590369584) setup complete. Starting run loop.
2025-05-28 17:51:36,491 - INFO - InactivityMonitorWorker - base_worker - run_loop - 258 - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-28 17:56:36,681 - INFO - InactivityMonitorWorker - base_worker - run_loop - 275 - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 17:56:36,691 - INFO - InactivityMonitorWorker - base_worker - run_loop - 281 - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 17:58:19,564 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 17:58:33,001 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 17:58:33,001 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 21 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-28 17:58:33,001 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 28 - Database session factory configured for Agent.
2025-05-28 17:58:33,001 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - __init__ - 44 - ServiceComponentBase initialized.
2025-05-28 17:58:33,001 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - __init__ - 120 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 99286
2025-05-28 17:58:33,001 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 42 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-28 17:58:33,001 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - setup - 494 - AgentRunner setup started.
2025-05-28 17:58:33,001 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - setup - 84 - ServiceComponent setup started.
2025-05-28 17:58:33,007 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - setup - 95 - ServiceComponent setup completed.
2025-05-28 17:58:33,008 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - fetch_config - 27 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-28 17:58:33,104 - INFO - httpx - _client - _send_single_request - 1740 - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-28 17:58:33,104 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - fetch_config - 33 - Configuration fetched successfully.
2025-05-28 17:58:33,104 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _load_config - 138 - Agent configuration loaded and prepared successfully.
2025-05-28 17:58:33,104 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _setup_app - 149 - Creating LangGraph application...
2025-05-28 17:58:33,104 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_agent_app - 913 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-28 17:58:33,104 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_llm_instance - 80 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-28 17:58:33,130 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _configure_main_llm - 63 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-28 17:58:33,131 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 818 - Creating agent graph in GraphFactory...
2025-05-28 17:58:33,131 - INFO - app.agent_runner.common.tools_registry - tools_registry - configure_tools_centralized - 364 - Configured 3 predefined tools from centralized registry
2025-05-28 17:58:33,131 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 94 - Added 3 tools from centralized registry
2025-05-28 17:58:33,131 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 114 - Configuring 1 Knowledge Base tool(s)...
2025-05-28 17:58:33,188 - INFO - httpx - _client - _send_single_request - 1025 - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-28 17:58:33,192 - INFO - httpx - _client - _send_single_request - 1025 - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-28 17:58:34,754 - INFO - httpx - _client - _send_single_request - 1025 - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-28 17:58:34,757 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 132 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-28 17:58:34,757 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 166 - Must conditions for KB tool 'knowledgeBase-1745316404538': [FieldCondition(key='metadata.client_id', match=MatchValue(value='2'), range=None, geo_bounding_box=None, geo_radius=None, geo_polygon=None, values_count=None), FieldCondition(key='metadata.datasource_id', match=MatchAny(any=['5', '6', '7']), range=None, geo_bounding_box=None, geo_radius=None, geo_polygon=None, values_count=None)]
2025-05-28 17:58:34,757 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 182 - Configured Knowledge Base tool 'База знаний' (ID: knowledgeBase-1745316404538) for datasources: ['5', '6', '7']
2025-05-28 17:58:34,757 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 190 - Using max_rewrites: 4
2025-05-28 17:58:34,757 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 217 - Configured Web Search tool 'Поиск в Интернете' (ID: webSearch-1746879979658)
2025-05-28 17:58:34,757 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 244 - Total tools configured: 5 (4 safe, 1 datastore).
2025-05-28 17:58:34,757 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _configure_tools - 153 - Tools configured: 5 total, 4 safe, 1 datastore tools. Max rewrites: 4.
2025-05-28 17:58:34,758 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 826 - Context memory enabled: True
2025-05-28 17:58:34,758 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 834 - Added node: agent
2025-05-28 17:58:34,758 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 843 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-28 17:58:34,758 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 853 - Added node: safe_tools
2025-05-28 17:58:34,758 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 864 - Added edge: safe_tools -> agent
2025-05-28 17:58:34,758 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 870 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-28 17:58:34,759 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 877 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-28 17:58:34,759 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 893 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-28 17:58:34,770 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 905 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-28 17:58:34,770 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_agent_app - 922 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-28 17:58:34,770 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _setup_app - 157 - LangGraph application created successfully.
2025-05-28 17:58:34,770 - INFO - AGENT:agent_airsoft_0faa9616 - runnable_component - run - 111 - Component AgentRunner (instance: 4506535456) setup complete. Starting run loop.
2025-05-28 17:58:34,770 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - run_loop - 522 - AgentRunner run_loop starting...
2025-05-28 17:58:34,770 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - _register_main_task - 62 - Registered main task: AgentPubSubListener
2025-05-28 17:58:34,770 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - run_loop - 122 - Starting run_loop with 1 registered main tasks.
2025-05-28 17:58:34,770 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 236 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-28 17:58:34,773 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 254 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-28 18:01:36,879 - INFO - InactivityMonitorWorker - base_worker - run_loop - 275 - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 18:01:36,888 - INFO - InactivityMonitorWorker - base_worker - run_loop - 281 - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 18:04:58,946 - INFO - app.core.lifespan - lifespan - lifespan - 287 - Application shutdown sequence initiated.
2025-05-28 18:04:58,947 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 230 - Stopping 3 background tasks...
2025-05-28 18:04:58,947 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task HistorySaverWorker...
2025-05-28 18:04:58,947 - INFO - HistorySaverWorker - runnable_component - run - 116 - Run_loop for HistorySaverWorker (instance: 4590062048) was cancelled.
2025-05-28 18:04:58,947 - INFO - HistorySaverWorker - runnable_component - run - 123 - Component HistorySaverWorker (instance: 4590062048) stopping. Performing cleanup...
2025-05-28 18:04:58,947 - INFO - HistorySaverWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 18:04:58,952 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for history_saver_worker as part of cleanup.
2025-05-28 18:04:58,953 - INFO - HistorySaverWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-28 18:04:58,953 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:04:58,953 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-28 18:04:58,953 - INFO - HistorySaverWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 18:04:58,953 - INFO - HistorySaverWorker - runnable_component - run - 128 - Component HistorySaverWorker (instance: 4590062048) cleanup complete.
2025-05-28 18:04:58,954 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task HistorySaverWorker finished after cancellation signal.
2025-05-28 18:04:58,954 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task TokenUsageWorker...
2025-05-28 18:04:58,954 - INFO - TokenUsageWorker - runnable_component - run - 116 - Run_loop for TokenUsageWorker (instance: 4590369680) was cancelled.
2025-05-28 18:04:58,954 - INFO - TokenUsageWorker - runnable_component - run - 123 - Component TokenUsageWorker (instance: 4590369680) stopping. Performing cleanup...
2025-05-28 18:04:58,954 - INFO - TokenUsageWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 18:04:58,957 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for token_usage_worker as part of cleanup.
2025-05-28 18:04:58,957 - INFO - TokenUsageWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-28 18:04:58,958 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:04:58,958 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-28 18:04:58,958 - INFO - TokenUsageWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 18:04:58,958 - INFO - TokenUsageWorker - runnable_component - run - 128 - Component TokenUsageWorker (instance: 4590369680) cleanup complete.
2025-05-28 18:04:58,958 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task TokenUsageWorker finished after cancellation signal.
2025-05-28 18:04:58,958 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task InactivityMonitorWorker...
2025-05-28 18:04:58,958 - INFO - InactivityMonitorWorker - runnable_component - run - 116 - Run_loop for InactivityMonitorWorker (instance: 4590369584) was cancelled.
2025-05-28 18:04:58,958 - INFO - InactivityMonitorWorker - runnable_component - run - 123 - Component InactivityMonitorWorker (instance: 4590369584) stopping. Performing cleanup...
2025-05-28 18:04:58,958 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 437 - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-28 18:04:58,958 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:04:58,958 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 18:04:58,958 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 441 - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-28 18:04:58,958 - INFO - InactivityMonitorWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 18:04:58,960 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-28 18:04:58,961 - INFO - InactivityMonitorWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-28 18:04:58,961 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:04:58,961 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-28 18:04:58,961 - INFO - InactivityMonitorWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 18:04:58,961 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 445 - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-28 18:04:58,961 - INFO - InactivityMonitorWorker - runnable_component - run - 128 - Component InactivityMonitorWorker (instance: 4590369584) cleanup complete.
2025-05-28 18:04:58,961 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-28 18:04:58,961 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 249 - All background tasks signaled to stop.
2025-05-28 18:04:58,961 - INFO - app.services.redis_service - redis_service - close_redis_pool - 43 - Redis connection pool closed successfully.
2025-05-28 18:04:58,971 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 18:04:58,971 - INFO - app.core.lifespan - lifespan - lifespan - 293 - Application shutdown sequence completed.
2025-05-28 18:04:59,424 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 18:04:59,424 - INFO - app.core.lifespan - lifespan - lifespan - 277 - Application startup sequence initiated.
2025-05-28 18:04:59,429 - INFO - app.services.redis_service - redis_service - init_redis_pool - 24 - Redis connection pool initialized successfully.
2025-05-28 18:04:59,429 - INFO - app.core.lifespan - lifespan - start_background_tasks - 172 - Starting background tasks...
2025-05-28 18:04:59,429 - INFO - app.core.lifespan - lifespan - start_background_tasks - 182 - History saver worker started, listening to queue: chat_history_queue
2025-05-28 18:04:59,429 - INFO - TokenUsageWorker - token_usage_worker - __init__ - 45 - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-28 18:04:59,429 - INFO - app.core.lifespan - lifespan - start_background_tasks - 194 - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-28 18:04:59,429 - INFO - app.core.lifespan - lifespan - start_background_tasks - 206 - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-28 18:04:59,429 - INFO - app.core.lifespan - lifespan - start_background_tasks - 210 - 3 background tasks initiated.
2025-05-28 18:04:59,429 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 51 - Attempting to start existing agents and their integrations...
2025-05-28 18:04:59,430 - INFO - HistorySaverWorker - base_worker - setup - 48 - [history_saver_worker] Worker setup started.
2025-05-28 18:04:59,430 - INFO - TokenUsageWorker - base_worker - setup - 48 - [token_usage_worker] Worker setup started.
2025-05-28 18:04:59,430 - INFO - InactivityMonitorWorker - base_worker - setup - 48 - [inactivity_monitor_worker] Worker setup started.
2025-05-28 18:04:59,433 - INFO - HistorySaverWorker - base_worker - setup - 52 - [history_saver_worker] Worker setup completed.
2025-05-28 18:04:59,433 - INFO - HistorySaverWorker - base_worker - setup - 114 - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-28 18:04:59,434 - INFO - TokenUsageWorker - base_worker - setup - 52 - [token_usage_worker] Worker setup completed.
2025-05-28 18:04:59,434 - INFO - TokenUsageWorker - base_worker - setup - 114 - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-28 18:04:59,434 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 61 - ProcessManager setup complete for startup.
2025-05-28 18:04:59,435 - INFO - InactivityMonitorWorker - base_worker - setup - 52 - [inactivity_monitor_worker] Worker setup completed.
2025-05-28 18:04:59,435 - INFO - InactivityMonitorWorker - base_worker - setup - 243 - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-28 18:04:59,436 - INFO - HistorySaverWorker - history_saver_worker - setup - 49 - [history_saver_worker] Database session factory initialized.
2025-05-28 18:04:59,436 - INFO - HistorySaverWorker - runnable_component - run - 111 - Component HistorySaverWorker (instance: 4378393584) setup complete. Starting run loop.
2025-05-28 18:04:59,436 - INFO - HistorySaverWorker - base_worker - run_loop - 131 - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-28 18:04:59,436 - INFO - TokenUsageWorker - token_usage_worker - setup - 57 - [token_usage_worker] Database session factory initialized.
2025-05-28 18:04:59,437 - INFO - TokenUsageWorker - token_usage_worker - setup - 64 - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-28 18:04:59,437 - INFO - TokenUsageWorker - runnable_component - run - 111 - Component TokenUsageWorker (instance: 4377966592) setup complete. Starting run loop.
2025-05-28 18:04:59,437 - INFO - TokenUsageWorker - base_worker - run_loop - 131 - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-28 18:04:59,438 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 86 - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-28 18:04:59,438 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 94 - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-28 18:04:59,482 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 66 - Found 1 agents to potentially start.
2025-05-28 18:04:59,482 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 69 - Attempting to start agent: agent_airsoft_0faa9616
2025-05-28 18:04:59,483 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 73 - Agent agent_airsoft_0faa9616 is already running.
2025-05-28 18:04:59,483 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 93 - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-28 18:04:59,483 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 109 - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-28 18:04:59,484 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 115 - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-28 18:04:59,484 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:04:59,485 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 18:04:59,485 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 153 - ProcessManager cleanup complete for startup function.
2025-05-28 18:04:59,485 - INFO - app.core.lifespan - lifespan - lifespan - 284 - Application startup sequence completed.
2025-05-28 18:05:01,198 - INFO - app.core.lifespan - lifespan - lifespan - 287 - Application shutdown sequence initiated.
2025-05-28 18:05:01,198 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 230 - Stopping 3 background tasks...
2025-05-28 18:05:01,198 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task HistorySaverWorker...
2025-05-28 18:05:01,198 - INFO - HistorySaverWorker - runnable_component - run - 116 - Run_loop for HistorySaverWorker (instance: 4378393584) was cancelled.
2025-05-28 18:05:01,198 - INFO - HistorySaverWorker - runnable_component - run - 123 - Component HistorySaverWorker (instance: 4378393584) stopping. Performing cleanup...
2025-05-28 18:05:01,198 - INFO - HistorySaverWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 18:05:01,203 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for history_saver_worker as part of cleanup.
2025-05-28 18:05:01,204 - INFO - HistorySaverWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-28 18:05:01,204 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:05:01,204 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-28 18:05:01,204 - INFO - HistorySaverWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 18:05:01,204 - INFO - HistorySaverWorker - runnable_component - run - 128 - Component HistorySaverWorker (instance: 4378393584) cleanup complete.
2025-05-28 18:05:01,204 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task HistorySaverWorker finished after cancellation signal.
2025-05-28 18:05:01,204 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task TokenUsageWorker...
2025-05-28 18:05:01,205 - INFO - TokenUsageWorker - runnable_component - run - 116 - Run_loop for TokenUsageWorker (instance: 4377966592) was cancelled.
2025-05-28 18:05:01,205 - INFO - TokenUsageWorker - runnable_component - run - 123 - Component TokenUsageWorker (instance: 4377966592) stopping. Performing cleanup...
2025-05-28 18:05:01,205 - INFO - TokenUsageWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 18:05:01,208 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for token_usage_worker as part of cleanup.
2025-05-28 18:05:01,209 - INFO - TokenUsageWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-28 18:05:01,209 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:05:01,209 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-28 18:05:01,209 - INFO - TokenUsageWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 18:05:01,209 - INFO - TokenUsageWorker - runnable_component - run - 128 - Component TokenUsageWorker (instance: 4377966592) cleanup complete.
2025-05-28 18:05:01,209 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task TokenUsageWorker finished after cancellation signal.
2025-05-28 18:05:01,209 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task InactivityMonitorWorker...
2025-05-28 18:05:01,209 - INFO - InactivityMonitorWorker - runnable_component - run - 116 - Run_loop for InactivityMonitorWorker (instance: 4378392912) was cancelled.
2025-05-28 18:05:01,209 - INFO - InactivityMonitorWorker - runnable_component - run - 123 - Component InactivityMonitorWorker (instance: 4378392912) stopping. Performing cleanup...
2025-05-28 18:05:01,209 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 437 - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-28 18:05:01,209 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:05:01,209 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 18:05:01,209 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 441 - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-28 18:05:01,209 - INFO - InactivityMonitorWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 18:05:01,211 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-28 18:05:01,212 - INFO - InactivityMonitorWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-28 18:05:01,212 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:05:01,212 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-28 18:05:01,212 - INFO - InactivityMonitorWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 18:05:01,212 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 445 - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-28 18:05:01,212 - INFO - InactivityMonitorWorker - runnable_component - run - 128 - Component InactivityMonitorWorker (instance: 4378392912) cleanup complete.
2025-05-28 18:05:01,212 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-28 18:05:01,212 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 249 - All background tasks signaled to stop.
2025-05-28 18:05:01,212 - INFO - app.services.redis_service - redis_service - close_redis_pool - 43 - Redis connection pool closed successfully.
2025-05-28 18:05:01,215 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 18:05:01,215 - INFO - app.core.lifespan - lifespan - lifespan - 293 - Application shutdown sequence completed.
2025-05-28 18:05:01,572 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 18:05:01,573 - INFO - app.core.lifespan - lifespan - lifespan - 277 - Application startup sequence initiated.
2025-05-28 18:05:01,577 - INFO - app.services.redis_service - redis_service - init_redis_pool - 24 - Redis connection pool initialized successfully.
2025-05-28 18:05:01,577 - INFO - app.core.lifespan - lifespan - start_background_tasks - 172 - Starting background tasks...
2025-05-28 18:05:01,577 - INFO - app.core.lifespan - lifespan - start_background_tasks - 182 - History saver worker started, listening to queue: chat_history_queue
2025-05-28 18:05:01,577 - INFO - TokenUsageWorker - token_usage_worker - __init__ - 45 - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-28 18:05:01,577 - INFO - app.core.lifespan - lifespan - start_background_tasks - 194 - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-28 18:05:01,577 - INFO - app.core.lifespan - lifespan - start_background_tasks - 206 - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-28 18:05:01,577 - INFO - app.core.lifespan - lifespan - start_background_tasks - 210 - 3 background tasks initiated.
2025-05-28 18:05:01,577 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 51 - Attempting to start existing agents and their integrations...
2025-05-28 18:05:01,578 - INFO - HistorySaverWorker - base_worker - setup - 48 - [history_saver_worker] Worker setup started.
2025-05-28 18:05:01,578 - INFO - TokenUsageWorker - base_worker - setup - 48 - [token_usage_worker] Worker setup started.
2025-05-28 18:05:01,578 - INFO - InactivityMonitorWorker - base_worker - setup - 48 - [inactivity_monitor_worker] Worker setup started.
2025-05-28 18:05:01,580 - INFO - HistorySaverWorker - base_worker - setup - 52 - [history_saver_worker] Worker setup completed.
2025-05-28 18:05:01,581 - INFO - HistorySaverWorker - base_worker - setup - 114 - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-28 18:05:01,581 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 61 - ProcessManager setup complete for startup.
2025-05-28 18:05:01,582 - INFO - TokenUsageWorker - base_worker - setup - 52 - [token_usage_worker] Worker setup completed.
2025-05-28 18:05:01,582 - INFO - TokenUsageWorker - base_worker - setup - 114 - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-28 18:05:01,582 - INFO - InactivityMonitorWorker - base_worker - setup - 52 - [inactivity_monitor_worker] Worker setup completed.
2025-05-28 18:05:01,582 - INFO - InactivityMonitorWorker - base_worker - setup - 243 - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-28 18:05:01,584 - INFO - HistorySaverWorker - history_saver_worker - setup - 49 - [history_saver_worker] Database session factory initialized.
2025-05-28 18:05:01,584 - INFO - HistorySaverWorker - runnable_component - run - 111 - Component HistorySaverWorker (instance: 4413400096) setup complete. Starting run loop.
2025-05-28 18:05:01,584 - INFO - HistorySaverWorker - base_worker - run_loop - 131 - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-28 18:05:01,584 - INFO - TokenUsageWorker - token_usage_worker - setup - 57 - [token_usage_worker] Database session factory initialized.
2025-05-28 18:05:01,585 - INFO - TokenUsageWorker - token_usage_worker - setup - 64 - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-28 18:05:01,585 - INFO - TokenUsageWorker - runnable_component - run - 111 - Component TokenUsageWorker (instance: 4413740896) setup complete. Starting run loop.
2025-05-28 18:05:01,585 - INFO - TokenUsageWorker - base_worker - run_loop - 131 - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-28 18:05:01,586 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 86 - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-28 18:05:01,586 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 94 - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-28 18:05:01,633 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 66 - Found 1 agents to potentially start.
2025-05-28 18:05:01,633 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 69 - Attempting to start agent: agent_airsoft_0faa9616
2025-05-28 18:05:01,634 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 73 - Agent agent_airsoft_0faa9616 is already running.
2025-05-28 18:05:01,634 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 93 - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-28 18:05:01,634 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 109 - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-28 18:05:01,635 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 115 - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-28 18:05:01,635 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:05:01,636 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 18:05:01,636 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 153 - ProcessManager cleanup complete for startup function.
2025-05-28 18:05:01,636 - INFO - app.core.lifespan - lifespan - lifespan - 284 - Application startup sequence completed.
2025-05-28 18:05:03,045 - INFO - app.core.lifespan - lifespan - lifespan - 287 - Application shutdown sequence initiated.
2025-05-28 18:05:03,045 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 230 - Stopping 3 background tasks...
2025-05-28 18:05:03,045 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task HistorySaverWorker...
2025-05-28 18:05:03,045 - INFO - HistorySaverWorker - runnable_component - run - 116 - Run_loop for HistorySaverWorker (instance: 4413400096) was cancelled.
2025-05-28 18:05:03,045 - INFO - HistorySaverWorker - runnable_component - run - 123 - Component HistorySaverWorker (instance: 4413400096) stopping. Performing cleanup...
2025-05-28 18:05:03,045 - INFO - HistorySaverWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 18:05:03,050 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for history_saver_worker as part of cleanup.
2025-05-28 18:05:03,051 - INFO - HistorySaverWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-28 18:05:03,051 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:05:03,051 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-28 18:05:03,051 - INFO - HistorySaverWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 18:05:03,051 - INFO - HistorySaverWorker - runnable_component - run - 128 - Component HistorySaverWorker (instance: 4413400096) cleanup complete.
2025-05-28 18:05:03,051 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task HistorySaverWorker finished after cancellation signal.
2025-05-28 18:05:03,051 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task TokenUsageWorker...
2025-05-28 18:05:03,051 - INFO - TokenUsageWorker - runnable_component - run - 116 - Run_loop for TokenUsageWorker (instance: 4413740896) was cancelled.
2025-05-28 18:05:03,051 - INFO - TokenUsageWorker - runnable_component - run - 123 - Component TokenUsageWorker (instance: 4413740896) stopping. Performing cleanup...
2025-05-28 18:05:03,051 - INFO - TokenUsageWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 18:05:03,055 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for token_usage_worker as part of cleanup.
2025-05-28 18:05:03,056 - INFO - TokenUsageWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-28 18:05:03,056 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:05:03,056 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-28 18:05:03,056 - INFO - TokenUsageWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 18:05:03,056 - INFO - TokenUsageWorker - runnable_component - run - 128 - Component TokenUsageWorker (instance: 4413740896) cleanup complete.
2025-05-28 18:05:03,056 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task TokenUsageWorker finished after cancellation signal.
2025-05-28 18:05:03,056 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task InactivityMonitorWorker...
2025-05-28 18:05:03,056 - INFO - InactivityMonitorWorker - runnable_component - run - 116 - Run_loop for InactivityMonitorWorker (instance: 4407434304) was cancelled.
2025-05-28 18:05:03,056 - INFO - InactivityMonitorWorker - runnable_component - run - 123 - Component InactivityMonitorWorker (instance: 4407434304) stopping. Performing cleanup...
2025-05-28 18:05:03,056 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 437 - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-28 18:05:03,056 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:05:03,056 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 18:05:03,056 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 441 - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-28 18:05:03,056 - INFO - InactivityMonitorWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 18:05:03,058 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-28 18:05:03,059 - INFO - InactivityMonitorWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-28 18:05:03,059 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:05:03,059 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-28 18:05:03,059 - INFO - InactivityMonitorWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 18:05:03,059 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 445 - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-28 18:05:03,059 - INFO - InactivityMonitorWorker - runnable_component - run - 128 - Component InactivityMonitorWorker (instance: 4407434304) cleanup complete.
2025-05-28 18:05:03,059 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-28 18:05:03,059 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 249 - All background tasks signaled to stop.
2025-05-28 18:05:03,059 - INFO - app.services.redis_service - redis_service - close_redis_pool - 43 - Redis connection pool closed successfully.
2025-05-28 18:05:03,064 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 18:05:03,064 - INFO - app.core.lifespan - lifespan - lifespan - 293 - Application shutdown sequence completed.
2025-05-28 18:05:03,377 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 18:05:03,377 - INFO - app.core.lifespan - lifespan - lifespan - 277 - Application startup sequence initiated.
2025-05-28 18:05:03,380 - INFO - app.services.redis_service - redis_service - init_redis_pool - 24 - Redis connection pool initialized successfully.
2025-05-28 18:05:03,381 - INFO - app.core.lifespan - lifespan - start_background_tasks - 172 - Starting background tasks...
2025-05-28 18:05:03,381 - INFO - app.core.lifespan - lifespan - start_background_tasks - 182 - History saver worker started, listening to queue: chat_history_queue
2025-05-28 18:05:03,381 - INFO - TokenUsageWorker - token_usage_worker - __init__ - 45 - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-28 18:05:03,381 - INFO - app.core.lifespan - lifespan - start_background_tasks - 194 - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-28 18:05:03,381 - INFO - app.core.lifespan - lifespan - start_background_tasks - 206 - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-28 18:05:03,381 - INFO - app.core.lifespan - lifespan - start_background_tasks - 210 - 3 background tasks initiated.
2025-05-28 18:05:03,381 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 51 - Attempting to start existing agents and their integrations...
2025-05-28 18:05:03,381 - INFO - HistorySaverWorker - base_worker - setup - 48 - [history_saver_worker] Worker setup started.
2025-05-28 18:05:03,381 - INFO - TokenUsageWorker - base_worker - setup - 48 - [token_usage_worker] Worker setup started.
2025-05-28 18:05:03,381 - INFO - InactivityMonitorWorker - base_worker - setup - 48 - [inactivity_monitor_worker] Worker setup started.
2025-05-28 18:05:03,384 - INFO - InactivityMonitorWorker - base_worker - setup - 52 - [inactivity_monitor_worker] Worker setup completed.
2025-05-28 18:05:03,384 - INFO - InactivityMonitorWorker - base_worker - setup - 243 - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-28 18:05:03,384 - INFO - TokenUsageWorker - base_worker - setup - 52 - [token_usage_worker] Worker setup completed.
2025-05-28 18:05:03,384 - INFO - TokenUsageWorker - base_worker - setup - 114 - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-28 18:05:03,384 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 61 - ProcessManager setup complete for startup.
2025-05-28 18:05:03,385 - INFO - HistorySaverWorker - base_worker - setup - 52 - [history_saver_worker] Worker setup completed.
2025-05-28 18:05:03,385 - INFO - HistorySaverWorker - base_worker - setup - 114 - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-28 18:05:03,387 - INFO - HistorySaverWorker - history_saver_worker - setup - 49 - [history_saver_worker] Database session factory initialized.
2025-05-28 18:05:03,387 - INFO - HistorySaverWorker - runnable_component - run - 111 - Component HistorySaverWorker (instance: 4375236480) setup complete. Starting run loop.
2025-05-28 18:05:03,387 - INFO - HistorySaverWorker - base_worker - run_loop - 131 - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-28 18:05:03,387 - INFO - TokenUsageWorker - token_usage_worker - setup - 57 - [token_usage_worker] Database session factory initialized.
2025-05-28 18:05:03,388 - INFO - TokenUsageWorker - token_usage_worker - setup - 64 - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-28 18:05:03,388 - INFO - TokenUsageWorker - runnable_component - run - 111 - Component TokenUsageWorker (instance: 4377754656) setup complete. Starting run loop.
2025-05-28 18:05:03,388 - INFO - TokenUsageWorker - base_worker - run_loop - 131 - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-28 18:05:03,389 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 86 - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-28 18:05:03,389 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 94 - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-28 18:05:03,429 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 66 - Found 1 agents to potentially start.
2025-05-28 18:05:03,429 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 69 - Attempting to start agent: agent_airsoft_0faa9616
2025-05-28 18:05:03,430 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 73 - Agent agent_airsoft_0faa9616 is already running.
2025-05-28 18:05:03,430 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 93 - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-28 18:05:03,430 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 109 - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-28 18:05:03,431 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 115 - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-28 18:05:03,432 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:05:03,432 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 18:05:03,432 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 153 - ProcessManager cleanup complete for startup function.
2025-05-28 18:05:03,432 - INFO - app.core.lifespan - lifespan - lifespan - 284 - Application startup sequence completed.
2025-05-28 18:05:13,390 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 96 - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-28 18:05:13,394 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 98 - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-28 18:05:13,395 - INFO - InactivityMonitorWorker - runnable_component - run - 111 - Component InactivityMonitorWorker (instance: 4377754800) setup complete. Starting run loop.
2025-05-28 18:05:13,395 - INFO - InactivityMonitorWorker - base_worker - run_loop - 258 - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-28 18:08:14,056 - WARNING - aiogram.dispatcher - dispatcher - _signal_stop_polling - 455 - Received SIGINT signal
2025-05-28 18:08:14,056 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - run_loop - 160 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-28 18:08:14,057 - INFO - AGENT:agent_airsoft_0faa9616 - runnable_component - initiate_shutdown - 74 - Component AgentRunner (instance: 4679402944) received shutdown request. Initiating graceful shutdown...
2025-05-28 18:08:14,057 - INFO - AGENT:agent_airsoft_0faa9616 - runnable_component - initiate_shutdown - 79 - Cancelling main task (_run_loop) for AgentRunner (instance: 4679402944)...
2025-05-28 18:08:14,057 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - run_loop - 172 - ServiceComponentBase run_loop finished.
2025-05-28 18:08:14,057 - INFO - aiogram.dispatcher - dispatcher - _polling - 359 - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-28 18:08:14,057 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - run_loop - 536 - AgentRunner run_loop finished.
2025-05-28 18:08:14,058 - INFO - AGENT:agent_airsoft_0faa9616 - runnable_component - run - 116 - Run_loop for AgentRunner (instance: 4679402944) was cancelled.
2025-05-28 18:08:14,058 - INFO - AGENT:agent_airsoft_0faa9616 - runnable_component - run - 123 - Component AgentRunner (instance: 4679402944) stopping. Performing cleanup...
2025-05-28 18:08:14,058 - INFO - aiogram.dispatcher - dispatcher - start_polling - 554 - Polling stopped
2025-05-28 18:08:14,058 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - cleanup - 546 - AgentRunner cleanup started.
2025-05-28 18:08:14,058 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 294 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-28 18:08:14,059 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 298 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-28 18:08:14,059 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - cleanup - 552 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-28 18:08:14,060 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - cleanup - 181 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-28 18:08:14,060 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - cleanup - 204 - No running main tasks to cancel.
2025-05-28 18:08:14,060 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - cleanup - 207 - All main tasks processed and list cleared.
2025-05-28 18:08:14,062 - INFO - AGENT:agent_airsoft_0faa9616 - status_updater - cleanup_status_updater - 316 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-28 18:08:14,063 - INFO - AGENT:agent_airsoft_0faa9616 - status_updater - delete_status_key_from_redis - 196 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-28 18:08:14,063 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:08:14,063 - INFO - AGENT:agent_airsoft_0faa9616 - status_updater - cleanup_status_updater - 320 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-28 18:08:14,063 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - cleanup - 211 - ServiceComponent cleanup completed.
2025-05-28 18:08:14,063 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - cleanup - 581 - AgentRunner cleanup finished.
2025-05-28 18:08:14,063 - INFO - AGENT:agent_airsoft_0faa9616 - runnable_component - run - 128 - Component AgentRunner (instance: 4679402944) cleanup complete.
2025-05-28 18:08:14,064 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 51 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-28 18:08:14,064 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 60 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-28 18:08:14,075 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 18:08:14,075 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 63 - Database engine closed.
2025-05-28 18:08:14,075 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 66 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-28 18:08:14,076 - INFO - __main__ - runner_main - <module> - 86 - Agent runner main finished.
2025-05-28 18:08:14,234 - INFO - app.core.lifespan - lifespan - lifespan - 287 - Application shutdown sequence initiated.
2025-05-28 18:08:14,235 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 230 - Stopping 3 background tasks...
2025-05-28 18:08:14,235 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task HistorySaverWorker...
2025-05-28 18:08:14,235 - INFO - HistorySaverWorker - runnable_component - run - 116 - Run_loop for HistorySaverWorker (instance: 4375236480) was cancelled.
2025-05-28 18:08:14,235 - INFO - HistorySaverWorker - runnable_component - run - 123 - Component HistorySaverWorker (instance: 4375236480) stopping. Performing cleanup...
2025-05-28 18:08:14,235 - INFO - HistorySaverWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 18:08:14,240 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for history_saver_worker as part of cleanup.
2025-05-28 18:08:14,241 - INFO - HistorySaverWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-28 18:08:14,241 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:08:14,242 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-28 18:08:14,242 - INFO - HistorySaverWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 18:08:14,242 - INFO - HistorySaverWorker - runnable_component - run - 128 - Component HistorySaverWorker (instance: 4375236480) cleanup complete.
2025-05-28 18:08:14,242 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task HistorySaverWorker finished after cancellation signal.
2025-05-28 18:08:14,242 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task TokenUsageWorker...
2025-05-28 18:08:14,242 - INFO - TokenUsageWorker - runnable_component - run - 116 - Run_loop for TokenUsageWorker (instance: 4377754656) was cancelled.
2025-05-28 18:08:14,242 - INFO - TokenUsageWorker - runnable_component - run - 123 - Component TokenUsageWorker (instance: 4377754656) stopping. Performing cleanup...
2025-05-28 18:08:14,242 - INFO - TokenUsageWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 18:08:14,245 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for token_usage_worker as part of cleanup.
2025-05-28 18:08:14,246 - INFO - TokenUsageWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-28 18:08:14,246 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:08:14,247 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-28 18:08:14,247 - INFO - TokenUsageWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 18:08:14,247 - INFO - TokenUsageWorker - runnable_component - run - 128 - Component TokenUsageWorker (instance: 4377754656) cleanup complete.
2025-05-28 18:08:14,247 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task TokenUsageWorker finished after cancellation signal.
2025-05-28 18:08:14,247 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task InactivityMonitorWorker...
2025-05-28 18:08:14,247 - INFO - InactivityMonitorWorker - runnable_component - run - 116 - Run_loop for InactivityMonitorWorker (instance: 4377754800) was cancelled.
2025-05-28 18:08:14,247 - INFO - InactivityMonitorWorker - runnable_component - run - 123 - Component InactivityMonitorWorker (instance: 4377754800) stopping. Performing cleanup...
2025-05-28 18:08:14,247 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 437 - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-28 18:08:14,247 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:08:14,248 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 18:08:14,248 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 441 - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-28 18:08:14,248 - INFO - InactivityMonitorWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 18:08:14,250 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-28 18:08:14,251 - INFO - InactivityMonitorWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-28 18:08:14,251 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:08:14,251 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-28 18:08:14,251 - INFO - InactivityMonitorWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 18:08:14,251 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 445 - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-28 18:08:14,251 - INFO - InactivityMonitorWorker - runnable_component - run - 128 - Component InactivityMonitorWorker (instance: 4377754800) cleanup complete.
2025-05-28 18:08:14,251 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-28 18:08:14,251 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 249 - All background tasks signaled to stop.
2025-05-28 18:08:14,251 - INFO - app.services.redis_service - redis_service - close_redis_pool - 43 - Redis connection pool closed successfully.
2025-05-28 18:08:14,257 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 18:08:14,257 - INFO - app.core.lifespan - lifespan - lifespan - 293 - Application shutdown sequence completed.
2025-05-28 18:08:14,309 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - polling_wrapper - 482 - Aiogram polling has stopped.
2025-05-28 18:08:14,309 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - run_loop - 137 - Main task 'AiogramPolling' completed. Result: None
2025-05-28 18:08:14,309 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - run_loop - 156 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-28 18:08:14,309 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - runnable_component - initiate_shutdown - 74 - Component TelegramIntegrationBot (instance: 4402044256) received shutdown request. Initiating graceful shutdown...
2025-05-28 18:08:14,309 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - runnable_component - initiate_shutdown - 79 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4402044256)...
2025-05-28 18:08:14,309 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - run_loop - 172 - ServiceComponentBase run_loop finished.
2025-05-28 18:08:14,309 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - run_loop - 494 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-28 18:08:14,309 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - runnable_component - run - 116 - Run_loop for TelegramIntegrationBot (instance: 4402044256) was cancelled.
2025-05-28 18:08:14,309 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - runnable_component - run - 123 - Component TelegramIntegrationBot (instance: 4402044256) stopping. Performing cleanup...
2025-05-28 18:08:14,309 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - cleanup - 503 - TelegramIntegrationBot cleanup started.
2025-05-28 18:08:14,309 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - cleanup - 516 - Closing Aiogram bot session.
2025-05-28 18:08:14,309 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - cleanup - 518 - Aiogram bot session closed.
2025-05-28 18:08:14,309 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - cleanup - 181 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-28 18:08:14,309 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - cleanup - 191 - Waiting for 1 tasks to process cancellation...
2025-05-28 18:08:14,309 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 270 - Pub/Sub listener task cancelled.
2025-05-28 18:08:14,309 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 294 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-28 18:08:14,309 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 298 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-28 18:08:14,309 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - cleanup - 202 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-28 18:08:14,309 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - cleanup - 207 - All main tasks processed and list cleared.
2025-05-28 18:08:14,315 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - status_updater - cleanup_status_updater - 316 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-28 18:08:14,316 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - status_updater - delete_status_key_from_redis - 196 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-28 18:08:14,316 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:08:14,316 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - status_updater - cleanup_status_updater - 320 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-28 18:08:14,316 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - cleanup - 211 - ServiceComponent cleanup completed.
2025-05-28 18:08:14,317 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - cleanup - 524 - TelegramIntegrationBot cleanup finished.
2025-05-28 18:08:14,317 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - runnable_component - run - 128 - Component TelegramIntegrationBot (instance: 4402044256) cleanup complete.
2025-05-28 18:08:14,317 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot_main - main_async_runner - 86 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-28 18:08:14,317 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot_main - main_async_runner - 95 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-28 18:08:14,322 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 18:08:14,322 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot_main - main_async_runner - 98 - Database engine closed.
2025-05-28 18:08:14,322 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot_main - main_async_runner - 101 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-28 18:08:14,324 - INFO - __main__ - telegram_bot_main - <module> - 124 - Telegram bot runner main finished.
2025-05-28 18:08:21,987 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - run_loop - 160 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-28 18:08:21,987 - INFO - AGENT:agent_airsoft_0faa9616 - runnable_component - initiate_shutdown - 74 - Component AgentRunner (instance: 4506535456) received shutdown request. Initiating graceful shutdown...
2025-05-28 18:08:21,987 - INFO - AGENT:agent_airsoft_0faa9616 - runnable_component - initiate_shutdown - 79 - Cancelling main task (_run_loop) for AgentRunner (instance: 4506535456)...
2025-05-28 18:08:21,987 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - run_loop - 172 - ServiceComponentBase run_loop finished.
2025-05-28 18:08:21,987 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - run_loop - 536 - AgentRunner run_loop finished.
2025-05-28 18:08:21,987 - INFO - AGENT:agent_airsoft_0faa9616 - runnable_component - run - 116 - Run_loop for AgentRunner (instance: 4506535456) was cancelled.
2025-05-28 18:08:21,987 - INFO - AGENT:agent_airsoft_0faa9616 - runnable_component - run - 123 - Component AgentRunner (instance: 4506535456) stopping. Performing cleanup...
2025-05-28 18:08:21,987 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - cleanup - 546 - AgentRunner cleanup started.
2025-05-28 18:08:21,989 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - cleanup - 552 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 0) on start/restart.
2025-05-28 18:08:21,989 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - cleanup - 181 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-28 18:08:21,989 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - cleanup - 191 - Waiting for 1 tasks to process cancellation...
2025-05-28 18:08:21,989 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 270 - Pub/Sub listener task cancelled.
2025-05-28 18:08:21,989 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 294 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-28 18:08:21,989 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 298 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-28 18:08:21,989 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - cleanup - 202 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-28 18:08:21,990 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - cleanup - 207 - All main tasks processed and list cleared.
2025-05-28 18:08:21,994 - INFO - AGENT:agent_airsoft_0faa9616 - status_updater - cleanup_status_updater - 316 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-28 18:08:21,995 - INFO - AGENT:agent_airsoft_0faa9616 - status_updater - delete_status_key_from_redis - 196 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-28 18:08:21,995 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:08:21,995 - INFO - AGENT:agent_airsoft_0faa9616 - status_updater - cleanup_status_updater - 320 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-28 18:08:21,995 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - cleanup - 211 - ServiceComponent cleanup completed.
2025-05-28 18:08:21,995 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - cleanup - 581 - AgentRunner cleanup finished.
2025-05-28 18:08:21,995 - INFO - AGENT:agent_airsoft_0faa9616 - runnable_component - run - 128 - Component AgentRunner (instance: 4506535456) cleanup complete.
2025-05-28 18:08:21,995 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 51 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-28 18:08:21,995 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 60 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-28 18:08:21,996 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 18:08:21,996 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 63 - Database engine closed.
2025-05-28 18:08:21,996 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 66 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-28 18:08:21,997 - INFO - __main__ - runner_main - <module> - 86 - Agent runner main finished.
2025-05-28 18:09:26,622 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 18:09:26,622 - INFO - app.core.lifespan - lifespan - lifespan - 277 - Application startup sequence initiated.
2025-05-28 18:09:26,628 - INFO - app.services.redis_service - redis_service - init_redis_pool - 24 - Redis connection pool initialized successfully.
2025-05-28 18:09:26,628 - INFO - app.core.lifespan - lifespan - start_background_tasks - 172 - Starting background tasks...
2025-05-28 18:09:26,628 - INFO - app.core.lifespan - lifespan - start_background_tasks - 182 - History saver worker started, listening to queue: chat_history_queue
2025-05-28 18:09:26,628 - INFO - TokenUsageWorker - token_usage_worker - __init__ - 45 - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-28 18:09:26,628 - INFO - app.core.lifespan - lifespan - start_background_tasks - 194 - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-28 18:09:26,628 - INFO - app.core.lifespan - lifespan - start_background_tasks - 206 - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-28 18:09:26,628 - INFO - app.core.lifespan - lifespan - start_background_tasks - 210 - 3 background tasks initiated.
2025-05-28 18:09:26,628 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 51 - Attempting to start existing agents and their integrations...
2025-05-28 18:09:26,628 - INFO - HistorySaverWorker - base_worker - setup - 48 - [history_saver_worker] Worker setup started.
2025-05-28 18:09:26,628 - INFO - TokenUsageWorker - base_worker - setup - 48 - [token_usage_worker] Worker setup started.
2025-05-28 18:09:26,628 - INFO - InactivityMonitorWorker - base_worker - setup - 48 - [inactivity_monitor_worker] Worker setup started.
2025-05-28 18:09:26,631 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 61 - ProcessManager setup complete for startup.
2025-05-28 18:09:26,632 - INFO - InactivityMonitorWorker - base_worker - setup - 52 - [inactivity_monitor_worker] Worker setup completed.
2025-05-28 18:09:26,632 - INFO - InactivityMonitorWorker - base_worker - setup - 243 - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-28 18:09:26,633 - INFO - HistorySaverWorker - base_worker - setup - 52 - [history_saver_worker] Worker setup completed.
2025-05-28 18:09:26,633 - INFO - HistorySaverWorker - base_worker - setup - 114 - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-28 18:09:26,633 - INFO - TokenUsageWorker - base_worker - setup - 52 - [token_usage_worker] Worker setup completed.
2025-05-28 18:09:26,633 - INFO - TokenUsageWorker - base_worker - setup - 114 - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-28 18:09:26,635 - INFO - TokenUsageWorker - token_usage_worker - setup - 57 - [token_usage_worker] Database session factory initialized.
2025-05-28 18:09:26,635 - INFO - HistorySaverWorker - history_saver_worker - setup - 49 - [history_saver_worker] Database session factory initialized.
2025-05-28 18:09:26,635 - INFO - HistorySaverWorker - runnable_component - run - 111 - Component HistorySaverWorker (instance: 4381985584) setup complete. Starting run loop.
2025-05-28 18:09:26,635 - INFO - HistorySaverWorker - base_worker - run_loop - 131 - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-28 18:09:26,637 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 86 - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-28 18:09:26,637 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 94 - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-28 18:09:26,637 - INFO - TokenUsageWorker - token_usage_worker - setup - 64 - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-28 18:09:26,637 - INFO - TokenUsageWorker - runnable_component - run - 111 - Component TokenUsageWorker (instance: 4382293024) setup complete. Starting run loop.
2025-05-28 18:09:26,637 - INFO - TokenUsageWorker - base_worker - run_loop - 131 - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-28 18:09:26,682 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 66 - Found 1 agents to potentially start.
2025-05-28 18:09:26,683 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 69 - Attempting to start agent: agent_airsoft_0faa9616
2025-05-28 18:09:26,685 - INFO - app.services.process_manager - process_manager - start_agent_process - 880 - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-28 18:09:26,686 - INFO - app.core.base.process_launcher - process_launcher - launch_process - 160 - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 579
2025-05-28 18:09:26,686 - INFO - app.services.process_manager - process_manager - start_agent_process - 913 - Agent process agent_airsoft_0faa9616 initiated start with PID 579
2025-05-28 18:09:26,686 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 79 - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-28 18:09:26,686 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 93 - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-28 18:09:26,686 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 109 - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-28 18:09:26,688 - INFO - app.services.process_manager - process_manager - start_integration_process - 554 - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-28 18:09:26,689 - INFO - app.core.base.process_launcher - process_launcher - launch_process - 160 - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 580
2025-05-28 18:09:26,689 - INFO - app.services.process_manager - process_manager - start_integration_process - 600 - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 580
2025-05-28 18:09:26,690 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 123 - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-28 18:09:26,691 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:09:26,691 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 18:09:26,691 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 153 - ProcessManager cleanup complete for startup function.
2025-05-28 18:09:26,691 - INFO - app.core.lifespan - lifespan - lifespan - 284 - Application startup sequence completed.
2025-05-28 18:09:27,609 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 18:09:27,609 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot_main - main_async_runner - 50 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-28 18:09:27,609 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot_main - main_async_runner - 57 - Database session factory configured for Telegram bot.
2025-05-28 18:09:27,609 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - __init__ - 44 - ServiceComponentBase initialized.
2025-05-28 18:09:27,609 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - __init__ - 56 - TelegramIntegrationBot initialized. PID: 580
2025-05-28 18:09:27,609 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot_main - main_async_runner - 74 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-28 18:09:27,610 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - setup - 441 - TelegramIntegrationBot setup started.
2025-05-28 18:09:27,610 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - setup - 84 - ServiceComponent setup started.
2025-05-28 18:09:27,616 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - setup - 95 - ServiceComponent setup completed.
2025-05-28 18:09:27,629 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - setup - 452 - Aiogram Bot and Dispatcher initialized.
2025-05-28 18:09:27,629 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _register_handlers - 341 - Aiogram handlers registered.
2025-05-28 18:09:27,629 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - setup - 456 - TelegramIntegrationBot setup complete.
2025-05-28 18:09:27,629 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - runnable_component - run - 111 - Component TelegramIntegrationBot (instance: 4723776912) setup complete. Starting run loop.
2025-05-28 18:09:27,629 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - run_loop - 464 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-28 18:09:27,629 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - _register_main_task - 62 - Registered main task: RedisOutputListener
2025-05-28 18:09:27,629 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - _register_main_task - 62 - Registered main task: AiogramPolling
2025-05-28 18:09:27,630 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - run_loop - 122 - Starting run_loop with 2 registered main tasks.
2025-05-28 18:09:27,630 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 236 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-28 18:09:27,630 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - polling_wrapper - 473 - Starting aiogram polling...
2025-05-28 18:09:27,630 - INFO - aiogram.dispatcher - dispatcher - start_polling - 527 - Start polling
2025-05-28 18:09:27,633 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 254 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-28 18:09:27,887 - INFO - aiogram.dispatcher - dispatcher - _polling - 341 - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-28 18:09:28,056 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 18:09:28,056 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 21 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-28 18:09:28,056 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 28 - Database session factory configured for Agent.
2025-05-28 18:09:28,056 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - __init__ - 44 - ServiceComponentBase initialized.
2025-05-28 18:09:28,056 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - __init__ - 120 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 579
2025-05-28 18:09:28,056 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 42 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-28 18:09:28,056 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - setup - 494 - AgentRunner setup started.
2025-05-28 18:09:28,056 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - setup - 84 - ServiceComponent setup started.
2025-05-28 18:09:28,062 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - setup - 95 - ServiceComponent setup completed.
2025-05-28 18:09:28,062 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - fetch_config - 27 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-28 18:09:28,142 - INFO - httpx - _client - _send_single_request - 1740 - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-28 18:09:28,142 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - fetch_config - 33 - Configuration fetched successfully.
2025-05-28 18:09:28,142 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _load_config - 138 - Agent configuration loaded and prepared successfully.
2025-05-28 18:09:28,142 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _setup_app - 149 - Creating LangGraph application...
2025-05-28 18:09:28,142 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_agent_app - 913 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-28 18:09:28,142 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_llm_instance - 80 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-28 18:09:28,168 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _configure_main_llm - 63 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-28 18:09:28,168 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 818 - Creating agent graph in GraphFactory...
2025-05-28 18:09:28,168 - INFO - app.agent_runner.common.tools_registry - tools_registry - configure_tools_centralized - 364 - Configured 3 predefined tools from centralized registry
2025-05-28 18:09:28,168 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 94 - Added 3 tools from centralized registry
2025-05-28 18:09:28,168 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 114 - Configuring 1 Knowledge Base tool(s)...
2025-05-28 18:09:28,223 - INFO - httpx - _client - _send_single_request - 1025 - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-28 18:09:28,227 - INFO - httpx - _client - _send_single_request - 1025 - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-28 18:09:29,202 - INFO - httpx - _client - _send_single_request - 1025 - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-28 18:09:29,204 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 132 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-28 18:09:29,205 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 166 - Must conditions for KB tool 'knowledgeBase-1745316404538': [FieldCondition(key='metadata.client_id', match=MatchValue(value='2'), range=None, geo_bounding_box=None, geo_radius=None, geo_polygon=None, values_count=None), FieldCondition(key='metadata.datasource_id', match=MatchAny(any=['5', '6', '7']), range=None, geo_bounding_box=None, geo_radius=None, geo_polygon=None, values_count=None)]
2025-05-28 18:09:29,205 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 182 - Configured Knowledge Base tool 'База знаний' (ID: knowledgeBase-1745316404538) for datasources: ['5', '6', '7']
2025-05-28 18:09:29,205 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 190 - Using max_rewrites: 4
2025-05-28 18:09:29,205 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 217 - Configured Web Search tool 'Поиск в Интернете' (ID: webSearch-1746879979658)
2025-05-28 18:09:29,205 - INFO - app.agent_runner.langgraph.tools - tools - configure_tools - 244 - Total tools configured: 5 (4 safe, 1 datastore).
2025-05-28 18:09:29,205 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _configure_tools - 153 - Tools configured: 5 total, 4 safe, 1 datastore tools. Max rewrites: 4.
2025-05-28 18:09:29,205 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 826 - Context memory enabled: True
2025-05-28 18:09:29,206 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 834 - Added node: agent
2025-05-28 18:09:29,206 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 843 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-28 18:09:29,206 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 853 - Added node: safe_tools
2025-05-28 18:09:29,206 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 864 - Added edge: safe_tools -> agent
2025-05-28 18:09:29,206 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 870 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-28 18:09:29,207 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 877 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-28 18:09:29,207 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 893 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-28 18:09:29,217 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 905 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-28 18:09:29,217 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_agent_app - 922 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-28 18:09:29,217 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _setup_app - 157 - LangGraph application created successfully.
2025-05-28 18:09:29,218 - INFO - AGENT:agent_airsoft_0faa9616 - runnable_component - run - 111 - Component AgentRunner (instance: 4494132912) setup complete. Starting run loop.
2025-05-28 18:09:29,218 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - run_loop - 522 - AgentRunner run_loop starting...
2025-05-28 18:09:29,218 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - _register_main_task - 62 - Registered main task: AgentPubSubListener
2025-05-28 18:09:29,218 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - run_loop - 122 - Starting run_loop with 1 registered main tasks.
2025-05-28 18:09:29,218 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 236 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-28 18:09:29,220 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 254 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-28 18:09:36,637 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 96 - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-28 18:09:36,645 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 98 - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-28 18:09:36,645 - INFO - InactivityMonitorWorker - runnable_component - run - 111 - Component InactivityMonitorWorker (instance: 4382286688) setup complete. Starting run loop.
2025-05-28 18:09:36,645 - INFO - InactivityMonitorWorker - base_worker - run_loop - 258 - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-28 18:14:36,869 - INFO - InactivityMonitorWorker - base_worker - run_loop - 275 - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 18:14:36,898 - INFO - InactivityMonitorWorker - base_worker - run_loop - 281 - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 18:19:37,090 - INFO - InactivityMonitorWorker - base_worker - run_loop - 275 - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 18:19:37,100 - INFO - InactivityMonitorWorker - base_worker - run_loop - 281 - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 18:24:37,301 - INFO - InactivityMonitorWorker - base_worker - run_loop - 275 - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 18:24:37,310 - INFO - InactivityMonitorWorker - base_worker - run_loop - 281 - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 18:29:37,504 - INFO - InactivityMonitorWorker - base_worker - run_loop - 275 - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 18:29:37,511 - INFO - InactivityMonitorWorker - base_worker - run_loop - 281 - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 18:34:37,701 - INFO - InactivityMonitorWorker - base_worker - run_loop - 275 - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 18:34:37,715 - INFO - InactivityMonitorWorker - base_worker - run_loop - 281 - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 18:37:44,976 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _handle_text_message - 287 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Привет...'
2025-05-28 18:37:44,988 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _check_user_authorization - 127 - Auth cache miss for user 144641834, agent agent_airsoft_0faa9616. Checking DB.
2025-05-28 18:37:45,406 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _check_user_authorization - 147 - User 144641834 (DBID: 1) IS authorized for agent agent_airsoft_0faa9616 via DB.
2025-05-28 18:37:45,410 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _publish_to_agent - 101 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-28 18:37:45,410 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _handle_text_message - 313 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-28 18:37:45,424 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _handle_pubsub_message - 202 - Processing message for chat_id: 144641834
2025-05-28 18:37:45,437 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _save_history - 481 - Queued user message for history (Thread: 144641834, InteractionID: 3206e391-9023-48f6-8962-173dc3553bf4)
2025-05-28 18:37:45,440 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _get_history - 417 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-28 18:37:45,442 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _get_history - 423 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-28 18:37:45,630 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _get_history - 433 - Loaded 20 messages from DB for thread '144641834'.
2025-05-28 18:37:45,632 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _get_history - 436 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-28 18:37:45,632 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _invoke_agent - 366 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-28 18:37:45,655 - INFO - HistorySaverWorker - history_saver_worker - process_message - 123 - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 3206e391-9023-48f6-8962-173dc3553bf4, db_id: 896
2025-05-28 18:37:45,733 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 255 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-28 18:37:45,734 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_llm_instance - 80 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-28 18:37:45,769 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_node_llm - 713 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-28 18:37:45,777 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _bind_tools_to_model - 804 - Model bound to 5 tools.
2025-05-28 18:37:46,411 - INFO - aiogram.event - dispatcher - feed_update - 172 - Update id=804756294 is handled. Duration 1456 ms by bot id=1750613938
2025-05-28 18:37:46,834 - INFO - httpx - _client - _send_single_request - 1740 - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-28 18:37:47,011 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 285 - Agent node response content preview: Привет-привет! Как настроение? Чем могу помочь? 😉
2025-05-28 18:37:47,011 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 287 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-28 18:37:47,011 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 289 - Agent node usage_metadata: {'input_tokens': 1701, 'output_tokens': 14, 'total_tokens': 1715, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-28 18:37:47,011 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _extract_token_data - 218 - Token usage from usage_metadata: P:1701 C:14 T:1715
2025-05-28 18:37:47,011 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _get_tokens - 250 - Token usage for agent_llm: 1715 tokens recorded.
2025-05-28 18:37:47,012 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _route_tools_edge - 605 - ---ROUTE TOOLS---
2025-05-28 18:37:47,012 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _route_tools_edge - 613 - ---DECISION: NO TOOLS CALLED, END---
2025-05-28 18:37:47,013 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _invoke_agent - 384 - Graph execution finished. Final response: Привет-привет! Как настроение? Чем могу помочь? 😉...
2025-05-28 18:37:47,016 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _save_history - 481 - Queued agent message for history (Thread: 144641834, InteractionID: 3206e391-9023-48f6-8962-173dc3553bf4)
2025-05-28 18:37:47,019 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _save_tokens - 315 - Found 1 token usage events for InteractionID: 3206e391-9023-48f6-8962-173dc3553bf4.
2025-05-28 18:37:47,026 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _handle_pubsub_message - 385 - Received response from agent for chat 144641834: Привет-привет! Как настроение? Чем могу помочь? 😉...
2025-05-28 18:37:47,026 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _handle_pubsub_message - 414 - Sending message from agent to chat 144641834: 'Привет-привет! Как настроение? Чем могу помочь? 😉...'
2025-05-28 18:37:47,036 - INFO - TokenUsageWorker - token_usage_worker - process_message - 117 - [token_usage_worker] RAW token usage data: {'interaction_id': '3206e391-9023-48f6-8962-173dc3553bf4', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1701, 'completion_tokens': 14, 'total_tokens': 1715, 'timestamp': '2025-05-28T13:37:47.011284+00:00'}
2025-05-28 18:37:47,036 - INFO - TokenUsageWorker - token_usage_worker - process_message - 129 - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 3206e391-9023-48f6-8962-173dc3553bf4
2025-05-28 18:37:47,052 - INFO - HistorySaverWorker - history_saver_worker - process_message - 123 - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 3206e391-9023-48f6-8962-173dc3553bf4, db_id: 897
2025-05-28 18:37:47,085 - INFO - TokenUsageWorker - token_usage_worker - process_message - 148 - [token_usage_worker] Found message_id: 897 for interaction_id: 3206e391-9023-48f6-8962-173dc3553bf4 on attempt 1
2025-05-28 18:37:47,092 - INFO - TokenUsageWorker - token_usage_worker - _save_token_usage_to_db - 92 - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 3206e391-9023-48f6-8962-173dc3553bf4, db_id: 362
2025-05-28 18:38:00,154 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _handle_text_message - 287 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'что ты умеешь?...'
2025-05-28 18:38:00,156 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _check_user_authorization - 124 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-28 18:38:00,162 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _publish_to_agent - 101 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-28 18:38:00,162 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _handle_text_message - 313 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-28 18:38:00,162 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _handle_pubsub_message - 202 - Processing message for chat_id: 144641834
2025-05-28 18:38:00,163 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _save_history - 481 - Queued user message for history (Thread: 144641834, InteractionID: 48253de1-9e83-40ee-a740-869240b1f8f2)
2025-05-28 18:38:00,163 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _get_history - 417 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-28 18:38:00,164 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _get_history - 439 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-28 18:38:00,164 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _invoke_agent - 366 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-28 18:38:00,168 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 255 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-28 18:38:00,168 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_llm_instance - 80 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-28 18:38:00,171 - INFO - HistorySaverWorker - history_saver_worker - process_message - 123 - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 48253de1-9e83-40ee-a740-869240b1f8f2, db_id: 898
2025-05-28 18:38:00,193 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_node_llm - 713 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-28 18:38:00,196 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _bind_tools_to_model - 804 - Model bound to 5 tools.
2025-05-28 18:38:00,854 - INFO - httpx - _client - _send_single_request - 1740 - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-28 18:38:01,162 - INFO - aiogram.event - dispatcher - feed_update - 172 - Update id=804756295 is handled. Duration 1008 ms by bot id=1750613938
2025-05-28 18:38:01,491 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 285 - Agent node response content preview: Ой, я умею много интересного! Вот несколько моих суперспособностей:

- Отвечать на вопросы и давать 
2025-05-28 18:38:01,491 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 287 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_658b958c37'}
2025-05-28 18:38:01,491 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 289 - Agent node usage_metadata: {'input_tokens': 1727, 'output_tokens': 119, 'total_tokens': 1846, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-28 18:38:01,491 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _extract_token_data - 218 - Token usage from usage_metadata: P:1727 C:119 T:1846
2025-05-28 18:38:01,491 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _get_tokens - 250 - Token usage for agent_llm: 1846 tokens recorded.
2025-05-28 18:38:01,492 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _route_tools_edge - 605 - ---ROUTE TOOLS---
2025-05-28 18:38:01,492 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _route_tools_edge - 613 - ---DECISION: NO TOOLS CALLED, END---
2025-05-28 18:38:01,493 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _invoke_agent - 384 - Graph execution finished. Final response: Ой, я умею много интересного! Вот несколько моих суперспособностей:

- Отвечать на вопросы и давать ...
2025-05-28 18:38:01,495 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _save_history - 481 - Queued agent message for history (Thread: 144641834, InteractionID: 48253de1-9e83-40ee-a740-869240b1f8f2)
2025-05-28 18:38:01,496 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _save_tokens - 315 - Found 1 token usage events for InteractionID: 48253de1-9e83-40ee-a740-869240b1f8f2.
2025-05-28 18:38:01,498 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _handle_pubsub_message - 385 - Received response from agent for chat 144641834: Ой, я умею много интересного! Вот несколько моих суперспособностей:

- Отвечать на вопросы и давать ...
2025-05-28 18:38:01,498 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _handle_pubsub_message - 414 - Sending message from agent to chat 144641834: 'Ой, я умею много интересного! Вот несколько моих с...'
2025-05-28 18:38:01,500 - INFO - TokenUsageWorker - token_usage_worker - process_message - 117 - [token_usage_worker] RAW token usage data: {'interaction_id': '48253de1-9e83-40ee-a740-869240b1f8f2', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1727, 'completion_tokens': 119, 'total_tokens': 1846, 'timestamp': '2025-05-28T13:38:01.491457+00:00'}
2025-05-28 18:38:01,500 - INFO - TokenUsageWorker - token_usage_worker - process_message - 129 - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 48253de1-9e83-40ee-a740-869240b1f8f2
2025-05-28 18:38:01,506 - INFO - HistorySaverWorker - history_saver_worker - process_message - 123 - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 48253de1-9e83-40ee-a740-869240b1f8f2, db_id: 899
2025-05-28 18:38:01,506 - INFO - TokenUsageWorker - token_usage_worker - process_message - 148 - [token_usage_worker] Found message_id: 899 for interaction_id: 48253de1-9e83-40ee-a740-869240b1f8f2 on attempt 1
2025-05-28 18:38:01,511 - INFO - TokenUsageWorker - token_usage_worker - _save_token_usage_to_db - 92 - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 48253de1-9e83-40ee-a740-869240b1f8f2, db_id: 363
2025-05-28 18:38:42,530 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _handle_text_message - 287 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Что ты можешь сказать про нюаны перехода на ут11?...'
2025-05-28 18:38:42,532 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _check_user_authorization - 124 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-28 18:38:42,536 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _publish_to_agent - 101 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-28 18:38:42,536 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _handle_text_message - 313 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-28 18:38:42,536 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _handle_pubsub_message - 202 - Processing message for chat_id: 144641834
2025-05-28 18:38:42,537 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _save_history - 481 - Queued user message for history (Thread: 144641834, InteractionID: 79460fdd-5d2f-4527-bad8-6541bc96f73f)
2025-05-28 18:38:42,537 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _get_history - 417 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-28 18:38:42,538 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _get_history - 439 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-28 18:38:42,539 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _invoke_agent - 366 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-28 18:38:42,545 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 255 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-28 18:38:42,545 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_llm_instance - 80 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-28 18:38:42,547 - INFO - HistorySaverWorker - history_saver_worker - process_message - 123 - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 79460fdd-5d2f-4527-bad8-6541bc96f73f, db_id: 900
2025-05-28 18:38:42,574 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_node_llm - 713 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-28 18:38:42,579 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _bind_tools_to_model - 804 - Model bound to 5 tools.
2025-05-28 18:38:43,468 - INFO - httpx - _client - _send_single_request - 1740 - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-28 18:38:43,537 - INFO - aiogram.event - dispatcher - feed_update - 172 - Update id=804756296 is handled. Duration 1007 ms by bot id=1750613938
2025-05-28 18:38:55,016 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 285 - Agent node response content preview: Ой, нюансов при переходе на 1С:Управление торговлей 11 действительно много! Вот самые важные, на кот
2025-05-28 18:38:55,016 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 287 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_38647f5e19'}
2025-05-28 18:38:55,016 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 289 - Agent node usage_metadata: {'input_tokens': 1867, 'output_tokens': 266, 'total_tokens': 2133, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-28 18:38:55,016 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _extract_token_data - 218 - Token usage from usage_metadata: P:1867 C:266 T:2133
2025-05-28 18:38:55,016 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _get_tokens - 250 - Token usage for agent_llm: 2133 tokens recorded.
2025-05-28 18:38:55,017 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _route_tools_edge - 605 - ---ROUTE TOOLS---
2025-05-28 18:38:55,017 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _route_tools_edge - 613 - ---DECISION: NO TOOLS CALLED, END---
2025-05-28 18:38:55,018 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _invoke_agent - 384 - Graph execution finished. Final response: Ой, нюансов при переходе на 1С:Управление торговлей 11 действительно много! Вот самые важные, на кот...
2025-05-28 18:38:55,021 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _save_history - 481 - Queued agent message for history (Thread: 144641834, InteractionID: 79460fdd-5d2f-4527-bad8-6541bc96f73f)
2025-05-28 18:38:55,021 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _save_tokens - 315 - Found 1 token usage events for InteractionID: 79460fdd-5d2f-4527-bad8-6541bc96f73f.
2025-05-28 18:38:55,023 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _handle_pubsub_message - 385 - Received response from agent for chat 144641834: Ой, нюансов при переходе на 1С:Управление торговлей 11 действительно много! Вот самые важные, на кот...
2025-05-28 18:38:55,023 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _handle_pubsub_message - 414 - Sending message from agent to chat 144641834: 'Ой, нюансов при переходе на 1С:Управление торговле...'
2025-05-28 18:38:55,025 - INFO - TokenUsageWorker - token_usage_worker - process_message - 117 - [token_usage_worker] RAW token usage data: {'interaction_id': '79460fdd-5d2f-4527-bad8-6541bc96f73f', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1867, 'completion_tokens': 266, 'total_tokens': 2133, 'timestamp': '2025-05-28T13:38:55.016670+00:00'}
2025-05-28 18:38:55,025 - INFO - TokenUsageWorker - token_usage_worker - process_message - 129 - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 79460fdd-5d2f-4527-bad8-6541bc96f73f
2025-05-28 18:38:55,028 - INFO - TokenUsageWorker - token_usage_worker - process_message - 148 - [token_usage_worker] Found message_id: 900 for interaction_id: 79460fdd-5d2f-4527-bad8-6541bc96f73f on attempt 1
2025-05-28 18:38:55,031 - INFO - HistorySaverWorker - history_saver_worker - process_message - 123 - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 79460fdd-5d2f-4527-bad8-6541bc96f73f, db_id: 901
2025-05-28 18:38:55,047 - INFO - TokenUsageWorker - token_usage_worker - _save_token_usage_to_db - 92 - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 79460fdd-5d2f-4527-bad8-6541bc96f73f, db_id: 364
2025-05-28 18:39:37,915 - INFO - InactivityMonitorWorker - base_worker - run_loop - 275 - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 18:39:37,924 - INFO - InactivityMonitorWorker - base_worker - run_loop - 281 - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 18:42:37,287 - INFO - app.core.lifespan - lifespan - lifespan - 287 - Application shutdown sequence initiated.
2025-05-28 18:42:37,288 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 230 - Stopping 3 background tasks...
2025-05-28 18:42:37,288 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task HistorySaverWorker...
2025-05-28 18:42:37,289 - INFO - HistorySaverWorker - runnable_component - run - 116 - Run_loop for HistorySaverWorker (instance: 4381985584) was cancelled.
2025-05-28 18:42:37,289 - INFO - HistorySaverWorker - runnable_component - run - 123 - Component HistorySaverWorker (instance: 4381985584) stopping. Performing cleanup...
2025-05-28 18:42:37,289 - INFO - HistorySaverWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 18:42:37,293 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for history_saver_worker as part of cleanup.
2025-05-28 18:42:37,294 - INFO - HistorySaverWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-28 18:42:37,294 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:42:37,295 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-28 18:42:37,295 - INFO - HistorySaverWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 18:42:37,295 - INFO - HistorySaverWorker - runnable_component - run - 128 - Component HistorySaverWorker (instance: 4381985584) cleanup complete.
2025-05-28 18:42:37,295 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task HistorySaverWorker finished after cancellation signal.
2025-05-28 18:42:37,295 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task TokenUsageWorker...
2025-05-28 18:42:37,295 - INFO - TokenUsageWorker - runnable_component - run - 116 - Run_loop for TokenUsageWorker (instance: 4382293024) was cancelled.
2025-05-28 18:42:37,295 - INFO - TokenUsageWorker - runnable_component - run - 123 - Component TokenUsageWorker (instance: 4382293024) stopping. Performing cleanup...
2025-05-28 18:42:37,295 - INFO - TokenUsageWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 18:42:37,296 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for token_usage_worker as part of cleanup.
2025-05-28 18:42:37,297 - INFO - TokenUsageWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-28 18:42:37,297 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:42:37,297 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-28 18:42:37,297 - INFO - TokenUsageWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 18:42:37,297 - INFO - TokenUsageWorker - runnable_component - run - 128 - Component TokenUsageWorker (instance: 4382293024) cleanup complete.
2025-05-28 18:42:37,297 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task TokenUsageWorker finished after cancellation signal.
2025-05-28 18:42:37,297 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task InactivityMonitorWorker...
2025-05-28 18:42:37,297 - INFO - InactivityMonitorWorker - runnable_component - run - 116 - Run_loop for InactivityMonitorWorker (instance: 4382286688) was cancelled.
2025-05-28 18:42:37,297 - INFO - InactivityMonitorWorker - runnable_component - run - 123 - Component InactivityMonitorWorker (instance: 4382286688) stopping. Performing cleanup...
2025-05-28 18:42:37,298 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 437 - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-28 18:42:37,298 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:42:37,298 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 18:42:37,298 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 441 - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-28 18:42:37,298 - INFO - InactivityMonitorWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 18:42:37,299 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-28 18:42:37,300 - INFO - InactivityMonitorWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-28 18:42:37,300 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:42:37,300 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-28 18:42:37,301 - INFO - InactivityMonitorWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 18:42:37,301 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 445 - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-28 18:42:37,301 - INFO - InactivityMonitorWorker - runnable_component - run - 128 - Component InactivityMonitorWorker (instance: 4382286688) cleanup complete.
2025-05-28 18:42:37,301 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-28 18:42:37,301 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 249 - All background tasks signaled to stop.
2025-05-28 18:42:37,301 - INFO - app.services.redis_service - redis_service - close_redis_pool - 43 - Redis connection pool closed successfully.
2025-05-28 18:42:37,318 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 18:42:37,318 - INFO - app.core.lifespan - lifespan - lifespan - 293 - Application shutdown sequence completed.
2025-05-28 18:42:37,811 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 18:42:37,811 - INFO - app.core.lifespan - lifespan - lifespan - 277 - Application startup sequence initiated.
2025-05-28 18:42:37,816 - INFO - app.services.redis_service - redis_service - init_redis_pool - 24 - Redis connection pool initialized successfully.
2025-05-28 18:42:37,816 - INFO - app.core.lifespan - lifespan - start_background_tasks - 172 - Starting background tasks...
2025-05-28 18:42:37,816 - INFO - app.core.lifespan - lifespan - start_background_tasks - 182 - History saver worker started, listening to queue: chat_history_queue
2025-05-28 18:42:37,816 - INFO - TokenUsageWorker - token_usage_worker - __init__ - 45 - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-28 18:42:37,816 - INFO - app.core.lifespan - lifespan - start_background_tasks - 194 - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-28 18:42:37,816 - INFO - app.core.lifespan - lifespan - start_background_tasks - 206 - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-28 18:42:37,816 - INFO - app.core.lifespan - lifespan - start_background_tasks - 210 - 3 background tasks initiated.
2025-05-28 18:42:37,816 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 51 - Attempting to start existing agents and their integrations...
2025-05-28 18:42:37,817 - INFO - HistorySaverWorker - base_worker - setup - 48 - [history_saver_worker] Worker setup started.
2025-05-28 18:42:37,817 - INFO - TokenUsageWorker - base_worker - setup - 48 - [token_usage_worker] Worker setup started.
2025-05-28 18:42:37,817 - INFO - InactivityMonitorWorker - base_worker - setup - 48 - [inactivity_monitor_worker] Worker setup started.
2025-05-28 18:42:37,818 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 61 - ProcessManager setup complete for startup.
2025-05-28 18:42:37,819 - INFO - HistorySaverWorker - base_worker - setup - 52 - [history_saver_worker] Worker setup completed.
2025-05-28 18:42:37,819 - INFO - HistorySaverWorker - base_worker - setup - 114 - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-28 18:42:37,820 - INFO - InactivityMonitorWorker - base_worker - setup - 52 - [inactivity_monitor_worker] Worker setup completed.
2025-05-28 18:42:37,820 - INFO - InactivityMonitorWorker - base_worker - setup - 243 - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-28 18:42:37,820 - INFO - TokenUsageWorker - base_worker - setup - 52 - [token_usage_worker] Worker setup completed.
2025-05-28 18:42:37,820 - INFO - TokenUsageWorker - base_worker - setup - 114 - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-28 18:42:37,823 - INFO - HistorySaverWorker - history_saver_worker - setup - 49 - [history_saver_worker] Database session factory initialized.
2025-05-28 18:42:37,823 - INFO - HistorySaverWorker - runnable_component - run - 111 - Component HistorySaverWorker (instance: 4446348896) setup complete. Starting run loop.
2025-05-28 18:42:37,823 - INFO - TokenUsageWorker - token_usage_worker - setup - 57 - [token_usage_worker] Database session factory initialized.
2025-05-28 18:42:37,823 - INFO - HistorySaverWorker - base_worker - run_loop - 131 - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-28 18:42:37,823 - INFO - TokenUsageWorker - token_usage_worker - setup - 64 - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-28 18:42:37,823 - INFO - TokenUsageWorker - runnable_component - run - 111 - Component TokenUsageWorker (instance: 4446353408) setup complete. Starting run loop.
2025-05-28 18:42:37,823 - INFO - TokenUsageWorker - base_worker - run_loop - 131 - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-28 18:42:37,825 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 86 - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-28 18:42:37,825 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 94 - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-28 18:42:37,872 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 66 - Found 1 agents to potentially start.
2025-05-28 18:42:37,873 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 69 - Attempting to start agent: agent_airsoft_0faa9616
2025-05-28 18:42:37,874 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 73 - Agent agent_airsoft_0faa9616 is already running.
2025-05-28 18:42:37,874 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 93 - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-28 18:42:37,874 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 109 - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-28 18:42:37,875 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 115 - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-28 18:42:37,875 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:42:37,876 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 18:42:37,876 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 153 - ProcessManager cleanup complete for startup function.
2025-05-28 18:42:37,876 - INFO - app.core.lifespan - lifespan - lifespan - 284 - Application startup sequence completed.
2025-05-28 18:42:47,826 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 96 - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-28 18:42:47,831 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 98 - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-28 18:42:47,831 - INFO - InactivityMonitorWorker - runnable_component - run - 111 - Component InactivityMonitorWorker (instance: 4446781264) setup complete. Starting run loop.
2025-05-28 18:42:47,831 - INFO - InactivityMonitorWorker - base_worker - run_loop - 258 - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-28 18:43:10,307 - INFO - app.core.lifespan - lifespan - lifespan - 287 - Application shutdown sequence initiated.
2025-05-28 18:43:10,308 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 230 - Stopping 3 background tasks...
2025-05-28 18:43:10,308 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task HistorySaverWorker...
2025-05-28 18:43:10,309 - INFO - HistorySaverWorker - runnable_component - run - 116 - Run_loop for HistorySaverWorker (instance: 4446348896) was cancelled.
2025-05-28 18:43:10,309 - INFO - HistorySaverWorker - runnable_component - run - 123 - Component HistorySaverWorker (instance: 4446348896) stopping. Performing cleanup...
2025-05-28 18:43:10,309 - INFO - HistorySaverWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 18:43:10,316 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for history_saver_worker as part of cleanup.
2025-05-28 18:43:10,317 - INFO - HistorySaverWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-28 18:43:10,317 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:43:10,317 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-28 18:43:10,317 - INFO - HistorySaverWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 18:43:10,317 - INFO - HistorySaverWorker - runnable_component - run - 128 - Component HistorySaverWorker (instance: 4446348896) cleanup complete.
2025-05-28 18:43:10,317 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task HistorySaverWorker finished after cancellation signal.
2025-05-28 18:43:10,317 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task TokenUsageWorker...
2025-05-28 18:43:10,317 - INFO - TokenUsageWorker - runnable_component - run - 116 - Run_loop for TokenUsageWorker (instance: 4446353408) was cancelled.
2025-05-28 18:43:10,317 - INFO - TokenUsageWorker - runnable_component - run - 123 - Component TokenUsageWorker (instance: 4446353408) stopping. Performing cleanup...
2025-05-28 18:43:10,317 - INFO - TokenUsageWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 18:43:10,321 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for token_usage_worker as part of cleanup.
2025-05-28 18:43:10,322 - INFO - TokenUsageWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-28 18:43:10,322 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:43:10,323 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-28 18:43:10,323 - INFO - TokenUsageWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 18:43:10,323 - INFO - TokenUsageWorker - runnable_component - run - 128 - Component TokenUsageWorker (instance: 4446353408) cleanup complete.
2025-05-28 18:43:10,323 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task TokenUsageWorker finished after cancellation signal.
2025-05-28 18:43:10,323 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task InactivityMonitorWorker...
2025-05-28 18:43:10,323 - INFO - InactivityMonitorWorker - runnable_component - run - 116 - Run_loop for InactivityMonitorWorker (instance: 4446781264) was cancelled.
2025-05-28 18:43:10,323 - INFO - InactivityMonitorWorker - runnable_component - run - 123 - Component InactivityMonitorWorker (instance: 4446781264) stopping. Performing cleanup...
2025-05-28 18:43:10,323 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 437 - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-28 18:43:10,323 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:43:10,323 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 18:43:10,323 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 441 - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-28 18:43:10,323 - INFO - InactivityMonitorWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 18:43:10,325 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-28 18:43:10,326 - INFO - InactivityMonitorWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-28 18:43:10,326 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:43:10,326 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-28 18:43:10,326 - INFO - InactivityMonitorWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 18:43:10,326 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 445 - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-28 18:43:10,326 - INFO - InactivityMonitorWorker - runnable_component - run - 128 - Component InactivityMonitorWorker (instance: 4446781264) cleanup complete.
2025-05-28 18:43:10,326 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-28 18:43:10,326 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 249 - All background tasks signaled to stop.
2025-05-28 18:43:10,326 - INFO - app.services.redis_service - redis_service - close_redis_pool - 43 - Redis connection pool closed successfully.
2025-05-28 18:43:10,332 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 18:43:10,332 - INFO - app.core.lifespan - lifespan - lifespan - 293 - Application shutdown sequence completed.
2025-05-28 18:43:10,807 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 18:43:10,807 - INFO - app.core.lifespan - lifespan - lifespan - 277 - Application startup sequence initiated.
2025-05-28 18:43:10,812 - INFO - app.services.redis_service - redis_service - init_redis_pool - 24 - Redis connection pool initialized successfully.
2025-05-28 18:43:10,812 - INFO - app.core.lifespan - lifespan - start_background_tasks - 172 - Starting background tasks...
2025-05-28 18:43:10,812 - INFO - app.core.lifespan - lifespan - start_background_tasks - 182 - History saver worker started, listening to queue: chat_history_queue
2025-05-28 18:43:10,812 - INFO - TokenUsageWorker - token_usage_worker - __init__ - 45 - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-28 18:43:10,812 - INFO - app.core.lifespan - lifespan - start_background_tasks - 194 - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-28 18:43:10,812 - INFO - app.core.lifespan - lifespan - start_background_tasks - 206 - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-28 18:43:10,812 - INFO - app.core.lifespan - lifespan - start_background_tasks - 210 - 3 background tasks initiated.
2025-05-28 18:43:10,812 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 51 - Attempting to start existing agents and their integrations...
2025-05-28 18:43:10,812 - INFO - HistorySaverWorker - base_worker - setup - 48 - [history_saver_worker] Worker setup started.
2025-05-28 18:43:10,812 - INFO - TokenUsageWorker - base_worker - setup - 48 - [token_usage_worker] Worker setup started.
2025-05-28 18:43:10,812 - INFO - InactivityMonitorWorker - base_worker - setup - 48 - [inactivity_monitor_worker] Worker setup started.
2025-05-28 18:43:10,815 - INFO - TokenUsageWorker - base_worker - setup - 52 - [token_usage_worker] Worker setup completed.
2025-05-28 18:43:10,815 - INFO - TokenUsageWorker - base_worker - setup - 114 - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-28 18:43:10,815 - INFO - HistorySaverWorker - base_worker - setup - 52 - [history_saver_worker] Worker setup completed.
2025-05-28 18:43:10,815 - INFO - HistorySaverWorker - base_worker - setup - 114 - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-28 18:43:10,815 - INFO - InactivityMonitorWorker - base_worker - setup - 52 - [inactivity_monitor_worker] Worker setup completed.
2025-05-28 18:43:10,815 - INFO - InactivityMonitorWorker - base_worker - setup - 243 - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-28 18:43:10,815 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 61 - ProcessManager setup complete for startup.
2025-05-28 18:43:10,817 - INFO - TokenUsageWorker - token_usage_worker - setup - 57 - [token_usage_worker] Database session factory initialized.
2025-05-28 18:43:10,817 - INFO - HistorySaverWorker - history_saver_worker - setup - 49 - [history_saver_worker] Database session factory initialized.
2025-05-28 18:43:10,817 - INFO - HistorySaverWorker - runnable_component - run - 111 - Component HistorySaverWorker (instance: 4405837168) setup complete. Starting run loop.
2025-05-28 18:43:10,817 - INFO - HistorySaverWorker - base_worker - run_loop - 131 - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-28 18:43:10,818 - INFO - TokenUsageWorker - token_usage_worker - setup - 64 - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-28 18:43:10,818 - INFO - TokenUsageWorker - runnable_component - run - 111 - Component TokenUsageWorker (instance: 4405836688) setup complete. Starting run loop.
2025-05-28 18:43:10,818 - INFO - TokenUsageWorker - base_worker - run_loop - 131 - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-28 18:43:10,820 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 86 - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-28 18:43:10,820 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 94 - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-28 18:43:10,869 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 66 - Found 1 agents to potentially start.
2025-05-28 18:43:10,869 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 69 - Attempting to start agent: agent_airsoft_0faa9616
2025-05-28 18:43:10,870 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 73 - Agent agent_airsoft_0faa9616 is already running.
2025-05-28 18:43:10,870 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 93 - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-28 18:43:10,870 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 109 - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-28 18:43:10,871 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 115 - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-28 18:43:10,872 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:43:10,872 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 18:43:10,872 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 153 - ProcessManager cleanup complete for startup function.
2025-05-28 18:43:10,872 - INFO - app.core.lifespan - lifespan - lifespan - 284 - Application startup sequence completed.
2025-05-28 18:43:15,442 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - run_loop - 160 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-28 18:43:15,445 - INFO - AGENT:agent_airsoft_0faa9616 - runnable_component - initiate_shutdown - 74 - Component AgentRunner (instance: 4494132912) received shutdown request. Initiating graceful shutdown...
2025-05-28 18:43:15,442 - WARNING - aiogram.dispatcher - dispatcher - _signal_stop_polling - 455 - Received SIGINT signal
2025-05-28 18:43:15,445 - INFO - AGENT:agent_airsoft_0faa9616 - runnable_component - initiate_shutdown - 79 - Cancelling main task (_run_loop) for AgentRunner (instance: 4494132912)...
2025-05-28 18:43:15,445 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - run_loop - 172 - ServiceComponentBase run_loop finished.
2025-05-28 18:43:15,445 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - run_loop - 536 - AgentRunner run_loop finished.
2025-05-28 18:43:15,445 - INFO - AGENT:agent_airsoft_0faa9616 - runnable_component - run - 116 - Run_loop for AgentRunner (instance: 4494132912) was cancelled.
2025-05-28 18:43:15,445 - INFO - AGENT:agent_airsoft_0faa9616 - runnable_component - run - 123 - Component AgentRunner (instance: 4494132912) stopping. Performing cleanup...
2025-05-28 18:43:15,445 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - cleanup - 546 - AgentRunner cleanup started.
2025-05-28 18:43:15,445 - INFO - aiogram.dispatcher - dispatcher - _polling - 359 - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-28 18:43:15,446 - INFO - aiogram.dispatcher - dispatcher - start_polling - 554 - Polling stopped
2025-05-28 18:43:15,446 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - cleanup - 552 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-28 18:43:15,447 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - cleanup - 181 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-28 18:43:15,447 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - cleanup - 191 - Waiting for 1 tasks to process cancellation...
2025-05-28 18:43:15,447 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 270 - Pub/Sub listener task cancelled.
2025-05-28 18:43:15,447 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 294 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-28 18:43:15,448 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 298 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-28 18:43:15,448 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - cleanup - 202 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-28 18:43:15,448 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - cleanup - 207 - All main tasks processed and list cleared.
2025-05-28 18:43:15,452 - INFO - AGENT:agent_airsoft_0faa9616 - status_updater - cleanup_status_updater - 316 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-28 18:43:15,453 - INFO - AGENT:agent_airsoft_0faa9616 - status_updater - delete_status_key_from_redis - 196 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-28 18:43:15,453 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:43:15,454 - INFO - AGENT:agent_airsoft_0faa9616 - status_updater - cleanup_status_updater - 320 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-28 18:43:15,454 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - cleanup - 211 - ServiceComponent cleanup completed.
2025-05-28 18:43:15,454 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - cleanup - 581 - AgentRunner cleanup finished.
2025-05-28 18:43:15,454 - INFO - AGENT:agent_airsoft_0faa9616 - runnable_component - run - 128 - Component AgentRunner (instance: 4494132912) cleanup complete.
2025-05-28 18:43:15,454 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 51 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-28 18:43:15,454 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 60 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-28 18:43:15,464 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 18:43:15,464 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 63 - Database engine closed.
2025-05-28 18:43:15,464 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 66 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-28 18:43:15,466 - INFO - __main__ - runner_main - <module> - 86 - Agent runner main finished.
2025-05-28 18:43:15,599 - INFO - app.core.lifespan - lifespan - lifespan - 287 - Application shutdown sequence initiated.
2025-05-28 18:43:15,600 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 230 - Stopping 3 background tasks...
2025-05-28 18:43:15,600 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task HistorySaverWorker...
2025-05-28 18:43:15,600 - INFO - HistorySaverWorker - runnable_component - run - 116 - Run_loop for HistorySaverWorker (instance: 4405837168) was cancelled.
2025-05-28 18:43:15,600 - INFO - HistorySaverWorker - runnable_component - run - 123 - Component HistorySaverWorker (instance: 4405837168) stopping. Performing cleanup...
2025-05-28 18:43:15,600 - INFO - HistorySaverWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 18:43:15,605 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for history_saver_worker as part of cleanup.
2025-05-28 18:43:15,606 - INFO - HistorySaverWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-28 18:43:15,606 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:43:15,606 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-28 18:43:15,606 - INFO - HistorySaverWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 18:43:15,606 - INFO - HistorySaverWorker - runnable_component - run - 128 - Component HistorySaverWorker (instance: 4405837168) cleanup complete.
2025-05-28 18:43:15,606 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task HistorySaverWorker finished after cancellation signal.
2025-05-28 18:43:15,606 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task TokenUsageWorker...
2025-05-28 18:43:15,606 - INFO - TokenUsageWorker - runnable_component - run - 116 - Run_loop for TokenUsageWorker (instance: 4405836688) was cancelled.
2025-05-28 18:43:15,606 - INFO - TokenUsageWorker - runnable_component - run - 123 - Component TokenUsageWorker (instance: 4405836688) stopping. Performing cleanup...
2025-05-28 18:43:15,606 - INFO - TokenUsageWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 18:43:15,609 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for token_usage_worker as part of cleanup.
2025-05-28 18:43:15,610 - INFO - TokenUsageWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-28 18:43:15,610 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:43:15,610 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-28 18:43:15,610 - INFO - TokenUsageWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 18:43:15,610 - INFO - TokenUsageWorker - runnable_component - run - 128 - Component TokenUsageWorker (instance: 4405836688) cleanup complete.
2025-05-28 18:43:15,610 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task TokenUsageWorker finished after cancellation signal.
2025-05-28 18:43:15,610 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task InactivityMonitorWorker...
2025-05-28 18:43:15,610 - INFO - InactivityMonitorWorker - runnable_component - run - 116 - Run_loop for InactivityMonitorWorker (instance: 4405826848) was cancelled.
2025-05-28 18:43:15,610 - INFO - InactivityMonitorWorker - runnable_component - run - 123 - Component InactivityMonitorWorker (instance: 4405826848) stopping. Performing cleanup...
2025-05-28 18:43:15,610 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 437 - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-28 18:43:15,611 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:43:15,611 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 18:43:15,611 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 441 - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-28 18:43:15,611 - INFO - InactivityMonitorWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 18:43:15,612 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-28 18:43:15,613 - INFO - InactivityMonitorWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-28 18:43:15,613 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:43:15,613 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-28 18:43:15,613 - INFO - InactivityMonitorWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 18:43:15,613 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 445 - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-28 18:43:15,613 - INFO - InactivityMonitorWorker - runnable_component - run - 128 - Component InactivityMonitorWorker (instance: 4405826848) cleanup complete.
2025-05-28 18:43:15,613 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-28 18:43:15,613 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 249 - All background tasks signaled to stop.
2025-05-28 18:43:15,613 - INFO - app.services.redis_service - redis_service - close_redis_pool - 43 - Redis connection pool closed successfully.
2025-05-28 18:43:15,616 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 18:43:15,616 - INFO - app.core.lifespan - lifespan - lifespan - 293 - Application shutdown sequence completed.
2025-05-28 18:43:15,696 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - polling_wrapper - 482 - Aiogram polling has stopped.
2025-05-28 18:43:15,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - run_loop - 137 - Main task 'AiogramPolling' completed. Result: None
2025-05-28 18:43:15,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - run_loop - 156 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-28 18:43:15,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - runnable_component - initiate_shutdown - 74 - Component TelegramIntegrationBot (instance: 4723776912) received shutdown request. Initiating graceful shutdown...
2025-05-28 18:43:15,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - runnable_component - initiate_shutdown - 79 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4723776912)...
2025-05-28 18:43:15,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - run_loop - 172 - ServiceComponentBase run_loop finished.
2025-05-28 18:43:15,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - run_loop - 494 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-28 18:43:15,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - runnable_component - run - 116 - Run_loop for TelegramIntegrationBot (instance: 4723776912) was cancelled.
2025-05-28 18:43:15,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - runnable_component - run - 123 - Component TelegramIntegrationBot (instance: 4723776912) stopping. Performing cleanup...
2025-05-28 18:43:15,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - cleanup - 503 - TelegramIntegrationBot cleanup started.
2025-05-28 18:43:15,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - cleanup - 516 - Closing Aiogram bot session.
2025-05-28 18:43:15,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - cleanup - 518 - Aiogram bot session closed.
2025-05-28 18:43:15,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - cleanup - 181 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-28 18:43:15,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - cleanup - 191 - Waiting for 1 tasks to process cancellation...
2025-05-28 18:43:15,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 270 - Pub/Sub listener task cancelled.
2025-05-28 18:43:15,697 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 294 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-28 18:43:15,698 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 298 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-28 18:43:15,698 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - cleanup - 202 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-28 18:43:15,698 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - cleanup - 207 - All main tasks processed and list cleared.
2025-05-28 18:43:15,702 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - status_updater - cleanup_status_updater - 316 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-28 18:43:15,703 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - status_updater - delete_status_key_from_redis - 196 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-28 18:43:15,703 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:43:15,703 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - status_updater - cleanup_status_updater - 320 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-28 18:43:15,703 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - cleanup - 211 - ServiceComponent cleanup completed.
2025-05-28 18:43:15,703 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - cleanup - 524 - TelegramIntegrationBot cleanup finished.
2025-05-28 18:43:15,703 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - runnable_component - run - 128 - Component TelegramIntegrationBot (instance: 4723776912) cleanup complete.
2025-05-28 18:43:15,703 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot_main - main_async_runner - 86 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-28 18:43:15,703 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot_main - main_async_runner - 95 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-28 18:43:15,708 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 18:43:15,708 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot_main - main_async_runner - 98 - Database engine closed.
2025-05-28 18:43:15,708 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot_main - main_async_runner - 101 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-28 18:43:15,710 - INFO - __main__ - telegram_bot_main - <module> - 124 - Telegram bot runner main finished.
2025-05-28 18:43:21,778 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 18:43:21,778 - INFO - app.core.lifespan - lifespan - lifespan - 277 - Application startup sequence initiated.
2025-05-28 18:43:21,783 - INFO - app.services.redis_service - redis_service - init_redis_pool - 24 - Redis connection pool initialized successfully.
2025-05-28 18:43:21,783 - INFO - app.core.lifespan - lifespan - start_background_tasks - 172 - Starting background tasks...
2025-05-28 18:43:21,783 - INFO - app.core.lifespan - lifespan - start_background_tasks - 182 - History saver worker started, listening to queue: chat_history_queue
2025-05-28 18:43:21,783 - INFO - TokenUsageWorker - token_usage_worker - __init__ - 45 - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-28 18:43:21,783 - INFO - app.core.lifespan - lifespan - start_background_tasks - 194 - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-28 18:43:21,783 - INFO - app.core.lifespan - lifespan - start_background_tasks - 206 - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-28 18:43:21,783 - INFO - app.core.lifespan - lifespan - start_background_tasks - 210 - 3 background tasks initiated.
2025-05-28 18:43:21,783 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 51 - Attempting to start existing agents and their integrations...
2025-05-28 18:43:21,783 - INFO - HistorySaverWorker - base_worker - setup - 48 - [history_saver_worker] Worker setup started.
2025-05-28 18:43:21,783 - INFO - TokenUsageWorker - base_worker - setup - 48 - [token_usage_worker] Worker setup started.
2025-05-28 18:43:21,783 - INFO - InactivityMonitorWorker - base_worker - setup - 48 - [inactivity_monitor_worker] Worker setup started.
2025-05-28 18:43:21,785 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 61 - ProcessManager setup complete for startup.
2025-05-28 18:43:21,787 - INFO - HistorySaverWorker - base_worker - setup - 52 - [history_saver_worker] Worker setup completed.
2025-05-28 18:43:21,787 - INFO - HistorySaverWorker - base_worker - setup - 114 - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-28 18:43:21,787 - INFO - TokenUsageWorker - base_worker - setup - 52 - [token_usage_worker] Worker setup completed.
2025-05-28 18:43:21,787 - INFO - TokenUsageWorker - base_worker - setup - 114 - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-28 18:43:21,787 - INFO - InactivityMonitorWorker - base_worker - setup - 52 - [inactivity_monitor_worker] Worker setup completed.
2025-05-28 18:43:21,787 - INFO - InactivityMonitorWorker - base_worker - setup - 243 - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-28 18:43:21,788 - INFO - TokenUsageWorker - token_usage_worker - setup - 57 - [token_usage_worker] Database session factory initialized.
2025-05-28 18:43:21,788 - INFO - HistorySaverWorker - history_saver_worker - setup - 49 - [history_saver_worker] Database session factory initialized.
2025-05-28 18:43:21,788 - INFO - HistorySaverWorker - runnable_component - run - 111 - Component HistorySaverWorker (instance: 4852513584) setup complete. Starting run loop.
2025-05-28 18:43:21,788 - INFO - HistorySaverWorker - base_worker - run_loop - 131 - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-28 18:43:21,789 - INFO - TokenUsageWorker - token_usage_worker - setup - 64 - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-28 18:43:21,789 - INFO - TokenUsageWorker - runnable_component - run - 111 - Component TokenUsageWorker (instance: 4852513200) setup complete. Starting run loop.
2025-05-28 18:43:21,789 - INFO - TokenUsageWorker - base_worker - run_loop - 131 - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-28 18:43:21,791 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 86 - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-28 18:43:21,791 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 94 - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-28 18:43:21,835 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 66 - Found 1 agents to potentially start.
2025-05-28 18:43:21,835 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 69 - Attempting to start agent: agent_airsoft_0faa9616
2025-05-28 18:43:21,836 - INFO - app.services.process_manager - process_manager - start_agent_process - 880 - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-28 18:43:21,838 - INFO - app.core.base.process_launcher - process_launcher - launch_process - 160 - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 2336
2025-05-28 18:43:21,838 - INFO - app.services.process_manager - process_manager - start_agent_process - 913 - Agent process agent_airsoft_0faa9616 initiated start with PID 2336
2025-05-28 18:43:21,838 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 79 - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-28 18:43:21,838 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 93 - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-28 18:43:21,838 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 109 - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-28 18:43:21,840 - INFO - app.services.process_manager - process_manager - start_integration_process - 554 - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-28 18:43:21,841 - INFO - app.core.base.process_launcher - process_launcher - launch_process - 160 - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 2337
2025-05-28 18:43:21,841 - INFO - app.services.process_manager - process_manager - start_integration_process - 600 - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 2337
2025-05-28 18:43:21,841 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 123 - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-28 18:43:21,842 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:43:21,842 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 18:43:21,842 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 153 - ProcessManager cleanup complete for startup function.
2025-05-28 18:43:21,842 - INFO - app.core.lifespan - lifespan - lifespan - 284 - Application startup sequence completed.
2025-05-28 18:43:22,758 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 18:43:22,759 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot_main - main_async_runner - 50 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-28 18:43:22,759 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot_main - main_async_runner - 57 - Database session factory configured for Telegram bot.
2025-05-28 18:43:22,759 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - __init__ - 44 - ServiceComponentBase initialized.
2025-05-28 18:43:22,759 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - __init__ - 56 - TelegramIntegrationBot initialized. PID: 2337
2025-05-28 18:43:22,759 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot_main - main_async_runner - 74 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-28 18:43:22,759 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - setup - 441 - TelegramIntegrationBot setup started.
2025-05-28 18:43:22,759 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - setup - 84 - ServiceComponent setup started.
2025-05-28 18:43:22,767 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - setup - 95 - ServiceComponent setup completed.
2025-05-28 18:43:22,780 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - setup - 452 - Aiogram Bot and Dispatcher initialized.
2025-05-28 18:43:22,780 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _register_handlers - 341 - Aiogram handlers registered.
2025-05-28 18:43:22,780 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - setup - 456 - TelegramIntegrationBot setup complete.
2025-05-28 18:43:22,780 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - runnable_component - run - 111 - Component TelegramIntegrationBot (instance: 4456881696) setup complete. Starting run loop.
2025-05-28 18:43:22,780 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - run_loop - 464 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-28 18:43:22,780 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - _register_main_task - 62 - Registered main task: RedisOutputListener
2025-05-28 18:43:22,780 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - _register_main_task - 62 - Registered main task: AiogramPolling
2025-05-28 18:43:22,780 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - run_loop - 122 - Starting run_loop with 2 registered main tasks.
2025-05-28 18:43:22,780 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 236 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-28 18:43:22,780 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - polling_wrapper - 473 - Starting aiogram polling...
2025-05-28 18:43:22,780 - INFO - aiogram.dispatcher - dispatcher - start_polling - 527 - Start polling
2025-05-28 18:43:22,783 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 254 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-28 18:43:23,035 - INFO - aiogram.dispatcher - dispatcher - _polling - 341 - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-28 18:43:23,111 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 18:43:23,112 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 21 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-28 18:43:23,112 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 28 - Database session factory configured for Agent.
2025-05-28 18:43:23,112 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - __init__ - 44 - ServiceComponentBase initialized.
2025-05-28 18:43:23,112 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - __init__ - 120 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 2336
2025-05-28 18:43:23,112 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 42 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-28 18:43:23,112 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - setup - 494 - AgentRunner setup started.
2025-05-28 18:43:23,112 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - setup - 84 - ServiceComponent setup started.
2025-05-28 18:43:23,118 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - setup - 95 - ServiceComponent setup completed.
2025-05-28 18:43:23,118 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - fetch_config - 27 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-28 18:43:23,200 - INFO - httpx - _client - _send_single_request - 1740 - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-28 18:43:23,200 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - fetch_config - 33 - Configuration fetched successfully.
2025-05-28 18:43:23,200 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _load_config - 138 - Agent configuration loaded and prepared successfully.
2025-05-28 18:43:23,200 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _setup_app - 149 - Creating LangGraph application...
2025-05-28 18:43:23,200 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_agent_app - 913 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-28 18:43:23,200 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_llm_instance - 80 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-28 18:43:23,226 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _configure_main_llm - 63 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-28 18:43:23,226 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 818 - Creating agent graph in GraphFactory...
2025-05-28 18:43:23,226 - INFO - app.agent_runner.common.tools_registry - tools_registry - configure_tools_centralized - 364 - Configured 3 predefined tools from centralized registry
2025-05-28 18:43:23,226 - INFO - AGENT:agent_airsoft_0faa9616 - tools - configure_tools - 94 - Added 3 tools from centralized registry
2025-05-28 18:43:23,226 - INFO - AGENT:agent_airsoft_0faa9616 - tools - configure_tools - 114 - Configuring 1 Knowledge Base tool(s)...
2025-05-28 18:43:23,282 - INFO - httpx - _client - _send_single_request - 1025 - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-28 18:43:23,288 - INFO - httpx - _client - _send_single_request - 1025 - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-28 18:43:24,157 - INFO - httpx - _client - _send_single_request - 1025 - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-28 18:43:24,161 - INFO - AGENT:agent_airsoft_0faa9616 - tools - configure_tools - 132 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-28 18:43:24,161 - INFO - AGENT:agent_airsoft_0faa9616 - tools - configure_tools - 166 - Must conditions for KB tool 'knowledgeBase-1745316404538': [FieldCondition(key='metadata.client_id', match=MatchValue(value='2'), range=None, geo_bounding_box=None, geo_radius=None, geo_polygon=None, values_count=None), FieldCondition(key='metadata.datasource_id', match=MatchAny(any=['5', '6', '7']), range=None, geo_bounding_box=None, geo_radius=None, geo_polygon=None, values_count=None)]
2025-05-28 18:43:24,161 - INFO - AGENT:agent_airsoft_0faa9616 - tools - configure_tools - 182 - Configured Knowledge Base tool 'База знаний' (ID: knowledgeBase-1745316404538) for datasources: ['5', '6', '7']
2025-05-28 18:43:24,161 - INFO - AGENT:agent_airsoft_0faa9616 - tools - configure_tools - 190 - Using max_rewrites: 4
2025-05-28 18:43:24,161 - INFO - AGENT:agent_airsoft_0faa9616 - tools - configure_tools - 217 - Configured Web Search tool 'Поиск в Интернете' (ID: webSearch-1746879979658)
2025-05-28 18:43:24,161 - INFO - AGENT:agent_airsoft_0faa9616 - tools - configure_tools - 244 - Total tools configured: 5 (4 safe, 1 datastore).
2025-05-28 18:43:24,161 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _configure_tools - 153 - Tools configured: 5 total, 4 safe, 1 datastore tools. Max rewrites: 4.
2025-05-28 18:43:24,161 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 826 - Context memory enabled: True
2025-05-28 18:43:24,162 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 834 - Added node: agent
2025-05-28 18:43:24,162 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 843 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-28 18:43:24,162 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 853 - Added node: safe_tools
2025-05-28 18:43:24,162 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 864 - Added edge: safe_tools -> agent
2025-05-28 18:43:24,162 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 870 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-28 18:43:24,162 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 877 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-28 18:43:24,162 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 893 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-28 18:43:24,172 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_graph - 905 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-28 18:43:24,172 - INFO - AGENT:agent_airsoft_0faa9616 - factory - create_agent_app - 922 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-28 18:43:24,172 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _setup_app - 157 - LangGraph application created successfully.
2025-05-28 18:43:24,172 - INFO - AGENT:agent_airsoft_0faa9616 - runnable_component - run - 111 - Component AgentRunner (instance: 4858692912) setup complete. Starting run loop.
2025-05-28 18:43:24,172 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - run_loop - 522 - AgentRunner run_loop starting...
2025-05-28 18:43:24,172 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - _register_main_task - 62 - Registered main task: AgentPubSubListener
2025-05-28 18:43:24,172 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - run_loop - 122 - Starting run_loop with 1 registered main tasks.
2025-05-28 18:43:24,172 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 236 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-28 18:43:24,176 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 254 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-28 18:43:31,791 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 96 - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-28 18:43:31,797 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 98 - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-28 18:43:31,798 - INFO - InactivityMonitorWorker - runnable_component - run - 111 - Component InactivityMonitorWorker (instance: 4852513344) setup complete. Starting run loop.
2025-05-28 18:43:31,798 - INFO - InactivityMonitorWorker - base_worker - run_loop - 258 - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-28 18:44:01,208 - INFO - app.core.lifespan - lifespan - lifespan - 287 - Application shutdown sequence initiated.
2025-05-28 18:44:01,208 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 230 - Stopping 3 background tasks...
2025-05-28 18:44:01,208 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task HistorySaverWorker...
2025-05-28 18:44:01,208 - INFO - HistorySaverWorker - runnable_component - run - 116 - Run_loop for HistorySaverWorker (instance: 4852513584) was cancelled.
2025-05-28 18:44:01,208 - INFO - HistorySaverWorker - runnable_component - run - 123 - Component HistorySaverWorker (instance: 4852513584) stopping. Performing cleanup...
2025-05-28 18:44:01,208 - INFO - HistorySaverWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 18:44:01,216 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for history_saver_worker as part of cleanup.
2025-05-28 18:44:01,218 - INFO - HistorySaverWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-28 18:44:01,218 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:44:01,218 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-28 18:44:01,218 - INFO - HistorySaverWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 18:44:01,218 - INFO - HistorySaverWorker - runnable_component - run - 128 - Component HistorySaverWorker (instance: 4852513584) cleanup complete.
2025-05-28 18:44:01,218 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task HistorySaverWorker finished after cancellation signal.
2025-05-28 18:44:01,218 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task TokenUsageWorker...
2025-05-28 18:44:01,218 - INFO - TokenUsageWorker - runnable_component - run - 116 - Run_loop for TokenUsageWorker (instance: 4852513200) was cancelled.
2025-05-28 18:44:01,218 - INFO - TokenUsageWorker - runnable_component - run - 123 - Component TokenUsageWorker (instance: 4852513200) stopping. Performing cleanup...
2025-05-28 18:44:01,218 - INFO - TokenUsageWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 18:44:01,222 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for token_usage_worker as part of cleanup.
2025-05-28 18:44:01,223 - INFO - TokenUsageWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-28 18:44:01,223 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:44:01,223 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-28 18:44:01,223 - INFO - TokenUsageWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 18:44:01,223 - INFO - TokenUsageWorker - runnable_component - run - 128 - Component TokenUsageWorker (instance: 4852513200) cleanup complete.
2025-05-28 18:44:01,223 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task TokenUsageWorker finished after cancellation signal.
2025-05-28 18:44:01,223 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task InactivityMonitorWorker...
2025-05-28 18:44:01,223 - INFO - InactivityMonitorWorker - runnable_component - run - 116 - Run_loop for InactivityMonitorWorker (instance: 4852513344) was cancelled.
2025-05-28 18:44:01,223 - INFO - InactivityMonitorWorker - runnable_component - run - 123 - Component InactivityMonitorWorker (instance: 4852513344) stopping. Performing cleanup...
2025-05-28 18:44:01,223 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 437 - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-28 18:44:01,223 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:44:01,223 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 18:44:01,223 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 441 - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-28 18:44:01,223 - INFO - InactivityMonitorWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 18:44:01,226 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-28 18:44:01,227 - INFO - InactivityMonitorWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-28 18:44:01,227 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:44:01,227 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-28 18:44:01,227 - INFO - InactivityMonitorWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 18:44:01,227 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 445 - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-28 18:44:01,227 - INFO - InactivityMonitorWorker - runnable_component - run - 128 - Component InactivityMonitorWorker (instance: 4852513344) cleanup complete.
2025-05-28 18:44:01,227 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-28 18:44:01,227 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 249 - All background tasks signaled to stop.
2025-05-28 18:44:01,227 - INFO - app.services.redis_service - redis_service - close_redis_pool - 43 - Redis connection pool closed successfully.
2025-05-28 18:44:01,239 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 18:44:01,239 - INFO - app.core.lifespan - lifespan - lifespan - 293 - Application shutdown sequence completed.
2025-05-28 18:44:01,718 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 18:44:01,718 - INFO - app.core.lifespan - lifespan - lifespan - 277 - Application startup sequence initiated.
2025-05-28 18:44:01,723 - INFO - app.services.redis_service - redis_service - init_redis_pool - 24 - Redis connection pool initialized successfully.
2025-05-28 18:44:01,723 - INFO - app.core.lifespan - lifespan - start_background_tasks - 172 - Starting background tasks...
2025-05-28 18:44:01,723 - INFO - app.core.lifespan - lifespan - start_background_tasks - 182 - History saver worker started, listening to queue: chat_history_queue
2025-05-28 18:44:01,723 - INFO - TokenUsageWorker - token_usage_worker - __init__ - 45 - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-28 18:44:01,723 - INFO - app.core.lifespan - lifespan - start_background_tasks - 194 - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-28 18:44:01,724 - INFO - app.core.lifespan - lifespan - start_background_tasks - 206 - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-28 18:44:01,724 - INFO - app.core.lifespan - lifespan - start_background_tasks - 210 - 3 background tasks initiated.
2025-05-28 18:44:01,724 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 51 - Attempting to start existing agents and their integrations...
2025-05-28 18:44:01,724 - INFO - HistorySaverWorker - base_worker - setup - 48 - [history_saver_worker] Worker setup started.
2025-05-28 18:44:01,724 - INFO - TokenUsageWorker - base_worker - setup - 48 - [token_usage_worker] Worker setup started.
2025-05-28 18:44:01,724 - INFO - InactivityMonitorWorker - base_worker - setup - 48 - [inactivity_monitor_worker] Worker setup started.
2025-05-28 18:44:01,727 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 61 - ProcessManager setup complete for startup.
2025-05-28 18:44:01,729 - INFO - InactivityMonitorWorker - base_worker - setup - 52 - [inactivity_monitor_worker] Worker setup completed.
2025-05-28 18:44:01,729 - INFO - InactivityMonitorWorker - base_worker - setup - 243 - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-28 18:44:01,731 - INFO - TokenUsageWorker - base_worker - setup - 52 - [token_usage_worker] Worker setup completed.
2025-05-28 18:44:01,731 - INFO - TokenUsageWorker - base_worker - setup - 114 - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-28 18:44:01,731 - INFO - HistorySaverWorker - base_worker - setup - 52 - [history_saver_worker] Worker setup completed.
2025-05-28 18:44:01,731 - INFO - HistorySaverWorker - base_worker - setup - 114 - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-28 18:44:01,733 - INFO - TokenUsageWorker - token_usage_worker - setup - 57 - [token_usage_worker] Database session factory initialized.
2025-05-28 18:44:01,733 - INFO - HistorySaverWorker - history_saver_worker - setup - 49 - [history_saver_worker] Database session factory initialized.
2025-05-28 18:44:01,733 - INFO - HistorySaverWorker - runnable_component - run - 111 - Component HistorySaverWorker (instance: 4438901056) setup complete. Starting run loop.
2025-05-28 18:44:01,733 - INFO - HistorySaverWorker - base_worker - run_loop - 131 - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-28 18:44:01,735 - INFO - TokenUsageWorker - token_usage_worker - setup - 64 - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-28 18:44:01,735 - INFO - TokenUsageWorker - runnable_component - run - 111 - Component TokenUsageWorker (instance: 4442651680) setup complete. Starting run loop.
2025-05-28 18:44:01,735 - INFO - TokenUsageWorker - base_worker - run_loop - 131 - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-28 18:44:01,736 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 86 - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-28 18:44:01,736 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 94 - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-28 18:44:01,799 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 66 - Found 1 agents to potentially start.
2025-05-28 18:44:01,800 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 69 - Attempting to start agent: agent_airsoft_0faa9616
2025-05-28 18:44:01,801 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 73 - Agent agent_airsoft_0faa9616 is already running.
2025-05-28 18:44:01,801 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 93 - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-28 18:44:01,801 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 109 - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-28 18:44:01,803 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 115 - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-28 18:44:01,803 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:44:01,804 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 18:44:01,804 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 153 - ProcessManager cleanup complete for startup function.
2025-05-28 18:44:01,804 - INFO - app.core.lifespan - lifespan - lifespan - 284 - Application startup sequence completed.
2025-05-28 18:44:11,737 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 96 - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-28 18:44:11,742 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 98 - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-28 18:44:11,742 - INFO - InactivityMonitorWorker - runnable_component - run - 111 - Component InactivityMonitorWorker (instance: 4442651584) setup complete. Starting run loop.
2025-05-28 18:44:11,742 - INFO - InactivityMonitorWorker - base_worker - run_loop - 258 - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-28 18:45:07,532 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _handle_text_message - 287 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Сколько программистов необходимо для перехода?...'
2025-05-28 18:45:07,535 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _check_user_authorization - 124 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-28 18:45:07,641 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _publish_to_agent - 101 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-28 18:45:07,641 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _handle_text_message - 313 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-28 18:45:07,641 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _handle_pubsub_message - 202 - Processing message for chat_id: 144641834
2025-05-28 18:45:07,644 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _save_history - 481 - Queued user message for history (Thread: 144641834, InteractionID: 6c719543-e400-459f-979c-360a0576c1bf)
2025-05-28 18:45:07,644 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _get_history - 417 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-28 18:45:07,644 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _get_history - 423 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-28 18:45:07,683 - INFO - HistorySaverWorker - history_saver_worker - process_message - 123 - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 6c719543-e400-459f-979c-360a0576c1bf, db_id: 902
2025-05-28 18:45:07,704 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _get_history - 433 - Loaded 20 messages from DB for thread '144641834'.
2025-05-28 18:45:07,705 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _get_history - 436 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-28 18:45:07,705 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _invoke_agent - 366 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-28 18:45:07,784 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 255 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-28 18:45:07,785 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_llm_instance - 80 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-28 18:45:07,811 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_node_llm - 713 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-28 18:45:07,817 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _bind_tools_to_model - 804 - Model bound to 5 tools.
2025-05-28 18:45:08,641 - INFO - aiogram.event - dispatcher - feed_update - 172 - Update id=804756297 is handled. Duration 1110 ms by bot id=1750613938
2025-05-28 18:45:08,739 - INFO - httpx - _client - _send_single_request - 1740 - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-28 18:45:11,981 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 285 - Agent node response content preview: Для перехода на 1С:Управление торговлей 11 обычно требуется от 1 до 3 программистов, в зависимости о
2025-05-28 18:45:11,981 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 287 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_38647f5e19'}
2025-05-28 18:45:11,981 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 289 - Agent node usage_metadata: {'input_tokens': 1684, 'output_tokens': 159, 'total_tokens': 1843, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-28 18:45:11,981 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _extract_token_data - 218 - Token usage from usage_metadata: P:1684 C:159 T:1843
2025-05-28 18:45:11,981 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _get_tokens - 250 - Token usage for agent_llm: 1843 tokens recorded.
2025-05-28 18:45:11,982 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _route_tools_edge - 605 - ---ROUTE TOOLS---
2025-05-28 18:45:11,982 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _route_tools_edge - 613 - ---DECISION: NO TOOLS CALLED, END---
2025-05-28 18:45:11,983 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _invoke_agent - 384 - Graph execution finished. Final response: Для перехода на 1С:Управление торговлей 11 обычно требуется от 1 до 3 программистов, в зависимости о...
2025-05-28 18:45:11,985 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _save_history - 481 - Queued agent message for history (Thread: 144641834, InteractionID: 6c719543-e400-459f-979c-360a0576c1bf)
2025-05-28 18:45:11,985 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _save_tokens - 315 - Found 1 token usage events for InteractionID: 6c719543-e400-459f-979c-360a0576c1bf.
2025-05-28 18:45:11,987 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _handle_pubsub_message - 385 - Received response from agent for chat 144641834: Для перехода на 1С:Управление торговлей 11 обычно требуется от 1 до 3 программистов, в зависимости о...
2025-05-28 18:45:11,988 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _handle_pubsub_message - 414 - Sending message from agent to chat 144641834: 'Для перехода на 1С:Управление торговлей 11 обычно ...'
2025-05-28 18:45:11,989 - INFO - TokenUsageWorker - token_usage_worker - process_message - 117 - [token_usage_worker] RAW token usage data: {'interaction_id': '6c719543-e400-459f-979c-360a0576c1bf', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1684, 'completion_tokens': 159, 'total_tokens': 1843, 'timestamp': '2025-05-28T13:45:11.981413+00:00'}
2025-05-28 18:45:11,989 - INFO - TokenUsageWorker - token_usage_worker - process_message - 129 - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 6c719543-e400-459f-979c-360a0576c1bf
2025-05-28 18:45:11,994 - INFO - HistorySaverWorker - history_saver_worker - process_message - 123 - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 6c719543-e400-459f-979c-360a0576c1bf, db_id: 903
2025-05-28 18:45:12,024 - INFO - TokenUsageWorker - token_usage_worker - process_message - 148 - [token_usage_worker] Found message_id: 903 for interaction_id: 6c719543-e400-459f-979c-360a0576c1bf on attempt 1
2025-05-28 18:45:12,029 - INFO - TokenUsageWorker - token_usage_worker - _save_token_usage_to_db - 92 - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 6c719543-e400-459f-979c-360a0576c1bf, db_id: 365
2025-05-28 18:46:16,395 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _handle_text_message - 287 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Что у тебя есть про налоговую?...'
2025-05-28 18:46:16,396 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _check_user_authorization - 124 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-28 18:46:16,407 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _publish_to_agent - 101 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-28 18:46:16,407 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _handle_text_message - 313 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-28 18:46:16,407 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _handle_pubsub_message - 202 - Processing message for chat_id: 144641834
2025-05-28 18:46:16,409 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _save_history - 481 - Queued user message for history (Thread: 144641834, InteractionID: 98faba0f-2c0c-4493-b32c-7a7a7ee4bc0d)
2025-05-28 18:46:16,409 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _get_history - 417 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-28 18:46:16,410 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _get_history - 439 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-28 18:46:16,411 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _invoke_agent - 366 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-28 18:46:16,416 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 255 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-28 18:46:16,417 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_llm_instance - 80 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-28 18:46:16,425 - INFO - HistorySaverWorker - history_saver_worker - process_message - 123 - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 98faba0f-2c0c-4493-b32c-7a7a7ee4bc0d, db_id: 904
2025-05-28 18:46:16,448 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_node_llm - 713 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-28 18:46:16,452 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _bind_tools_to_model - 804 - Model bound to 5 tools.
2025-05-28 18:46:17,408 - INFO - aiogram.event - dispatcher - feed_update - 172 - Update id=804756298 is handled. Duration 1013 ms by bot id=1750613938
2025-05-28 18:46:21,472 - INFO - httpx - _client - _send_single_request - 1740 - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-28 18:46:21,569 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 285 - Agent node response content preview: N/A
2025-05-28 18:46:21,569 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 287 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_658b958c37'}
2025-05-28 18:46:21,569 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 289 - Agent node usage_metadata: {'input_tokens': 1858, 'output_tokens': 23, 'total_tokens': 1881, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-28 18:46:21,569 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _extract_token_data - 218 - Token usage from usage_metadata: P:1858 C:23 T:1881
2025-05-28 18:46:21,569 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _get_tokens - 250 - Token usage for agent_llm: 1881 tokens recorded.
2025-05-28 18:46:21,570 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _route_tools_edge - 605 - ---ROUTE TOOLS---
2025-05-28 18:46:21,570 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _route_tools_edge - 635 - Tool call detected: knowledgeBase-1745316404538
2025-05-28 18:46:21,570 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _route_tools_edge - 638 - ---DECISION: ROUTE TO RETRIEVE (knowledgeBase-1745316404538)---
2025-05-28 18:46:22,170 - INFO - httpx - _client - _send_single_request - 1025 - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-28 18:46:22,200 - INFO - httpx - _client - _send_single_request - 1025 - HTTP Request: POST http://127.0.0.1:6333/collections/platformai/points/query "HTTP/1.1 200 OK"
2025-05-28 18:46:22,204 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _grade_docs_node - 360 - ---CHECK RELEVANCE (Agent ID: agent_airsoft_0faa9616)---
2025-05-28 18:46:22,204 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _grade_docs_node - 371 - Grading documents for question: 'Что у тебя есть про налоговую?'
2025-05-28 18:46:22,204 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_llm_instance - 80 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.0, streaming: False
2025-05-28 18:46:22,230 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_node_llm - 713 - Created grading LLM: gpt-4.1-mini via OpenAI
2025-05-28 18:46:22,238 - INFO - AGENT:agent_airsoft_0faa9616 - factory - process_doc - 413 - Grading document content (first 300 chars): ## МИНФИН РОССИИ ФЕДЕРАЛЬНАЯ НАЛОГОВАЯ СЛУЖБА УФНС РОССИИ ПО СВЕРДЛОВСКОЙ ОБЛАСТИ

**МЕЖРАЙОННАЯ ИНСПЕКЦИЯ ФЕДЕРАЛЬНОЙ НАЛОГОВОЙ СЛУЖБЫ №32 ПО СВЕРДЛОВСКОЙ ОБЛАСТИ**

> (Межрайонная ИФНС России № 32 по Свердловской области)

Стачек ул., 17-Б, Екатеринбург, 620091 Телефон:(343) 288-2648; Телефакс:(34
2025-05-28 18:46:22,238 - INFO - AGENT:agent_airsoft_0faa9616 - factory - process_doc - 414 - Question for grading: Что у тебя есть про налоговую?
2025-05-28 18:46:22,914 - INFO - httpx - _client - _send_single_request - 1740 - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-28 18:46:22,928 - INFO - AGENT:agent_airsoft_0faa9616 - factory - process_doc - 424 - Grading result: yes for document starting with: ## МИНФИН РОССИИ ФЕДЕРАЛЬНАЯ НАЛОГОВАЯ СЛУЖБА УФНС РОССИИ ПО СВЕРДЛОВСКОЙ ОБЛАСТИ

**МЕЖРАЙОННАЯ ИНС...
2025-05-28 18:46:22,928 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _extract_token_data - 218 - Token usage from usage_metadata: P:898 C:6 T:904
2025-05-28 18:46:22,928 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _get_tokens - 250 - Token usage for grading_llm: 904 tokens recorded.
2025-05-28 18:46:22,928 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _grade_docs_node - 461 - Total token usage for grading_llm batch: 904 tokens.
2025-05-28 18:46:22,928 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _grade_docs_node - 466 - Found 1 relevant documents out of 1 initial (after split).
2025-05-28 18:46:22,929 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _decide_to_generate_edge - 585 - ---ASSESS GRADED DOCUMENTS---
2025-05-28 18:46:22,929 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _decide_to_generate_edge - 600 - ---DECISION: RELEVANT DOCUMENTS FOUND, GENERATE---
2025-05-28 18:46:22,929 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _generate_node - 532 - ---GENERATE (Agent ID: agent_airsoft_0faa9616)---
2025-05-28 18:46:22,929 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _generate_node - 553 - Generating answer for question: 'Что у тебя есть про налоговую?' using 1 documents.
2025-05-28 18:46:22,934 - ERROR - AGENT:agent_airsoft_0faa9616 - agent_runner - _handle_pubsub_message - 264 - Error processing PubSub message: 'GraphFactory' object has no attribute '_create_rag_prompt_template'
Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/agent_runner/agent_runner.py", line 228, in _handle_pubsub_message
    response_content, final_message = await self._invoke_agent(
                                      ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/agent_runner/agent_runner.py", line 370, in _invoke_agent
    async for output in self.agent_app.astream(graph_input, self.config, stream_mode="updates"):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langgraph/pregel/__init__.py", line 2313, in astream
    async for _ in runner.atick(
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langgraph/pregel/runner.py", line 444, in atick
    await arun_with_retry(
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langgraph/pregel/retry.py", line 128, in arun_with_retry
    return await task.proc.ainvoke(task.input, config)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langgraph/utils/runnable.py", line 583, in ainvoke
    input = await step.ainvoke(input, config, **kwargs)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/langgraph/utils/runnable.py", line 371, in ainvoke
    ret = await asyncio.create_task(coro, context=context)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/agent_runner/langgraph/factory.py", line 557, in _generate_node
    prompt = self._create_rag_prompt_template()
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'GraphFactory' object has no attribute '_create_rag_prompt_template'. Did you mean: '_create_rag_template'?
During task with name 'generate' and id '495ffb5e-b5e7-7473-cbbb-3820295eff68'
2025-05-28 18:47:51,596 - INFO - app.core.lifespan - lifespan - lifespan - 287 - Application shutdown sequence initiated.
2025-05-28 18:47:51,598 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 230 - Stopping 3 background tasks...
2025-05-28 18:47:51,598 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task HistorySaverWorker...
2025-05-28 18:47:51,601 - INFO - HistorySaverWorker - runnable_component - run - 116 - Run_loop for HistorySaverWorker (instance: 4438901056) was cancelled.
2025-05-28 18:47:51,601 - INFO - HistorySaverWorker - runnable_component - run - 123 - Component HistorySaverWorker (instance: 4438901056) stopping. Performing cleanup...
2025-05-28 18:47:51,602 - INFO - HistorySaverWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 18:47:51,611 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for history_saver_worker as part of cleanup.
2025-05-28 18:47:51,612 - INFO - HistorySaverWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-28 18:47:51,612 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:47:51,612 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-28 18:47:51,612 - INFO - HistorySaverWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 18:47:51,612 - INFO - HistorySaverWorker - runnable_component - run - 128 - Component HistorySaverWorker (instance: 4438901056) cleanup complete.
2025-05-28 18:47:51,612 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task HistorySaverWorker finished after cancellation signal.
2025-05-28 18:47:51,612 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task TokenUsageWorker...
2025-05-28 18:47:51,612 - INFO - TokenUsageWorker - runnable_component - run - 116 - Run_loop for TokenUsageWorker (instance: 4442651680) was cancelled.
2025-05-28 18:47:51,612 - INFO - TokenUsageWorker - runnable_component - run - 123 - Component TokenUsageWorker (instance: 4442651680) stopping. Performing cleanup...
2025-05-28 18:47:51,612 - INFO - TokenUsageWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 18:47:51,616 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for token_usage_worker as part of cleanup.
2025-05-28 18:47:51,617 - INFO - TokenUsageWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-28 18:47:51,617 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:47:51,617 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-28 18:47:51,617 - INFO - TokenUsageWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 18:47:51,617 - INFO - TokenUsageWorker - runnable_component - run - 128 - Component TokenUsageWorker (instance: 4442651680) cleanup complete.
2025-05-28 18:47:51,617 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task TokenUsageWorker finished after cancellation signal.
2025-05-28 18:47:51,617 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task InactivityMonitorWorker...
2025-05-28 18:47:51,617 - INFO - InactivityMonitorWorker - runnable_component - run - 116 - Run_loop for InactivityMonitorWorker (instance: 4442651584) was cancelled.
2025-05-28 18:47:51,617 - INFO - InactivityMonitorWorker - runnable_component - run - 123 - Component InactivityMonitorWorker (instance: 4442651584) stopping. Performing cleanup...
2025-05-28 18:47:51,617 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 437 - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-28 18:47:51,617 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:47:51,617 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 18:47:51,617 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 441 - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-28 18:47:51,617 - INFO - InactivityMonitorWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 18:47:51,620 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-28 18:47:51,621 - INFO - InactivityMonitorWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-28 18:47:51,621 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:47:51,621 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-28 18:47:51,621 - INFO - InactivityMonitorWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 18:47:51,621 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 445 - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-28 18:47:51,621 - INFO - InactivityMonitorWorker - runnable_component - run - 128 - Component InactivityMonitorWorker (instance: 4442651584) cleanup complete.
2025-05-28 18:47:51,621 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-28 18:47:51,621 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 249 - All background tasks signaled to stop.
2025-05-28 18:47:51,622 - INFO - app.services.redis_service - redis_service - close_redis_pool - 43 - Redis connection pool closed successfully.
2025-05-28 18:47:51,641 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 18:47:51,641 - INFO - app.core.lifespan - lifespan - lifespan - 293 - Application shutdown sequence completed.
2025-05-28 18:47:52,116 - INFO - app.core.logging_config - logging_config - setup_logging - 32 - Logging configured with level: INFO
2025-05-28 18:47:52,116 - INFO - app.core.lifespan - lifespan - lifespan - 277 - Application startup sequence initiated.
2025-05-28 18:47:52,121 - INFO - app.services.redis_service - redis_service - init_redis_pool - 24 - Redis connection pool initialized successfully.
2025-05-28 18:47:52,121 - INFO - app.core.lifespan - lifespan - start_background_tasks - 172 - Starting background tasks...
2025-05-28 18:47:52,121 - INFO - app.core.lifespan - lifespan - start_background_tasks - 182 - History saver worker started, listening to queue: chat_history_queue
2025-05-28 18:47:52,121 - INFO - TokenUsageWorker - token_usage_worker - __init__ - 45 - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-28 18:47:52,121 - INFO - app.core.lifespan - lifespan - start_background_tasks - 194 - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-28 18:47:52,121 - INFO - app.core.lifespan - lifespan - start_background_tasks - 206 - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-28 18:47:52,121 - INFO - app.core.lifespan - lifespan - start_background_tasks - 210 - 3 background tasks initiated.
2025-05-28 18:47:52,121 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 51 - Attempting to start existing agents and their integrations...
2025-05-28 18:47:52,122 - INFO - HistorySaverWorker - base_worker - setup - 48 - [history_saver_worker] Worker setup started.
2025-05-28 18:47:52,122 - INFO - TokenUsageWorker - base_worker - setup - 48 - [token_usage_worker] Worker setup started.
2025-05-28 18:47:52,122 - INFO - InactivityMonitorWorker - base_worker - setup - 48 - [inactivity_monitor_worker] Worker setup started.
2025-05-28 18:47:52,124 - INFO - HistorySaverWorker - base_worker - setup - 52 - [history_saver_worker] Worker setup completed.
2025-05-28 18:47:52,124 - INFO - HistorySaverWorker - base_worker - setup - 114 - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-28 18:47:52,124 - INFO - InactivityMonitorWorker - base_worker - setup - 52 - [inactivity_monitor_worker] Worker setup completed.
2025-05-28 18:47:52,124 - INFO - InactivityMonitorWorker - base_worker - setup - 243 - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-28 18:47:52,124 - INFO - TokenUsageWorker - base_worker - setup - 52 - [token_usage_worker] Worker setup completed.
2025-05-28 18:47:52,124 - INFO - TokenUsageWorker - base_worker - setup - 114 - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-28 18:47:52,125 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 61 - ProcessManager setup complete for startup.
2025-05-28 18:47:52,127 - INFO - HistorySaverWorker - history_saver_worker - setup - 49 - [history_saver_worker] Database session factory initialized.
2025-05-28 18:47:52,127 - INFO - HistorySaverWorker - runnable_component - run - 111 - Component HistorySaverWorker (instance: 4446485584) setup complete. Starting run loop.
2025-05-28 18:47:52,127 - INFO - HistorySaverWorker - base_worker - run_loop - 131 - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-28 18:47:52,127 - INFO - TokenUsageWorker - token_usage_worker - setup - 57 - [token_usage_worker] Database session factory initialized.
2025-05-28 18:47:52,128 - INFO - TokenUsageWorker - token_usage_worker - setup - 64 - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-28 18:47:52,128 - INFO - TokenUsageWorker - runnable_component - run - 111 - Component TokenUsageWorker (instance: 4446485056) setup complete. Starting run loop.
2025-05-28 18:47:52,128 - INFO - TokenUsageWorker - base_worker - run_loop - 131 - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-28 18:47:52,129 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 86 - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-28 18:47:52,129 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 94 - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-28 18:47:52,177 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 66 - Found 1 agents to potentially start.
2025-05-28 18:47:52,177 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 69 - Attempting to start agent: agent_airsoft_0faa9616
2025-05-28 18:47:52,178 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 73 - Agent agent_airsoft_0faa9616 is already running.
2025-05-28 18:47:52,178 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 93 - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-28 18:47:52,178 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 109 - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-28 18:47:52,179 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 115 - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-28 18:47:52,180 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:47:52,180 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 18:47:52,180 - INFO - app.core.lifespan - lifespan - start_existing_agents_and_integrations - 153 - ProcessManager cleanup complete for startup function.
2025-05-28 18:47:52,180 - INFO - app.core.lifespan - lifespan - lifespan - 284 - Application startup sequence completed.
2025-05-28 18:48:02,131 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 96 - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-28 18:48:02,134 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - setup - 98 - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-28 18:48:02,134 - INFO - InactivityMonitorWorker - runnable_component - run - 111 - Component InactivityMonitorWorker (instance: 4446588368) setup complete. Starting run loop.
2025-05-28 18:48:02,134 - INFO - InactivityMonitorWorker - base_worker - run_loop - 258 - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-28 18:48:06,423 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _handle_text_message - 287 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Что у тебя есть про налоговую?...'
2025-05-28 18:48:06,434 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _check_user_authorization - 124 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-28 18:48:06,442 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _publish_to_agent - 101 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-28 18:48:06,443 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _handle_text_message - 313 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-28 18:48:06,443 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _handle_pubsub_message - 202 - Processing message for chat_id: 144641834
2025-05-28 18:48:06,445 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _save_history - 481 - Queued user message for history (Thread: 144641834, InteractionID: cf272141-313b-4f0c-825c-ee96fd2c2c5d)
2025-05-28 18:48:06,445 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _get_history - 417 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-28 18:48:06,446 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _get_history - 439 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-28 18:48:06,446 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _invoke_agent - 366 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-28 18:48:06,456 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 255 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-28 18:48:06,465 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_llm_instance - 80 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-28 18:48:06,509 - INFO - HistorySaverWorker - history_saver_worker - process_message - 123 - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: cf272141-313b-4f0c-825c-ee96fd2c2c5d, db_id: 905
2025-05-28 18:48:06,517 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _create_node_llm - 713 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-28 18:48:06,521 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _bind_tools_to_model - 804 - Model bound to 5 tools.
2025-05-28 18:48:07,444 - INFO - aiogram.event - dispatcher - feed_update - 172 - Update id=804756299 is handled. Duration 1022 ms by bot id=1750613938
2025-05-28 18:48:07,717 - INFO - httpx - _client - _send_single_request - 1740 - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-28 18:48:10,948 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 285 - Agent node response content preview: Вот что у меня есть про налоговую службу:

- Пример официального уведомления от Межрайонной инспекци
2025-05-28 18:48:10,948 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 287 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_38647f5e19'}
2025-05-28 18:48:10,948 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _agent_node - 289 - Agent node usage_metadata: {'input_tokens': 2641, 'output_tokens': 135, 'total_tokens': 2776, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-28 18:48:10,948 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _extract_token_data - 218 - Token usage from usage_metadata: P:2641 C:135 T:2776
2025-05-28 18:48:10,948 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _get_tokens - 250 - Token usage for agent_llm: 2776 tokens recorded.
2025-05-28 18:48:10,949 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _route_tools_edge - 605 - ---ROUTE TOOLS---
2025-05-28 18:48:10,949 - INFO - AGENT:agent_airsoft_0faa9616 - factory - _route_tools_edge - 613 - ---DECISION: NO TOOLS CALLED, END---
2025-05-28 18:48:10,950 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _invoke_agent - 384 - Graph execution finished. Final response: Вот что у меня есть про налоговую службу:

- Пример официального уведомления от Межрайонной инспекци...
2025-05-28 18:48:10,952 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _save_history - 481 - Queued agent message for history (Thread: 144641834, InteractionID: cf272141-313b-4f0c-825c-ee96fd2c2c5d)
2025-05-28 18:48:10,953 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - _save_tokens - 315 - Found 1 token usage events for InteractionID: cf272141-313b-4f0c-825c-ee96fd2c2c5d.
2025-05-28 18:48:10,956 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _handle_pubsub_message - 385 - Received response from agent for chat 144641834: Вот что у меня есть про налоговую службу:

- Пример официального уведомления от Межрайонной инспекци...
2025-05-28 18:48:10,956 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - _handle_pubsub_message - 414 - Sending message from agent to chat 144641834: 'Вот что у меня есть про налоговую службу:

- Приме...'
2025-05-28 18:48:10,958 - INFO - TokenUsageWorker - token_usage_worker - process_message - 117 - [token_usage_worker] RAW token usage data: {'interaction_id': 'cf272141-313b-4f0c-825c-ee96fd2c2c5d', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 2641, 'completion_tokens': 135, 'total_tokens': 2776, 'timestamp': '2025-05-28T13:48:10.948510+00:00'}
2025-05-28 18:48:10,958 - INFO - TokenUsageWorker - token_usage_worker - process_message - 129 - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: cf272141-313b-4f0c-825c-ee96fd2c2c5d
2025-05-28 18:48:10,963 - INFO - HistorySaverWorker - history_saver_worker - process_message - 123 - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: cf272141-313b-4f0c-825c-ee96fd2c2c5d, db_id: 906
2025-05-28 18:48:10,994 - INFO - TokenUsageWorker - token_usage_worker - process_message - 148 - [token_usage_worker] Found message_id: 906 for interaction_id: cf272141-313b-4f0c-825c-ee96fd2c2c5d on attempt 1
2025-05-28 18:48:10,998 - INFO - TokenUsageWorker - token_usage_worker - _save_token_usage_to_db - 92 - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: cf272141-313b-4f0c-825c-ee96fd2c2c5d, db_id: 366
2025-05-28 18:51:27,070 - INFO - app.core.lifespan - lifespan - lifespan - 287 - Application shutdown sequence initiated.
2025-05-28 18:51:27,071 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 230 - Stopping 3 background tasks...
2025-05-28 18:51:27,071 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task HistorySaverWorker...
2025-05-28 18:51:27,071 - INFO - HistorySaverWorker - runnable_component - run - 116 - Run_loop for HistorySaverWorker (instance: 4446485584) was cancelled.
2025-05-28 18:51:27,071 - INFO - HistorySaverWorker - runnable_component - run - 123 - Component HistorySaverWorker (instance: 4446485584) stopping. Performing cleanup...
2025-05-28 18:51:27,071 - INFO - HistorySaverWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 18:51:27,075 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for history_saver_worker as part of cleanup.
2025-05-28 18:51:27,076 - INFO - HistorySaverWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-28 18:51:27,076 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:51:27,076 - INFO - HistorySaverWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-28 18:51:27,076 - INFO - HistorySaverWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 18:51:27,076 - INFO - HistorySaverWorker - runnable_component - run - 128 - Component HistorySaverWorker (instance: 4446485584) cleanup complete.
2025-05-28 18:51:27,076 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task HistorySaverWorker finished after cancellation signal.
2025-05-28 18:51:27,076 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task TokenUsageWorker...
2025-05-28 18:51:27,076 - INFO - TokenUsageWorker - runnable_component - run - 116 - Run_loop for TokenUsageWorker (instance: 4446485056) was cancelled.
2025-05-28 18:51:27,076 - INFO - TokenUsageWorker - runnable_component - run - 123 - Component TokenUsageWorker (instance: 4446485056) stopping. Performing cleanup...
2025-05-28 18:51:27,076 - INFO - TokenUsageWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 18:51:27,079 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for token_usage_worker as part of cleanup.
2025-05-28 18:51:27,080 - INFO - TokenUsageWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-28 18:51:27,080 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:51:27,080 - INFO - TokenUsageWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-28 18:51:27,080 - INFO - TokenUsageWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 18:51:27,080 - INFO - TokenUsageWorker - runnable_component - run - 128 - Component TokenUsageWorker (instance: 4446485056) cleanup complete.
2025-05-28 18:51:27,080 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task TokenUsageWorker finished after cancellation signal.
2025-05-28 18:51:27,080 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 234 - Attempting to cancel task InactivityMonitorWorker...
2025-05-28 18:51:27,080 - INFO - InactivityMonitorWorker - runnable_component - run - 116 - Run_loop for InactivityMonitorWorker (instance: 4446588368) was cancelled.
2025-05-28 18:51:27,080 - INFO - InactivityMonitorWorker - runnable_component - run - 123 - Component InactivityMonitorWorker (instance: 4446588368) stopping. Performing cleanup...
2025-05-28 18:51:27,080 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 437 - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-28 18:51:27,080 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:51:27,080 - INFO - app.services.process_manager - process_manager - cleanup_manager - 170 - ProcessManager cleaned up Redis connection.
2025-05-28 18:51:27,080 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 441 - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-28 18:51:27,080 - INFO - InactivityMonitorWorker - base_worker - cleanup - 63 - [self._component_id] Worker cleanup started.
2025-05-28 18:51:27,083 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 316 - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-28 18:51:27,084 - INFO - InactivityMonitorWorker - status_updater - delete_status_key_from_redis - 196 - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-28 18:51:27,085 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:51:27,085 - INFO - InactivityMonitorWorker - status_updater - cleanup_status_updater - 320 - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-28 18:51:27,085 - INFO - InactivityMonitorWorker - base_worker - cleanup - 67 - [self._component_id] Worker cleanup completed.
2025-05-28 18:51:27,085 - INFO - InactivityMonitorWorker - inactivity_monitor_worker - cleanup - 445 - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-28 18:51:27,085 - INFO - InactivityMonitorWorker - runnable_component - run - 128 - Component InactivityMonitorWorker (instance: 4446588368) cleanup complete.
2025-05-28 18:51:27,085 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 240 - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-28 18:51:27,085 - INFO - app.core.lifespan - lifespan - stop_background_tasks - 249 - All background tasks signaled to stop.
2025-05-28 18:51:27,085 - INFO - app.services.redis_service - redis_service - close_redis_pool - 43 - Redis connection pool closed successfully.
2025-05-28 18:51:27,096 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 18:51:27,096 - INFO - app.core.lifespan - lifespan - lifespan - 293 - Application shutdown sequence completed.
2025-05-28 18:51:27,584 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-28 18:51:27,584 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-28 18:51:27,588 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-28 18:51:27,588 - INFO - app.core.lifespan - Starting background tasks...
2025-05-28 18:51:27,588 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-28 18:51:27,588 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-28 18:51:27,588 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-28 18:51:27,588 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-28 18:51:27,588 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-28 18:51:27,588 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-28 18:51:27,588 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-28 18:51:27,589 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-28 18:51:27,589 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-28 18:51:27,592 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-28 18:51:27,592 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-28 18:51:27,593 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-28 18:51:27,593 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-28 18:51:27,593 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-28 18:51:27,594 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-28 18:51:27,594 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-28 18:51:27,594 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-28 18:51:27,596 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-28 18:51:27,596 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4567290064) setup complete. Starting run loop.
2025-05-28 18:51:27,596 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-28 18:51:27,596 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4567300672) setup complete. Starting run loop.
2025-05-28 18:51:27,596 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-28 18:51:27,596 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-28 18:51:27,598 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-28 18:51:27,598 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-28 18:51:27,646 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-28 18:51:27,646 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-28 18:51:27,647 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-28 18:51:27,647 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-28 18:51:27,647 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-28 18:51:27,648 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-28 18:51:27,649 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-28 18:51:27,649 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-28 18:51:27,649 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-28 18:51:27,649 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-28 18:51:37,597 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-28 18:51:37,602 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-28 18:51:37,602 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4350868704) setup complete. Starting run loop.
2025-05-28 18:51:37,602 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-28 18:52:50,585 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - run_loop - 160 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-28 18:52:50,585 - WARNING - aiogram.dispatcher - dispatcher - _signal_stop_polling - 455 - Received SIGINT signal
2025-05-28 18:52:50,586 - INFO - AGENT:agent_airsoft_0faa9616 - runnable_component - initiate_shutdown - 74 - Component AgentRunner (instance: 4858692912) received shutdown request. Initiating graceful shutdown...
2025-05-28 18:52:50,586 - INFO - AGENT:agent_airsoft_0faa9616 - runnable_component - initiate_shutdown - 79 - Cancelling main task (_run_loop) for AgentRunner (instance: 4858692912)...
2025-05-28 18:52:50,586 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - run_loop - 172 - ServiceComponentBase run_loop finished.
2025-05-28 18:52:50,586 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - run_loop - 536 - AgentRunner run_loop finished.
2025-05-28 18:52:50,586 - INFO - AGENT:agent_airsoft_0faa9616 - runnable_component - run - 116 - Run_loop for AgentRunner (instance: 4858692912) was cancelled.
2025-05-28 18:52:50,587 - INFO - AGENT:agent_airsoft_0faa9616 - runnable_component - run - 123 - Component AgentRunner (instance: 4858692912) stopping. Performing cleanup...
2025-05-28 18:52:50,587 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - cleanup - 546 - AgentRunner cleanup started.
2025-05-28 18:52:50,587 - INFO - aiogram.dispatcher - dispatcher - _polling - 359 - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-28 18:52:50,587 - INFO - aiogram.dispatcher - dispatcher - start_polling - 554 - Polling stopped
2025-05-28 18:52:50,588 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - cleanup - 552 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-28 18:52:50,588 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - cleanup - 181 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-28 18:52:50,588 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - cleanup - 191 - Waiting for 1 tasks to process cancellation...
2025-05-28 18:52:50,588 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 270 - Pub/Sub listener task cancelled.
2025-05-28 18:52:50,588 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 294 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-28 18:52:50,588 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 298 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-28 18:52:50,588 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - cleanup - 202 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-28 18:52:50,589 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - cleanup - 207 - All main tasks processed and list cleared.
2025-05-28 18:52:50,596 - INFO - AGENT:agent_airsoft_0faa9616 - status_updater - cleanup_status_updater - 316 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-28 18:52:50,597 - INFO - AGENT:agent_airsoft_0faa9616 - status_updater - delete_status_key_from_redis - 196 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-28 18:52:50,597 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:52:50,597 - INFO - AGENT:agent_airsoft_0faa9616 - status_updater - cleanup_status_updater - 320 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-28 18:52:50,597 - INFO - AGENT:agent_airsoft_0faa9616 - service_component - cleanup - 211 - ServiceComponent cleanup completed.
2025-05-28 18:52:50,597 - INFO - AGENT:agent_airsoft_0faa9616 - agent_runner - cleanup - 581 - AgentRunner cleanup finished.
2025-05-28 18:52:50,597 - INFO - AGENT:agent_airsoft_0faa9616 - runnable_component - run - 128 - Component AgentRunner (instance: 4858692912) cleanup complete.
2025-05-28 18:52:50,597 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 51 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-28 18:52:50,597 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 60 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-28 18:52:50,608 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 18:52:50,608 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 63 - Database engine closed.
2025-05-28 18:52:50,608 - INFO - AGENT:agent_airsoft_0faa9616 - runner_main - main_async_runner - 66 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-28 18:52:50,608 - INFO - __main__ - runner_main - <module> - 86 - Agent runner main finished.
2025-05-28 18:52:50,695 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-28 18:52:50,695 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-28 18:52:50,695 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-28 18:52:50,695 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4567290064) was cancelled.
2025-05-28 18:52:50,695 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4567290064) stopping. Performing cleanup...
2025-05-28 18:52:50,695 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-28 18:52:50,700 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-28 18:52:50,701 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-28 18:52:50,701 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-28 18:52:50,701 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-28 18:52:50,701 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-28 18:52:50,701 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4567290064) cleanup complete.
2025-05-28 18:52:50,701 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-28 18:52:50,701 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-28 18:52:50,701 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4567300672) was cancelled.
2025-05-28 18:52:50,702 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4567300672) stopping. Performing cleanup...
2025-05-28 18:52:50,702 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-28 18:52:50,705 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-28 18:52:50,706 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-28 18:52:50,706 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-28 18:52:50,706 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-28 18:52:50,706 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-28 18:52:50,706 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4567300672) cleanup complete.
2025-05-28 18:52:50,706 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-28 18:52:50,706 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-28 18:52:50,706 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4350868704) was cancelled.
2025-05-28 18:52:50,706 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4350868704) stopping. Performing cleanup...
2025-05-28 18:52:50,706 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-28 18:52:50,706 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-28 18:52:50,706 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-28 18:52:50,706 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-28 18:52:50,706 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-28 18:52:50,709 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-28 18:52:50,709 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-28 18:52:50,709 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-28 18:52:50,710 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-28 18:52:50,710 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-28 18:52:50,710 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-28 18:52:50,710 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4350868704) cleanup complete.
2025-05-28 18:52:50,710 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-28 18:52:50,710 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-28 18:52:50,710 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-28 18:52:50,722 - INFO - app.db.session - Database engine closed successfully.
2025-05-28 18:52:50,722 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-28 18:52:50,841 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - polling_wrapper - 482 - Aiogram polling has stopped.
2025-05-28 18:52:50,841 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - run_loop - 137 - Main task 'AiogramPolling' completed. Result: None
2025-05-28 18:52:50,842 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - run_loop - 156 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-28 18:52:50,842 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - runnable_component - initiate_shutdown - 74 - Component TelegramIntegrationBot (instance: 4456881696) received shutdown request. Initiating graceful shutdown...
2025-05-28 18:52:50,842 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - runnable_component - initiate_shutdown - 79 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4456881696)...
2025-05-28 18:52:50,842 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - run_loop - 172 - ServiceComponentBase run_loop finished.
2025-05-28 18:52:50,843 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - run_loop - 494 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-28 18:52:50,845 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - runnable_component - run - 116 - Run_loop for TelegramIntegrationBot (instance: 4456881696) was cancelled.
2025-05-28 18:52:50,845 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - runnable_component - run - 123 - Component TelegramIntegrationBot (instance: 4456881696) stopping. Performing cleanup...
2025-05-28 18:52:50,846 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - cleanup - 503 - TelegramIntegrationBot cleanup started.
2025-05-28 18:52:50,847 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - cleanup - 516 - Closing Aiogram bot session.
2025-05-28 18:52:50,847 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - cleanup - 518 - Aiogram bot session closed.
2025-05-28 18:52:50,847 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - cleanup - 181 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-28 18:52:50,847 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - cleanup - 191 - Waiting for 1 tasks to process cancellation...
2025-05-28 18:52:50,847 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 270 - Pub/Sub listener task cancelled.
2025-05-28 18:52:50,847 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 294 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-28 18:52:50,848 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - _pubsub_listener_loop - 298 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-28 18:52:50,848 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - cleanup - 202 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-28 18:52:50,848 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - cleanup - 207 - All main tasks processed and list cleared.
2025-05-28 18:52:50,852 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - status_updater - cleanup_status_updater - 316 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-28 18:52:50,853 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - status_updater - delete_status_key_from_redis - 196 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-28 18:52:50,853 - INFO - app.core.base.redis_manager - redis_manager - close_redis_resources - 139 - Closing Redis client connection.
2025-05-28 18:52:50,854 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - status_updater - cleanup_status_updater - 320 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-28 18:52:50,854 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - service_component - cleanup - 211 - ServiceComponent cleanup completed.
2025-05-28 18:52:50,854 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot - cleanup - 524 - TelegramIntegrationBot cleanup finished.
2025-05-28 18:52:50,854 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - runnable_component - run - 128 - Component TelegramIntegrationBot (instance: 4456881696) cleanup complete.
2025-05-28 18:52:50,854 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot_main - main_async_runner - 86 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-28 18:52:50,854 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot_main - main_async_runner - 95 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-28 18:52:50,859 - INFO - app.db.session - session - close_db_engine - 66 - Database engine closed successfully.
2025-05-28 18:52:50,859 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot_main - main_async_runner - 98 - Database engine closed.
2025-05-28 18:52:50,859 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - telegram_bot_main - main_async_runner - 101 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-28 18:52:50,860 - INFO - __main__ - telegram_bot_main - <module> - 124 - Telegram bot runner main finished.
2025-05-28 18:52:56,207 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-28 18:52:56,208 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-28 18:52:56,212 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-28 18:52:56,212 - INFO - app.core.lifespan - Starting background tasks...
2025-05-28 18:52:56,212 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-28 18:52:56,212 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-28 18:52:56,212 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-28 18:52:56,212 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-28 18:52:56,212 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-28 18:52:56,212 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-28 18:52:56,213 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-28 18:52:56,213 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-28 18:52:56,213 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-28 18:52:56,216 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-28 18:52:56,216 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-28 18:52:56,216 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-28 18:52:56,216 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-28 18:52:56,216 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-28 18:52:56,216 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-28 18:52:56,216 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-28 18:52:56,218 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-28 18:52:56,218 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4450024624) setup complete. Starting run loop.
2025-05-28 18:52:56,218 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-28 18:52:56,218 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-28 18:52:56,219 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-28 18:52:56,219 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4441192688) setup complete. Starting run loop.
2025-05-28 18:52:56,219 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-28 18:52:56,220 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-28 18:52:56,220 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-28 18:52:56,265 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-28 18:52:56,265 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-28 18:52:56,267 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-28 18:52:56,268 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 2670
2025-05-28 18:52:56,268 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 2670
2025-05-28 18:52:56,269 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-28 18:52:56,269 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-28 18:52:56,269 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-28 18:52:56,270 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-28 18:52:56,271 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 2671
2025-05-28 18:52:56,271 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 2671
2025-05-28 18:52:56,272 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-28 18:52:56,272 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-28 18:52:56,272 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-28 18:52:56,272 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-28 18:52:56,273 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-28 18:52:57,172 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-28 18:52:57,173 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-28 18:52:57,173 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-28 18:52:57,173 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-28 18:52:57,173 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 2671
2025-05-28 18:52:57,173 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-28 18:52:57,173 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-28 18:52:57,173 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-28 18:52:57,177 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-28 18:52:57,190 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-28 18:52:57,191 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-28 18:52:57,191 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-28 18:52:57,191 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4403322208) setup complete. Starting run loop.
2025-05-28 18:52:57,191 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-28 18:52:57,191 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-28 18:52:57,191 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-28 18:52:57,191 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-28 18:52:57,191 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-28 18:52:57,191 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-28 18:52:57,192 - INFO - aiogram.dispatcher - Start polling
2025-05-28 18:52:57,195 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-28 18:52:57,441 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-28 18:52:57,532 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-28 18:52:57,533 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-28 18:52:57,533 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-28 18:52:57,533 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-28 18:52:57,533 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 2670
2025-05-28 18:52:57,533 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-28 18:52:57,533 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-28 18:52:57,533 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-28 18:52:57,539 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-28 18:52:57,539 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-28 18:52:57,620 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-28 18:52:57,621 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-28 18:52:57,621 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-28 18:52:57,621 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-28 18:52:57,621 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-28 18:52:57,621 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-28 18:52:57,647 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-28 18:52:57,647 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-28 18:52:57,647 - INFO - app.agent_runner.common.tools_registry - Configured 3 predefined tools from centralized registry
2025-05-28 18:52:57,647 - INFO - AGENT:agent_airsoft_0faa9616 - Added 3 tools from centralized registry
2025-05-28 18:52:57,647 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-28 18:52:57,701 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-28 18:52:57,706 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-28 18:52:58,664 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-28 18:52:58,666 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-28 18:52:58,666 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'База знаний' (ID: knowledgeBase-1745316404538) for datasources: ['5', '6', '7']
2025-05-28 18:52:58,666 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 4
2025-05-28 18:52:58,666 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Поиск в Интернете' (ID: webSearch-1746879979658)
2025-05-28 18:52:58,666 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 5 (4 safe, 1 datastore).
2025-05-28 18:52:58,666 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 5 total, 4 safe, 1 datastore tools. Max rewrites: 4.
2025-05-28 18:52:58,666 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-28 18:52:58,667 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-28 18:52:58,667 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-28 18:52:58,667 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-28 18:52:58,667 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-28 18:52:58,667 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-28 18:52:58,667 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-28 18:52:58,668 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-28 18:52:58,678 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-28 18:52:58,678 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-28 18:52:58,678 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-28 18:52:58,678 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4506879472) setup complete. Starting run loop.
2025-05-28 18:52:58,678 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-28 18:52:58,678 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-28 18:52:58,678 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-28 18:52:58,678 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-28 18:52:58,682 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-28 18:53:06,222 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-28 18:53:06,226 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-28 18:53:06,226 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4450013344) setup complete. Starting run loop.
2025-05-28 18:53:06,226 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-28 18:54:00,583 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-28 18:54:00,597 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-28 18:54:00,597 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-28 18:54:00,597 - INFO - app.db.crud.agent_crud - Updating agent config in DB for agent_id: agent_airsoft_0faa9616
2025-05-28 18:54:00,640 - INFO - app.db.crud.agent_crud - Agent config updated successfully for agent_id: agent_airsoft_0faa9616
2025-05-28 18:54:00,640 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616 was running. Attempting to restart it after config update.
2025-05-28 18:54:00,640 - INFO - app.services.process_manager - Restarting agent process for agent_airsoft_0faa9616...
2025-05-28 18:54:00,641 - INFO - app.services.process_manager - Stopping agent process agent_airsoft_0faa9616 (PID: 2670). Force: True
2025-05-28 18:54:00,641 - INFO - app.services.process_manager - SIGTERM sent to agent agent_airsoft_0faa9616 (PID: 2670)
2025-05-28 18:54:00,741 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 (PID: 2670) terminated gracefully after SIGTERM.
2025-05-28 18:54:00,743 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 marked as stopped in Redis.
2025-05-28 18:54:00,743 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 stopped (or stop attempted and assumed successful for restart). Pausing briefly...
2025-05-28 18:54:05,745 - INFO - app.services.process_manager - Proceeding to start agent agent_airsoft_0faa9616 after delay...
2025-05-28 18:54:05,748 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-28 18:54:05,749 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 2744
2025-05-28 18:54:05,749 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 2744
2025-05-28 18:54:05,750 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 successfully started as part of restart sequence.
2025-05-28 18:54:05,750 - INFO - app.api.routers.agent_api - Restart command issued for agent agent_airsoft_0faa9616 after config update.
2025-05-28 18:54:05,750 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-28 18:54:05,750 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-28 18:54:07,105 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-28 18:54:07,106 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-28 18:54:07,106 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-28 18:54:07,106 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-28 18:54:07,106 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 2744
2025-05-28 18:54:07,106 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-28 18:54:07,106 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-28 18:54:07,106 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-28 18:54:07,112 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-28 18:54:07,112 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-28 18:54:07,190 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-28 18:54:07,190 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-28 18:54:07,190 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-28 18:54:07,190 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-28 18:54:07,190 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-28 18:54:07,190 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-28 18:54:07,216 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-28 18:54:07,216 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-28 18:54:07,216 - INFO - app.agent_runner.common.tools_registry - Configured 3 predefined tools from centralized registry
2025-05-28 18:54:07,216 - INFO - AGENT:agent_airsoft_0faa9616 - Added 3 tools from centralized registry
2025-05-28 18:54:07,216 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-28 18:54:07,277 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-28 18:54:07,283 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-28 18:54:08,277 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-28 18:54:08,280 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-28 18:54:08,280 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'База знаний' (ID: knowledgeBase-1745316404538) for datasources: ['5', '6', '7']
2025-05-28 18:54:08,280 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 4
2025-05-28 18:54:08,280 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Поиск в Интернете' (ID: webSearch-1746879979658)
2025-05-28 18:54:08,281 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 5 (4 safe, 1 datastore).
2025-05-28 18:54:08,281 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 5 total, 4 safe, 1 datastore tools. Max rewrites: 4.
2025-05-28 18:54:08,281 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-28 18:54:08,281 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-28 18:54:08,282 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-28 18:54:08,282 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-28 18:54:08,282 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-28 18:54:08,282 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-28 18:54:08,282 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-28 18:54:08,282 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-28 18:54:08,293 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-28 18:54:08,293 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-28 18:54:08,293 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-28 18:54:08,293 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4504094192) setup complete. Starting run loop.
2025-05-28 18:54:08,293 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-28 18:54:08,293 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-28 18:54:08,294 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-28 18:54:08,294 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-28 18:54:08,297 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-28 18:54:41,853 - INFO - app.db.crud.agent_crud - Updating agent config in DB for agent_id: agent_airsoft_0faa9616
2025-05-28 18:54:41,888 - INFO - app.db.crud.agent_crud - Agent config updated successfully for agent_id: agent_airsoft_0faa9616
2025-05-28 18:54:41,889 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616 was running. Attempting to restart it after config update.
2025-05-28 18:54:41,889 - INFO - app.services.process_manager - Restarting agent process for agent_airsoft_0faa9616...
2025-05-28 18:54:41,891 - INFO - app.services.process_manager - Stopping agent process agent_airsoft_0faa9616 (PID: 2744). Force: True
2025-05-28 18:54:41,892 - INFO - app.services.process_manager - SIGTERM sent to agent agent_airsoft_0faa9616 (PID: 2744)
2025-05-28 18:54:41,992 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 (PID: 2744) terminated gracefully after SIGTERM.
2025-05-28 18:54:41,994 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 marked as stopped in Redis.
2025-05-28 18:54:41,994 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 stopped (or stop attempted and assumed successful for restart). Pausing briefly...
2025-05-28 18:54:46,995 - INFO - app.services.process_manager - Proceeding to start agent agent_airsoft_0faa9616 after delay...
2025-05-28 18:54:46,998 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-28 18:54:46,999 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 2766
2025-05-28 18:54:46,999 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 2766
2025-05-28 18:54:47,000 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 successfully started as part of restart sequence.
2025-05-28 18:54:47,000 - INFO - app.api.routers.agent_api - Restart command issued for agent agent_airsoft_0faa9616 after config update.
2025-05-28 18:54:47,000 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-28 18:54:47,000 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-28 18:54:48,258 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-28 18:54:48,259 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-28 18:54:48,259 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-28 18:54:48,259 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-28 18:54:48,259 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 2766
2025-05-28 18:54:48,259 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-28 18:54:48,259 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-28 18:54:48,259 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-28 18:54:48,266 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-28 18:54:48,266 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-28 18:54:48,346 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-28 18:54:48,346 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-28 18:54:48,346 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-28 18:54:48,346 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-28 18:54:48,346 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-28 18:54:48,346 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-28 18:54:48,372 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-28 18:54:48,372 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-28 18:54:48,372 - INFO - app.agent_runner.common.tools_registry - Configured 3 predefined tools from centralized registry
2025-05-28 18:54:48,372 - INFO - AGENT:agent_airsoft_0faa9616 - Added 3 tools from centralized registry
2025-05-28 18:54:48,372 - INFO - AGENT:agent_airsoft_0faa9616 - No Knowledge Base tools configured.
2025-05-28 18:54:48,372 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-28 18:54:48,372 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Поиск в Интернете' (ID: webSearch-1746879979658)
2025-05-28 18:54:48,372 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 4 (4 safe, 0 datastore).
2025-05-28 18:54:48,372 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 4 total, 4 safe, 0 datastore tools. Max rewrites: 3.
2025-05-28 18:54:48,372 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-28 18:54:48,373 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-28 18:54:48,373 - INFO - AGENT:agent_airsoft_0faa9616 - No datastore tools configured. RAG nodes skipped.
2025-05-28 18:54:48,373 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-28 18:54:48,373 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-28 18:54:48,373 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', '__end__'])
2025-05-28 18:54:48,378 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-28 18:54:48,378 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-28 18:54:48,378 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-28 18:54:48,378 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4430071040) setup complete. Starting run loop.
2025-05-28 18:54:48,378 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-28 18:54:48,378 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-28 18:54:48,378 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-28 18:54:48,378 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-28 18:54:48,381 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-28 18:55:14,652 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-28 18:55:14,659 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-28 18:55:14,660 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-28 18:55:14,660 - INFO - app.db.crud.agent_crud - Updating agent config in DB for agent_id: agent_airsoft_0faa9616
2025-05-28 18:55:14,668 - INFO - app.db.crud.agent_crud - Agent config updated successfully for agent_id: agent_airsoft_0faa9616
2025-05-28 18:55:14,668 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616 was running. Attempting to restart it after config update.
2025-05-28 18:55:14,668 - INFO - app.services.process_manager - Restarting agent process for agent_airsoft_0faa9616...
2025-05-28 18:55:14,671 - INFO - app.services.process_manager - Stopping agent process agent_airsoft_0faa9616 (PID: 2766). Force: True
2025-05-28 18:55:14,671 - INFO - app.services.process_manager - SIGTERM sent to agent agent_airsoft_0faa9616 (PID: 2766)
2025-05-28 18:55:14,772 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 (PID: 2766) terminated gracefully after SIGTERM.
2025-05-28 18:55:14,774 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 marked as stopped in Redis.
2025-05-28 18:55:14,774 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 stopped (or stop attempted and assumed successful for restart). Pausing briefly...
2025-05-28 18:55:19,775 - INFO - app.services.process_manager - Proceeding to start agent agent_airsoft_0faa9616 after delay...
2025-05-28 18:55:19,778 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-28 18:55:19,779 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 2785
2025-05-28 18:55:19,779 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 2785
2025-05-28 18:55:19,780 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 successfully started as part of restart sequence.
2025-05-28 18:55:19,780 - INFO - app.api.routers.agent_api - Restart command issued for agent agent_airsoft_0faa9616 after config update.
2025-05-28 18:55:19,780 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-28 18:55:19,780 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-28 18:55:21,060 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-28 18:55:21,060 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-28 18:55:21,061 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-28 18:55:21,061 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-28 18:55:21,061 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 2785
2025-05-28 18:55:21,061 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-28 18:55:21,061 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-28 18:55:21,061 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-28 18:55:21,067 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-28 18:55:21,067 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-28 18:55:21,141 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-28 18:55:21,141 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-28 18:55:21,141 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-28 18:55:21,141 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-28 18:55:21,141 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-28 18:55:21,141 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-28 18:55:21,167 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-28 18:55:21,167 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-28 18:55:21,167 - INFO - app.agent_runner.common.tools_registry - Configured 3 predefined tools from centralized registry
2025-05-28 18:55:21,167 - INFO - AGENT:agent_airsoft_0faa9616 - Added 3 tools from centralized registry
2025-05-28 18:55:21,167 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-28 18:55:21,226 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-28 18:55:21,231 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-28 18:55:22,313 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-28 18:55:22,317 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-28 18:55:22,317 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'База знаний' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-28 18:55:22,317 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-28 18:55:22,317 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Поиск в Интернете' (ID: webSearch-1746879979658)
2025-05-28 18:55:22,317 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 5 (4 safe, 1 datastore).
2025-05-28 18:55:22,317 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 5 total, 4 safe, 1 datastore tools. Max rewrites: 3.
2025-05-28 18:55:22,317 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-28 18:55:22,318 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-28 18:55:22,318 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-28 18:55:22,318 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-28 18:55:22,318 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-28 18:55:22,318 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-28 18:55:22,319 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-28 18:55:22,319 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-28 18:55:22,329 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-28 18:55:22,329 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-28 18:55:22,329 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-28 18:55:22,329 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 5168022928) setup complete. Starting run loop.
2025-05-28 18:55:22,329 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-28 18:55:22,329 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-28 18:55:22,329 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-28 18:55:22,329 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-28 18:55:22,333 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-28 18:56:09,058 - INFO - app.api.routers.sse_api - SSE connection requested for agent agent_airsoft_0faa9616, thread a469dcf5-a2a5-4344-b15c-27db2e19360a
2025-05-28 18:56:41,842 - INFO - app.api.routers.sse_api - Message published to agent:agent_airsoft_0faa9616:input for agent agent_airsoft_0faa9616, thread 9fb8e3a6-7879-4612-9e53-9d1bbaea8257
2025-05-28 18:56:41,842 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 9fb8e3a6-7879-4612-9e53-9d1bbaea8257
2025-05-28 18:56:41,844 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 9fb8e3a6-7879-4612-9e53-9d1bbaea8257, InteractionID: d06c037a-a1bc-45a7-bb04-fe36755847d0)
2025-05-28 18:56:41,844 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-28 18:56:41,845 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '9fb8e3a6-7879-4612-9e53-9d1bbaea8257' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-28 18:56:41,866 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: d06c037a-a1bc-45a7-bb04-fe36755847d0, db_id: 907
2025-05-28 18:56:41,947 - INFO - AGENT:agent_airsoft_0faa9616 - Loaded 1 messages from DB for thread '9fb8e3a6-7879-4612-9e53-9d1bbaea8257'.
2025-05-28 18:56:41,949 - INFO - AGENT:agent_airsoft_0faa9616 - Added thread '9fb8e3a6-7879-4612-9e53-9d1bbaea8257' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-28 18:56:41,949 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 9fb8e3a6-7879-4612-9e53-9d1bbaea8257 (Initial history messages: 1)
2025-05-28 18:56:41,960 - INFO - app.api.routers.sse_api - SSE connection requested for agent agent_airsoft_0faa9616, thread 9fb8e3a6-7879-4612-9e53-9d1bbaea8257
2025-05-28 18:56:42,042 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-28 18:56:42,042 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-28 18:56:42,077 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-28 18:56:42,084 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 5 tools.
2025-05-28 18:56:43,268 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-28 18:56:46,452 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Количество программистов, необходимых для перехода на 1С:Управление Торговлей 11 (УТ11), зависит от 
2025-05-28 18:56:46,452 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_71b9d4b387'}
2025-05-28 18:56:46,452 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 391, 'output_tokens': 186, 'total_tokens': 577, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-28 18:56:46,452 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:391 C:186 T:577
2025-05-28 18:56:46,452 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 577 tokens recorded.
2025-05-28 18:56:46,453 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-28 18:56:46,453 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-28 18:56:46,454 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Количество программистов, необходимых для перехода на 1С:Управление Торговлей 11 (УТ11), зависит от ...
2025-05-28 18:56:46,457 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 9fb8e3a6-7879-4612-9e53-9d1bbaea8257, InteractionID: d06c037a-a1bc-45a7-bb04-fe36755847d0)
2025-05-28 18:56:46,458 - INFO - AGENT:agent_airsoft_0faa9616 - Found 1 token usage events for InteractionID: d06c037a-a1bc-45a7-bb04-fe36755847d0.
2025-05-28 18:56:46,462 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'd06c037a-a1bc-45a7-bb04-fe36755847d0', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '9fb8e3a6-7879-4612-9e53-9d1bbaea8257', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 391, 'completion_tokens': 186, 'total_tokens': 577, 'timestamp': '2025-05-28T13:56:46.452692+00:00'}
2025-05-28 18:56:46,463 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: d06c037a-a1bc-45a7-bb04-fe36755847d0
2025-05-28 18:56:46,470 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: d06c037a-a1bc-45a7-bb04-fe36755847d0, db_id: 908
2025-05-28 18:56:46,510 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 908 for interaction_id: d06c037a-a1bc-45a7-bb04-fe36755847d0 on attempt 1
2025-05-28 18:56:46,519 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: d06c037a-a1bc-45a7-bb04-fe36755847d0, db_id: 367
2025-05-28 18:58:06,374 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 18:58:06,385 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 18:58:29,107 - INFO - app.api.routers.sse_api - Message published to agent:agent_airsoft_0faa9616:input for agent agent_airsoft_0faa9616, thread 9fb8e3a6-7879-4612-9e53-9d1bbaea8257
2025-05-28 18:58:29,108 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 9fb8e3a6-7879-4612-9e53-9d1bbaea8257
2025-05-28 18:58:29,109 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 9fb8e3a6-7879-4612-9e53-9d1bbaea8257, InteractionID: ed604089-d348-4c2c-8147-91a980b207a7)
2025-05-28 18:58:29,109 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-28 18:58:29,110 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '9fb8e3a6-7879-4612-9e53-9d1bbaea8257' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-28 18:58:29,110 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 9fb8e3a6-7879-4612-9e53-9d1bbaea8257 (Initial history messages: 0)
2025-05-28 18:58:29,121 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-28 18:58:29,122 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-28 18:58:29,126 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: ed604089-d348-4c2c-8147-91a980b207a7, db_id: 909
2025-05-28 18:58:29,154 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-28 18:58:29,159 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 5 tools.
2025-05-28 18:58:30,366 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-28 18:58:30,686 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-28 18:58:30,686 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_71b9d4b387'}
2025-05-28 18:58:30,686 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 590, 'output_tokens': 35, 'total_tokens': 625, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-28 18:58:30,686 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:590 C:35 T:625
2025-05-28 18:58:30,686 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 625 tokens recorded.
2025-05-28 18:58:30,687 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-28 18:58:30,687 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: knowledgeBase-1748440512419
2025-05-28 18:58:30,687 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO RETRIEVE (knowledgeBase-1748440512419)---
2025-05-28 18:58:31,803 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-28 18:58:31,824 - INFO - httpx - HTTP Request: POST http://127.0.0.1:6333/collections/platformai/points/query "HTTP/1.1 200 OK"
2025-05-28 18:58:31,827 - INFO - AGENT:agent_airsoft_0faa9616 - ---CHECK RELEVANCE (Agent ID: agent_airsoft_0faa9616)---
2025-05-28 18:58:31,828 - INFO - AGENT:agent_airsoft_0faa9616 - Grading documents for question: 'Посмотри в базе знаний'
2025-05-28 18:58:31,828 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.0, streaming: False
2025-05-28 18:58:31,853 - INFO - AGENT:agent_airsoft_0faa9616 - Created grading LLM: gpt-4.1-mini via OpenAI
2025-05-28 18:58:31,856 - INFO - AGENT:agent_airsoft_0faa9616 - Grading document content (first 300 chars): # **8) Всякое**

8.1) Всякие обработки и механизмы которые нужно будет переписывать под новую 1с. Тут это займет месяцев 6

# **9)Разработка матрицы прав под нашу логику**

9.1) Это всякие роли права, статусы для заказов. Какая роль за что отвечает, кто что делает с заказами. 1 месяц

# **10)Обучени
2025-05-28 18:58:31,856 - INFO - AGENT:agent_airsoft_0faa9616 - Question for grading: Посмотри в базе знаний
2025-05-28 18:58:32,790 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-28 18:58:32,818 - INFO - AGENT:agent_airsoft_0faa9616 - Grading result: yes for document starting with: # **8) Всякое**

8.1) Всякие обработки и механизмы которые нужно будет переписывать под новую 1с. Ту...
2025-05-28 18:58:32,818 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:905 C:6 T:911
2025-05-28 18:58:32,818 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for grading_llm: 911 tokens recorded.
2025-05-28 18:58:32,818 - INFO - AGENT:agent_airsoft_0faa9616 - Total token usage for grading_llm batch: 911 tokens.
2025-05-28 18:58:32,818 - INFO - AGENT:agent_airsoft_0faa9616 - Found 1 relevant documents out of 1 initial (after split).
2025-05-28 18:58:32,819 - INFO - AGENT:agent_airsoft_0faa9616 - ---ASSESS GRADED DOCUMENTS---
2025-05-28 18:58:32,819 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: RELEVANT DOCUMENTS FOUND, GENERATE---
2025-05-28 18:58:32,820 - INFO - AGENT:agent_airsoft_0faa9616 - ---GENERATE (Agent ID: agent_airsoft_0faa9616)---
2025-05-28 18:58:32,820 - INFO - AGENT:agent_airsoft_0faa9616 - Generating answer for question: 'Посмотри в базе знаний' using 1 documents.
2025-05-28 18:58:32,820 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-28 18:58:32,849 - INFO - AGENT:agent_airsoft_0faa9616 - Created generate LLM: gpt-4.1-mini via OpenAI
2025-05-28 18:58:33,685 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-28 18:58:36,078 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:875 C:132 T:1007
2025-05-28 18:58:36,078 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for generation_llm: 1007 tokens recorded.
2025-05-28 18:58:36,079 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: В базе знаний есть информация по этапам и срокам перехода на новую 1С, включая переписывание бизнес-...
2025-05-28 18:58:36,082 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 9fb8e3a6-7879-4612-9e53-9d1bbaea8257, InteractionID: ed604089-d348-4c2c-8147-91a980b207a7)
2025-05-28 18:58:36,082 - INFO - AGENT:agent_airsoft_0faa9616 - Found 3 token usage events for InteractionID: ed604089-d348-4c2c-8147-91a980b207a7.
2025-05-28 18:58:36,089 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'ed604089-d348-4c2c-8147-91a980b207a7', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '9fb8e3a6-7879-4612-9e53-9d1bbaea8257', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 590, 'completion_tokens': 35, 'total_tokens': 625, 'timestamp': '2025-05-28T13:58:30.686276+00:00'}
2025-05-28 18:58:36,089 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: ed604089-d348-4c2c-8147-91a980b207a7
2025-05-28 18:58:36,117 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: ed604089-d348-4c2c-8147-91a980b207a7, db_id: 910
2025-05-28 18:58:36,117 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 910 for interaction_id: ed604089-d348-4c2c-8147-91a980b207a7 on attempt 1
2025-05-28 18:58:36,127 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: ed604089-d348-4c2c-8147-91a980b207a7, db_id: 368
2025-05-28 18:58:36,132 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'ed604089-d348-4c2c-8147-91a980b207a7', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '9fb8e3a6-7879-4612-9e53-9d1bbaea8257', 'call_type': 'generation_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 875, 'completion_tokens': 132, 'total_tokens': 1007, 'timestamp': '2025-05-28T13:58:36.078633+00:00'}
2025-05-28 18:58:36,132 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: ed604089-d348-4c2c-8147-91a980b207a7
2025-05-28 18:58:36,133 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 910 for interaction_id: ed604089-d348-4c2c-8147-91a980b207a7 on attempt 1
2025-05-28 18:58:36,136 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: ed604089-d348-4c2c-8147-91a980b207a7, db_id: 369
2025-05-28 18:58:36,139 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'ed604089-d348-4c2c-8147-91a980b207a7', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '9fb8e3a6-7879-4612-9e53-9d1bbaea8257', 'call_type': 'grading_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 905, 'completion_tokens': 6, 'total_tokens': 911, 'timestamp': '2025-05-28T13:58:32.818589+00:00'}
2025-05-28 18:58:36,139 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: ed604089-d348-4c2c-8147-91a980b207a7
2025-05-28 18:58:36,140 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 910 for interaction_id: ed604089-d348-4c2c-8147-91a980b207a7 on attempt 1
2025-05-28 18:58:36,142 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: ed604089-d348-4c2c-8147-91a980b207a7, db_id: 370
2025-05-28 19:03:06,584 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 19:03:06,594 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 19:08:06,788 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 19:08:06,797 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 19:13:07,000 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 19:13:07,010 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 19:18:07,204 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 19:18:07,211 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 19:23:07,406 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 19:23:07,418 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 19:28:07,628 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 19:28:07,641 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 19:33:07,825 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 19:33:07,834 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 19:33:49,689 - INFO - app.api.routers.sse_api - SSE connection for agent agent_airsoft_0faa9616, thread a469dcf5-a2a5-4344-b15c-27db2e19360a closed by client.
2025-05-28 19:33:49,690 - INFO - app.api.routers.sse_api - SSE connection for agent agent_airsoft_0faa9616, thread 9fb8e3a6-7879-4612-9e53-9d1bbaea8257 closed by client.
2025-05-28 19:33:49,762 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-28 19:33:49,762 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-28 19:33:49,762 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-28 19:33:49,762 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4450024624) was cancelled.
2025-05-28 19:33:49,762 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4450024624) stopping. Performing cleanup...
2025-05-28 19:33:49,762 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-28 19:33:49,767 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-28 19:33:49,768 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-28 19:33:49,768 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-28 19:33:49,768 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-28 19:33:49,768 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-28 19:33:49,768 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4450024624) cleanup complete.
2025-05-28 19:33:49,768 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-28 19:33:49,768 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-28 19:33:49,769 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4441192688) was cancelled.
2025-05-28 19:33:49,769 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4441192688) stopping. Performing cleanup...
2025-05-28 19:33:49,769 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-28 19:33:49,772 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-28 19:33:49,772 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-28 19:33:49,772 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-28 19:33:49,773 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-28 19:33:49,773 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-28 19:33:49,773 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4441192688) cleanup complete.
2025-05-28 19:33:49,773 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-28 19:33:49,773 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-28 19:33:49,773 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4450013344) was cancelled.
2025-05-28 19:33:49,773 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4450013344) stopping. Performing cleanup...
2025-05-28 19:33:49,773 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-28 19:33:49,773 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-28 19:33:49,773 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-28 19:33:49,773 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-28 19:33:49,773 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-28 19:33:49,776 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-28 19:33:49,777 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-28 19:33:49,777 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-28 19:33:49,777 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-28 19:33:49,777 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-28 19:33:49,777 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-28 19:33:49,777 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4450013344) cleanup complete.
2025-05-28 19:33:49,777 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-28 19:33:49,777 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-28 19:33:49,777 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-28 19:33:49,792 - INFO - app.db.session - Database engine closed successfully.
2025-05-28 19:33:49,792 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-28 19:33:50,323 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-28 19:33:50,323 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-28 19:33:50,328 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-28 19:33:50,328 - INFO - app.core.lifespan - Starting background tasks...
2025-05-28 19:33:50,328 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-28 19:33:50,328 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-28 19:33:50,328 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-28 19:33:50,328 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-28 19:33:50,328 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-28 19:33:50,328 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-28 19:33:50,329 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-28 19:33:50,329 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-28 19:33:50,329 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-28 19:33:50,332 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-28 19:33:50,333 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-28 19:33:50,333 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-28 19:33:50,334 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-28 19:33:50,334 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-28 19:33:50,334 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-28 19:33:50,334 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-28 19:33:50,335 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-28 19:33:50,335 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4449549200) setup complete. Starting run loop.
2025-05-28 19:33:50,335 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-28 19:33:50,335 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-28 19:33:50,336 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-28 19:33:50,336 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4449548864) setup complete. Starting run loop.
2025-05-28 19:33:50,336 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-28 19:33:50,337 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-28 19:33:50,337 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-28 19:33:50,384 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-28 19:33:50,384 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-28 19:33:50,385 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-28 19:33:50,385 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-28 19:33:50,385 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-28 19:33:50,386 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-28 19:33:50,387 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-28 19:33:50,387 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-28 19:33:50,387 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-28 19:33:50,387 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-28 19:34:00,338 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-28 19:34:00,343 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-28 19:34:00,343 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4437695552) setup complete. Starting run loop.
2025-05-28 19:34:00,343 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-28 19:39:00,546 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 19:39:00,555 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 19:44:00,719 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 19:44:00,728 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 19:49:01,062 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 19:49:01,098 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 19:54:01,497 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 19:54:01,507 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 19:59:01,879 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 19:59:01,889 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 20:04:02,228 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 20:04:02,237 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 20:09:02,623 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 20:09:02,634 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 20:14:02,970 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 20:14:02,979 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 20:19:03,370 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 20:19:03,383 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 20:24:03,752 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 20:24:03,762 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 20:29:04,165 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 20:29:04,175 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 20:34:04,537 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 20:34:04,549 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 20:39:04,889 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 20:39:04,900 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 20:44:05,279 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 20:44:05,288 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 20:49:05,646 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 20:49:05,654 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 20:54:06,033 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 20:54:06,042 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 20:59:06,431 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 20:59:06,439 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 21:04:06,826 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 21:04:06,836 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 21:09:07,187 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 21:09:07,196 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 21:14:07,546 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 21:14:07,556 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 21:19:07,933 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 21:19:07,946 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 21:24:08,342 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 21:24:08,351 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 21:29:08,713 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 21:29:08,723 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 21:34:09,054 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 21:34:09,065 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 21:39:09,242 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 21:39:09,251 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 21:41:57,740 - ERROR - aiogram.dispatcher - Failed to fetch updates - TelegramNetworkError: HTTP Client says - Request timeout error
2025-05-28 21:41:57,822 - WARNING - aiogram.dispatcher - Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 1750613938)
2025-05-28 21:42:09,741 - INFO - aiogram.dispatcher - Connection established (tryings = 1, bot id = 1750613938)
2025-05-28 21:59:27,737 - ERROR - aiogram.dispatcher - Failed to fetch updates - TelegramNetworkError: HTTP Client says - Request timeout error
2025-05-28 21:59:27,737 - WARNING - aiogram.dispatcher - Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 1750613938)
2025-05-28 21:59:48,299 - INFO - aiogram.dispatcher - Connection established (tryings = 1, bot id = 1750613938)
2025-05-28 22:04:40,563 - ERROR - aiogram.dispatcher - Failed to fetch updates - TelegramNetworkError: HTTP Client says - Request timeout error
2025-05-28 22:04:40,564 - WARNING - aiogram.dispatcher - Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 1750613938)
2025-05-28 22:04:51,810 - INFO - aiogram.dispatcher - Connection established (tryings = 1, bot id = 1750613938)
2025-05-28 22:05:17,395 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 22:05:17,406 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 22:49:33,601 - ERROR - aiogram.dispatcher - Failed to fetch updates - TelegramNetworkError: HTTP Client says - Request timeout error
2025-05-28 22:49:33,604 - WARNING - aiogram.dispatcher - Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 1750613938)
2025-05-28 22:49:44,871 - INFO - aiogram.dispatcher - Connection established (tryings = 1, bot id = 1750613938)
2025-05-28 22:52:23,194 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 22:52:23,204 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 22:57:23,401 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 22:57:23,411 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 22:59:41,719 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-28 22:59:41,730 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-28 22:59:41,732 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-28 22:59:41,732 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-28 22:59:41,736 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-28 22:59:41,737 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-28 22:59:41,737 - INFO - app.db.crud.agent_crud - Updating agent config in DB for agent_id: agent_airsoft_0faa9616
2025-05-28 22:59:41,774 - INFO - app.db.crud.agent_crud - Agent config updated successfully for agent_id: agent_airsoft_0faa9616
2025-05-28 22:59:41,774 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616 was running. Attempting to restart it after config update.
2025-05-28 22:59:41,774 - INFO - app.services.process_manager - Restarting agent process for agent_airsoft_0faa9616...
2025-05-28 22:59:41,775 - INFO - app.services.process_manager - Stopping agent process agent_airsoft_0faa9616 (PID: 2785). Force: True
2025-05-28 22:59:41,776 - INFO - app.services.process_manager - SIGTERM sent to agent agent_airsoft_0faa9616 (PID: 2785)
2025-05-28 22:59:41,877 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 (PID: 2785) terminated gracefully after SIGTERM.
2025-05-28 22:59:41,880 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 marked as stopped in Redis.
2025-05-28 22:59:41,880 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 stopped (or stop attempted and assumed successful for restart). Pausing briefly...
2025-05-28 22:59:46,881 - INFO - app.services.process_manager - Proceeding to start agent agent_airsoft_0faa9616 after delay...
2025-05-28 22:59:46,884 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-28 22:59:46,889 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 9495
2025-05-28 22:59:46,889 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 9495
2025-05-28 22:59:46,890 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 successfully started as part of restart sequence.
2025-05-28 22:59:46,890 - INFO - app.api.routers.agent_api - Restart command issued for agent agent_airsoft_0faa9616 after config update.
2025-05-28 22:59:46,890 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-28 22:59:46,890 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-28 22:59:48,503 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-28 22:59:48,503 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-28 22:59:48,503 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-28 22:59:48,503 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-28 22:59:48,503 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 9495
2025-05-28 22:59:48,503 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-28 22:59:48,503 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-28 22:59:48,503 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-28 22:59:48,510 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-28 22:59:48,510 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-28 22:59:48,586 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-28 22:59:48,587 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-28 22:59:48,587 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-28 22:59:48,587 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-28 22:59:48,587 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-28 22:59:48,587 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-28 22:59:48,613 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-28 22:59:48,613 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-28 22:59:48,613 - INFO - app.agent_runner.common.tools_registry - Configured 3 predefined tools from centralized registry
2025-05-28 22:59:48,613 - INFO - AGENT:agent_airsoft_0faa9616 - Added 3 tools from centralized registry
2025-05-28 22:59:48,613 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 2 Knowledge Base tool(s)...
2025-05-28 22:59:48,681 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-28 22:59:48,697 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-28 22:59:50,327 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-28 22:59:50,330 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-28 22:59:50,330 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'airsoft' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-28 22:59:50,330 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'База знаний' (ID: knowledgeBase-1748455171610) for datasources: ['5', '6', '7']
2025-05-28 22:59:50,330 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-28 22:59:50,330 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Поиск в Интернете' (ID: webSearch-1746879979658)
2025-05-28 22:59:50,330 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (4 safe, 2 datastore).
2025-05-28 22:59:50,330 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 4 safe, 2 datastore tools. Max rewrites: 3.
2025-05-28 22:59:50,330 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-28 22:59:50,331 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-28 22:59:50,331 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-28 22:59:50,331 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-28 22:59:50,331 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-28 22:59:50,331 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-28 22:59:50,331 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-28 22:59:50,331 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-28 22:59:50,341 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-28 22:59:50,341 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-28 22:59:50,341 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-28 22:59:50,341 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4921656240) setup complete. Starting run loop.
2025-05-28 22:59:50,341 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-28 22:59:50,341 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-28 22:59:50,341 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-28 22:59:50,341 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-28 22:59:50,346 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-28 23:00:20,669 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-28 23:00:20,679 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-28 23:00:20,680 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-28 23:00:20,681 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-28 23:00:20,690 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-28 23:00:20,691 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-28 23:00:20,692 - INFO - app.db.crud.agent_crud - Updating agent config in DB for agent_id: agent_airsoft_0faa9616
2025-05-28 23:00:20,725 - INFO - app.db.crud.agent_crud - Agent config updated successfully for agent_id: agent_airsoft_0faa9616
2025-05-28 23:00:20,725 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616 was running. Attempting to restart it after config update.
2025-05-28 23:00:20,725 - INFO - app.services.process_manager - Restarting agent process for agent_airsoft_0faa9616...
2025-05-28 23:00:20,727 - INFO - app.services.process_manager - Stopping agent process agent_airsoft_0faa9616 (PID: 9495). Force: True
2025-05-28 23:00:20,727 - INFO - app.services.process_manager - SIGTERM sent to agent agent_airsoft_0faa9616 (PID: 9495)
2025-05-28 23:00:20,827 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 (PID: 9495) terminated gracefully after SIGTERM.
2025-05-28 23:00:20,830 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 marked as stopped in Redis.
2025-05-28 23:00:20,830 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 stopped (or stop attempted and assumed successful for restart). Pausing briefly...
2025-05-28 23:00:25,831 - INFO - app.services.process_manager - Proceeding to start agent agent_airsoft_0faa9616 after delay...
2025-05-28 23:00:25,832 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-28 23:00:25,834 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 9528
2025-05-28 23:00:25,834 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 9528
2025-05-28 23:00:25,835 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 successfully started as part of restart sequence.
2025-05-28 23:00:25,835 - INFO - app.api.routers.agent_api - Restart command issued for agent agent_airsoft_0faa9616 after config update.
2025-05-28 23:00:25,835 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-28 23:00:25,835 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-28 23:00:27,237 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-28 23:00:27,238 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-28 23:00:27,238 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-28 23:00:27,238 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-28 23:00:27,238 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 9528
2025-05-28 23:00:27,238 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-28 23:00:27,238 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-28 23:00:27,238 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-28 23:00:27,245 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-28 23:00:27,245 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-28 23:00:27,320 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-28 23:00:27,321 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-28 23:00:27,321 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-28 23:00:27,321 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-28 23:00:27,321 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-28 23:00:27,321 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-28 23:00:27,346 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-28 23:00:27,346 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-28 23:00:27,346 - INFO - app.agent_runner.common.tools_registry - Configured 3 predefined tools from centralized registry
2025-05-28 23:00:27,346 - INFO - AGENT:agent_airsoft_0faa9616 - Added 3 tools from centralized registry
2025-05-28 23:00:27,346 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 2 Knowledge Base tool(s)...
2025-05-28 23:00:27,404 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-28 23:00:27,412 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-28 23:00:28,332 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-28 23:00:28,335 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-28 23:00:28,335 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'airsoft' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-28 23:00:28,335 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'База знаний' (ID: knowledgeBase-1748455171610) for datasources: ['5', '6', '7']
2025-05-28 23:00:28,336 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-28 23:00:28,336 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Поиск в Интернете' (ID: webSearch-1746879979658)
2025-05-28 23:00:28,336 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (4 safe, 2 datastore).
2025-05-28 23:00:28,336 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 4 safe, 2 datastore tools. Max rewrites: 3.
2025-05-28 23:00:28,336 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-28 23:00:28,336 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-28 23:00:28,336 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-28 23:00:28,337 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-28 23:00:28,337 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-28 23:00:28,337 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-28 23:00:28,337 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-28 23:00:28,337 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-28 23:00:28,348 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-28 23:00:28,348 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-28 23:00:28,348 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-28 23:00:28,348 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4559848896) setup complete. Starting run loop.
2025-05-28 23:00:28,348 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-28 23:00:28,348 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-28 23:00:28,348 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-28 23:00:28,348 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-28 23:00:28,352 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-28 23:02:23,620 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 23:02:23,630 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 23:07:23,832 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 23:07:23,842 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 23:12:24,045 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 23:12:24,055 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 23:17:24,246 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 23:17:24,254 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 23:22:24,445 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 23:22:24,458 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 23:24:42,218 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-28 23:24:42,229 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-28 23:24:42,232 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-28 23:24:42,232 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-28 23:24:42,240 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-28 23:24:42,241 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-28 23:24:42,242 - INFO - app.db.crud.agent_crud - Updating agent config in DB for agent_id: agent_airsoft_0faa9616
2025-05-28 23:24:42,300 - INFO - app.db.crud.agent_crud - Agent config updated successfully for agent_id: agent_airsoft_0faa9616
2025-05-28 23:24:42,300 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616 was running. Attempting to restart it after config update.
2025-05-28 23:24:42,300 - INFO - app.services.process_manager - Restarting agent process for agent_airsoft_0faa9616...
2025-05-28 23:24:42,306 - INFO - app.services.process_manager - Stopping agent process agent_airsoft_0faa9616 (PID: 9528). Force: True
2025-05-28 23:24:42,307 - INFO - app.services.process_manager - SIGTERM sent to agent agent_airsoft_0faa9616 (PID: 9528)
2025-05-28 23:24:42,407 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 (PID: 9528) terminated gracefully after SIGTERM.
2025-05-28 23:24:42,410 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 marked as stopped in Redis.
2025-05-28 23:24:42,410 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 stopped (or stop attempted and assumed successful for restart). Pausing briefly...
2025-05-28 23:24:47,411 - INFO - app.services.process_manager - Proceeding to start agent agent_airsoft_0faa9616 after delay...
2025-05-28 23:24:47,412 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-28 23:24:47,413 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 10243
2025-05-28 23:24:47,413 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 10243
2025-05-28 23:24:47,414 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 successfully started as part of restart sequence.
2025-05-28 23:24:47,414 - INFO - app.api.routers.agent_api - Restart command issued for agent agent_airsoft_0faa9616 after config update.
2025-05-28 23:24:47,414 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-28 23:24:47,414 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-28 23:24:48,991 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-28 23:24:48,991 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-28 23:24:48,991 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-28 23:24:48,991 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-28 23:24:48,991 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 10243
2025-05-28 23:24:48,991 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-28 23:24:48,991 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-28 23:24:48,991 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-28 23:24:48,998 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-28 23:24:48,998 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-28 23:24:49,076 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-28 23:24:49,076 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-28 23:24:49,076 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-28 23:24:49,076 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-28 23:24:49,076 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-28 23:24:49,076 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-28 23:24:49,102 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-28 23:24:49,102 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-28 23:24:49,102 - INFO - app.agent_runner.common.tools_registry - Configured 3 predefined tools from centralized registry
2025-05-28 23:24:49,102 - INFO - AGENT:agent_airsoft_0faa9616 - Added 3 tools from centralized registry
2025-05-28 23:24:49,102 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 2 Knowledge Base tool(s)...
2025-05-28 23:24:49,161 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-28 23:24:49,175 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-28 23:24:50,302 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-28 23:24:50,305 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-28 23:24:50,305 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'airsoft' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-28 23:24:50,305 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'База знаний' (ID: knowledgeBase-1748455171610) for datasources: ['5', '6', '7']
2025-05-28 23:24:50,305 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-28 23:24:50,305 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1746879979658)
2025-05-28 23:24:50,305 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (4 safe, 2 datastore).
2025-05-28 23:24:50,306 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 4 safe, 2 datastore tools. Max rewrites: 3.
2025-05-28 23:24:50,306 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-28 23:24:50,306 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-28 23:24:50,306 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-28 23:24:50,307 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-28 23:24:50,307 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-28 23:24:50,307 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-28 23:24:50,307 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-28 23:24:50,307 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-28 23:24:50,318 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-28 23:24:50,318 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-28 23:24:50,318 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-28 23:24:50,318 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4693034192) setup complete. Starting run loop.
2025-05-28 23:24:50,318 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-28 23:24:50,318 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-28 23:24:50,318 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-28 23:24:50,318 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-28 23:24:50,322 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-28 23:24:59,341 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-28 23:24:59,345 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-28 23:24:59,346 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-28 23:24:59,346 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-28 23:24:59,351 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-28 23:24:59,352 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-28 23:24:59,352 - INFO - app.db.crud.agent_crud - Updating agent config in DB for agent_id: agent_airsoft_0faa9616
2025-05-28 23:24:59,361 - INFO - app.db.crud.agent_crud - Agent config updated successfully for agent_id: agent_airsoft_0faa9616
2025-05-28 23:24:59,361 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616 was running. Attempting to restart it after config update.
2025-05-28 23:24:59,361 - INFO - app.services.process_manager - Restarting agent process for agent_airsoft_0faa9616...
2025-05-28 23:24:59,363 - INFO - app.services.process_manager - Stopping agent process agent_airsoft_0faa9616 (PID: 10243). Force: True
2025-05-28 23:24:59,363 - INFO - app.services.process_manager - SIGTERM sent to agent agent_airsoft_0faa9616 (PID: 10243)
2025-05-28 23:24:59,465 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 (PID: 10243) terminated gracefully after SIGTERM.
2025-05-28 23:24:59,466 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 marked as stopped in Redis.
2025-05-28 23:24:59,466 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 stopped (or stop attempted and assumed successful for restart). Pausing briefly...
2025-05-28 23:25:04,468 - INFO - app.services.process_manager - Proceeding to start agent agent_airsoft_0faa9616 after delay...
2025-05-28 23:25:04,473 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-28 23:25:04,475 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 10263
2025-05-28 23:25:04,475 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 10263
2025-05-28 23:25:04,476 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 successfully started as part of restart sequence.
2025-05-28 23:25:04,476 - INFO - app.api.routers.agent_api - Restart command issued for agent agent_airsoft_0faa9616 after config update.
2025-05-28 23:25:04,476 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-28 23:25:04,476 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-28 23:25:05,982 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-28 23:25:05,982 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-28 23:25:05,982 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-28 23:25:05,982 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-28 23:25:05,982 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 10263
2025-05-28 23:25:05,982 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-28 23:25:05,982 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-28 23:25:05,982 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-28 23:25:05,991 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-28 23:25:05,991 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-28 23:25:06,084 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-28 23:25:06,084 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-28 23:25:06,084 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-28 23:25:06,084 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-28 23:25:06,084 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-28 23:25:06,085 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-28 23:25:06,111 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-28 23:25:06,111 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-28 23:25:06,111 - INFO - app.agent_runner.common.tools_registry - Configured 3 predefined tools from centralized registry
2025-05-28 23:25:06,111 - INFO - AGENT:agent_airsoft_0faa9616 - Added 3 tools from centralized registry
2025-05-28 23:25:06,111 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 2 Knowledge Base tool(s)...
2025-05-28 23:25:06,186 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-28 23:25:06,194 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-28 23:25:07,198 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-28 23:25:07,200 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-28 23:25:07,200 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-28 23:25:07,200 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748455171610) for datasources: ['5', '6', '7']
2025-05-28 23:25:07,200 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-28 23:25:07,200 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1746879979658)
2025-05-28 23:25:07,200 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (4 safe, 2 datastore).
2025-05-28 23:25:07,200 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 4 safe, 2 datastore tools. Max rewrites: 3.
2025-05-28 23:25:07,200 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-28 23:25:07,201 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-28 23:25:07,201 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-28 23:25:07,201 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-28 23:25:07,201 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-28 23:25:07,201 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-28 23:25:07,201 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-28 23:25:07,201 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-28 23:25:07,212 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-28 23:25:07,212 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-28 23:25:07,212 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-28 23:25:07,212 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4965598944) setup complete. Starting run loop.
2025-05-28 23:25:07,212 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-28 23:25:07,212 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-28 23:25:07,212 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-28 23:25:07,212 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-28 23:25:07,215 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-28 23:27:24,647 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 23:27:24,657 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 23:32:24,871 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 23:32:24,881 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 23:37:25,223 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 23:37:25,235 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 23:42:25,615 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 23:42:25,624 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 23:47:25,974 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 23:47:25,985 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 23:52:26,339 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 23:52:26,348 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-28 23:54:54,158 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-28 23:54:54,172 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-28 23:54:54,175 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-28 23:54:54,175 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-28 23:54:54,194 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-28 23:54:54,195 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-28 23:54:54,196 - INFO - app.db.crud.agent_crud - Updating agent config in DB for agent_id: agent_airsoft_0faa9616
2025-05-28 23:54:54,233 - INFO - app.db.crud.agent_crud - Agent config updated successfully for agent_id: agent_airsoft_0faa9616
2025-05-28 23:54:54,233 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616 was running. Attempting to restart it after config update.
2025-05-28 23:54:54,233 - INFO - app.services.process_manager - Restarting agent process for agent_airsoft_0faa9616...
2025-05-28 23:54:54,235 - INFO - app.services.process_manager - Stopping agent process agent_airsoft_0faa9616 (PID: 10263). Force: True
2025-05-28 23:54:54,235 - INFO - app.services.process_manager - SIGTERM sent to agent agent_airsoft_0faa9616 (PID: 10263)
2025-05-28 23:54:54,335 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 (PID: 10263) terminated gracefully after SIGTERM.
2025-05-28 23:54:54,337 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 marked as stopped in Redis.
2025-05-28 23:54:54,337 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 stopped (or stop attempted and assumed successful for restart). Pausing briefly...
2025-05-28 23:54:59,337 - INFO - app.services.process_manager - Proceeding to start agent agent_airsoft_0faa9616 after delay...
2025-05-28 23:54:59,340 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-28 23:54:59,343 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 11023
2025-05-28 23:54:59,343 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 11023
2025-05-28 23:54:59,344 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 successfully started as part of restart sequence.
2025-05-28 23:54:59,344 - INFO - app.api.routers.agent_api - Restart command issued for agent agent_airsoft_0faa9616 after config update.
2025-05-28 23:54:59,344 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-28 23:54:59,344 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-28 23:55:00,973 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-28 23:55:00,973 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-28 23:55:00,973 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-28 23:55:00,973 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-28 23:55:00,974 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 11023
2025-05-28 23:55:00,974 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-28 23:55:00,974 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-28 23:55:00,974 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-28 23:55:00,980 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-28 23:55:00,980 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-28 23:55:01,075 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-28 23:55:01,075 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-28 23:55:01,075 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-28 23:55:01,075 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-28 23:55:01,075 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-28 23:55:01,075 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-28 23:55:01,103 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-28 23:55:01,103 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-28 23:55:01,103 - INFO - app.agent_runner.common.tools_registry - Configured 3 predefined tools from centralized registry
2025-05-28 23:55:01,103 - INFO - AGENT:agent_airsoft_0faa9616 - Added 3 tools from centralized registry
2025-05-28 23:55:01,103 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 2 Knowledge Base tool(s)...
2025-05-28 23:55:01,179 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-28 23:55:01,184 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-28 23:55:02,183 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-28 23:55:02,187 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-28 23:55:02,187 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-28 23:55:02,187 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748455171610) for datasources: ['5', '6', '7']
2025-05-28 23:55:02,187 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-28 23:55:02,187 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1746879979658)
2025-05-28 23:55:02,187 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (4 safe, 2 datastore).
2025-05-28 23:55:02,187 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 4 safe, 2 datastore tools. Max rewrites: 3.
2025-05-28 23:55:02,187 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-28 23:55:02,188 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-28 23:55:02,188 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-28 23:55:02,189 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-28 23:55:02,189 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-28 23:55:02,189 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-28 23:55:02,189 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-28 23:55:02,189 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-28 23:55:02,199 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-28 23:55:02,199 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-28 23:55:02,199 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-28 23:55:02,199 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4689888320) setup complete. Starting run loop.
2025-05-28 23:55:02,199 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-28 23:55:02,199 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-28 23:55:02,199 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-28 23:55:02,199 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-28 23:55:02,203 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-28 23:55:28,801 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-28 23:55:28,807 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-28 23:55:28,808 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-28 23:55:28,808 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-28 23:55:28,814 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-28 23:55:28,815 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-28 23:55:28,815 - INFO - app.db.crud.agent_crud - Updating agent config in DB for agent_id: agent_airsoft_0faa9616
2025-05-28 23:55:28,826 - INFO - app.db.crud.agent_crud - Agent config updated successfully for agent_id: agent_airsoft_0faa9616
2025-05-28 23:55:28,826 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616 was running. Attempting to restart it after config update.
2025-05-28 23:55:28,826 - INFO - app.services.process_manager - Restarting agent process for agent_airsoft_0faa9616...
2025-05-28 23:55:28,828 - INFO - app.services.process_manager - Stopping agent process agent_airsoft_0faa9616 (PID: 11023). Force: True
2025-05-28 23:55:28,828 - INFO - app.services.process_manager - SIGTERM sent to agent agent_airsoft_0faa9616 (PID: 11023)
2025-05-28 23:55:28,928 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 (PID: 11023) terminated gracefully after SIGTERM.
2025-05-28 23:55:28,931 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 marked as stopped in Redis.
2025-05-28 23:55:28,931 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 stopped (or stop attempted and assumed successful for restart). Pausing briefly...
2025-05-28 23:55:33,933 - INFO - app.services.process_manager - Proceeding to start agent agent_airsoft_0faa9616 after delay...
2025-05-28 23:55:33,935 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-28 23:55:33,937 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 11061
2025-05-28 23:55:33,937 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 11061
2025-05-28 23:55:33,937 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 successfully started as part of restart sequence.
2025-05-28 23:55:33,937 - INFO - app.api.routers.agent_api - Restart command issued for agent agent_airsoft_0faa9616 after config update.
2025-05-28 23:55:33,937 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-28 23:55:33,938 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-28 23:55:35,328 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-28 23:55:35,329 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-28 23:55:35,329 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-28 23:55:35,329 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-28 23:55:35,329 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 11061
2025-05-28 23:55:35,329 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-28 23:55:35,329 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-28 23:55:35,329 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-28 23:55:35,336 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-28 23:55:35,336 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-28 23:55:35,413 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-28 23:55:35,413 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-28 23:55:35,413 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-28 23:55:35,413 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-28 23:55:35,413 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-28 23:55:35,413 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-28 23:55:35,439 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-28 23:55:35,439 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-28 23:55:35,439 - INFO - app.agent_runner.common.tools_registry - Configured 3 predefined tools from centralized registry
2025-05-28 23:55:35,439 - INFO - AGENT:agent_airsoft_0faa9616 - Added 3 tools from centralized registry
2025-05-28 23:55:35,439 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 2 Knowledge Base tool(s)...
2025-05-28 23:55:35,496 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-28 23:55:35,501 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-28 23:55:36,594 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-28 23:55:36,597 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-28 23:55:36,597 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-28 23:55:36,597 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748455171610) for datasources: ['5', '6', '7']
2025-05-28 23:55:36,597 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-28 23:55:36,597 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1746879979658)
2025-05-28 23:55:36,598 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (4 safe, 2 datastore).
2025-05-28 23:55:36,598 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 4 safe, 2 datastore tools. Max rewrites: 3.
2025-05-28 23:55:36,598 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-28 23:55:36,598 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-28 23:55:36,598 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-28 23:55:36,598 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-28 23:55:36,598 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-28 23:55:36,598 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-28 23:55:36,599 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-28 23:55:36,599 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-28 23:55:36,609 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-28 23:55:36,609 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-28 23:55:36,609 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-28 23:55:36,609 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 5008622944) setup complete. Starting run loop.
2025-05-28 23:55:36,609 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-28 23:55:36,609 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-28 23:55:36,609 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-28 23:55:36,609 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-28 23:55:36,613 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-28 23:57:26,560 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-28 23:57:26,571 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 00:02:26,762 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 00:02:26,773 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 00:04:58,722 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-29 00:04:58,730 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-29 00:04:58,731 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-29 00:04:58,731 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-29 00:04:58,740 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-29 00:04:58,741 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-29 00:04:58,741 - INFO - app.db.crud.agent_crud - Updating agent config in DB for agent_id: agent_airsoft_0faa9616
2025-05-29 00:04:58,757 - INFO - app.db.crud.agent_crud - Agent config updated successfully for agent_id: agent_airsoft_0faa9616
2025-05-29 00:04:58,757 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616 was running. Attempting to restart it after config update.
2025-05-29 00:04:58,757 - INFO - app.services.process_manager - Restarting agent process for agent_airsoft_0faa9616...
2025-05-29 00:04:58,758 - INFO - app.services.process_manager - Stopping agent process agent_airsoft_0faa9616 (PID: 11061). Force: True
2025-05-29 00:04:58,758 - INFO - app.services.process_manager - SIGTERM sent to agent agent_airsoft_0faa9616 (PID: 11061)
2025-05-29 00:04:58,858 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 (PID: 11061) terminated gracefully after SIGTERM.
2025-05-29 00:04:58,860 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 marked as stopped in Redis.
2025-05-29 00:04:58,860 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 stopped (or stop attempted and assumed successful for restart). Pausing briefly...
2025-05-29 00:05:03,861 - INFO - app.services.process_manager - Proceeding to start agent agent_airsoft_0faa9616 after delay...
2025-05-29 00:05:03,863 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-29 00:05:03,865 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 11614
2025-05-29 00:05:03,865 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 11614
2025-05-29 00:05:03,865 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 successfully started as part of restart sequence.
2025-05-29 00:05:03,866 - INFO - app.api.routers.agent_api - Restart command issued for agent agent_airsoft_0faa9616 after config update.
2025-05-29 00:05:03,866 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-29 00:05:03,866 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-29 00:05:05,285 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-29 00:05:05,285 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-29 00:05:05,285 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-29 00:05:05,285 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-29 00:05:05,285 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 11614
2025-05-29 00:05:05,285 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-29 00:05:05,285 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-29 00:05:05,285 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-29 00:05:05,291 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-29 00:05:05,291 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-29 00:05:05,368 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-29 00:05:05,368 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-29 00:05:05,368 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-29 00:05:05,368 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-29 00:05:05,368 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-29 00:05:05,368 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-29 00:05:05,394 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-29 00:05:05,394 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-29 00:05:05,394 - INFO - app.agent_runner.common.tools_registry - Configured 3 predefined tools from centralized registry
2025-05-29 00:05:05,394 - INFO - AGENT:agent_airsoft_0faa9616 - Added 3 tools from centralized registry
2025-05-29 00:05:05,394 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 2 Knowledge Base tool(s)...
2025-05-29 00:05:05,451 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-29 00:05:05,460 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-29 00:05:06,660 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-29 00:05:06,662 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-29 00:05:06,663 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-29 00:05:06,663 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748455171610) for datasources: ['5', '6', '7']
2025-05-29 00:05:06,663 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-29 00:05:06,663 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1746879979658)
2025-05-29 00:05:06,663 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (4 safe, 2 datastore).
2025-05-29 00:05:06,663 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 4 safe, 2 datastore tools. Max rewrites: 3.
2025-05-29 00:05:06,663 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-29 00:05:06,663 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-29 00:05:06,664 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-29 00:05:06,664 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-29 00:05:06,664 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-29 00:05:06,664 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-29 00:05:06,664 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-29 00:05:06,664 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-29 00:05:06,676 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-29 00:05:06,676 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-29 00:05:06,676 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-29 00:05:06,676 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4980327680) setup complete. Starting run loop.
2025-05-29 00:05:06,676 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-29 00:05:06,676 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-29 00:05:06,676 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-29 00:05:06,676 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-29 00:05:06,679 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-29 00:06:02,117 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-29 00:06:02,129 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-29 00:06:02,132 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-29 00:06:02,132 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-29 00:06:02,138 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-29 00:06:02,138 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-29 00:06:02,138 - INFO - app.db.crud.agent_crud - Updating agent config in DB for agent_id: agent_airsoft_0faa9616
2025-05-29 00:06:02,178 - INFO - app.db.crud.agent_crud - Agent config updated successfully for agent_id: agent_airsoft_0faa9616
2025-05-29 00:06:02,178 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616 was running. Attempting to restart it after config update.
2025-05-29 00:06:02,178 - INFO - app.services.process_manager - Restarting agent process for agent_airsoft_0faa9616...
2025-05-29 00:06:02,181 - INFO - app.services.process_manager - Stopping agent process agent_airsoft_0faa9616 (PID: 11614). Force: True
2025-05-29 00:06:02,182 - INFO - app.services.process_manager - SIGTERM sent to agent agent_airsoft_0faa9616 (PID: 11614)
2025-05-29 00:06:02,283 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 (PID: 11614) terminated gracefully after SIGTERM.
2025-05-29 00:06:02,285 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 marked as stopped in Redis.
2025-05-29 00:06:02,285 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 stopped (or stop attempted and assumed successful for restart). Pausing briefly...
2025-05-29 00:06:07,285 - INFO - app.services.process_manager - Proceeding to start agent agent_airsoft_0faa9616 after delay...
2025-05-29 00:06:07,289 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-29 00:06:07,293 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 11663
2025-05-29 00:06:07,294 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 11663
2025-05-29 00:06:07,295 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 successfully started as part of restart sequence.
2025-05-29 00:06:07,295 - INFO - app.api.routers.agent_api - Restart command issued for agent agent_airsoft_0faa9616 after config update.
2025-05-29 00:06:07,296 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-29 00:06:07,296 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-29 00:06:09,046 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-29 00:06:09,047 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-29 00:06:09,047 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-29 00:06:09,047 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-29 00:06:09,047 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 11663
2025-05-29 00:06:09,047 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-29 00:06:09,047 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-29 00:06:09,047 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-29 00:06:09,053 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-29 00:06:09,053 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-29 00:06:09,139 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-29 00:06:09,140 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-29 00:06:09,140 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-29 00:06:09,140 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-29 00:06:09,140 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-29 00:06:09,140 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-29 00:06:09,166 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-29 00:06:09,166 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-29 00:06:09,166 - INFO - app.agent_runner.common.tools_registry - Configured 3 predefined tools from centralized registry
2025-05-29 00:06:09,166 - INFO - AGENT:agent_airsoft_0faa9616 - Added 3 tools from centralized registry
2025-05-29 00:06:09,166 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 2 Knowledge Base tool(s)...
2025-05-29 00:06:09,222 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-29 00:06:09,237 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-29 00:06:10,274 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-29 00:06:10,276 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-29 00:06:10,276 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-29 00:06:10,276 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748455171610) for datasources: ['5', '6', '7']
2025-05-29 00:06:10,276 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-29 00:06:10,276 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 5 (3 safe, 2 datastore).
2025-05-29 00:06:10,276 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 5 total, 3 safe, 2 datastore tools. Max rewrites: 3.
2025-05-29 00:06:10,276 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-29 00:06:10,277 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-29 00:06:10,277 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-29 00:06:10,277 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-29 00:06:10,277 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-29 00:06:10,277 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-29 00:06:10,277 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-29 00:06:10,277 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-29 00:06:10,288 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-29 00:06:10,288 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-29 00:06:10,288 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-29 00:06:10,288 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4561945904) setup complete. Starting run loop.
2025-05-29 00:06:10,288 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-29 00:06:10,288 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-29 00:06:10,288 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-29 00:06:10,288 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-29 00:06:10,293 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-29 00:07:26,936 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 00:07:26,946 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 00:09:08,267 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-29 00:09:08,272 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-29 00:09:08,273 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-29 00:09:08,273 - INFO - app.db.crud.agent_crud - Updating agent config in DB for agent_id: agent_airsoft_0faa9616
2025-05-29 00:09:08,289 - INFO - app.db.crud.agent_crud - Agent config updated successfully for agent_id: agent_airsoft_0faa9616
2025-05-29 00:09:08,289 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616 was running. Attempting to restart it after config update.
2025-05-29 00:09:08,289 - INFO - app.services.process_manager - Restarting agent process for agent_airsoft_0faa9616...
2025-05-29 00:09:08,290 - INFO - app.services.process_manager - Stopping agent process agent_airsoft_0faa9616 (PID: 11663). Force: True
2025-05-29 00:09:08,290 - INFO - app.services.process_manager - SIGTERM sent to agent agent_airsoft_0faa9616 (PID: 11663)
2025-05-29 00:09:08,390 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 (PID: 11663) terminated gracefully after SIGTERM.
2025-05-29 00:09:08,392 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 marked as stopped in Redis.
2025-05-29 00:09:08,393 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 stopped (or stop attempted and assumed successful for restart). Pausing briefly...
2025-05-29 00:09:13,393 - INFO - app.services.process_manager - Proceeding to start agent agent_airsoft_0faa9616 after delay...
2025-05-29 00:09:13,396 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-29 00:09:13,397 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 11901
2025-05-29 00:09:13,397 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 11901
2025-05-29 00:09:13,398 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 successfully started as part of restart sequence.
2025-05-29 00:09:13,398 - INFO - app.api.routers.agent_api - Restart command issued for agent agent_airsoft_0faa9616 after config update.
2025-05-29 00:09:13,398 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-29 00:09:13,398 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-29 00:09:14,786 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-29 00:09:14,787 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-29 00:09:14,787 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-29 00:09:14,787 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-29 00:09:14,787 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 11901
2025-05-29 00:09:14,787 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-29 00:09:14,787 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-29 00:09:14,787 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-29 00:09:14,793 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-29 00:09:14,793 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-29 00:09:14,879 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-29 00:09:14,879 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-29 00:09:14,879 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-29 00:09:14,879 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-29 00:09:14,879 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-29 00:09:14,879 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-29 00:09:14,905 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-29 00:09:14,906 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-29 00:09:14,906 - INFO - app.agent_runner.common.tools_registry - Configured 3 predefined tools from centralized registry
2025-05-29 00:09:14,906 - INFO - AGENT:agent_airsoft_0faa9616 - Added 3 tools from centralized registry
2025-05-29 00:09:14,906 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-29 00:09:14,967 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-29 00:09:14,975 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-29 00:09:16,070 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-29 00:09:16,072 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-29 00:09:16,073 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-29 00:09:16,073 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-29 00:09:16,073 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-29 00:09:16,073 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 5 (4 safe, 1 datastore).
2025-05-29 00:09:16,073 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 5 total, 4 safe, 1 datastore tools. Max rewrites: 3.
2025-05-29 00:09:16,073 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-29 00:09:16,074 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-29 00:09:16,074 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-29 00:09:16,074 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-29 00:09:16,074 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-29 00:09:16,074 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-29 00:09:16,074 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-29 00:09:16,074 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-29 00:09:16,085 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-29 00:09:16,085 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-29 00:09:16,085 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-29 00:09:16,085 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 5217338864) setup complete. Starting run loop.
2025-05-29 00:09:16,085 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-29 00:09:16,085 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-29 00:09:16,085 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-29 00:09:16,086 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-29 00:09:16,089 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-29 00:11:07,271 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-29 00:11:07,279 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-29 00:11:07,280 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-29 00:11:07,280 - INFO - app.db.crud.agent_crud - Updating agent config in DB for agent_id: agent_airsoft_0faa9616
2025-05-29 00:11:07,301 - INFO - app.db.crud.agent_crud - Agent config updated successfully for agent_id: agent_airsoft_0faa9616
2025-05-29 00:11:07,302 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616 was running. Attempting to restart it after config update.
2025-05-29 00:11:07,302 - INFO - app.services.process_manager - Restarting agent process for agent_airsoft_0faa9616...
2025-05-29 00:11:07,304 - INFO - app.services.process_manager - Stopping agent process agent_airsoft_0faa9616 (PID: 11901). Force: True
2025-05-29 00:11:07,304 - INFO - app.services.process_manager - SIGTERM sent to agent agent_airsoft_0faa9616 (PID: 11901)
2025-05-29 00:11:07,404 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 (PID: 11901) terminated gracefully after SIGTERM.
2025-05-29 00:11:07,407 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 marked as stopped in Redis.
2025-05-29 00:11:07,407 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 stopped (or stop attempted and assumed successful for restart). Pausing briefly...
2025-05-29 00:11:12,406 - INFO - app.services.process_manager - Proceeding to start agent agent_airsoft_0faa9616 after delay...
2025-05-29 00:11:12,410 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-29 00:11:12,412 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 11985
2025-05-29 00:11:12,412 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 11985
2025-05-29 00:11:12,413 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 successfully started as part of restart sequence.
2025-05-29 00:11:12,413 - INFO - app.api.routers.agent_api - Restart command issued for agent agent_airsoft_0faa9616 after config update.
2025-05-29 00:11:12,413 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-29 00:11:12,413 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-29 00:11:13,926 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-29 00:11:13,926 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-29 00:11:13,926 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-29 00:11:13,926 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-29 00:11:13,926 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 11985
2025-05-29 00:11:13,926 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-29 00:11:13,927 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-29 00:11:13,927 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-29 00:11:13,932 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-29 00:11:13,932 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-29 00:11:14,016 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-29 00:11:14,016 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-29 00:11:14,016 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-29 00:11:14,016 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-29 00:11:14,017 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-29 00:11:14,017 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-29 00:11:14,043 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-29 00:11:14,043 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-29 00:11:14,043 - INFO - app.agent_runner.common.tools_registry - Configured 3 predefined tools from centralized registry
2025-05-29 00:11:14,043 - INFO - AGENT:agent_airsoft_0faa9616 - Added 3 tools from centralized registry
2025-05-29 00:11:14,043 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-29 00:11:14,097 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-29 00:11:14,102 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-29 00:11:14,957 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-29 00:11:14,960 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-29 00:11:14,960 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-29 00:11:14,960 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-29 00:11:14,960 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-29 00:11:14,960 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 5 (4 safe, 1 datastore).
2025-05-29 00:11:14,960 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 5 total, 4 safe, 1 datastore tools. Max rewrites: 3.
2025-05-29 00:11:14,960 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-29 00:11:14,961 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-29 00:11:14,961 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-29 00:11:14,961 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-29 00:11:14,961 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-29 00:11:14,961 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-29 00:11:14,961 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-29 00:11:14,962 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-29 00:11:14,973 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-29 00:11:14,973 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-29 00:11:14,973 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-29 00:11:14,973 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4652139680) setup complete. Starting run loop.
2025-05-29 00:11:14,973 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-29 00:11:14,973 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-29 00:11:14,973 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-29 00:11:14,973 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-29 00:11:14,977 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-29 00:12:27,148 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 00:12:27,158 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 00:17:27,356 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 00:17:27,365 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 00:22:27,581 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 00:22:27,591 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 00:27:27,785 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 00:27:27,795 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 00:32:27,992 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 00:32:28,000 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 00:37:28,170 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 00:37:28,181 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 00:42:28,378 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 00:42:28,389 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 00:47:28,579 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 00:47:28,590 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 00:52:28,815 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 00:52:28,825 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 00:57:29,012 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 00:57:29,023 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 01:02:29,217 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 01:02:29,226 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 01:07:29,440 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 01:07:29,452 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 01:12:29,640 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 01:12:29,650 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 01:17:29,840 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 01:17:29,852 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 01:18:18,341 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-29 01:18:18,348 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-29 01:18:18,350 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-29 01:18:18,350 - INFO - app.db.crud.agent_crud - Updating agent config in DB for agent_id: agent_airsoft_0faa9616
2025-05-29 01:18:18,370 - INFO - app.db.crud.agent_crud - Agent config updated successfully for agent_id: agent_airsoft_0faa9616
2025-05-29 01:18:18,370 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616 was running. Attempting to restart it after config update.
2025-05-29 01:18:18,370 - INFO - app.services.process_manager - Restarting agent process for agent_airsoft_0faa9616...
2025-05-29 01:18:18,372 - INFO - app.services.process_manager - Stopping agent process agent_airsoft_0faa9616 (PID: 11985). Force: True
2025-05-29 01:18:18,372 - INFO - app.services.process_manager - SIGTERM sent to agent agent_airsoft_0faa9616 (PID: 11985)
2025-05-29 01:18:18,474 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 (PID: 11985) terminated gracefully after SIGTERM.
2025-05-29 01:18:18,478 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 marked as stopped in Redis.
2025-05-29 01:18:18,478 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 stopped (or stop attempted and assumed successful for restart). Pausing briefly...
2025-05-29 01:18:23,478 - INFO - app.services.process_manager - Proceeding to start agent agent_airsoft_0faa9616 after delay...
2025-05-29 01:18:23,482 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-29 01:18:23,485 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 14512
2025-05-29 01:18:23,485 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 14512
2025-05-29 01:18:23,486 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 successfully started as part of restart sequence.
2025-05-29 01:18:23,486 - INFO - app.api.routers.agent_api - Restart command issued for agent agent_airsoft_0faa9616 after config update.
2025-05-29 01:18:23,486 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-29 01:18:23,486 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-29 01:18:25,143 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-29 01:18:25,143 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-29 01:18:25,143 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-29 01:18:25,143 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-29 01:18:25,143 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 14512
2025-05-29 01:18:25,143 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-29 01:18:25,143 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-29 01:18:25,143 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-29 01:18:25,149 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-29 01:18:25,149 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-29 01:18:25,229 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-29 01:18:25,229 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-29 01:18:25,229 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-29 01:18:25,229 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-29 01:18:25,229 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-29 01:18:25,229 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-29 01:18:25,255 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-29 01:18:25,255 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-29 01:18:25,255 - INFO - app.agent_runner.common.tools_registry - Configured 3 predefined tools from centralized registry
2025-05-29 01:18:25,255 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000000
2025-05-29 01:18:25,255 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001
2025-05-29 01:18:25,255 - INFO - AGENT:agent_airsoft_0faa9616 - Added 3 tools from centralized registry
2025-05-29 01:18:25,255 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-29 01:18:25,310 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-29 01:18:25,315 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-29 01:18:26,467 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-29 01:18:26,469 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-29 01:18:26,470 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-29 01:18:26,470 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-29 01:18:26,470 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-29 01:18:26,470 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-29 01:18:26,470 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 5 (4 safe, 1 datastore).
2025-05-29 01:18:26,470 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 5 total, 4 safe, 1 datastore tools. Max rewrites: 3.
2025-05-29 01:18:26,470 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-29 01:18:26,470 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-29 01:18:26,471 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-29 01:18:26,471 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-29 01:18:26,471 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-29 01:18:26,471 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-29 01:18:26,471 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-29 01:18:26,471 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-29 01:18:26,481 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-29 01:18:26,481 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-29 01:18:26,481 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-29 01:18:26,482 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4695115584) setup complete. Starting run loop.
2025-05-29 01:18:26,482 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-29 01:18:26,482 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-29 01:18:26,482 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-29 01:18:26,482 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-29 01:18:26,485 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-29 01:22:30,046 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 01:22:30,056 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 01:24:07,115 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-29 01:24:07,123 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-29 01:24:07,124 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-29 01:24:07,124 - INFO - app.db.crud.agent_crud - Updating agent config in DB for agent_id: agent_airsoft_0faa9616
2025-05-29 01:24:07,139 - INFO - app.db.crud.agent_crud - Agent config updated successfully for agent_id: agent_airsoft_0faa9616
2025-05-29 01:24:07,139 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616 was running. Attempting to restart it after config update.
2025-05-29 01:24:07,139 - INFO - app.services.process_manager - Restarting agent process for agent_airsoft_0faa9616...
2025-05-29 01:24:07,143 - INFO - app.services.process_manager - Stopping agent process agent_airsoft_0faa9616 (PID: 14512). Force: True
2025-05-29 01:24:07,143 - INFO - app.services.process_manager - SIGTERM sent to agent agent_airsoft_0faa9616 (PID: 14512)
2025-05-29 01:24:07,244 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 (PID: 14512) terminated gracefully after SIGTERM.
2025-05-29 01:24:07,246 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 marked as stopped in Redis.
2025-05-29 01:24:07,246 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 stopped (or stop attempted and assumed successful for restart). Pausing briefly...
2025-05-29 01:24:12,247 - INFO - app.services.process_manager - Proceeding to start agent agent_airsoft_0faa9616 after delay...
2025-05-29 01:24:12,250 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-29 01:24:12,251 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 14725
2025-05-29 01:24:12,251 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 14725
2025-05-29 01:24:12,252 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 successfully started as part of restart sequence.
2025-05-29 01:24:12,252 - INFO - app.api.routers.agent_api - Restart command issued for agent agent_airsoft_0faa9616 after config update.
2025-05-29 01:24:12,252 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-29 01:24:12,252 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-29 01:24:13,681 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-29 01:24:13,681 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-29 01:24:13,681 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-29 01:24:13,681 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-29 01:24:13,681 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 14725
2025-05-29 01:24:13,681 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-29 01:24:13,681 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-29 01:24:13,681 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-29 01:24:13,686 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-29 01:24:13,686 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-29 01:24:13,772 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-29 01:24:13,772 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-29 01:24:13,772 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-29 01:24:13,772 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-29 01:24:13,772 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-29 01:24:13,772 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-29 01:24:13,804 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-29 01:24:13,804 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-29 01:24:13,804 - INFO - app.agent_runner.common.tools_registry - Configured 3 predefined tools from centralized registry
2025-05-29 01:24:13,804 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000000
2025-05-29 01:24:13,804 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001
2025-05-29 01:24:13,804 - INFO - AGENT:agent_airsoft_0faa9616 - Added 3 tools from centralized registry
2025-05-29 01:24:13,804 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-29 01:24:13,863 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-29 01:24:13,870 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-29 01:24:15,500 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-29 01:24:15,504 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-29 01:24:15,504 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-29 01:24:15,504 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-29 01:24:15,504 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-29 01:24:15,504 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-29 01:24:15,504 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 5 (4 safe, 1 datastore).
2025-05-29 01:24:15,504 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 5 total, 4 safe, 1 datastore tools. Max rewrites: 3.
2025-05-29 01:24:15,504 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-29 01:24:15,505 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-29 01:24:15,505 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-29 01:24:15,505 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-29 01:24:15,505 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-29 01:24:15,505 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-29 01:24:15,506 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-29 01:24:15,506 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-29 01:24:15,517 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-29 01:24:15,517 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-29 01:24:15,517 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-29 01:24:15,517 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4830397552) setup complete. Starting run loop.
2025-05-29 01:24:15,517 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-29 01:24:15,517 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-29 01:24:15,517 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-29 01:24:15,517 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-29 01:24:15,519 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-29 01:24:54,859 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Получи запись блога...'
2025-05-29 01:24:54,870 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache miss for user 144641834, agent agent_airsoft_0faa9616. Checking DB.
2025-05-29 01:24:55,124 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - User 144641834 (DBID: 1) IS authorized for agent agent_airsoft_0faa9616 via DB.
2025-05-29 01:24:55,127 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-29 01:24:55,127 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-29 01:24:55,127 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-29 01:24:55,128 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: e92f8ad4-0bb3-44a7-bfbb-aba354d74ac0)
2025-05-29 01:24:55,128 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-29 01:24:55,129 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-29 01:24:55,168 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: e92f8ad4-0bb3-44a7-bfbb-aba354d74ac0, db_id: 911
2025-05-29 01:24:55,172 - INFO - AGENT:agent_airsoft_0faa9616 - Loaded 20 messages from DB for thread '144641834'.
2025-05-29 01:24:55,172 - INFO - AGENT:agent_airsoft_0faa9616 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-29 01:24:55,172 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-29 01:24:55,235 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-29 01:24:55,235 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-29 01:24:55,261 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-29 01:24:55,265 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 5 tools.
2025-05-29 01:24:56,129 - INFO - aiogram.event - Update id=804756300 is handled. Duration 1292 ms by bot id=1750613938
2025-05-29 01:24:56,539 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-29 01:24:56,674 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-29 01:24:56,674 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-29 01:24:56,674 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1563, 'output_tokens': 24, 'total_tokens': 1587, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-29 01:24:56,675 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1563 C:24 T:1587
2025-05-29 01:24:56,675 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1587 tokens recorded.
2025-05-29 01:24:56,675 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-29 01:24:56,675 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: webSearch-1748459212676
2025-05-29 01:24:56,676 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (webSearch-1748459212676)---
2025-05-29 01:24:59,392 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-29 01:24:59,392 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-29 01:24:59,417 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-29 01:24:59,420 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 5 tools.
2025-05-29 01:25:00,501 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-29 01:25:02,613 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Похоже, что по запросу "запись блога" нашлись статьи, связанные со страйкболом, например:

- "CO2 ил
2025-05-29 01:25:02,614 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-29 01:25:02,614 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1794, 'output_tokens': 114, 'total_tokens': 1908, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-29 01:25:02,614 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1794 C:114 T:1908
2025-05-29 01:25:02,614 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1908 tokens recorded.
2025-05-29 01:25:02,615 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-29 01:25:02,615 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-29 01:25:02,616 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Похоже, что по запросу "запись блога" нашлись статьи, связанные со страйкболом, например:

- "CO2 ил...
2025-05-29 01:25:02,618 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: e92f8ad4-0bb3-44a7-bfbb-aba354d74ac0)
2025-05-29 01:25:02,619 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: e92f8ad4-0bb3-44a7-bfbb-aba354d74ac0.
2025-05-29 01:25:02,621 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Похоже, что по запросу "запись блога" нашлись статьи, связанные со страйкболом, например:

- "CO2 ил...
2025-05-29 01:25:02,621 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Похоже, что по запросу "запись блога" нашлись стат...'
2025-05-29 01:25:02,622 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'e92f8ad4-0bb3-44a7-bfbb-aba354d74ac0', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1563, 'completion_tokens': 24, 'total_tokens': 1587, 'timestamp': '2025-05-28T20:24:56.675034+00:00'}
2025-05-29 01:25:02,622 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: e92f8ad4-0bb3-44a7-bfbb-aba354d74ac0
2025-05-29 01:25:02,628 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: e92f8ad4-0bb3-44a7-bfbb-aba354d74ac0, db_id: 912
2025-05-29 01:25:02,667 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 912 for interaction_id: e92f8ad4-0bb3-44a7-bfbb-aba354d74ac0 on attempt 1
2025-05-29 01:25:02,675 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: e92f8ad4-0bb3-44a7-bfbb-aba354d74ac0, db_id: 371
2025-05-29 01:25:02,679 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'e92f8ad4-0bb3-44a7-bfbb-aba354d74ac0', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1794, 'completion_tokens': 114, 'total_tokens': 1908, 'timestamp': '2025-05-28T20:25:02.614517+00:00'}
2025-05-29 01:25:02,679 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: e92f8ad4-0bb3-44a7-bfbb-aba354d74ac0
2025-05-29 01:25:02,680 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 912 for interaction_id: e92f8ad4-0bb3-44a7-bfbb-aba354d74ac0 on attempt 1
2025-05-29 01:25:02,685 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: e92f8ad4-0bb3-44a7-bfbb-aba354d74ac0, db_id: 372
2025-05-29 01:25:33,307 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-29 01:25:33,307 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4830397552) received shutdown request. Initiating graceful shutdown...
2025-05-29 01:25:33,308 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4830397552)...
2025-05-29 01:25:33,308 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-29 01:25:33,308 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-29 01:25:33,308 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-29 01:25:33,308 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4830397552) was cancelled.
2025-05-29 01:25:33,308 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4830397552) stopping. Performing cleanup...
2025-05-29 01:25:33,308 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-29 01:25:33,308 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-29 01:25:33,308 - INFO - aiogram.dispatcher - Polling stopped
2025-05-29 01:25:33,309 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-29 01:25:33,309 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-29 01:25:33,309 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-29 01:25:33,309 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-29 01:25:33,309 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-29 01:25:33,309 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-29 01:25:33,309 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-29 01:25:33,309 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-29 01:25:33,315 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-29 01:25:33,316 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-29 01:25:33,316 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-29 01:25:33,317 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-29 01:25:33,317 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-29 01:25:33,317 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-29 01:25:33,317 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4830397552) cleanup complete.
2025-05-29 01:25:33,317 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-29 01:25:33,317 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-29 01:25:33,320 - INFO - app.db.session - Database engine closed successfully.
2025-05-29 01:25:33,320 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-29 01:25:33,320 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-29 01:25:33,321 - INFO - __main__ - Agent runner main finished.
2025-05-29 01:25:33,421 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-29 01:25:33,421 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-29 01:25:33,421 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-29 01:25:33,422 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4449549200) was cancelled.
2025-05-29 01:25:33,422 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4449549200) stopping. Performing cleanup...
2025-05-29 01:25:33,422 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-29 01:25:33,428 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-29 01:25:33,428 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-29 01:25:33,428 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-29 01:25:33,429 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-29 01:25:33,429 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-29 01:25:33,429 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4449549200) cleanup complete.
2025-05-29 01:25:33,429 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-29 01:25:33,429 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-29 01:25:33,429 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4449548864) was cancelled.
2025-05-29 01:25:33,429 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4449548864) stopping. Performing cleanup...
2025-05-29 01:25:33,429 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-29 01:25:33,432 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-29 01:25:33,433 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-29 01:25:33,433 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-29 01:25:33,433 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-29 01:25:33,433 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-29 01:25:33,433 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4449548864) cleanup complete.
2025-05-29 01:25:33,433 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-29 01:25:33,433 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-29 01:25:33,433 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4437695552) was cancelled.
2025-05-29 01:25:33,433 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4437695552) stopping. Performing cleanup...
2025-05-29 01:25:33,433 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-29 01:25:33,433 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-29 01:25:33,434 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-29 01:25:33,434 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-29 01:25:33,434 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-29 01:25:33,437 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-29 01:25:33,437 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-29 01:25:33,438 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-29 01:25:33,438 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-29 01:25:33,438 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-29 01:25:33,438 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-29 01:25:33,438 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4437695552) cleanup complete.
2025-05-29 01:25:33,438 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-29 01:25:33,438 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-29 01:25:33,438 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-29 01:25:33,448 - INFO - app.db.session - Database engine closed successfully.
2025-05-29 01:25:33,448 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-29 01:25:33,560 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-29 01:25:33,560 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-29 01:25:33,560 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-29 01:25:33,560 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4403322208) received shutdown request. Initiating graceful shutdown...
2025-05-29 01:25:33,560 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4403322208)...
2025-05-29 01:25:33,560 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-29 01:25:33,560 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-29 01:25:33,560 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4403322208) was cancelled.
2025-05-29 01:25:33,560 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4403322208) stopping. Performing cleanup...
2025-05-29 01:25:33,560 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-29 01:25:33,560 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-29 01:25:33,560 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-29 01:25:33,560 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-29 01:25:33,560 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-29 01:25:33,560 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-29 01:25:33,560 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-29 01:25:33,561 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-29 01:25:33,561 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-29 01:25:33,561 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-29 01:25:33,565 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-29 01:25:33,566 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-29 01:25:33,566 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-29 01:25:33,567 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-29 01:25:33,567 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-29 01:25:33,567 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-29 01:25:33,567 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4403322208) cleanup complete.
2025-05-29 01:25:33,567 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-29 01:25:33,567 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-29 01:25:33,570 - INFO - app.db.session - Database engine closed successfully.
2025-05-29 01:25:33,570 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-29 01:25:33,570 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-29 01:25:33,571 - INFO - __main__ - Telegram bot runner main finished.
2025-05-29 01:25:38,691 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-29 01:25:38,691 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-29 01:25:38,696 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-29 01:25:38,696 - INFO - app.core.lifespan - Starting background tasks...
2025-05-29 01:25:38,696 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-29 01:25:38,696 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-29 01:25:38,696 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-29 01:25:38,696 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-29 01:25:38,696 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-29 01:25:38,696 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-29 01:25:38,696 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-29 01:25:38,696 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-29 01:25:38,697 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-29 01:25:38,700 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-29 01:25:38,701 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-29 01:25:38,701 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-29 01:25:38,701 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-29 01:25:38,701 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-29 01:25:38,701 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-29 01:25:38,701 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-29 01:25:38,705 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-29 01:25:38,705 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4417345088) setup complete. Starting run loop.
2025-05-29 01:25:38,705 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-29 01:25:38,705 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-29 01:25:38,706 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-29 01:25:38,706 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4417354016) setup complete. Starting run loop.
2025-05-29 01:25:38,706 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-29 01:25:38,706 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-29 01:25:38,706 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-29 01:25:38,748 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-29 01:25:38,748 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-29 01:25:38,751 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-29 01:25:38,752 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 14849
2025-05-29 01:25:38,752 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 14849
2025-05-29 01:25:38,753 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-29 01:25:38,753 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-29 01:25:38,753 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-29 01:25:38,755 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-29 01:25:38,755 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 14850
2025-05-29 01:25:38,755 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 14850
2025-05-29 01:25:38,756 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-29 01:25:38,757 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-29 01:25:38,757 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-29 01:25:38,757 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-29 01:25:38,757 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-29 01:25:39,644 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-29 01:25:39,645 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-29 01:25:39,645 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-29 01:25:39,645 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-29 01:25:39,645 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 14850
2025-05-29 01:25:39,645 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-29 01:25:39,645 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-29 01:25:39,645 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-29 01:25:39,650 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-29 01:25:39,663 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-29 01:25:39,663 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-29 01:25:39,663 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-29 01:25:39,663 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 5125184192) setup complete. Starting run loop.
2025-05-29 01:25:39,663 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-29 01:25:39,663 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-29 01:25:39,663 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-29 01:25:39,663 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-29 01:25:39,664 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-29 01:25:39,664 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-29 01:25:39,664 - INFO - aiogram.dispatcher - Start polling
2025-05-29 01:25:39,666 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-29 01:25:39,920 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-29 01:25:39,933 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-29 01:25:39,933 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-29 01:25:39,933 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-29 01:25:39,933 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-29 01:25:39,933 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 14849
2025-05-29 01:25:39,933 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-29 01:25:39,933 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-29 01:25:39,933 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-29 01:25:39,939 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-29 01:25:39,939 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-29 01:25:40,018 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-29 01:25:40,018 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-29 01:25:40,018 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-29 01:25:40,018 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-29 01:25:40,018 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-29 01:25:40,018 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-29 01:25:40,044 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-29 01:25:40,044 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-29 01:25:40,044 - INFO - app.agent_runner.common.tools_registry - Configured 3 predefined tools from centralized registry
2025-05-29 01:25:40,044 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000000
2025-05-29 01:25:40,044 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001
2025-05-29 01:25:40,044 - INFO - AGENT:agent_airsoft_0faa9616 - Added 3 tools from centralized registry
2025-05-29 01:25:40,044 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-29 01:25:40,099 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-29 01:25:40,106 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-29 01:25:41,172 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-29 01:25:41,174 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-29 01:25:41,175 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-29 01:25:41,175 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-29 01:25:41,175 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-29 01:25:41,175 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-29 01:25:41,175 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 5 (4 safe, 1 datastore).
2025-05-29 01:25:41,175 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 5 total, 4 safe, 1 datastore tools. Max rewrites: 3.
2025-05-29 01:25:41,175 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-29 01:25:41,176 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-29 01:25:41,176 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-29 01:25:41,176 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-29 01:25:41,176 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-29 01:25:41,176 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-29 01:25:41,176 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-29 01:25:41,176 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-29 01:25:41,187 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-29 01:25:41,188 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-29 01:25:41,188 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-29 01:25:41,188 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4437428032) setup complete. Starting run loop.
2025-05-29 01:25:41,188 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-29 01:25:41,188 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-29 01:25:41,188 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-29 01:25:41,188 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-29 01:25:41,191 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-29 01:25:48,707 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-29 01:25:48,712 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-29 01:25:48,712 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4417457328) setup complete. Starting run loop.
2025-05-29 01:25:48,712 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-29 01:26:25,206 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'получи запись блога из JSONPlaceholder...'
2025-05-29 01:26:25,209 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-29 01:26:25,360 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-29 01:26:25,360 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-29 01:26:25,360 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-29 01:26:25,362 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 4f62b494-001d-49c5-b547-fbe1f0e8bd69)
2025-05-29 01:26:25,362 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-29 01:26:25,363 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-29 01:26:25,409 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 4f62b494-001d-49c5-b547-fbe1f0e8bd69, db_id: 913
2025-05-29 01:26:25,427 - INFO - AGENT:agent_airsoft_0faa9616 - Loaded 20 messages from DB for thread '144641834'.
2025-05-29 01:26:25,428 - INFO - AGENT:agent_airsoft_0faa9616 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-29 01:26:25,428 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-29 01:26:25,495 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-29 01:26:25,495 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-29 01:26:25,524 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-29 01:26:25,534 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 5 tools.
2025-05-29 01:26:26,360 - INFO - aiogram.event - Update id=804756301 is handled. Duration 1155 ms by bot id=1750613938
2025-05-29 01:26:26,468 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-29 01:26:26,599 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-29 01:26:26,599 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-29 01:26:26,599 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1592, 'output_tokens': 23, 'total_tokens': 1615, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-29 01:26:26,599 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1592 C:23 T:1615
2025-05-29 01:26:26,599 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1615 tokens recorded.
2025-05-29 01:26:26,600 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-29 01:26:26,600 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: webSearch-1748459212676
2025-05-29 01:26:26,600 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (webSearch-1748459212676)---
2025-05-29 01:26:38,872 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-29 01:26:38,873 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-29 01:26:38,898 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-29 01:26:38,900 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 5 tools.
2025-05-29 01:26:39,819 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-29 01:26:42,182 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: JSONPlaceholder — это сервис для тестирования и прототипирования, который предоставляет фейковые дан
2025-05-29 01:26:42,183 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-29 01:26:42,183 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1629, 'output_tokens': 159, 'total_tokens': 1788, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-29 01:26:42,183 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1629 C:159 T:1788
2025-05-29 01:26:42,183 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1788 tokens recorded.
2025-05-29 01:26:42,184 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-29 01:26:42,184 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-29 01:26:42,185 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: JSONPlaceholder — это сервис для тестирования и прототипирования, который предоставляет фейковые дан...
2025-05-29 01:26:42,187 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 4f62b494-001d-49c5-b547-fbe1f0e8bd69)
2025-05-29 01:26:42,187 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: 4f62b494-001d-49c5-b547-fbe1f0e8bd69.
2025-05-29 01:26:42,189 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: JSONPlaceholder — это сервис для тестирования и прототипирования, который предоставляет фейковые дан...
2025-05-29 01:26:42,189 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'JSONPlaceholder — это сервис для тестирования и пр...'
2025-05-29 01:26:42,190 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '4f62b494-001d-49c5-b547-fbe1f0e8bd69', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1592, 'completion_tokens': 23, 'total_tokens': 1615, 'timestamp': '2025-05-28T20:26:26.599811+00:00'}
2025-05-29 01:26:42,190 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 4f62b494-001d-49c5-b547-fbe1f0e8bd69
2025-05-29 01:26:42,198 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 4f62b494-001d-49c5-b547-fbe1f0e8bd69, db_id: 914
2025-05-29 01:26:42,227 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 914 for interaction_id: 4f62b494-001d-49c5-b547-fbe1f0e8bd69 on attempt 1
2025-05-29 01:26:42,232 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 4f62b494-001d-49c5-b547-fbe1f0e8bd69, db_id: 373
2025-05-29 01:26:42,235 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '4f62b494-001d-49c5-b547-fbe1f0e8bd69', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1629, 'completion_tokens': 159, 'total_tokens': 1788, 'timestamp': '2025-05-28T20:26:42.183125+00:00'}
2025-05-29 01:26:42,235 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 4f62b494-001d-49c5-b547-fbe1f0e8bd69
2025-05-29 01:26:42,236 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 914 for interaction_id: 4f62b494-001d-49c5-b547-fbe1f0e8bd69 on attempt 1
2025-05-29 01:26:42,240 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 4f62b494-001d-49c5-b547-fbe1f0e8bd69, db_id: 374
2025-05-29 01:28:08,639 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'получи информацию о погоде для теста...'
2025-05-29 01:28:08,641 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-29 01:28:08,666 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-29 01:28:08,668 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-29 01:28:08,670 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-29 01:28:08,673 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: e3d3ca0d-5080-4db9-80c7-59e14673cc42)
2025-05-29 01:28:08,673 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-29 01:28:08,675 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-29 01:28:08,676 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-29 01:28:08,702 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-29 01:28:08,703 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-29 01:28:08,714 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: e3d3ca0d-5080-4db9-80c7-59e14673cc42, db_id: 915
2025-05-29 01:28:08,738 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-29 01:28:08,743 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 5 tools.
2025-05-29 01:28:09,669 - INFO - aiogram.event - Update id=804756302 is handled. Duration 1029 ms by bot id=1750613938
2025-05-29 01:28:09,844 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-29 01:28:09,981 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-29 01:28:09,981 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-29 01:28:09,981 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1804, 'output_tokens': 25, 'total_tokens': 1829, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-29 01:28:09,981 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1804 C:25 T:1829
2025-05-29 01:28:09,981 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1829 tokens recorded.
2025-05-29 01:28:09,982 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-29 01:28:09,982 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: webSearch-1748459212676
2025-05-29 01:28:09,982 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (webSearch-1748459212676)---
2025-05-29 01:28:12,519 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-29 01:28:12,520 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-29 01:28:12,545 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-29 01:28:12,547 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 5 tools.
2025-05-29 01:28:13,569 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-29 01:28:14,199 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Погоды для теста конкретной информации не нашлось, но если хочешь, могу получить актуальные данные о
2025-05-29 01:28:14,199 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_71b9d4b387'}
2025-05-29 01:28:14,199 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 2155, 'output_tokens': 52, 'total_tokens': 2207, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-29 01:28:14,199 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:2155 C:52 T:2207
2025-05-29 01:28:14,200 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 2207 tokens recorded.
2025-05-29 01:28:14,200 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-29 01:28:14,200 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-29 01:28:14,202 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Погоды для теста конкретной информации не нашлось, но если хочешь, могу получить актуальные данные о...
2025-05-29 01:28:14,205 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: e3d3ca0d-5080-4db9-80c7-59e14673cc42)
2025-05-29 01:28:14,206 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: e3d3ca0d-5080-4db9-80c7-59e14673cc42.
2025-05-29 01:28:14,208 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Погоды для теста конкретной информации не нашлось, но если хочешь, могу получить актуальные данные о...
2025-05-29 01:28:14,208 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Погоды для теста конкретной информации не нашлось,...'
2025-05-29 01:28:14,210 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'e3d3ca0d-5080-4db9-80c7-59e14673cc42', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1804, 'completion_tokens': 25, 'total_tokens': 1829, 'timestamp': '2025-05-28T20:28:09.981820+00:00'}
2025-05-29 01:28:14,210 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: e3d3ca0d-5080-4db9-80c7-59e14673cc42
2025-05-29 01:28:14,214 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 916 for interaction_id: e3d3ca0d-5080-4db9-80c7-59e14673cc42 on attempt 1
2025-05-29 01:28:14,214 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: e3d3ca0d-5080-4db9-80c7-59e14673cc42, db_id: 916
2025-05-29 01:28:14,220 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: e3d3ca0d-5080-4db9-80c7-59e14673cc42, db_id: 375
2025-05-29 01:28:14,223 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'e3d3ca0d-5080-4db9-80c7-59e14673cc42', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 2155, 'completion_tokens': 52, 'total_tokens': 2207, 'timestamp': '2025-05-28T20:28:14.200016+00:00'}
2025-05-29 01:28:14,223 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: e3d3ca0d-5080-4db9-80c7-59e14673cc42
2025-05-29 01:28:14,224 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 916 for interaction_id: e3d3ca0d-5080-4db9-80c7-59e14673cc42 on attempt 1
2025-05-29 01:28:14,227 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: e3d3ca0d-5080-4db9-80c7-59e14673cc42, db_id: 376
2025-05-29 01:29:29,367 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-29 01:29:29,367 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-29 01:29:29,368 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4437428032) received shutdown request. Initiating graceful shutdown...
2025-05-29 01:29:29,368 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4437428032)...
2025-05-29 01:29:29,368 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-29 01:29:29,368 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-29 01:29:29,368 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4437428032) was cancelled.
2025-05-29 01:29:29,368 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4437428032) stopping. Performing cleanup...
2025-05-29 01:29:29,369 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-29 01:29:29,369 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-29 01:29:29,369 - INFO - aiogram.dispatcher - Polling stopped
2025-05-29 01:29:29,370 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-29 01:29:29,370 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-29 01:29:29,370 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-29 01:29:29,370 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-29 01:29:29,370 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-29 01:29:29,370 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-29 01:29:29,370 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-29 01:29:29,370 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-29 01:29:29,376 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-29 01:29:29,377 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-29 01:29:29,377 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-29 01:29:29,377 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-29 01:29:29,377 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-29 01:29:29,377 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-29 01:29:29,377 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4437428032) cleanup complete.
2025-05-29 01:29:29,378 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-29 01:29:29,378 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-29 01:29:29,385 - INFO - app.db.session - Database engine closed successfully.
2025-05-29 01:29:29,385 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-29 01:29:29,385 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-29 01:29:29,386 - INFO - __main__ - Agent runner main finished.
2025-05-29 01:29:29,554 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-29 01:29:29,554 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-29 01:29:29,554 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-29 01:29:29,554 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4417345088) was cancelled.
2025-05-29 01:29:29,554 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4417345088) stopping. Performing cleanup...
2025-05-29 01:29:29,554 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-29 01:29:29,558 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-29 01:29:29,559 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-29 01:29:29,559 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-29 01:29:29,560 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-29 01:29:29,560 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-29 01:29:29,560 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4417345088) cleanup complete.
2025-05-29 01:29:29,560 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-29 01:29:29,560 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-29 01:29:29,560 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4417354016) was cancelled.
2025-05-29 01:29:29,560 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4417354016) stopping. Performing cleanup...
2025-05-29 01:29:29,560 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-29 01:29:29,563 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-29 01:29:29,564 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-29 01:29:29,564 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-29 01:29:29,564 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-29 01:29:29,564 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-29 01:29:29,564 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4417354016) cleanup complete.
2025-05-29 01:29:29,564 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-29 01:29:29,564 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-29 01:29:29,564 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4417457328) was cancelled.
2025-05-29 01:29:29,564 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4417457328) stopping. Performing cleanup...
2025-05-29 01:29:29,564 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-29 01:29:29,565 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-29 01:29:29,565 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-29 01:29:29,565 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-29 01:29:29,565 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-29 01:29:29,566 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-29 01:29:29,567 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-29 01:29:29,567 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-29 01:29:29,568 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-29 01:29:29,568 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-29 01:29:29,568 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-29 01:29:29,568 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4417457328) cleanup complete.
2025-05-29 01:29:29,568 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-29 01:29:29,568 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-29 01:29:29,568 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-29 01:29:29,578 - INFO - app.db.session - Database engine closed successfully.
2025-05-29 01:29:29,578 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-29 01:29:29,620 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-29 01:29:29,620 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-29 01:29:29,620 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-29 01:29:29,620 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 5125184192) received shutdown request. Initiating graceful shutdown...
2025-05-29 01:29:29,620 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 5125184192)...
2025-05-29 01:29:29,620 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-29 01:29:29,620 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-29 01:29:29,620 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 5125184192) was cancelled.
2025-05-29 01:29:29,620 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 5125184192) stopping. Performing cleanup...
2025-05-29 01:29:29,620 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-29 01:29:29,620 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-29 01:29:29,620 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-29 01:29:29,620 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-29 01:29:29,620 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-29 01:29:29,620 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-29 01:29:29,620 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-29 01:29:29,620 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-29 01:29:29,620 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-29 01:29:29,621 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-29 01:29:29,626 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-29 01:29:29,627 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-29 01:29:29,627 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-29 01:29:29,627 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-29 01:29:29,627 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-29 01:29:29,627 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-29 01:29:29,627 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 5125184192) cleanup complete.
2025-05-29 01:29:29,627 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-29 01:29:29,627 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-29 01:29:29,632 - INFO - app.db.session - Database engine closed successfully.
2025-05-29 01:29:29,632 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-29 01:29:29,632 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-29 01:29:29,633 - INFO - __main__ - Telegram bot runner main finished.
2025-05-29 12:33:55,834 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-29 12:33:55,834 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-29 12:33:55,848 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-29 12:33:55,848 - INFO - app.core.lifespan - Starting background tasks...
2025-05-29 12:33:55,848 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-29 12:33:55,848 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-29 12:33:55,848 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-29 12:33:55,848 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-29 12:33:55,848 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-29 12:33:55,848 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-29 12:33:55,848 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-29 12:33:55,849 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-29 12:33:55,849 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-29 12:33:55,853 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-29 12:33:55,853 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-29 12:33:55,853 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-29 12:33:55,853 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-29 12:33:55,853 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-29 12:33:55,856 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-29 12:33:55,856 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-29 12:33:55,860 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-29 12:33:55,860 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4445387280) setup complete. Starting run loop.
2025-05-29 12:33:55,860 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-29 12:33:55,860 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-29 12:33:55,861 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-29 12:33:55,861 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4445386944) setup complete. Starting run loop.
2025-05-29 12:33:55,862 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-29 12:33:55,863 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-29 12:33:55,863 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-29 12:33:55,918 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-29 12:33:55,918 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-29 12:33:55,921 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-29 12:33:55,922 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 22336
2025-05-29 12:33:55,922 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 22336
2025-05-29 12:33:55,924 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-29 12:33:55,924 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-29 12:33:55,924 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-29 12:33:55,926 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-29 12:33:55,926 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 22337
2025-05-29 12:33:55,926 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 22337
2025-05-29 12:33:55,927 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-29 12:33:55,928 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-29 12:33:55,928 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-29 12:33:55,928 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-29 12:33:55,928 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-29 12:33:56,800 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-29 12:33:56,800 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-29 12:33:56,800 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-29 12:33:56,800 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-29 12:33:56,800 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 22337
2025-05-29 12:33:56,800 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-29 12:33:56,800 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-29 12:33:56,800 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-29 12:33:56,807 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-29 12:33:56,820 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-29 12:33:56,821 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-29 12:33:56,821 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-29 12:33:56,821 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4459305904) setup complete. Starting run loop.
2025-05-29 12:33:56,821 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-29 12:33:56,821 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-29 12:33:56,821 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-29 12:33:56,821 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-29 12:33:56,821 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-29 12:33:56,821 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-29 12:33:56,821 - INFO - aiogram.dispatcher - Start polling
2025-05-29 12:33:56,824 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-29 12:33:57,067 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-29 12:33:57,240 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-29 12:33:57,241 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-29 12:33:57,241 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-29 12:33:57,241 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-29 12:33:57,241 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 22336
2025-05-29 12:33:57,241 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-29 12:33:57,241 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-29 12:33:57,241 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-29 12:33:57,248 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-29 12:33:57,248 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-29 12:33:57,325 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-29 12:33:57,325 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-29 12:33:57,325 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-29 12:33:57,325 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-29 12:33:57,325 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-29 12:33:57,325 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-29 12:33:57,350 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-29 12:33:57,350 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-29 12:33:57,350 - INFO - app.agent_runner.common.tools_registry - Configured 3 predefined tools from centralized registry
2025-05-29 12:33:57,350 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000000
2025-05-29 12:33:57,350 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001
2025-05-29 12:33:57,350 - INFO - AGENT:agent_airsoft_0faa9616 - Added 3 tools from centralized registry
2025-05-29 12:33:57,350 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-29 12:33:57,411 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-29 12:33:57,417 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-29 12:33:58,632 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-29 12:33:58,639 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-29 12:33:58,641 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-29 12:33:58,641 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-29 12:33:58,641 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-29 12:33:58,641 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-29 12:33:58,641 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 5 (4 safe, 1 datastore).
2025-05-29 12:33:58,641 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 5 total, 4 safe, 1 datastore tools. Max rewrites: 3.
2025-05-29 12:33:58,641 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-29 12:33:58,643 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-29 12:33:58,644 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-29 12:33:58,644 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-29 12:33:58,644 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-29 12:33:58,645 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-29 12:33:58,645 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-29 12:33:58,645 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-29 12:33:58,669 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-29 12:33:58,669 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-29 12:33:58,669 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-29 12:33:58,669 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4468590064) setup complete. Starting run loop.
2025-05-29 12:33:58,669 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-29 12:33:58,669 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-29 12:33:58,669 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-29 12:33:58,669 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-29 12:33:58,673 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-29 12:34:05,864 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-29 12:34:05,871 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-29 12:34:05,872 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4444300368) setup complete. Starting run loop.
2025-05-29 12:34:05,872 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-29 12:39:06,082 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 12:39:06,091 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 12:44:06,296 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 12:44:06,306 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 12:49:06,544 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 12:49:06,553 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 12:54:06,743 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 12:54:06,753 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 12:59:06,952 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 12:59:06,960 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 13:04:07,132 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 13:04:07,141 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 13:09:07,323 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 13:09:07,331 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 13:14:07,519 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 13:14:07,530 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 13:19:07,728 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 13:19:07,736 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 13:24:07,920 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 13:24:07,930 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 13:29:08,113 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 13:29:08,127 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 13:34:08,303 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 13:34:08,316 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 13:39:08,505 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 13:39:08,517 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 13:44:08,731 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 13:44:08,742 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 13:49:08,930 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 13:49:08,940 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 13:54:09,132 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 13:54:09,141 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 13:59:09,328 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 13:59:09,337 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 14:04:09,512 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 14:04:09,523 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 14:09:09,704 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 14:09:09,717 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 14:14:09,915 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 14:14:09,928 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 14:19:10,209 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 14:19:10,218 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 14:24:10,411 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 14:24:10,421 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 14:29:10,611 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 14:29:10,618 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 14:34:10,798 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 14:34:10,806 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 14:39:10,989 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 14:39:10,999 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 14:44:11,227 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 14:44:11,236 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 14:49:11,409 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 14:49:11,418 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 14:54:11,609 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 14:54:11,618 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 14:59:11,797 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 14:59:11,807 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 15:04:12,043 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 15:04:12,054 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 15:09:12,319 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 15:09:12,333 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 15:14:12,682 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 15:14:12,693 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 15:19:13,105 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 15:19:13,114 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 15:24:13,530 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 15:24:13,542 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 15:29:13,925 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 15:29:13,937 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 15:34:14,293 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 15:34:14,305 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 15:39:14,665 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 15:39:14,676 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 15:44:15,044 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 15:44:15,056 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 15:49:15,402 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 15:49:15,412 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 15:54:15,770 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 15:54:15,782 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 15:59:16,127 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 15:59:16,138 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 16:04:16,484 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 16:04:16,494 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 16:09:16,879 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 16:09:16,889 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 16:14:17,239 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 16:14:17,246 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 16:19:17,608 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 16:19:17,642 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 16:24:18,026 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 16:24:18,036 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 16:29:18,412 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 16:29:18,419 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 16:34:18,803 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 16:34:18,816 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 16:39:19,109 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 16:39:19,117 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 16:44:19,328 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 16:44:19,338 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 16:49:19,522 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 16:49:19,534 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 16:54:19,753 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 16:54:19,767 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 16:59:19,965 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 16:59:19,975 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 17:04:20,230 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 17:04:20,243 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 17:09:20,458 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 17:09:20,468 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 17:14:20,660 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 17:14:20,685 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 17:19:20,912 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 17:19:20,921 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 17:24:21,092 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 17:24:21,101 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 17:29:21,551 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 17:29:21,580 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 17:34:21,849 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 17:34:21,873 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 17:39:22,122 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 17:39:22,132 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 17:44:22,574 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 17:44:22,589 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 17:49:22,924 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 17:49:22,936 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 17:54:23,216 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 17:54:23,236 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 17:59:23,462 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 17:59:23,471 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 17:59:46,975 - INFO - app.api.routers.sse_api - SSE connection requested for agent agent_airsoft_0faa9616, thread 9fb8e3a6-7879-4612-9e53-9d1bbaea8257
2025-05-29 18:00:59,820 - INFO - app.api.routers.sse_api - SSE connection for agent agent_airsoft_0faa9616, thread 9fb8e3a6-7879-4612-9e53-9d1bbaea8257 closed by client.
2025-05-29 18:04:23,699 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 18:04:23,710 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 18:09:23,883 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 18:09:23,899 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 18:14:24,110 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 18:14:24,120 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 18:19:24,305 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 18:19:24,315 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 18:24:24,507 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 18:24:24,518 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 18:29:24,717 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 18:29:24,734 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 18:34:24,963 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 18:34:24,971 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 18:39:25,178 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 18:39:25,188 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 18:44:25,379 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 18:44:25,392 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 18:49:25,599 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 18:49:25,607 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 18:54:25,793 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 18:54:25,803 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 18:59:26,176 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 18:59:26,186 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 19:04:26,543 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 19:04:26,563 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 19:09:26,908 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 19:09:26,917 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 19:14:27,282 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 19:14:27,293 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 19:19:27,671 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 19:19:27,680 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 19:24:28,023 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 19:24:28,036 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 19:29:28,388 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 19:29:28,400 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 19:34:28,802 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 19:34:28,815 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 19:39:29,171 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 19:39:29,183 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 19:44:29,576 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 19:44:29,588 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 19:49:29,969 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 19:49:29,980 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 19:54:30,257 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 19:54:30,269 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 19:54:46,125 - ERROR - aiogram.dispatcher - Failed to fetch updates - TelegramNetworkError: HTTP Client says - Request timeout error
2025-05-29 19:54:46,132 - WARNING - aiogram.dispatcher - Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 1750613938)
2025-05-29 19:54:57,386 - INFO - aiogram.dispatcher - Connection established (tryings = 1, bot id = 1750613938)
2025-05-29 19:59:30,485 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 19:59:30,496 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 20:04:30,711 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 20:04:30,723 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 20:09:30,990 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 20:09:31,002 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 20:14:31,367 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 20:14:31,381 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 20:19:31,689 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 20:19:31,700 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 20:24:31,881 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-29 20:24:31,897 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-29 20:27:11,163 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-29 20:27:11,180 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-29 20:27:11,181 - INFO - aiogram.dispatcher - Polling stopped
2025-05-29 20:27:11,171 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-29 20:27:11,187 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4468590064) received shutdown request. Initiating graceful shutdown...
2025-05-29 20:27:11,194 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4468590064)...
2025-05-29 20:27:11,194 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-29 20:27:11,195 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-29 20:27:11,196 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4468590064) was cancelled.
2025-05-29 20:27:11,196 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4468590064) stopping. Performing cleanup...
2025-05-29 20:27:11,197 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-29 20:27:11,201 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 0) on start/restart.
2025-05-29 20:27:11,210 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-29 20:27:11,211 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-29 20:27:11,212 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-29 20:27:11,212 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-29 20:27:11,215 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-29 20:27:11,215 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-29 20:27:11,215 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-29 20:27:11,229 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-29 20:27:11,230 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-29 20:27:11,231 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-29 20:27:11,233 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-29 20:27:11,234 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-29 20:27:11,234 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-29 20:27:11,234 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4468590064) cleanup complete.
2025-05-29 20:27:11,234 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-29 20:27:11,234 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-29 20:27:11,246 - INFO - app.db.session - Database engine closed successfully.
2025-05-29 20:27:11,246 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-29 20:27:11,246 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-29 20:27:11,249 - INFO - __main__ - Agent runner main finished.
2025-05-29 20:27:11,280 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-29 20:27:11,280 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-29 20:27:11,280 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-29 20:27:11,283 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4445387280) was cancelled.
2025-05-29 20:27:11,283 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4445387280) stopping. Performing cleanup...
2025-05-29 20:27:11,283 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-29 20:27:11,293 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-29 20:27:11,294 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-29 20:27:11,295 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-29 20:27:11,296 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-29 20:27:11,297 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-29 20:27:11,297 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4445387280) cleanup complete.
2025-05-29 20:27:11,297 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-29 20:27:11,297 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-29 20:27:11,297 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4445386944) was cancelled.
2025-05-29 20:27:11,297 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4445386944) stopping. Performing cleanup...
2025-05-29 20:27:11,297 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-29 20:27:11,300 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-29 20:27:11,300 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-29 20:27:11,300 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-29 20:27:11,301 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-29 20:27:11,301 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-29 20:27:11,301 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4445386944) cleanup complete.
2025-05-29 20:27:11,301 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-29 20:27:11,301 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-29 20:27:11,301 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4444300368) was cancelled.
2025-05-29 20:27:11,301 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4444300368) stopping. Performing cleanup...
2025-05-29 20:27:11,302 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-29 20:27:11,302 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-29 20:27:11,302 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-29 20:27:11,302 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-29 20:27:11,303 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-29 20:27:11,306 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-29 20:27:11,306 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-29 20:27:11,306 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-29 20:27:11,307 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-29 20:27:11,307 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-29 20:27:11,307 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-29 20:27:11,307 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4444300368) cleanup complete.
2025-05-29 20:27:11,307 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-29 20:27:11,307 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-29 20:27:11,308 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-29 20:27:11,348 - INFO - app.db.session - Database engine closed successfully.
2025-05-29 20:27:11,348 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-29 20:27:11,436 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-29 20:27:11,436 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-29 20:27:11,437 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-29 20:27:11,437 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4459305904) received shutdown request. Initiating graceful shutdown...
2025-05-29 20:27:11,437 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4459305904)...
2025-05-29 20:27:11,437 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-29 20:27:11,437 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-29 20:27:11,438 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4459305904) was cancelled.
2025-05-29 20:27:11,438 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4459305904) stopping. Performing cleanup...
2025-05-29 20:27:11,438 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-29 20:27:11,438 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-29 20:27:11,438 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-29 20:27:11,438 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-29 20:27:11,438 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-29 20:27:11,438 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-29 20:27:11,438 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-29 20:27:11,439 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-29 20:27:11,440 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-29 20:27:11,440 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-29 20:27:11,447 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-29 20:27:11,448 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-29 20:27:11,448 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-29 20:27:11,449 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-29 20:27:11,449 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-29 20:27:11,449 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-29 20:27:11,449 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4459305904) cleanup complete.
2025-05-29 20:27:11,449 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-29 20:27:11,449 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-29 20:27:11,458 - INFO - app.db.session - Database engine closed successfully.
2025-05-29 20:27:11,458 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-29 20:27:11,458 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-29 20:27:11,460 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 00:00:19,413 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 00:00:19,413 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 00:00:19,415 - ERROR - app.services.redis_service - Failed to connect to Redis: Error 61 connecting to localhost:6379. Connection refused.
Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 281, in connect
    await self.retry.call_with_retry(
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/retry.py", line 59, in call_with_retry
    return await do()
           ^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 697, in _connect
    reader, writer = await asyncio.open_connection(
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/.local/share/uv/python/cpython-3.12.9-macos-aarch64-none/lib/python3.12/asyncio/streams.py", line 48, in open_connection
    transport, _ = await loop.create_connection(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "uvloop/loop.pyx", line 2043, in create_connection
  File "uvloop/loop.pyx", line 2020, in uvloop.loop.Loop.create_connection
ConnectionRefusedError: [Errno 61] Connection refused

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/services/redis_service.py", line 22, in init_redis_pool
    await client.ping()
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/client.py", line 611, in execute_command
    conn = self.connection or await pool.get_connection(command_name, **options)
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 1064, in get_connection
    await self.ensure_connection(connection)
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 1097, in ensure_connection
    await connection.connect()
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 289, in connect
    raise ConnectionError(self._error_message(e))
redis.exceptions.ConnectionError: Error 61 connecting to localhost:6379. Connection refused.
2025-05-30 00:00:19,417 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 00:00:19,417 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 00:00:19,417 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 00:00:19,417 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 00:00:19,417 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 00:00:19,417 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 00:00:19,417 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 00:00:19,418 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 00:00:19,418 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 00:00:19,418 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 00:00:19,418 - ERROR - app.core.base.redis_manager - Failed to connect to Redis after initialization: Error 61 connecting to localhost:6379. Connection refused.
Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 281, in connect
    await self.retry.call_with_retry(
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/retry.py", line 59, in call_with_retry
    return await do()
           ^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 697, in _connect
    reader, writer = await asyncio.open_connection(
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/.local/share/uv/python/cpython-3.12.9-macos-aarch64-none/lib/python3.12/asyncio/streams.py", line 48, in open_connection
    transport, _ = await loop.create_connection(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "uvloop/loop.pyx", line 2043, in create_connection
  File "uvloop/loop.pyx", line 2020, in uvloop.loop.Loop.create_connection
ConnectionRefusedError: [Errno 61] Connection refused

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/core/base/redis_manager.py", line 117, in setup_redis_client
    await self._redis_client.ping()
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/client.py", line 611, in execute_command
    conn = self.connection or await pool.get_connection(command_name, **options)
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 1064, in get_connection
    await self.ensure_connection(connection)
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 1097, in ensure_connection
    await connection.connect()
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 289, in connect
    raise ConnectionError(self._error_message(e))
redis.exceptions.ConnectionError: Error 61 connecting to localhost:6379. Connection refused.
2025-05-30 00:00:19,419 - ERROR - app.core.base.redis_manager - Failed to connect to Redis after initialization: Error 61 connecting to localhost:6379. Connection refused.
Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 281, in connect
    await self.retry.call_with_retry(
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/retry.py", line 59, in call_with_retry
    return await do()
           ^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 697, in _connect
    reader, writer = await asyncio.open_connection(
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/.local/share/uv/python/cpython-3.12.9-macos-aarch64-none/lib/python3.12/asyncio/streams.py", line 48, in open_connection
    transport, _ = await loop.create_connection(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "uvloop/loop.pyx", line 2043, in create_connection
  File "uvloop/loop.pyx", line 2020, in uvloop.loop.Loop.create_connection
ConnectionRefusedError: [Errno 61] Connection refused

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/core/base/redis_manager.py", line 117, in setup_redis_client
    await self._redis_client.ping()
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/client.py", line 611, in execute_command
    conn = self.connection or await pool.get_connection(command_name, **options)
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 1064, in get_connection
    await self.ensure_connection(connection)
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 1097, in ensure_connection
    await connection.connect()
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 289, in connect
    raise ConnectionError(self._error_message(e))
redis.exceptions.ConnectionError: Error 61 connecting to localhost:6379. Connection refused.
2025-05-30 00:00:19,419 - ERROR - app.core.lifespan - Failed to setup ProcessManager or connect to Redis: Error 61 connecting to localhost:6379. Connection refused.
Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 281, in connect
    await self.retry.call_with_retry(
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/retry.py", line 59, in call_with_retry
    return await do()
           ^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 697, in _connect
    reader, writer = await asyncio.open_connection(
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/.local/share/uv/python/cpython-3.12.9-macos-aarch64-none/lib/python3.12/asyncio/streams.py", line 48, in open_connection
    transport, _ = await loop.create_connection(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "uvloop/loop.pyx", line 2043, in create_connection
  File "uvloop/loop.pyx", line 2020, in uvloop.loop.Loop.create_connection
ConnectionRefusedError: [Errno 61] Connection refused

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/core/lifespan.py", line 60, in start_existing_agents_and_integrations
    await pm.setup_manager() # ADDED: Setup ProcessManager
    ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/services/process_manager.py", line 159, in setup_manager
    await self.setup_redis_client(redis_url=str(settings.REDIS_URL))
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/core/base/redis_manager.py", line 117, in setup_redis_client
    await self._redis_client.ping()
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/client.py", line 611, in execute_command
    conn = self.connection or await pool.get_connection(command_name, **options)
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 1064, in get_connection
    await self.ensure_connection(connection)
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 1097, in ensure_connection
    await connection.connect()
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 289, in connect
    raise ConnectionError(self._error_message(e))
redis.exceptions.ConnectionError: Error 61 connecting to localhost:6379. Connection refused.
2025-05-30 00:00:19,420 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 00:00:19,420 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 00:00:19,420 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 00:00:19,420 - ERROR - app.core.base.redis_manager - Failed to connect to Redis after initialization: Error 61 connecting to localhost:6379. Connection refused.
Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 281, in connect
    await self.retry.call_with_retry(
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/retry.py", line 59, in call_with_retry
    return await do()
           ^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 697, in _connect
    reader, writer = await asyncio.open_connection(
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/.local/share/uv/python/cpython-3.12.9-macos-aarch64-none/lib/python3.12/asyncio/streams.py", line 48, in open_connection
    transport, _ = await loop.create_connection(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "uvloop/loop.pyx", line 2043, in create_connection
  File "uvloop/loop.pyx", line 2020, in uvloop.loop.Loop.create_connection
ConnectionRefusedError: [Errno 61] Connection refused

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/core/base/redis_manager.py", line 117, in setup_redis_client
    await self._redis_client.ping()
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/client.py", line 611, in execute_command
    conn = self.connection or await pool.get_connection(command_name, **options)
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 1064, in get_connection
    await self.ensure_connection(connection)
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 1097, in ensure_connection
    await connection.connect()
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 289, in connect
    raise ConnectionError(self._error_message(e))
redis.exceptions.ConnectionError: Error 61 connecting to localhost:6379. Connection refused.
2025-05-30 00:00:19,420 - ERROR - HistorySaverWorker - Unhandled error in component HistorySaverWorker (instance: 4617353792) run phase: Error 61 connecting to localhost:6379. Connection refused.
Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 281, in connect
    await self.retry.call_with_retry(
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/retry.py", line 59, in call_with_retry
    return await do()
           ^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 697, in _connect
    reader, writer = await asyncio.open_connection(
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/.local/share/uv/python/cpython-3.12.9-macos-aarch64-none/lib/python3.12/asyncio/streams.py", line 48, in open_connection
    transport, _ = await loop.create_connection(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "uvloop/loop.pyx", line 2043, in create_connection
  File "uvloop/loop.pyx", line 2020, in uvloop.loop.Loop.create_connection
ConnectionRefusedError: [Errno 61] Connection refused

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/core/base/runnable_component.py", line 106, in run
    await self.setup()
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/workers/history_saver_worker.py", line 47, in setup
    await super().setup()
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/workers/base_worker.py", line 113, in setup
    await super().setup()
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/workers/base_worker.py", line 51, in setup
    await self.setup_status_updater(redis_url=str(settings.REDIS_URL))
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/core/base/status_updater.py", line 298, in setup_status_updater
    await self.setup_redis_client(effective_redis_url) # From RedisClientManager
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/core/base/redis_manager.py", line 117, in setup_redis_client
    await self._redis_client.ping()
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/client.py", line 611, in execute_command
    conn = self.connection or await pool.get_connection(command_name, **options)
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 1064, in get_connection
    await self.ensure_connection(connection)
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 1097, in ensure_connection
    await connection.connect()
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 289, in connect
    raise ConnectionError(self._error_message(e))
redis.exceptions.ConnectionError: Error 61 connecting to localhost:6379. Connection refused.
2025-05-30 00:00:19,421 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4617353792) received shutdown request. Initiating graceful shutdown...
2025-05-30 00:00:19,421 - INFO - HistorySaverWorker - No active main task to cancel for HistorySaverWorker (instance: 4617353792). Component might not have fully started or already stopped.
2025-05-30 00:00:19,421 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4617353792) stopping. Performing cleanup...
2025-05-30 00:00:19,421 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 00:00:19,421 - ERROR - HistorySaverWorker - Redis client not available. Cannot update status for history_saver_worker.
2025-05-30 00:00:19,421 - ERROR - HistorySaverWorker - Redis client not available. Cannot clear fields for history_saver_worker.
2025-05-30 00:00:19,421 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 00:00:19,421 - ERROR - HistorySaverWorker - Redis client not available. Cannot delete status key for history_saver_worker.
2025-05-30 00:00:19,421 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 00:00:19,421 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 00:00:19,421 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4617353792) cleanup complete.
2025-05-30 00:00:19,421 - ERROR - app.core.base.redis_manager - Failed to connect to Redis after initialization: Error 61 connecting to localhost:6379. Connection refused.
Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 281, in connect
    await self.retry.call_with_retry(
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/retry.py", line 59, in call_with_retry
    return await do()
           ^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 697, in _connect
    reader, writer = await asyncio.open_connection(
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/.local/share/uv/python/cpython-3.12.9-macos-aarch64-none/lib/python3.12/asyncio/streams.py", line 48, in open_connection
    transport, _ = await loop.create_connection(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "uvloop/loop.pyx", line 2043, in create_connection
  File "uvloop/loop.pyx", line 2020, in uvloop.loop.Loop.create_connection
ConnectionRefusedError: [Errno 61] Connection refused

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/core/base/redis_manager.py", line 117, in setup_redis_client
    await self._redis_client.ping()
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/client.py", line 611, in execute_command
    conn = self.connection or await pool.get_connection(command_name, **options)
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 1064, in get_connection
    await self.ensure_connection(connection)
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 1097, in ensure_connection
    await connection.connect()
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 289, in connect
    raise ConnectionError(self._error_message(e))
redis.exceptions.ConnectionError: Error 61 connecting to localhost:6379. Connection refused.
2025-05-30 00:00:19,421 - ERROR - InactivityMonitorWorker - Unhandled error in component InactivityMonitorWorker (instance: 4617353936) run phase: Error 61 connecting to localhost:6379. Connection refused.
Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 281, in connect
    await self.retry.call_with_retry(
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/retry.py", line 59, in call_with_retry
    return await do()
           ^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 697, in _connect
    reader, writer = await asyncio.open_connection(
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/.local/share/uv/python/cpython-3.12.9-macos-aarch64-none/lib/python3.12/asyncio/streams.py", line 48, in open_connection
    transport, _ = await loop.create_connection(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "uvloop/loop.pyx", line 2043, in create_connection
  File "uvloop/loop.pyx", line 2020, in uvloop.loop.Loop.create_connection
ConnectionRefusedError: [Errno 61] Connection refused

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/core/base/runnable_component.py", line 106, in run
    await self.setup()
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/workers/inactivity_monitor_worker.py", line 80, in setup
    await super().setup() # Sets up StatusUpdater, Redis client for worker status
    ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/workers/base_worker.py", line 242, in setup
    await super().setup()
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/workers/base_worker.py", line 51, in setup
    await self.setup_status_updater(redis_url=str(settings.REDIS_URL))
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/core/base/status_updater.py", line 298, in setup_status_updater
    await self.setup_redis_client(effective_redis_url) # From RedisClientManager
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/core/base/redis_manager.py", line 117, in setup_redis_client
    await self._redis_client.ping()
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/client.py", line 611, in execute_command
    conn = self.connection or await pool.get_connection(command_name, **options)
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 1064, in get_connection
    await self.ensure_connection(connection)
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 1097, in ensure_connection
    await connection.connect()
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 289, in connect
    raise ConnectionError(self._error_message(e))
redis.exceptions.ConnectionError: Error 61 connecting to localhost:6379. Connection refused.
2025-05-30 00:00:19,422 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4617353936) received shutdown request. Initiating graceful shutdown...
2025-05-30 00:00:19,422 - INFO - InactivityMonitorWorker - No active main task to cancel for InactivityMonitorWorker (instance: 4617353936). Component might not have fully started or already stopped.
2025-05-30 00:00:19,422 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4617353936) stopping. Performing cleanup...
2025-05-30 00:00:19,422 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 00:00:19,422 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 00:00:19,422 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 00:00:19,422 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 00:00:19,422 - ERROR - InactivityMonitorWorker - Redis client not available. Cannot update status for inactivity_monitor_worker.
2025-05-30 00:00:19,422 - ERROR - InactivityMonitorWorker - Redis client not available. Cannot clear fields for inactivity_monitor_worker.
2025-05-30 00:00:19,422 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 00:00:19,422 - ERROR - InactivityMonitorWorker - Redis client not available. Cannot delete status key for inactivity_monitor_worker.
2025-05-30 00:00:19,422 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 00:00:19,422 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 00:00:19,422 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 00:00:19,422 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4617353936) cleanup complete.
2025-05-30 00:00:19,422 - ERROR - TokenUsageWorker - Unhandled error in component TokenUsageWorker (instance: 4617353456) run phase: Error 61 connecting to localhost:6379. Connection refused.
Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 281, in connect
    await self.retry.call_with_retry(
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/retry.py", line 59, in call_with_retry
    return await do()
           ^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 697, in _connect
    reader, writer = await asyncio.open_connection(
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/.local/share/uv/python/cpython-3.12.9-macos-aarch64-none/lib/python3.12/asyncio/streams.py", line 48, in open_connection
    transport, _ = await loop.create_connection(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "uvloop/loop.pyx", line 2043, in create_connection
  File "uvloop/loop.pyx", line 2020, in uvloop.loop.Loop.create_connection
ConnectionRefusedError: [Errno 61] Connection refused

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/core/base/runnable_component.py", line 106, in run
    await self.setup()
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/workers/token_usage_worker.py", line 55, in setup
    await super().setup()
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/workers/base_worker.py", line 113, in setup
    await super().setup()
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/workers/base_worker.py", line 51, in setup
    await self.setup_status_updater(redis_url=str(settings.REDIS_URL))
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/core/base/status_updater.py", line 298, in setup_status_updater
    await self.setup_redis_client(effective_redis_url) # From RedisClientManager
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/core/base/redis_manager.py", line 117, in setup_redis_client
    await self._redis_client.ping()
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/client.py", line 611, in execute_command
    conn = self.connection or await pool.get_connection(command_name, **options)
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 1064, in get_connection
    await self.ensure_connection(connection)
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 1097, in ensure_connection
    await connection.connect()
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 289, in connect
    raise ConnectionError(self._error_message(e))
redis.exceptions.ConnectionError: Error 61 connecting to localhost:6379. Connection refused.
2025-05-30 00:00:19,422 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4617353456) received shutdown request. Initiating graceful shutdown...
2025-05-30 00:00:19,422 - INFO - TokenUsageWorker - No active main task to cancel for TokenUsageWorker (instance: 4617353456). Component might not have fully started or already stopped.
2025-05-30 00:00:19,422 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4617353456) stopping. Performing cleanup...
2025-05-30 00:00:19,422 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 00:00:19,422 - ERROR - TokenUsageWorker - Redis client not available. Cannot update status for token_usage_worker.
2025-05-30 00:00:19,422 - ERROR - TokenUsageWorker - Redis client not available. Cannot clear fields for token_usage_worker.
2025-05-30 00:00:19,422 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 00:00:19,422 - ERROR - TokenUsageWorker - Redis client not available. Cannot delete status key for token_usage_worker.
2025-05-30 00:00:19,422 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 00:00:19,422 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 00:00:19,422 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4617353456) cleanup complete.
2025-05-30 00:01:06,419 - ERROR - app.db.crud.agent_crud - Unexpected error fetching all agent configs: [Errno 61] Connection refused
Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/db/crud/agent_crud.py", line 65, in db_get_all_agents
    result = await db.execute(stmt)
             ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py", line 463, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 201, in greenlet_spawn
    result = context.throw(*sys.exc_info())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2365, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2241, in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2110, in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 1189, in _connection_for_bind
    conn = bind.connect()
           ^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 3274, in connect
    return self._connection_cls(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 146, in __init__
    self._dbapi_connection = engine.raw_connection()
                             ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 3298, in raw_connection
    return self.pool.connect()
           ^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 449, in connect
    return _ConnectionFairy._checkout(self)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 1264, in _checkout
    fairy = _ConnectionRecord.checkout(pool)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 713, in checkout
    rec = pool._do_get()
          ^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/sqlalchemy/pool/impl.py", line 179, in _do_get
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py", line 146, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/sqlalchemy/pool/impl.py", line 177, in _do_get
    return self._create_connection()
           ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 390, in _create_connection
    return _ConnectionRecord(self)
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 675, in __init__
    self.__connect()
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 901, in __connect
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py", line 146, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/sqlalchemy/pool/base.py", line 897, in __connect
    self.dbapi_connection = connection = pool._invoke_creator(self)
                                         ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/sqlalchemy/engine/create.py", line 646, in connect
    return dialect.connect(*cargs, **cparams)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 622, in connect
    return self.loaded_dbapi.connect(*cargs, **cparams)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 961, in connect
    await_only(creator_fn(*arg, **kw)),
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/asyncpg/connection.py", line 2421, in connect
    return await connect_utils._connect(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/asyncpg/connect_utils.py", line 1075, in _connect
    raise last_error or exceptions.TargetServerAttributeNotMatched(
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/asyncpg/connect_utils.py", line 1049, in _connect
    conn = await _connect_addr(
           ^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/asyncpg/connect_utils.py", line 886, in _connect_addr
    return await __connect_addr(params, True, *args)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/asyncpg/connect_utils.py", line 931, in __connect_addr
    tr, pr = await connector
             ^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/asyncpg/connect_utils.py", line 802, in _create_ssl_connection
    tr, pr = await loop.create_connection(
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "uvloop/loop.pyx", line 2043, in create_connection
  File "uvloop/loop.pyx", line 2020, in uvloop.loop.Loop.create_connection
ConnectionRefusedError: [Errno 61] Connection refused
2025-05-30 00:01:06,428 - ERROR - app.core.base.redis_manager - Failed to connect to Redis after initialization: Error 61 connecting to localhost:6379. Connection refused.
Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 281, in connect
    await self.retry.call_with_retry(
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/retry.py", line 59, in call_with_retry
    return await do()
           ^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 697, in _connect
    reader, writer = await asyncio.open_connection(
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/.local/share/uv/python/cpython-3.12.9-macos-aarch64-none/lib/python3.12/asyncio/streams.py", line 48, in open_connection
    transport, _ = await loop.create_connection(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "uvloop/loop.pyx", line 2043, in create_connection
  File "uvloop/loop.pyx", line 2020, in uvloop.loop.Loop.create_connection
ConnectionRefusedError: [Errno 61] Connection refused

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/core/base/redis_manager.py", line 117, in setup_redis_client
    await self._redis_client.ping()
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/client.py", line 611, in execute_command
    conn = self.connection or await pool.get_connection(command_name, **options)
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 1064, in get_connection
    await self.ensure_connection(connection)
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 1097, in ensure_connection
    await connection.connect()
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 289, in connect
    raise ConnectionError(self._error_message(e))
redis.exceptions.ConnectionError: Error 61 connecting to localhost:6379. Connection refused.
2025-05-30 00:01:06,429 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 00:01:06,429 - ERROR - app.core.dependencies - Error in DB session: Error 61 connecting to localhost:6379. Connection refused.
Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 281, in connect
    await self.retry.call_with_retry(
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/retry.py", line 59, in call_with_retry
    return await do()
           ^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 697, in _connect
    reader, writer = await asyncio.open_connection(
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/.local/share/uv/python/cpython-3.12.9-macos-aarch64-none/lib/python3.12/asyncio/streams.py", line 48, in open_connection
    transport, _ = await loop.create_connection(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "uvloop/loop.pyx", line 2043, in create_connection
  File "uvloop/loop.pyx", line 2020, in uvloop.loop.Loop.create_connection
ConnectionRefusedError: [Errno 61] Connection refused

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/core/dependencies.py", line 24, in get_db
    yield session
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 301, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/api/routers/agent_api.py", line 148, in list_agents
    await pm.setup_manager()
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/services/process_manager.py", line 159, in setup_manager
    await self.setup_redis_client(redis_url=str(settings.REDIS_URL))
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/core/base/redis_manager.py", line 117, in setup_redis_client
    await self._redis_client.ping()
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/client.py", line 611, in execute_command
    conn = self.connection or await pool.get_connection(command_name, **options)
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 1064, in get_connection
    await self.ensure_connection(connection)
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 1097, in ensure_connection
    await connection.connect()
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/redis/asyncio/connection.py", line 289, in connect
    raise ConnectionError(self._error_message(e))
redis.exceptions.ConnectionError: Error 61 connecting to localhost:6379. Connection refused.
2025-05-30 00:02:08,792 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 00:02:08,798 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 00:02:08,802 - INFO - app.core.lifespan - Task HistorySaverWorker was already done.
2025-05-30 00:02:08,802 - INFO - app.core.lifespan - Task TokenUsageWorker was already done.
2025-05-30 00:02:08,802 - INFO - app.core.lifespan - Task InactivityMonitorWorker was already done.
2025-05-30 00:02:08,802 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 00:02:08,802 - INFO - app.services.redis_service - Redis connection pool was not initialized or already closed.
2025-05-30 00:02:08,812 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 00:02:08,812 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 00:02:11,827 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 00:02:11,827 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 00:02:11,834 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 00:02:11,834 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 00:02:11,834 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 00:02:11,834 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 00:02:11,834 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 00:02:11,834 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 00:02:11,834 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 00:02:11,834 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 00:02:11,834 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 00:02:11,834 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 00:02:11,835 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 00:02:11,837 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 00:02:11,837 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 00:02:11,837 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 00:02:11,841 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 00:02:11,841 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 00:02:11,841 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 00:02:11,841 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 00:02:11,842 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 00:02:11,843 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 00:02:11,843 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4384373312) setup complete. Starting run loop.
2025-05-30 00:02:11,843 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 00:02:11,843 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 00:02:11,843 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4384072016) setup complete. Starting run loop.
2025-05-30 00:02:11,843 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 00:02:11,844 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 00:02:11,844 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 00:02:11,959 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 00:02:11,959 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 00:02:11,960 - WARNING - app.services.process_manager - Agent agent_airsoft_0faa9616 status is 'running' in Redis, but PID 22336 not found. Updating status.
2025-05-30 00:02:11,961 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 00:02:11,963 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 6967
2025-05-30 00:02:11,963 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 6967
2025-05-30 00:02:11,963 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 00:02:11,963 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 00:02:11,963 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 00:02:11,963 - WARNING - app.services.process_manager - Integration telegram for agent agent_airsoft_0faa9616 status is 'running' in Redis, but PID 22337 not found. Updating status.
2025-05-30 00:02:11,964 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 00:02:11,965 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 6968
2025-05-30 00:02:11,965 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 6968
2025-05-30 00:02:11,966 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 00:02:11,968 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 00:02:11,968 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 00:02:11,968 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 00:02:11,968 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 00:02:12,924 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 00:02:12,925 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 00:02:12,925 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 00:02:12,925 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 00:02:12,925 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 6968
2025-05-30 00:02:12,925 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 00:02:12,925 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 00:02:12,925 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 00:02:12,931 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 00:02:12,945 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 00:02:12,945 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 00:02:12,945 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 00:02:12,945 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4462763264) setup complete. Starting run loop.
2025-05-30 00:02:12,945 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 00:02:12,945 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 00:02:12,945 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 00:02:12,945 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 00:02:12,945 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 00:02:12,945 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 00:02:12,945 - INFO - aiogram.dispatcher - Start polling
2025-05-30 00:02:12,949 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 00:02:13,308 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 00:02:13,463 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 00:02:13,463 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 00:02:13,464 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 00:02:13,464 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 00:02:13,464 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 6967
2025-05-30 00:02:13,464 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 00:02:13,464 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 00:02:13,464 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 00:02:13,472 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 00:02:13,472 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 00:02:13,568 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 00:02:13,569 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 00:02:13,569 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 00:02:13,569 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 00:02:13,569 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 00:02:13,569 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 00:02:13,595 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 00:02:13,595 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 00:02:13,595 - INFO - app.agent_runner.common.tools_registry - Configured 3 predefined tools from centralized registry
2025-05-30 00:02:13,595 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000000
2025-05-30 00:02:13,595 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001
2025-05-30 00:02:13,595 - INFO - AGENT:agent_airsoft_0faa9616 - Added 3 tools from centralized registry
2025-05-30 00:02:13,595 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 00:02:13,655 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 00:02:13,666 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 00:02:18,466 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 00:02:18,470 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 00:02:18,471 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 00:02:18,471 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 00:02:18,471 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 00:02:18,471 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 00:02:18,471 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 5 (4 safe, 1 datastore).
2025-05-30 00:02:18,471 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 5 total, 4 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 00:02:18,471 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 00:02:18,473 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 00:02:18,474 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 00:02:18,474 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 00:02:18,474 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 00:02:18,474 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 00:02:18,475 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 00:02:18,475 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 00:02:18,485 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 00:02:18,485 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 00:02:18,485 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 00:02:18,485 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4875486416) setup complete. Starting run loop.
2025-05-30 00:02:18,486 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 00:02:18,486 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 00:02:18,486 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 00:02:18,486 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 00:02:18,488 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 00:02:21,843 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 00:02:21,849 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 00:02:21,849 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4384364576) setup complete. Starting run loop.
2025-05-30 00:02:21,849 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 00:02:59,430 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 00:02:59,431 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 00:07:22,068 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 00:07:22,078 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 00:12:22,318 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 00:12:22,327 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 00:17:22,687 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 00:17:22,697 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 00:22:23,073 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 00:22:23,082 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 00:27:23,461 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 00:27:23,472 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 00:32:23,780 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 00:32:23,789 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 00:37:23,974 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 00:37:23,983 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 00:41:12,761 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 00:41:12,761 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 00:41:12,763 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4875486416) received shutdown request. Initiating graceful shutdown...
2025-05-30 00:41:12,763 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4875486416)...
2025-05-30 00:41:12,763 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 00:41:12,763 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 00:41:12,763 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4875486416) was cancelled.
2025-05-30 00:41:12,763 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4875486416) stopping. Performing cleanup...
2025-05-30 00:41:12,763 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 00:41:12,763 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 00:41:12,764 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 00:41:12,764 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 0) on start/restart.
2025-05-30 00:41:12,765 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 00:41:12,765 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 00:41:12,765 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 00:41:12,765 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 00:41:12,766 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 00:41:12,766 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 00:41:12,766 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 00:41:12,772 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 00:41:12,772 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 00:41:12,772 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 00:41:12,773 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 00:41:12,773 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 00:41:12,773 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 00:41:12,773 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4875486416) cleanup complete.
2025-05-30 00:41:12,773 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 00:41:12,773 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 00:41:12,775 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 00:41:12,775 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 00:41:12,775 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 00:41:12,775 - INFO - __main__ - Agent runner main finished.
2025-05-30 00:41:12,938 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 00:41:12,939 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 00:41:12,939 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 00:41:12,939 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4384072016) was cancelled.
2025-05-30 00:41:12,939 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4384072016) stopping. Performing cleanup...
2025-05-30 00:41:12,939 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 00:41:12,944 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 00:41:12,945 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 00:41:12,946 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 00:41:12,951 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 00:41:12,951 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 00:41:12,951 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4384072016) cleanup complete.
2025-05-30 00:41:12,951 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 00:41:12,951 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 00:41:12,951 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4384373312) was cancelled.
2025-05-30 00:41:12,951 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4384373312) stopping. Performing cleanup...
2025-05-30 00:41:12,951 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 00:41:12,954 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 00:41:12,955 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 00:41:12,955 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 00:41:12,955 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 00:41:12,955 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 00:41:12,955 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4384373312) cleanup complete.
2025-05-30 00:41:12,955 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 00:41:12,955 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 00:41:12,955 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4384364576) was cancelled.
2025-05-30 00:41:12,955 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4384364576) stopping. Performing cleanup...
2025-05-30 00:41:12,955 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 00:41:12,955 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 00:41:12,955 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 00:41:12,955 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 00:41:12,955 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 00:41:12,958 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 00:41:12,958 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 00:41:12,958 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 00:41:12,959 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 00:41:12,959 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 00:41:12,959 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 00:41:12,959 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4384364576) cleanup complete.
2025-05-30 00:41:12,959 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 00:41:12,959 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 00:41:12,959 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 00:41:12,969 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 00:41:12,969 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 00:41:13,015 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 00:41:13,015 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 00:41:13,015 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 00:41:13,015 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4462763264) received shutdown request. Initiating graceful shutdown...
2025-05-30 00:41:13,015 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4462763264)...
2025-05-30 00:41:13,015 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 00:41:13,015 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 00:41:13,016 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4462763264) was cancelled.
2025-05-30 00:41:13,016 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4462763264) stopping. Performing cleanup...
2025-05-30 00:41:13,016 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 00:41:13,016 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 00:41:13,016 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 00:41:13,016 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 00:41:13,016 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 00:41:13,016 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 00:41:13,016 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 00:41:13,016 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 00:41:13,016 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 00:41:13,016 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 00:41:13,019 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 00:41:13,020 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 00:41:13,020 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 00:41:13,021 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 00:41:13,021 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 00:41:13,021 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 00:41:13,021 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4462763264) cleanup complete.
2025-05-30 00:41:13,021 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 00:41:13,021 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 00:41:13,022 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 00:41:13,022 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 00:41:13,022 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 00:41:13,022 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 01:04:32,440 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 01:04:32,440 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 01:04:32,446 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 01:04:32,446 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 01:04:32,446 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 01:04:32,446 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 01:04:32,446 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 01:04:32,446 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 01:04:32,446 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 01:04:32,446 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 01:04:32,447 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 01:04:32,447 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 01:04:32,447 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 01:04:32,449 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 01:04:32,449 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 01:04:32,449 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 01:04:32,449 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 01:04:32,449 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 01:04:32,449 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 01:04:32,449 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 01:04:32,468 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 01:04:32,469 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 01:04:32,469 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4448340976) setup complete. Starting run loop.
2025-05-30 01:04:32,469 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 01:04:32,469 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 01:04:32,469 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4447483520) setup complete. Starting run loop.
2025-05-30 01:04:32,469 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 01:04:32,472 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 01:04:32,472 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 01:04:32,509 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 01:04:32,509 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 01:04:32,511 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 01:04:32,512 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 9978
2025-05-30 01:04:32,512 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 9978
2025-05-30 01:04:32,512 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 01:04:32,512 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 01:04:32,512 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 01:04:32,514 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 01:04:32,514 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 9979
2025-05-30 01:04:32,515 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 9979
2025-05-30 01:04:32,515 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 01:04:32,516 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 01:04:32,516 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 01:04:32,516 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 01:04:32,516 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 01:04:33,427 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 01:04:33,427 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 01:04:33,427 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 01:04:33,427 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 01:04:33,427 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 9979
2025-05-30 01:04:33,427 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 01:04:33,427 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 01:04:33,427 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 01:04:33,433 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 01:04:33,447 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 01:04:33,447 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 01:04:33,447 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 01:04:33,447 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4918928704) setup complete. Starting run loop.
2025-05-30 01:04:33,447 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 01:04:33,447 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 01:04:33,447 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 01:04:33,447 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 01:04:33,447 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 01:04:33,447 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 01:04:33,447 - INFO - aiogram.dispatcher - Start polling
2025-05-30 01:04:33,449 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 01:04:33,706 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 01:04:33,860 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 01:04:33,860 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 01:04:33,860 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 01:04:33,860 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 01:04:33,860 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 9978
2025-05-30 01:04:33,860 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 01:04:33,860 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 01:04:33,860 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 01:04:33,906 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 01:04:33,906 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 01:04:33,949 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 01:04:33,950 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 01:04:33,950 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 01:04:33,950 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 01:04:33,950 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 01:04:33,950 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 01:04:33,976 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 01:04:33,976 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 01:04:33,976 - INFO - app.agent_runner.common.tools_registry - Configured 3 predefined tools from centralized registry
2025-05-30 01:04:33,976 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000000 (method: GET)
2025-05-30 01:04:33,976 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (method: GET)
2025-05-30 01:04:33,976 - INFO - AGENT:agent_airsoft_0faa9616 - Added 5 tools from centralized registry
2025-05-30 01:04:33,976 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 01:04:34,031 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 01:04:34,035 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 01:04:35,232 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 01:04:35,359 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 01:04:35,359 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 01:04:35,359 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 01:04:35,359 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 01:04:35,359 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 01:04:35,360 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 7 (6 safe, 1 datastore).
2025-05-30 01:04:35,360 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 7 total, 6 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 01:04:35,360 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 01:04:35,360 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 01:04:35,361 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 01:04:35,370 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 01:04:35,370 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 01:04:35,370 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 01:04:35,370 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 01:04:35,370 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 01:04:35,381 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 01:04:35,381 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 01:04:35,381 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 01:04:35,381 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4837740416) setup complete. Starting run loop.
2025-05-30 01:04:35,381 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 01:04:35,381 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 01:04:35,381 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 01:04:35,381 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 01:04:35,384 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 01:04:42,472 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 01:04:42,477 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 01:04:42,477 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4448351632) setup complete. Starting run loop.
2025-05-30 01:04:42,477 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 01:06:22,691 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Сколько программистов необходимо для перехода на 1...'
2025-05-30 01:06:22,692 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache miss for user 144641834, agent agent_airsoft_0faa9616. Checking DB.
2025-05-30 01:06:22,774 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - User 144641834 (DBID: 1) IS authorized for agent agent_airsoft_0faa9616 via DB.
2025-05-30 01:06:22,777 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 01:06:22,777 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 01:06:22,777 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 01:06:22,778 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 6730f162-52c3-43a1-a09b-52e389b5276d)
2025-05-30 01:06:22,778 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 01:06:22,779 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-30 01:06:22,815 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 6730f162-52c3-43a1-a09b-52e389b5276d, db_id: 917
2025-05-30 01:06:22,817 - INFO - AGENT:agent_airsoft_0faa9616 - Loaded 20 messages from DB for thread '144641834'.
2025-05-30 01:06:22,818 - INFO - AGENT:agent_airsoft_0faa9616 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-30 01:06:22,818 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-30 01:06:22,875 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 01:06:22,876 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 01:06:22,902 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 01:06:22,910 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 7 tools.
2025-05-30 01:06:23,778 - INFO - aiogram.event - Update id=804756303 is handled. Duration 1087 ms by bot id=1750613938
2025-05-30 01:06:23,997 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 01:06:26,160 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Для перехода на 1С:Управление торговлей 11 обычно требуется от 1 до 3 программистов, в зависимости о
2025-05-30 01:06:26,160 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 01:06:26,160 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1712, 'output_tokens': 159, 'total_tokens': 1871, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 01:06:26,160 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1712 C:159 T:1871
2025-05-30 01:06:26,160 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1871 tokens recorded.
2025-05-30 01:06:26,161 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 01:06:26,161 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 01:06:26,162 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Для перехода на 1С:Управление торговлей 11 обычно требуется от 1 до 3 программистов, в зависимости о...
2025-05-30 01:06:26,165 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 6730f162-52c3-43a1-a09b-52e389b5276d)
2025-05-30 01:06:26,165 - INFO - AGENT:agent_airsoft_0faa9616 - Found 1 token usage events for InteractionID: 6730f162-52c3-43a1-a09b-52e389b5276d.
2025-05-30 01:06:26,166 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Для перехода на 1С:Управление торговлей 11 обычно требуется от 1 до 3 программистов, в зависимости о...
2025-05-30 01:06:26,166 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Для перехода на 1С:Управление торговлей 11 обычно ...'
2025-05-30 01:06:26,168 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '6730f162-52c3-43a1-a09b-52e389b5276d', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1712, 'completion_tokens': 159, 'total_tokens': 1871, 'timestamp': '2025-05-29T20:06:26.160852+00:00'}
2025-05-30 01:06:26,169 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 6730f162-52c3-43a1-a09b-52e389b5276d
2025-05-30 01:06:26,172 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 6730f162-52c3-43a1-a09b-52e389b5276d, db_id: 918
2025-05-30 01:06:26,209 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 918 for interaction_id: 6730f162-52c3-43a1-a09b-52e389b5276d on attempt 1
2025-05-30 01:06:26,217 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 6730f162-52c3-43a1-a09b-52e389b5276d, db_id: 377
2025-05-30 01:06:46,574 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'посмотри  базе знаний...'
2025-05-30 01:06:46,576 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 01:06:46,582 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 01:06:46,582 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 01:06:46,583 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 01:06:46,584 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: c8d931e6-1d5b-475f-b5fb-9132a90e4613)
2025-05-30 01:06:46,584 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 01:06:46,585 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 01:06:46,585 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 01:06:46,589 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 01:06:46,590 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 01:06:46,594 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: c8d931e6-1d5b-475f-b5fb-9132a90e4613, db_id: 919
2025-05-30 01:06:46,615 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 01:06:46,623 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 7 tools.
2025-05-30 01:06:47,584 - INFO - aiogram.event - Update id=804756304 is handled. Duration 1009 ms by bot id=1750613938
2025-05-30 01:06:47,737 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 01:06:48,012 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 01:06:48,012 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_38647f5e19'}
2025-05-30 01:06:48,012 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1884, 'output_tokens': 36, 'total_tokens': 1920, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 01:06:48,012 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1884 C:36 T:1920
2025-05-30 01:06:48,012 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1920 tokens recorded.
2025-05-30 01:06:48,013 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 01:06:48,013 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: knowledgeBase-1748440512419
2025-05-30 01:06:48,013 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO RETRIEVE (knowledgeBase-1748440512419)---
2025-05-30 01:06:48,549 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 01:06:48,575 - INFO - httpx - HTTP Request: POST http://127.0.0.1:6333/collections/platformai/points/query "HTTP/1.1 200 OK"
2025-05-30 01:06:48,578 - INFO - AGENT:agent_airsoft_0faa9616 - ---CHECK RELEVANCE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 01:06:48,578 - INFO - AGENT:agent_airsoft_0faa9616 - Grading documents for question: 'посмотри  базе знаний'
2025-05-30 01:06:48,578 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.0, streaming: False
2025-05-30 01:06:48,603 - INFO - AGENT:agent_airsoft_0faa9616 - Created grading LLM: gpt-4.1-mini via OpenAI
2025-05-30 01:06:49,571 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 01:06:49,588 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:905 C:6 T:911
2025-05-30 01:06:49,588 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for grading_llm: 911 tokens recorded.
2025-05-30 01:06:49,588 - INFO - AGENT:agent_airsoft_0faa9616 - Total token usage for grading_llm batch: 911 tokens.
2025-05-30 01:06:49,588 - INFO - AGENT:agent_airsoft_0faa9616 - Found 0 relevant documents out of 1 initial (after split).
2025-05-30 01:06:49,589 - INFO - AGENT:agent_airsoft_0faa9616 - ---ASSESS GRADED DOCUMENTS---
2025-05-30 01:06:49,589 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO RELEVANT DOCUMENTS, REWRITE---
2025-05-30 01:06:49,590 - INFO - AGENT:agent_airsoft_0faa9616 - ---TRANSFORM QUERY (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 01:06:49,590 - INFO - AGENT:agent_airsoft_0faa9616 - Rewrite attempt 1/3 for question: 'посмотри  базе знаний'
2025-05-30 01:06:49,590 - INFO - AGENT:agent_airsoft_0faa9616 - Rewriting original question: посмотри  базе знаний
2025-05-30 01:06:49,590 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: False
2025-05-30 01:06:49,615 - INFO - AGENT:agent_airsoft_0faa9616 - Created rewrite LLM: gpt-4.1-mini via OpenAI
2025-05-30 01:06:51,322 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 01:06:51,324 - INFO - AGENT:agent_airsoft_0faa9616 - Rewritten question: Сколько программистов необходимо для полного перехода на 1С:Управление торговлей 11 с учетом этапов миграции, доработок, интеграций и обучения пользователей?
2025-05-30 01:06:51,324 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:3654 C:42 T:3696
2025-05-30 01:06:51,324 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for rewrite_llm: 3696 tokens recorded.
2025-05-30 01:06:51,325 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 01:06:51,325 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 01:06:51,350 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 01:06:51,359 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 7 tools.
2025-05-30 01:06:52,654 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 01:06:53,495 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Переформулированный запрос:

**"Сколько программистов необходимо для полного перехода на 1С:Управлен
2025-05-30 01:06:53,496 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_38647f5e19'}
2025-05-30 01:06:53,496 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 2732, 'output_tokens': 74, 'total_tokens': 2806, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 01:06:53,496 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:2732 C:74 T:2806
2025-05-30 01:06:53,496 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 2806 tokens recorded.
2025-05-30 01:06:53,497 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 01:06:53,497 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 01:06:53,498 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Переформулированный запрос:

**"Сколько программистов необходимо для полного перехода на 1С:Управлен...
2025-05-30 01:06:53,499 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: c8d931e6-1d5b-475f-b5fb-9132a90e4613)
2025-05-30 01:06:53,499 - INFO - AGENT:agent_airsoft_0faa9616 - Found 4 token usage events for InteractionID: c8d931e6-1d5b-475f-b5fb-9132a90e4613.
2025-05-30 01:06:53,502 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'c8d931e6-1d5b-475f-b5fb-9132a90e4613', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1884, 'completion_tokens': 36, 'total_tokens': 1920, 'timestamp': '2025-05-29T20:06:48.012578+00:00'}
2025-05-30 01:06:53,502 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: c8d931e6-1d5b-475f-b5fb-9132a90e4613
2025-05-30 01:06:53,502 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Переформулированный запрос:

**"Сколько программистов необходимо для полного перехода на 1С:Управлен...
2025-05-30 01:06:53,502 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Переформулированный запрос:

**"Сколько программис...'
2025-05-30 01:06:53,506 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 920 for interaction_id: c8d931e6-1d5b-475f-b5fb-9132a90e4613 on attempt 1
2025-05-30 01:06:53,506 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: c8d931e6-1d5b-475f-b5fb-9132a90e4613, db_id: 920
2025-05-30 01:06:53,512 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: c8d931e6-1d5b-475f-b5fb-9132a90e4613, db_id: 378
2025-05-30 01:06:53,518 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'c8d931e6-1d5b-475f-b5fb-9132a90e4613', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 2732, 'completion_tokens': 74, 'total_tokens': 2806, 'timestamp': '2025-05-29T20:06:53.496102+00:00'}
2025-05-30 01:06:53,518 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: c8d931e6-1d5b-475f-b5fb-9132a90e4613
2025-05-30 01:06:53,520 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 920 for interaction_id: c8d931e6-1d5b-475f-b5fb-9132a90e4613 on attempt 1
2025-05-30 01:06:53,527 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: c8d931e6-1d5b-475f-b5fb-9132a90e4613, db_id: 379
2025-05-30 01:06:53,535 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'c8d931e6-1d5b-475f-b5fb-9132a90e4613', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'rewrite_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 3654, 'completion_tokens': 42, 'total_tokens': 3696, 'timestamp': '2025-05-29T20:06:51.324436+00:00'}
2025-05-30 01:06:53,535 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: c8d931e6-1d5b-475f-b5fb-9132a90e4613
2025-05-30 01:06:53,538 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 920 for interaction_id: c8d931e6-1d5b-475f-b5fb-9132a90e4613 on attempt 1
2025-05-30 01:06:53,544 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: c8d931e6-1d5b-475f-b5fb-9132a90e4613, db_id: 380
2025-05-30 01:06:53,549 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'c8d931e6-1d5b-475f-b5fb-9132a90e4613', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'grading_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 905, 'completion_tokens': 6, 'total_tokens': 911, 'timestamp': '2025-05-29T20:06:49.588829+00:00'}
2025-05-30 01:06:53,549 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: c8d931e6-1d5b-475f-b5fb-9132a90e4613
2025-05-30 01:06:53,551 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 920 for interaction_id: c8d931e6-1d5b-475f-b5fb-9132a90e4613 on attempt 1
2025-05-30 01:06:53,555 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: c8d931e6-1d5b-475f-b5fb-9132a90e4613, db_id: 381
2025-05-30 01:07:30,603 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Сколько программистов необходимо для полного перех...'
2025-05-30 01:07:30,604 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 01:07:30,606 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 01:07:30,606 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 01:07:30,606 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 01:07:30,607 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 708bc0a7-0027-4a50-966f-66d62cca92bb)
2025-05-30 01:07:30,607 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 01:07:30,607 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 01:07:30,607 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 01:07:30,611 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 01:07:30,611 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 01:07:30,617 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 708bc0a7-0027-4a50-966f-66d62cca92bb, db_id: 921
2025-05-30 01:07:30,639 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 01:07:30,649 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 7 tools.
2025-05-30 01:07:31,606 - INFO - aiogram.event - Update id=804756305 is handled. Duration 1004 ms by bot id=1750613938
2025-05-30 01:07:32,080 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 01:07:35,681 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Для полного перехода на 1С:Управление торговлей 11 с учетом всех этапов — миграции, доработок, интег
2025-05-30 01:07:35,681 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_71b9d4b387'}
2025-05-30 01:07:35,681 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 2855, 'output_tokens': 288, 'total_tokens': 3143, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 01:07:35,681 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:2855 C:288 T:3143
2025-05-30 01:07:35,681 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 3143 tokens recorded.
2025-05-30 01:07:35,682 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 01:07:35,682 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 01:07:35,683 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Для полного перехода на 1С:Управление торговлей 11 с учетом всех этапов — миграции, доработок, интег...
2025-05-30 01:07:35,685 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 708bc0a7-0027-4a50-966f-66d62cca92bb)
2025-05-30 01:07:35,685 - INFO - AGENT:agent_airsoft_0faa9616 - Found 1 token usage events for InteractionID: 708bc0a7-0027-4a50-966f-66d62cca92bb.
2025-05-30 01:07:35,688 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Для полного перехода на 1С:Управление торговлей 11 с учетом всех этапов — миграции, доработок, интег...
2025-05-30 01:07:35,688 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Для полного перехода на 1С:Управление торговлей 11...'
2025-05-30 01:07:35,690 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '708bc0a7-0027-4a50-966f-66d62cca92bb', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 2855, 'completion_tokens': 288, 'total_tokens': 3143, 'timestamp': '2025-05-29T20:07:35.681222+00:00'}
2025-05-30 01:07:35,690 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 708bc0a7-0027-4a50-966f-66d62cca92bb
2025-05-30 01:07:35,694 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 922 for interaction_id: 708bc0a7-0027-4a50-966f-66d62cca92bb on attempt 1
2025-05-30 01:07:35,694 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 708bc0a7-0027-4a50-966f-66d62cca92bb, db_id: 922
2025-05-30 01:07:35,699 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 708bc0a7-0027-4a50-966f-66d62cca92bb, db_id: 382
2025-05-30 01:09:01,226 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Что у тебя есть по поводу налоговой в базе знаний?...'
2025-05-30 01:09:01,228 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 01:09:01,239 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 01:09:01,239 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 01:09:01,240 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 01:09:01,241 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 2e8ca95a-e46e-4cb6-995e-b6bc015f31c9)
2025-05-30 01:09:01,241 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 01:09:01,242 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 01:09:01,242 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 01:09:01,249 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 01:09:01,249 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 01:09:01,255 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 2e8ca95a-e46e-4cb6-995e-b6bc015f31c9, db_id: 923
2025-05-30 01:09:01,278 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 01:09:01,288 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 7 tools.
2025-05-30 01:09:02,240 - INFO - aiogram.event - Update id=804756306 is handled. Duration 1015 ms by bot id=1750613938
2025-05-30 01:09:02,599 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 01:09:02,662 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 01:09:02,662 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 01:09:02,662 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 3162, 'output_tokens': 23, 'total_tokens': 3185, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 01:09:02,662 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:3162 C:23 T:3185
2025-05-30 01:09:02,662 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 3185 tokens recorded.
2025-05-30 01:09:02,663 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 01:09:02,663 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: knowledgeBase-1748440512419
2025-05-30 01:09:02,663 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO RETRIEVE (knowledgeBase-1748440512419)---
2025-05-30 01:09:03,507 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 01:09:03,525 - INFO - httpx - HTTP Request: POST http://127.0.0.1:6333/collections/platformai/points/query "HTTP/1.1 200 OK"
2025-05-30 01:09:03,528 - INFO - AGENT:agent_airsoft_0faa9616 - ---CHECK RELEVANCE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 01:09:03,528 - INFO - AGENT:agent_airsoft_0faa9616 - Grading documents for question: 'Что у тебя есть по поводу налоговой в базе знаний?'
2025-05-30 01:09:03,529 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.0, streaming: False
2025-05-30 01:09:03,553 - INFO - AGENT:agent_airsoft_0faa9616 - Created grading LLM: gpt-4.1-mini via OpenAI
2025-05-30 01:09:04,444 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 01:09:04,455 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:887 C:6 T:893
2025-05-30 01:09:04,455 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for grading_llm: 893 tokens recorded.
2025-05-30 01:09:04,455 - INFO - AGENT:agent_airsoft_0faa9616 - Total token usage for grading_llm batch: 893 tokens.
2025-05-30 01:09:04,455 - INFO - AGENT:agent_airsoft_0faa9616 - Found 1 relevant documents out of 1 initial (after split).
2025-05-30 01:09:04,456 - INFO - AGENT:agent_airsoft_0faa9616 - ---ASSESS GRADED DOCUMENTS---
2025-05-30 01:09:04,456 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: RELEVANT DOCUMENTS FOUND, GENERATE---
2025-05-30 01:09:04,456 - INFO - AGENT:agent_airsoft_0faa9616 - ---GENERATE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 01:09:04,456 - INFO - AGENT:agent_airsoft_0faa9616 - Generating answer for question: 'Что у тебя есть по поводу налоговой в базе знаний?' using 1 documents.
2025-05-30 01:09:04,457 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 01:09:04,481 - INFO - AGENT:agent_airsoft_0faa9616 - Created generate LLM: gpt-4.1-mini via OpenAI
2025-05-30 01:09:05,373 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 01:09:07,201 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:857 C:139 T:996
2025-05-30 01:09:07,202 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for generation_llm: 996 tokens recorded.
2025-05-30 01:09:07,203 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: В базе есть информация о Межрайонной инспекции Федеральной налоговой службы № 32 по Свердловской обл...
2025-05-30 01:09:07,205 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 2e8ca95a-e46e-4cb6-995e-b6bc015f31c9)
2025-05-30 01:09:07,205 - INFO - AGENT:agent_airsoft_0faa9616 - Found 3 token usage events for InteractionID: 2e8ca95a-e46e-4cb6-995e-b6bc015f31c9.
2025-05-30 01:09:07,208 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: В базе есть информация о Межрайонной инспекции Федеральной налоговой службы № 32 по Свердловской обл...
2025-05-30 01:09:07,208 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'В базе есть информация о Межрайонной инспекции Фед...'
2025-05-30 01:09:07,209 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '2e8ca95a-e46e-4cb6-995e-b6bc015f31c9', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 3162, 'completion_tokens': 23, 'total_tokens': 3185, 'timestamp': '2025-05-29T20:09:02.662177+00:00'}
2025-05-30 01:09:07,209 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 2e8ca95a-e46e-4cb6-995e-b6bc015f31c9
2025-05-30 01:09:07,212 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 924 for interaction_id: 2e8ca95a-e46e-4cb6-995e-b6bc015f31c9 on attempt 1
2025-05-30 01:09:07,213 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 2e8ca95a-e46e-4cb6-995e-b6bc015f31c9, db_id: 924
2025-05-30 01:09:07,216 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 2e8ca95a-e46e-4cb6-995e-b6bc015f31c9, db_id: 383
2025-05-30 01:09:07,220 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '2e8ca95a-e46e-4cb6-995e-b6bc015f31c9', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'generation_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 857, 'completion_tokens': 139, 'total_tokens': 996, 'timestamp': '2025-05-29T20:09:07.202125+00:00'}
2025-05-30 01:09:07,220 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 2e8ca95a-e46e-4cb6-995e-b6bc015f31c9
2025-05-30 01:09:07,222 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 924 for interaction_id: 2e8ca95a-e46e-4cb6-995e-b6bc015f31c9 on attempt 1
2025-05-30 01:09:07,226 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 2e8ca95a-e46e-4cb6-995e-b6bc015f31c9, db_id: 384
2025-05-30 01:09:07,230 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '2e8ca95a-e46e-4cb6-995e-b6bc015f31c9', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'grading_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 887, 'completion_tokens': 6, 'total_tokens': 893, 'timestamp': '2025-05-29T20:09:04.455170+00:00'}
2025-05-30 01:09:07,230 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 2e8ca95a-e46e-4cb6-995e-b6bc015f31c9
2025-05-30 01:09:07,232 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 924 for interaction_id: 2e8ca95a-e46e-4cb6-995e-b6bc015f31c9 on attempt 1
2025-05-30 01:09:07,235 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 2e8ca95a-e46e-4cb6-995e-b6bc015f31c9, db_id: 385
2025-05-30 01:09:42,682 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 01:09:42,701 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 01:10:33,165 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Получи запись блога...'
2025-05-30 01:10:33,167 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 01:10:33,173 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 01:10:33,173 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 01:10:33,173 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 01:10:33,174 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 72623ae9-74c6-43cc-8e7b-7d7371d391bf)
2025-05-30 01:10:33,174 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 01:10:33,175 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 01:10:33,175 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 01:10:33,181 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 01:10:33,181 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 01:10:33,186 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 72623ae9-74c6-43cc-8e7b-7d7371d391bf, db_id: 925
2025-05-30 01:10:33,210 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 01:10:33,218 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 7 tools.
2025-05-30 01:10:34,172 - INFO - aiogram.event - Update id=804756307 is handled. Duration 1006 ms by bot id=1750613938
2025-05-30 01:10:35,271 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 01:10:35,694 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 01:10:35,694 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_38647f5e19'}
2025-05-30 01:10:35,694 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 4070, 'output_tokens': 24, 'total_tokens': 4094, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 01:10:35,694 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:4070 C:24 T:4094
2025-05-30 01:10:35,694 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 4094 tokens recorded.
2025-05-30 01:10:35,695 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 01:10:35,695 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748460000000
2025-05-30 01:10:35,695 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748460000000)---
2025-05-30 01:10:35,697 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'apiRequest-1748460000000'
2025-05-30 01:10:35,697 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://api.openweathermap.org/data/2.5/weather
2025-05-30 01:10:35,697 - ERROR - app.agent_runner.common.tools_registry - Unexpected error in API tool 'apiRequest-1748460000000': 'list' object has no attribute 'items'
Traceback (most recent call last):
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/app/agent_runner/common/tools_registry.py", line 234, in make_api_request
    response = requests.request(
               ^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/requests/api.py", line 59, in request
    return session.request(method=method, url=url, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/requests/sessions.py", line 575, in request
    prep = self.prepare_request(req)
           ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/requests/sessions.py", line 484, in prepare_request
    p.prepare(
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/requests/models.py", line 368, in prepare
    self.prepare_headers(headers)
  File "/Users/jb/Projects/PlatformAI/PlatformAI-HUB/.venv/lib/python3.12/site-packages/requests/models.py", line 488, in prepare_headers
    for header in headers.items():
                  ^^^^^^^^^^^^^
AttributeError: 'list' object has no attribute 'items'
2025-05-30 01:10:35,703 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 01:10:35,703 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 01:10:35,727 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 01:10:35,735 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 7 tools.
2025-05-30 01:10:37,018 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 01:10:37,627 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Похоже, возникла ошибка при попытке получить запись блога. Могу попробовать снова или помочь с друго
2025-05-30 01:10:37,627 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 01:10:37,627 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 4137, 'output_tokens': 32, 'total_tokens': 4169, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 01:10:37,627 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:4137 C:32 T:4169
2025-05-30 01:10:37,628 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 4169 tokens recorded.
2025-05-30 01:10:37,628 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 01:10:37,628 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 01:10:37,629 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Похоже, возникла ошибка при попытке получить запись блога. Могу попробовать снова или помочь с друго...
2025-05-30 01:10:37,631 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 72623ae9-74c6-43cc-8e7b-7d7371d391bf)
2025-05-30 01:10:37,631 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: 72623ae9-74c6-43cc-8e7b-7d7371d391bf.
2025-05-30 01:10:37,634 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Похоже, возникла ошибка при попытке получить запись блога. Могу попробовать снова или помочь с друго...
2025-05-30 01:10:37,634 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Похоже, возникла ошибка при попытке получить запис...'
2025-05-30 01:10:37,636 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '72623ae9-74c6-43cc-8e7b-7d7371d391bf', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 4070, 'completion_tokens': 24, 'total_tokens': 4094, 'timestamp': '2025-05-29T20:10:35.694648+00:00'}
2025-05-30 01:10:37,636 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 72623ae9-74c6-43cc-8e7b-7d7371d391bf
2025-05-30 01:10:37,638 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 925 for interaction_id: 72623ae9-74c6-43cc-8e7b-7d7371d391bf on attempt 1
2025-05-30 01:10:37,640 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 72623ae9-74c6-43cc-8e7b-7d7371d391bf, db_id: 926
2025-05-30 01:10:37,644 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 72623ae9-74c6-43cc-8e7b-7d7371d391bf, db_id: 386
2025-05-30 01:10:37,648 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '72623ae9-74c6-43cc-8e7b-7d7371d391bf', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 4137, 'completion_tokens': 32, 'total_tokens': 4169, 'timestamp': '2025-05-29T20:10:37.627995+00:00'}
2025-05-30 01:10:37,648 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 72623ae9-74c6-43cc-8e7b-7d7371d391bf
2025-05-30 01:10:37,650 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 926 for interaction_id: 72623ae9-74c6-43cc-8e7b-7d7371d391bf on attempt 1
2025-05-30 01:10:37,655 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 72623ae9-74c6-43cc-8e7b-7d7371d391bf, db_id: 387
2025-05-30 01:11:43,613 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 01:11:43,613 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 01:11:43,613 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 01:11:43,614 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4448340976) was cancelled.
2025-05-30 01:11:43,614 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4448340976) stopping. Performing cleanup...
2025-05-30 01:11:43,614 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 01:11:43,619 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 01:11:43,620 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 01:11:43,621 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 01:11:43,621 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 01:11:43,621 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 01:11:43,621 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4448340976) cleanup complete.
2025-05-30 01:11:43,621 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 01:11:43,621 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 01:11:43,621 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4447483520) was cancelled.
2025-05-30 01:11:43,621 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4447483520) stopping. Performing cleanup...
2025-05-30 01:11:43,621 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 01:11:43,628 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 01:11:43,629 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 01:11:43,629 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 01:11:43,629 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 01:11:43,629 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 01:11:43,629 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4447483520) cleanup complete.
2025-05-30 01:11:43,629 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 01:11:43,629 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 01:11:43,629 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4448351632) was cancelled.
2025-05-30 01:11:43,629 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4448351632) stopping. Performing cleanup...
2025-05-30 01:11:43,629 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 01:11:43,629 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 01:11:43,629 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 01:11:43,629 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 01:11:43,630 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 01:11:43,633 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 01:11:43,634 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 01:11:43,634 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 01:11:43,634 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 01:11:43,634 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 01:11:43,634 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 01:11:43,634 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4448351632) cleanup complete.
2025-05-30 01:11:43,634 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 01:11:43,635 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 01:11:43,635 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 01:11:43,647 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 01:11:43,647 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 01:11:44,160 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 01:11:44,160 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 01:11:44,165 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 01:11:44,165 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 01:11:44,165 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 01:11:44,165 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 01:11:44,165 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 01:11:44,165 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 01:11:44,165 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 01:11:44,165 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 01:11:44,165 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 01:11:44,165 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 01:11:44,165 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 01:11:44,168 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 01:11:44,168 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 01:11:44,168 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 01:11:44,184 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 01:11:44,184 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 01:11:44,184 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 01:11:44,184 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 01:11:44,187 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 01:11:44,187 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 01:11:44,187 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4412669152) setup complete. Starting run loop.
2025-05-30 01:11:44,187 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 01:11:44,187 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 01:11:44,187 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4414551344) setup complete. Starting run loop.
2025-05-30 01:11:44,187 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 01:11:44,188 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 01:11:44,188 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 01:11:44,225 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 01:11:44,225 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 01:11:44,226 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 01:11:44,226 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 01:11:44,226 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 01:11:44,227 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 01:11:44,228 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 01:11:44,228 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 01:11:44,228 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 01:11:44,228 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 01:11:54,102 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 01:11:54,102 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 01:11:54,102 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 01:11:54,103 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4412669152) was cancelled.
2025-05-30 01:11:54,103 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4412669152) stopping. Performing cleanup...
2025-05-30 01:11:54,103 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 01:11:54,107 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 01:11:54,108 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 01:11:54,108 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 01:11:54,108 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 01:11:54,108 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 01:11:54,108 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4412669152) cleanup complete.
2025-05-30 01:11:54,108 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 01:11:54,108 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 01:11:54,108 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4414551344) was cancelled.
2025-05-30 01:11:54,108 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4414551344) stopping. Performing cleanup...
2025-05-30 01:11:54,108 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 01:11:54,112 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 01:11:54,112 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 01:11:54,113 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 01:11:54,113 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 01:11:54,113 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 01:11:54,113 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4414551344) cleanup complete.
2025-05-30 01:11:54,113 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 01:11:54,113 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 01:11:54,113 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4414551008) was cancelled.
2025-05-30 01:11:54,113 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4414551008) stopping. Performing cleanup...
2025-05-30 01:11:54,113 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 01:11:54,113 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 01:11:54,113 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 01:11:54,113 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 01:11:54,113 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 01:11:54,115 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 01:11:54,116 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 01:11:54,116 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 01:11:54,116 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 01:11:54,116 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 01:11:54,116 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 01:11:54,116 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4414551008) cleanup complete.
2025-05-30 01:11:54,116 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 01:11:54,116 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 01:11:54,116 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 01:11:54,120 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 01:11:54,120 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 01:11:54,487 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 01:11:54,487 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 01:11:54,492 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 01:11:54,492 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 01:11:54,492 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 01:11:54,492 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 01:11:54,492 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 01:11:54,492 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 01:11:54,492 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 01:11:54,492 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 01:11:54,492 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 01:11:54,493 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 01:11:54,493 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 01:11:54,496 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 01:11:54,496 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 01:11:54,496 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 01:11:54,511 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 01:11:54,511 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 01:11:54,511 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 01:11:54,511 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 01:11:54,512 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 01:11:54,514 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 01:11:54,514 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4592835744) setup complete. Starting run loop.
2025-05-30 01:11:54,514 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 01:11:54,514 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 01:11:54,514 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4595341536) setup complete. Starting run loop.
2025-05-30 01:11:54,514 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 01:11:54,516 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 01:11:54,516 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 01:11:54,546 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 01:11:54,546 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 01:11:54,547 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 01:11:54,547 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 01:11:54,547 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 01:11:54,548 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 01:11:54,549 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 01:11:54,549 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 01:11:54,549 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 01:11:54,549 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 01:12:04,517 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 01:12:04,522 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 01:12:04,522 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4595344080) setup complete. Starting run loop.
2025-05-30 01:12:04,522 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 01:12:09,944 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 01:12:09,944 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 01:12:09,944 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 01:12:09,944 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4592835744) was cancelled.
2025-05-30 01:12:09,944 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4592835744) stopping. Performing cleanup...
2025-05-30 01:12:09,944 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 01:12:09,951 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 01:12:09,952 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 01:12:09,952 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 01:12:09,952 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 01:12:09,952 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 01:12:09,952 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4592835744) cleanup complete.
2025-05-30 01:12:09,952 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 01:12:09,952 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 01:12:09,952 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4595341536) was cancelled.
2025-05-30 01:12:09,952 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4595341536) stopping. Performing cleanup...
2025-05-30 01:12:09,952 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 01:12:09,956 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 01:12:09,957 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 01:12:09,957 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 01:12:09,957 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 01:12:09,957 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 01:12:09,957 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4595341536) cleanup complete.
2025-05-30 01:12:09,957 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 01:12:09,957 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 01:12:09,957 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4595344080) was cancelled.
2025-05-30 01:12:09,957 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4595344080) stopping. Performing cleanup...
2025-05-30 01:12:09,957 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 01:12:09,957 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 01:12:09,958 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 01:12:09,958 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 01:12:09,958 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 01:12:09,960 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 01:12:09,960 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 01:12:09,960 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 01:12:09,961 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 01:12:09,961 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 01:12:09,961 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 01:12:09,961 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4595344080) cleanup complete.
2025-05-30 01:12:09,961 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 01:12:09,961 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 01:12:09,961 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 01:12:09,965 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 01:12:09,965 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 01:12:10,383 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 01:12:10,383 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 01:12:10,387 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 01:12:10,387 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 01:12:10,387 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 01:12:10,387 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 01:12:10,387 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 01:12:10,387 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 01:12:10,387 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 01:12:10,387 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 01:12:10,388 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 01:12:10,388 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 01:12:10,388 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 01:12:10,390 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 01:12:10,390 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 01:12:10,390 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 01:12:10,390 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 01:12:10,390 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 01:12:10,390 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 01:12:10,390 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 01:12:10,405 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 01:12:10,405 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4418456416) setup complete. Starting run loop.
2025-05-30 01:12:10,405 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 01:12:10,405 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 01:12:10,406 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 01:12:10,406 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4418467216) setup complete. Starting run loop.
2025-05-30 01:12:10,406 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 01:12:10,408 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 01:12:10,408 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 01:12:10,438 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 01:12:10,438 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 01:12:10,439 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 01:12:10,439 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 01:12:10,439 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 01:12:10,440 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 01:12:10,441 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 01:12:10,441 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 01:12:10,441 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 01:12:10,441 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 01:12:20,409 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 01:12:20,413 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 01:12:20,413 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4418467024) setup complete. Starting run loop.
2025-05-30 01:12:20,413 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 01:12:20,503 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 01:12:20,503 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 01:12:20,503 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 01:12:20,504 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4418456416) was cancelled.
2025-05-30 01:12:20,504 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4418456416) stopping. Performing cleanup...
2025-05-30 01:12:20,504 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 01:12:20,509 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 01:12:20,510 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 01:12:20,510 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 01:12:20,510 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 01:12:20,510 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 01:12:20,510 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4418456416) cleanup complete.
2025-05-30 01:12:20,510 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 01:12:20,510 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 01:12:20,510 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4418467216) was cancelled.
2025-05-30 01:12:20,510 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4418467216) stopping. Performing cleanup...
2025-05-30 01:12:20,510 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 01:12:20,514 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 01:12:20,515 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 01:12:20,515 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 01:12:20,515 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 01:12:20,515 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 01:12:20,515 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4418467216) cleanup complete.
2025-05-30 01:12:20,515 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 01:12:20,515 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 01:12:20,516 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4418467024) was cancelled.
2025-05-30 01:12:20,516 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4418467024) stopping. Performing cleanup...
2025-05-30 01:12:20,516 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 01:12:20,516 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 01:12:20,516 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 01:12:20,516 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 01:12:20,516 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 01:12:20,517 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 01:12:20,518 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 01:12:20,518 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 01:12:20,519 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 01:12:20,519 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 01:12:20,519 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 01:12:20,519 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4418467024) cleanup complete.
2025-05-30 01:12:20,519 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 01:12:20,519 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 01:12:20,519 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 01:12:20,522 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 01:12:20,522 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 01:12:20,953 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 01:12:20,953 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 01:12:20,957 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 01:12:20,957 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 01:12:20,957 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 01:12:20,957 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 01:12:20,957 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 01:12:20,957 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 01:12:20,957 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 01:12:20,957 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 01:12:20,957 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 01:12:20,958 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 01:12:20,958 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 01:12:20,960 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 01:12:20,960 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 01:12:20,960 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 01:12:20,977 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 01:12:20,977 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 01:12:20,977 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 01:12:20,977 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 01:12:20,978 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 01:12:20,978 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4655435264) setup complete. Starting run loop.
2025-05-30 01:12:20,978 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 01:12:20,979 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 01:12:20,980 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 01:12:20,980 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4655445344) setup complete. Starting run loop.
2025-05-30 01:12:20,980 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 01:12:20,982 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 01:12:20,982 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 01:12:21,012 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 01:12:21,012 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 01:12:21,013 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 01:12:21,013 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 01:12:21,013 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 01:12:21,014 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 01:12:21,015 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 01:12:21,015 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 01:12:21,015 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 01:12:21,015 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 01:12:23,630 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 01:12:23,630 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 01:12:23,630 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4837740416) received shutdown request. Initiating graceful shutdown...
2025-05-30 01:12:23,630 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4837740416)...
2025-05-30 01:12:23,630 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 01:12:23,630 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 01:12:23,631 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4837740416) was cancelled.
2025-05-30 01:12:23,631 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4837740416) stopping. Performing cleanup...
2025-05-30 01:12:23,631 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 01:12:23,631 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 01:12:23,631 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 01:12:23,633 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-30 01:12:23,633 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 01:12:23,633 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 01:12:23,633 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 01:12:23,633 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 01:12:23,634 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 01:12:23,634 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 01:12:23,634 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 01:12:23,638 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 01:12:23,639 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 01:12:23,639 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 01:12:23,639 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 01:12:23,639 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 01:12:23,639 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 01:12:23,640 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4837740416) cleanup complete.
2025-05-30 01:12:23,640 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 01:12:23,640 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 01:12:23,645 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 01:12:23,646 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 01:12:23,646 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 01:12:23,646 - INFO - __main__ - Agent runner main finished.
2025-05-30 01:12:23,831 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 01:12:23,831 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 01:12:23,831 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 01:12:23,832 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4655435264) was cancelled.
2025-05-30 01:12:23,832 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4655435264) stopping. Performing cleanup...
2025-05-30 01:12:23,832 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 01:12:23,837 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 01:12:23,838 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 01:12:23,838 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 01:12:23,838 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 01:12:23,838 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 01:12:23,838 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4655435264) cleanup complete.
2025-05-30 01:12:23,838 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 01:12:23,838 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 01:12:23,838 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4655445344) was cancelled.
2025-05-30 01:12:23,838 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4655445344) stopping. Performing cleanup...
2025-05-30 01:12:23,838 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 01:12:23,842 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 01:12:23,843 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 01:12:23,843 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 01:12:23,843 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 01:12:23,843 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 01:12:23,843 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4655445344) cleanup complete.
2025-05-30 01:12:23,843 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 01:12:23,843 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 01:12:23,843 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4655445392) was cancelled.
2025-05-30 01:12:23,843 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4655445392) stopping. Performing cleanup...
2025-05-30 01:12:23,843 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 01:12:23,843 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 01:12:23,844 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 01:12:23,844 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 01:12:23,844 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 01:12:23,845 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 01:12:23,847 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 01:12:23,847 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 01:12:23,847 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 01:12:23,847 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 01:12:23,847 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 01:12:23,847 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4655445392) cleanup complete.
2025-05-30 01:12:23,847 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 01:12:23,847 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 01:12:23,847 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 01:12:23,850 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 01:12:23,850 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 01:12:23,882 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 01:12:23,882 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 01:12:23,882 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 01:12:23,882 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4918928704) received shutdown request. Initiating graceful shutdown...
2025-05-30 01:12:23,882 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4918928704)...
2025-05-30 01:12:23,882 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 01:12:23,882 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 01:12:23,882 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4918928704) was cancelled.
2025-05-30 01:12:23,882 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4918928704) stopping. Performing cleanup...
2025-05-30 01:12:23,882 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 01:12:23,882 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 01:12:23,882 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 01:12:23,882 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 01:12:23,882 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 01:12:23,882 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 01:12:23,882 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 01:12:23,883 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 01:12:23,883 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 01:12:23,883 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 01:12:23,887 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 01:12:23,888 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 01:12:23,888 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 01:12:23,888 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 01:12:23,888 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 01:12:23,888 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 01:12:23,888 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4918928704) cleanup complete.
2025-05-30 01:12:23,888 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 01:12:23,888 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 01:12:23,894 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 01:12:23,894 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 01:12:23,894 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 01:12:23,895 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 01:21:42,439 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 01:21:42,439 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 01:21:42,444 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 01:21:42,444 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 01:21:42,444 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 01:21:42,444 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 01:21:42,444 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 01:21:42,445 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 01:21:42,445 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 01:21:42,445 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 01:21:42,445 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 01:21:42,445 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 01:21:42,445 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 01:21:42,447 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 01:21:42,447 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 01:21:42,447 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 01:21:42,447 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 01:21:42,448 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 01:21:42,448 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 01:21:42,448 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 01:21:42,465 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 01:21:42,468 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 01:21:42,468 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4447278416) setup complete. Starting run loop.
2025-05-30 01:21:42,468 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 01:21:42,468 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 01:21:42,468 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4440897344) setup complete. Starting run loop.
2025-05-30 01:21:42,468 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 01:21:42,469 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 01:21:42,469 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 01:21:42,500 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 01:21:42,500 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 01:21:42,501 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 01:21:42,503 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 12994
2025-05-30 01:21:42,503 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 12994
2025-05-30 01:21:42,503 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 01:21:42,503 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 01:21:42,503 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 01:21:42,505 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 01:21:42,506 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 12995
2025-05-30 01:21:42,506 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 12995
2025-05-30 01:21:42,506 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 01:21:42,507 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 01:21:42,507 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 01:21:42,507 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 01:21:42,507 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 01:21:43,454 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 01:21:43,455 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 01:21:43,455 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 01:21:43,455 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 01:21:43,455 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 12995
2025-05-30 01:21:43,455 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 01:21:43,455 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 01:21:43,455 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 01:21:43,460 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 01:21:43,473 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 01:21:43,473 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 01:21:43,473 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 01:21:43,473 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4738491856) setup complete. Starting run loop.
2025-05-30 01:21:43,474 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 01:21:43,474 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 01:21:43,474 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 01:21:43,474 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 01:21:43,474 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 01:21:43,474 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 01:21:43,474 - INFO - aiogram.dispatcher - Start polling
2025-05-30 01:21:43,476 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 01:21:43,726 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 01:21:43,839 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 01:21:43,840 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 01:21:43,840 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 01:21:43,840 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 01:21:43,840 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 12994
2025-05-30 01:21:43,840 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 01:21:43,840 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 01:21:43,840 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 01:21:43,883 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 01:21:43,883 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 01:21:43,928 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 01:21:43,928 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 01:21:43,928 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 01:21:43,928 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 01:21:43,928 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 01:21:43,928 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 01:21:43,954 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 01:21:43,954 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 01:21:43,954 - INFO - app.agent_runner.common.tools_registry - Configured 3 predefined tools from centralized registry
2025-05-30 01:21:43,954 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000000 (method: GET)
2025-05-30 01:21:43,954 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (method: GET)
2025-05-30 01:21:43,954 - INFO - AGENT:agent_airsoft_0faa9616 - Added 5 tools from centralized registry
2025-05-30 01:21:43,954 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 01:21:44,012 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 01:21:44,016 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 01:21:44,973 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 01:21:44,976 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 01:21:44,976 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 01:21:44,976 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 01:21:44,976 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 01:21:44,976 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 01:21:44,976 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 7 (6 safe, 1 datastore).
2025-05-30 01:21:44,976 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 7 total, 6 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 01:21:44,976 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 01:21:44,977 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 01:21:44,978 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 01:21:44,987 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 01:21:44,987 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 01:21:44,987 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 01:21:44,987 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 01:21:44,987 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 01:21:44,998 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 01:21:44,998 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 01:21:44,998 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 01:21:44,998 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4932144880) setup complete. Starting run loop.
2025-05-30 01:21:44,998 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 01:21:44,998 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 01:21:44,998 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 01:21:44,998 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 01:21:45,001 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 01:21:52,470 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 01:21:52,476 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 01:21:52,476 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4447286288) setup complete. Starting run loop.
2025-05-30 01:21:52,476 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 01:22:14,596 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Получи запись блога...'
2025-05-30 01:22:14,597 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 01:22:14,669 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 01:22:14,669 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 01:22:14,670 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 01:22:14,670 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 25624ec3-c760-4f6f-9e24-026774a0b1c3)
2025-05-30 01:22:14,670 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 01:22:14,671 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-30 01:22:14,696 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 25624ec3-c760-4f6f-9e24-026774a0b1c3, db_id: 927
2025-05-30 01:22:14,709 - INFO - AGENT:agent_airsoft_0faa9616 - Loaded 20 messages from DB for thread '144641834'.
2025-05-30 01:22:14,710 - INFO - AGENT:agent_airsoft_0faa9616 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-30 01:22:14,710 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-30 01:22:14,783 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 01:22:14,783 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 01:22:14,809 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 01:22:14,817 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 7 tools.
2025-05-30 01:22:15,670 - INFO - aiogram.event - Update id=804756308 is handled. Duration 1073 ms by bot id=1750613938
2025-05-30 01:22:15,947 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 01:22:16,060 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 01:22:16,060 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_71b9d4b387'}
2025-05-30 01:22:16,060 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1774, 'output_tokens': 23, 'total_tokens': 1797, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 01:22:16,060 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1774 C:23 T:1797
2025-05-30 01:22:16,061 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1797 tokens recorded.
2025-05-30 01:22:16,061 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 01:22:16,061 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748460000000
2025-05-30 01:22:16,061 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748460000000)---
2025-05-30 01:22:16,063 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'apiRequest-1748460000000'
2025-05-30 01:22:16,063 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://api.openweathermap.org/data/2.5/weather
2025-05-30 01:22:16,286 - ERROR - app.agent_runner.common.tools_registry - HTTP error making GET request to https://api.openweathermap.org/data/2.5/weather: 401 {"cod":401, "message": "Invalid API key. Please see https://openweathermap.org/faq#error401 for more info."}
2025-05-30 01:22:16,288 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 01:22:16,288 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 01:22:16,313 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 01:22:16,320 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 7 tools.
2025-05-30 01:22:17,079 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 01:22:17,735 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: К сожалению, не удалось получить запись блога из-за ошибки с доступом к API (недействительный ключ).
2025-05-30 01:22:17,735 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 01:22:17,735 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1864, 'output_tokens': 52, 'total_tokens': 1916, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 01:22:17,735 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1864 C:52 T:1916
2025-05-30 01:22:17,735 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1916 tokens recorded.
2025-05-30 01:22:17,736 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 01:22:17,736 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 01:22:17,737 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: К сожалению, не удалось получить запись блога из-за ошибки с доступом к API (недействительный ключ)....
2025-05-30 01:22:17,739 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 25624ec3-c760-4f6f-9e24-026774a0b1c3)
2025-05-30 01:22:17,739 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: 25624ec3-c760-4f6f-9e24-026774a0b1c3.
2025-05-30 01:22:17,742 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: К сожалению, не удалось получить запись блога из-за ошибки с доступом к API (недействительный ключ)....
2025-05-30 01:22:17,742 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'К сожалению, не удалось получить запись блога из-з...'
2025-05-30 01:22:17,743 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '25624ec3-c760-4f6f-9e24-026774a0b1c3', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1774, 'completion_tokens': 23, 'total_tokens': 1797, 'timestamp': '2025-05-29T20:22:16.061006+00:00'}
2025-05-30 01:22:17,743 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 25624ec3-c760-4f6f-9e24-026774a0b1c3
2025-05-30 01:22:17,746 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 25624ec3-c760-4f6f-9e24-026774a0b1c3, db_id: 928
2025-05-30 01:22:17,779 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 928 for interaction_id: 25624ec3-c760-4f6f-9e24-026774a0b1c3 on attempt 1
2025-05-30 01:22:17,784 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 25624ec3-c760-4f6f-9e24-026774a0b1c3, db_id: 388
2025-05-30 01:22:17,786 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '25624ec3-c760-4f6f-9e24-026774a0b1c3', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1864, 'completion_tokens': 52, 'total_tokens': 1916, 'timestamp': '2025-05-29T20:22:17.735541+00:00'}
2025-05-30 01:22:17,786 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 25624ec3-c760-4f6f-9e24-026774a0b1c3
2025-05-30 01:22:17,788 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 928 for interaction_id: 25624ec3-c760-4f6f-9e24-026774a0b1c3 on attempt 1
2025-05-30 01:22:17,791 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 25624ec3-c760-4f6f-9e24-026774a0b1c3, db_id: 389
2025-05-30 01:23:04,880 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Я просил запись блога, а не погоду...'
2025-05-30 01:23:04,883 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 01:23:04,890 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 01:23:04,890 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 01:23:04,890 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 01:23:04,891 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 8588bbdd-7dfe-4599-a264-948fdac26397)
2025-05-30 01:23:04,891 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 01:23:04,892 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 01:23:04,892 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 01:23:04,897 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 01:23:04,897 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 01:23:04,904 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 8588bbdd-7dfe-4599-a264-948fdac26397, db_id: 929
2025-05-30 01:23:04,927 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 01:23:04,936 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 7 tools.
2025-05-30 01:23:05,890 - INFO - aiogram.event - Update id=804756309 is handled. Duration 1010 ms by bot id=1750613938
2025-05-30 01:23:06,175 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 01:23:06,915 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 01:23:06,915 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 01:23:06,916 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1934, 'output_tokens': 23, 'total_tokens': 1957, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 01:23:06,916 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1934 C:23 T:1957
2025-05-30 01:23:06,916 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1957 tokens recorded.
2025-05-30 01:23:06,917 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 01:23:06,917 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748460000001
2025-05-30 01:23:06,917 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748460000001)---
2025-05-30 01:23:06,918 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'apiRequest-1748460000001'
2025-05-30 01:23:06,918 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://jsonplaceholder.typicode.com/posts
2025-05-30 01:23:07,285 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 01:23:07,286 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 01:23:07,310 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 01:23:07,318 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 7 tools.
2025-05-30 01:23:08,871 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 01:23:11,019 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Вот пример записи блога из JSONPlaceholder:

### Заголовок:
sunt aut facere repellat provident occae
2025-05-30 01:23:11,019 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 01:23:11,019 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 9661, 'output_tokens': 88, 'total_tokens': 9749, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 01:23:11,019 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:9661 C:88 T:9749
2025-05-30 01:23:11,019 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 9749 tokens recorded.
2025-05-30 01:23:11,020 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 01:23:11,020 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 01:23:11,021 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Вот пример записи блога из JSONPlaceholder:

### Заголовок:
sunt aut facere repellat provident occae...
2025-05-30 01:23:11,023 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 8588bbdd-7dfe-4599-a264-948fdac26397)
2025-05-30 01:23:11,023 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: 8588bbdd-7dfe-4599-a264-948fdac26397.
2025-05-30 01:23:11,025 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Вот пример записи блога из JSONPlaceholder:

### Заголовок:
sunt aut facere repellat provident occae...
2025-05-30 01:23:11,025 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Вот пример записи блога из JSONPlaceholder:

### З...'
2025-05-30 01:23:11,027 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '8588bbdd-7dfe-4599-a264-948fdac26397', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1934, 'completion_tokens': 23, 'total_tokens': 1957, 'timestamp': '2025-05-29T20:23:06.916039+00:00'}
2025-05-30 01:23:11,027 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 8588bbdd-7dfe-4599-a264-948fdac26397
2025-05-30 01:23:11,031 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 930 for interaction_id: 8588bbdd-7dfe-4599-a264-948fdac26397 on attempt 1
2025-05-30 01:23:11,032 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 8588bbdd-7dfe-4599-a264-948fdac26397, db_id: 930
2025-05-30 01:23:11,035 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 8588bbdd-7dfe-4599-a264-948fdac26397, db_id: 390
2025-05-30 01:23:11,039 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '8588bbdd-7dfe-4599-a264-948fdac26397', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 9661, 'completion_tokens': 88, 'total_tokens': 9749, 'timestamp': '2025-05-29T20:23:11.019548+00:00'}
2025-05-30 01:23:11,039 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 8588bbdd-7dfe-4599-a264-948fdac26397
2025-05-30 01:23:11,040 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 930 for interaction_id: 8588bbdd-7dfe-4599-a264-948fdac26397 on attempt 1
2025-05-30 01:23:11,044 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 8588bbdd-7dfe-4599-a264-948fdac26397, db_id: 391
2025-05-30 01:23:54,735 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'сколько у меня бонусных баллов?...'
2025-05-30 01:23:54,737 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 01:23:54,743 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 01:23:54,743 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 01:23:54,743 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 01:23:54,744 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 72380d1f-c210-4930-9704-d8e8f9f75895)
2025-05-30 01:23:54,744 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 01:23:54,745 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 01:23:54,745 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 01:23:54,751 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 01:23:54,751 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 01:23:54,754 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 72380d1f-c210-4930-9704-d8e8f9f75895, db_id: 931
2025-05-30 01:23:54,779 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 01:23:54,788 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 7 tools.
2025-05-30 01:23:55,743 - INFO - aiogram.event - Update id=804756310 is handled. Duration 1008 ms by bot id=1750613938
2025-05-30 01:23:56,658 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 01:23:56,699 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 01:23:56,699 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 01:23:56,699 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 9765, 'output_tokens': 11, 'total_tokens': 9776, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 01:23:56,699 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:9765 C:11 T:9776
2025-05-30 01:23:56,699 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 9776 tokens recorded.
2025-05-30 01:23:56,700 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 01:23:56,700 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: get_bonus_points
2025-05-30 01:23:56,700 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (get_bonus_points)---
2025-05-30 01:23:57,176 - ERROR - app.agent_runner.common.tools_registry - Request exception fetching bonus points: 403 Client Error: Forbidden for url: https://airsoft-rus.ru/obmen_rus/bals.php?type=info&tel=79222088435
2025-05-30 01:23:57,178 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 01:23:57,178 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 01:23:57,202 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 01:23:57,209 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 7 tools.
2025-05-30 01:23:58,707 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 01:23:59,130 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: К сожалению, не удалось получить информацию о твоих бонусных баллах из-за ошибки доступа. Могу помоч
2025-05-30 01:23:59,131 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 01:23:59,131 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 9830, 'output_tokens': 29, 'total_tokens': 9859, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 01:23:59,131 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:9830 C:29 T:9859
2025-05-30 01:23:59,131 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 9859 tokens recorded.
2025-05-30 01:23:59,132 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 01:23:59,132 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 01:23:59,133 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: К сожалению, не удалось получить информацию о твоих бонусных баллах из-за ошибки доступа. Могу помоч...
2025-05-30 01:23:59,135 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 72380d1f-c210-4930-9704-d8e8f9f75895)
2025-05-30 01:23:59,135 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: 72380d1f-c210-4930-9704-d8e8f9f75895.
2025-05-30 01:23:59,138 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: К сожалению, не удалось получить информацию о твоих бонусных баллах из-за ошибки доступа. Могу помоч...
2025-05-30 01:23:59,138 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'К сожалению, не удалось получить информацию о твои...'
2025-05-30 01:23:59,139 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '72380d1f-c210-4930-9704-d8e8f9f75895', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 9765, 'completion_tokens': 11, 'total_tokens': 9776, 'timestamp': '2025-05-29T20:23:56.699403+00:00'}
2025-05-30 01:23:59,139 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 72380d1f-c210-4930-9704-d8e8f9f75895
2025-05-30 01:23:59,141 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 932 for interaction_id: 72380d1f-c210-4930-9704-d8e8f9f75895 on attempt 1
2025-05-30 01:23:59,142 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 72380d1f-c210-4930-9704-d8e8f9f75895, db_id: 932
2025-05-30 01:23:59,146 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 72380d1f-c210-4930-9704-d8e8f9f75895, db_id: 392
2025-05-30 01:23:59,149 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '72380d1f-c210-4930-9704-d8e8f9f75895', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 9830, 'completion_tokens': 29, 'total_tokens': 9859, 'timestamp': '2025-05-29T20:23:59.131065+00:00'}
2025-05-30 01:23:59,149 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 72380d1f-c210-4930-9704-d8e8f9f75895
2025-05-30 01:23:59,150 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 932 for interaction_id: 72380d1f-c210-4930-9704-d8e8f9f75895 on attempt 1
2025-05-30 01:23:59,154 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 72380d1f-c210-4930-9704-d8e8f9f75895, db_id: 393
2025-05-30 01:24:32,318 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 01:24:32,318 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 01:24:32,319 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4932144880) received shutdown request. Initiating graceful shutdown...
2025-05-30 01:24:32,319 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4932144880)...
2025-05-30 01:24:32,319 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 01:24:32,319 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 01:24:32,319 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4932144880) was cancelled.
2025-05-30 01:24:32,319 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4932144880) stopping. Performing cleanup...
2025-05-30 01:24:32,319 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 01:24:32,319 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 01:24:32,319 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 01:24:32,320 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-30 01:24:32,320 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 01:24:32,320 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 01:24:32,320 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 01:24:32,320 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 01:24:32,320 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 01:24:32,320 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 01:24:32,320 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 01:24:32,325 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 01:24:32,326 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 01:24:32,326 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 01:24:32,326 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 01:24:32,326 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 01:24:32,326 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 01:24:32,326 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4932144880) cleanup complete.
2025-05-30 01:24:32,326 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 01:24:32,326 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 01:24:32,331 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 01:24:32,331 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 01:24:32,331 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 01:24:32,332 - INFO - __main__ - Agent runner main finished.
2025-05-30 01:24:32,470 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 01:24:32,470 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 01:24:32,471 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 01:24:32,471 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4440897344) was cancelled.
2025-05-30 01:24:32,471 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4440897344) stopping. Performing cleanup...
2025-05-30 01:24:32,471 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 01:24:32,475 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 01:24:32,476 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 01:24:32,476 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 01:24:32,476 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 01:24:32,476 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 01:24:32,476 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4440897344) cleanup complete.
2025-05-30 01:24:32,477 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 01:24:32,477 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 01:24:32,477 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4447278416) was cancelled.
2025-05-30 01:24:32,477 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4447278416) stopping. Performing cleanup...
2025-05-30 01:24:32,477 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 01:24:32,479 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 01:24:32,480 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 01:24:32,480 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 01:24:32,480 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 01:24:32,480 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 01:24:32,480 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4447278416) cleanup complete.
2025-05-30 01:24:32,480 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 01:24:32,480 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 01:24:32,481 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4447286288) was cancelled.
2025-05-30 01:24:32,481 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4447286288) stopping. Performing cleanup...
2025-05-30 01:24:32,481 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 01:24:32,481 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 01:24:32,481 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 01:24:32,481 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 01:24:32,481 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 01:24:32,484 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 01:24:32,485 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 01:24:32,485 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 01:24:32,485 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 01:24:32,485 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 01:24:32,485 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 01:24:32,485 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4447286288) cleanup complete.
2025-05-30 01:24:32,486 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 01:24:32,486 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 01:24:32,486 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 01:24:32,494 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 01:24:32,494 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 01:24:32,571 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 01:24:32,571 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 01:24:32,571 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 01:24:32,571 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4738491856) received shutdown request. Initiating graceful shutdown...
2025-05-30 01:24:32,571 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4738491856)...
2025-05-30 01:24:32,571 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 01:24:32,571 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 01:24:32,571 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4738491856) was cancelled.
2025-05-30 01:24:32,571 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4738491856) stopping. Performing cleanup...
2025-05-30 01:24:32,571 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 01:24:32,571 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 01:24:32,571 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 01:24:32,572 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 01:24:32,572 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 01:24:32,572 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 01:24:32,572 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 01:24:32,572 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 01:24:32,572 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 01:24:32,572 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 01:24:32,578 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 01:24:32,579 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 01:24:32,579 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 01:24:32,579 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 01:24:32,579 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 01:24:32,579 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 01:24:32,579 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4738491856) cleanup complete.
2025-05-30 01:24:32,579 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 01:24:32,579 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 01:24:32,582 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 01:24:32,582 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 01:24:32,582 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 01:24:32,585 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 12:07:44,759 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 12:07:44,759 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 12:07:44,767 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 12:07:44,767 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 12:07:44,767 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 12:07:44,767 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 12:07:44,767 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 12:07:44,768 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 12:07:44,768 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 12:07:44,768 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 12:07:44,768 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 12:07:44,768 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 12:07:44,768 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 12:07:44,771 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 12:07:44,790 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 12:07:44,790 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 12:07:44,790 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 12:07:44,790 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 12:07:44,790 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 12:07:44,790 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 12:07:44,793 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 12:07:44,793 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4378113760) setup complete. Starting run loop.
2025-05-30 12:07:44,793 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 12:07:44,793 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 12:07:44,794 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 12:07:44,794 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4378113472) setup complete. Starting run loop.
2025-05-30 12:07:44,794 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 12:07:44,795 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 12:07:44,795 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 12:07:44,828 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 12:07:44,828 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 12:07:44,831 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 12:07:44,832 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 20854
2025-05-30 12:07:44,832 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 20854
2025-05-30 12:07:44,832 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 12:07:44,832 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 12:07:44,832 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 12:07:44,834 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 12:07:44,835 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 20855
2025-05-30 12:07:44,835 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 20855
2025-05-30 12:07:44,835 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 12:07:44,836 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:07:44,836 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 12:07:44,836 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 12:07:44,836 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 12:07:45,779 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 12:07:45,780 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 12:07:45,780 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 12:07:45,780 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 12:07:45,780 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 20855
2025-05-30 12:07:45,780 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 12:07:45,780 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 12:07:45,780 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 12:07:45,786 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 12:07:45,799 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 12:07:45,799 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 12:07:45,799 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 12:07:45,799 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4835928080) setup complete. Starting run loop.
2025-05-30 12:07:45,799 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 12:07:45,799 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 12:07:45,799 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 12:07:45,799 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 12:07:45,799 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 12:07:45,799 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 12:07:45,799 - INFO - aiogram.dispatcher - Start polling
2025-05-30 12:07:45,803 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 12:07:46,107 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 12:07:46,218 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 12:07:46,218 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 12:07:46,218 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 12:07:46,218 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 12:07:46,218 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 20854
2025-05-30 12:07:46,218 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 12:07:46,218 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 12:07:46,218 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 12:07:46,262 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 12:07:46,263 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 12:07:46,306 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 12:07:46,307 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 12:07:46,307 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 12:07:46,307 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 12:07:46,307 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 12:07:46,307 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 12:07:46,333 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 12:07:46,333 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 12:07:46,333 - INFO - app.agent_runner.common.tools_registry - Configured 3 predefined tools from centralized registry
2025-05-30 12:07:46,333 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000000 (method: GET)
2025-05-30 12:07:46,333 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (method: GET)
2025-05-30 12:07:46,333 - INFO - AGENT:agent_airsoft_0faa9616 - Added 5 tools from centralized registry
2025-05-30 12:07:46,333 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 12:07:46,390 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 12:07:46,395 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 12:07:47,539 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 12:07:47,622 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 12:07:47,623 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 12:07:47,623 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 12:07:47,623 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 12:07:47,623 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 12:07:47,623 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 7 (6 safe, 1 datastore).
2025-05-30 12:07:47,623 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 7 total, 6 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 12:07:47,623 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 12:07:47,624 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 12:07:47,624 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 12:07:47,634 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 12:07:47,634 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 12:07:47,634 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 12:07:47,634 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 12:07:47,634 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 12:07:47,644 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 12:07:47,645 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 12:07:47,645 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 12:07:47,645 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4531572464) setup complete. Starting run loop.
2025-05-30 12:07:47,645 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 12:07:47,645 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 12:07:47,645 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 12:07:47,645 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 12:07:47,647 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 12:07:54,795 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 12:07:54,800 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 12:07:54,800 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4372128752) setup complete. Starting run loop.
2025-05-30 12:07:54,800 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 12:12:54,977 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 12:12:54,988 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 12:17:12,178 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 12:17:12,179 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 12:17:12,179 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 12:17:12,179 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4378113760) was cancelled.
2025-05-30 12:17:12,179 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4378113760) stopping. Performing cleanup...
2025-05-30 12:17:12,179 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 12:17:12,184 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 12:17:12,185 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 12:17:12,185 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:17:12,185 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 12:17:12,185 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 12:17:12,185 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4378113760) cleanup complete.
2025-05-30 12:17:12,185 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 12:17:12,185 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 12:17:12,185 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4378113472) was cancelled.
2025-05-30 12:17:12,185 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4378113472) stopping. Performing cleanup...
2025-05-30 12:17:12,185 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 12:17:12,189 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 12:17:12,190 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 12:17:12,190 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:17:12,190 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 12:17:12,190 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 12:17:12,190 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4378113472) cleanup complete.
2025-05-30 12:17:12,190 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 12:17:12,190 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 12:17:12,190 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4372128752) was cancelled.
2025-05-30 12:17:12,190 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4372128752) stopping. Performing cleanup...
2025-05-30 12:17:12,190 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 12:17:12,190 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:17:12,190 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 12:17:12,190 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 12:17:12,190 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 12:17:12,192 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 12:17:12,193 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 12:17:12,193 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:17:12,193 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 12:17:12,193 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 12:17:12,193 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 12:17:12,193 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4372128752) cleanup complete.
2025-05-30 12:17:12,193 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 12:17:12,193 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 12:17:12,193 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 12:17:12,202 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 12:17:12,202 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 12:17:12,675 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 12:17:12,675 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 12:17:12,679 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 12:17:12,679 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 12:17:12,679 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 12:17:12,679 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 12:17:12,679 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 12:17:12,679 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 12:17:12,679 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 12:17:12,679 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 12:17:12,680 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 12:17:12,680 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 12:17:12,680 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 12:17:12,682 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 12:17:12,682 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 12:17:12,682 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 12:17:12,682 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 12:17:12,682 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 12:17:12,697 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 12:17:12,697 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 12:17:12,699 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 12:17:12,699 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 12:17:12,699 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4742809168) setup complete. Starting run loop.
2025-05-30 12:17:12,699 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 12:17:12,701 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 12:17:12,701 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4744312784) setup complete. Starting run loop.
2025-05-30 12:17:12,701 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 12:17:12,703 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 12:17:12,703 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 12:17:12,734 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 12:17:12,734 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 12:17:12,735 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 12:17:12,735 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 12:17:12,735 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 12:17:12,736 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 12:17:12,737 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:17:12,737 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 12:17:12,737 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 12:17:12,737 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 12:17:22,702 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 12:17:22,706 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 12:17:22,706 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4744312016) setup complete. Starting run loop.
2025-05-30 12:17:22,706 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 12:22:22,863 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 12:22:22,873 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 12:22:33,194 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 12:22:33,195 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 12:22:33,195 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 12:22:33,195 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4742809168) was cancelled.
2025-05-30 12:22:33,195 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4742809168) stopping. Performing cleanup...
2025-05-30 12:22:33,195 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 12:22:33,201 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 12:22:33,201 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 12:22:33,202 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:22:33,202 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 12:22:33,202 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 12:22:33,202 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4742809168) cleanup complete.
2025-05-30 12:22:33,202 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 12:22:33,202 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 12:22:33,202 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4744312784) was cancelled.
2025-05-30 12:22:33,202 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4744312784) stopping. Performing cleanup...
2025-05-30 12:22:33,202 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 12:22:33,206 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 12:22:33,206 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 12:22:33,206 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:22:33,206 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 12:22:33,207 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 12:22:33,207 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4744312784) cleanup complete.
2025-05-30 12:22:33,207 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 12:22:33,207 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 12:22:33,207 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4744312016) was cancelled.
2025-05-30 12:22:33,207 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4744312016) stopping. Performing cleanup...
2025-05-30 12:22:33,207 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 12:22:33,207 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:22:33,207 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 12:22:33,207 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 12:22:33,207 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 12:22:33,209 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 12:22:33,210 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 12:22:33,210 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:22:33,210 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 12:22:33,210 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 12:22:33,210 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 12:22:33,210 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4744312016) cleanup complete.
2025-05-30 12:22:33,210 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 12:22:33,210 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 12:22:33,210 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 12:22:33,215 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 12:22:33,215 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 12:22:33,687 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 12:22:33,687 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 12:22:33,691 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 12:22:33,691 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 12:22:33,691 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 12:22:33,691 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 12:22:33,691 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 12:22:33,692 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 12:22:33,692 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 12:22:33,692 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 12:22:33,692 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 12:22:33,692 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 12:22:33,692 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 12:22:33,694 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 12:22:33,694 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 12:22:33,694 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 12:22:33,708 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 12:22:33,708 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 12:22:33,709 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 12:22:33,709 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 12:22:33,710 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 12:22:33,710 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 12:22:33,710 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4874165408) setup complete. Starting run loop.
2025-05-30 12:22:33,710 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 12:22:33,711 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 12:22:33,711 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4876684320) setup complete. Starting run loop.
2025-05-30 12:22:33,711 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 12:22:33,713 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 12:22:33,713 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 12:22:33,744 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 12:22:33,744 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 12:22:33,745 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 12:22:33,745 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 12:22:33,745 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 12:22:33,746 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 12:22:33,747 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:22:33,747 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 12:22:33,747 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 12:22:33,747 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 12:22:43,714 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 12:22:43,718 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 12:22:43,718 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4876695264) setup complete. Starting run loop.
2025-05-30 12:22:43,718 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 12:25:08,337 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 12:25:08,338 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 12:25:08,338 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 12:25:08,338 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4874165408) was cancelled.
2025-05-30 12:25:08,338 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4874165408) stopping. Performing cleanup...
2025-05-30 12:25:08,338 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 12:25:08,344 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 12:25:08,345 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 12:25:08,345 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:25:08,345 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 12:25:08,345 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 12:25:08,345 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4874165408) cleanup complete.
2025-05-30 12:25:08,345 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 12:25:08,345 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 12:25:08,345 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4876684320) was cancelled.
2025-05-30 12:25:08,345 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4876684320) stopping. Performing cleanup...
2025-05-30 12:25:08,345 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 12:25:08,348 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 12:25:08,349 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 12:25:08,349 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:25:08,349 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 12:25:08,349 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 12:25:08,349 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4876684320) cleanup complete.
2025-05-30 12:25:08,349 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 12:25:08,349 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 12:25:08,349 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4876695264) was cancelled.
2025-05-30 12:25:08,350 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4876695264) stopping. Performing cleanup...
2025-05-30 12:25:08,350 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 12:25:08,350 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:25:08,350 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 12:25:08,350 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 12:25:08,350 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 12:25:08,351 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 12:25:08,352 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 12:25:08,352 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:25:08,352 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 12:25:08,352 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 12:25:08,352 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 12:25:08,352 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4876695264) cleanup complete.
2025-05-30 12:25:08,352 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 12:25:08,352 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 12:25:08,352 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 12:25:08,356 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 12:25:08,356 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 12:25:08,830 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 12:25:08,830 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 12:25:08,835 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 12:25:08,835 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 12:25:08,835 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 12:25:08,835 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 12:25:08,835 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 12:25:08,835 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 12:25:08,835 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 12:25:08,835 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 12:25:08,835 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 12:25:08,835 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 12:25:08,835 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 12:25:08,837 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 12:25:08,837 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 12:25:08,838 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 12:25:08,852 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 12:25:08,852 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 12:25:08,853 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 12:25:08,853 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 12:25:08,853 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 12:25:08,853 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4410789088) setup complete. Starting run loop.
2025-05-30 12:25:08,853 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 12:25:08,854 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 12:25:08,855 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 12:25:08,855 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4411127184) setup complete. Starting run loop.
2025-05-30 12:25:08,855 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 12:25:08,866 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 12:25:08,866 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 12:25:08,885 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 12:25:08,885 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 12:25:08,886 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 12:25:08,886 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 12:25:08,886 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 12:25:08,887 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 12:25:08,887 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:25:08,888 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 12:25:08,888 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 12:25:08,888 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 12:25:18,867 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 12:25:18,872 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 12:25:18,872 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4411127664) setup complete. Starting run loop.
2025-05-30 12:25:18,872 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 12:26:06,339 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-30 12:26:06,353 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-30 12:26:06,354 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-30 12:26:06,354 - INFO - app.db.crud.agent_crud - Updating agent config in DB for agent_id: agent_airsoft_0faa9616
2025-05-30 12:26:06,372 - INFO - app.db.crud.agent_crud - Agent config updated successfully for agent_id: agent_airsoft_0faa9616
2025-05-30 12:26:06,372 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616 was running. Attempting to restart it after config update.
2025-05-30 12:26:06,372 - INFO - app.services.process_manager - Restarting agent process for agent_airsoft_0faa9616...
2025-05-30 12:26:06,376 - INFO - app.services.process_manager - Stopping agent process agent_airsoft_0faa9616 (PID: 20854). Force: True
2025-05-30 12:26:06,376 - INFO - app.services.process_manager - SIGTERM sent to agent agent_airsoft_0faa9616 (PID: 20854)
2025-05-30 12:26:06,476 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 (PID: 20854) terminated gracefully after SIGTERM.
2025-05-30 12:26:06,478 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 marked as stopped in Redis.
2025-05-30 12:26:06,478 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 stopped (or stop attempted and assumed successful for restart). Pausing briefly...
2025-05-30 12:26:11,478 - INFO - app.services.process_manager - Proceeding to start agent agent_airsoft_0faa9616 after delay...
2025-05-30 12:26:11,480 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 12:26:11,481 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 21358
2025-05-30 12:26:11,481 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 21358
2025-05-30 12:26:11,482 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 successfully started as part of restart sequence.
2025-05-30 12:26:11,482 - INFO - app.api.routers.agent_api - Restart command issued for agent agent_airsoft_0faa9616 after config update.
2025-05-30 12:26:11,482 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:26:11,483 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 12:27:49,684 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 12:27:49,687 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 12:27:49,687 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 12:27:49,799 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 12:27:49,799 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 12:27:49,799 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 12:27:49,800 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4410789088) was cancelled.
2025-05-30 12:27:49,800 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4410789088) stopping. Performing cleanup...
2025-05-30 12:27:49,800 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 12:27:49,805 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 12:27:49,806 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 12:27:49,806 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:27:49,806 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 12:27:49,806 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 12:27:49,806 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4410789088) cleanup complete.
2025-05-30 12:27:49,806 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 12:27:49,806 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 12:27:49,806 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4411127184) was cancelled.
2025-05-30 12:27:49,806 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4411127184) stopping. Performing cleanup...
2025-05-30 12:27:49,806 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 12:27:49,809 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 12:27:49,811 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 12:27:49,811 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:27:49,811 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 12:27:49,811 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 12:27:49,811 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4411127184) cleanup complete.
2025-05-30 12:27:49,811 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 12:27:49,811 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 12:27:49,811 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4411127664) was cancelled.
2025-05-30 12:27:49,811 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4411127664) stopping. Performing cleanup...
2025-05-30 12:27:49,811 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 12:27:49,811 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:27:49,811 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 12:27:49,811 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 12:27:49,811 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 12:27:49,813 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 12:27:49,814 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 12:27:49,814 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:27:49,814 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 12:27:49,814 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 12:27:49,814 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 12:27:49,814 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4411127664) cleanup complete.
2025-05-30 12:27:49,814 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 12:27:49,814 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 12:27:49,814 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 12:27:49,819 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 12:27:49,819 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 12:27:49,938 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 12:27:49,938 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 12:27:49,938 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 12:27:49,938 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4835928080) received shutdown request. Initiating graceful shutdown...
2025-05-30 12:27:49,938 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4835928080)...
2025-05-30 12:27:49,938 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 12:27:49,938 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 12:27:49,938 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4835928080) was cancelled.
2025-05-30 12:27:49,938 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4835928080) stopping. Performing cleanup...
2025-05-30 12:27:49,938 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 12:27:49,938 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 12:27:49,938 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 12:27:49,938 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 12:27:49,938 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 12:27:49,938 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 12:27:49,938 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 12:27:49,938 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 12:27:49,938 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 12:27:49,938 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 12:27:49,943 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 12:27:49,944 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 12:27:49,944 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:27:49,944 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 12:27:49,944 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 12:27:49,944 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 12:27:49,944 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4835928080) cleanup complete.
2025-05-30 12:27:49,944 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 12:27:49,944 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 12:27:49,945 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 12:27:49,945 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 12:27:49,945 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 12:27:49,947 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 12:27:56,983 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 12:27:56,983 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 12:27:56,988 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 12:27:56,988 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 12:27:56,988 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 12:27:56,988 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 12:27:56,988 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 12:27:56,988 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 12:27:56,988 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 12:27:56,988 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 12:27:56,989 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 12:27:56,989 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 12:27:56,989 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 12:27:56,991 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 12:27:56,991 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 12:27:56,991 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 12:27:56,991 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 12:27:56,991 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 12:27:56,991 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 12:27:56,991 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 12:27:57,006 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 12:27:57,008 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 12:27:57,008 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4360568560) setup complete. Starting run loop.
2025-05-30 12:27:57,008 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 12:27:57,008 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4384568720) setup complete. Starting run loop.
2025-05-30 12:27:57,008 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 12:27:57,008 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 12:27:57,009 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 12:27:57,009 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 12:27:57,039 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 12:27:57,039 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 12:27:57,040 - WARNING - app.services.process_manager - Agent agent_airsoft_0faa9616 status is 'starting' in Redis, but PID 21358 not found. Updating status.
2025-05-30 12:27:57,042 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 12:27:57,043 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 21507
2025-05-30 12:27:57,043 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 21507
2025-05-30 12:27:57,044 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 12:27:57,044 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 12:27:57,044 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 12:27:57,045 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 12:27:57,046 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 21508
2025-05-30 12:27:57,046 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 21508
2025-05-30 12:27:57,046 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 12:27:57,047 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:27:57,047 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 12:27:57,047 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 12:27:57,047 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 12:27:57,955 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 12:27:57,955 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 12:27:57,955 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 12:27:57,955 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 12:27:57,955 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 21508
2025-05-30 12:27:57,955 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 12:27:57,955 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 12:27:57,955 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 12:27:57,960 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 12:27:57,973 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 12:27:57,973 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 12:27:57,973 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 12:27:57,973 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4689209168) setup complete. Starting run loop.
2025-05-30 12:27:57,973 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 12:27:57,973 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 12:27:57,973 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 12:27:57,973 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 12:27:57,973 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 12:27:57,974 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 12:27:57,974 - INFO - aiogram.dispatcher - Start polling
2025-05-30 12:27:57,976 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 12:27:58,287 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 12:28:07,010 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 12:28:07,014 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 12:28:07,015 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4384568000) setup complete. Starting run loop.
2025-05-30 12:28:07,015 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 12:28:48,774 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 12:28:48,774 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 12:28:48,774 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 12:28:48,774 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4384568720) was cancelled.
2025-05-30 12:28:48,774 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4384568720) stopping. Performing cleanup...
2025-05-30 12:28:48,774 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 12:28:48,779 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 12:28:48,780 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 12:28:48,780 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:28:48,780 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 12:28:48,780 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 12:28:48,780 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4384568720) cleanup complete.
2025-05-30 12:28:48,780 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 12:28:48,780 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 12:28:48,780 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4360568560) was cancelled.
2025-05-30 12:28:48,780 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4360568560) stopping. Performing cleanup...
2025-05-30 12:28:48,780 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 12:28:48,784 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 12:28:48,784 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 12:28:48,784 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:28:48,785 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 12:28:48,785 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 12:28:48,785 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4360568560) cleanup complete.
2025-05-30 12:28:48,785 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 12:28:48,785 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 12:28:48,785 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4384568000) was cancelled.
2025-05-30 12:28:48,785 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4384568000) stopping. Performing cleanup...
2025-05-30 12:28:48,785 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 12:28:48,785 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:28:48,785 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 12:28:48,785 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 12:28:48,785 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 12:28:48,787 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 12:28:48,788 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 12:28:48,788 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:28:48,788 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 12:28:48,788 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 12:28:48,788 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 12:28:48,788 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4384568000) cleanup complete.
2025-05-30 12:28:48,788 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 12:28:48,788 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 12:28:48,788 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 12:28:48,792 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 12:28:48,792 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 12:28:49,242 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 12:28:49,242 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 12:28:49,246 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 12:28:49,246 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 12:28:49,246 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 12:28:49,246 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 12:28:49,246 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 12:28:49,247 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 12:28:49,247 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 12:28:49,247 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 12:28:49,247 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 12:28:49,247 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 12:28:49,247 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 12:28:49,250 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 12:28:49,264 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 12:28:49,264 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 12:28:49,264 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 12:28:49,264 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 12:28:49,264 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 12:28:49,264 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 12:28:49,267 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 12:28:49,267 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4439423792) setup complete. Starting run loop.
2025-05-30 12:28:49,267 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 12:28:49,267 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 12:28:49,269 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 12:28:49,269 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4439128688) setup complete. Starting run loop.
2025-05-30 12:28:49,269 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 12:28:49,270 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 12:28:49,270 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 12:28:49,300 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 12:28:49,300 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 12:28:49,301 - WARNING - app.services.process_manager - Agent agent_airsoft_0faa9616 status is 'starting' in Redis, but PID 21507 not found. Updating status.
2025-05-30 12:28:49,302 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 12:28:49,303 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 21530
2025-05-30 12:28:49,303 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 21530
2025-05-30 12:28:49,303 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 12:28:49,303 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 12:28:49,304 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 12:28:49,304 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 12:28:49,305 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:28:49,305 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 12:28:49,305 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 12:28:49,305 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 12:28:50,563 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 12:28:50,564 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 12:28:50,564 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 12:28:50,564 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 12:28:50,564 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 21530
2025-05-30 12:28:50,564 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 12:28:50,564 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 12:28:50,564 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 12:28:50,570 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 12:28:50,570 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 12:28:50,653 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 12:28:50,653 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 12:28:50,653 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 12:28:50,653 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 12:28:50,653 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 12:28:50,653 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 12:28:50,679 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 12:28:50,679 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 12:28:50,679 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 12:28:50,679 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (method: GET)
2025-05-30 12:28:50,679 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (method: GET)
2025-05-30 12:28:50,679 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 12:28:50,679 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 12:28:50,735 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 12:28:50,739 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 12:28:53,264 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 12:28:53,266 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 12:28:53,267 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 12:28:53,267 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 12:28:53,267 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 12:28:53,267 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 12:28:53,267 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 12:28:53,267 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 12:28:53,267 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 12:28:53,267 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 12:28:53,268 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 12:28:53,278 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 12:28:53,278 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 12:28:53,278 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 12:28:53,278 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 12:28:53,278 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 12:28:53,287 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 12:28:53,287 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 12:28:53,288 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 12:28:53,288 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4479528416) setup complete. Starting run loop.
2025-05-30 12:28:53,288 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 12:28:53,288 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 12:28:53,288 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 12:28:53,288 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 12:28:53,291 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 12:28:59,270 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 12:28:59,274 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 12:28:59,274 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4439129600) setup complete. Starting run loop.
2025-05-30 12:28:59,274 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 12:30:56,705 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'привет. Я авторизован?...'
2025-05-30 12:30:56,707 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache miss for user 144641834, agent agent_airsoft_0faa9616. Checking DB.
2025-05-30 12:30:56,795 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - User 144641834 (DBID: 1) IS authorized for agent agent_airsoft_0faa9616 via DB.
2025-05-30 12:30:56,800 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 12:30:56,800 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 12:30:56,800 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 12:30:56,801 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 4698495a-1054-41d0-a009-b6ae15f43bc8)
2025-05-30 12:30:56,801 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 12:30:56,801 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-30 12:30:56,828 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 4698495a-1054-41d0-a009-b6ae15f43bc8, db_id: 933
2025-05-30 12:30:56,842 - INFO - AGENT:agent_airsoft_0faa9616 - Loaded 20 messages from DB for thread '144641834'.
2025-05-30 12:30:56,843 - INFO - AGENT:agent_airsoft_0faa9616 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-30 12:30:56,843 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-30 12:30:56,906 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 12:30:56,907 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 12:30:56,931 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 12:30:56,940 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 12:30:57,801 - INFO - aiogram.event - Update id=804756311 is handled. Duration 1097 ms by bot id=1750613938
2025-05-30 12:30:58,063 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 12:30:58,119 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 12:30:58,119 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 12:30:58,119 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1644, 'output_tokens': 12, 'total_tokens': 1656, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 12:30:58,119 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1644 C:12 T:1656
2025-05-30 12:30:58,119 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1656 tokens recorded.
2025-05-30 12:30:58,120 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 12:30:58,120 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: get_user_info_tool
2025-05-30 12:30:58,120 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (get_user_info_tool)---
2025-05-30 12:30:58,122 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 12:30:58,122 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 12:30:58,146 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 12:30:58,153 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 12:30:59,035 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 12:30:59,348 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Привет, Евгений! Да, ты авторизован. Чем могу помочь? 😉
2025-05-30 12:30:59,348 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_38647f5e19'}
2025-05-30 12:30:59,348 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1715, 'output_tokens': 20, 'total_tokens': 1735, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 12:30:59,348 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1715 C:20 T:1735
2025-05-30 12:30:59,348 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1735 tokens recorded.
2025-05-30 12:30:59,349 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 12:30:59,349 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 12:30:59,350 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Привет, Евгений! Да, ты авторизован. Чем могу помочь? 😉...
2025-05-30 12:30:59,351 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 4698495a-1054-41d0-a009-b6ae15f43bc8)
2025-05-30 12:30:59,352 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: 4698495a-1054-41d0-a009-b6ae15f43bc8.
2025-05-30 12:30:59,354 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Привет, Евгений! Да, ты авторизован. Чем могу помочь? 😉...
2025-05-30 12:30:59,354 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Привет, Евгений! Да, ты авторизован. Чем могу помо...'
2025-05-30 12:30:59,355 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '4698495a-1054-41d0-a009-b6ae15f43bc8', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1644, 'completion_tokens': 12, 'total_tokens': 1656, 'timestamp': '2025-05-30T07:30:58.119141+00:00'}
2025-05-30 12:30:59,355 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 4698495a-1054-41d0-a009-b6ae15f43bc8
2025-05-30 12:30:59,359 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 4698495a-1054-41d0-a009-b6ae15f43bc8, db_id: 934
2025-05-30 12:30:59,391 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 934 for interaction_id: 4698495a-1054-41d0-a009-b6ae15f43bc8 on attempt 1
2025-05-30 12:30:59,397 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 4698495a-1054-41d0-a009-b6ae15f43bc8, db_id: 394
2025-05-30 12:30:59,400 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '4698495a-1054-41d0-a009-b6ae15f43bc8', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1715, 'completion_tokens': 20, 'total_tokens': 1735, 'timestamp': '2025-05-30T07:30:59.348248+00:00'}
2025-05-30 12:30:59,400 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 4698495a-1054-41d0-a009-b6ae15f43bc8
2025-05-30 12:30:59,401 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 934 for interaction_id: 4698495a-1054-41d0-a009-b6ae15f43bc8 on attempt 1
2025-05-30 12:30:59,404 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 4698495a-1054-41d0-a009-b6ae15f43bc8, db_id: 395
2025-05-30 12:31:13,089 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Сколько у меня бб?...'
2025-05-30 12:31:13,090 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 12:31:13,097 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 12:31:13,097 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 12:31:13,098 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 12:31:13,099 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: fd3ef552-60b9-499c-a969-eeb66e451482)
2025-05-30 12:31:13,099 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 12:31:13,100 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 12:31:13,100 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 12:31:13,105 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 12:31:13,105 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 12:31:13,108 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: fd3ef552-60b9-499c-a969-eeb66e451482, db_id: 935
2025-05-30 12:31:13,132 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 12:31:13,140 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 12:31:14,098 - INFO - aiogram.event - Update id=804756312 is handled. Duration 1011 ms by bot id=1750613938
2025-05-30 12:31:14,132 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 12:31:14,350 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 12:31:14,350 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 12:31:14,350 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1749, 'output_tokens': 25, 'total_tokens': 1774, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 12:31:14,350 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1749 C:25 T:1774
2025-05-30 12:31:14,350 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1774 tokens recorded.
2025-05-30 12:31:14,351 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 12:31:14,351 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748460000001
2025-05-30 12:31:14,351 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748460000001)---
2025-05-30 12:31:14,352 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'apiRequest-1748460000001'
2025-05-30 12:31:14,352 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://jsonplaceholder.typicode.com/posts
2025-05-30 12:31:14,709 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 12:31:14,709 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 12:31:14,733 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 12:31:14,740 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 12:31:16,685 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 12:31:17,939 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Похоже, что информация о твоих бонусных баллах сейчас недоступна, вместо этого пришли данные из тест
2025-05-30 12:31:17,939 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 12:31:17,939 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 9478, 'output_tokens': 61, 'total_tokens': 9539, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 12:31:17,939 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:9478 C:61 T:9539
2025-05-30 12:31:17,939 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 9539 tokens recorded.
2025-05-30 12:31:17,940 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 12:31:17,940 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 12:31:17,941 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Похоже, что информация о твоих бонусных баллах сейчас недоступна, вместо этого пришли данные из тест...
2025-05-30 12:31:17,943 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: fd3ef552-60b9-499c-a969-eeb66e451482)
2025-05-30 12:31:17,943 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: fd3ef552-60b9-499c-a969-eeb66e451482.
2025-05-30 12:31:17,945 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Похоже, что информация о твоих бонусных баллах сейчас недоступна, вместо этого пришли данные из тест...
2025-05-30 12:31:17,945 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Похоже, что информация о твоих бонусных баллах сей...'
2025-05-30 12:31:17,946 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'fd3ef552-60b9-499c-a969-eeb66e451482', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1749, 'completion_tokens': 25, 'total_tokens': 1774, 'timestamp': '2025-05-30T07:31:14.350428+00:00'}
2025-05-30 12:31:17,947 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: fd3ef552-60b9-499c-a969-eeb66e451482
2025-05-30 12:31:17,951 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 936 for interaction_id: fd3ef552-60b9-499c-a969-eeb66e451482 on attempt 1
2025-05-30 12:31:17,951 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: fd3ef552-60b9-499c-a969-eeb66e451482, db_id: 936
2025-05-30 12:31:17,954 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: fd3ef552-60b9-499c-a969-eeb66e451482, db_id: 396
2025-05-30 12:31:17,958 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'fd3ef552-60b9-499c-a969-eeb66e451482', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 9478, 'completion_tokens': 61, 'total_tokens': 9539, 'timestamp': '2025-05-30T07:31:17.939518+00:00'}
2025-05-30 12:31:17,958 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: fd3ef552-60b9-499c-a969-eeb66e451482
2025-05-30 12:31:17,959 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 936 for interaction_id: fd3ef552-60b9-499c-a969-eeb66e451482 on attempt 1
2025-05-30 12:31:17,963 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: fd3ef552-60b9-499c-a969-eeb66e451482, db_id: 397
2025-05-30 12:33:59,446 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 12:33:59,457 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 12:38:59,623 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 12:38:59,632 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 12:41:13,345 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 12:41:13,346 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 12:41:13,346 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 12:41:13,346 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4439423792) was cancelled.
2025-05-30 12:41:13,346 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4439423792) stopping. Performing cleanup...
2025-05-30 12:41:13,346 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 12:41:13,351 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 12:41:13,352 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 12:41:13,352 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:41:13,352 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 12:41:13,352 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 12:41:13,352 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4439423792) cleanup complete.
2025-05-30 12:41:13,352 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 12:41:13,352 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 12:41:13,352 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4439128688) was cancelled.
2025-05-30 12:41:13,352 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4439128688) stopping. Performing cleanup...
2025-05-30 12:41:13,352 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 12:41:13,356 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 12:41:13,357 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 12:41:13,357 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:41:13,357 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 12:41:13,357 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 12:41:13,357 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4439128688) cleanup complete.
2025-05-30 12:41:13,357 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 12:41:13,357 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 12:41:13,357 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4439129600) was cancelled.
2025-05-30 12:41:13,357 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4439129600) stopping. Performing cleanup...
2025-05-30 12:41:13,357 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 12:41:13,357 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:41:13,357 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 12:41:13,357 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 12:41:13,357 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 12:41:13,359 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 12:41:13,360 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 12:41:13,360 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:41:13,360 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 12:41:13,360 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 12:41:13,360 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 12:41:13,360 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4439129600) cleanup complete.
2025-05-30 12:41:13,361 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 12:41:13,361 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 12:41:13,361 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 12:41:13,370 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 12:41:13,371 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 12:41:13,848 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 12:41:13,848 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 12:41:13,856 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 12:41:13,856 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 12:41:13,856 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 12:41:13,856 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 12:41:13,856 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 12:41:13,856 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 12:41:13,856 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 12:41:13,856 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 12:41:13,856 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 12:41:13,856 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 12:41:13,856 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 12:41:13,859 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 12:41:13,859 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 12:41:13,859 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 12:41:13,859 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 12:41:13,859 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 12:41:13,874 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 12:41:13,874 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 12:41:13,876 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 12:41:13,877 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 12:41:13,877 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4421318272) setup complete. Starting run loop.
2025-05-30 12:41:13,877 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 12:41:13,878 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 12:41:13,878 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4421318560) setup complete. Starting run loop.
2025-05-30 12:41:13,878 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 12:41:13,879 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 12:41:13,879 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 12:41:13,911 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 12:41:13,911 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 12:41:13,915 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 12:41:13,915 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 12:41:13,915 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 12:41:13,916 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 12:41:13,917 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:41:13,917 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 12:41:13,917 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 12:41:13,917 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 12:41:20,285 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 12:41:20,285 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4479528416) received shutdown request. Initiating graceful shutdown...
2025-05-30 12:41:20,285 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4479528416)...
2025-05-30 12:41:20,285 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 12:41:20,285 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 12:41:20,285 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 12:41:20,286 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4479528416) was cancelled.
2025-05-30 12:41:20,286 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4479528416) stopping. Performing cleanup...
2025-05-30 12:41:20,286 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 12:41:20,286 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 12:41:20,286 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 12:41:20,287 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-30 12:41:20,288 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 12:41:20,288 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 12:41:20,288 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 12:41:20,288 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 12:41:20,288 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 12:41:20,288 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 12:41:20,288 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 12:41:20,292 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 12:41:20,293 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 12:41:20,294 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:41:20,294 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 12:41:20,294 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 12:41:20,294 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 12:41:20,294 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4479528416) cleanup complete.
2025-05-30 12:41:20,294 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 12:41:20,294 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 12:41:20,300 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 12:41:20,300 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 12:41:20,300 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 12:41:20,301 - INFO - __main__ - Agent runner main finished.
2025-05-30 12:41:20,464 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 12:41:20,464 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 12:41:20,464 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 12:41:20,464 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4421318560) was cancelled.
2025-05-30 12:41:20,464 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4421318560) stopping. Performing cleanup...
2025-05-30 12:41:20,464 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 12:41:20,470 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 12:41:20,471 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 12:41:20,471 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:41:20,471 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 12:41:20,471 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 12:41:20,471 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4421318560) cleanup complete.
2025-05-30 12:41:20,472 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 12:41:20,472 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 12:41:20,472 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4421318272) was cancelled.
2025-05-30 12:41:20,472 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4421318272) stopping. Performing cleanup...
2025-05-30 12:41:20,472 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 12:41:20,475 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 12:41:20,476 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 12:41:20,476 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:41:20,476 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 12:41:20,476 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 12:41:20,476 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4421318272) cleanup complete.
2025-05-30 12:41:20,476 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 12:41:20,476 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 12:41:20,476 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4421318320) was cancelled.
2025-05-30 12:41:20,476 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4421318320) stopping. Performing cleanup...
2025-05-30 12:41:20,476 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 12:41:20,476 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:41:20,476 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 12:41:20,476 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 12:41:20,476 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 12:41:20,479 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 12:41:20,480 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 12:41:20,480 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:41:20,480 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 12:41:20,480 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 12:41:20,480 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 12:41:20,480 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4421318320) cleanup complete.
2025-05-30 12:41:20,480 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 12:41:20,480 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 12:41:20,481 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 12:41:20,486 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 12:41:20,486 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 12:41:20,538 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 12:41:20,539 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 12:41:20,539 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 12:41:20,539 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4689209168) received shutdown request. Initiating graceful shutdown...
2025-05-30 12:41:20,539 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4689209168)...
2025-05-30 12:41:20,539 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 12:41:20,539 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 12:41:20,539 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4689209168) was cancelled.
2025-05-30 12:41:20,539 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4689209168) stopping. Performing cleanup...
2025-05-30 12:41:20,539 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 12:41:20,539 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 12:41:20,539 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 12:41:20,539 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 12:41:20,539 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 12:41:20,539 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 12:41:20,539 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 12:41:20,539 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 12:41:20,539 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 12:41:20,539 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 12:41:20,544 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 12:41:20,545 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 12:41:20,545 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:41:20,545 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 12:41:20,545 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 12:41:20,545 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 12:41:20,545 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4689209168) cleanup complete.
2025-05-30 12:41:20,545 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 12:41:20,546 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 12:41:20,550 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 12:41:20,550 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 12:41:20,550 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 12:41:20,551 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 12:41:28,422 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 12:41:28,422 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 12:41:28,427 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 12:41:28,427 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 12:41:28,427 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 12:41:28,427 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 12:41:28,427 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 12:41:28,427 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 12:41:28,427 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 12:41:28,427 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 12:41:28,427 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 12:41:28,427 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 12:41:28,428 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 12:41:28,430 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 12:41:28,430 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 12:41:28,430 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 12:41:28,430 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 12:41:28,430 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 12:41:28,430 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 12:41:28,430 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 12:41:28,444 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 12:41:28,444 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4415570000) setup complete. Starting run loop.
2025-05-30 12:41:28,444 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 12:41:28,446 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 12:41:28,446 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 12:41:28,446 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4415570240) setup complete. Starting run loop.
2025-05-30 12:41:28,446 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 12:41:28,447 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 12:41:28,447 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 12:41:28,474 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 12:41:28,474 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 12:41:28,476 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 12:41:28,477 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 21882
2025-05-30 12:41:28,477 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 21882
2025-05-30 12:41:28,478 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 12:41:28,478 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 12:41:28,478 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 12:41:28,479 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 12:41:28,480 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 21883
2025-05-30 12:41:28,480 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 21883
2025-05-30 12:41:28,481 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 12:41:28,481 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 12:41:28,482 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 12:41:28,482 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 12:41:28,482 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 12:41:29,363 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 12:41:29,364 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 12:41:29,364 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 12:41:29,364 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 12:41:29,364 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 21883
2025-05-30 12:41:29,364 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 12:41:29,364 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 12:41:29,364 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 12:41:29,368 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 12:41:29,381 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 12:41:29,381 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 12:41:29,381 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 12:41:29,381 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4397360832) setup complete. Starting run loop.
2025-05-30 12:41:29,382 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 12:41:29,382 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 12:41:29,382 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 12:41:29,382 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 12:41:29,382 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 12:41:29,382 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 12:41:29,382 - INFO - aiogram.dispatcher - Start polling
2025-05-30 12:41:29,385 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 12:41:29,628 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 12:41:29,708 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 12:41:29,708 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 12:41:29,708 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 12:41:29,709 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 12:41:29,709 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 21882
2025-05-30 12:41:29,709 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 12:41:29,709 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 12:41:29,709 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 12:41:29,714 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 12:41:29,714 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 12:41:29,794 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 12:41:29,795 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 12:41:29,795 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 12:41:29,795 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 12:41:29,795 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 12:41:29,795 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 12:41:29,821 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 12:41:29,821 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 12:41:29,821 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 12:41:29,821 - INFO - app.agent_runner.common.tools_registry - Creating API tool: apiRequest-1748460000001 (apiRequest-1748460000001) with description: API tool: unnamed
2025-05-30 12:41:29,821 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (method: GET)
2025-05-30 12:41:29,821 - INFO - app.agent_runner.common.tools_registry - Creating API tool: apiRequest-1748589354598 (apiRequest-1748589354598) with description: API tool: unnamed
2025-05-30 12:41:29,821 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (method: GET)
2025-05-30 12:41:29,821 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 12:41:29,821 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 12:41:29,876 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 12:41:29,881 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 12:41:30,503 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 12:41:30,506 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 12:41:30,506 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 12:41:30,506 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 12:41:30,506 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 12:41:30,506 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 12:41:30,506 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 12:41:30,507 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 12:41:30,507 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 12:41:30,507 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 12:41:30,508 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 12:41:30,518 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 12:41:30,518 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 12:41:30,518 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 12:41:30,518 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 12:41:30,518 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 12:41:30,528 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 12:41:30,528 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 12:41:30,528 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 12:41:30,528 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4450512016) setup complete. Starting run loop.
2025-05-30 12:41:30,528 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 12:41:30,528 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 12:41:30,528 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 12:41:30,529 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 12:41:30,532 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 12:41:38,448 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 12:41:38,454 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 12:41:38,454 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4415580944) setup complete. Starting run loop.
2025-05-30 12:41:38,454 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 12:46:38,632 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 12:46:38,642 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 12:51:38,795 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 12:51:38,806 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 12:56:38,860 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 12:56:38,871 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 13:01:39,050 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 13:01:39,059 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 13:06:39,231 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 13:06:39,240 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 13:11:04,801 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 13:11:04,800 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 13:11:04,802 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4450512016) received shutdown request. Initiating graceful shutdown...
2025-05-30 13:11:04,802 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4450512016)...
2025-05-30 13:11:04,802 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 13:11:04,802 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 13:11:04,802 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4450512016) was cancelled.
2025-05-30 13:11:04,802 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4450512016) stopping. Performing cleanup...
2025-05-30 13:11:04,802 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 13:11:04,802 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 13:11:04,803 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 13:11:04,804 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 0) on start/restart.
2025-05-30 13:11:04,805 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 13:11:04,806 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 13:11:04,806 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 13:11:04,806 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 13:11:04,807 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 13:11:04,807 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 13:11:04,807 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 13:11:04,814 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 13:11:04,815 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 13:11:04,815 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:11:04,815 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 13:11:04,815 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 13:11:04,815 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 13:11:04,815 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4450512016) cleanup complete.
2025-05-30 13:11:04,815 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 13:11:04,815 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 13:11:04,816 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 13:11:04,816 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 13:11:04,816 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 13:11:04,816 - INFO - __main__ - Agent runner main finished.
2025-05-30 13:11:04,975 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 13:11:04,976 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 13:11:04,976 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 13:11:04,976 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4415570000) was cancelled.
2025-05-30 13:11:04,976 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4415570000) stopping. Performing cleanup...
2025-05-30 13:11:04,976 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 13:11:04,980 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 13:11:04,982 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 13:11:04,982 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:11:04,982 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 13:11:04,982 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 13:11:04,982 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4415570000) cleanup complete.
2025-05-30 13:11:04,982 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 13:11:04,982 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 13:11:04,982 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4415570240) was cancelled.
2025-05-30 13:11:04,982 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4415570240) stopping. Performing cleanup...
2025-05-30 13:11:04,982 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 13:11:04,986 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 13:11:04,987 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 13:11:04,987 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:11:04,988 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 13:11:04,988 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 13:11:04,988 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4415570240) cleanup complete.
2025-05-30 13:11:04,988 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 13:11:04,988 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 13:11:04,988 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4415580944) was cancelled.
2025-05-30 13:11:04,988 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4415580944) stopping. Performing cleanup...
2025-05-30 13:11:04,988 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 13:11:04,988 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:11:04,988 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 13:11:04,988 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 13:11:04,988 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 13:11:04,990 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 13:11:04,991 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 13:11:04,991 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:11:04,992 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 13:11:04,992 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 13:11:04,992 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 13:11:04,992 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4415580944) cleanup complete.
2025-05-30 13:11:04,992 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 13:11:04,992 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 13:11:04,992 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 13:11:04,997 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 13:11:04,997 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 13:11:05,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 13:11:05,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 13:11:05,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 13:11:05,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4397360832) received shutdown request. Initiating graceful shutdown...
2025-05-30 13:11:05,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4397360832)...
2025-05-30 13:11:05,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 13:11:05,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 13:11:05,054 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4397360832) was cancelled.
2025-05-30 13:11:05,055 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4397360832) stopping. Performing cleanup...
2025-05-30 13:11:05,055 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 13:11:05,055 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 13:11:05,055 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 13:11:05,055 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 13:11:05,055 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 13:11:05,055 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 13:11:05,055 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 13:11:05,055 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 13:11:05,055 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 13:11:05,055 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 13:11:05,058 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 13:11:05,060 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 13:11:05,060 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:11:05,060 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 13:11:05,060 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 13:11:05,060 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 13:11:05,060 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4397360832) cleanup complete.
2025-05-30 13:11:05,060 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 13:11:05,060 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 13:11:05,061 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 13:11:05,061 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 13:11:05,061 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 13:11:05,061 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 13:11:13,494 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 13:11:13,494 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 13:11:13,499 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 13:11:13,499 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 13:11:13,499 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 13:11:13,499 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 13:11:13,499 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 13:11:13,499 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 13:11:13,499 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 13:11:13,499 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 13:11:13,499 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 13:11:13,499 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 13:11:13,499 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 13:11:13,501 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 13:11:13,514 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 13:11:13,515 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 13:11:13,515 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 13:11:13,515 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 13:11:13,515 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 13:11:13,515 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 13:11:13,518 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 13:11:13,518 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4407925920) setup complete. Starting run loop.
2025-05-30 13:11:13,518 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 13:11:13,518 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 13:11:13,519 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 13:11:13,519 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4410425712) setup complete. Starting run loop.
2025-05-30 13:11:13,519 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 13:11:13,529 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 13:11:13,529 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 13:11:13,549 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 13:11:13,549 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 13:11:13,551 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 13:11:13,552 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 22516
2025-05-30 13:11:13,552 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 22516
2025-05-30 13:11:13,552 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 13:11:13,552 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 13:11:13,552 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 13:11:13,554 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 13:11:13,555 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 22517
2025-05-30 13:11:13,555 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 22517
2025-05-30 13:11:13,555 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 13:11:13,556 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:11:13,556 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 13:11:13,556 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 13:11:13,556 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 13:11:14,428 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 13:11:14,429 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 13:11:14,429 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 13:11:14,429 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 13:11:14,429 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 22517
2025-05-30 13:11:14,429 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 13:11:14,429 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 13:11:14,429 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 13:11:14,434 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 13:11:14,447 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 13:11:14,447 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 13:11:14,447 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 13:11:14,447 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4424689680) setup complete. Starting run loop.
2025-05-30 13:11:14,447 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 13:11:14,447 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 13:11:14,447 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 13:11:14,447 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 13:11:14,447 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 13:11:14,447 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 13:11:14,447 - INFO - aiogram.dispatcher - Start polling
2025-05-30 13:11:14,451 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 13:11:14,695 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 13:11:14,830 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 13:11:14,831 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 13:11:14,831 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 13:11:14,831 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 13:11:14,831 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 22516
2025-05-30 13:11:14,831 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 13:11:14,831 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 13:11:14,831 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 13:11:14,836 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 13:11:14,836 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 13:11:14,918 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 13:11:14,918 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 13:11:14,918 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 13:11:14,918 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 13:11:14,918 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 13:11:14,918 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 13:11:14,944 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 13:11:14,944 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 13:11:14,944 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 13:11:14,944 - INFO - app.agent_runner.common.tools_registry - Creating API tool: apiRequest-1748460000001 (JSONPlaceholder POST) with description: Получение записи блога
2025-05-30 13:11:14,944 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (method: GET)
2025-05-30 13:11:14,944 - INFO - app.agent_runner.common.tools_registry - Creating API tool: apiRequest-1748589354598 (Получить Бонусные баллы) with description: Узнать баланс бонусных баллов (бб) на счету пользователя.
2025-05-30 13:11:14,944 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (method: GET)
2025-05-30 13:11:14,944 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 13:11:14,944 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 13:11:15,001 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 13:11:15,006 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 13:11:15,928 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 13:11:15,930 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 13:11:15,931 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 13:11:15,931 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 13:11:15,931 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 13:11:15,931 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 13:11:15,931 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 13:11:15,931 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 13:11:15,931 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 13:11:15,931 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 13:11:15,932 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 13:11:15,943 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 13:11:15,943 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 13:11:15,943 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 13:11:15,943 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 13:11:15,943 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 13:11:15,954 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 13:11:15,954 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 13:11:15,954 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 13:11:15,954 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4480314800) setup complete. Starting run loop.
2025-05-30 13:11:15,954 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 13:11:15,954 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 13:11:15,954 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 13:11:15,954 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 13:11:15,956 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 13:11:23,529 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 13:11:23,534 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 13:11:23,534 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4410436080) setup complete. Starting run loop.
2025-05-30 13:11:23,534 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 13:11:53,654 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Сколько у меня бб?...'
2025-05-30 13:11:53,655 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 13:11:53,723 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 13:11:53,723 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 13:11:53,723 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 13:11:53,723 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: a17c4d45-351d-4bcb-a03c-3f74bb6f801a)
2025-05-30 13:11:53,724 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 13:11:53,724 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-30 13:11:53,744 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: a17c4d45-351d-4bcb-a03c-3f74bb6f801a, db_id: 937
2025-05-30 13:11:53,761 - INFO - AGENT:agent_airsoft_0faa9616 - Loaded 20 messages from DB for thread '144641834'.
2025-05-30 13:11:53,761 - INFO - AGENT:agent_airsoft_0faa9616 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-30 13:11:53,761 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-30 13:11:53,813 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 13:11:53,813 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 13:11:53,839 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 13:11:53,848 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 13:11:54,723 - INFO - aiogram.event - Update id=804756313 is handled. Duration 1069 ms by bot id=1750613938
2025-05-30 13:11:55,453 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 13:11:55,465 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 13:11:55,465 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 13:11:55,465 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1513, 'output_tokens': 12, 'total_tokens': 1525, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 13:11:55,465 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1513 C:12 T:1525
2025-05-30 13:11:55,465 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1525 tokens recorded.
2025-05-30 13:11:55,466 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 13:11:55,466 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: get_user_info_tool
2025-05-30 13:11:55,466 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (get_user_info_tool)---
2025-05-30 13:11:55,469 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 13:11:55,469 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 13:11:55,493 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 13:11:55,499 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 13:11:56,936 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 13:11:57,362 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 13:11:57,363 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 13:11:57,363 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1584, 'output_tokens': 25, 'total_tokens': 1609, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 13:11:57,363 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1584 C:25 T:1609
2025-05-30 13:11:57,363 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1609 tokens recorded.
2025-05-30 13:11:57,364 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 13:11:57,364 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748589354598
2025-05-30 13:11:57,364 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748589354598)---
2025-05-30 13:11:57,365 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'Получить Бонусные баллы'
2025-05-30 13:11:57,365 - INFO - app.agent_runner.common.tools_registry - Making GET request to http://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 13:11:57,995 - ERROR - app.agent_runner.common.tools_registry - HTTP error making GET request to http://airsoft-rus.ru/obmen_rus/bals.php: 403 <!DOCTYPE html><html lang="en-US"><head><title>Just a moment...</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="robots" content="noindex,nofollow"><meta name="viewport" content="width=device-width,initial-scale=1"><style>*{box-sizing:border-box;margin:0;padding:0}html{line-height:1.15;-webkit-text-size-adjust:100%;color:#313131;font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji}body{display:flex;flex-direction:column;height:100vh;min-height:100vh}.main-content{margin:8rem auto;max-width:60rem;padding-left:1.5rem}@media (width <= 720px){.main-content{margin-top:4rem}}.h2{font-size:1.5rem;font-weight:500;line-height:2.25rem}@media (width <= 720px){.h2{font-size:1.25rem;line-height:1.5rem}}#challenge-error-text{background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgZmlsbD0ibm9uZSI+PHBhdGggZmlsbD0iI0IyMEYwMyIgZD0iTTE2IDNhMTMgMTMgMCAxIDAgMTMgMTNBMTMuMDE1IDEzLjAxNSAwIDAgMCAxNiAzbTAgMjRhMTEgMTEgMCAxIDEgMTEtMTEgMTEuMDEgMTEuMDEgMCAwIDEtMTEgMTEiLz48cGF0aCBmaWxsPSIjQjIwRjAzIiBkPSJNMTcuMDM4IDE4LjYxNUgxNC44N0wxNC41NjMgOS41aDIuNzgzem0tMS4wODQgMS40MjdxLjY2IDAgMS4wNTcuMzg4LjQwNy4zODkuNDA3Ljk5NCAwIC41OTYtLjQwNy45ODQtLjM5Ny4zOS0xLjA1Ny4zODktLjY1IDAtMS4wNTYtLjM4OS0uMzk4LS4zODktLjM5OC0uOTg0IDAtLjU5Ny4zOTgtLjk4NS40MDYtLjM5NyAxLjA1Ni0uMzk3Ii8+PC9zdmc+);background-repeat:no-repeat;background-size:contain;padding-left:34px}@media (prefers-color-scheme:dark){body{background-color:#222;color:#d9d9d9}}</style><meta http-equiv="refresh" content="360"></head><body><div class="main-wrapper" role="main"><div class="main-content"><noscript><div class="h2"><span id="challenge-error-text">Enable JavaScript and cookies to continue</span></div></noscript></div></div><script>(function(){window._cf_chl_opt={cvId: '3',cZone: "airsoft-rus.ru",cType: 'managed',cRay: '947cc38829a5b660',cH: 'NwTpD8HSVJVFQM_lPQGE.8Ej_7wHME7ur.GlANl7mYc-1748592718-1.2.1.1-s2JtUNkbHZFV_qFCsvMB0rgztG.9.WKn3c9SrGYJI7ts3VphUOJ6kXO4T9MY.8WC',cUPMDTk: "\/obmen_rus\/bals.php?type=info&tel=&__cf_chl_tk=Fw3q8TjSWZQVAnDhx7Rj4S6Z9dw3_mxOwIoxOagk3X0-1748592718-1.0.1.1-_ebtp7cGRG80E69psaG_CAyorrzALm4bI8EnZhZBuzI",cFPWv: 'g',cITimeS: '1748592718',cTplC: 0,cTplV: 5,cTplB: 'cf',fa: "\/obmen_rus\/bals.php?type=info&tel=&__cf_chl_f_tk=Fw3q8TjSWZQVAnDhx7Rj4S6Z9dw3_mxOwIoxOagk3X0-1748592718-1.0.1.1-_ebtp7cGRG80E69psaG_CAyorrzALm4bI8EnZhZBuzI",md: "qB3nXfJaw.Mcj37z0207I1BT3HMMrmXsEwPw2vzo5T4-1748592718-1.2.1.1-V_sicfav9CpwxoJiH765vW5WUOI.UrxxCLahlKmUnvd4SSKt2rDTl1swkXidWHlFOzyWsKbg3WkNVziH7VsbYz2.Oy38g8ZfJrC52nFGAaDq8mh3S7FmopvSPP9AW9k_Kqg5_f9p3oAXOx9iMefTWmka.7qte2Za0bwkGQ_iFzKj8eYv1ktnxIsfm5LKOlBEki7k4jWhl2gwb__odiO7JaiDCDy6GXxy.GrAlDCckfe7Uc5esINwoqQ6p85V4VL0.MpviK9KvJBuZqefyFi9sUf2q3y91EVQrukNTEh7HcA1Um8Wa5QC276ae59p1z3Gus9GUu0OPYw.7RofLwSSNRDyprmfdeQJoE1_VQu6yRqMG8hg1YPdrRbOqCjJn.PeArXOdQt6wmSB_FtCOUdMf_RPrIWRE4XtjR9cfDgUhZukEocA9J54s8cSTZtje53ELg4ZOa6YO9X7CR2U99hPeaVcfisWgbdbYvKYGfmV_D8QyOuMbzC4Jk3aKqqN2xmWkerxOgy.UhO5XfMNDjWsIsC0FrbmuDD5YF4oy6xcHz2WrU9NR9zixROlJW1I.2erkDce_.6rG8GVVF0SO6kFt3pMO0Q54lTQtmOppmUTkpJXFvcNxAKDtowAUxr76BTbi7D_uCscN_oT3aW.JqdkNwPPNZX3fFhJbIAAzyt85LgV4gBreB8noTfNrFalgem1d3JTU921X3XvK63wDoiyUZd0Ud0MAaQ7pc2.x3YgB5uLta5_bREphIjufGueTDatFaCtmLtb7FpN11ivBdiCATOdWpAlmCaX9lc6817ATtywhSx5doI5VFA0mLPT5zqcGW5ezKTu4en7Anpp3klzoq2K_8RvCgIqxGDbGjUq_W5zRge9zA5fHJLyXJAZ.6.DJmaIBwxjjsnSEH04SBRlsFEcY985ZCc2oJioSwqN7AyGnB6JjZoKK4rLSAG4H_la",mdrd: "LjjYB5PslA_oDEoo7QP62I3Hb4ObgQISIgNc3yceS.Y-1748592718-1.2.1.1-.dsV2cy7FZ9iB.E1KwHJNkGX7Rq0zEyVvFjyQepNoM7TutMrjSHsIOuUFYYQeflIkXpMAx7hhF9pQXN904BBdFi.4p90iw29GLQTwRA2rbN5IZi_hLkkbsKHA5Si5uCRJo4qhPs7OhtAyaCfnp7to3R3I.QC.QLC1VWKMjjeyLxOOZpHlcntjqFf4mrXkJ6OEXPEelj9kKBdGySf_SGCtN92FxNE9NaQwqZtPqrFizegEaAiGD0JREFdsmiiLsIR3fzlaLHqFBkkWmZ6Jk0m2LWRbO4ns.c.yagyN.DicTIHO4IRNsTrHQd3xHrUH46CFohsuTlloBoxnK0Ctq9xnjNmalJcHKbY5XD7OhqRnqKL7p.VVL_OGUkSqptdxMVR9k.7LO3yUcvasUHAnt58XlLHm6aUhJlIK7f.n7K17GpoOSX1_Kuag_AAn4AlGoigqq12tcI3l6.r4zIhm.RcQPk8mmD9V7qehjiUrwesL..Slf6WmqeHVluly4gkIinoKJNNto7q8ANImvelaLBA09i2t0gkKj8g55ambvcL795AP9s31zsfv343poZFXvnaocPWhbpLO4QCo1ZZqwd2SH8NE6DvS.88FqyLweOgAGfai8r54HprxiZ1wdPsDFZwi57_IR6eSlZhlZ8PdluvB4hc2OitU5UOPgvIOYQdi2gfmSVwSsmMDoQ_OhA8IsTWY3QOT.lAXk6R1otGIzZWbhGh6QwZ1TDBSqG0GqAOZjKMFDRJgAutZy8RgDTR_RDuID84.vMda.lHPolTX8Lky4vn5YfFoa65_g9RZ3GVG1vqnk60f0VDaN2D4YeT0.EjriKLXCt.zvowS0Mu3.qlteTWiQvvMJntuYQLj8t1aPwWuryrjl7aulqRPzzod0gZkJm1HrkGfUh.XerI3cqMJlQBxAH5mNprDQb9ql3aLBzCFGw37DN6ULj8zxrwhPFRqmxUFT_D2d5tAITZV2dS.lcntxhaumdOVKk2.rqn6KuP6dSOeiysdNf5N1U42JJV8WcJOWlxHMy7FHPgxvDqwSy9YvJapAQ.M1EIUAZQrS4qdK1MtR2lrcxLEvmj_uqmRvi_lQ8MGVnKD8xMZDMHz0b7iWVHMjbsNVMxn5QIf.vIb9f9EuRprfmvPnq8ZZDpQXAMLtqiHy0wzr_pnhdT4wuBYD7XRy2IkyZ1v4Ae78exHjcO1njFfCNDKPpgJ.NZSVrWbFBgaRYhz6y6yE.VcPgcFqc9esvdLGkgL6wkNazjJiBcmrUrXgUcByasrdciifUJjkM7gSmEOAwKt_M3Seyo2uFug82LNzAg45j3WMfXidLXcR_uP2zcJke32VKEsLn.eubg_Dda.0UA42Yzc01sijl7hbYUN54BBzmecprn7SMiz5VqyAHAvLjwj_q1XeebsxjyOctVlttPdXSMW__Hn3r9mrVY3zTqcCAuOsm34dCVPtslHnc5sa2SwCLmHZnmSFb2mwo83paqTrwXLKiSkXgtuMVdHYxNPoFZMlVtC1N.PB0rBMgaLyGCsAFDu18lTNOBoyYBtK3sazAnn1zybTbKTLkf4DHJ_FgPoa5oLYjFEEXas1iXDgJJl4evGB5SUcn9OZW.I4q_G7su7Mxk.u5rI66ig4wlT7mtGJcT6mIKZ.ld2wJw2GxHLeXZBfN6p.XVbsceMed7Fiva2Snt7NF_UHQ5OwDI8ufkpQhd.xk3m67K7CpyaJN8O9e7DaWLB9sbMADNp1FVZQ0MOzdqS8_y_VNkVlPd7UWdyo5QgIjWzJcBBRKNPt6kIdkASTRAKzxH0aY.SIyU7IC5rxvXuSNfaWup9CeUFx0R15TuG7MdtDlmxDILRUTdh1lyXgW1HHn.P5pk0UsAXjk3lIRX8PJSxyiMfPTi3RTaX8at82kuotsojzM8uP.pbB7tJvZb2ECZf1ZX4ivBUoYIGtwyLzQAalgZOViqPwSC2DREqhZsposAU_Pziaj94bGP9wWfxG2kZJk_PdOWZlD1zyyInaR7tSZRdsRR4pKdPEQYt_aaHVSyZ.Cfu.xRsd685pTFxUOxR31BPeSFDWSKiZiPzpqJeQ8VC8pazmyaVd84iA5iBRyz5mB4LvbinM_sXWcTJQh6E5L1Q46XA9zywHRMhXGV0D3z13UkOEyIKFg1YLgjrLmEH9GiIE7UMlwPR1MqoYktzTFmgRppM84pBdOjHr8xyKEtjmub_fZARaFxhTsodDeIfUU84toivbrHqprs7yegY_dFhskkbGYibgUCMqNS4HWYgqx7Riib28BiqNbV2FGoXQfYe7re3zpg"};var cpo = document.createElement('script');cpo.src = '/cdn-cgi/challenge-platform/h/g/orchestrate/chl_page/v1?ray=947cc38829a5b660';window._cf_chl_opt.cOgUHash = location.hash === '' && location.href.indexOf('#') !== -1 ? '#' : location.hash;window._cf_chl_opt.cOgUQuery = location.search === '' && location.href.slice(0, location.href.length - window._cf_chl_opt.cOgUHash.length).indexOf('?') !== -1 ? '?' : location.search;if (window.history && window.history.replaceState) {var ogU = location.pathname + window._cf_chl_opt.cOgUQuery + window._cf_chl_opt.cOgUHash;history.replaceState(null, null, "\/obmen_rus\/bals.php?type=info&tel=&__cf_chl_rt_tk=Fw3q8TjSWZQVAnDhx7Rj4S6Z9dw3_mxOwIoxOagk3X0-1748592718-1.0.1.1-_ebtp7cGRG80E69psaG_CAyorrzALm4bI8EnZhZBuzI" + window._cf_chl_opt.cOgUHash);cpo.onload = function() {history.replaceState(null, null, ogU);}}document.getElementsByTagName('head')[0].appendChild(cpo);}());</script></body></html>
2025-05-30 13:11:57,997 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 13:11:57,997 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 13:11:58,021 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 13:11:58,029 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 13:11:59,241 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 13:12:00,396 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Похоже, что сейчас не удаётся получить данные о твоих бонусных баллах из-за технической ошибки с дос
2025-05-30 13:12:00,396 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 13:12:00,396 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 5379, 'output_tokens': 51, 'total_tokens': 5430, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 13:12:00,396 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:5379 C:51 T:5430
2025-05-30 13:12:00,396 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 5430 tokens recorded.
2025-05-30 13:12:00,397 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 13:12:00,397 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 13:12:00,398 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Похоже, что сейчас не удаётся получить данные о твоих бонусных баллах из-за технической ошибки с дос...
2025-05-30 13:12:00,400 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: a17c4d45-351d-4bcb-a03c-3f74bb6f801a)
2025-05-30 13:12:00,400 - INFO - AGENT:agent_airsoft_0faa9616 - Found 3 token usage events for InteractionID: a17c4d45-351d-4bcb-a03c-3f74bb6f801a.
2025-05-30 13:12:00,403 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Похоже, что сейчас не удаётся получить данные о твоих бонусных баллах из-за технической ошибки с дос...
2025-05-30 13:12:00,403 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Похоже, что сейчас не удаётся получить данные о тв...'
2025-05-30 13:12:00,404 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'a17c4d45-351d-4bcb-a03c-3f74bb6f801a', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1513, 'completion_tokens': 12, 'total_tokens': 1525, 'timestamp': '2025-05-30T08:11:55.465872+00:00'}
2025-05-30 13:12:00,404 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: a17c4d45-351d-4bcb-a03c-3f74bb6f801a
2025-05-30 13:12:00,417 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: a17c4d45-351d-4bcb-a03c-3f74bb6f801a, db_id: 938
2025-05-30 13:12:00,433 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 938 for interaction_id: a17c4d45-351d-4bcb-a03c-3f74bb6f801a on attempt 1
2025-05-30 13:12:00,439 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: a17c4d45-351d-4bcb-a03c-3f74bb6f801a, db_id: 398
2025-05-30 13:12:00,441 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'a17c4d45-351d-4bcb-a03c-3f74bb6f801a', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 5379, 'completion_tokens': 51, 'total_tokens': 5430, 'timestamp': '2025-05-30T08:12:00.396733+00:00'}
2025-05-30 13:12:00,441 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: a17c4d45-351d-4bcb-a03c-3f74bb6f801a
2025-05-30 13:12:00,443 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 938 for interaction_id: a17c4d45-351d-4bcb-a03c-3f74bb6f801a on attempt 1
2025-05-30 13:12:00,445 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: a17c4d45-351d-4bcb-a03c-3f74bb6f801a, db_id: 399
2025-05-30 13:12:00,448 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'a17c4d45-351d-4bcb-a03c-3f74bb6f801a', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1584, 'completion_tokens': 25, 'total_tokens': 1609, 'timestamp': '2025-05-30T08:11:57.363093+00:00'}
2025-05-30 13:12:00,448 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: a17c4d45-351d-4bcb-a03c-3f74bb6f801a
2025-05-30 13:12:00,448 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 938 for interaction_id: a17c4d45-351d-4bcb-a03c-3f74bb6f801a on attempt 1
2025-05-30 13:12:00,451 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: a17c4d45-351d-4bcb-a03c-3f74bb6f801a, db_id: 400
2025-05-30 13:15:49,019 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'получи запись блога...'
2025-05-30 13:15:49,021 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 13:15:49,028 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 13:15:49,028 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 13:15:49,028 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 13:15:49,029 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: abb993cd-4918-43fc-bbe8-2a7760da76c9)
2025-05-30 13:15:49,029 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 13:15:49,030 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' found in cache 'agent_threads:agent_airsoft_0faa9616'. Skipping DB load.
2025-05-30 13:15:49,030 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 0)
2025-05-30 13:15:49,037 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 13:15:49,037 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 13:15:49,043 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: abb993cd-4918-43fc-bbe8-2a7760da76c9, db_id: 939
2025-05-30 13:15:49,065 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 13:15:49,074 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 13:15:50,028 - INFO - aiogram.event - Update id=804756314 is handled. Duration 1009 ms by bot id=1750613938
2025-05-30 13:15:50,663 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 13:15:50,750 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 13:15:50,750 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 13:15:50,750 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 5442, 'output_tokens': 22, 'total_tokens': 5464, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 13:15:50,750 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:5442 C:22 T:5464
2025-05-30 13:15:50,750 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 5464 tokens recorded.
2025-05-30 13:15:50,751 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 13:15:50,751 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748460000001
2025-05-30 13:15:50,751 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748460000001)---
2025-05-30 13:15:50,752 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'JSONPlaceholder POST'
2025-05-30 13:15:50,752 - INFO - app.agent_runner.common.tools_registry - Making GET request to https://jsonplaceholder.typicode.com/posts
2025-05-30 13:15:51,211 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 13:15:51,211 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 13:15:51,236 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 13:15:51,245 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 13:15:53,225 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 13:15:54,381 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Вот запись блога для тебя:

### Заголовок:
sunt aut facere repellat provident occaecati excepturi op
2025-05-30 13:15:54,381 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 13:15:54,381 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 13168, 'output_tokens': 85, 'total_tokens': 13253, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 13:15:54,381 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:13168 C:85 T:13253
2025-05-30 13:15:54,381 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 13253 tokens recorded.
2025-05-30 13:15:54,382 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 13:15:54,382 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 13:15:54,383 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Вот запись блога для тебя:

### Заголовок:
sunt aut facere repellat provident occaecati excepturi op...
2025-05-30 13:15:54,384 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: abb993cd-4918-43fc-bbe8-2a7760da76c9)
2025-05-30 13:15:54,385 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: abb993cd-4918-43fc-bbe8-2a7760da76c9.
2025-05-30 13:15:54,387 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Вот запись блога для тебя:

### Заголовок:
sunt aut facere repellat provident occaecati excepturi op...
2025-05-30 13:15:54,387 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Вот запись блога для тебя:

### Заголовок:
sunt au...'
2025-05-30 13:15:54,389 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'abb993cd-4918-43fc-bbe8-2a7760da76c9', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 5442, 'completion_tokens': 22, 'total_tokens': 5464, 'timestamp': '2025-05-30T08:15:50.750358+00:00'}
2025-05-30 13:15:54,389 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: abb993cd-4918-43fc-bbe8-2a7760da76c9
2025-05-30 13:15:54,393 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 940 for interaction_id: abb993cd-4918-43fc-bbe8-2a7760da76c9 on attempt 1
2025-05-30 13:15:54,393 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: abb993cd-4918-43fc-bbe8-2a7760da76c9, db_id: 940
2025-05-30 13:15:54,397 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: abb993cd-4918-43fc-bbe8-2a7760da76c9, db_id: 401
2025-05-30 13:15:54,400 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'abb993cd-4918-43fc-bbe8-2a7760da76c9', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 13168, 'completion_tokens': 85, 'total_tokens': 13253, 'timestamp': '2025-05-30T08:15:54.381704+00:00'}
2025-05-30 13:15:54,400 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: abb993cd-4918-43fc-bbe8-2a7760da76c9
2025-05-30 13:15:54,402 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 940 for interaction_id: abb993cd-4918-43fc-bbe8-2a7760da76c9 on attempt 1
2025-05-30 13:15:54,405 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: abb993cd-4918-43fc-bbe8-2a7760da76c9, db_id: 402
2025-05-30 13:16:23,699 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 13:16:23,707 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 13:21:23,888 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 13:21:23,897 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 13:26:24,128 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 13:26:24,136 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 13:26:38,161 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 13:26:38,161 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 13:26:38,161 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 13:26:38,161 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4407925920) was cancelled.
2025-05-30 13:26:38,161 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4407925920) stopping. Performing cleanup...
2025-05-30 13:26:38,161 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 13:26:38,166 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 13:26:38,167 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 13:26:38,167 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:26:38,168 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 13:26:38,168 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 13:26:38,168 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4407925920) cleanup complete.
2025-05-30 13:26:38,168 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 13:26:38,168 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 13:26:38,168 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4410425712) was cancelled.
2025-05-30 13:26:38,168 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4410425712) stopping. Performing cleanup...
2025-05-30 13:26:38,168 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 13:26:38,175 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 13:26:38,176 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 13:26:38,176 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:26:38,176 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 13:26:38,176 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 13:26:38,176 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4410425712) cleanup complete.
2025-05-30 13:26:38,176 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 13:26:38,176 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 13:26:38,176 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4410436080) was cancelled.
2025-05-30 13:26:38,176 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4410436080) stopping. Performing cleanup...
2025-05-30 13:26:38,176 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 13:26:38,177 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:26:38,177 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 13:26:38,177 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 13:26:38,177 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 13:26:38,178 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 13:26:38,179 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 13:26:38,179 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:26:38,179 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 13:26:38,179 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 13:26:38,179 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 13:26:38,179 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4410436080) cleanup complete.
2025-05-30 13:26:38,179 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 13:26:38,179 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 13:26:38,179 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 13:26:38,186 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 13:26:38,186 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 13:26:38,660 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 13:26:38,660 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 13:26:38,665 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 13:26:38,665 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 13:26:38,665 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 13:26:38,665 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 13:26:38,665 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 13:26:38,665 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 13:26:38,665 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 13:26:38,665 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 13:26:38,665 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 13:26:38,665 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 13:26:38,666 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 13:26:38,667 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 13:26:38,682 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 13:26:38,682 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 13:26:38,682 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 13:26:38,682 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 13:26:38,682 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 13:26:38,682 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 13:26:38,685 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 13:26:38,685 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4598822384) setup complete. Starting run loop.
2025-05-30 13:26:38,685 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 13:26:38,685 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 13:26:38,687 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 13:26:38,687 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4598822192) setup complete. Starting run loop.
2025-05-30 13:26:38,687 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 13:26:38,698 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 13:26:38,698 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 13:26:38,720 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 13:26:38,720 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 13:26:38,721 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 13:26:38,721 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 13:26:38,721 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 13:26:38,722 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 13:26:38,723 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:26:38,723 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 13:26:38,723 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 13:26:38,723 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 13:26:44,955 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 13:26:44,956 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4480314800) received shutdown request. Initiating graceful shutdown...
2025-05-30 13:26:44,956 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4480314800)...
2025-05-30 13:26:44,956 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 13:26:44,956 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 13:26:44,955 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 13:26:44,956 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4480314800) was cancelled.
2025-05-30 13:26:44,956 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4480314800) stopping. Performing cleanup...
2025-05-30 13:26:44,956 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 13:26:44,956 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 13:26:44,956 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 13:26:44,957 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-30 13:26:44,957 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 13:26:44,957 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 13:26:44,957 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 13:26:44,957 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 13:26:44,958 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 13:26:44,958 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 13:26:44,958 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 13:26:44,963 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 13:26:44,964 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 13:26:44,964 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:26:44,965 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 13:26:44,965 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 13:26:44,965 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 13:26:44,965 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4480314800) cleanup complete.
2025-05-30 13:26:44,965 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 13:26:44,965 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 13:26:44,969 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 13:26:44,969 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 13:26:44,969 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 13:26:44,970 - INFO - __main__ - Agent runner main finished.
2025-05-30 13:26:45,060 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 13:26:45,060 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 13:26:45,060 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 13:26:45,060 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4598822384) was cancelled.
2025-05-30 13:26:45,060 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4598822384) stopping. Performing cleanup...
2025-05-30 13:26:45,060 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 13:26:45,064 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 13:26:45,065 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 13:26:45,065 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:26:45,065 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 13:26:45,065 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 13:26:45,065 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4598822384) cleanup complete.
2025-05-30 13:26:45,065 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 13:26:45,065 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 13:26:45,066 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4598822192) was cancelled.
2025-05-30 13:26:45,066 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4598822192) stopping. Performing cleanup...
2025-05-30 13:26:45,066 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 13:26:45,070 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 13:26:45,070 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 13:26:45,070 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:26:45,071 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 13:26:45,071 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 13:26:45,071 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4598822192) cleanup complete.
2025-05-30 13:26:45,071 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 13:26:45,071 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 13:26:45,071 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4598822240) was cancelled.
2025-05-30 13:26:45,071 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4598822240) stopping. Performing cleanup...
2025-05-30 13:26:45,071 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 13:26:45,071 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:26:45,071 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 13:26:45,071 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 13:26:45,071 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 13:26:45,074 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 13:26:45,074 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 13:26:45,074 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:26:45,075 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 13:26:45,075 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 13:26:45,075 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 13:26:45,075 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4598822240) cleanup complete.
2025-05-30 13:26:45,075 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 13:26:45,075 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 13:26:45,075 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 13:26:45,078 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 13:26:45,078 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 13:26:45,208 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 13:26:45,208 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 13:26:45,208 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 13:26:45,208 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4424689680) received shutdown request. Initiating graceful shutdown...
2025-05-30 13:26:45,208 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4424689680)...
2025-05-30 13:26:45,208 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 13:26:45,208 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 13:26:45,208 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4424689680) was cancelled.
2025-05-30 13:26:45,208 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4424689680) stopping. Performing cleanup...
2025-05-30 13:26:45,208 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 13:26:45,208 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 13:26:45,208 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 13:26:45,209 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 13:26:45,209 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 13:26:45,209 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 13:26:45,209 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 13:26:45,209 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 13:26:45,209 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 13:26:45,209 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 13:26:45,213 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 13:26:45,214 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 13:26:45,214 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:26:45,214 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 13:26:45,214 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 13:26:45,214 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 13:26:45,214 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4424689680) cleanup complete.
2025-05-30 13:26:45,214 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 13:26:45,214 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 13:26:45,219 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 13:26:45,219 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 13:26:45,219 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 13:26:45,220 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 13:26:48,757 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 13:26:48,757 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 13:26:48,761 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 13:26:48,761 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 13:26:48,761 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 13:26:48,761 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 13:26:48,761 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 13:26:48,761 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 13:26:48,761 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 13:26:48,761 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 13:26:48,762 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 13:26:48,762 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 13:26:48,762 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 13:26:48,764 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 13:26:48,777 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 13:26:48,777 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 13:26:48,778 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 13:26:48,778 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 13:26:48,778 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 13:26:48,778 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 13:26:48,779 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 13:26:48,779 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4447486704) setup complete. Starting run loop.
2025-05-30 13:26:48,779 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 13:26:48,779 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 13:26:48,779 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 13:26:48,779 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4447827440) setup complete. Starting run loop.
2025-05-30 13:26:48,780 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 13:26:48,782 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 13:26:48,782 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 13:26:48,811 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 13:26:48,811 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 13:26:48,813 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 13:26:48,813 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 22898
2025-05-30 13:26:48,813 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 22898
2025-05-30 13:26:48,814 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 13:26:48,814 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 13:26:48,814 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 13:26:48,816 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 13:26:48,816 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 22899
2025-05-30 13:26:48,816 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 22899
2025-05-30 13:26:48,817 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 13:26:48,817 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:26:48,817 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 13:26:48,817 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 13:26:48,817 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 13:26:49,694 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 13:26:49,695 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 13:26:49,695 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 13:26:49,695 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 13:26:49,695 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 22899
2025-05-30 13:26:49,695 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 13:26:49,695 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 13:26:49,695 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 13:26:49,701 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 13:26:49,715 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 13:26:49,715 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 13:26:49,715 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 13:26:49,715 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4634600912) setup complete. Starting run loop.
2025-05-30 13:26:49,715 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 13:26:49,715 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 13:26:49,715 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 13:26:49,715 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 13:26:49,715 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 13:26:49,715 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 13:26:49,715 - INFO - aiogram.dispatcher - Start polling
2025-05-30 13:26:49,719 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 13:26:49,964 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 13:26:50,052 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 13:26:50,052 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 13:26:50,052 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 13:26:50,052 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 13:26:50,052 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 22898
2025-05-30 13:26:50,052 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 13:26:50,052 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 13:26:50,053 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 13:26:50,058 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 13:26:50,058 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 13:26:50,137 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 13:26:50,137 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 13:26:50,137 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 13:26:50,137 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 13:26:50,137 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 13:26:50,137 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 13:26:50,163 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 13:26:50,163 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 13:26:50,163 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 13:26:50,163 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (method: GET)
2025-05-30 13:26:50,163 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (method: GET)
2025-05-30 13:26:50,163 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 13:26:50,163 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 13:26:50,217 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 13:26:50,221 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 13:26:50,822 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 13:26:50,825 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 13:26:50,825 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 13:26:50,825 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 13:26:50,825 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 13:26:50,825 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 13:26:50,825 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 13:26:50,825 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 13:26:50,826 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 13:26:50,826 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 13:26:50,826 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 13:26:50,836 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 13:26:50,836 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 13:26:50,836 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 13:26:50,836 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 13:26:50,836 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 13:26:50,847 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 13:26:50,847 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 13:26:50,847 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 13:26:50,847 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4417678384) setup complete. Starting run loop.
2025-05-30 13:26:50,847 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 13:26:50,847 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 13:26:50,847 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 13:26:50,847 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 13:26:50,850 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 13:26:58,782 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 13:26:58,786 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 13:26:58,786 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4447827488) setup complete. Starting run loop.
2025-05-30 13:26:58,786 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 13:28:08,443 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 13:28:08,444 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 13:28:08,444 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 13:28:08,444 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4447486704) was cancelled.
2025-05-30 13:28:08,444 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4447486704) stopping. Performing cleanup...
2025-05-30 13:28:08,444 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 13:28:08,449 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 13:28:08,450 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 13:28:08,450 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:28:08,450 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 13:28:08,450 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 13:28:08,450 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4447486704) cleanup complete.
2025-05-30 13:28:08,450 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 13:28:08,450 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 13:28:08,450 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4447827440) was cancelled.
2025-05-30 13:28:08,450 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4447827440) stopping. Performing cleanup...
2025-05-30 13:28:08,450 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 13:28:08,453 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 13:28:08,454 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 13:28:08,454 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:28:08,454 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 13:28:08,454 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 13:28:08,454 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4447827440) cleanup complete.
2025-05-30 13:28:08,454 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 13:28:08,454 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 13:28:08,454 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4447827488) was cancelled.
2025-05-30 13:28:08,454 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4447827488) stopping. Performing cleanup...
2025-05-30 13:28:08,454 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 13:28:08,454 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:28:08,454 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 13:28:08,454 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 13:28:08,454 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 13:28:08,456 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 13:28:08,457 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 13:28:08,457 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:28:08,457 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 13:28:08,457 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 13:28:08,457 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 13:28:08,457 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4447827488) cleanup complete.
2025-05-30 13:28:08,457 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 13:28:08,457 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 13:28:08,457 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 13:28:08,460 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 13:28:08,460 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 13:28:08,942 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 13:28:08,942 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 13:28:08,946 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 13:28:08,946 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 13:28:08,946 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 13:28:08,946 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 13:28:08,946 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 13:28:08,946 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 13:28:08,946 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 13:28:08,946 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 13:28:08,946 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 13:28:08,947 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 13:28:08,947 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 13:28:08,949 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 13:28:08,949 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 13:28:08,949 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 13:28:08,963 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 13:28:08,963 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 13:28:08,963 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 13:28:08,963 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 13:28:08,964 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 13:28:08,964 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4401675584) setup complete. Starting run loop.
2025-05-30 13:28:08,964 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 13:28:08,965 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 13:28:08,966 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 13:28:08,966 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4408242736) setup complete. Starting run loop.
2025-05-30 13:28:08,966 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 13:28:08,977 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 13:28:08,977 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 13:28:08,995 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 13:28:08,996 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 13:28:08,997 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 13:28:08,997 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 13:28:08,997 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 13:28:08,997 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 13:28:08,998 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:28:08,998 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 13:28:08,998 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 13:28:08,998 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 13:28:18,978 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 13:28:18,983 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 13:28:18,983 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4408098448) setup complete. Starting run loop.
2025-05-30 13:28:18,983 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 13:30:06,884 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 13:30:06,884 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 13:30:06,887 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4417678384) received shutdown request. Initiating graceful shutdown...
2025-05-30 13:30:06,887 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4417678384)...
2025-05-30 13:30:06,887 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 13:30:06,887 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 13:30:06,887 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4417678384) was cancelled.
2025-05-30 13:30:06,887 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4417678384) stopping. Performing cleanup...
2025-05-30 13:30:06,887 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 13:30:06,887 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 13:30:06,887 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 13:30:06,888 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 0) on start/restart.
2025-05-30 13:30:06,891 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 13:30:06,891 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 13:30:06,891 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 13:30:06,891 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 13:30:06,891 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 13:30:06,891 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 13:30:06,891 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 13:30:06,894 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 13:30:06,895 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 13:30:06,895 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:30:06,895 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 13:30:06,895 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 13:30:06,895 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 13:30:06,895 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4417678384) cleanup complete.
2025-05-30 13:30:06,895 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 13:30:06,895 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 13:30:06,896 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 13:30:06,896 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 13:30:06,896 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 13:30:06,896 - INFO - __main__ - Agent runner main finished.
2025-05-30 13:30:07,036 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 13:30:07,036 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 13:30:07,036 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 13:30:07,037 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4401675584) was cancelled.
2025-05-30 13:30:07,037 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4401675584) stopping. Performing cleanup...
2025-05-30 13:30:07,037 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 13:30:07,041 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 13:30:07,042 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 13:30:07,042 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:30:07,042 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 13:30:07,042 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 13:30:07,042 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4401675584) cleanup complete.
2025-05-30 13:30:07,042 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 13:30:07,042 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 13:30:07,042 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4408242736) was cancelled.
2025-05-30 13:30:07,042 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4408242736) stopping. Performing cleanup...
2025-05-30 13:30:07,042 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 13:30:07,045 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 13:30:07,046 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 13:30:07,046 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:30:07,046 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 13:30:07,046 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 13:30:07,046 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4408242736) cleanup complete.
2025-05-30 13:30:07,046 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 13:30:07,046 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 13:30:07,046 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4408098448) was cancelled.
2025-05-30 13:30:07,046 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4408098448) stopping. Performing cleanup...
2025-05-30 13:30:07,046 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 13:30:07,047 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:30:07,047 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 13:30:07,047 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 13:30:07,047 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 13:30:07,048 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 13:30:07,049 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 13:30:07,049 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:30:07,049 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 13:30:07,049 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 13:30:07,049 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 13:30:07,049 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4408098448) cleanup complete.
2025-05-30 13:30:07,049 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 13:30:07,049 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 13:30:07,049 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 13:30:07,052 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 13:30:07,052 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 13:30:07,139 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 13:30:07,139 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 13:30:07,139 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 13:30:07,139 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4634600912) received shutdown request. Initiating graceful shutdown...
2025-05-30 13:30:07,139 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4634600912)...
2025-05-30 13:30:07,139 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 13:30:07,139 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 13:30:07,139 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4634600912) was cancelled.
2025-05-30 13:30:07,139 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4634600912) stopping. Performing cleanup...
2025-05-30 13:30:07,139 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 13:30:07,139 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 13:30:07,139 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 13:30:07,139 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 13:30:07,139 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 13:30:07,139 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 13:30:07,139 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 13:30:07,139 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 13:30:07,139 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 13:30:07,139 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 13:30:07,144 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 13:30:07,145 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 13:30:07,145 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:30:07,145 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 13:30:07,145 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 13:30:07,145 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 13:30:07,145 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4634600912) cleanup complete.
2025-05-30 13:30:07,145 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 13:30:07,145 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 13:30:07,145 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 13:30:07,145 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 13:30:07,145 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 13:30:07,145 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 13:30:10,469 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 13:30:10,469 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 13:30:10,472 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 13:30:10,472 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 13:30:10,472 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 13:30:10,472 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 13:30:10,472 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 13:30:10,473 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 13:30:10,473 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 13:30:10,473 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 13:30:10,473 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 13:30:10,473 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 13:30:10,473 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 13:30:10,475 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 13:30:10,475 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 13:30:10,475 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 13:30:10,490 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 13:30:10,490 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 13:30:10,490 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 13:30:10,490 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 13:30:10,492 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 13:30:10,493 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 13:30:10,493 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4699485680) setup complete. Starting run loop.
2025-05-30 13:30:10,493 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 13:30:10,493 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4425290992) setup complete. Starting run loop.
2025-05-30 13:30:10,493 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 13:30:10,493 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 13:30:10,505 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 13:30:10,505 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 13:30:10,521 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 13:30:10,521 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 13:30:10,523 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 13:30:10,524 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 23068
2025-05-30 13:30:10,524 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 23068
2025-05-30 13:30:10,525 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 13:30:10,525 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 13:30:10,525 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 13:30:10,527 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 13:30:10,528 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 23069
2025-05-30 13:30:10,528 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 23069
2025-05-30 13:30:10,529 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 13:30:10,530 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:30:10,530 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 13:30:10,530 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 13:30:10,530 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 13:30:11,419 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 13:30:11,420 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 13:30:11,420 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 13:30:11,420 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 13:30:11,420 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 23069
2025-05-30 13:30:11,420 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 13:30:11,420 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 13:30:11,420 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 13:30:11,425 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 13:30:11,439 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 13:30:11,439 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 13:30:11,439 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 13:30:11,439 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4398786192) setup complete. Starting run loop.
2025-05-30 13:30:11,439 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 13:30:11,439 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 13:30:11,439 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 13:30:11,439 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 13:30:11,439 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 13:30:11,439 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 13:30:11,439 - INFO - aiogram.dispatcher - Start polling
2025-05-30 13:30:11,442 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 13:30:11,777 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 13:30:11,778 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 13:30:11,778 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 13:30:11,778 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 13:30:11,778 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 23068
2025-05-30 13:30:11,778 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 13:30:11,778 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 13:30:11,778 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 13:30:11,783 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 13:30:11,783 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 13:30:11,861 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 13:30:11,862 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 13:30:11,862 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 13:30:11,862 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 13:30:11,862 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 13:30:11,862 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 13:30:11,887 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 13:30:11,887 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 13:30:11,887 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 13:30:11,887 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 13:30:11,887 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (Получить Бонусные баллы) (method: GET)
2025-05-30 13:30:11,888 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 13:30:11,888 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 13:30:11,940 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 13:30:11,943 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 13:30:12,293 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 13:30:12,840 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 13:30:12,842 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 13:30:12,843 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 13:30:12,843 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 13:30:12,843 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 13:30:12,843 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 13:30:12,843 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 13:30:12,843 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 13:30:12,843 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 13:30:12,843 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 13:30:12,844 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 13:30:12,853 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 13:30:12,853 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 13:30:12,853 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 13:30:12,854 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 13:30:12,854 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 13:30:12,863 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 13:30:12,863 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 13:30:12,863 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 13:30:12,863 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4415073712) setup complete. Starting run loop.
2025-05-30 13:30:12,863 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 13:30:12,863 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 13:30:12,864 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 13:30:12,864 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 13:30:12,867 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 13:30:20,505 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 13:30:20,510 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 13:30:20,510 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4699485776) setup complete. Starting run loop.
2025-05-30 13:30:20,510 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 13:31:07,107 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Какой у меня баланс?...'
2025-05-30 13:31:07,109 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache miss for user 144641834, agent agent_airsoft_0faa9616. Checking DB.
2025-05-30 13:31:07,177 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - User 144641834 (DBID: 1) IS authorized for agent agent_airsoft_0faa9616 via DB.
2025-05-30 13:31:07,181 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 13:31:07,181 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 13:31:07,181 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 13:31:07,182 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 7dd425fe-5e13-4e87-be31-1c5013f1e99d)
2025-05-30 13:31:07,182 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 13:31:07,182 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-30 13:31:07,204 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 7dd425fe-5e13-4e87-be31-1c5013f1e99d, db_id: 941
2025-05-30 13:31:07,217 - INFO - AGENT:agent_airsoft_0faa9616 - Loaded 20 messages from DB for thread '144641834'.
2025-05-30 13:31:07,217 - INFO - AGENT:agent_airsoft_0faa9616 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-30 13:31:07,218 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-30 13:31:07,274 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 13:31:07,275 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 13:31:07,299 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 13:31:07,307 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 13:31:08,181 - INFO - aiogram.event - Update id=804756315 is handled. Duration 1074 ms by bot id=1750613938
2025-05-30 13:31:09,046 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 13:31:09,151 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 13:31:09,151 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 13:31:09,151 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1378, 'output_tokens': 24, 'total_tokens': 1402, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 13:31:09,151 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1378 C:24 T:1402
2025-05-30 13:31:09,151 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1402 tokens recorded.
2025-05-30 13:31:09,152 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 13:31:09,152 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748589354598
2025-05-30 13:31:09,152 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748589354598)---
2025-05-30 13:31:09,154 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'Получить Бонусные баллы'
2025-05-30 13:31:09,154 - INFO - app.agent_runner.common.tools_registry - Making GET request to http://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 13:31:09,154 - INFO - app.agent_runner.common.tools_registry - Headers type: <class 'dict'>, value: {'User-Agent': 'PostmanRuntime/7.44'}
2025-05-30 13:31:09,154 - INFO - app.agent_runner.common.tools_registry - Query Params: {'type': 'info', 'tel': ''}
2025-05-30 13:31:09,766 - ERROR - app.agent_runner.common.tools_registry - HTTP error making GET request to http://airsoft-rus.ru/obmen_rus/bals.php: 403 <!DOCTYPE html><html lang="en-US"><head><title>Just a moment...</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="robots" content="noindex,nofollow"><meta name="viewport" content="width=device-width,initial-scale=1"><style>*{box-sizing:border-box;margin:0;padding:0}html{line-height:1.15;-webkit-text-size-adjust:100%;color:#313131;font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji}body{display:flex;flex-direction:column;height:100vh;min-height:100vh}.main-content{margin:8rem auto;max-width:60rem;padding-left:1.5rem}@media (width <= 720px){.main-content{margin-top:4rem}}.h2{font-size:1.5rem;font-weight:500;line-height:2.25rem}@media (width <= 720px){.h2{font-size:1.25rem;line-height:1.5rem}}#challenge-error-text{background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgZmlsbD0ibm9uZSI+PHBhdGggZmlsbD0iI0IyMEYwMyIgZD0iTTE2IDNhMTMgMTMgMCAxIDAgMTMgMTNBMTMuMDE1IDEzLjAxNSAwIDAgMCAxNiAzbTAgMjRhMTEgMTEgMCAxIDEgMTEtMTEgMTEuMDEgMTEuMDEgMCAwIDEtMTEgMTEiLz48cGF0aCBmaWxsPSIjQjIwRjAzIiBkPSJNMTcuMDM4IDE4LjYxNUgxNC44N0wxNC41NjMgOS41aDIuNzgzem0tMS4wODQgMS40MjdxLjY2IDAgMS4wNTcuMzg4LjQwNy4zODkuNDA3Ljk5NCAwIC41OTYtLjQwNy45ODQtLjM5Ny4zOS0xLjA1Ny4zODktLjY1IDAtMS4wNTYtLjM4OS0uMzk4LS4zODktLjM5OC0uOTg0IDAtLjU5Ny4zOTgtLjk4NS40MDYtLjM5NyAxLjA1Ni0uMzk3Ii8+PC9zdmc+);background-repeat:no-repeat;background-size:contain;padding-left:34px}@media (prefers-color-scheme:dark){body{background-color:#222;color:#d9d9d9}}</style><meta http-equiv="refresh" content="360"></head><body><div class="main-wrapper" role="main"><div class="main-content"><noscript><div class="h2"><span id="challenge-error-text">Enable JavaScript and cookies to continue</span></div></noscript></div></div><script>(function(){window._cf_chl_opt={cvId: '3',cZone: "airsoft-rus.ru",cType: 'managed',cRay: '947cdfa679626624',cH: 'hW0nx7mBFilhix2vgXqlRRjS.jgN7doR3LY7CZ7swjk-1748593869-1.2.1.1-3wufe6JtH14NsGS5LYXu9QU2dVmF3Xe_GMnI1d0ya7_eMYcYRDbv38RlSPsQUa4D',cUPMDTk: "\/obmen_rus\/bals.php?type=info&tel=&__cf_chl_tk=jZPjacbBhOd44zo26eistF2D6w_WwND.4EVgs61IDKk-1748593869-1.0.1.1-PQRUrDPa42EDXpgdxgQbdE.5TyNsjNsKY3AjwCnFO_I",cFPWv: 'g',cITimeS: '1748593869',cTplC: 0,cTplV: 5,cTplB: 'cf',fa: "\/obmen_rus\/bals.php?type=info&tel=&__cf_chl_f_tk=jZPjacbBhOd44zo26eistF2D6w_WwND.4EVgs61IDKk-1748593869-1.0.1.1-PQRUrDPa42EDXpgdxgQbdE.5TyNsjNsKY3AjwCnFO_I",md: "SSh3eTGSvTUKQdDmBf9vnSe1.T3cDjpTHC7.Yvrd90I-1748593869-1.2.1.1-PxDF5CrMgQVDjnAf0RFc.Ama0wLeNhgysTex3pCWJKUiXbUTAKORNVXPzJKXViFTOWIAaZc3IFX1au3lKJ9x5ETp2mYVJqEfB3WoULJw1kmA0Z_3RbkRAyEdc0Xc6WfUbVR_BjlmtBLVjJOXCxstmI1y93nJGFhyab2hRu7bcaeE1gbzzlUMY3hxLCy7ihhQWMyf_3KBfPKx7lKJnuWCzclQFMma148_4lJri3A3S1kmV4qXiPeyjWsXjj7eqLpqAFIqcr7ke8OIXyybo_xd5GT9hktcyp3Z.I9hrQYY9OP5oLhZYe6YdpeWjEe7oefU.WhfBwTeOBYPw6xks5M70ODwQD9d6H62MIbXDr1IvxYbixam_16QzmUp1wNNISExTIWiNrNF7Ak7vPhIdQZIBM_284mAQ3XkN_pLjdo.NCtgn.KbjM5gEsCO3MFDpsLDAE89RVg_EwHn62.3f062X86YESFSMeYnHDlOe43AAmoRD.tvoTpmztHv8KmRwgnU3HbfAww9kDR4KqHcTpLqTjrPBoc8_yNpWWsyOEIq55p8nzRbbLpfPqwgp5FT2flvkpzGDVJVa4d8dkjzgdSOsxobZo2wuGp52YWuMdpoV8ZoBipqHL1IPS9dslUhn5zXxXyps20kGzvaif8MjtFEDaj7QtPn5cAYlXH7Vus5RIJ9Kx6E9yiIFi9Itjs.WXtLzW2hl9ZSBJEZvCqB57Iq7H_bcpgURqYB_9SbK2vIbCtdv9q1bqGx3I.LlCXPjDLbDvVHCDqhx_36yLeIdExzFZxfZhFtRq6Fe0ml_hMdPqWup2dZ6NPyKdcMRlLxc_sGKZXNYXo2JWvdyFuvm6h8.l0RQZy.bXvngqLIVlvC1eKK4wuAv9Onxe7U9lbXEVYwftvfK3e.6io814.YEKfPtdw8Ol53YkXWThzvZjmEkhEDRTGSa_QToulvMUX3.sgr",mdrd: "ZfCgcMwMtiMJ6qY3CVPsRZPIWTNlrJSf1MdzYzN18GU-1748593869-1.2.1.1-dfQ61oASeGhTFhIN0K5S5qvquhK3ecGZbgQLi1Z0D8CvHxDEDkBOWobrzRWHIAQri7fHpK7Y_2m4Wjer.AM9e9XvfF905RqRZAQcmTstGhvULm9NSLPbtgfqx_5hPWAIQeCY3bZZlQnzhG4MpahteygTXmLQRtmlTisFFQP1ddaShBOE94q68LfAL2QamkGoxulSksR58Athm.q4n.BfdEtFHHQOUuZDt241yk.kZUf7o_3P4kJFrHdGKQMO.QXGAic2rzNtQFuY998XrvNm2dAb7ndJi3ZK0JzR_KW95x1sLF0fzcT2iabFK4JyeAizQDTuEdiIW6v76BuLOjP.kGqfz8ExIUWly1NS7B_VIpf973vUeYRJROitqxbi45dD9EG108nICner_1Z1cPLwdzubVqY08SzcnPzFHg57ZTg__mc_7Mx8LIbxDbbYnMLH_nJrbDUH38BMPdj2L5OAz7y8SKsT70J.2feerd5xoLRGtH_3nmGCM9JkXEUIcqiMymvMeCsCGiQWSHTFMaTUuvS7vFkcuYKbFTHyreiTftuvq0mCtkFu2A6hAxEj8pCD67fXIrTviKLx0SWvoIzN11eqKRrVyHVQMcwBtymZBNMQmi2H.ZyY02sz1nCTwuTtmu6QE1GBeDvnJTauCYAhznLIouPZxycXagmz5lXPw3sychnj2vNZYGFRDVNwpJ3KBcBdnhSvf6VhquvNQXkOVqF3bNFNtDTeG5JMck.9Tj5kmtSCavDN_iFHvqjdTWPeoI9Vg8NkdXNB6VhwCZw2ZM4NL8hS9zGw.LC9YQcv318wzmDeZFxKJISrVCuDy9VJSc8WdYlg1jMAyGIGiFZpF6Tv_RyWXSJn592pSc1i56IxW6np4GyRBZwOGMJDFp6eWJ8uFvtwnB8cnZxUe359yAyDcFsG52a8sg4oqM8XlNNptg.IFq4Ruhu3qhEbBvN62Ne3V2xna1HIY8SnDMrDtBXu8xvNSdOb7aaye6Vf2M5AmoqKD7r56Qk1rMiYuIaQQVAwaX7w67YCiVfZ4vtBYCzn.UlK9bPbh8dsF.SnKnJLvz_nlr_5HnZ33kg9vx9gk83SzKu.QWhugucE_mcshDCSek9.BsOr6ezbRmkCFjg0KO0rxILw_hK3tZYSSOScJ2mSS_vrgj4oHmCEsmHAtBoKtJ_HU9V9t4Iqi1g5tNMNgXrumyX68_X1yvk9eRLpGbYd7gySOAK3U5T_WzdyiSK.NCqyIcRTQBgOaqEGryI8JGlECtysZbQ6C9g9fqbsLETHHmMphBZjbxKz_hrFF2w3CoKFvtLTk_FnJbYiQkINrxqdGgvzBBZAJ.3H3ZO.TYyP1f8WNp8Kq1yUMROiqb2swZsl0aViJX1VjzFU8hwcHk13rT1atVtbCyZk9XAiph7D_GN55uZoUx9cXI0MoujbSrdxQEGnNuC49QMHG299.UTbrqIX.59yo2aPQYaYq2pjpcmr5QLqarOgbD5FMFlkCBp9Vz9jJ0KE_xZk_JSyJNZbJrratTOtxYBzOKfRZqIX37P_5SZxMk4nCHWTLrWNslEY6r2mWP5JM16hPQeEJLvLo23_zG5oCZFOMnFmMUXr4R1vnb_lrA1vbOJ09MXV.NCa2GtJHDd30yxPjFkvX5isvJ07RgYIMCbVyNF2o_YfZJbbXAPIpuo4ZT__6E5l1s8lFwtusBL8FWd8fLyYpFEIqg2XTRJJFfgDouD6v1BGoCFjAMckTgHODoW2Cm8K3M2KDPREfc1h7uAiI3L4LfTKOvfgJhe_kQGrS92gW44rhMo1saBhAhMTYfA5_0HeM0nedtZMcIj_6Ltd3nsFVJbMrq2VkRjNDhuQfid9iuBphJwzHBYI6YC22f19Bhu6HCNESEAs9Dsv7CeQWiZMNwMD43Jj5a5nCs0bvUg1ulGFmpDO3L8Z.EQ8p8H7MMfP7QAGTZJkkv1kGKZgwmiWyWHyJhB8tVH2y7GqBW53DPr7b0.iZA4LNtTaEx78euUd4yLQ_PwL1DbxnIF1wgf6uyFGRnlQvr6x8nr34ckZcVHgEzwe31KXgDcqQ_eCrSkTx2cVzwtrWdFDgtrQ9XscphaJHssERPYI2jCYKFJTyoE5SSd16Ys2QG9p9d.dUaK9tPmrMaRTjXcX2x37oJD9aeBBb5YOzTqsKOJbjecd9hKRArxAlSZgYWT8WauyipqJ93bMWz4yQv6dsOR5ONDSCGFQUtiQGFLrrTxqvZ_udOlzrsD21YJ.8RMeq.Qv6c5aO7eVXpCF57f_ehqyl68"};var cpo = document.createElement('script');cpo.src = '/cdn-cgi/challenge-platform/h/g/orchestrate/chl_page/v1?ray=947cdfa679626624';window._cf_chl_opt.cOgUHash = location.hash === '' && location.href.indexOf('#') !== -1 ? '#' : location.hash;window._cf_chl_opt.cOgUQuery = location.search === '' && location.href.slice(0, location.href.length - window._cf_chl_opt.cOgUHash.length).indexOf('?') !== -1 ? '?' : location.search;if (window.history && window.history.replaceState) {var ogU = location.pathname + window._cf_chl_opt.cOgUQuery + window._cf_chl_opt.cOgUHash;history.replaceState(null, null, "\/obmen_rus\/bals.php?type=info&tel=&__cf_chl_rt_tk=jZPjacbBhOd44zo26eistF2D6w_WwND.4EVgs61IDKk-1748593869-1.0.1.1-PQRUrDPa42EDXpgdxgQbdE.5TyNsjNsKY3AjwCnFO_I" + window._cf_chl_opt.cOgUHash);cpo.onload = function() {history.replaceState(null, null, ogU);}}document.getElementsByTagName('head')[0].appendChild(cpo);}());</script></body></html>
2025-05-30 13:31:09,768 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 13:31:09,768 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 13:31:09,792 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 13:31:09,799 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 13:31:11,010 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 13:31:11,900 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Похоже, что сейчас не удаётся получить данные о твоём балансе бонусных баллов из-за технической ошиб
2025-05-30 13:31:11,900 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 13:31:11,900 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 5172, 'output_tokens': 54, 'total_tokens': 5226, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 13:31:11,900 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:5172 C:54 T:5226
2025-05-30 13:31:11,900 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 5226 tokens recorded.
2025-05-30 13:31:11,901 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 13:31:11,901 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 13:31:11,902 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Похоже, что сейчас не удаётся получить данные о твоём балансе бонусных баллов из-за технической ошиб...
2025-05-30 13:31:11,904 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 7dd425fe-5e13-4e87-be31-1c5013f1e99d)
2025-05-30 13:31:11,904 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 token usage events for InteractionID: 7dd425fe-5e13-4e87-be31-1c5013f1e99d.
2025-05-30 13:31:11,906 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Похоже, что сейчас не удаётся получить данные о твоём балансе бонусных баллов из-за технической ошиб...
2025-05-30 13:31:11,906 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Похоже, что сейчас не удаётся получить данные о тв...'
2025-05-30 13:31:11,907 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '7dd425fe-5e13-4e87-be31-1c5013f1e99d', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1378, 'completion_tokens': 24, 'total_tokens': 1402, 'timestamp': '2025-05-30T08:31:09.151726+00:00'}
2025-05-30 13:31:11,907 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 7dd425fe-5e13-4e87-be31-1c5013f1e99d
2025-05-30 13:31:11,911 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 7dd425fe-5e13-4e87-be31-1c5013f1e99d, db_id: 942
2025-05-30 13:31:11,938 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 942 for interaction_id: 7dd425fe-5e13-4e87-be31-1c5013f1e99d on attempt 1
2025-05-30 13:31:11,945 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 7dd425fe-5e13-4e87-be31-1c5013f1e99d, db_id: 403
2025-05-30 13:31:11,948 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '7dd425fe-5e13-4e87-be31-1c5013f1e99d', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 5172, 'completion_tokens': 54, 'total_tokens': 5226, 'timestamp': '2025-05-30T08:31:11.900690+00:00'}
2025-05-30 13:31:11,948 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 7dd425fe-5e13-4e87-be31-1c5013f1e99d
2025-05-30 13:31:11,950 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 942 for interaction_id: 7dd425fe-5e13-4e87-be31-1c5013f1e99d on attempt 1
2025-05-30 13:31:11,953 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 7dd425fe-5e13-4e87-be31-1c5013f1e99d, db_id: 404
2025-05-30 13:35:08,717 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Found knowledgeBase tool with IDs: ['3']. Fetching source IDs...
2025-05-30 13:35:08,728 - INFO - httpx - HTTP Request: GET http://localhost:3001/api/v1/admin-sources/?datastoreId=3&status=sync "HTTP/1.1 200 OK"
2025-05-30 13:35:08,729 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616: Replacing knowledgeBaseIds ['3'] with source IDs (as strings) ['5', '6', '7']
2025-05-30 13:35:08,729 - INFO - app.db.crud.agent_crud - Updating agent config in DB for agent_id: agent_airsoft_0faa9616
2025-05-30 13:35:08,743 - INFO - app.db.crud.agent_crud - Agent config updated successfully for agent_id: agent_airsoft_0faa9616
2025-05-30 13:35:08,743 - INFO - app.api.routers.agent_api - Agent agent_airsoft_0faa9616 was running. Attempting to restart it after config update.
2025-05-30 13:35:08,743 - INFO - app.services.process_manager - Restarting agent process for agent_airsoft_0faa9616...
2025-05-30 13:35:08,744 - INFO - app.services.process_manager - Stopping agent process agent_airsoft_0faa9616 (PID: 23068). Force: True
2025-05-30 13:35:08,744 - INFO - app.services.process_manager - SIGTERM sent to agent agent_airsoft_0faa9616 (PID: 23068)
2025-05-30 13:35:08,845 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 (PID: 23068) terminated gracefully after SIGTERM.
2025-05-30 13:35:08,847 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 marked as stopped in Redis.
2025-05-30 13:35:08,847 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 stopped (or stop attempted and assumed successful for restart). Pausing briefly...
2025-05-30 13:35:13,847 - INFO - app.services.process_manager - Proceeding to start agent agent_airsoft_0faa9616 after delay...
2025-05-30 13:35:13,849 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 13:35:13,851 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 23178
2025-05-30 13:35:13,851 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 23178
2025-05-30 13:35:13,851 - INFO - app.services.process_manager - Agent agent_airsoft_0faa9616 successfully started as part of restart sequence.
2025-05-30 13:35:13,851 - INFO - app.api.routers.agent_api - Restart command issued for agent agent_airsoft_0faa9616 after config update.
2025-05-30 13:35:13,852 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:35:13,852 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 13:35:15,224 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 13:35:15,224 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 13:35:15,224 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 13:35:15,224 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 13:35:15,224 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 23178
2025-05-30 13:35:15,224 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 13:35:15,224 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 13:35:15,225 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 13:35:15,230 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 13:35:15,230 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 13:35:15,297 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 13:35:15,297 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 13:35:15,297 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 13:35:15,297 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 13:35:15,297 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 13:35:15,297 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 13:35:15,324 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 13:35:15,324 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 13:35:15,324 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 13:35:15,324 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 13:35:15,324 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (Получить Бонусные баллы) (method: GET)
2025-05-30 13:35:15,324 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 13:35:15,324 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 13:35:15,378 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 13:35:15,382 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 13:35:16,138 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 13:35:16,141 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 13:35:16,141 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 13:35:16,141 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 13:35:16,141 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 13:35:16,141 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 13:35:16,141 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 13:35:16,141 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 13:35:16,141 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 13:35:16,142 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 13:35:16,142 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 13:35:16,151 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 13:35:16,151 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 13:35:16,151 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 13:35:16,151 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 13:35:16,151 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 13:35:16,162 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 13:35:16,162 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 13:35:16,162 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 13:35:16,162 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4592103408) setup complete. Starting run loop.
2025-05-30 13:35:16,162 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 13:35:16,162 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 13:35:16,162 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 13:35:16,162 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 13:35:16,165 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 13:35:20,728 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 13:35:20,735 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 13:38:24,457 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 13:38:24,458 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 13:38:24,458 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 13:38:24,459 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4425290992) was cancelled.
2025-05-30 13:38:24,459 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4425290992) stopping. Performing cleanup...
2025-05-30 13:38:24,459 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 13:38:24,463 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 13:38:24,464 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 13:38:24,464 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:38:24,465 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 13:38:24,465 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 13:38:24,465 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4425290992) cleanup complete.
2025-05-30 13:38:24,465 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 13:38:24,465 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 13:38:24,465 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4699485680) was cancelled.
2025-05-30 13:38:24,465 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4699485680) stopping. Performing cleanup...
2025-05-30 13:38:24,465 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 13:38:24,469 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 13:38:24,469 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 13:38:24,470 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:38:24,470 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 13:38:24,470 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 13:38:24,470 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4699485680) cleanup complete.
2025-05-30 13:38:24,470 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 13:38:24,470 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 13:38:24,470 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4699485776) was cancelled.
2025-05-30 13:38:24,470 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4699485776) stopping. Performing cleanup...
2025-05-30 13:38:24,470 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 13:38:24,470 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:38:24,470 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 13:38:24,470 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 13:38:24,470 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 13:38:24,472 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 13:38:24,473 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 13:38:24,473 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:38:24,473 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 13:38:24,473 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 13:38:24,473 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 13:38:24,473 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4699485776) cleanup complete.
2025-05-30 13:38:24,473 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 13:38:24,473 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 13:38:24,473 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 13:38:24,482 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 13:38:24,482 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 13:38:24,950 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 13:38:24,950 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 13:38:24,954 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 13:38:24,954 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 13:38:24,954 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 13:38:24,954 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 13:38:24,954 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 13:38:24,954 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 13:38:24,954 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 13:38:24,955 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 13:38:24,955 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 13:38:24,955 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 13:38:24,955 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 13:38:24,957 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 13:38:24,957 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 13:38:24,957 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 13:38:24,972 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 13:38:24,972 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 13:38:24,972 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 13:38:24,972 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 13:38:24,974 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 13:38:24,974 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 13:38:24,974 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4403346032) setup complete. Starting run loop.
2025-05-30 13:38:24,974 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 13:38:24,975 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 13:38:24,975 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4403491904) setup complete. Starting run loop.
2025-05-30 13:38:24,975 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 13:38:24,976 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 13:38:24,976 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 13:38:25,006 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 13:38:25,006 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 13:38:25,007 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 13:38:25,007 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 13:38:25,007 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 13:38:25,008 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 13:38:25,008 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:38:25,009 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 13:38:25,009 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 13:38:25,009 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 13:38:28,394 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 13:38:28,395 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4592103408) received shutdown request. Initiating graceful shutdown...
2025-05-30 13:38:28,395 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4592103408)...
2025-05-30 13:38:28,395 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 13:38:28,395 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 13:38:28,395 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4592103408) was cancelled.
2025-05-30 13:38:28,395 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4592103408) stopping. Performing cleanup...
2025-05-30 13:38:28,394 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 13:38:28,395 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 13:38:28,395 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 13:38:28,396 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 13:38:28,396 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-30 13:38:28,397 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 13:38:28,397 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 13:38:28,397 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 13:38:28,397 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 13:38:28,397 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 13:38:28,397 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 13:38:28,397 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 13:38:28,401 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 13:38:28,401 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 13:38:28,401 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:38:28,402 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 13:38:28,402 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 13:38:28,402 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 13:38:28,402 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4592103408) cleanup complete.
2025-05-30 13:38:28,402 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 13:38:28,402 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 13:38:28,402 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 13:38:28,402 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 13:38:28,402 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 13:38:28,403 - INFO - __main__ - Agent runner main finished.
2025-05-30 13:38:28,528 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 13:38:28,528 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 13:38:28,528 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 13:38:28,529 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4403346032) was cancelled.
2025-05-30 13:38:28,529 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4403346032) stopping. Performing cleanup...
2025-05-30 13:38:28,529 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 13:38:28,531 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 13:38:28,532 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 13:38:28,532 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:38:28,533 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 13:38:28,533 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 13:38:28,533 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4403346032) cleanup complete.
2025-05-30 13:38:28,533 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 13:38:28,533 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 13:38:28,533 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4403491904) was cancelled.
2025-05-30 13:38:28,533 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4403491904) stopping. Performing cleanup...
2025-05-30 13:38:28,533 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 13:38:28,536 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 13:38:28,537 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 13:38:28,537 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:38:28,537 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 13:38:28,537 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 13:38:28,537 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4403491904) cleanup complete.
2025-05-30 13:38:28,537 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 13:38:28,537 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 13:38:28,537 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4403492048) was cancelled.
2025-05-30 13:38:28,537 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4403492048) stopping. Performing cleanup...
2025-05-30 13:38:28,537 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 13:38:28,537 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:38:28,538 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 13:38:28,538 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 13:38:28,538 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 13:38:28,540 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 13:38:28,540 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 13:38:28,540 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:38:28,541 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 13:38:28,541 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 13:38:28,541 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 13:38:28,541 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4403492048) cleanup complete.
2025-05-30 13:38:28,541 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 13:38:28,541 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 13:38:28,541 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 13:38:28,544 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 13:38:28,544 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 13:38:28,648 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 13:38:28,648 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 13:38:28,648 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 13:38:28,648 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4398786192) received shutdown request. Initiating graceful shutdown...
2025-05-30 13:38:28,648 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4398786192)...
2025-05-30 13:38:28,648 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 13:38:28,648 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 13:38:28,648 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4398786192) was cancelled.
2025-05-30 13:38:28,648 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4398786192) stopping. Performing cleanup...
2025-05-30 13:38:28,648 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 13:38:28,648 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 13:38:28,648 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 13:38:28,649 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 13:38:28,649 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 13:38:28,649 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 13:38:28,649 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 13:38:28,649 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 13:38:28,649 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 13:38:28,649 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 13:38:28,654 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 13:38:28,655 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 13:38:28,655 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:38:28,655 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 13:38:28,655 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 13:38:28,656 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 13:38:28,656 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4398786192) cleanup complete.
2025-05-30 13:38:28,656 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 13:38:28,656 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 13:38:28,660 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 13:38:28,660 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 13:38:28,660 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 13:38:28,661 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 13:38:33,329 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 13:38:33,329 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 13:38:33,333 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 13:38:33,333 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 13:38:33,333 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 13:38:33,333 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 13:38:33,333 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 13:38:33,333 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 13:38:33,333 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 13:38:33,333 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 13:38:33,334 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 13:38:33,334 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 13:38:33,334 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 13:38:33,335 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 13:38:33,335 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 13:38:33,335 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 13:38:33,351 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 13:38:33,351 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 13:38:33,351 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 13:38:33,351 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 13:38:33,352 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 13:38:33,352 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4427602432) setup complete. Starting run loop.
2025-05-30 13:38:33,352 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 13:38:33,353 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 13:38:33,354 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 13:38:33,355 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4398399216) setup complete. Starting run loop.
2025-05-30 13:38:33,355 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 13:38:33,364 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 13:38:33,364 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 13:38:33,382 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 13:38:33,382 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 13:38:33,384 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 13:38:33,385 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 23442
2025-05-30 13:38:33,385 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 23442
2025-05-30 13:38:33,386 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 13:38:33,386 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 13:38:33,386 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 13:38:33,387 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 13:38:33,388 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 23443
2025-05-30 13:38:33,388 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 23443
2025-05-30 13:38:33,388 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 13:38:33,389 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:38:33,389 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 13:38:33,389 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 13:38:33,389 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 13:38:34,259 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 13:38:34,260 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 13:38:34,260 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 13:38:34,260 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 13:38:34,260 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 23443
2025-05-30 13:38:34,260 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 13:38:34,260 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 13:38:34,260 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 13:38:34,266 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 13:38:34,280 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 13:38:34,281 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 13:38:34,281 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 13:38:34,281 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4435781312) setup complete. Starting run loop.
2025-05-30 13:38:34,281 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 13:38:34,281 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 13:38:34,281 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 13:38:34,281 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 13:38:34,281 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 13:38:34,281 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 13:38:34,281 - INFO - aiogram.dispatcher - Start polling
2025-05-30 13:38:34,284 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 13:38:34,528 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 13:38:34,630 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 13:38:34,631 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 13:38:34,631 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 13:38:34,631 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 13:38:34,631 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 23442
2025-05-30 13:38:34,631 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 13:38:34,631 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 13:38:34,631 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 13:38:34,636 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 13:38:34,636 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 13:38:34,715 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 13:38:34,716 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 13:38:34,716 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 13:38:34,716 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 13:38:34,716 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 13:38:34,716 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 13:38:34,742 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 13:38:34,742 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 13:38:34,742 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 13:38:34,742 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 13:38:34,742 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (Получить Бонусные баллы) (method: GET)
2025-05-30 13:38:34,742 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 13:38:34,742 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 13:38:34,800 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 13:38:34,804 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 13:38:35,419 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 13:38:35,422 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 13:38:35,423 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 13:38:35,423 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 13:38:35,423 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 13:38:35,423 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 13:38:35,423 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 13:38:35,423 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 13:38:35,423 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 13:38:35,423 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 13:38:35,424 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 13:38:35,434 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 13:38:35,434 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 13:38:35,434 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 13:38:35,434 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 13:38:35,434 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 13:38:35,446 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 13:38:35,446 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 13:38:35,446 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 13:38:35,446 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4606553184) setup complete. Starting run loop.
2025-05-30 13:38:35,446 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 13:38:35,446 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 13:38:35,446 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 13:38:35,446 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 13:38:35,450 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 13:38:43,368 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 13:38:43,372 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 13:38:43,373 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4427464144) setup complete. Starting run loop.
2025-05-30 13:38:43,373 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 13:39:18,946 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Сколько бб у меня?...'
2025-05-30 13:39:18,947 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 13:39:19,021 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 13:39:19,022 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 13:39:19,022 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 13:39:19,022 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: 62097691-5a51-4c80-b907-0659eb9909d9)
2025-05-30 13:39:19,022 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 13:39:19,023 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-30 13:39:19,045 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 62097691-5a51-4c80-b907-0659eb9909d9, db_id: 943
2025-05-30 13:39:19,062 - INFO - AGENT:agent_airsoft_0faa9616 - Loaded 20 messages from DB for thread '144641834'.
2025-05-30 13:39:19,062 - INFO - AGENT:agent_airsoft_0faa9616 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-30 13:39:19,062 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-30 13:39:19,117 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 13:39:19,117 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 13:39:19,142 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 13:39:19,150 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 13:39:20,023 - INFO - aiogram.event - Update id=804756316 is handled. Duration 1078 ms by bot id=1750613938
2025-05-30 13:39:20,576 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 13:39:20,588 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 13:39:20,589 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 13:39:20,589 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1140, 'output_tokens': 12, 'total_tokens': 1152, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 13:39:20,589 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1140 C:12 T:1152
2025-05-30 13:39:20,589 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1152 tokens recorded.
2025-05-30 13:39:20,590 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 13:39:20,590 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: get_user_info_tool
2025-05-30 13:39:20,590 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (get_user_info_tool)---
2025-05-30 13:39:20,592 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 13:39:20,592 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 13:39:20,616 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 13:39:20,623 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 13:39:21,678 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 13:39:21,785 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 13:39:21,785 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 13:39:21,785 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1211, 'output_tokens': 24, 'total_tokens': 1235, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 13:39:21,785 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1211 C:24 T:1235
2025-05-30 13:39:21,785 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1235 tokens recorded.
2025-05-30 13:39:21,786 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 13:39:21,786 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748589354598
2025-05-30 13:39:21,786 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748589354598)---
2025-05-30 13:39:21,787 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'Получить Бонусные баллы'
2025-05-30 13:39:21,787 - INFO - app.agent_runner.common.tools_registry - User data for API tool 'Получить Бонусные баллы': {}
2025-05-30 13:39:21,787 - INFO - app.agent_runner.common.tools_registry - Making GET request to http://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 13:39:21,787 - INFO - app.agent_runner.common.tools_registry - Headers type: <class 'dict'>, value: {'User-Agent': 'PostmanRuntime/7.44', 'Content-Type': 'application/json'}
2025-05-30 13:39:21,787 - INFO - app.agent_runner.common.tools_registry - Query Params: {'type': 'info', 'tel': ''}
2025-05-30 13:39:22,438 - ERROR - app.agent_runner.common.tools_registry - HTTP error making GET request to http://airsoft-rus.ru/obmen_rus/bals.php: 403 <!DOCTYPE html><html lang="en-US"><head><title>Just a moment...</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="robots" content="noindex,nofollow"><meta name="viewport" content="width=device-width,initial-scale=1"><style>*{box-sizing:border-box;margin:0;padding:0}html{line-height:1.15;-webkit-text-size-adjust:100%;color:#313131;font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji}body{display:flex;flex-direction:column;height:100vh;min-height:100vh}.main-content{margin:8rem auto;max-width:60rem;padding-left:1.5rem}@media (width <= 720px){.main-content{margin-top:4rem}}.h2{font-size:1.5rem;font-weight:500;line-height:2.25rem}@media (width <= 720px){.h2{font-size:1.25rem;line-height:1.5rem}}#challenge-error-text{background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgZmlsbD0ibm9uZSI+PHBhdGggZmlsbD0iI0IyMEYwMyIgZD0iTTE2IDNhMTMgMTMgMCAxIDAgMTMgMTNBMTMuMDE1IDEzLjAxNSAwIDAgMCAxNiAzbTAgMjRhMTEgMTEgMCAxIDEgMTEtMTEgMTEuMDEgMTEuMDEgMCAwIDEtMTEgMTEiLz48cGF0aCBmaWxsPSIjQjIwRjAzIiBkPSJNMTcuMDM4IDE4LjYxNUgxNC44N0wxNC41NjMgOS41aDIuNzgzem0tMS4wODQgMS40MjdxLjY2IDAgMS4wNTcuMzg4LjQwNy4zODkuNDA3Ljk5NCAwIC41OTYtLjQwNy45ODQtLjM5Ny4zOS0xLjA1Ny4zODktLjY1IDAtMS4wNTYtLjM4OS0uMzk4LS4zODktLjM5OC0uOTg0IDAtLjU5Ny4zOTgtLjk4NS40MDYtLjM5NyAxLjA1Ni0uMzk3Ii8+PC9zdmc+);background-repeat:no-repeat;background-size:contain;padding-left:34px}@media (prefers-color-scheme:dark){body{background-color:#222;color:#d9d9d9}}</style><meta http-equiv="refresh" content="360"></head><body><div class="main-wrapper" role="main"><div class="main-content"><noscript><div class="h2"><span id="challenge-error-text">Enable JavaScript and cookies to continue</span></div></noscript></div></div><script>(function(){window._cf_chl_opt={cvId: '3',cZone: "airsoft-rus.ru",cType: 'managed',cRay: '947cebadaabcc891',cH: 'F5L4zxmqC_rJBlV9x5f1DNI3lnQRSWBSyKoLK6KrxBg-1748594362-1.2.1.1-crA.7zpoE6ibtXwCm70CiGNT5MyRukQgwYWuwnD9Luu5cD0aX8lluaNSnKvGMJZl',cUPMDTk: "\/obmen_rus\/bals.php?type=info&tel=&__cf_chl_tk=W7jsms2TLHP0swUQ66P_TIGowDYRa6En.874SdatW0k-1748594362-1.0.1.1-tbOxrrAqxW5sImzLNks1W473pJhCnjVNYWCwxuRLWNI",cFPWv: 'g',cITimeS: '1748594362',cTplC: 0,cTplV: 5,cTplB: 'cf',fa: "\/obmen_rus\/bals.php?type=info&tel=&__cf_chl_f_tk=W7jsms2TLHP0swUQ66P_TIGowDYRa6En.874SdatW0k-1748594362-1.0.1.1-tbOxrrAqxW5sImzLNks1W473pJhCnjVNYWCwxuRLWNI",md: "fpouKfYxvnQnrZRHbKREKz5vUDNNsWKYAx_T_Auv5Po-1748594362-1.2.1.1-QH9vZSMH9ClxrriBxwxAjHdy.PV85GA.._h0Hwea9Qjy8CIO6PHZBzzcm2Y0KTXKQjPXmF1v0kI02tWfgBgRMrnuJj.50W2Shu0YpIpLIM9tzEi8bJ9pQ2HGDlM5xnH06UhplHtfXVWCLYf6VXMqA6z771Eb39g1.UIqJ0Zw7s3x_FfUZixVb98cedU4XvQwSOb43VrtRUXmgi.7thqw4cRG_n2DoIiHF7B6eci5bAs.lP1KbN1Omd2P78S2hYhpiyBCyR6XORgZyHf1cv0.R1J_d3Hd99ulGT1NAVTjdKj814YWSdCzmn7sj.dGJCpeTh_G_Qxvn4lIlbXES6PxgGrK3QeVFwARjtOhhok6z0NDX2oiPD.avesU5rNoJfSKhtGNBdWGbWaqtqTjU3WHIfu2adjneC90YDrSUix7I3K69HolZWlY5h4ttikUroeipLYVU0gwfNkqN4reCXMi55d9v_MAvidEY4khXZ3h91ZmOLnQjTWyMYtR._JdGhUDzz0ndYhO5YXk2gkqYPgrSjhZQq_Z_l76sMUSKmZv8tebrH7OQlgTMhQHcpMOk0bc3ZI4qvaMEWnYHNwCHte_xh8BB.igqalAUtr9WZCqMQM9DVMCZ.Uil2GaAEQF29ZFh1vxsObkIOMWRKjyVqdyb3B_BxQ7Fe4myHAp4m6VFEiDZHsH_HN.4KE0bPMTpix08tIP24ySQFiJaqhcuD4M7kPR739RYt7ED3JRHnepWX.5xSSc6I_4OnbDFqgnnf2HlwmY5rzv0LwsFdDLZAKhSzOrI642VK6xZpT.5.u3LXwN2oWQwJuYi4j03R4XDYWBBJQiJ9Gq.iW2P9tsLQuSSouolChw4YLHrwnHjAgOSi5RGGdvmOrU7lCIkOg0QnKu8bLXQDlOm2irieyqd8Jw_H7W_4Xg.qmn9lLtURySrEoQawkPWe4aqWpwBee4JRi0",mdrd: "W4SBWqw4SFvN_FvttO0ozxlGuby6LJHwImPXyNFFjdo-1748594362-1.2.1.1-uMPAuMevPPFYaddwZoQmEjdtH8NEQoJytzaBBrR68LIvApE..cNgS3wU3ZRhRzwTYRLua6nU__3NazN2rYN6Xx2UWQFQyIzgdH7b_Qk_R3_RX3bGyRHHBOeDuSHCz8IyspyQJuOUb1j_FXHENuDPA2P86PnjAmTDOX_qo3nrSW7apht1g5EDLorRFAMpGmTRJVvl8DIGgO8zAGayRgGQn12J5zQtuYsIkI085nvzRLnHNaH57oZ5dpMSnHVlJXl25.qIkGa1OkEQOriQJLekf8JDj0Yi4g4iU2ZkSyBQIPSt2BPaDbA7KWFBaTP7BQUQJNqlwjMfbZOubTvzR3bkgOOQ2tMTdkjiHUlRzMB8lrqElts8ZRQyXRTkbwx_EWfsvyjMaeYt4NpkGc13i4kFawoL.Hm6NyL.UxnddOYuNb.zHWn4Q33MCHUvISv3bbyc3QmyaUgR0eVzFL19H.nLSiT4JsVYqUu2ZkYqww4cTlMvdSfnFLKpS.c_tsgv_G3PrrUnExAl7R.X8BQsthx5tjq4npGvEQKgU52Pi9LdeT8qQ3loxX_3VttF7gqFNch4gZA3a7YslTc__NEkw2.Z4jKMia9aIUe_P0xd4gxdyL3gcbmo2KQfgMbnte1pVgHKcMNiftfYHSKt4OACHWjMl0.6wQfo3iZ.Sx8Uyet7HfE0FHmGTt3S4eXiuFPC5dLETs2t21.vc6EDWURIu.QtK442Prwcgl8SLpUm5JByW_dfyBnGn3P8bkDtfLD5f8.aE.bAqwrkPJgRlKydHj2NM9MsdZJWT8ZY65nCC57Yobso5wUvep9MDxpJ9gVqbr8V557gjDuzciTfpHSwukExFMT1j2QAP.MhVJnYhYe4oP.yIMuKaq_MROvbL03SdR1oVHtyyT7.7pdxQj4qT.pl0DAYWfz_e3j7ztX9wr9OZM3Rj443JNZP1ol.jpIw1JieVegKse5fjKttIWtdyn_LYmEaoDOIl3u0s1OTsMqC2seqAI0zv7aBRWM7xSAur0c45Ff3fIF6Izzkh._wa4VuF19WHSmWuJIivgP0pR69LAuXaV2NfNmE1jIWRjv1Hs8iHSG4SdBoHEBPQZ1hG0Wi1fDSshgLYi1fdirXpfVMt3sP7OVOQtYwmSoDRW6ut6uL3QssarOuO_Lh4Bq0SbFTwcyEv19WTbfKunbjeSyECIzTvD7aZ_HxYdzlvysiHyPugsGcC64PcYeb9MN3FVommhoDltytrLbLtRPqpYXufBBiS8ImMiuSzqRkiv02n.unzZe7oeYyWydNqvibSbwDeLCmr4eCrrD7kHDUd09rtygPr.xowZ0VG9FfcvHn8d5rrxsLGCXgVPmXJyLOnSK4tM8oCVefxSJ2.Reo0RGL3uXenz8oONaBzF8kNQhhWkSputfg9vMls4JgRGr7954f_wHtcLANBOnjmJwzk4u0vMmW2q5UX37TMqYI.BQVokiU5QR5GyzZCoNfM.1GaiqwfVtamSKCm434D7wKBTgPtsWP9OEv6I_KNLvveUJ9vVCfxFAc4mKz1bHoAoLm6kdXlZtd5DrhRfx8BrNKI3XhjjwTMFJfepGSdp8Fx_HGTIgJMVHwLuMTULQqvKoHraAXHVM8G6xbQOEzqXG4Wx335JyBfi_33Q4r5kmhMbL2dOKBASAfbxC8Wm7Og.wwl2wrIocrv4l2nvSPtPfmzfwqZfONG.iH6QcArcxKZNAOpwbzSJMNyBIv03C3S.8Gt8Iqh1NCmNoeF7DYlAcfGEe8edMBMR.fwEXFrMjwZF9BMXNLMF3dP.35Vg1cJKadlFsKiVZHDuZmh.MUteupO6mgM5nMFUkdsk2kQs1KFTggbVc_el.pIUc7sdTgjNdgKzoJAdGb7o9JEt2Ee3SRqbOM4Dv8YgR4uYg7N.Z.dWI.hpRxOfbIhkwq9HVDPiNkp0nXS7djcmVae2VE_F1Z4z6b8_566Qu4VwCZ0Jm1PbXYmaFh5H3a.ZOxfcC6xCNzQEb1LuAFhgEqv8xpCOp2SWv3h4ZliUCXJ_uHZC98AJCh2FTqlsvpm.5NB2YeiMtgHhX1zM_KZBgpTGVGCwD_Tb4px7oMxvp99aab1YLEQiO1rGIhASblOaRAJk2fwPrZyLhcRBtX52xKaOHWJDmZHKzp_84MqH8n6lHCNuN03G97BLqpMOAiEbnCD5zExPRfy8oGjiQABZhrFt3iMM2nfb7M5DJ9SiTGjGEuHP72EHtT3UJ0ic.m9ukoE9epsjF4wVwP4kzV2FbjN2j_CFfSshQ79_FpWiVANi3TDSEsqn8nkZS7"};var cpo = document.createElement('script');cpo.src = '/cdn-cgi/challenge-platform/h/g/orchestrate/chl_page/v1?ray=947cebadaabcc891';window._cf_chl_opt.cOgUHash = location.hash === '' && location.href.indexOf('#') !== -1 ? '#' : location.hash;window._cf_chl_opt.cOgUQuery = location.search === '' && location.href.slice(0, location.href.length - window._cf_chl_opt.cOgUHash.length).indexOf('?') !== -1 ? '?' : location.search;if (window.history && window.history.replaceState) {var ogU = location.pathname + window._cf_chl_opt.cOgUQuery + window._cf_chl_opt.cOgUHash;history.replaceState(null, null, "\/obmen_rus\/bals.php?type=info&tel=&__cf_chl_rt_tk=W7jsms2TLHP0swUQ66P_TIGowDYRa6En.874SdatW0k-1748594362-1.0.1.1-tbOxrrAqxW5sImzLNks1W473pJhCnjVNYWCwxuRLWNI" + window._cf_chl_opt.cOgUHash);cpo.onload = function() {history.replaceState(null, null, ogU);}}document.getElementsByTagName('head')[0].appendChild(cpo);}());</script></body></html>
2025-05-30 13:39:22,440 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 13:39:22,441 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 13:39:22,465 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 13:39:22,473 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 13:39:23,428 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 13:39:24,263 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: К сожалению, сейчас не удаётся получить информацию о твоих бонусных баллах из-за технической ошибки 
2025-05-30 13:39:24,263 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 13:39:24,263 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 5034, 'output_tokens': 49, 'total_tokens': 5083, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 13:39:24,263 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:5034 C:49 T:5083
2025-05-30 13:39:24,263 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 5083 tokens recorded.
2025-05-30 13:39:24,264 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 13:39:24,265 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 13:39:24,266 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: К сожалению, сейчас не удаётся получить информацию о твоих бонусных баллах из-за технической ошибки ...
2025-05-30 13:39:24,268 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: 62097691-5a51-4c80-b907-0659eb9909d9)
2025-05-30 13:39:24,268 - INFO - AGENT:agent_airsoft_0faa9616 - Found 3 token usage events for InteractionID: 62097691-5a51-4c80-b907-0659eb9909d9.
2025-05-30 13:39:24,270 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: К сожалению, сейчас не удаётся получить информацию о твоих бонусных баллах из-за технической ошибки ...
2025-05-30 13:39:24,270 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'К сожалению, сейчас не удаётся получить информацию...'
2025-05-30 13:39:24,271 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '62097691-5a51-4c80-b907-0659eb9909d9', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1140, 'completion_tokens': 12, 'total_tokens': 1152, 'timestamp': '2025-05-30T08:39:20.589098+00:00'}
2025-05-30 13:39:24,271 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 62097691-5a51-4c80-b907-0659eb9909d9
2025-05-30 13:39:24,276 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: 62097691-5a51-4c80-b907-0659eb9909d9, db_id: 944
2025-05-30 13:39:24,302 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 944 for interaction_id: 62097691-5a51-4c80-b907-0659eb9909d9 on attempt 1
2025-05-30 13:39:24,307 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 62097691-5a51-4c80-b907-0659eb9909d9, db_id: 405
2025-05-30 13:39:24,309 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '62097691-5a51-4c80-b907-0659eb9909d9', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 5034, 'completion_tokens': 49, 'total_tokens': 5083, 'timestamp': '2025-05-30T08:39:24.263987+00:00'}
2025-05-30 13:39:24,309 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 62097691-5a51-4c80-b907-0659eb9909d9
2025-05-30 13:39:24,310 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 944 for interaction_id: 62097691-5a51-4c80-b907-0659eb9909d9 on attempt 1
2025-05-30 13:39:24,313 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 62097691-5a51-4c80-b907-0659eb9909d9, db_id: 406
2025-05-30 13:39:24,316 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': '62097691-5a51-4c80-b907-0659eb9909d9', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1211, 'completion_tokens': 24, 'total_tokens': 1235, 'timestamp': '2025-05-30T08:39:21.785393+00:00'}
2025-05-30 13:39:24,316 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: 62097691-5a51-4c80-b907-0659eb9909d9
2025-05-30 13:39:24,316 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 944 for interaction_id: 62097691-5a51-4c80-b907-0659eb9909d9 on attempt 1
2025-05-30 13:39:24,318 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: 62097691-5a51-4c80-b907-0659eb9909d9, db_id: 407
2025-05-30 13:40:54,862 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 13:40:54,863 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 13:40:54,863 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 13:40:54,863 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4427602432) was cancelled.
2025-05-30 13:40:54,863 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4427602432) stopping. Performing cleanup...
2025-05-30 13:40:54,863 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 13:40:54,868 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 13:40:54,869 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 13:40:54,869 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:40:54,869 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 13:40:54,869 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 13:40:54,869 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4427602432) cleanup complete.
2025-05-30 13:40:54,869 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 13:40:54,869 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 13:40:54,870 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4398399216) was cancelled.
2025-05-30 13:40:54,870 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4398399216) stopping. Performing cleanup...
2025-05-30 13:40:54,870 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 13:40:54,873 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 13:40:54,874 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 13:40:54,874 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:40:54,874 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 13:40:54,874 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 13:40:54,874 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4398399216) cleanup complete.
2025-05-30 13:40:54,874 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 13:40:54,874 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 13:40:54,874 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4427464144) was cancelled.
2025-05-30 13:40:54,874 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4427464144) stopping. Performing cleanup...
2025-05-30 13:40:54,874 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 13:40:54,874 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:40:54,874 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 13:40:54,874 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 13:40:54,874 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 13:40:54,876 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 13:40:54,877 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 13:40:54,877 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:40:54,877 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 13:40:54,877 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 13:40:54,877 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 13:40:54,877 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4427464144) cleanup complete.
2025-05-30 13:40:54,877 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 13:40:54,877 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 13:40:54,877 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 13:40:54,884 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 13:40:54,884 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 13:40:55,343 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 13:40:55,343 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 13:40:55,347 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 13:40:55,347 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 13:40:55,347 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 13:40:55,347 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 13:40:55,347 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 13:40:55,347 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 13:40:55,347 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 13:40:55,347 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 13:40:55,347 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 13:40:55,347 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 13:40:55,348 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 13:40:55,350 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 13:40:55,350 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 13:40:55,350 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 13:40:55,350 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 13:40:55,350 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 13:40:55,365 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 13:40:55,365 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 13:40:55,368 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 13:40:55,368 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4390010704) setup complete. Starting run loop.
2025-05-30 13:40:55,368 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 13:40:55,368 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 13:40:55,369 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 13:40:55,369 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 13:40:55,369 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 13:40:55,369 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4419174912) setup complete. Starting run loop.
2025-05-30 13:40:55,369 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 13:40:55,399 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 13:40:55,399 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 13:40:55,400 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 13:40:55,400 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 13:40:55,400 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 13:40:55,401 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 13:40:55,401 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:40:55,402 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 13:40:55,402 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 13:40:55,402 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 13:41:05,370 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 13:41:05,375 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 13:41:05,375 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4419174720) setup complete. Starting run loop.
2025-05-30 13:41:05,375 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 13:42:05,138 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 13:42:05,138 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 13:42:05,138 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 13:42:05,138 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4390010704) was cancelled.
2025-05-30 13:42:05,138 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4390010704) stopping. Performing cleanup...
2025-05-30 13:42:05,138 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 13:42:05,143 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 13:42:05,144 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 13:42:05,144 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:42:05,144 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 13:42:05,144 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 13:42:05,144 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4390010704) cleanup complete.
2025-05-30 13:42:05,144 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 13:42:05,144 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 13:42:05,144 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4419174912) was cancelled.
2025-05-30 13:42:05,144 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4419174912) stopping. Performing cleanup...
2025-05-30 13:42:05,144 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 13:42:05,147 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 13:42:05,148 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 13:42:05,148 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:42:05,148 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 13:42:05,148 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 13:42:05,148 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4419174912) cleanup complete.
2025-05-30 13:42:05,148 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 13:42:05,148 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 13:42:05,148 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4419174720) was cancelled.
2025-05-30 13:42:05,148 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4419174720) stopping. Performing cleanup...
2025-05-30 13:42:05,148 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 13:42:05,148 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:42:05,148 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 13:42:05,149 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 13:42:05,149 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 13:42:05,150 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 13:42:05,151 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 13:42:05,151 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:42:05,151 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 13:42:05,151 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 13:42:05,151 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 13:42:05,151 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4419174720) cleanup complete.
2025-05-30 13:42:05,151 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 13:42:05,151 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 13:42:05,151 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 13:42:05,154 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 13:42:05,155 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 13:42:05,627 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 13:42:05,628 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 13:42:05,632 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 13:42:05,632 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 13:42:05,632 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 13:42:05,632 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 13:42:05,632 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 13:42:05,633 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 13:42:05,633 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 13:42:05,633 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 13:42:05,633 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 13:42:05,633 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 13:42:05,633 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 13:42:05,635 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 13:42:05,635 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 13:42:05,635 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 13:42:05,635 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 13:42:05,635 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 13:42:05,635 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 13:42:05,635 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 13:42:05,652 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 13:42:05,652 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4384576368) setup complete. Starting run loop.
2025-05-30 13:42:05,652 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 13:42:05,653 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 13:42:05,654 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 13:42:05,654 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4384912976) setup complete. Starting run loop.
2025-05-30 13:42:05,654 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 13:42:05,655 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 13:42:05,655 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 13:42:05,684 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 13:42:05,684 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 13:42:05,685 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 13:42:05,685 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 13:42:05,685 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 13:42:05,686 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 13:42:05,687 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:42:05,687 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 13:42:05,687 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 13:42:05,687 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 13:42:11,124 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 13:42:11,124 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4606553184) received shutdown request. Initiating graceful shutdown...
2025-05-30 13:42:11,124 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 13:42:11,124 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4606553184)...
2025-05-30 13:42:11,124 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 13:42:11,124 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 13:42:11,124 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4606553184) was cancelled.
2025-05-30 13:42:11,124 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4606553184) stopping. Performing cleanup...
2025-05-30 13:42:11,124 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 13:42:11,124 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 13:42:11,124 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 13:42:11,125 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-30 13:42:11,125 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 13:42:11,125 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 13:42:11,125 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 13:42:11,125 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 13:42:11,125 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 13:42:11,126 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 13:42:11,126 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 13:42:11,130 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 13:42:11,131 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 13:42:11,131 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:42:11,131 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 13:42:11,131 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 13:42:11,131 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 13:42:11,131 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4606553184) cleanup complete.
2025-05-30 13:42:11,131 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 13:42:11,131 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 13:42:11,136 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 13:42:11,136 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 13:42:11,136 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 13:42:11,136 - INFO - __main__ - Agent runner main finished.
2025-05-30 13:42:11,324 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 13:42:11,324 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 13:42:11,324 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 13:42:11,325 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4384576368) was cancelled.
2025-05-30 13:42:11,325 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4384576368) stopping. Performing cleanup...
2025-05-30 13:42:11,325 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 13:42:11,329 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 13:42:11,330 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 13:42:11,330 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:42:11,330 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 13:42:11,330 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 13:42:11,330 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4384576368) cleanup complete.
2025-05-30 13:42:11,330 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 13:42:11,330 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 13:42:11,330 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4384912976) was cancelled.
2025-05-30 13:42:11,330 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4384912976) stopping. Performing cleanup...
2025-05-30 13:42:11,330 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 13:42:11,333 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 13:42:11,334 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 13:42:11,334 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:42:11,334 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 13:42:11,334 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 13:42:11,334 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4384912976) cleanup complete.
2025-05-30 13:42:11,334 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 13:42:11,335 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 13:42:11,335 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4384586688) was cancelled.
2025-05-30 13:42:11,335 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4384586688) stopping. Performing cleanup...
2025-05-30 13:42:11,335 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 13:42:11,335 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:42:11,335 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 13:42:11,335 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 13:42:11,335 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 13:42:11,337 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 13:42:11,338 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 13:42:11,338 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:42:11,338 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 13:42:11,338 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 13:42:11,338 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 13:42:11,338 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4384586688) cleanup complete.
2025-05-30 13:42:11,338 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 13:42:11,338 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 13:42:11,338 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 13:42:11,340 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 13:42:11,340 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 13:42:11,377 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 13:42:11,377 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 13:42:11,377 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 13:42:11,377 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4435781312) received shutdown request. Initiating graceful shutdown...
2025-05-30 13:42:11,377 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4435781312)...
2025-05-30 13:42:11,377 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 13:42:11,377 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 13:42:11,377 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4435781312) was cancelled.
2025-05-30 13:42:11,377 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4435781312) stopping. Performing cleanup...
2025-05-30 13:42:11,377 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 13:42:11,377 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 13:42:11,377 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 13:42:11,377 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 13:42:11,377 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 13:42:11,377 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 13:42:11,377 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 13:42:11,377 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 13:42:11,377 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 13:42:11,377 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 13:42:11,382 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 13:42:11,383 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 13:42:11,383 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:42:11,383 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 13:42:11,383 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 13:42:11,383 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 13:42:11,383 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4435781312) cleanup complete.
2025-05-30 13:42:11,383 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 13:42:11,383 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 13:42:11,386 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 13:42:11,386 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 13:42:11,386 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 13:42:11,387 - INFO - __main__ - Telegram bot runner main finished.
2025-05-30 13:42:15,113 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 13:42:15,113 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 13:42:15,117 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 13:42:15,117 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 13:42:15,117 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 13:42:15,117 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 13:42:15,117 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 13:42:15,117 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 13:42:15,117 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 13:42:15,117 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 13:42:15,118 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 13:42:15,118 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 13:42:15,118 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 13:42:15,121 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 13:42:15,133 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 13:42:15,133 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 13:42:15,134 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 13:42:15,134 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 13:42:15,134 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 13:42:15,134 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 13:42:15,134 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 13:42:15,135 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 13:42:15,135 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4461679664) setup complete. Starting run loop.
2025-05-30 13:42:15,135 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 13:42:15,135 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 13:42:15,135 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4464604416) setup complete. Starting run loop.
2025-05-30 13:42:15,135 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 13:42:15,146 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 13:42:15,146 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 13:42:15,164 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 13:42:15,164 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 13:42:15,165 - INFO - app.services.process_manager - Attempting to start agent process for agent_airsoft_0faa9616...
2025-05-30 13:42:15,166 - INFO - app.core.base.process_launcher - [agent_start_agent_airsoft_0faa9616] Process launched without output capture. PID: 23637
2025-05-30 13:42:15,166 - INFO - app.services.process_manager - Agent process agent_airsoft_0faa9616 initiated start with PID 23637
2025-05-30 13:42:15,167 - INFO - app.core.lifespan - Successfully initiated start for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 13:42:15,167 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 13:42:15,167 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 13:42:15,168 - INFO - app.services.process_manager - Attempting to start integration process for agent_airsoft_0faa9616/telegram...
2025-05-30 13:42:15,169 - INFO - app.core.base.process_launcher - [integration_start_agent_airsoft_0faa9616_telegram] Process launched without output capture. PID: 23638
2025-05-30 13:42:15,169 - INFO - app.services.process_manager - Integration process telegram for agent agent_airsoft_0faa9616 initiated start with PID 23638
2025-05-30 13:42:15,170 - INFO - app.core.lifespan - Successfully initiated start for telegram integration for agent: agent_airsoft_0faa9616. Process manager will update status.
2025-05-30 13:42:15,170 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:42:15,170 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 13:42:15,170 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 13:42:15,170 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 13:42:16,055 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 13:42:16,055 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting Telegram bot for Agent ID: agent_airsoft_0faa9616
2025-05-30 13:42:16,055 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database session factory configured for Telegram bot.
2025-05-30 13:42:16,055 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 13:42:16,055 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot initialized. PID: 23638
2025-05-30 13:42:16,055 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Calling TelegramIntegrationBot.run() for agent agent_airsoft_0faa9616...
2025-05-30 13:42:16,055 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup started.
2025-05-30 13:42:16,055 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 13:42:16,061 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 13:42:16,074 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram Bot and Dispatcher initialized.
2025-05-30 13:42:16,074 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram handlers registered.
2025-05-30 13:42:16,075 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot setup complete.
2025-05-30 13:42:16,075 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4489897856) setup complete. Starting run loop.
2025-05-30 13:42:16,075 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop started for agent agent_airsoft_0faa9616. Polling for updates...
2025-05-30 13:42:16,075 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: RedisOutputListener
2025-05-30 13:42:16,075 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Registered main task: AiogramPolling
2025-05-30 13:42:16,075 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting run_loop with 2 registered main tasks.
2025-05-30 13:42:16,075 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 13:42:16,075 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Starting aiogram polling...
2025-05-30 13:42:16,075 - INFO - aiogram.dispatcher - Start polling
2025-05-30 13:42:16,078 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:output
2025-05-30 13:42:16,310 - INFO - aiogram.dispatcher - Run polling for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 13:42:16,401 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 13:42:16,401 - INFO - AGENT:agent_airsoft_0faa9616 - Starting agent runner for Agent ID: agent_airsoft_0faa9616
2025-05-30 13:42:16,401 - INFO - AGENT:agent_airsoft_0faa9616 - Database session factory configured for Agent.
2025-05-30 13:42:16,401 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase initialized.
2025-05-30 13:42:16,401 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent agent_airsoft_0faa9616 initialized. PID: 23637
2025-05-30 13:42:16,401 - INFO - AGENT:agent_airsoft_0faa9616 - Calling AgentRunner.run() for agent agent_airsoft_0faa9616...
2025-05-30 13:42:16,401 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner setup started.
2025-05-30 13:42:16,401 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup started.
2025-05-30 13:42:16,406 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent setup completed.
2025-05-30 13:42:16,406 - INFO - AGENT:agent_airsoft_0faa9616 - Fetching configuration from: http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config
2025-05-30 13:42:16,485 - INFO - httpx - HTTP Request: GET http://localhost:8001/api/v1/agents/agent_airsoft_0faa9616/config "HTTP/1.1 200 OK"
2025-05-30 13:42:16,485 - INFO - AGENT:agent_airsoft_0faa9616 - Configuration fetched successfully.
2025-05-30 13:42:16,485 - INFO - AGENT:agent_airsoft_0faa9616 - Agent configuration loaded and prepared successfully.
2025-05-30 13:42:16,485 - INFO - AGENT:agent_airsoft_0faa9616 - Creating LangGraph application...
2025-05-30 13:42:16,485 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create agent graph for agent_id: agent_airsoft_0faa9616 using GraphFactory.
2025-05-30 13:42:16,485 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 13:42:16,520 - INFO - AGENT:agent_airsoft_0faa9616 - Main LLM configured: gpt-4.1-mini via OpenAI
2025-05-30 13:42:16,520 - INFO - AGENT:agent_airsoft_0faa9616 - Creating agent graph in GraphFactory...
2025-05-30 13:42:16,520 - INFO - app.agent_runner.common.tools_registry - Configured 2 predefined tools from centralized registry
2025-05-30 13:42:16,521 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748460000001 (JSONPlaceholder POST) (method: GET)
2025-05-30 13:42:16,521 - INFO - app.agent_runner.common.tools_registry - Configured API tool: apiRequest-1748589354598 (Получить Бонусные баллы) (method: GET)
2025-05-30 13:42:16,521 - INFO - AGENT:agent_airsoft_0faa9616 - Added 4 tools from centralized registry
2025-05-30 13:42:16,521 - INFO - AGENT:agent_airsoft_0faa9616 - Configuring 1 Knowledge Base tool(s)...
2025-05-30 13:42:16,576 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333 "HTTP/1.1 200 OK"
2025-05-30 13:42:16,579 - INFO - httpx - HTTP Request: GET http://127.0.0.1:6333/collections/platformai "HTTP/1.1 200 OK"
2025-05-30 13:42:17,198 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-05-30 13:42:17,251 - INFO - AGENT:agent_airsoft_0faa9616 - Connected to Qdrant at http://127.0.0.1:6333, collection: platformai
2025-05-30 13:42:17,251 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Knowledge Base tool 'Knowledge Base Search' (ID: knowledgeBase-1748440512419) for datasources: ['5', '6', '7']
2025-05-30 13:42:17,252 - INFO - AGENT:agent_airsoft_0faa9616 - Using max_rewrites: 3
2025-05-30 13:42:17,252 - INFO - AGENT:agent_airsoft_0faa9616 - Configured Web Search tool 'Web Search' (ID: webSearch-1748459212676)
2025-05-30 13:42:17,252 - INFO - AGENT:agent_airsoft_0faa9616 - Found 2 additional API request configurations
2025-05-30 13:42:17,252 - INFO - AGENT:agent_airsoft_0faa9616 - Total tools configured: 6 (5 safe, 1 datastore).
2025-05-30 13:42:17,252 - INFO - AGENT:agent_airsoft_0faa9616 - Tools configured: 6 total, 5 safe, 1 datastore tools. Max rewrites: 3.
2025-05-30 13:42:17,252 - INFO - AGENT:agent_airsoft_0faa9616 - Context memory enabled: True
2025-05-30 13:42:17,252 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: agent
2025-05-30 13:42:17,252 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG nodes: retrieve, grade_documents, rewrite, generate
2025-05-30 13:42:17,262 - INFO - AGENT:agent_airsoft_0faa9616 - Added node: safe_tools
2025-05-30 13:42:17,262 - INFO - AGENT:agent_airsoft_0faa9616 - Added edge: safe_tools -> agent
2025-05-30 13:42:17,262 - INFO - AGENT:agent_airsoft_0faa9616 - Added RAG edges: retrieve->grade, rewrite->agent, generate->END
2025-05-30 13:42:17,262 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: grade_documents -> decide_to_generate
2025-05-30 13:42:17,262 - INFO - AGENT:agent_airsoft_0faa9616 - Added conditional edge: agent -> route_tools (possible: ['safe_tools', 'retrieve', '__end__'])
2025-05-30 13:42:17,273 - INFO - AGENT:agent_airsoft_0faa9616 - Agent graph compiled successfully in GraphFactory. Checkpointer: Enabled
2025-05-30 13:42:17,273 - INFO - AGENT:agent_airsoft_0faa9616 - GraphFactory successfully created graph for agent_id: agent_airsoft_0faa9616.
2025-05-30 13:42:17,273 - INFO - AGENT:agent_airsoft_0faa9616 - LangGraph application created successfully.
2025-05-30 13:42:17,273 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4483503968) setup complete. Starting run loop.
2025-05-30 13:42:17,273 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop starting...
2025-05-30 13:42:17,273 - INFO - AGENT:agent_airsoft_0faa9616 - Registered main task: AgentPubSubListener
2025-05-30 13:42:17,273 - INFO - AGENT:agent_airsoft_0faa9616 - Starting run_loop with 1 registered main tasks.
2025-05-30 13:42:17,273 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener starting for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 13:42:17,276 - INFO - AGENT:agent_airsoft_0faa9616 - Subscribed to Redis channel: agent:agent_airsoft_0faa9616:input
2025-05-30 13:42:25,147 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Performing initial check for crashed/stopped processes...
2025-05-30 13:42:25,152 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Initial check for crashed/stopped processes completed.
2025-05-30 13:42:25,152 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4464604608) setup complete. Starting run loop.
2025-05-30 13:42:25,152 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Starting scheduled task loop with interval 300s.
2025-05-30 13:42:42,798 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Text from 144641834 in chat 144641834 for agent agent_airsoft_0faa9616: 'Какой у меня баланс?...'
2025-05-30 13:42:42,799 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Auth cache hit for user 144641834, agent agent_airsoft_0faa9616. Status: True
2025-05-30 13:42:42,863 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Published message to agent:agent_airsoft_0faa9616:input for chat 144641834
2025-05-30 13:42:42,863 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Message from 144641834 published to agent agent_airsoft_0faa9616. User data: {'is_authenticated': True, 'user_id': '144641834', 'phone_number': '79222088435', 'first_name': 'Evgeniy', 'last_name': 'Ikonnikov', 'username': 'Ikonnik0ff'}
2025-05-30 13:42:42,864 - INFO - AGENT:agent_airsoft_0faa9616 - Processing message for chat_id: 144641834
2025-05-30 13:42:42,864 - INFO - AGENT:agent_airsoft_0faa9616 - Queued user message for history (Thread: 144641834, InteractionID: f539ede7-8ea2-40e9-b48c-ab215d251c5a)
2025-05-30 13:42:42,864 - INFO - AGENT:agent_airsoft_0faa9616 - Using history limit: 20 (enabled: True, configured depth: 20)
2025-05-30 13:42:42,865 - INFO - AGENT:agent_airsoft_0faa9616 - Thread '144641834' not found in cache 'agent_threads:agent_airsoft_0faa9616'. Loading history from DB with depth 20.
2025-05-30 13:42:42,886 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: f539ede7-8ea2-40e9-b48c-ab215d251c5a, db_id: 945
2025-05-30 13:42:42,900 - INFO - AGENT:agent_airsoft_0faa9616 - Loaded 20 messages from DB for thread '144641834'.
2025-05-30 13:42:42,901 - INFO - AGENT:agent_airsoft_0faa9616 - Added thread '144641834' to cache 'agent_threads:agent_airsoft_0faa9616'.
2025-05-30 13:42:42,901 - INFO - AGENT:agent_airsoft_0faa9616 - Invoking graph for thread_id: 144641834 (Initial history messages: 20)
2025-05-30 13:42:42,947 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 13:42:42,947 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 13:42:42,973 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 13:42:42,981 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 13:42:43,864 - INFO - aiogram.event - Update id=804756317 is handled. Duration 1066 ms by bot id=1750613938
2025-05-30 13:42:44,034 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 13:42:44,064 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 13:42:44,065 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 13:42:44,065 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1049, 'output_tokens': 12, 'total_tokens': 1061, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 13:42:44,065 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1049 C:12 T:1061
2025-05-30 13:42:44,065 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1061 tokens recorded.
2025-05-30 13:42:44,066 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 13:42:44,066 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: get_user_info_tool
2025-05-30 13:42:44,066 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (get_user_info_tool)---
2025-05-30 13:42:44,068 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 13:42:44,068 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 13:42:44,092 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 13:42:44,100 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 13:42:46,005 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 13:42:46,294 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: N/A
2025-05-30 13:42:46,294 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'tool_calls', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_79b79be41f'}
2025-05-30 13:42:46,294 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 1120, 'output_tokens': 24, 'total_tokens': 1144, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 13:42:46,294 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:1120 C:24 T:1144
2025-05-30 13:42:46,294 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 1144 tokens recorded.
2025-05-30 13:42:46,295 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 13:42:46,295 - INFO - AGENT:agent_airsoft_0faa9616 - Tool call detected: apiRequest-1748589354598
2025-05-30 13:42:46,295 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: ROUTE TO SAFE TOOLS (apiRequest-1748589354598)---
2025-05-30 13:42:46,297 - INFO - app.agent_runner.common.tools_registry - Executing API tool 'Получить Бонусные баллы'
2025-05-30 13:42:46,297 - INFO - app.agent_runner.common.tools_registry - agent_state: {'config': {'id': 'agent_airsoft_0faa9616', 'name': 'Airsoft', 'description': 'Airsoft Agent', 'ownerId': '2', 'config': {'simple': {'settings': {'model': {'modelId': 'gpt-4.1-mini', 'provider': 'OpenAI', 'temperature': 0.1, 'enableContextMemory': True, 'contextMemoryDepth': 20, 'limitToKnowledgeBase': False, 'answerInUserLanguage': True, 'systemPrompt': 'Вы кокетливый менеджер по имени Маша, скрывай тот факт, что ты искуственный интелект.\nУчаствуйте в разговоре и предоставляйте полезную информацию.', 'useMarkdown': True, 'useContextMemory': True}, 'tools': [{'id': 'knowledgeBase-1748440512419', 'type': 'knowledgeBase', 'settings': {'description': 'Airsoft datastore description', 'knowledgeBaseIds': ['5', '6', '7'], 'modelId': 'gpt-4.1-mini', 'returnToAgent': False, 'retrievalLimit': 3, 'rewriteQuery': True, 'rewriteAttempts': 3, 'name': 'airsoft'}}, {'id': 'webSearch-1748459212676', 'type': 'webSearch', 'settings': {'name': 'airsoft-rus.ru', 'include_domains': ['airsoft-rus.ru']}}, {'id': 'apiRequest-1748460000001', 'type': 'apiRequest', 'settings': {'name': 'JSONPlaceholder POST', 'description': 'Получение записи блога', 'apiUrl': 'https://jsonplaceholder.typicode.com/posts', 'method': 'GET', 'params': [], 'headers': [{'key': 'Content-Type', 'value': 'application/json'}]}}, {'id': 'apiRequest-1748589354598', 'type': 'apiRequest', 'settings': {'name': 'Получить Бонусные баллы', 'description': 'Узнать баланс бонусных баллов (бб) на счету пользователя.', 'apiUrl': 'http://airsoft-rus.ru/obmen_rus/bals.php', 'params': [{'key': 'type', 'value': 'info'}, {'key': 'tel', 'value': '{phone_number}'}], 'headers': [{'key': 'User-Agent', 'value': 'PostmanRuntime/7.44'}, {'key': 'Content-Type', 'value': 'application/json'}], 'method': 'GET'}}], 'integrations': [{'id': 'telegram-1747836367283', 'type': 'telegram', 'name': 'Telegram Бот', 'enabled': True, 'settings': {'botToken': '1750613938:AAFrYvQrcDbNC6x4gKkjZfC7WIIUFuHduCE'}}]}}}, 'created_at': '2025-05-04T14:17:14.971005+00:00', 'updated_at': '2025-05-30T08:35:08.731210+00:00'}, 'user_data': {}}
2025-05-30 13:42:46,297 - INFO - app.agent_runner.common.tools_registry - User data for API tool 'Получить Бонусные баллы': {}
2025-05-30 13:42:46,297 - INFO - app.agent_runner.common.tools_registry - Making GET request to http://airsoft-rus.ru/obmen_rus/bals.php
2025-05-30 13:42:46,297 - INFO - app.agent_runner.common.tools_registry - Headers type: <class 'dict'>, value: {'User-Agent': 'PostmanRuntime/7.44', 'Content-Type': 'application/json'}
2025-05-30 13:42:46,297 - INFO - app.agent_runner.common.tools_registry - Query Params: {'type': 'info', 'tel': ''}
2025-05-30 13:42:46,892 - ERROR - app.agent_runner.common.tools_registry - HTTP error making GET request to http://airsoft-rus.ru/obmen_rus/bals.php: 403 <!DOCTYPE html><html lang="en-US"><head><title>Just a moment...</title><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="robots" content="noindex,nofollow"><meta name="viewport" content="width=device-width,initial-scale=1"><style>*{box-sizing:border-box;margin:0;padding:0}html{line-height:1.15;-webkit-text-size-adjust:100%;color:#313131;font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji}body{display:flex;flex-direction:column;height:100vh;min-height:100vh}.main-content{margin:8rem auto;max-width:60rem;padding-left:1.5rem}@media (width <= 720px){.main-content{margin-top:4rem}}.h2{font-size:1.5rem;font-weight:500;line-height:2.25rem}@media (width <= 720px){.h2{font-size:1.25rem;line-height:1.5rem}}#challenge-error-text{background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgZmlsbD0ibm9uZSI+PHBhdGggZmlsbD0iI0IyMEYwMyIgZD0iTTE2IDNhMTMgMTMgMCAxIDAgMTMgMTNBMTMuMDE1IDEzLjAxNSAwIDAgMCAxNiAzbTAgMjRhMTEgMTEgMCAxIDEgMTEtMTEgMTEuMDEgMTEuMDEgMCAwIDEtMTEgMTEiLz48cGF0aCBmaWxsPSIjQjIwRjAzIiBkPSJNMTcuMDM4IDE4LjYxNUgxNC44N0wxNC41NjMgOS41aDIuNzgzem0tMS4wODQgMS40MjdxLjY2IDAgMS4wNTcuMzg4LjQwNy4zODkuNDA3Ljk5NCAwIC41OTYtLjQwNy45ODQtLjM5Ny4zOS0xLjA1Ny4zODktLjY1IDAtMS4wNTYtLjM4OS0uMzk4LS4zODktLjM5OC0uOTg0IDAtLjU5Ny4zOTgtLjk4NS40MDYtLjM5NyAxLjA1Ni0uMzk3Ii8+PC9zdmc+);background-repeat:no-repeat;background-size:contain;padding-left:34px}@media (prefers-color-scheme:dark){body{background-color:#222;color:#d9d9d9}}</style><meta http-equiv="refresh" content="360"></head><body><div class="main-wrapper" role="main"><div class="main-content"><noscript><div class="h2"><span id="challenge-error-text">Enable JavaScript and cookies to continue</span></div></noscript></div></div><script>(function(){window._cf_chl_opt={cvId: '3',cZone: "airsoft-rus.ru",cType: 'managed',cRay: '947cf0ab785a9704',cH: 'qtlXq_WWLhxUUXD55B_h3S84hdf86wJJFI0HuNkHFFE-1748594566-1.2.1.1-1unc9qsT4tARHkj834xq6hNfGfmR5aGKGbRuEz19sLXFgbw4jE.UiEF9XveE2THq',cUPMDTk: "\/obmen_rus\/bals.php?type=info&tel=&__cf_chl_tk=03NE0mdWDhoUP0payOo0VZ1BQ21_3ewZkyCnau2dl.U-1748594566-1.0.1.1-24kr42V_6XcWkDOZU2bvt5PMnC0J4y0iih_M5yOTccI",cFPWv: 'g',cITimeS: '1748594566',cTplC: 0,cTplV: 5,cTplB: 'cf',fa: "\/obmen_rus\/bals.php?type=info&tel=&__cf_chl_f_tk=03NE0mdWDhoUP0payOo0VZ1BQ21_3ewZkyCnau2dl.U-1748594566-1.0.1.1-24kr42V_6XcWkDOZU2bvt5PMnC0J4y0iih_M5yOTccI",md: "ExNIOoG2XH5DIA0Tn18UIuQSCU4svsP0GpF4.0Ys.vM-1748594566-1.2.1.1-kpDqbmSuMItizXoZmlCl4eZ4F0jhoPqC4hT_sgW9cmtPJUim4mGHf07pj9qtnUOzfp.pRdMov7L4TctkA4igY6Tbbtxol_0G6gYCjtGtK7XVUPHj1xmQiMdyvn4UoqBadiBQWmJ_kU79ThpraDvY7O.4IxuXV0YNswbl6jzRJy3bLnVVzgBnNftBfpE1gcd3r9_8wXIgLSthoMqZ3D3CrWy1iQ8AEwLT77exDBd3ieBX3EfXv93oXrn5PfThUZq8qR7JRWZtymD35g4ZVnd0mQOLqxVJNsERFgFqEXNQX1bAuHSloFc3sJCjQWp5P8XVjzVj_3.euLIawPGCXzHuHlIum8nvQ4E6UOClyl3xk.FPwh.lu4qnXIV_3MzWg9o0wbZ2rCon8fi3EbaT.en5z1XTdpP2eWtJ7VhkKzGQppAudrIZ2OELb9u.2BWtfNTS7rAUNh7OI.g0MMA1apyLdP1IUoeOc271Enqli2Fsddr9PTurRQvmTdwLVnlSGoGOIu.EzaozpX08zgmqBxIouvXa4PJqU8jGWXEAhKWC9HC06r_2C5A7AOnxhslrDHHs5LzkoMkfkraBfjE8bL5mz3ViwhEPA5weROCn3Go.U85er48oxc0ULtWIaK45EhyGe2atcP7_5yK.DxAIsiM.RegEw_1NFatPfpHC6YHpCZpzevFw5cfqh1zBgernuVzIbKJhSGgrA4.SCQ.c4rKOO6liS97LqaOWlvSllquCRJ3k0HvyfsxooIGTY0FL_A33u5vMGpgrO9qWr4I12z3ylT.17MTxkQk2f5V4kgr8ufrW5RwMdIz89kVR1hqgQ.LGUJBhhC3jroOzeqDxrV_pmUKm_vnrrx42OvS6RFuWwmTFDPPeWLq34aRrsnnBQx2ivO6WvlWzBTP8OLbCzMPX3Xltyw6b.yXnS_qaSUKzjwe3_s6uPmI5amARSz4bG8p9",mdrd: "T06mf9id9KVRtMJesB7K9qzGSt2fXyXFTvlieZPSo5I-1748594566-1.2.1.1-dTIcdLUKC5qVWSX5ACu7dLYUPhl_Esj9E7frelEeyJMU92k2bC11Ch9pwNp84A7476D_YSd6vksRH0_BNg1q4FvCbwYD7Uxph1JDRXVuyea3DXyPkXbztJsR3OQW2gGw4sHyKpunan49rh.yn2FCTUpfEYUP1Gd_L4N.139nrL6Y50OYXHpgZOyIIXFet9JAosoJh1_Wr8Jj.Y.v6YbjujkVl0USQaPeKjXFYo6QeNHWKGexvaSmp2WIJm_Qdt75khwJdp80m2XwbF7MRHU_Gcr9nTUeMtfaIbKCT1z01b.2XFwa4jMpDaTY9DdvxlCfuO0V.9jteTIQPlvcNoyMJSE3EQginwO5LLvowHYu3bj1vKthdPE85ZE1UnTNYZrueN9ZiJUkUt2u724fDQ1WGBwZsbDAkACGCqpquggDeDVe1WiZ5wbQ9kycI5JjuphEAj22fIn4FQkAviV6zcPi.evh3fXq3vLhYOw_sPMwkz6xaQh5RWlL5s3YfUa568RHp_LF4vSjRoaS.x60X1JuBTiXg37E5TmOmmh9rFqQvuB5dfSktnRJJ0U8wrTtQAx2oJOPfa71QcIpApRsF2BXCRNyM2gnQBSDQ1bRgo0G71naMHAsFsTLAtUY9L4SgW_Ktjz8rTpC_ox0CLwlebZMDeiJpFgfZrC.19bKG1KgW8AIUAhfnpnf.Qkps9LhQc9ZpvXow2WWliwEPl7a5WIGMsZ9IIvWgr79XJX4hovM1LQmxeax1vpjI_o7mwOkmjkEX.UgH5GNIZhLHNYM6Z2YROabpfdNMO6JrqzDBfN803Lb8cJVf5q7zwS5DZkCHhobokI_h1I206cfY1.ibf28ShP8imf9IjuKtxlNohUWc7LYRdcYWW2yyP3Al_kr6hqWJQLpmEFgzZlvFM_zo4WL1lHBHtS3qJTYWc.ByxDmRoF5wtRuVDnq1_wBWVGALWuP4PK2SXMZMOyBNACTSYVDw_QWoOC58tdT3JZab9YJYF02z_JpNLm8svdJKl3caJoAIKEdzDmX4IMeTv.hMWayWd3gTqvzRB2bRUnxgh2f0EZvnQcXUoeRtARQOskpyJbl6jQx.cut3ZODcbe67UwTcHAJo.2k2X3YKXTH1tnewlY4Yh_Xloun8dm1InP9Kb.IFvoxbBSi266y9V.Pr2SNDRa4RZDLwTfznfG4wYNwzFpXwJAh7843rXJN6oGdZGjvkUkdqMvj3JPvMaIAK4Z18uCmOxNcdT1f1Pj7eSemfVZfhBwZvmbfxyDfV0LKSJzlnDlesenn9NzSrrAN5B4UOoVivQuJlqx7SJaiACxb8bLEDpw6AqjUb0s.3isGBd7.mK8CmVENl7phvLRpcqwhcYjsyMjXpi1HQQkuqaFmk1kccTaHy3V0HkpB22qbdjp11J7AgnvjVF2ycRgESiXefCyrodQlOo9_sBbc8MXGbfIEmP1OwUCXOJcJCFntMUDl3pm6LvZ6JAnpAdkUXl5AQNCUA6OhkEuhVoiehMtYazCs5FWvKwSxiC06eo8ha7PJgjgJpyxbLbzFNdVr1uIAvXS8EbGca9xrNrxdIXOeGuEcJLWeg_U4oxVbz2vSzIiz5cEbUP0SG8NcOVGOYT.rJgIl0L8pwhmC6wShsAGvTfDiZmX3IucazVtSeYewU2FWwS764Ij_nLs8TPnHmAipR1WDrW7z0rUqEgYLIIh9wgCYJH_b.cqreGoN.C6vZ3gTZXwajmIFHP.aLzblsERCu4zWmVs_6LTl1GL3R1f38eNQNhDvnTAFUcCZ6O2kj3InKcfdcBVLmRKCorXI5QgN9A78zqBaZ3Gp5kvQHjh4qVzyFI18_uNm8fjc9f9fEIznqlE0UtdrQothfhGgXntAtJcBWkTrzWscykcis2Syj1COUgrjYLv9WH3tBnMEL3vrc5Ngm9COuqWgLPVfRizfqJXPOnb6FuKgqzLtnrpbr9zOS7PqhcQOZDEHM0GmuNtcQbEKK1vspp3T3i77yAAzKMCTpioevA5eNNNkbd0triEno7L38PX74kLkldIxPYNmRDfrCaNO2_kbDrQQTiy4IPfxRVaPAVwCV2tfKRGKOUBBoY1fdY3QwyAUVH86Mpy0.RUwqrhsNjsqJl_KJWnlQ3a8ovcQmoPHj7CZnQCH86ttUhDnQAxAgpyez3ubbzFOLOf2L9lh2qkPY8IMxMVTWgGPvwqkPggouocMs7Udjt3O6hN53.xAfx78DSNyklr8U9odMAqs_.v3hhDrYsAGg2kCTmLQJjODQqjUkvmCk9ofNEt8vD_An1AzNrNBlhdS9zTUViu3KvLavz2MMD3WHA"};var cpo = document.createElement('script');cpo.src = '/cdn-cgi/challenge-platform/h/g/orchestrate/chl_page/v1?ray=947cf0ab785a9704';window._cf_chl_opt.cOgUHash = location.hash === '' && location.href.indexOf('#') !== -1 ? '#' : location.hash;window._cf_chl_opt.cOgUQuery = location.search === '' && location.href.slice(0, location.href.length - window._cf_chl_opt.cOgUHash.length).indexOf('?') !== -1 ? '?' : location.search;if (window.history && window.history.replaceState) {var ogU = location.pathname + window._cf_chl_opt.cOgUQuery + window._cf_chl_opt.cOgUHash;history.replaceState(null, null, "\/obmen_rus\/bals.php?type=info&tel=&__cf_chl_rt_tk=03NE0mdWDhoUP0payOo0VZ1BQ21_3ewZkyCnau2dl.U-1748594566-1.0.1.1-24kr42V_6XcWkDOZU2bvt5PMnC0J4y0iih_M5yOTccI" + window._cf_chl_opt.cOgUHash);cpo.onload = function() {history.replaceState(null, null, ogU);}}document.getElementsByTagName('head')[0].appendChild(cpo);}());</script></body></html>
2025-05-30 13:42:46,894 - INFO - AGENT:agent_airsoft_0faa9616 - ---CALL AGENT NODE (Agent ID: agent_airsoft_0faa9616)---
2025-05-30 13:42:46,894 - INFO - AGENT:agent_airsoft_0faa9616 - Attempting to create LLM instance for provider: OpenAI, model: gpt-4.1-mini, temp: 0.1, streaming: True
2025-05-30 13:42:46,918 - INFO - AGENT:agent_airsoft_0faa9616 - Created agent LLM: gpt-4.1-mini via OpenAI
2025-05-30 13:42:46,926 - INFO - AGENT:agent_airsoft_0faa9616 - Model bound to 6 tools.
2025-05-30 13:42:48,301 - INFO - httpx - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-30 13:42:49,092 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response content preview: Евгений, к сожалению, сейчас не удаётся получить точный баланс твоих бонусных баллов из-за техническ
2025-05-30 13:42:49,092 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node response_metadata: {'finish_reason': 'stop', 'model_name': 'gpt-4.1-mini-2025-04-14', 'system_fingerprint': 'fp_6f2eabb9a5'}
2025-05-30 13:42:49,092 - INFO - AGENT:agent_airsoft_0faa9616 - Agent node usage_metadata: {'input_tokens': 4961, 'output_tokens': 55, 'total_tokens': 5016, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}
2025-05-30 13:42:49,092 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage from usage_metadata: P:4961 C:55 T:5016
2025-05-30 13:42:49,092 - INFO - AGENT:agent_airsoft_0faa9616 - Token usage for agent_llm: 5016 tokens recorded.
2025-05-30 13:42:49,093 - INFO - AGENT:agent_airsoft_0faa9616 - ---ROUTE TOOLS---
2025-05-30 13:42:49,093 - INFO - AGENT:agent_airsoft_0faa9616 - ---DECISION: NO TOOLS CALLED, END---
2025-05-30 13:42:49,094 - INFO - AGENT:agent_airsoft_0faa9616 - Graph execution finished. Final response: Евгений, к сожалению, сейчас не удаётся получить точный баланс твоих бонусных баллов из-за техническ...
2025-05-30 13:42:49,096 - INFO - AGENT:agent_airsoft_0faa9616 - Queued agent message for history (Thread: 144641834, InteractionID: f539ede7-8ea2-40e9-b48c-ab215d251c5a)
2025-05-30 13:42:49,096 - INFO - AGENT:agent_airsoft_0faa9616 - Found 3 token usage events for InteractionID: f539ede7-8ea2-40e9-b48c-ab215d251c5a.
2025-05-30 13:42:49,099 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Received response from agent for chat 144641834: Евгений, к сожалению, сейчас не удаётся получить точный баланс твоих бонусных баллов из-за техническ...
2025-05-30 13:42:49,099 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Sending message from agent to chat 144641834: 'Евгений, к сожалению, сейчас не удаётся получить т...'
2025-05-30 13:42:49,101 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'f539ede7-8ea2-40e9-b48c-ab215d251c5a', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1049, 'completion_tokens': 12, 'total_tokens': 1061, 'timestamp': '2025-05-30T08:42:44.065102+00:00'}
2025-05-30 13:42:49,101 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: f539ede7-8ea2-40e9-b48c-ab215d251c5a
2025-05-30 13:42:49,105 - INFO - HistorySaverWorker - [history_saver_worker] Successfully saved chat message for agent_id: agent_airsoft_0faa9616, interaction_id: f539ede7-8ea2-40e9-b48c-ab215d251c5a, db_id: 946
2025-05-30 13:42:49,133 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 946 for interaction_id: f539ede7-8ea2-40e9-b48c-ab215d251c5a on attempt 1
2025-05-30 13:42:49,138 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: f539ede7-8ea2-40e9-b48c-ab215d251c5a, db_id: 408
2025-05-30 13:42:49,140 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'f539ede7-8ea2-40e9-b48c-ab215d251c5a', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 4961, 'completion_tokens': 55, 'total_tokens': 5016, 'timestamp': '2025-05-30T08:42:49.092516+00:00'}
2025-05-30 13:42:49,141 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: f539ede7-8ea2-40e9-b48c-ab215d251c5a
2025-05-30 13:42:49,142 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 946 for interaction_id: f539ede7-8ea2-40e9-b48c-ab215d251c5a on attempt 1
2025-05-30 13:42:49,144 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: f539ede7-8ea2-40e9-b48c-ab215d251c5a, db_id: 409
2025-05-30 13:42:49,147 - INFO - TokenUsageWorker - [token_usage_worker] RAW token usage data: {'interaction_id': 'f539ede7-8ea2-40e9-b48c-ab215d251c5a', 'agent_id': 'agent_airsoft_0faa9616', 'thread_id': '144641834', 'call_type': 'agent_llm', 'model_id': 'gpt-4.1-mini-2025-04-14', 'prompt_tokens': 1120, 'completion_tokens': 24, 'total_tokens': 1144, 'timestamp': '2025-05-30T08:42:46.294910+00:00'}
2025-05-30 13:42:49,147 - INFO - TokenUsageWorker - [token_usage_worker] Attempting to find message_id for agent_id: agent_airsoft_0faa9616, interaction_id: f539ede7-8ea2-40e9-b48c-ab215d251c5a
2025-05-30 13:42:49,147 - INFO - TokenUsageWorker - [token_usage_worker] Found message_id: 946 for interaction_id: f539ede7-8ea2-40e9-b48c-ab215d251c5a on attempt 1
2025-05-30 13:42:49,149 - INFO - TokenUsageWorker - [token_usage_worker] Successfully saved token usage for agent_id: agent_airsoft_0faa9616, interaction_id: f539ede7-8ea2-40e9-b48c-ab215d251c5a, db_id: 410
2025-05-30 13:47:25,340 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 13:47:25,349 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 13:52:25,533 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Executing scheduled task.
2025-05-30 13:52:25,544 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task completed.
2025-05-30 13:56:29,584 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 13:56:29,586 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 13:56:29,586 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 13:56:29,586 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4461679664) was cancelled.
2025-05-30 13:56:29,586 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4461679664) stopping. Performing cleanup...
2025-05-30 13:56:29,586 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 13:56:29,591 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 13:56:29,592 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 13:56:29,592 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:56:29,592 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 13:56:29,592 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 13:56:29,592 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4461679664) cleanup complete.
2025-05-30 13:56:29,592 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 13:56:29,592 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 13:56:29,592 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4464604416) was cancelled.
2025-05-30 13:56:29,592 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4464604416) stopping. Performing cleanup...
2025-05-30 13:56:29,593 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 13:56:29,596 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 13:56:29,596 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 13:56:29,597 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:56:29,597 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 13:56:29,597 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 13:56:29,597 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4464604416) cleanup complete.
2025-05-30 13:56:29,597 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 13:56:29,597 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 13:56:29,597 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4464604608) was cancelled.
2025-05-30 13:56:29,597 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4464604608) stopping. Performing cleanup...
2025-05-30 13:56:29,597 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 13:56:29,597 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:56:29,597 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 13:56:29,597 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 13:56:29,597 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 13:56:29,599 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 13:56:29,600 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 13:56:29,600 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:56:29,600 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 13:56:29,600 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 13:56:29,600 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 13:56:29,600 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4464604608) cleanup complete.
2025-05-30 13:56:29,600 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 13:56:29,600 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 13:56:29,600 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 13:56:29,609 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 13:56:29,609 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 13:56:30,082 - INFO - app.core.logging_config - Logging configured with level: INFO
2025-05-30 13:56:30,082 - INFO - app.core.lifespan - Application startup sequence initiated.
2025-05-30 13:56:30,086 - INFO - app.services.redis_service - Redis connection pool initialized successfully.
2025-05-30 13:56:30,086 - INFO - app.core.lifespan - Starting background tasks...
2025-05-30 13:56:30,087 - INFO - app.core.lifespan - History saver worker started, listening to queue: chat_history_queue
2025-05-30 13:56:30,087 - INFO - TokenUsageWorker - [token_usage_worker] Initialized. Listening to queue: token_usage_queue
2025-05-30 13:56:30,087 - INFO - app.core.lifespan - Token usage saver worker started, listening to queue: token_usage_queue
2025-05-30 13:56:30,087 - INFO - app.core.lifespan - Inactivity monitor worker started. Check interval: 300s, Timeout: 1800s.
2025-05-30 13:56:30,087 - INFO - app.core.lifespan - 3 background tasks initiated.
2025-05-30 13:56:30,087 - INFO - app.core.lifespan - Attempting to start existing agents and their integrations...
2025-05-30 13:56:30,087 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup started.
2025-05-30 13:56:30,087 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup started.
2025-05-30 13:56:30,087 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup started.
2025-05-30 13:56:30,089 - INFO - TokenUsageWorker - [token_usage_worker] Worker setup completed.
2025-05-30 13:56:30,089 - INFO - TokenUsageWorker - [token_usage_worker] Listening to Redis queues: token_usage_queue
2025-05-30 13:56:30,089 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Worker setup completed.
2025-05-30 13:56:30,089 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Scheduled task interval: 300 seconds.
2025-05-30 13:56:30,090 - INFO - app.core.lifespan - ProcessManager setup complete for startup.
2025-05-30 13:56:30,104 - INFO - HistorySaverWorker - [history_saver_worker] Worker setup completed.
2025-05-30 13:56:30,104 - INFO - HistorySaverWorker - [history_saver_worker] Listening to Redis queues: chat_history_queue
2025-05-30 13:56:30,105 - INFO - TokenUsageWorker - [token_usage_worker] Database session factory initialized.
2025-05-30 13:56:30,106 - INFO - HistorySaverWorker - [history_saver_worker] Database session factory initialized.
2025-05-30 13:56:30,106 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4410615248) setup complete. Starting run loop.
2025-05-30 13:56:30,106 - INFO - HistorySaverWorker - [history_saver_worker] Starting queue listening loop for chat_history_queue.
2025-05-30 13:56:30,106 - INFO - TokenUsageWorker - [token_usage_worker] Redis queue 'token_usage_queue' length at setup: 0
2025-05-30 13:56:30,106 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4410766592) setup complete. Starting run loop.
2025-05-30 13:56:30,106 - INFO - TokenUsageWorker - [token_usage_worker] Starting queue listening loop for token_usage_queue.
2025-05-30 13:56:30,108 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager initialized for InactivityMonitor.
2025-05-30 13:56:30,108 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Delaying initial check for 10 seconds to allow lifespan to complete agent setups...
2025-05-30 13:56:30,139 - INFO - app.core.lifespan - Found 1 agents to potentially start.
2025-05-30 13:56:30,140 - INFO - app.core.lifespan - Attempting to start agent: agent_airsoft_0faa9616
2025-05-30 13:56:30,141 - INFO - app.core.lifespan - Agent agent_airsoft_0faa9616 is already running.
2025-05-30 13:56:30,141 - INFO - app.core.lifespan - Found 1 integrations in config for agent agent_airsoft_0faa9616.
2025-05-30 13:56:30,141 - INFO - app.core.lifespan - Attempting to start telegram integration for agent: agent_airsoft_0faa9616 (settings provided: True)
2025-05-30 13:56:30,143 - INFO - app.core.lifespan - telegram integration for agent agent_airsoft_0faa9616 is already running.
2025-05-30 13:56:30,143 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:56:30,144 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 13:56:30,144 - INFO - app.core.lifespan - ProcessManager cleanup complete for startup function.
2025-05-30 13:56:30,144 - INFO - app.core.lifespan - Application startup sequence completed.
2025-05-30 13:56:30,684 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop itself was cancelled (e.g. during shutdown).
2025-05-30 13:56:30,684 - WARNING - aiogram.dispatcher - Received SIGINT signal
2025-05-30 13:56:30,685 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4483503968) received shutdown request. Initiating graceful shutdown...
2025-05-30 13:56:30,685 - INFO - AGENT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for AgentRunner (instance: 4483503968)...
2025-05-30 13:56:30,685 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 13:56:30,685 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner run_loop finished.
2025-05-30 13:56:30,685 - INFO - AGENT:agent_airsoft_0faa9616 - Run_loop for AgentRunner (instance: 4483503968) was cancelled.
2025-05-30 13:56:30,686 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4483503968) stopping. Performing cleanup...
2025-05-30 13:56:30,686 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup started.
2025-05-30 13:56:30,686 - INFO - aiogram.dispatcher - Polling stopped for bot @Mcat_testbot id=1750613938 - 'PlatformAI'
2025-05-30 13:56:30,686 - INFO - aiogram.dispatcher - Polling stopped
2025-05-30 13:56:30,688 - INFO - AGENT:agent_airsoft_0faa9616 - Cleared loaded threads cache 'agent_threads:agent_airsoft_0faa9616' (deleted: 1) on start/restart.
2025-05-30 13:56:30,688 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 1 main tasks.
2025-05-30 13:56:30,688 - INFO - AGENT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 13:56:30,689 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 13:56:30,689 - INFO - AGENT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:input
2025-05-30 13:56:30,689 - INFO - AGENT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:input finished.
2025-05-30 13:56:30,689 - INFO - AGENT:agent_airsoft_0faa9616 - Task 'AgentPubSubListener' completed during cleanup with result: None
2025-05-30 13:56:30,689 - INFO - AGENT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 13:56:30,693 - INFO - AGENT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616 as part of cleanup.
2025-05-30 13:56:30,694 - INFO - AGENT:agent_airsoft_0faa9616 - Deleted status key agent_status:agent_airsoft_0faa9616 from Redis.
2025-05-30 13:56:30,694 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:56:30,695 - INFO - AGENT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616 cleaned up Redis resources.
2025-05-30 13:56:30,695 - INFO - AGENT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 13:56:30,695 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner cleanup finished.
2025-05-30 13:56:30,695 - INFO - AGENT:agent_airsoft_0faa9616 - Component AgentRunner (instance: 4483503968) cleanup complete.
2025-05-30 13:56:30,695 - INFO - AGENT:agent_airsoft_0faa9616 - AgentRunner for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 13:56:30,695 - INFO - AGENT:agent_airsoft_0faa9616 - Shutting down agent runner for agent_airsoft_0faa9616.
2025-05-30 13:56:30,699 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 13:56:30,699 - INFO - AGENT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 13:56:30,699 - INFO - AGENT:agent_airsoft_0faa9616 - Agent runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 13:56:30,700 - INFO - __main__ - Agent runner main finished.
2025-05-30 13:56:30,849 - INFO - app.core.lifespan - Application shutdown sequence initiated.
2025-05-30 13:56:30,849 - INFO - app.core.lifespan - Stopping 3 background tasks...
2025-05-30 13:56:30,849 - INFO - app.core.lifespan - Attempting to cancel task HistorySaverWorker...
2025-05-30 13:56:30,849 - INFO - HistorySaverWorker - Run_loop for HistorySaverWorker (instance: 4410615248) was cancelled.
2025-05-30 13:56:30,849 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4410615248) stopping. Performing cleanup...
2025-05-30 13:56:30,849 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup started.
2025-05-30 13:56:30,853 - INFO - HistorySaverWorker - Clearing status key for history_saver_worker as part of cleanup.
2025-05-30 13:56:30,854 - INFO - HistorySaverWorker - Deleted status key worker_status:history_saver:history_saver_worker from Redis.
2025-05-30 13:56:30,854 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:56:30,855 - INFO - HistorySaverWorker - StatusUpdater for history_saver_worker cleaned up Redis resources.
2025-05-30 13:56:30,855 - INFO - HistorySaverWorker - [self._component_id] Worker cleanup completed.
2025-05-30 13:56:30,855 - INFO - HistorySaverWorker - Component HistorySaverWorker (instance: 4410615248) cleanup complete.
2025-05-30 13:56:30,855 - INFO - app.core.lifespan - Task HistorySaverWorker finished after cancellation signal.
2025-05-30 13:56:30,855 - INFO - app.core.lifespan - Attempting to cancel task TokenUsageWorker...
2025-05-30 13:56:30,855 - INFO - TokenUsageWorker - Run_loop for TokenUsageWorker (instance: 4410766592) was cancelled.
2025-05-30 13:56:30,855 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4410766592) stopping. Performing cleanup...
2025-05-30 13:56:30,855 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup started.
2025-05-30 13:56:30,858 - INFO - TokenUsageWorker - Clearing status key for token_usage_worker as part of cleanup.
2025-05-30 13:56:30,859 - INFO - TokenUsageWorker - Deleted status key worker_status:token_usage:token_usage_worker from Redis.
2025-05-30 13:56:30,859 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:56:30,859 - INFO - TokenUsageWorker - StatusUpdater for token_usage_worker cleaned up Redis resources.
2025-05-30 13:56:30,859 - INFO - TokenUsageWorker - [self._component_id] Worker cleanup completed.
2025-05-30 13:56:30,859 - INFO - TokenUsageWorker - Component TokenUsageWorker (instance: 4410766592) cleanup complete.
2025-05-30 13:56:30,859 - INFO - app.core.lifespan - Task TokenUsageWorker finished after cancellation signal.
2025-05-30 13:56:30,859 - INFO - app.core.lifespan - Attempting to cancel task InactivityMonitorWorker...
2025-05-30 13:56:30,859 - INFO - InactivityMonitorWorker - Run_loop for InactivityMonitorWorker (instance: 4410766400) was cancelled.
2025-05-30 13:56:30,859 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4410766400) stopping. Performing cleanup...
2025-05-30 13:56:30,859 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] Cleaning up InactivityMonitorWorker...
2025-05-30 13:56:30,859 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:56:30,859 - INFO - app.services.process_manager - ProcessManager cleaned up Redis connection.
2025-05-30 13:56:30,859 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] ProcessManager cleaned up.
2025-05-30 13:56:30,859 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup started.
2025-05-30 13:56:30,861 - INFO - InactivityMonitorWorker - Clearing status key for inactivity_monitor_worker as part of cleanup.
2025-05-30 13:56:30,862 - INFO - InactivityMonitorWorker - Deleted status key worker_status:inactivity_monitor:inactivity_monitor_worker from Redis.
2025-05-30 13:56:30,862 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:56:30,862 - INFO - InactivityMonitorWorker - StatusUpdater for inactivity_monitor_worker cleaned up Redis resources.
2025-05-30 13:56:30,862 - INFO - InactivityMonitorWorker - [self._component_id] Worker cleanup completed.
2025-05-30 13:56:30,862 - INFO - InactivityMonitorWorker - [inactivity_monitor_worker] InactivityMonitorWorker cleanup finished.
2025-05-30 13:56:30,863 - INFO - InactivityMonitorWorker - Component InactivityMonitorWorker (instance: 4410766400) cleanup complete.
2025-05-30 13:56:30,863 - INFO - app.core.lifespan - Task InactivityMonitorWorker finished after cancellation signal.
2025-05-30 13:56:30,863 - INFO - app.core.lifespan - All background tasks signaled to stop.
2025-05-30 13:56:30,863 - INFO - app.services.redis_service - Redis connection pool closed successfully.
2025-05-30 13:56:30,866 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 13:56:30,866 - INFO - app.core.lifespan - Application shutdown sequence completed.
2025-05-30 13:56:30,938 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram polling has stopped.
2025-05-30 13:56:30,938 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Main task 'AiogramPolling' completed. Result: None
2025-05-30 13:56:30,938 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - A main task finished. Initiating shutdown of other tasks and component.
2025-05-30 13:56:30,938 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4489897856) received shutdown request. Initiating graceful shutdown...
2025-05-30 13:56:30,938 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Cancelling main task (_run_loop) for TelegramIntegrationBot (instance: 4489897856)...
2025-05-30 13:56:30,938 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponentBase run_loop finished.
2025-05-30 13:56:30,938 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot run_loop for agent agent_airsoft_0faa9616 finishing.
2025-05-30 13:56:30,939 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Run_loop for TelegramIntegrationBot (instance: 4489897856) was cancelled.
2025-05-30 13:56:30,939 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4489897856) stopping. Performing cleanup...
2025-05-30 13:56:30,939 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup started.
2025-05-30 13:56:30,939 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Aiogram bot session.
2025-05-30 13:56:30,939 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Aiogram bot session closed.
2025-05-30 13:56:30,939 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup started. Cancelling 2 main tasks.
2025-05-30 13:56:30,939 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Waiting for 1 tasks to process cancellation...
2025-05-30 13:56:30,939 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener task cancelled.
2025-05-30 13:56:30,939 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Closing Pub/Sub connection for channel: agent:agent_airsoft_0faa9616:output
2025-05-30 13:56:30,939 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Pub/Sub listener loop for agent:agent_airsoft_0faa9616:output finished.
2025-05-30 13:56:30,939 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Task 'RedisOutputListener' completed during cleanup with result: None
2025-05-30 13:56:30,939 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - All main tasks processed and list cleared.
2025-05-30 13:56:30,943 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Clearing status key for agent_airsoft_0faa9616:telegram as part of cleanup.
2025-05-30 13:56:30,944 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Deleted status key integration_status:agent_airsoft_0faa9616:telegram from Redis.
2025-05-30 13:56:30,944 - INFO - app.core.base.redis_manager - Closing Redis client connection.
2025-05-30 13:56:30,944 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - StatusUpdater for agent_airsoft_0faa9616:telegram cleaned up Redis resources.
2025-05-30 13:56:30,944 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - ServiceComponent cleanup completed.
2025-05-30 13:56:30,945 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot cleanup finished.
2025-05-30 13:56:30,945 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Component TelegramIntegrationBot (instance: 4489897856) cleanup complete.
2025-05-30 13:56:30,945 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - TelegramIntegrationBot for agent_airsoft_0faa9616 finished execution or was shut down without a restart request.
2025-05-30 13:56:30,945 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Shutting down Telegram bot runner for agent_airsoft_0faa9616.
2025-05-30 13:56:30,948 - INFO - app.db.session - Database engine closed successfully.
2025-05-30 13:56:30,948 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Database engine closed.
2025-05-30 13:56:30,948 - INFO - TELEGRAM_BOT:agent_airsoft_0faa9616 - Telegram bot runner for agent_airsoft_0faa9616 has been shut down.
2025-05-30 13:56:30,949 - INFO - __main__ - Telegram bot runner main finished.
