# –û—Ç—á–µ—Ç –æ –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–µ: –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –õ–æ–≥–∏–∫–∏ –ü–æ–¥—Å—á–µ—Ç–∞ –¢–æ–∫–µ–Ω–æ–≤

## üìã –û–ø–∏—Å–∞–Ω–∏–µ –ó–∞–¥–∞—á–∏

–ë—ã–ª–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ª–æ–≥–∏–∫–∏ –ø–æ–¥—Å—á–µ—Ç–∞ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –∫–ª–∞—Å—Å–µ `GraphFactory`. –ú–µ—Ç–æ–¥ `_grade_documents_node` —Å–æ–¥–µ—Ä–∂–∞–ª –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –∏–∑ –æ—Ç–≤–µ—Ç–æ–≤ –º–æ–¥–µ–ª–∏, –≤–º–µ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤.

## üîç –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ü—Ä–æ–±–ª–µ–º—ã

1. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞**: –í –º–µ—Ç–æ–¥–µ `_grade_documents_node.process_doc()` –±—ã–ª–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ —á–µ—Ä–µ–∑ `self._extract_token_data()`, —Ö–æ—Ç—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –º–µ—Ç–æ–¥ `self._get_tokens()`

2. **–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø–∞ DRY**: –û–¥–∏–Ω–∞–∫–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –±—ã–ª–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö

3. **–£—Å–ª–æ–∂–Ω–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏**: –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª–æ–≥–∏–∫–∏ –ø–æ–¥—Å—á–µ—Ç–∞ —Ç–æ–∫–µ–Ω–æ–≤ —Ç—Ä–µ–±–æ–≤–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–ª—è—Ç—å –∫–æ–¥ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ò–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç–æ–¥–∞ `process_doc` –≤ `_grade_documents_node`

**–î–æ:**
```python
async def process_doc(doc_content: str) -> Tuple[str, str, Optional[TokenUsageData]]:
    # ...
    token_event_for_doc = self._extract_token_data(raw_ai_message, "grading_llm", node_model_id)
    return doc_content, binary_score, token_event_for_doc
```

**–ü–æ—Å–ª–µ:**
```python
async def process_doc(doc_content: str) -> Tuple[str, str]:
    # ...
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –º–µ—Ç–æ–¥ _extract_token_data —á–µ—Ä–µ–∑ _get_tokens
    temp_state = {"token_usage_events": []}
    self._get_tokens(temp_state, "grading_llm", node_model_id, raw_ai_message)
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω—ã –≤ –æ—Å–Ω–æ–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    if temp_state["token_usage_events"]:
        current_token_events.extend(temp_state["token_usage_events"])
    
    return doc_content, binary_score
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

**–î–æ:**
```python
for doc_content, score, token_event_data_item in results:
    if score == "yes":
        filtered_docs_content.append(doc_content)
    if token_event_data_item:
        current_token_events.append(token_event_data_item)
```

**–ü–æ—Å–ª–µ:**
```python
for doc_content, score in results:
    if score == "yes":
        filtered_docs_content.append(doc_content)
# –¢–æ–∫–µ–Ω—ã —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ current_token_events —á–µ—Ä–µ–∑ _get_tokens –≤ process_doc
```

## üéØ –î–æ—Å—Ç–∏–≥–Ω—É—Ç—ã–µ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

1. **–£—Å—Ç—Ä–∞–Ω–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ**: –£–¥–∞–ª–µ–Ω–æ ~30 —Å—Ç—Ä–æ–∫ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
2. **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏–∫–∏**: –í—Å—è –ª–æ–≥–∏–∫–∞ –ø–æ–¥—Å—á–µ—Ç–∞ —Ç–æ–∫–µ–Ω–æ–≤ —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ–¥–∏–Ω—ã–µ –º–µ—Ç–æ–¥—ã `_extract_token_data()` –∏ `_get_tokens()`
3. **–£–ª—É—á—à–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å**: –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ª–æ–≥–∏–∫–µ —Ç–æ–∫–µ–Ω–æ–≤ —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–Ω–æ—Å–∏—Ç—å —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
4. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å**: –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–¥—Å—á–µ—Ç–∞ —Ç–æ–∫–µ–Ω–æ–≤ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ –ø—Ä–µ–∂–¥–µ

## üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ –†–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

- ‚úÖ –£—Å–ø–µ—à–Ω—ã–π –∏–º–ø–æ—Ä—Ç –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π –ø–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞
- ‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –≤ –∫–æ–¥–µ
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ `GraphFactory`
- ‚úÖ –†–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –º–µ—Ç–æ–¥–∞ `_get_model_settings()`

## üìÅ –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –§–∞–π–ª—ã

- `app/agent_runner/langgraph/factory.py` - –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª —Å —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–æ–º

## üîÆ –°–ª–µ–¥—É—é—â–∏–µ –®–∞–≥–∏

1. –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –≤—Å–µ—Ö —É–∑–ª–æ–≤ –≥—Ä–∞—Ñ–∞ –∞–≥–µ–Ω—Ç–∞
3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –ø–æ–¥—Å—á–µ—Ç–∞ —Ç–æ–∫–µ–Ω–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö
4. –ü–æ–∏—Å–∫ –¥—Ä—É–≥–∏—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –¥–ª—è —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

---
*–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω: 27 –º–∞—è 2025*
