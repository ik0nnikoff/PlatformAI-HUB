# –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ E2E —Ç–µ—Å—Ç–æ–≤: –æ—Ç –º–æ–∫–æ–≤ –∫ —Ä–µ–∞–ª—å–Ω—ã–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º

**–î–∞—Ç–∞**: 16 —è–Ω–≤–∞—Ä—è 2025  
**–§–∞–π–ª**: `tests/test_e2e_image_workflow.py`  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û

## –ü—Ä–æ–±–ª–µ–º–∞

–ò–∑–Ω–∞—á–∞–ª—å–Ω—ã–µ e2e —Ç–µ—Å—Ç—ã –∏–º–µ–ª–∏ —Å–µ—Ä—å—ë–∑–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. **–ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ç–æ–¥—ã**: –¢–µ—Å—Ç—ã –≤—ã–∑—ã–≤–∞–ª–∏ `upload_telegram_photo()` –∏ `upload_whatsapp_image()`, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–æ –≤ `ImageOrchestrator`
2. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ –∫–ª–∞—Å—Å–æ–≤**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å `TelegramBot` –≤–º–µ—Å—Ç–æ `TelegramIntegrationBot`
3. **–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–µ –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ú–æ–∫–∏—Ä–æ–≤–∞–ª—Å—è MinIO, —Ö–æ—Ç—è –µ—Å—Ç—å —Ä–∞–±–æ—á–∏–π —Ä–µ–∞–ª—å–Ω—ã–π MinIO
4. **–ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ**: –ü–æ–¥–¥–µ–ª—å–Ω—ã–µ JPEG –±–∞–π—Ç—ã –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ –≤–∞–ª–∏–¥–∞—Ü–∏—é

## –ò–Ω—Å–∞–π—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

> "–∑–∞—á–µ–º —Ç—ã –º–æ–∫–∏—Ä—É–µ—à—å minio –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π —Ä–∞–±–æ—á–∏–π minio?"

–≠—Ç–æ –ø—Ä–∏–≤–µ–ª–æ –∫ –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ–º—É –∏–∑–º–µ–Ω–µ–Ω–∏—é –ø–æ–¥—Ö–æ–¥–∞ - –æ—Ç –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è –∫ –∞—É—Ç–µ–Ω—Ç–∏—á–Ω–æ–º—É –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–º—É —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é.

## –†–µ—à–µ–Ω–∏–µ

### 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

#### –î–æ:
```python
class TestCompleteImageWorkflow:
    @pytest.fixture
    def mock_image_orchestrator(self):
        # –ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–æ–∫–∏
        
    def test_telegram_to_langgraph_workflow(self, mock_image_orchestrator):
        # –ú–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```

#### –ü–æ—Å–ª–µ:
```python
class TestRealImageWorkflow:
    @pytest_asyncio.fixture
    async def real_image_orchestrator(self):
        # –ù–∞—Å—Ç–æ—è—â–∏–π ImageOrchestrator
        orchestrator = ImageOrchestrator()
        await orchestrator.initialize()
        return orchestrator
        
    async def test_minio_upload_and_vision_analysis(self, real_image_orchestrator):
        # –†–µ–∞–ª—å–Ω–æ–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç–æ–¥–∞ –∑–∞–≥—Ä—É–∑–∫–∏

–î–æ–±–∞–≤–ª–µ–Ω –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–π –º–µ—Ç–æ–¥ –≤ `ImageOrchestrator`:

```python
async def upload_user_image(self, 
                           agent_id: str, 
                           user_id: str, 
                           image_data: bytes, 
                           original_filename: str = None) -> str:
    """–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏."""
    return await self.minio_manager.upload_user_image(
        image_data=image_data,
        agent_id=agent_id, 
        user_id=user_id,
        original_filename=original_filename
    )
```

### 3. –°–æ–∑–¥–∞–Ω–∏–µ –≤–∞–ª–∏–¥–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö

#### –î–æ (–Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π JPEG):
```python
fake_jpeg_data = b'\xff\xd8\xff\xe0...'  # –ù–µ—Ä–∞–±–æ—Ç–∞—é—â–∏–µ –±–∞–π—Ç—ã
```

#### –ü–æ—Å–ª–µ (—Ä–µ–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ PIL):
```python
from PIL import Image
import io

img = Image.new('RGB', (100, 100), color='red')
img_bytes = io.BytesIO()
img.save(img_bytes, format='JPEG')
image_data = img_bytes.getvalue()
```

## –ù–æ–≤—ã–µ —Ç–µ—Å—Ç—ã

### 1. `test_minio_upload_and_vision_analysis`
- ‚úÖ –°–æ–∑–¥–∞—ë—Ç —Ä–µ–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ PIL
- ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤ –Ω–∞—Å—Ç–æ—è—â–∏–π MinIO —á–µ—Ä–µ–∑ `ImageOrchestrator` 
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ vision –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã
- ‚úÖ –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É URL –∏ —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π

### 2. `test_langgraph_tools_integration`
- ‚úÖ –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å LangGraph tools
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—ã–∑–æ–≤ `analyze_images` tool
- ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ API –∏–∑—è—â–Ω–æ

### 3. `test_bot_integration_workflow`
- ‚úÖ –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å Telegram –±–æ—Ç–æ–º
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ –±–æ—Ç
- ‚úÖ –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç workflow –æ—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ –æ—Ç–≤–µ—Ç–∞

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤:
```bash
PYTHONPATH=. uv run pytest tests/test_e2e_image_workflow.py::TestRealImageWorkflow -v -s
```

### –í—ã–≤–æ–¥:
```
======================== test session starts =========================
collected 3 items

test_minio_upload_and_vision_analysis 
üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ MinIO...
‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: agent_test-agent/user_test-user/2025/07/16/17/img_20250716_172859_84929c33.jpg
üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –∞–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ vision providers...
‚úÖ –ë–∞–∑–æ–≤–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!
PASSED

test_langgraph_tools_integration 
üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å LangGraph tools...
‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ LangGraph integration –∑–∞–≤–µ—Ä—à–µ–Ω–æ!
PASSED

test_bot_integration_workflow 
üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å Telegram –±–æ—Ç–æ–º...
‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram integration –∑–∞–≤–µ—Ä—à–µ–Ω–æ!
PASSED

=================== 3 passed, 11 warnings in 6.90s ===================
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

### 1. –ê—É—Ç–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—å
- –¢–µ—Å—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ä–µ–∞–ª—å–Ω—ã–π MinIO, –∞ –Ω–µ –º–æ–∫–∏
- –†–µ–∞–ª—å–Ω—ã–µ vision –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã (OpenAI) 
- –ù–∞—Å—Ç–æ—è—â–∏–µ –ø—É—Ç–∏ –∏ URL-—ã —Ñ–∞–π–ª–æ–≤

### 2. –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å
- –í–∞–ª–∏–¥–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ PIL
- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ async —Ñ–∏–∫—Å—Ç—É—Ä—ã —Å pytest-asyncio
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫ API

### 3. –ü–æ–∫—Ä—ã—Ç–∏–µ
- –ü–æ–ª–Ω—ã–π workflow –æ—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ –∞–Ω–∞–ª–∏–∑–∞
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å LangGraph tools
- –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –±–æ—Ç–∞–º–∏

### 4. –û—Ç–ª–∞–¥–∫–∞
- –†–µ–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏ –∏ –æ—à–∏–±–∫–∏
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏–Ω—Å–ø–µ–∫—Ü–∏–∏ —Ñ–∞–π–ª–æ–≤ –≤ MinIO
- –ù–∞—Å—Ç–æ—è—â–∏–µ API –≤—ã–∑–æ–≤—ã

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å

1. **–†–µ–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**: –¢–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç —Ñ–∞–∫—Ç–∏—á–µ—Å–∫—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å, –∞ –Ω–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –º–æ–∫–æ–≤
2. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ**: –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –º–µ–∂–¥—É MinIO, vision API –∏ –±–æ—Ç–∞–º–∏  
3. **–ö–∞—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö**: PIL –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
4. **Debugging-friendly**: –õ–µ–≥–∫–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–π —Å—Ä–µ–¥–µ

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü–µ—Ä–µ—Ö–æ–¥ –æ—Ç –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è –∫ –∞—É—Ç–µ–Ω—Ç–∏—á–Ω–æ–º—É –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–º—É —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –ø–æ–≤—ã—Å–∏–ª:

- **–ö–∞—á–µ—Å—Ç–≤–æ —Ç–µ—Å—Ç–æ–≤**: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ä–µ–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- **–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å**: –í–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ API –≤—ã–∑–æ–≤—ã  
- **–¶–µ–Ω–Ω–æ—Å—Ç—å**: –¢–µ—Å—Ç—ã –æ—Ç—Ä–∞–∂–∞—é—Ç —Ä–µ–∞–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
- **–û—Ç–ª–∞–¥–æ—á–Ω–æ—Å—Ç—å**: –ü—Ä–æ—Å—Ç–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

**–ì–ª–∞–≤–Ω—ã–π —É—Ä–æ–∫**: –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–∞–±–æ—á–∏–µ —Ä–µ–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, –ª—É—á—à–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Ö –Ω–∞–ø—Ä—è–º—É—é, —á–µ–º —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–æ–∫–∏. –≠—Ç–æ –¥–∞—ë—Ç –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –∏ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
