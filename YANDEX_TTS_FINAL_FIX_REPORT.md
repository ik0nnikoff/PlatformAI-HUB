# –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–ß–ï–¢: –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï YANDEX TTS

## –î–∞—Ç–∞: 2024-12-19
## –°—Ç–∞—Ç—É—Å: ‚úÖ –ü–û–õ–ù–û–°–¢–¨–Æ –ò–°–ü–†–ê–í–õ–ï–ù–û –ò –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–ù–û

---

## üéØ –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê –ü–†–û–ë–õ–ï–ú–´

### –ê–Ω–∞–ª–∏–∑ —Ä–∞–∑–ª–∏—á–∏–π –º–µ–∂–¥—É STT –∏ TTS:

**Yandex STT (—Ä–∞–±–æ—Ç–∞–ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ):**
```python
headers = {
    "Authorization": f"Api-Key {self.api_key}",
    "x-folder-id": self.folder_id,  # ‚úÖ Folder ID –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
}
```

**Yandex TTS (–±—ã–ª –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):**
```python
headers = {
    "Authorization": f"Api-Key {self.api_key}",
}
data = {
    "folderId": self.folder_id,  # ‚ùå Folder ID –≤ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–∞
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** Yandex TTS API —Ç—Ä–µ–±—É–µ—Ç folder ID –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ `x-folder-id`, –∞ –Ω–µ –≤ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–∞ –∫–∞–∫ `folderId`.

---

## üîß –í–ù–ï–°–ï–ù–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### 1. –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏

**–§–∞–π–ª:** `app/services/voice/tts/yandex_tts.py`

**–î–æ:**
```python
headers = {
    "Authorization": f"Api-Key {self.api_key}",
}
data = {
    "text": text,
    "lang": self.config.language or "ru-RU",
    "voice": self.config.voice or "jane",
    "speed": getattr(self.config, 'speed', 1.0),
    "format": self._get_yandex_format(),
    "sampleRateHertz": getattr(self.config, 'sample_rate', 22050),
    "folderId": self.folder_id,  # ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ
}
```

**–ü–æ—Å–ª–µ:**
```python
headers = {
    "Authorization": f"Api-Key {self.api_key}",
    "x-folder-id": self.folder_id,  # ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
}
data = {
    "text": text,
    "lang": self.config.language or "ru-RU",
    "voice": self.config.voice or "jane",
    "speed": getattr(self.config, 'speed', 1.0),
    "format": self._get_yandex_format(),
    # –£–±—Ä–∞–ª–∏ sampleRateHertz –∏ folderId
}
```

### 2. –ú–µ—Ç–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è

**–î–æ:**
```python
headers = {
    "Authorization": f"Api-Key {self.api_key}",
}
data = {
    "text": "test",
    "lang": "ru-RU",
    "voice": "jane",
    "folderId": self.folder_id,  # ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ
}
```

**–ü–æ—Å–ª–µ:**
```python
headers = {
    "Authorization": f"Api-Key {self.api_key}",
    "x-folder-id": self.folder_id,  # ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
}
data = {
    "text": "test",
    "lang": "ru-RU",
    "voice": "jane",
    # –£–±—Ä–∞–ª–∏ folderId
}
```

### 3. –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã

**–ú–µ—Ç–æ–¥ `_get_headers()`:**
```python
def _get_headers(self) -> dict[str, str]:
    return {
        "Authorization": f"Api-Key {self.api_key}",
        "Content-Type": "application/x-www-form-urlencoded",
        "x-folder-id": self.folder_id  # ‚úÖ –î–æ–±–∞–≤–∏–ª–∏
    }
```

**–ú–µ—Ç–æ–¥ `_build_synthesis_request()`:**
```python
def _build_synthesis_request(self, text: str, voice: str, speed: float, format: str) -> dict[str, str]:
    return {
        "text": text,
        "voice": voice,
        "speed": speed,
        "format": format,
        "lang": self.config.language,
        # –£–±—Ä–∞–ª–∏ "folderId": self.folder_id
    }
```

### 4. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ API key –ø–æ–ª—É—á–µ–Ω–∏—è

**–¢–∞–∫–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Ä–∞–Ω–µ–µ:**
```python
# –î–æ:
self.api_key = settings.YANDEX_API_KEY

# –ü–æ—Å–ª–µ:
self.api_key = settings.YANDEX_API_KEY.get_secret_value() if settings.YANDEX_API_KEY else None
```

---

## ‚úÖ –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø

### –¢–µ—Å—Ç 1: –ü—Ä—è–º–æ–π API –∑–∞–ø—Ä–æ—Å
```
üîß –¢–µ—Å—Ç–∏—Ä—É–µ–º Yandex TTS —Å x-folder-id –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ...
üîë API –∫–ª—é—á: AQVNxP9WBz... (–¥–ª–∏–Ω–∞: 40)
üìÇ Folder ID: aje4vtb0ecrp0glbscsr
üåê –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å —Å folder ID –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ...
üìä –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: 200
‚úÖ –£—Å–ø–µ—Ö! –ü–æ–ª—É—á–µ–Ω–æ 16106 –±–∞–π—Ç –∞—É–¥–∏–æ
‚úÖ Folder ID –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
```

### –¢–µ—Å—Ç 2: Yandex TTS Service
```
üéØ –¢–µ—Å—Ç–∏—Ä—É–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π YandexTTSService...
‚úÖ YandexTTSService –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
‚úÖ Health check: OK
‚úÖ Yandex TTS –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–°–ï –¢–ï–°–¢–´ –ü–†–û–®–õ–ò –£–°–ü–ï–®–ù–û

---

## üéâ –ò–¢–û–ì–ò –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. **Folder ID** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —á–µ—Ä–µ–∑ –∑–∞–≥–æ–ª–æ–≤–æ–∫ `x-folder-id`
2. **API –∫–ª—é—á** –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ —á–µ—Ä–µ–∑ `.get_secret_value()`
3. **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** —Å STT –æ–±–µ—Å–ø–µ—á–µ–Ω–∞ (–æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥)
4. **Health check** –ø—Ä–æ—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ
5. **–°–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏** —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### üîÑ –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π:
- **YANDEX_FOLDER_ID=aje4vtb0ecrp0glbscsr** ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- **YANDEX_API_KEY** ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- **–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π .env** ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è

### üìä –í–ª–∏—è–Ω–∏–µ –Ω–∞ —Å–∏—Å—Ç–µ–º—É:
- **STT**: –ü—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ –ø—Ä–µ–∂–¥–µ
- **TTS**: –¢–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ç–µ–º –∂–µ folder ID
- **–õ–æ–≥–∏**: –û—à–∏–±–∫–∏ 401 –∏—Å—á–µ–∑–Ω—É—Ç
- **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏**: –ì–æ–ª–æ—Å–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞—é—Ç

---

## üöÄ –¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –û–ë–™–Ø–°–ù–ï–ù–ò–ï

### –ü–æ—á–µ–º—É STT —Ä–∞–±–æ—Ç–∞–ª, –∞ TTS –Ω–µ—Ç:

1. **Yandex Speech-to-Text API** –∏ **Text-to-Speech API** –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ä–∞–∑–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
2. **STT** –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª `x-folder-id` –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö
3. **TTS** –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª `folderId` –≤ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–∞
4. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Yandex** —Ç—Ä–µ–±—É–µ—Ç –µ–¥–∏–Ω—ã–π –ø–æ–¥—Ö–æ–¥ —á–µ—Ä–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∏

### –ö–ª—é—á–µ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ:
```python
# –ë—ã–ª–æ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
data = {"folderId": folder_id}

# –°—Ç–∞–ª–æ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
headers = {"x-folder-id": folder_id}
```

---

## üéØ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

### üéâ –£–°–ü–ï–®–ù–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´:
- ‚úÖ **–ü—Ä–æ–±–ª–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–µ–Ω–∞**
- ‚úÖ **Yandex TTS —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π**
- ‚úÖ **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å STT –æ–±–µ—Å–ø–µ—á–µ–Ω–∞**
- ‚úÖ **–ö–æ–¥ —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω**

### üìà –ö–ê–ß–ï–°–¢–í–û –ö–û–î–ê:
- ‚úÖ **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** –º–µ–∂–¥—É STT –∏ TTS
- ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ API**
- ‚úÖ **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Yandex**
- ‚úÖ **–£–±—Ä–∞–Ω—ã –∏–∑–±—ã—Ç–æ—á–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã**

### üö´ –ë–û–õ–¨–®–ï –ù–ï –ë–£–î–ï–¢:
- ‚ùå –û—à–∏–±–æ–∫ 401 UNAUTHORIZED
- ‚ùå –°–æ–æ–±—â–µ–Ω–∏–π –æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º folder ID
- ‚ùå –ü—Ä–æ–±–ª–µ–º —Å –≥–æ–ª–æ—Å–æ–≤—ã–º —Å–∏–Ω—Ç–µ–∑–æ–º

---

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** ‚úÖ –†–ï–®–ï–ù–û  
**–í—Ä–µ–º—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 30 –º–∏–Ω—É—Ç  
**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ü–†–û–ô–î–ï–ù–û  
**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ production:** ‚úÖ –ì–û–¢–û–í–û

---

**–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ:** AI Assistant  
**–î–∞—Ç–∞:** 2024-12-19  
**–í–µ—Ä—Å–∏—è:** Yandex TTS Final Fix v1.0
